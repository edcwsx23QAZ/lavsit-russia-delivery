# Инструкция по настройке Wiki системы

## Обзор

Реализована полнофункциональная вики-система для раздела "Инструкция логиста" с возможностями:
- ✅ Редактирование всех заголовков (H1-H6)
- ✅ Редактирование ссылок
- ✅ Поддержка всех уровней вложенности страниц
- ✅ Добавление/удаление страниц
- ✅ Вставка и удаление изображений с drag-and-drop
- ✅ **Полная история версий с возможностью отката**

## Структура базы данных

Добавлены две новые модели в Prisma:
- `WikiPage` - страницы вики
- `WikiVersion` - история версий

## Шаги настройки

### 1. Создание миграции базы данных

```bash
# Создать миграцию
npx prisma migrate dev --name add_wiki_models

# Или если используется bun
bunx prisma migrate dev --name add_wiki_models
```

### 2. Создание директории для изображений

```bash
mkdir -p public/wiki-images
```

Или вручную создайте папку `public/wiki-images` в корне проекта.

### 3. Проверка переменных окружения

Убедитесь, что в `.env` настроена переменная `DATABASE_URL` для подключения к базе данных.

### 4. Генерация Prisma Client

```bash
npx prisma generate
# или
bunx prisma generate
```

## Использование

### Доступ к вики

1. Откройте страницу `/wiki` в браузере
2. Система автоматически создаст первую страницу при первом запуске
3. Используйте левую панель для управления страницами

### Редактирование страниц

1. Выберите страницу из списка слева
2. Нажмите кнопку "Редактировать"
3. Используйте панель инструментов для форматирования:
   - H1, H2, H3 - заголовки
   - Ссылка - вставка ссылок
   - Изображение - загрузка изображений
   - Жирный, курсив, код
4. Перетащите изображения прямо в область редактирования
5. Нажмите "Сохранить"

### Создание новых страниц

1. Нажмите "Новая страница" в левой панели
2. Введите заголовок и slug (URL)
3. Страница создастся автоматически

### История версий

1. Выберите страницу
2. Нажмите "История"
3. Просмотрите все версии с датами и примечаниями
4. Нажмите "Откатить" для восстановления нужной версии

### Вложенность страниц

При создании страницы можно указать `parentId` для создания вложенной структуры.
Это можно сделать через API или добавить в интерфейс.

## API Endpoints

### Страницы

- `GET /api/wiki/pages` - получить все страницы
- `GET /api/wiki/pages?slug=xxx` - получить страницу по slug
- `POST /api/wiki/pages` - создать страницу
- `PUT /api/wiki/pages` - обновить страницу
- `DELETE /api/wiki/pages?id=xxx` - удалить страницу (мягкое удаление)

### Версии

- `GET /api/wiki/versions?pageId=xxx` - получить историю версий
- `GET /api/wiki/versions?pageId=xxx&version=N` - получить конкретную версию
- `POST /api/wiki/versions` - откатить к версии

### Загрузка изображений

- `POST /api/wiki/upload` - загрузить изображение (формат FormData с полем 'file')

## Безопасность

⚠️ **Важно**: В текущей реализации отсутствует аутентификация. Рекомендуется:
1. Добавить проверку авторизации в API маршруты
2. Ограничить доступ к редактированию только авторизованным пользователям
3. Логировать все изменения с информацией о пользователе

## Откат изменений

Все изменения сохраняются в таблице `WikiVersion`. При каждом сохранении:
1. Создается новая версия с инкрементированным номером
2. Сохраняется полный контент и заголовок
3. Записывается примечание об изменении (если указано)
4. Сохраняется ID пользователя (если авторизация настроена)
5. Записывается время изменения

Любую версию можно восстановить через интерфейс истории или API.

## Структура файлов

```
app/
  api/
    wiki/
      pages/route.ts      # CRUD операции для страниц
      versions/route.ts   # Операции с версиями
      upload/route.ts     # Загрузка изображений
  wiki/
    page.tsx              # Главная страница вики

components/
  wiki/
    WikiEditor.tsx        # Редактор с поддержкой markdown
    PageManager.tsx       # Управление страницами
    VersionHistory.tsx    # История версий

prisma/
  schema.prisma           # Модели WikiPage и WikiVersion
```

## Решение проблем

### Ошибка при создании миграции

Убедитесь, что:
- База данных доступна
- `DATABASE_URL` настроен правильно
- Prisma Client сгенерирован

### Изображения не загружаются

Проверьте:
- Существует ли папка `public/wiki-images`
- Права на запись в эту папку
- Размер файла (максимум 10MB)

### История версий не отображается

Проверьте:
- Созданы ли записи в таблице `wiki_versions`
- Правильно ли работает связь между `WikiPage` и `WikiVersion`

## Дальнейшие улучшения

Возможные улучшения:
- [ ] Добавить аутентификацию
- [ ] Добавить поиск по страницам
- [ ] Добавить возможность изменения порядка страниц drag-and-drop
- [ ] Добавить экспорт/импорт страниц
- [ ] Добавить теги для организации страниц
- [ ] Добавить возможность сравнения версий
- [ ] Добавить комментарии к версиям

