# Контекст проекта: Система парсинга тканей от поставщиков

## Общее описание проекта

Проект представляет собой веб-приложение на Next.js 14 для автоматизированного парсинга и управления данными о тканях от различных поставщиков. Система поддерживает несколько методов получения данных: парсинг HTML-страниц, загрузка Excel-файлов по URL, и получение данных через email с Excel-вложениями.

## Технологический стек

- **Framework**: Next.js 14 (App Router)
- **Language**: TypeScript
- **Database**: PostgreSQL с Prisma ORM
- **Excel Parsing**: `xlsx` (SheetJS) - поддерживает как `.xls`, так и `.xlsx` форматы
- **Email Integration**: `imap`, `mailparser` для работы с IMAP/POP3
- **UI Components**: Radix UI, shadcn/ui
- **Styling**: Tailwind CSS

## Структура базы данных (Prisma Schema)

### Модель Supplier (Поставщик)
```prisma
model Supplier {
  id            String
  name          String
  websiteUrl    String?
  parsingMethod String  // "html" | "excel" | "email"
  parsingUrl    String?
  emailConfig   String? // JSON строка с настройками IMAP
  fabrics       Fabric[]
  parsingRules  ParsingRule?
  dataStructure DataStructure?
  manualUploads ManualUpload[]
  // ... другие поля
}
```

### Модель Fabric (Ткань)
```prisma
model Fabric {
  id            String
  supplierId    String
  collection    String
  color         String
  meterage      Float?
  price         Float?
  pricePerMeter Float?
  category      Int?
  imageUrl      String?
  colorHex      String?
  comment       String?
  isAvailable   Boolean
  supplier      Supplier
  // ... другие поля
}
```

### Модель FabricCategory (Категория ткани)
```prisma
model FabricCategory {
  id       Int
  category Int     // Номер категории (1-16)
  price    Float   // Максимальная цена для категории
  // ... timestamps
}
```

### Модель ManualUpload (Ручная загрузка)
```prisma
model ManualUpload {
  id              String
  supplierId      String
  type            String  // "stock" | "price"
  filePath        String
  uploadedAt      DateTime
  processedAt     DateTime?
  isActive        Boolean
  lastParserUpdate DateTime?
  metadata        Json?
  supplier        Supplier
}
```

### Модель EmailAttachment (Email вложения)
```prisma
model EmailAttachment {
  id          String
  supplierId  String
  emailUid    Int
  filename    String
  filePath    String
  processedAt DateTime?
  size        Int?
  supplier    Supplier
}
```

## Методы парсинга

### 1. HTML парсинг
- Используется для поставщиков, данные которых доступны на веб-страницах
- Парсинг через Puppeteer/Playwright для динамического контента

### 2. Excel парсинг по URL
- Загрузка Excel-файлов по прямой ссылке
- Поддержка динамических URL (например, Vektor с датами в URL)
- Автоматический поиск актуального файла по датам

### 3. Email парсинг
- Подключение к IMAP/POP3 почтовым серверам
- Автоматическая проверка новых писем
- Извлечение Excel-вложений
- Валидация файлов перед обработкой
- Выбор самого позднего письма с валидным Excel-вложением

## Поставщики и их особенности

### NoFrames
- **Метод**: Excel по URL
- **Особенности**:
  - Использует вкладки "ОСНОВНЫЕ КОЛЛЕКЦИИ" и "РАСПРОДАЖА"
  - Коллекция и цвет в столбце B (индекс 1)
  - Пропуск первых 6 строк (заголовки)
  - Игнорирование строк только с названием коллекции (например, "AKCENT")

### Нортекс (Nortex)
- **Метод**: Email (IMAP)
- **Особенности**:
  - Получение данных через email с Excel-вложениями
  - Формат "Ткань Collection Color" в столбце C
  - Наличие в столбцах E, F, G
  - Удаление префикса "Ткань" при парсинге
  - Пропуск строк с "пог. м", "Ед.изм.", "отчет создан"

### Vektor
- **Метод**: Excel по URL (динамический)
- **Особенности**:
  - URL содержит дату формата DDMMYY (например, 251225)
  - Автоматический поиск файла начиная с сегодняшней даты по убыванию
  - Столбец D - коллекция и цвет
  - Только строки со словом "ткань" (игнорируется при парсинге)
  - Игнорирование строк со словом "Сетка" (любой регистр)
  - Столбец F - метраж с наличием
  - "по запросу" = не в наличии, записывается в комментарий

## Ключевые компоненты системы

### Парсеры (`lib/parsers/`)

#### BaseParser
Базовый класс для всех парсеров с методами:
- `parse()` - основной метод парсинга
- `analyze()` - анализ структуры данных
- `validateFile()` - валидация файла

#### NoFramesParser
- Использует `xlsx` для чтения Excel
- Ищет нужные вкладки по названиям
- Пропускает служебные строки
- Парсит коллекцию, цвет, наличие

#### EmailExcelParser
- Расширяет BaseParser
- Работает с локальными файлами (из email)
- Адаптированная логика для разных поставщиков
- Валидация файла перед парсингом

### Email система (`lib/email/`)

#### EmailParser
Класс для работы с email:
- `connect()` - подключение к IMAP
- `disconnect()` - отключение
- `fetchNewEmails()` - получение новых писем
- `extractExcelAttachments()` - извлечение Excel-вложений
- `saveAttachment()` - сохранение вложения
- `markAsProcessed()` - пометка как обработанного
- `validateFile()` - валидация Excel-файла

**Настройки email**:
- IMAP host, port, secure
- User, password (App Password для Gmail/Mail.ru)
- fromEmail - фильтр по отправителю
- subjectFilter - фильтр по теме
- searchDays - период поиска (по умолчанию 90 дней)
- searchUnreadOnly - только непрочитанные (по умолчанию false)

### Автоматические правила (`lib/parsers/auto-rules.ts`)

Функция `createAutoRules()` генерирует правила парсинга для каждого поставщика:
- Индексы столбцов (collection, color, meterage, price)
- Строки для пропуска (skipRows)
- Строка заголовка (headerRow)
- Специальные правила (specialRules)
- Паттерны для пропуска (skipPatterns)

### Категории тканей (`lib/fabric-categories.ts`)

Система категоризации по цене:
- 16 категорий с диапазонами цен (550-7300+)
- Функция `getCategoryByPrice()` определяет категорию по цене
- Функция `calculatePricePerMeter()` вычисляет цену за метр

**Логика категоризации**:
- Если цена <= стоимости категории → эта категория
- Если цена больше → следующая категория
- Примеры: 350₽ → 1 категория, 7000₽ → 15 категория, 8500₽ → 16 категория

### Ручная загрузка (`lib/manual-upload-utils.ts`)

Утилиты для управления ручными загрузками:
- `shouldUpdateFromParser()` - определяет, нужно ли обновлять данные из парсера
- `updateFabricsFromParser()` - обновление данных из парсера с учетом приоритета ручных загрузок

**Приоритет данных**:
- Ручная загрузка наличия имеет приоритет до тех пор, пока парсер не получит более новые данные
- Ручная загрузка прайс-листа используется для установки цен

## API Endpoints

### Поставщики
- `GET /api/suppliers` - список всех поставщиков
- `GET /api/suppliers/[id]` - информация о поставщике
- `POST /api/suppliers/[id]/parse` - запуск парсинга
- `POST /api/suppliers/[id]/analyze` - анализ структуры данных
- `POST /api/suppliers/[id]/parse-email` - проверка email и парсинг
- `GET/POST /api/suppliers/[id]/email-config` - настройки email
- `POST /api/suppliers/[id]/manual-upload` - ручная загрузка файла

### Ткани
- `GET /api/fabrics` - список тканей (с фильтрацией по наличию)
- `POST /api/fabrics/upload-image` - загрузка изображения ткани

### Категории
- `GET /api/categories` - список категорий
- `POST /api/categories` - создание категории
- `DELETE /api/categories/[id]` - удаление категории

### Jobs
- `POST /api/jobs/check-emails` - проверка email для всех поставщиков (защищено API ключом)

## UI Страницы

### `/suppliers` - Страница поставщиков
- Таблица всех поставщиков (компактная, без горизонтального скролла)
- Кнопки для email-поставщиков:
  - "Настройки Email" - открывает диалог настройки
  - "Проверить Email" - ручная проверка email
- Кнопки для всех поставщиков:
  - "Ручная загрузка наличия"
  - "Ручная загрузка прайс-листа"
- Компоненты: `EmailSettingsDialog`, `ManualUploadDialog`

### `/fabrics` - Главная страница тканей
- Таблица всех тканей с колонками:
  - Поставщик, Коллекция, Цвет
  - Метраж, Цена, Цена за мп
  - Категория ткани
  - Изображение (с кнопкой загрузки)
  - Наличие
- Переключатель "Показывать только ткани в наличии"
- Компонент `ImageUploadButton` для загрузки изображений

### `/palette` - Палитра цветов
- Визуальное отображение тканей как цветных квадратов
- При наведении - tooltip с информацией (поставщик, коллекция, цвет, категория, стоимость)
- При клике на ткань - показ 2 предыдущих и 2 последующих тканей
- Переключатель "Показывать только ткани в наличии"
- Возможность загрузки изображений

### `/categories` - Управление категориями
- Таблица категорий с диапазонами цен
- Возможность добавления, редактирования, удаления категорий
- Инициализация с предустановленными категориями

## Особенности реализации

### Обработка ошибок
- Все API endpoints возвращают JSON с `Content-Type: application/json`
- Клиентская сторона проверяет `Content-Type` перед парсингом JSON
- Детальное логирование на сервере для отладки

### Валидация Excel-файлов
- Проверка существования файла
- Проверка размера файла (> 0)
- Проверка наличия листов
- Проверка наличия данных (не только заголовки)
- Для Nortex - гибкая проверка с игнорированием пустых строк в начале

### Email интеграция
- Поддержка Gmail, Yandex, Mail.ru, Outlook
- Требование App Password для Gmail и Mail.ru (при включенной 2FA)
- Поиск по отправителю и теме письма
- Выбор самого позднего письма с валидным Excel-вложением
- Отслеживание обработанных вложений в БД

### Динамические URL (Vektor)
- Поиск файла начиная с сегодняшней даты
- Перебор дат по убыванию (сегодня, вчера, позавчера...)
- Проверка доступности файла через HEAD запрос
- Максимальный период поиска (по умолчанию 30 дней)

### Ручные загрузки
- Приоритет ручных загрузок над парсером
- Обновление из парсера только если данные новее
- Отдельные типы: "stock" (наличие) и "price" (прайс-лист)
- Метаданные о загрузке (дата, статус обработки)

## Конфигурация и настройки

### Порт приложения
- Development: `4001` (`npm run dev -p 4001`)
- Production: `4001` (`npm run start -p 4001`)

### Переменные окружения
- `DATABASE_URL` - строка подключения к PostgreSQL
- `API_KEY` - ключ для защищенных endpoints (jobs)

### Зависимости
- `xlsx` - парсинг Excel файлов
- `imap`, `mailparser` - работа с email
- `@radix-ui/react-*` - UI компоненты
- `prisma`, `@prisma/client` - ORM

## Скрипты и утилиты

### Тестовые скрипты
- `test-noframes.ts` - тест парсера NoFrames
- `test-noframes-data.ts` - анализ данных NoFrames
- `test-noframes-full.ts` - полный тест парсинга NoFrames
- `test-nortex.ts` - анализ файла Nortex
- `test-nortex-parser.ts` - тест парсера Nortex

### Утилиты
- `regenerate-prisma.bat` - регенерация Prisma Client
- `init-suppliers.ts` - инициализация поставщиков в БД

## Важные замечания

1. **Prisma Client**: После изменения `schema.prisma` необходимо запустить `npx prisma generate` и перезапустить сервер

2. **Email App Passwords**: Gmail и Mail.ru требуют App Password для внешних приложений, особенно при включенной 2FA

3. **Формат Excel**: Старые `.xls` файлы не поддерживаются `ExcelJS`, используется `xlsx` (SheetJS)

4. **Кодировка путей**: В Windows могут быть проблемы с кириллицей в путях, требуется осторожность при работе с `Set-Location` в PowerShell

5. **Приоритет данных**: Ручные загрузки имеют приоритет над парсером до получения более новых данных

## Архитектурные принципы

- **Модульность**: Каждый парсер - отдельный класс, расширяющий BaseParser
- **Гибкость**: Поддержка разных методов получения данных (HTML, Excel URL, Email)
- **Автоматизация**: Автоматическая проверка email, генерация правил парсинга
- **Валидация**: Многоуровневая валидация данных на всех этапах
- **Логирование**: Детальное логирование для отладки и мониторинга
- **Обработка ошибок**: Graceful degradation с информативными сообщениями

## Документация

- `EMAIL_INTEGRATION.md` - архитектура email интеграции
- `IMAP_SETUP_GUIDE.md` - настройка IMAP для разных провайдеров
- `EMAIL_ERRORS_TROUBLESHOOTING.md` - решение проблем с email




