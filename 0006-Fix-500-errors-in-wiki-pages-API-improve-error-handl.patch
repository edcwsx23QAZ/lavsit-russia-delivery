From fbf1749db3e977399d024cda05793e8f3b1d0454 Mon Sep 17 00:00:00 2001
From: edcwsx23QAZ <edcwsx23QAZ@users.noreply.github.com>
Date: Tue, 27 Jan 2026 18:08:36 +0300
Subject: [PATCH 06/12] Fix 500 errors in wiki pages API: improve error
 handling for database connection issues

---
 app/api/wiki/pages/route.ts | 90 +++++++++++++++++++++++--------------
 1 file changed, 57 insertions(+), 33 deletions(-)

diff --git a/app/api/wiki/pages/route.ts b/app/api/wiki/pages/route.ts
index b140e1b9..849f3cd2 100644
--- a/app/api/wiki/pages/route.ts
+++ b/app/api/wiki/pages/route.ts
@@ -8,47 +8,68 @@ export async function GET(request: NextRequest) {
     const slug = searchParams.get('slug');
     const includeVersions = searchParams.get('includeVersions') === 'true';
 
+    // Проверяем доступность Prisma клиента
+    if (!prisma) {
+      console.warn('Prisma client is not available');
+      if (slug) {
+        return NextResponse.json({ error: 'Страница не найдена' }, { status: 404 });
+      }
+      return NextResponse.json([], { status: 200 });
+    }
+
     if (slug) {
       // Получить конкретную страницу
-      const page = await prisma.wikiPage.findUnique({
-        where: { slug, isActive: true },
-        include: {
-          parent: true,
-          children: {
-            where: { isActive: true },
-            orderBy: { order: 'asc' }
-          },
-          ...(includeVersions && {
-            versions: {
-              orderBy: { version: 'desc' },
-              take: 10 // Последние 10 версий
-            }
-          })
+      try {
+        const page = await prisma.wikiPage.findUnique({
+          where: { slug, isActive: true },
+          include: {
+            parent: true,
+            children: {
+              where: { isActive: true },
+              orderBy: { order: 'asc' }
+            },
+            ...(includeVersions && {
+              versions: {
+                orderBy: { version: 'desc' },
+                take: 10 // Последние 10 версий
+              }
+            })
+          }
+        });
+
+        if (!page) {
+          return NextResponse.json({ error: 'Страница не найдена' }, { status: 404 });
         }
-      });
 
-      if (!page) {
+        return NextResponse.json(page);
+      } catch (dbError: any) {
+        console.error('Database error fetching page:', dbError);
+        // Если ошибка базы данных, возвращаем 404 для конкретной страницы
         return NextResponse.json({ error: 'Страница не найдена' }, { status: 404 });
       }
-
-      return NextResponse.json(page);
     } else {
       // Получить все страницы
-      const pages = await prisma.wikiPage.findMany({
-        where: { isActive: true },
-        include: {
-          parent: true,
-          children: {
-            where: { isActive: true }
-          }
-        },
-        orderBy: [
-          { order: 'asc' },
-          { createdAt: 'asc' }
-        ]
-      });
-
-      return NextResponse.json(pages || []);
+      try {
+        const pages = await prisma.wikiPage.findMany({
+          where: { isActive: true },
+          include: {
+            parent: true,
+            children: {
+              where: { isActive: true }
+            }
+          },
+          orderBy: [
+            { order: 'asc' },
+            { createdAt: 'asc' }
+          ]
+        });
+
+        return NextResponse.json(pages || []);
+      } catch (dbError: any) {
+        console.error('Database error fetching pages:', dbError);
+        // Возвращаем пустой массив при ошибке базы данных
+        return NextResponse.json([], { status: 200 });
+      }
     }
   } catch (error: any) {
     console.error('Error fetching wiki pages:', error);
@@ -61,6 +82,9 @@ export async function GET(request: NextRequest) {
     
     // Возвращаем пустой массив вместо ошибки, чтобы страница могла работать
     // Это позволяет странице работать даже если база данных не настроена
+    const { searchParams } = new URL(request.url);
+    const slug = searchParams.get('slug');
+    
     if (slug) {
       return NextResponse.json({ error: 'Страница не найдена' }, { status: 404 });
     }
-- 
2.51.2.windows.1

