/**
 * Скрипт для инициализации структуры вики-инструкции для логистов
 * Запуск: npx tsx scripts/init-wiki-structure.ts
 */

import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

interface WikiPageData {
  slug: string;
  title: string;
  content: string;
  order: number;
  parentSlug?: string;
}

const wikiStructure: WikiPageData[] = [
  // Главная страница
  {
    slug: 'introduction',
    title: 'Инструкция для менеджера по логистике',
    content: JSON.stringify({
      sections: [
        {
          id: 'intro',
          title: '1. Введение',
          content: `### Цель и важность работы

Менеджер по логистике — ключевое звено в цепочке доставки премиум-мебели. Ваша работа напрямую влияет на удовлетворенность клиентов и репутацию компании.

В компании действует **клиентократия по Вкуссвиллу** и **AJTBD подход** (Always Just The Best Delivery). Это означает, что клиент всегда прав, и мы стремимся предоставить лучший сервис доставки в отрасли.

### Ценность для клиента

* ✅ **Безопасность и сохранность** — гарантия целостности премиум-мебели при транспортировке
* ✅ **Прозрачность** — полная информация о статусе доставки в реальном времени
* ✅ **Удобство** — гибкое планирование доставки с учетом пожеланий клиента
* ✅ **Профессионализм** — компетентное решение любых вопросов и проблем
* ✅ **Эксклюзивность** — индивидуальный подход к каждому клиенту
* ✅ **Скорость реакции** — оперативное решение вопросов и рекламаций

### Общие принципы работы

* Клиент всегда в приоритете
* Проактивная коммуникация вместо реактивной
* Документирование всех операций
* Работа в команде и взаимопомощь
* Постоянное улучшение процессов`,
          order: 0
        }
      ]
    }),
    order: 0
  },
  // Раздел 1: Культура и структура компании
  {
    slug: 'culture-and-structure',
    title: 'Культура и структура компании',
    content: JSON.stringify({
      sections: [
        {
          id: 'culture-intro',
          title: 'Культура компании',
          content: `### Цели и ценности компании

Наша компания производит мебель премиум-сегмента и стремится предоставить клиентам не просто продукт, а полный цикл премиум-сервиса от заказа до доставки.

**Ключевые ценности:**
- Клиент всегда прав
- Качество превыше всего
- Профессионализм и ответственность
- Командная работа
- Постоянное развитие

### Роль логиста в компании

Логист — это связующее звено между производством, складом, экспедиторами и клиентом. От вашей работы зависит:
- Удовлетворенность клиента
- Репутация компании
- Эффективность работы команды
- Финансовые показатели отдела`,
          order: 0
        },
        {
          id: 'ajtbd',
          title: 'AJTBD подход (Always Just The Best Delivery)',
          content: `### Суть подхода

AJTBD означает, что мы всегда стремимся предоставить **лучшую доставку** в отрасли. Это не просто лозунг, а принцип работы каждого логиста.

**Ключевые принципы AJTBD:**
1. **Скорость реакции** — отвечаем на запросы клиентов в течение 15 минут
2. **Проактивность** — информируем клиента о статусе доставки до того, как он спросит
3. **Качество коммуникации** — профессиональный, вежливый, понятный язык
4. **Решение проблем** — фокус на решении, а не на объяснении причин
5. **Персонализация** — индивидуальный подход к каждому клиенту

### Метрики AJTBD

- Время ответа на сообщение клиента: **≤ 15 минут**
- Проактивные уведомления: **100%** заказов
- Удовлетворенность клиента: **≥ 95%** (оценивается по метрикам без опросов)`,
          order: 1
        },
        {
          id: 'clientocracy',
          title: 'Клиентократия по Вкуссвиллу',
          content: `### Принципы клиентократии

**Клиент всегда прав** — это не просто фраза, а основа нашей работы. Даже если клиент ошибается, наша задача — найти решение, которое его удовлетворит.

**12 принципов клиентократии:**

1. Клиент всегда прав
2. Проактивная коммуникация
3. Эмпатия и понимание
4. Прозрачность и честность
5. Быстрая реакция (15 минут)
6. Персонализация
7. Решение проблем, а не объяснение причин
8. Предложение альтернатив
9. Благодарность и признательность
10. Следование обещаниям
11. Антиципация потребностей
12. Эксклюзивность сервиса

### Как это работает на практике

Каждый клиент — это VIP. Мы относимся к нему соответственно:
- Помним детали предыдущих разговоров
- Предугадываем его потребности
- Предлагаем решения до того, как возникнет проблема
- Создаем впечатление эксклюзивного сервиса`,
          order: 2
        },
        {
          id: 'product-heroes',
          title: 'Product Heroes подход',
          content: `### Суть подхода

Product Heroes — это методология, которая помогает количественно оценить качество работы и удовлетворенность клиента без необходимости мучить его опросами.

**Ключевые метрики:**
- Количество повторных обращений по одному вопросу
- Время решения проблемы
- Количество эскалаций
- Процент успешных доставок с первого раза
- Время отклика на запросы

### Применение в логистике

Мы отслеживаем:
- **NPS (Net Promoter Score)** через косвенные метрики
- **CSAT (Customer Satisfaction)** через качество коммуникации
- **Время решения проблем** — среднее время от обращения до решения
- **Процент успешных доставок** — доставки без проблем с первого раза`,
          order: 3
        }
      ]
    }),
    order: 1,
    parentSlug: 'introduction'
  },
  // Раздел 2: Ценность отдела логистики
  {
    slug: 'logistics-value',
    title: 'Ценность отдела логистики',
    content: JSON.stringify({
      sections: [
        {
          id: 'value-description',
          title: 'Ценность для клиента',
          content: `### Что мы даем клиенту

Отдел логистики — это не просто координация доставки, это **персональный сервис** для каждого клиента.

**Ключевые ценности:**

1. **Спокойствие клиента**
   - Клиент знает, что всё под контролем
   - Проактивные уведомления о статусе
   - Прозрачность процесса

2. **Экономия времени**
   - Клиент не тратит время на поиск информации
   - Все вопросы решаются быстро
   - Минимум действий от клиента

3. **Уверенность**
   - Клиент уверен, что его заказ в надежных руках
   - Профессиональная коммуникация
   - Решение проблем без задержек

4. **Комфорт**
   - Все вопросы решаются быстро и профессионально
   - Удобное время доставки
   - Гибкость в планировании

5. **Эмоциональная поддержка**
   - Особенно важна при задержках или проблемах
   - Понимание и эмпатия
   - Индивидуальный подход`,
          order: 0
        },
        {
          id: 'team-roles',
          title: 'Роль каждого участника команды',
          content: `### Состав отдела логистики

В отделе логистики работают:
- **2 логиста** — координация доставок, работа с клиентами
- **1 кладовщик** — управление складом, приемка и отгрузка
- **Команда экспедиторов-сборщиков** — доставка и сборка мебели

### Роль логиста

**Основные обязанности:**
- Проверка сообщений в Битриксе и согласование доставки с клиентом
- Расчет стоимости междугородней доставки
- Работа с доплатами и платным хранением
- Курирование отгрузок поставщиков и склада
- Составление плана отгрузок
- Курирование отгрузок с экспедиторами
- Отметка отвезенных заказов
- Курирование междугородних доставок
- Поддержка клиента (кроме рекламаций на этапе после готовности)
- Обеспечение высокой скорости ответа и премиум-уровня общения

### Роль кладовщика

**Основные обязанности:**
- Приемка товара от поставщиков
- Учет товара на складе
- Подготовка товара к отгрузке
- Контроль качества товара
- Взаимодействие с логистами по вопросам наличия товара

### Роль экспедиторов-сборщиков

**Основные обязанности:**
- Доставка мебели клиентам
- Сборка мебели на месте (при необходимости)
- Контроль качества доставки
- Взаимодействие с клиентами на месте доставки
- Информирование логистов о статусе доставки`,
          order: 1
        },
        {
          id: 'key-metrics',
          title: 'Ключевые метрики качества работы',
          content: `### Метрики для оценки работы отдела

**Общие метрики отдела:**
- Время ответа на сообщения: **≤ 15 минут** (цель: 100% в течение 15 минут)
- Процент успешных доставок с первого раза: **≥ 95%**
- Среднее время решения проблемы: **≤ 2 часа**
- Процент проактивных уведомлений: **100%**
- Удовлетворенность клиента (косвенные метрики): **≥ 95%**

**Метрики для логистов:**
- Время ответа на сообщения клиентов: **≤ 15 минут**
- Процент заказов с проактивными уведомлениями: **100%**
- Количество повторных обращений по одному вопросу: **≤ 1**
- Время согласования доставки: **≤ 24 часа**
- Процент успешных согласований: **≥ 98%**

**Метрики для кладовщика:**
- Точность учета товара: **100%**
- Время приемки товара: **≤ 2 часа** с момента прибытия
- Процент товара без повреждений: **≥ 99%**
- Время подготовки к отгрузке: **≤ 1 час** до назначенного времени

**Метрики для экспедиторов-сборщиков:**
- Процент доставок в назначенное время: **≥ 95%**
- Процент доставок без повреждений: **≥ 99%**
- Время доставки: **соответствие плану**
- Качество сборки (если требуется): **100%** (без рекламаций)
- Процент клиентов, довольных доставкой: **≥ 95%** (оценивается по отсутствию обращений)`,
          order: 2
        }
      ]
    }),
    order: 2,
    parentSlug: 'introduction'
  }
];

async function initWikiStructure() {
  try {
    console.log('Начало инициализации структуры вики...');

    // Создаем страницы по порядку
    for (const pageData of wikiStructure) {
      // Проверяем, существует ли страница
      const existing = await prisma.wikiPage.findUnique({
        where: { slug: pageData.slug }
      });

      if (existing) {
        console.log(`Страница "${pageData.title}" уже существует, пропускаем...`);
        continue;
      }

      // Находим родительскую страницу, если указана
      let parentId: string | null = null;
      if (pageData.parentSlug) {
        const parent = await prisma.wikiPage.findUnique({
          where: { slug: pageData.parentSlug }
        });
        if (parent) {
          parentId = parent.id;
        }
      }

      // Создаем страницу
      const page = await prisma.wikiPage.create({
        data: {
          slug: pageData.slug,
          title: pageData.title,
          content: pageData.content,
          order: pageData.order,
          parentId: parentId,
          isActive: true
        }
      });

      // Создаем первую версию
      await prisma.wikiVersion.create({
        data: {
          pageId: page.id,
          title: page.title,
          content: page.content,
          version: 1,
          changeNote: 'Создание страницы при инициализации',
          createdBy: null
        }
      });

      console.log(`✓ Создана страница: "${pageData.title}" (${pageData.slug})`);
    }

    console.log('\n✅ Инициализация структуры вики завершена успешно!');
  } catch (error) {
    console.error('Ошибка при инициализации структуры вики:', error);
    throw error;
  } finally {
    await prisma.$disconnect();
  }
}

// Запуск скрипта
initWikiStructure()
  .then(() => {
    console.log('Скрипт завершен.');
    process.exit(0);
  })
  .catch((error) => {
    console.error('Критическая ошибка:', error);
    process.exit(1);
  });

