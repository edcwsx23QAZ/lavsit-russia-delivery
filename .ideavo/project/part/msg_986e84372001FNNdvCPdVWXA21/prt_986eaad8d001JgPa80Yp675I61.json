{
  "id": "prt_986eaad8d001JgPa80Yp675I61",
  "messageID": "msg_986e84372001FNNdvCPdVWXA21",
  "sessionID": "ses_6852784ecffeuHwynj83p2lr14",
  "type": "tool",
  "tool": "write",
  "callID": "toolu_01BwGeZ8ktYL2kdB1DrsbG5C",
  "state": {
    "status": "completed",
    "input": {
      "filePath": "/home/user/project/app/api/pek/route.ts",
      "content": "import { NextRequest, NextResponse } from 'next/server';\n\nexport async function POST(request: NextRequest) {\n  try {\n    console.log('üîß –ü–≠–ö –ü—Ä–æ–∫—Å–∏: –ü–æ–ª—É—á–µ–Ω –∑–∞–ø—Ä–æ—Å');\n    \n    const requestData = await request.json();\n    console.log('üìù –î–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å–∞:', JSON.stringify(requestData, null, 2));\n    \n    const { method, address, coordinates } = requestData;\n    \n    const PEK_TOKEN = '624FC93CA677B23673BB476D4982294DC27E246F';\n    \n    // –ü–æ–ø—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –±–∞–∑–æ–≤—ã–µ URL - API –º–æ–≥–ª–æ –ø–µ—Ä–µ–µ—Ö–∞—Ç—å\n    const API_VARIANTS = [\n      'https://kabinet.pecom.ru/api/v1',  // –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç (–Ω–∞–∏–±–æ–ª–µ–µ –≤–µ—Ä–æ—è—Ç–Ω—ã–π)\n      'https://lk.pecom.ru/api/v1',       // –°–æ–∫—Ä–∞—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è\n      'https://api.pecom.ru/v1',          // –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π (–Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç)\n      'https://pecom.ru/api/v1',          // –û—Å–Ω–æ–≤–Ω–æ–π —Å–∞–π—Ç\n      'https://www.pecom.ru/api/v1'       // –° www\n    ];\n    \n    let urlPath = '';\n    let body = {};\n    \n    switch (method) {\n      case 'findzonebyaddress':\n        urlPath = '/branches/findzonebyaddress/';\n        body = { address: address };\n        break;\n        \n      case 'findzonebycoordinates':\n        urlPath = '/branches/findzonebycoordinates/';\n        body = {\n          longitude: coordinates.longitude,\n          latitude: coordinates.latitude\n        };\n        break;\n        \n      case 'calculateprice':\n        urlPath = '/calculator/calculateprice/';\n        const { method: methodName, ...calculationData } = requestData;\n        body = calculationData;\n        break;\n        \n      case 'nearestdepartments':\n        urlPath = '/branches/nearestdepartments/';\n        const { method: nearestMethod, ...departmentData } = requestData;\n        body = departmentData;\n        break;\n        \n      case 'test':\n        console.log('üîß –¢–µ—Å—Ç–æ–≤—ã–π –º–µ—Ç–æ–¥ –ø—Ä–æ–∫—Å–∏');\n        return NextResponse.json({ \n          status: 'OK', \n          message: '–ü—Ä–æ–∫—Å–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç',\n          timestamp: new Date().toISOString(),\n          receivedData: requestData\n        });\n        \n      default:\n        console.log('‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –º–µ—Ç–æ–¥:', method);\n        return NextResponse.json({ error: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –º–µ—Ç–æ–¥', method }, { status: 400 });\n    }\n    \n    // –ü–æ–ø—Ä–æ–±—É–µ–º –∫–∞–∂–¥—ã–π –≤–∞—Ä–∏–∞–Ω—Ç URL\n    for (let i = 0; i < API_VARIANTS.length; i++) {\n      const baseUrl = API_VARIANTS[i];\n      const fullUrl = baseUrl + urlPath;\n      \n      try {\n        console.log(`üåê –ü–æ–ø—ã—Ç–∫–∞ ${i + 1}/${API_VARIANTS.length}: ${fullUrl}`);\n        console.log('Body:', JSON.stringify(body, null, 2));\n        \n        const response = await fetch(fullUrl, {\n          method: 'POST',\n          headers: {\n            'Content-Type': 'application/json',\n            'Authorization': `Bearer ${PEK_TOKEN}`,\n          },\n          body: JSON.stringify(body)\n        });\n        \n        console.log(`üì° –û—Ç–≤–µ—Ç –ø–æ–ø—ã—Ç–∫–∞ ${i + 1}:`, response.status, response.statusText);\n        \n        if (response.ok) {\n          const responseText = await response.text();\n          console.log(`‚úÖ –£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç –ø–æ–ø—ã—Ç–∫–∞ ${i + 1}:`, responseText.substring(0, 500));\n          \n          try {\n            const data = JSON.parse(responseText);\n            return NextResponse.json(data);\n          } catch (parseError) {\n            console.error(`‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON –ø–æ–ø—ã—Ç–∫–∞ ${i + 1}:`, parseError);\n            continue; // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É URL\n          }\n        } else {\n          const errorText = await response.text();\n          console.error(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–ø—ã—Ç–∫–∞ ${i + 1}: ${response.status}`, errorText.substring(0, 200));\n          \n          // –ï—Å–ª–∏ 404, –ø—Ä–æ–±—É–µ–º —Å–ª–µ–¥—É—é—â–∏–π URL\n          if (response.status === 404) {\n            continue;\n          }\n          \n          // –ï—Å–ª–∏ –¥—Ä—É–≥–∞—è –æ—à–∏–±–∫–∞, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –µ—ë (–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è, —Å–µ—Ä–≤–µ—Ä –∏ —Ç.–¥.)\n          return NextResponse.json({ \n            error: `–ü–≠–ö API –æ—à–∏–±–∫–∞: ${response.status} ${response.statusText}`,\n            details: errorText,\n            url: fullUrl,\n            method,\n            requestBody: body,\n            attempt: i + 1\n          }, { status: response.status });\n        }\n        \n      } catch (fetchError) {\n        console.error(`‚ùå –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø–æ–ø—ã—Ç–∫–∞ ${i + 1}:`, fetchError);\n        continue; // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É URL\n      }\n    }\n    \n    // –ï—Å–ª–∏ –≤—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –ø—Ä–æ–≤–∞–ª–∏–ª–∏—Å—å\n    console.error('‚ùå –í—Å–µ URL –≤–∞—Ä–∏–∞–Ω—Ç—ã –ø—Ä–æ–≤–∞–ª–∏–ª–∏—Å—å');\n    return NextResponse.json({ \n      error: '–í—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –ü–≠–ö API –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã',\n      details: '–ü—Ä–æ–≤–µ—Ä–µ–Ω—ã –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ endpoints',\n      attemptedUrls: API_VARIANTS.map(base => base + urlPath),\n      method,\n      requestBody: body\n    }, { status: 503 });\n    \n  } catch (error) {\n    console.error('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–æ–∫—Å–∏ –ü–≠–ö API:', error);\n    \n    if (error instanceof Error) {\n      console.error('Stack trace:', error.stack);\n    }\n    \n    return NextResponse.json({ \n      error: '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞',\n      details: error instanceof Error ? error.message : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞',\n      type: error instanceof Error ? error.name : 'Unknown',\n      stack: error instanceof Error ? error.stack : undefined\n    }, { status: 500 });\n  }\n}"
    },
    "output": "",
    "metadata": {
      "diagnostics": {},
      "filepath": "/home/user/project/app/api/pek/route.ts",
      "exists": true
    },
    "title": "app/api/pek/route.ts",
    "time": {
      "start": 1758905171599,
      "end": 1758905171601
    }
  }
}