{
  "id": "prt_9ba32847b001V1mAJvq5BRv5Vr",
  "messageID": "msg_9ba2f7999001QlhlTMX0E7V729",
  "sessionID": "ses_6852784ecffeuHwynj83p2lr14",
  "type": "tool",
  "tool": "write",
  "callID": "toolu_01MYNkygc2yvzfJF8ze1Xmif",
  "state": {
    "status": "completed",
    "input": {
      "filePath": "/home/user/project/public/persistent-form-guardian.js",
      "content": "// PERSISTENT FORM DATA GUARDIAN WITH TRIPLE PROTECTION\n// Защищает данные формы от любых видов очистки, включая Clear-Site-Data\n// Тройная защита: localStorage + IndexedDB + cookies\n(function() {\n  'use strict';\n  \n  console.log('[FORM-GUARDIAN] Инициализация с тройной защитой (localStorage + IndexedDB + cookies)...');\n  \n  const FORM_DATA_KEY = 'deliveryFormData';\n  const APP_VERSION_KEY = 'appVersion';\n  const BACKUP_KEYS = ['formBackup1', 'formBackup2', 'formBackup3'];\n  const DB_NAME = 'LavsitFormStorage';\n  const DB_VERSION = 1;\n  const STORE_NAME = 'formData';\n  const COOKIE_NAME = 'lavsit_form_guardian';\n  const MAX_COOKIE_SIZE = 4000;\n  \n  let formDataBackup = null;\n  let appVersionBackup = null;\n  let guardianActive = false;\n  let dbInstance = null;\n  \n  // IndexedDB helper functions\n  function initIndexedDB() {\n    return new Promise((resolve, reject) => {\n      if (typeof window === 'undefined' || !window.indexedDB) {\n        console.warn('[FORM-GUARDIAN] IndexedDB не доступна');\n        resolve(null);\n        return;\n      }\n      \n      const request = window.indexedDB.open(DB_NAME, DB_VERSION);\n      \n      request.onerror = () => {\n        console.error('[FORM-GUARDIAN] Ошибка открытия IndexedDB:', request.error);\n        resolve(null);\n      };\n      \n      request.onsuccess = () => {\n        dbInstance = request.result;\n        console.log('[FORM-GUARDIAN] IndexedDB инициализирована');\n        resolve(dbInstance);\n      };\n      \n      request.onupgradeneeded = (event) => {\n        const db = event.target.result;\n        if (!db.objectStoreNames.contains(STORE_NAME)) {\n          const store = db.createObjectStore(STORE_NAME, { keyPath: 'key' });\n          store.createIndex('timestamp', 'timestamp', { unique: false });\n          console.log('[FORM-GUARDIAN] IndexedDB объект-хранилище создано');\n        }\n      };\n    });\n  }\n  \n  function saveToIndexedDB(key, value) {\n    return new Promise((resolve) => {\n      if (!dbInstance) {\n        resolve(false);\n        return;\n      }\n      \n      try {\n        const transaction = dbInstance.transaction([STORE_NAME], 'readwrite');\n        const store = transaction.objectStore(STORE_NAME);\n        const data = {\n          key: key,\n          value: value,\n          timestamp: Date.now()\n        };\n        \n        const request = store.put(data);\n        \n        request.onsuccess = () => {\n          console.log(`[FORM-GUARDIAN] Сохранено в IndexedDB: ${key}`);\n          resolve(true);\n        };\n        \n        request.onerror = () => {\n          console.error(`[FORM-GUARDIAN] Ошибка сохранения в IndexedDB: ${key}`, request.error);\n          resolve(false);\n        };\n      } catch (error) {\n        console.error('[FORM-GUARDIAN] Исключение при сохранении в IndexedDB:', error);\n        resolve(false);\n      }\n    });\n  }\n  \n  function loadFromIndexedDB(key) {\n    return new Promise((resolve) => {\n      if (!dbInstance) {\n        resolve(null);\n        return;\n      }\n      \n      try {\n        const transaction = dbInstance.transaction([STORE_NAME], 'readonly');\n        const store = transaction.objectStore(STORE_NAME);\n        const request = store.get(key);\n        \n        request.onsuccess = () => {\n          const result = request.result;\n          if (result) {\n            console.log(`[FORM-GUARDIAN] Загружено из IndexedDB: ${key}`);\n            resolve(result.value);\n          } else {\n            console.log(`[FORM-GUARDIAN] Данные не найдены в IndexedDB: ${key}`);\n            resolve(null);\n          }\n        };\n        \n        request.onerror = () => {\n          console.error(`[FORM-GUARDIAN] Ошибка загрузки из IndexedDB: ${key}`, request.error);\n          resolve(null);\n        };\n      } catch (error) {\n        console.error('[FORM-GUARDIAN] Исключение при загрузке из IndexedDB:', error);\n        resolve(null);\n      }\n    });\n  }\n  \n  // Cookie helper functions\n  function compressFormData(data) {\n    try {\n      const parsed = JSON.parse(data);\n      const compressed = {\n        v: parsed.version,\n        t: parsed.timestamp,\n        c: parsed.cargos,\n        fc: parsed.fromCity,\n        tc: parsed.toCity,\n        fa: parsed.fromAddress,\n        ta: parsed.toAddress,\n        dv: parsed.declaredValue\n      };\n      return JSON.stringify(compressed);\n    } catch (error) {\n      return data;\n    }\n  }\n  \n  function decompressFormData(data) {\n    try {\n      const compressed = JSON.parse(data);\n      if (compressed.version) return data; // Уже полные данные\n      \n      const decompressed = {\n        version: compressed.v || '1.2',\n        timestamp: compressed.t || Date.now(),\n        cargos: compressed.c || [],\n        fromCity: compressed.fc || '',\n        toCity: compressed.tc || '',\n        fromAddress: compressed.fa || '',\n        toAddress: compressed.ta || '',\n        declaredValue: compressed.dv || 0,\n        needPackaging: false,\n        needLoading: false,\n        needCarry: false,\n        floor: 1,\n        hasFreightLift: false,\n        needInsurance: false,\n        fromTerminal: true,\n        toTerminal: true,\n        fromAddressDelivery: false,\n        toAddressDelivery: false,\n        fromLavsiteWarehouse: false,\n        selectedProducts: [],\n        enabledCompanies: {}\n      };\n      return JSON.stringify(decompressed);\n    } catch (error) {\n      return data;\n    }\n  }\n  \n  function saveToCookies(data) {\n    try {\n      const compressed = compressFormData(data);\n      \n      if (compressed.length > MAX_COOKIE_SIZE) {\n        console.warn('[FORM-GUARDIAN] Data too large for cookies');\n        return false;\n      }\n      \n      const expires = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toUTCString();\n      document.cookie = `${COOKIE_NAME}=${encodeURIComponent(compressed)}; expires=${expires}; path=/; SameSite=Lax`;\n      console.log('[FORM-GUARDIAN] Сохранено в cookies');\n      return true;\n    } catch (error) {\n      console.warn('[FORM-GUARDIAN] Cookie save failed:', error);\n      return false;\n    }\n  }\n  \n  function loadFromCookies() {\n    try {\n      const cookies = document.cookie.split(';');\n      for (let cookie of cookies) {\n        cookie = cookie.trim();\n        if (cookie.startsWith(`${COOKIE_NAME}=`)) {\n          const compressed = decodeURIComponent(cookie.substring(`${COOKIE_NAME}=`.length));\n          const data = decompressFormData(compressed);\n          console.log('[FORM-GUARDIAN] Загружено из cookies');\n          return data;\n        }\n      }\n    } catch (error) {\n      console.warn('[FORM-GUARDIAN] Cookie load failed:', error);\n    }\n    return null;\n  }\n  \n  // Функция создания резервных копий во всех хранилищах\n  async function createBackups() {\n    try {\n      const formData = localStorage.getItem(FORM_DATA_KEY);\n      const appVersion = localStorage.getItem(APP_VERSION_KEY);\n      \n      let localStorageSuccess = false;\n      let cookieSuccess = false;\n      let indexedDBSuccess = false;\n      \n      if (formData) {\n        formDataBackup = formData;\n        \n        // 1. Создаем резервные копии в localStorage\n        try {\n          BACKUP_KEYS.forEach((key, index) => {\n            setTimeout(() => {\n              try {\n                localStorage.setItem(key, formData);\n              } catch (e) {\n                console.warn('[FORM-GUARDIAN] Backup failed for:', key, e);\n              }\n            }, index * 10);\n          });\n          localStorageSuccess = true;\n        } catch (error) {\n          console.warn('[FORM-GUARDIAN] localStorage backup failed:', error);\n        }\n        \n        // 2. Сохраняем в cookies\n        try {\n          cookieSuccess = saveToCookies(formData);\n        } catch (error) {\n          console.warn('[FORM-GUARDIAN] Cookie backup failed:', error);\n        }\n        \n        // 3. Сохраняем в IndexedDB\n        if (dbInstance) {\n          try {\n            indexedDBSuccess = await saveToIndexedDB(FORM_DATA_KEY, formData);\n          } catch (error) {\n            console.warn('[FORM-GUARDIAN] IndexedDB backup failed:', error);\n          }\n        }\n      }\n      \n      if (appVersion) {\n        appVersionBackup = appVersion;\n        localStorage.setItem('appVersionBackup', appVersion);\n        if (dbInstance) {\n          await saveToIndexedDB(APP_VERSION_KEY, appVersion);\n        }\n      }\n      \n      console.log(`[FORM-GUARDIAN] Triple backup created: localStorage=${localStorageSuccess}, cookies=${cookieSuccess}, indexedDB=${indexedDBSuccess}`);\n    } catch (e) {\n      console.warn('[FORM-GUARDIAN] Backup creation failed:', e);\n    }\n  }\n  \n  // Функция восстановления данных из всех источников\n  async function restoreFormData() {\n    try {\n      // Проверяем, нужно ли восстановление\n      const currentFormData = localStorage.getItem(FORM_DATA_KEY);\n      if (currentFormData) {\n        console.log('[FORM-GUARDIAN] Form data already exists, no restore needed');\n        return;\n      }\n      \n      console.log('[FORM-GUARDIAN] Data lost, attempting restore from all sources...');\n      let restored = false;\n      \n      // 1. Пытаемся восстановить из memory backup\n      if (formDataBackup) {\n        localStorage.setItem(FORM_DATA_KEY, formDataBackup);\n        console.log('[FORM-GUARDIAN] Restored from memory backup');\n        restored = true;\n      }\n      \n      // 2. Пытаемся восстановить из localStorage backups\n      if (!restored) {\n        for (const backupKey of BACKUP_KEYS) {\n          const backup = localStorage.getItem(backupKey);\n          if (backup) {\n            localStorage.setItem(FORM_DATA_KEY, backup);\n            console.log('[FORM-GUARDIAN] Restored from', backupKey);\n            restored = true;\n            break;\n          }\n        }\n      }\n      \n      // 3. Пытаемся восстановить из cookies\n      if (!restored) {\n        const cookieData = loadFromCookies();\n        if (cookieData) {\n          localStorage.setItem(FORM_DATA_KEY, cookieData);\n          console.log('[FORM-GUARDIAN] Restored from cookies');\n          restored = true;\n        }\n      }\n      \n      // 4. Пытаемся восстановить из IndexedDB\n      if (!restored && dbInstance) {\n        const indexedData = await loadFromIndexedDB(FORM_DATA_KEY);\n        if (indexedData) {\n          localStorage.setItem(FORM_DATA_KEY, indexedData);\n          console.log('[FORM-GUARDIAN] Restored from IndexedDB');\n          restored = true;\n        }\n      }\n      \n      // Восстанавливаем версию приложения\n      if (appVersionBackup && !localStorage.getItem(APP_VERSION_KEY)) {\n        localStorage.setItem(APP_VERSION_KEY, appVersionBackup);\n        console.log('[FORM-GUARDIAN] App version restored');\n      }\n      \n      if (restored) {\n        console.log('[FORM-GUARDIAN] ✅ Form data successfully restored from triple protection');\n        // Пересоздаем backup после восстановления\n        setTimeout(createBackups, 100);\n        \n        // Уведомляем React о восстановлении данных\n        window.dispatchEvent(new CustomEvent('formDataRestored', {\n          detail: { source: 'triple-protection-guardian' }\n        }));\n      } else {\n        console.log('[FORM-GUARDIAN] No backup data found in any source for restoration');\n      }\n      \n    } catch (e) {\n      console.warn('[FORM-GUARDIAN] Restore failed:', e);\n    }\n  }\n  \n  // Мониторинг изменений localStorage с тройной защитой\n  async function monitorLocalStorage() {\n    if (guardianActive) return;\n    \n    guardianActive = true;\n    console.log('[FORM-GUARDIAN] Monitoring localStorage with triple protection...');\n    \n    // Инициализируем IndexedDB\n    await initIndexedDB();\n    \n    // Сохраняем текущие данные во всех хранилищах\n    await createBackups();\n    \n    // Периодически проверяем и восстанавливаем данные\n    const restoreInterval = setInterval(async () => {\n      const formData = localStorage.getItem(FORM_DATA_KEY);\n      if (!formData && (formDataBackup || localStorage.getItem(BACKUP_KEYS[0]))) {\n        console.log('[FORM-GUARDIAN] Detected data loss, restoring from triple protection...');\n        await restoreFormData();\n      }\n    }, 500);\n    \n    // Отложенное восстановление после загрузки страницы\n    setTimeout(async () => {\n      await restoreFormData();\n    }, 1000);\n    \n    // Дополнительное восстановление через 3 секунды (после всех Clear-Site-Data)\n    setTimeout(async () => {\n      await restoreFormData();\n    }, 3000);\n    \n    // Обновляем backup при изменениях\n    const originalSetItem = localStorage.setItem;\n    localStorage.setItem = function(key, value) {\n      originalSetItem.call(this, key, value);\n      if (key === FORM_DATA_KEY || key === APP_VERSION_KEY) {\n        setTimeout(createBackups, 50);\n      }\n    };\n    \n    // Восстанавливаем при storage events\n    window.addEventListener('storage', async function(e) {\n      if (e.key === FORM_DATA_KEY && !e.newValue && formDataBackup) {\n        console.log('[FORM-GUARDIAN] Storage event detected data loss, restoring...');\n        setTimeout(restoreFormData, 100);\n      }\n    });\n    \n    console.log('[FORM-GUARDIAN] ✅ Triple protection guardian activated');\n  }\n  \n  // Экспортируем функции для использования в React\n  window.formGuardian = {\n    createBackups,\n    restoreFormData,\n    saveToCookies,\n    loadFromCookies,\n    saveToIndexedDB,\n    loadFromIndexedDB,\n    initIndexedDB\n  };\n  \n  // Запускаем мониторинг\n  if (document.readyState === 'loading') {\n    document.addEventListener('DOMContentLoaded', monitorLocalStorage);\n  } else {\n    monitorLocalStorage();\n  }\n  \n  // Запускаем немедленно\n  setTimeout(monitorLocalStorage, 0);\n  \n})();"
    },
    "output": "",
    "metadata": {
      "diagnostics": {},
      "filepath": "/home/user/project/public/persistent-form-guardian.js",
      "exists": true
    },
    "title": "public/persistent-form-guardian.js",
    "time": {
      "start": 1759765542757,
      "end": 1759765542760
    }
  }
}