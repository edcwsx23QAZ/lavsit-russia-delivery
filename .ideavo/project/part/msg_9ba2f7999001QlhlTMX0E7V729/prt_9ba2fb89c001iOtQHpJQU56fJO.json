{
  "id": "prt_9ba2fb89c001iOtQHpJQU56fJO",
  "messageID": "msg_9ba2f7999001QlhlTMX0E7V729",
  "sessionID": "ses_6852784ecffeuHwynj83p2lr14",
  "type": "tool",
  "tool": "read",
  "callID": "toolu_015X9bLUfgkUocv1YvynDBsZ",
  "state": {
    "status": "completed",
    "input": {
      "filePath": "/home/user/project/lib/indexeddb-storage.ts"
    },
    "output": "<file>\n00001| 'use client';\n00002| \n00003| // IndexedDB storage for form data - survives Clear-Site-Data headers\n00004| const DB_NAME = 'LavsitFormStorage';\n00005| const DB_VERSION = 1;\n00006| const STORE_NAME = 'formData';\n00007| const FORM_DATA_KEY = 'deliveryFormData';\n00008| const APP_VERSION_KEY = 'appVersion';\n00009| \n00010| interface IndexedDBFormData {\n00011|   key: string;\n00012|   value: string;\n00013|   timestamp: number;\n00014| }\n00015| \n00016| class IndexedDBStorage {\n00017|   private db: IDBDatabase | null = null;\n00018|   private initPromise: Promise<void> | null = null;\n00019| \n00020|   async init(): Promise<void> {\n00021|     if (this.initPromise) {\n00022|       return this.initPromise;\n00023|     }\n00024| \n00025|     this.initPromise = new Promise((resolve, reject) => {\n00026|       if (typeof window === 'undefined') {\n00027|         reject(new Error('IndexedDB not available in SSR'));\n00028|         return;\n00029|       }\n00030| \n00031|       const request = indexedDB.open(DB_NAME, DB_VERSION);\n00032| \n00033|       request.onerror = () => {\n00034|         console.error('[INDEXEDDB] Failed to open database:', request.error);\n00035|         reject(request.error);\n00036|       };\n00037| \n00038|       request.onsuccess = () => {\n00039|         this.db = request.result;\n00040|         console.log('[INDEXEDDB] Database opened successfully');\n00041|         resolve();\n00042|       };\n00043| \n00044|       request.onupgradeneeded = (event) => {\n00045|         const db = (event.target as IDBOpenDBRequest).result;\n00046|         \n00047|         if (!db.objectStoreNames.contains(STORE_NAME)) {\n00048|           const store = db.createObjectStore(STORE_NAME, { keyPath: 'key' });\n00049|           store.createIndex('timestamp', 'timestamp', { unique: false });\n00050|           console.log('[INDEXEDDB] Object store created');\n00051|         }\n00052|       };\n00053|     });\n00054| \n00055|     return this.initPromise;\n00056|   }\n00057| \n00058|   async setItem(key: string, value: string): Promise<boolean> {\n00059|     try {\n00060|       await this.init();\n00061|       if (!this.db) throw new Error('Database not initialized');\n00062| \n00063|       return new Promise((resolve, reject) => {\n00064|         const transaction = this.db!.transaction([STORE_NAME], 'readwrite');\n00065|         const store = transaction.objectStore(STORE_NAME);\n00066|         \n00067|         const data: IndexedDBFormData = {\n00068|           key,\n00069|           value,\n00070|           timestamp: Date.now()\n00071|         };\n00072| \n00073|         const request = store.put(data);\n00074| \n00075|         request.onsuccess = () => {\n00076|           console.log(`[INDEXEDDB] Saved ${key}`);\n00077|           resolve(true);\n00078|         };\n00079| \n00080|         request.onerror = () => {\n00081|           console.error(`[INDEXEDDB] Failed to save ${key}:`, request.error);\n00082|           reject(request.error);\n00083|         };\n00084|       });\n00085|     } catch (error) {\n00086|       console.error(`[INDEXEDDB] Error saving ${key}:`, error);\n00087|       return false;\n00088|     }\n00089|   }\n00090| \n00091|   async getItem(key: string): Promise<string | null> {\n00092|     try {\n00093|       await this.init();\n00094|       if (!this.db) throw new Error('Database not initialized');\n00095| \n00096|       return new Promise((resolve, reject) => {\n00097|         const transaction = this.db!.transaction([STORE_NAME], 'readonly');\n00098|         const store = transaction.objectStore(STORE_NAME);\n00099|         const request = store.get(key);\n00100| \n00101|         request.onsuccess = () => {\n00102|           const result = request.result;\n00103|           if (result) {\n00104|             console.log(`[INDEXEDDB] Retrieved ${key}`);\n00105|             resolve(result.value);\n00106|           } else {\n00107|             console.log(`[INDEXEDDB] No data found for ${key}`);\n00108|             resolve(null);\n00109|           }\n00110|         };\n00111| \n00112|         request.onerror = () => {\n00113|           console.error(`[INDEXEDDB] Failed to retrieve ${key}:`, request.error);\n00114|           reject(request.error);\n00115|         };\n00116|       });\n00117|     } catch (error) {\n00118|       console.error(`[INDEXEDDB] Error retrieving ${key}:`, error);\n00119|       return null;\n00120|     }\n00121|   }\n00122| \n00123|   async removeItem(key: string): Promise<boolean> {\n00124|     try {\n00125|       await this.init();\n00126|       if (!this.db) throw new Error('Database not initialized');\n00127| \n00128|       return new Promise((resolve, reject) => {\n00129|         const transaction = this.db!.transaction([STORE_NAME], 'readwrite');\n00130|         const store = transaction.objectStore(STORE_NAME);\n00131|         const request = store.delete(key);\n00132| \n00133|         request.onsuccess = () => {\n00134|           console.log(`[INDEXEDDB] Removed ${key}`);\n00135|           resolve(true);\n00136|         };\n00137| \n00138|         request.onerror = () => {\n00139|           console.error(`[INDEXEDDB] Failed to remove ${key}:`, request.error);\n00140|           reject(request.error);\n00141|         };\n00142|       });\n00143|     } catch (error) {\n00144|       console.error(`[INDEXEDDB] Error removing ${key}:`, error);\n00145|       return false;\n00146|     }\n00147|   }\n00148| \n00149|   async clear(): Promise<boolean> {\n00150|     try {\n00151|       await this.init();\n00152|       if (!this.db) throw new Error('Database not initialized');\n00153| \n00154|       return new Promise((resolve, reject) => {\n00155|         const transaction = this.db!.transaction([STORE_NAME], 'readwrite');\n00156|         const store = transaction.objectStore(STORE_NAME);\n00157|         const request = store.clear();\n00158| \n00159|         request.onsuccess = () => {\n00160|           console.log('[INDEXEDDB] All data cleared');\n00161|           resolve(true);\n00162|         };\n00163| \n00164|         request.onerror = () => {\n00165|           console.error('[INDEXEDDB] Failed to clear data:', request.error);\n00166|           reject(request.error);\n00167|         };\n00168|       });\n00169|     } catch (error) {\n00170|       console.error('[INDEXEDDB] Error clearing data:', error);\n00171|       return false;\n00172|     }\n00173|   }\n00174| \n00175|   async getAllKeys(): Promise<string[]> {\n00176|     try {\n00177|       await this.init();\n00178|       if (!this.db) throw new Error('Database not initialized');\n00179| \n00180|       return new Promise((resolve, reject) => {\n00181|         const transaction = this.db!.transaction([STORE_NAME], 'readonly');\n00182|         const store = transaction.objectStore(STORE_NAME);\n00183|         const request = store.getAllKeys();\n00184| \n00185|         request.onsuccess = () => {\n00186|           resolve(request.result as string[]);\n00187|         };\n00188| \n00189|         request.onerror = () => {\n00190|           console.error('[INDEXEDDB] Failed to get keys:', request.error);\n00191|           reject(request.error);\n00192|         };\n00193|       });\n00194|     } catch (error) {\n00195|       console.error('[INDEXEDDB] Error getting keys:', error);\n00196|       return [];\n00197|     }\n00198|   }\n00199| }\n00200| \n00201| // Singleton instance\n00202| const indexedDBStorage = new IndexedDBStorage();\n00203| \n00204| // Public API functions\n00205| export const saveFormDataToIndexedDB = async (formData: string): Promise<boolean> => {\n00206|   return await indexedDBStorage.setItem(FORM_DATA_KEY, formData);\n00207| };\n00208| \n00209| export const loadFormDataFromIndexedDB = async (): Promise<string | null> => {\n00210|   return await indexedDBStorage.getItem(FORM_DATA_KEY);\n00211| };\n00212| \n00213| export const saveAppVersionToIndexedDB = async (version: string): Promise<boolean> => {\n00214|   return await indexedDBStorage.setItem(APP_VERSION_KEY, version);\n00215| };\n00216| \n00217| export const loadAppVersionFromIndexedDB = async (): Promise<string | null> => {\n00218|   return await indexedDBStorage.getItem(APP_VERSION_KEY);\n00219| };\n00220| \n00221| export const clearFormDataFromIndexedDB = async (): Promise<boolean> => {\n00222|   const success1 = await indexedDBStorage.removeItem(FORM_DATA_KEY);\n00223|   const success2 = await indexedDBStorage.removeItem(APP_VERSION_KEY);\n00224|   return success1 && success2;\n00225| };\n00226| \n00227| export const clearAllIndexedDBData = async (): Promise<boolean> => {\n00228|   return await indexedDBStorage.clear();\n00229| };\n00230| \n00231| // Helper function to check if IndexedDB is available\n00232| export const isIndexedDBAvailable = (): boolean => {\n00233|   return typeof window !== 'undefined' && 'indexedDB' in window;\n00234| };\n00235| \n00236| console.log('[INDEXEDDB] Storage module initialized');\n</file>",
    "metadata": {
      "preview": "'use client';\n\n// IndexedDB storage for form data - survives Clear-Site-Data headers\nconst DB_NAME = 'LavsitFormStorage';\nconst DB_VERSION = 1;\nconst STORE_NAME = 'formData';\nconst FORM_DATA_KEY = 'deliveryFormData';\nconst APP_VERSION_KEY = 'appVersion';\n\ninterface IndexedDBFormData {\n  key: string;\n  value: string;\n  timestamp: number;\n}\n\nclass IndexedDBStorage {\n  private db: IDBDatabase | null = null;\n  private initPromise: Promise<void> | null = null;\n\n  async init(): Promise<void> {"
    },
    "title": "lib/indexeddb-storage.ts",
    "time": {
      "start": 1759765314467,
      "end": 1759765314469
    }
  }
}