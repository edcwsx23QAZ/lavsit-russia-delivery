{
  "id": "prt_9ba3180970012eA7OkMGNDG7ei",
  "messageID": "msg_9ba2f7999001QlhlTMX0E7V729",
  "sessionID": "ses_6852784ecffeuHwynj83p2lr14",
  "type": "tool",
  "tool": "multiedit",
  "callID": "toolu_015mq1tDi8PaGMzGNtzNvq1a",
  "state": {
    "status": "error",
    "input": {
      "filePath": "/home/user/project/public/persistent-form-guardian.js",
      "edits": [
        {
          "oldString": "// Защищает данные формы от любых видов очистки, включая Clear-Site-Data\n// Запускается ДО загрузки React и любых других скриптов\nconsole.log('[FORM-GUARDIAN] Initializing ultra-persistent storage guardian...');",
          "newString": "// Защищает данные формы от любых видов очистки, включая Clear-Site-Data\n// Запускается ДО загрузки React и любых других скриптов\n// Тройная защита: localStorage + IndexedDB + cookies\nconsole.log('[FORM-GUARDIAN] Initializing ultra-persistent storage guardian with triple protection...');"
        },
        {
          "oldString": "  // Создаем множественные резервные копии\n  function createBackups() {\n    if (!window.localStorage) {\n      console.log('[FORM-GUARDIAN] localStorage not available');\n      return false;\n    }\n\n    const data = window.localStorage.getItem('deliveryFormData');\n    if (!data || data === 'null') {\n      console.log('[FORM-GUARDIAN] No form data to backup');\n      return false;\n    }\n\n    try {\n      // Резервные копии в localStorage с разными ключами\n      window.localStorage.setItem('deliveryFormData_backup1', data);\n      window.localStorage.setItem('deliveryFormData_backup2', data);\n      window.localStorage.setItem('deliveryFormData_backup3', data);\n      \n      // Сохраняем в памяти\n      memoryStorage.formData = data;\n      memoryStorage.timestamp = Date.now();\n      \n      console.log('[FORM-GUARDIAN] Backups created successfully');\n      return true;\n    } catch (error) {\n      console.error('[FORM-GUARDIAN] Failed to create backups:', error);\n      return false;\n    }\n  }",
          "newString": "  // Создаем множественные резервные копии во всех доступных хранилищах\n  function createBackups() {\n    if (!window.localStorage) {\n      console.log('[FORM-GUARDIAN] localStorage not available');\n      return false;\n    }\n\n    const data = window.localStorage.getItem('deliveryFormData');\n    if (!data || data === 'null') {\n      console.log('[FORM-GUARDIAN] No form data to backup');\n      return false;\n    }\n\n    try {\n      let localStorageSuccess = false;\n      let cookieSuccess = false;\n      let indexedDBSuccess = false;\n      \n      // 1. Резервные копии в localStorage с разными ключами\n      try {\n        window.localStorage.setItem('deliveryFormData_backup1', data);\n        window.localStorage.setItem('deliveryFormData_backup2', data);\n        window.localStorage.setItem('deliveryFormData_backup3', data);\n        localStorageSuccess = true;\n      } catch (error) {\n        console.warn('[FORM-GUARDIAN] localStorage backup failed:', error);\n      }\n      \n      // 2. Сохраняем в памяти\n      memoryStorage.formData = data;\n      memoryStorage.timestamp = Date.now();\n      \n      // 3. Резервная копия в cookies\n      try {\n        cookieSuccess = saveToCookies(data);\n      } catch (error) {\n        console.warn('[FORM-GUARDIAN] Cookie backup failed:', error);\n      }\n      \n      // 4. Резервная копия в IndexedDB\n      try {\n        indexedDBSuccess = saveToIndexedDB(data);\n      } catch (error) {\n        console.warn('[FORM-GUARDIAN] IndexedDB backup failed:', error);\n      }\n      \n      console.log(`[FORM-GUARDIAN] Backups created: localStorage=${localStorageSuccess}, cookies=${cookieSuccess}, indexedDB=${indexedDBSuccess}`);\n      return localStorageSuccess || cookieSuccess;\n    } catch (error) {\n      console.error('[FORM-GUARDIAN] Failed to create backups:', error);\n      return false;\n    }\n  }"
        },
        {
          "oldString": "  // Восстанавливаем данные из резервных копий\n  function restoreFromBackups() {\n    if (!window.localStorage) {\n      console.log('[FORM-GUARDIAN] localStorage not available for restore');\n      return false;\n    }\n\n    // Сначала проверяем основной ключ\n    let data = window.localStorage.getItem('deliveryFormData');\n    if (data && data !== 'null') {\n      console.log('[FORM-GUARDIAN] Main data intact, no restore needed');\n      return true;\n    }\n\n    // Пробуем восстановить из резервных копий\n    const backupKeys = ['deliveryFormData_backup1', 'deliveryFormData_backup2', 'deliveryFormData_backup3'];\n    \n    for (const key of backupKeys) {\n      try {\n        data = window.localStorage.getItem(key);\n        if (data && data !== 'null') {\n          window.localStorage.setItem('deliveryFormData', data);\n          console.log(`[FORM-GUARDIAN] Restored from ${key}`);\n          return true;\n        }\n      } catch (error) {\n        console.warn(`[FORM-GUARDIAN] Failed to restore from ${key}:`, error);\n      }\n    }\n    \n    // Пробуем восстановить из памяти\n    if (memoryStorage.formData && memoryStorage.timestamp) {\n      const age = Date.now() - memoryStorage.timestamp;\n      if (age < 300000) { // 5 минут\n        try {\n          window.localStorage.setItem('deliveryFormData', memoryStorage.formData);\n          console.log('[FORM-GUARDIAN] Restored from memory storage');\n          return true;\n        } catch (error) {\n          console.warn('[FORM-GUARDIAN] Failed to restore from memory:', error);\n        }\n      }\n    }\n    \n    console.log('[FORM-GUARDIAN] No backups available for restore');\n    return false;\n  }",
          "newString": "  // Восстанавливаем данные из резервных копий (тройная защита)\n  function restoreFromBackups() {\n    if (!window.localStorage) {\n      console.log('[FORM-GUARDIAN] localStorage not available for restore');\n      return false;\n    }\n\n    // Сначала проверяем основной ключ\n    let data = window.localStorage.getItem('deliveryFormData');\n    if (data && data !== 'null') {\n      console.log('[FORM-GUARDIAN] Main data intact, no restore needed');\n      return true;\n    }\n\n    console.log('[FORM-GUARDIAN] Main data lost, attempting restore from backups...');\n    \n    // 1. Пробуем восстановить из localStorage резервных копий\n    const backupKeys = ['deliveryFormData_backup1', 'deliveryFormData_backup2', 'deliveryFormData_backup3'];\n    \n    for (const key of backupKeys) {\n      try {\n        data = window.localStorage.getItem(key);\n        if (data && data !== 'null') {\n          window.localStorage.setItem('deliveryFormData', data);\n          console.log(`[FORM-GUARDIAN] Restored from localStorage ${key}`);\n          return true;\n        }\n      } catch (error) {\n        console.warn(`[FORM-GUARDIAN] Failed to restore from ${key}:`, error);\n      }\n    }\n    \n    // 2. Пробуем восстановить из памяти\n    if (memoryStorage.formData && memoryStorage.timestamp) {\n      const age = Date.now() - memoryStorage.timestamp;\n      if (age < 300000) { // 5 минут\n        try {\n          window.localStorage.setItem('deliveryFormData', memoryStorage.formData);\n          console.log('[FORM-GUARDIAN] Restored from memory storage');\n          return true;\n        } catch (error) {\n          console.warn('[FORM-GUARDIAN] Failed to restore from memory:', error);\n        }\n      }\n    }\n    \n    // 3. Пробуем восстановить из cookies\n    try {\n      const cookieData = loadFromCookies();\n      if (cookieData) {\n        window.localStorage.setItem('deliveryFormData', cookieData);\n        console.log('[FORM-GUARDIAN] Restored from cookies');\n        return true;\n      }\n    } catch (error) {\n      console.warn('[FORM-GUARDIAN] Failed to restore from cookies:', error);\n    }\n    \n    // 4. Пробуем восстановить из IndexedDB (асинхронно)\n    try {\n      loadFromIndexedDB().then(indexedData => {\n        if (indexedData) {\n          window.localStorage.setItem('deliveryFormData', indexedData);\n          console.log('[FORM-GUARDIAN] Restored from IndexedDB');\n          // Уведомляем о восстановлении через событие\n          window.dispatchEvent(new CustomEvent('formDataRestored', { detail: { source: 'IndexedDB' } }));\n        }\n      }).catch(error => {\n        console.warn('[FORM-GUARDIAN] Failed to restore from IndexedDB:', error);\n      });\n    } catch (error) {\n      console.warn('[FORM-GUARDIAN] IndexedDB restore error:', error);\n    }\n    \n    console.log('[FORM-GUARDIAN] No synchronous backups available for restore');\n    return false;\n  }"
        },
        {
          "oldString": "  // Константное восстановление каждую секунду\n  setInterval(() => {\n    const currentData = window.localStorage ? window.localStorage.getItem('deliveryFormData') : null;\n    \n    if (!currentData || currentData === 'null') {\n      console.log('[FORM-GUARDIAN] Data lost, attempting restore...');\n      const restored = restoreFromBackups();\n      \n      if (restored) {\n        console.log('[FORM-GUARDIAN] ✅ Data successfully restored');\n        const newData = window.localStorage.getItem('deliveryFormData');\n        createBackups(); // Пересоздаем резервные копии\n        \n        // Уведомляем React о восстановлении данных\n        window.dispatchEvent(new CustomEvent('formDataRestored', {\n          detail: { data: newData }\n        }));\n      } else {\n        console.log('[FORM-GUARDIAN] ❌ Failed to restore data');\n      }\n    } else {\n      // Если данные есть, обновляем резервные копии\n      const success1 = createBackups();\n      console.log(`[FORM-GUARDIAN] Backup created: ${success1}`);\n    }\n  }, 1000);",
          "newString": "  // Константное восстановление каждую секунду с тройной защитой\n  setInterval(() => {\n    const currentData = window.localStorage ? window.localStorage.getItem('deliveryFormData') : null;\n    \n    if (!currentData || currentData === 'null') {\n      console.log('[FORM-GUARDIAN] Data lost, attempting restore from all sources...');\n      const restored = restoreFromBackups();\n      \n      if (restored) {\n        console.log('[FORM-GUARDIAN] ✅ Data successfully restored');\n        const newData = window.localStorage.getItem('deliveryFormData');\n        createBackups(); // Пересоздаем резервные копии во всех хранилищах\n        \n        // Уведомляем React о восстановлении данных\n        window.dispatchEvent(new CustomEvent('formDataRestored', {\n          detail: { data: newData }\n        }));\n      } else {\n        console.log('[FORM-GUARDIAN] ❌ Failed to restore data from any source');\n      }\n    } else {\n      // Если данные есть, обновляем резервные копии во всех хранилищах\n      const success = createBackups();\n      console.log(`[FORM-GUARDIAN] Triple backup created: ${success}`);\n    }\n  }, 1000);"
        },
        {
          "oldString": "  console.log('[FORM-GUARDIAN] Guardian activated with memory protection');",
          "newString": "  // Функции для работы с cookies\n  function saveToCookies(data) {\n    try {\n      const expires = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toUTCString();\n      const compressed = compressFormData(data);\n      \n      if (compressed.length > 4000) {\n        console.warn('[FORM-GUARDIAN] Data too large for cookies');\n        return false;\n      }\n      \n      document.cookie = `lavsit_form_guardian=${encodeURIComponent(compressed)}; expires=${expires}; path=/; SameSite=Lax`;\n      console.log('[FORM-GUARDIAN] Saved to cookies');\n      return true;\n    } catch (error) {\n      console.warn('[FORM-GUARDIAN] Cookie save failed:', error);\n      return false;\n    }\n  }\n  \n  function loadFromCookies() {\n    try {\n      const cookies = document.cookie.split(';');\n      for (let cookie of cookies) {\n        cookie = cookie.trim();\n        if (cookie.startsWith('lavsit_form_guardian=')) {\n          const compressed = decodeURIComponent(cookie.substring('lavsit_form_guardian='.length));\n          const data = decompressFormData(compressed);\n          console.log('[FORM-GUARDIAN] Loaded from cookies');\n          return data;\n        }\n      }\n    } catch (error) {\n      console.warn('[FORM-GUARDIAN] Cookie load failed:', error);\n    }\n    return null;\n  }\n  \n  // Простое сжатие JSON для cookies\n  function compressFormData(data) {\n    try {\n      const parsed = JSON.parse(data);\n      const compressed = {\n        v: parsed.version,\n        t: parsed.timestamp,\n        c: parsed.cargos,\n        fc: parsed.fromCity,\n        tc: parsed.toCity\n      };\n      return JSON.stringify(compressed);\n    } catch (error) {\n      return data;\n    }\n  }\n  \n  function decompressFormData(data) {\n    try {\n      const compressed = JSON.parse(data);\n      if (compressed.version) return data; // Уже полные данные\n      \n      const decompressed = {\n        version: compressed.v,\n        timestamp: compressed.t,\n        cargos: compressed.c,\n        fromCity: compressed.fc,\n        toCity: compressed.tc,\n        fromAddress: '',\n        toAddress: '',\n        declaredValue: 0,\n        needPackaging: false,\n        needLoading: false,\n        needCarry: false,\n        floor: 1,\n        hasFreightLift: false,\n        needInsurance: false,\n        fromTerminal: true,\n        toTerminal: true,\n        fromAddressDelivery: false,\n        toAddressDelivery: false,\n        fromLavsiteWarehouse: false,\n        selectedProducts: [],\n        enabledCompanies: {}\n      };\n      return JSON.stringify(decompressed);\n    } catch (error) {\n      return data;\n    }\n  }\n  \n  // Функции для работы с IndexedDB\n  function saveToIndexedDB(data) {\n    try {\n      const request = indexedDB.open('LavsitFormStorage', 1);\n      \n      request.onupgradeneeded = function(event) {\n        const db = event.target.result;\n        if (!db.objectStoreNames.contains('formData')) {\n          db.createObjectStore('formData', { keyPath: 'key' });\n        }\n      };\n      \n      request.onsuccess = function(event) {\n        const db = event.target.result;\n        const transaction = db.transaction(['formData'], 'readwrite');\n        const store = transaction.objectStore('formData');\n        \n        store.put({\n          key: 'deliveryFormData',\n          value: data,\n          timestamp: Date.now()\n        });\n        \n        console.log('[FORM-GUARDIAN] Saved to IndexedDB');\n      };\n      \n      request.onerror = function(error) {\n        console.warn('[FORM-GUARDIAN] IndexedDB save failed:', error);\n      };\n      \n      return true;\n    } catch (error) {\n      console.warn('[FORM-GUARDIAN] IndexedDB save error:', error);\n      return false;\n    }\n  }\n  \n  function loadFromIndexedDB() {\n    return new Promise((resolve, reject) => {\n      try {\n        const request = indexedDB.open('LavsitFormStorage', 1);\n        \n        request.onsuccess = function(event) {\n          const db = event.target.result;\n          const transaction = db.transaction(['formData'], 'readonly');\n          const store = transaction.objectStore('formData');\n          const getRequest = store.get('deliveryFormData');\n          \n          getRequest.onsuccess = function() {\n            if (getRequest.result) {\n              console.log('[FORM-GUARDIAN] Loaded from IndexedDB');\n              resolve(getRequest.result.value);\n            } else {\n              resolve(null);\n            }\n          };\n          \n          getRequest.onerror = function() {\n            reject(getRequest.error);\n          };\n        };\n        \n        request.onerror = function() {\n          reject(request.error);\n        };\n      } catch (error) {\n        reject(error);\n      }\n    });\n  }\n  \n  console.log('[FORM-GUARDIAN] Guardian activated with triple protection (localStorage + IndexedDB + cookies)');"
        },
        {
          "oldString": "    // Дополнительное восстановление через 3 секунды (после всех Clear-Site-Data)\n    setTimeout(() => {\n      console.log('[FORM-GUARDIAN] Delayed restore attempt...');\n      const success = restoreFromBackups();\n      if (success) {\n        const data = window.localStorage.getItem('deliveryFormData');\n        window.dispatchEvent(new CustomEvent('formDataRestored', {\n          detail: { data: data, source: 'delayed' }\n        }));\n      }\n    }, 3000);",
          "newString": "    // Дополнительное восстановление через 3 секунды (после всех Clear-Site-Data)\n    setTimeout(() => {\n      console.log('[FORM-GUARDIAN] Delayed restore attempt from all sources...');\n      const success = restoreFromBackups();\n      if (success) {\n        const data = window.localStorage.getItem('deliveryFormData');\n        window.dispatchEvent(new CustomEvent('formDataRestored', {\n          detail: { data: data, source: 'delayed-triple-restore' }\n        }));\n      }\n    }, 3000);"
        },
        {
          "oldString": "  })();\n\n  console.log('[FORM-GUARDIAN] All protection mechanisms active');",
          "newString": "  })();\n\n  console.log('[FORM-GUARDIAN] All triple protection mechanisms active (localStorage + IndexedDB + cookies)');\n  \n  // Экспортируем функции для использования в React\n  window.formGuardian = {\n    createBackups,\n    restoreFromBackups,\n    saveToCookies,\n    loadFromCookies,\n    saveToIndexedDB,\n    loadFromIndexedDB\n  };"
        }
      ]
    },
    "error": "Error: You must read the file /home/user/project/public/persistent-form-guardian.js before overwriting it. Use the Read tool first",
    "time": {
      "start": 1759765491145,
      "end": 1759765491149
    }
  }
}