{
  "id": "prt_9ba32770e001ScvrEzNlkoeqe8",
  "messageID": "msg_9ba2f7999001QlhlTMX0E7V729",
  "sessionID": "ses_6852784ecffeuHwynj83p2lr14",
  "type": "tool",
  "tool": "read",
  "callID": "toolu_01JXqCjPKc26un3TBEmps62W",
  "state": {
    "status": "completed",
    "input": {
      "filePath": "/home/user/project/public/persistent-form-guardian.js"
    },
    "output": "<file>\n00001| // PERSISTENT FORM DATA GUARDIAN WITH INDEXEDDB\n00002| // Защищает данные формы от любых видов очистки, включая Clear-Site-Data\n00003| (function() {\n00004|   'use strict';\n00005|   \n00006|   console.log('[FORM-GUARDIAN] Инициализация с IndexedDB защитой...');\n00007|   \n00008|   const FORM_DATA_KEY = 'deliveryFormData';\n00009|   const APP_VERSION_KEY = 'appVersion';\n00010|   const BACKUP_KEYS = ['formBackup1', 'formBackup2', 'formBackup3'];\n00011|   const DB_NAME = 'LavsitFormStorage';\n00012|   const DB_VERSION = 1;\n00013|   const STORE_NAME = 'formData';\n00014|   \n00015|   let formDataBackup = null;\n00016|   let appVersionBackup = null;\n00017|   let guardianActive = false;\n00018|   let indexedDB = null;\n00019|   let dbInstance = null;\n00020|   \n00021|   // IndexedDB helper functions\n00022|   function initIndexedDB() {\n00023|     return new Promise((resolve, reject) => {\n00024|       if (typeof window === 'undefined' || !window.indexedDB) {\n00025|         console.warn('[FORM-GUARDIAN] IndexedDB не доступна');\n00026|         resolve(null);\n00027|         return;\n00028|       }\n00029|       \n00030|       const request = window.indexedDB.open(DB_NAME, DB_VERSION);\n00031|       \n00032|       request.onerror = () => {\n00033|         console.error('[FORM-GUARDIAN] Ошибка открытия IndexedDB:', request.error);\n00034|         resolve(null);\n00035|       };\n00036|       \n00037|       request.onsuccess = () => {\n00038|         dbInstance = request.result;\n00039|         console.log('[FORM-GUARDIAN] IndexedDB инициализирована');\n00040|         resolve(dbInstance);\n00041|       };\n00042|       \n00043|       request.onupgradeneeded = (event) => {\n00044|         const db = event.target.result;\n00045|         if (!db.objectStoreNames.contains(STORE_NAME)) {\n00046|           const store = db.createObjectStore(STORE_NAME, { keyPath: 'key' });\n00047|           store.createIndex('timestamp', 'timestamp', { unique: false });\n00048|           console.log('[FORM-GUARDIAN] IndexedDB объект-хранилище создано');\n00049|         }\n00050|       };\n00051|     });\n00052|   }\n00053|   \n00054|   function saveToIndexedDB(key, value) {\n00055|     return new Promise((resolve) => {\n00056|       if (!dbInstance) {\n00057|         resolve(false);\n00058|         return;\n00059|       }\n00060|       \n00061|       try {\n00062|         const transaction = dbInstance.transaction([STORE_NAME], 'readwrite');\n00063|         const store = transaction.objectStore(STORE_NAME);\n00064|         const data = {\n00065|           key: key,\n00066|           value: value,\n00067|           timestamp: Date.now()\n00068|         };\n00069|         \n00070|         const request = store.put(data);\n00071|         \n00072|         request.onsuccess = () => {\n00073|           console.log(`[FORM-GUARDIAN] Сохранено в IndexedDB: ${key}`);\n00074|           resolve(true);\n00075|         };\n00076|         \n00077|         request.onerror = () => {\n00078|           console.error(`[FORM-GUARDIAN] Ошибка сохранения в IndexedDB: ${key}`, request.error);\n00079|           resolve(false);\n00080|         };\n00081|       } catch (error) {\n00082|         console.error('[FORM-GUARDIAN] Исключение при сохранении в IndexedDB:', error);\n00083|         resolve(false);\n00084|       }\n00085|     });\n00086|   }\n00087|   \n00088|   function loadFromIndexedDB(key) {\n00089|     return new Promise((resolve) => {\n00090|       if (!dbInstance) {\n00091|         resolve(null);\n00092|         return;\n00093|       }\n00094|       \n00095|       try {\n00096|         const transaction = dbInstance.transaction([STORE_NAME], 'readonly');\n00097|         const store = transaction.objectStore(STORE_NAME);\n00098|         const request = store.get(key);\n00099|         \n00100|         request.onsuccess = () => {\n00101|           const result = request.result;\n00102|           if (result) {\n00103|             console.log(`[FORM-GUARDIAN] Загружено из IndexedDB: ${key}`);\n00104|             resolve(result.value);\n00105|           } else {\n00106|             console.log(`[FORM-GUARDIAN] Данные не найдены в IndexedDB: ${key}`);\n00107|             resolve(null);\n00108|           }\n00109|         };\n00110|         \n00111|         request.onerror = () => {\n00112|           console.error(`[FORM-GUARDIAN] Ошибка загрузки из IndexedDB: ${key}`, request.error);\n00113|           resolve(null);\n00114|         };\n00115|       } catch (error) {\n00116|         console.error('[FORM-GUARDIAN] Исключение при загрузке из IndexedDB:', error);\n00117|         resolve(null);\n00118|       }\n00119|     });\n00120|   }\n00121|   \n00122|   // Функция сохранения данных в резервные копии\n00123|   async function createBackups() {\n00124|     try {\n00125|       const formData = localStorage.getItem(FORM_DATA_KEY);\n00126|       const appVersion = localStorage.getItem(APP_VERSION_KEY);\n00127|       \n00128|       if (formData) {\n00129|         formDataBackup = formData;\n00130|         // Создаем несколько резервных копий в localStorage\n00131|         BACKUP_KEYS.forEach((key, index) => {\n00132|           setTimeout(() => {\n00133|             try {\n00134|               localStorage.setItem(key, formData);\n00135|             } catch (e) {\n00136|               console.warn('[FORM-GUARDIAN] Backup failed for:', key, e);\n00137|             }\n00138|           }, index * 10);\n00139|         });\n00140|       }\n00141|       \n00142|       if (appVersion) {\n00143|         appVersionBackup = appVersion;\n00144|         localStorage.setItem('appVersionBackup', appVersion);\n00145|       }\n00146|       \n00147|       console.log('[FORM-GUARDIAN] Backup created:', !!formData, !!appVersion);\n00148|     } catch (e) {\n00149|       console.warn('[FORM-GUARDIAN] Backup creation failed:', e);\n00150|     }\n00151|   }\n00152|   \n00153|   // Функция восстановления данных\n00154|   function restoreFormData() {\n00155|     try {\n00156|       let restored = false;\n00157|       \n00158|       // Проверяем, нужно ли восстановление\n00159|       const currentFormData = localStorage.getItem(FORM_DATA_KEY);\n00160|       if (currentFormData) {\n00161|         console.log('[FORM-GUARDIAN] Form data already exists, no restore needed');\n00162|         return;\n00163|       }\n00164|       \n00165|       // Пытаемся восстановить из memory backup\n00166|       if (formDataBackup) {\n00167|         localStorage.setItem(FORM_DATA_KEY, formDataBackup);\n00168|         console.log('[FORM-GUARDIAN] Restored from memory backup');\n00169|         restored = true;\n00170|       }\n00171|       \n00172|       // Пытаемся восстановить из localStorage backups\n00173|       if (!restored) {\n00174|         for (const backupKey of BACKUP_KEYS) {\n00175|           const backup = localStorage.getItem(backupKey);\n00176|           if (backup) {\n00177|             localStorage.setItem(FORM_DATA_KEY, backup);\n00178|             console.log('[FORM-GUARDIAN] Restored from', backupKey);\n00179|             restored = true;\n00180|             break;\n00181|           }\n00182|         }\n00183|       }\n00184|       \n00185|       // Восстанавливаем версию приложения\n00186|       if (appVersionBackup && !localStorage.getItem(APP_VERSION_KEY)) {\n00187|         localStorage.setItem(APP_VERSION_KEY, appVersionBackup);\n00188|         console.log('[FORM-GUARDIAN] App version restored');\n00189|       }\n00190|       \n00191|       if (restored) {\n00192|         console.log('[FORM-GUARDIAN] ✅ Form data successfully restored');\n00193|         // Пересоздаем backup после восстановления\n00194|         setTimeout(createBackups, 100);\n00195|       } else {\n00196|         console.log('[FORM-GUARDIAN] No backup data found for restoration');\n00197|       }\n00198|       \n00199|     } catch (e) {\n00200|       console.warn('[FORM-GUARDIAN] Restore failed:', e);\n00201|     }\n00202|   }\n00203|   \n00204|   // Мониторинг изменений localStorage\n00205|   function monitorLocalStorage() {\n00206|     if (guardianActive) return;\n00207|     \n00208|     guardianActive = true;\n00209|     console.log('[FORM-GUARDIAN] Monitoring localStorage changes...');\n00210|     \n00211|     // Сохраняем текущие данные\n00212|     createBackups();\n00213|     \n00214|     // Периодически проверяем и восстанавливаем данные\n00215|     const restoreInterval = setInterval(() => {\n00216|       const formData = localStorage.getItem(FORM_DATA_KEY);\n00217|       if (!formData && (formDataBackup || localStorage.getItem(BACKUP_KEYS[0]))) {\n00218|         console.log('[FORM-GUARDIAN] Detected data loss, restoring...');\n00219|         restoreFormData();\n00220|       }\n00221|     }, 500);\n00222|     \n00223|     // Отложенное восстановление после загрузки страницы\n00224|     setTimeout(() => {\n00225|       restoreFormData();\n00226|     }, 1000);\n00227|     \n00228|     // Дополнительное восстановление через 3 секунды (после всех Clear-Site-Data)\n00229|     setTimeout(() => {\n00230|       restoreFormData();\n00231|     }, 3000);\n00232|     \n00233|     // Обновляем backup при изменениях\n00234|     const originalSetItem = localStorage.setItem;\n00235|     localStorage.setItem = function(key, value) {\n00236|       originalSetItem.call(this, key, value);\n00237|       if (key === FORM_DATA_KEY || key === APP_VERSION_KEY) {\n00238|         setTimeout(createBackups, 50);\n00239|       }\n00240|     };\n00241|     \n00242|     // Восстанавливаем при storage events\n00243|     window.addEventListener('storage', function(e) {\n00244|       if (e.key === FORM_DATA_KEY && !e.newValue && formDataBackup) {\n00245|         console.log('[FORM-GUARDIAN] Storage event detected data loss, restoring...');\n00246|         setTimeout(restoreFormData, 100);\n00247|       }\n00248|     });\n00249|     \n00250|     console.log('[FORM-GUARDIAN] ✅ Guardian activated');\n00251|   }\n00252|   \n00253|   // Запускаем мониторинг\n00254|   if (document.readyState === 'loading') {\n00255|     document.addEventListener('DOMContentLoaded', monitorLocalStorage);\n00256|   } else {\n00257|     monitorLocalStorage();\n00258|   }\n00259|   \n00260|   // Запускаем немедленно\n00261|   setTimeout(monitorLocalStorage, 0);\n00262|   \n00263| })();\n</file>",
    "metadata": {
      "preview": "// PERSISTENT FORM DATA GUARDIAN WITH INDEXEDDB\n// Защищает данные формы от любых видов очистки, включая Clear-Site-Data\n(function() {\n  'use strict';\n  \n  console.log('[FORM-GUARDIAN] Инициализация с IndexedDB защитой...');\n  \n  const FORM_DATA_KEY = 'deliveryFormData';\n  const APP_VERSION_KEY = 'appVersion';\n  const BACKUP_KEYS = ['formBackup1', 'formBackup2', 'formBackup3'];\n  const DB_NAME = 'LavsitFormStorage';\n  const DB_VERSION = 1;\n  const STORE_NAME = 'formData';\n  \n  let formDataBackup = null;\n  let appVersionBackup = null;\n  let guardianActive = false;\n  let indexedDB = null;\n  let dbInstance = null;\n  "
    },
    "title": "public/persistent-form-guardian.js",
    "time": {
      "start": 1759765494022,
      "end": 1759765494025
    }
  }
}