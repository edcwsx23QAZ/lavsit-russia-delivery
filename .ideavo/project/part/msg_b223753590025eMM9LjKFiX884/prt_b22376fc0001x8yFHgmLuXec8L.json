{
  "id": "prt_b22376fc0001x8yFHgmLuXec8L",
  "sessionID": "ses_4ec400949ffekDUyPGFumLInaA",
  "messageID": "msg_b223753590025eMM9LjKFiX884",
  "type": "tool",
  "callID": "call_42445415",
  "tool": "read",
  "state": {
    "status": "completed",
    "input": {
      "filePath": "app/api/cdek/route.ts"
    },
    "output": "<file>\n00001| import { NextRequest, NextResponse } from 'next/server';\n00002| import { apiRequestWithTimeout, PerformanceMonitor } from '@/lib/api-utils';\n00003| \n00004| const CDEK_CLIENT_ID = '3J5AvQWReEdW1o01PApvw6jHsnkNpqT1';\n00005| const CDEK_CLIENT_SECRET = 'T8iMvgShV0p9OfJiysSBpCCWcXtOO0Hy';\n00006| const CDEK_API_URL = 'https://api.cdek.ru/v2';\n00007| \n00008| let cachedToken: string | null = null;\n00009| let tokenExpiry: number = 0;\n00010| \n00011| async function getCdekToken(): Promise<string> {\n00012|   if (cachedToken && Date.now() < tokenExpiry) {\n00013|     return cachedToken;\n00014|   }\n00015| \n00016|   const credentials = Buffer.from(`${CDEK_CLIENT_ID}:${CDEK_CLIENT_SECRET}`).toString('base64');\n00017| \n00018|   const response = await apiRequestWithTimeout(`${CDEK_API_URL}/oauth/token`, {\n00019|     method: 'POST',\n00020|     headers: {\n00021|       'Content-Type': 'application/x-www-form-urlencoded'\n00022|     },\n00023|     body: `grant_type=client_credentials&client_id=${CDEK_CLIENT_ID}&client_secret=${CDEK_CLIENT_SECRET}`\n00024|   }, { timeout: 10000, retries: 2 });\n00025| \n00026|   if (!response.ok) {\n00027|     throw new Error(`CDEK OAuth failed: ${response.status} ${response.statusText}`);\n00028|   }\n00029| \n00030|   const data = await response.json();\n00031|   cachedToken = data.access_token;\n00032|   tokenExpiry = Date.now() + (data.expires_in - 60) * 1000;\n00033| \n00034|   if (!cachedToken) {\n00035|     throw new Error('Failed to get CDEK access token');\n00036|   }\n00037| \n00038|   return cachedToken;\n00039| }\n00040| \n00041| async function getCityCode(cityName: string, token: string): Promise<number | null> {\n00042|   try {\n00043|     const response = await apiRequestWithTimeout(\n00044|       `${CDEK_API_URL}/location/cities?city=${encodeURIComponent(cityName)}&size=1`,\n00045|       {\n00046|         method: 'GET',\n00047|         headers: {\n00048|           'Authorization': `Bearer ${token}`,\n00049|           'Content-Type': 'application/json'\n00050|         }\n00051|       },\n00052|       { timeout: 8000, retries: 1 }\n00053|     );\n00054| \n00055|     if (!response.ok) {\n00056|       console.error(`CDEK city lookup failed for ${cityName}: ${response.status}`);\n00057|       return null;\n00058|     }\n00059| \n00060|     const data = await response.json();\n00061|     if (data && data.length > 0 && data[0].code) {\n00062|       return data[0].code;\n00063|     }\n00064| \n00065|     return null;\n00066|   } catch (error) {\n00067|     console.error(`Error looking up city ${cityName}:`, error);\n00068|     return null;\n00069|   }\n00070| }\n00071| \n00072| export async function POST(request: NextRequest) {\n00073|   const endTiming = PerformanceMonitor.startMeasurement('cdek_api_total');\n00074|   \n00075|   try {\n00076|     const body = await request.json();\n00077|     \n00078|     console.log('üì¶ CDEK API –∑–∞–ø—Ä–æ—Å:', JSON.stringify(body, null, 2));\n00079| \n00080|     const token = await getCdekToken();\n00081| \n00082|     const fromCityCode = await getCityCode(body.from_city || '–ú–æ—Å–∫–≤–∞', token);\n00083|     const toCityCode = await getCityCode(body.to_city || '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥', token);\n00084| \n00085|     if (!fromCityCode || !toCityCode) {\n00086|       return NextResponse.json({\n00087|         success: false,\n00088|         error: '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–æ–¥—ã –≥–æ—Ä–æ–¥–æ–≤',\n00089|         details: {\n00090|           fromCity: body.from_city,\n00091|           toCity: body.to_city,\n00092|           fromCityCode,\n00093|           toCityCode\n00094|         }\n00095|       }, { status: 400 });\n00096|     }\n00097| \n00098|     const packages = body.packages || [{\n00099|       height: body.height || 10,\n00100|       length: body.length || 20,\n00101|       width: body.width || 10,\n00102|       weight: body.weight || 1000\n00103|     }];\n00104| \n00105|     const now = new Date();\n00106|     const offset = -now.getTimezoneOffset();\n00107|     const sign = offset >= 0 ? '+' : '-';\n00108|     const pad = (num: number) => String(Math.abs(num)).padStart(2, '0');\n00109|     const hours = pad(Math.floor(Math.abs(offset) / 60));\n00110|     const minutes = pad(Math.abs(offset) % 60);\n00111|     const dateFormatted = now.getFullYear() + '-' + \n00112|       pad(now.getMonth() + 1) + '-' + \n00113|       pad(now.getDate()) + 'T' + \n00114|       pad(now.getHours()) + ':' + \n00115|       pad(now.getMinutes()) + ':' + \n00116|       pad(now.getSeconds()) + sign + hours + minutes;\n00117| \n00118|     const requestData: any = {\n00119|       type: 1,\n00120|       date: dateFormatted,\n00121|       lang: 'rus',\n00122|       from_location: {\n00123|         code: fromCityCode\n00124|       },\n00125|       to_location: {\n00126|         code: toCityCode\n00127|       },\n00128|       packages: packages\n00129|     };\n00130| \n00131|     if (body.services && body.services.length > 0) {\n00132|       requestData.services = body.services;\n00133|       console.log('üì¶ CDEK: –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏', body.services);\n00134|     }\n00135| \n00136|     console.log('üì¶ CDEK –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –∑–∞–ø—Ä–æ—Å:', JSON.stringify(requestData, null, 2));\n00137| \n00138|     const response = await apiRequestWithTimeout(`${CDEK_API_URL}/calculator/tarifflist`, {\n00139|       method: 'POST',\n00140|       headers: {\n00141|         'Authorization': `Bearer ${token}`,\n00142|         'Content-Type': 'application/json'\n00143|       },\n00144|       body: JSON.stringify(requestData)\n00145|     }, { timeout: 12000, retries: 1 });\n00146| \n00147|     console.log(`üì¶ CDEK API —Å—Ç–∞—Ç—É—Å: ${response.status} ${response.statusText}`);\n00148| \n00149|     if (!response.ok) {\n00150|       const errorText = await response.text();\n00151|       console.error('üì¶ CDEK API –æ—à–∏–±–∫–∞:', errorText);\n00152|       \n00153|       return NextResponse.json({\n00154|         success: false,\n00155|         error: `API –æ—à–∏–±–∫–∞: ${response.status} ${response.statusText}`,\n00156|         details: errorText\n00157|       }, { status: response.status });\n00158|     }\n00159| \n00160|     const data = await response.json();\n00161|     console.log('üì¶ CDEK API –æ—Ç–≤–µ—Ç —Ç–∞—Ä–∏—Ñ–æ–≤:', data.tariff_codes?.length || 0, '–≤–∞—Ä–∏–∞–Ω—Ç–æ–≤');\n00162| \n00163|     if (data.errors && data.errors.length > 0) {\n00164|       console.error('üì¶ CDEK API –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫–∏:', data.errors);\n00165|       return NextResponse.json({\n00166|         success: false,\n00167|         error: data.errors[0].message || 'CDEK API error',\n00168|         details: data.errors\n00169|       }, { status: 400 });\n00170|     }\n00171| \n00172|     if (body.tariff_code && body.get_details) {\n00173|       console.log('üì¶ CDEK: –∑–∞–ø—Ä–æ—Å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–ª—è —Ç–∞—Ä–∏—Ñ–∞', body.tariff_code);\n00174|       \n00175|       const detailsRequest: any = {\n00176|         type: 1,\n00177|         date: dateFormatted,\n00178|         lang: 'rus',\n00179|         tariff_code: body.tariff_code,\n00180|         from_location: {\n00181|           code: fromCityCode\n00182|         },\n00183|         to_location: {\n00184|           code: toCityCode\n00185|         },\n00186|         packages: packages\n00187|       };\n00188| \n00189|       if (body.services && body.services.length > 0) {\n00190|         detailsRequest.services = body.services;\n00191|         console.log('üì¶ CDEK –¥–µ—Ç–∞–ª–∏: –¥–æ–±–∞–≤–ª–µ–Ω—ã —É—Å–ª—É–≥–∏', body.services);\n00192|       }\n00193| \n00194|       const detailsResponse = await apiRequestWithTimeout(`${CDEK_API_URL}/calculator/tariff`, {\n00195|         method: 'POST',\n00196|         headers: {\n00197|           'Authorization': `Bearer ${token}`,\n00198|           'Content-Type': 'application/json'\n00199|         },\n00200|         body: JSON.stringify(detailsRequest)\n00201|       }, { timeout: 12000, retries: 1 });\n00202| \n00203|       if (detailsResponse.ok) {\n00204|         const detailsData = await detailsResponse.json();\n00205|         console.log('üì¶ CDEK –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è:', JSON.stringify(detailsData, null, 2));\n00206|         endTiming();\n00207|         return NextResponse.json({\n00208|           ...data,\n00209|           tariff_details: detailsData\n00210|         });\n00211|       }\n00212|     }\n00213| \n00214|     endTiming();\n00215|     return NextResponse.json(data);\n00216| \n00217|   } catch (error: any) {\n00218|     console.error('üì¶ CDEK API –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:', error);\n00219|     endTiming();\n00220|     return NextResponse.json({\n00221|       success: false,\n00222|       error: error.message || '–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞',\n00223|       details: error.stack\n00224|     }, { status: 500 });\n00225|   }\n00226| }\n00227| \n\n(End of file - total 227 lines)\n</file>",
    "title": "app/api/cdek/route.ts",
    "metadata": {
      "preview": "import { NextRequest, NextResponse } from 'next/server';\nimport { apiRequestWithTimeout, PerformanceMonitor } from '@/lib/api-utils';\n\nconst CDEK_CLIENT_ID = '3J5AvQWReEdW1o01PApvw6jHsnkNpqT1';\nconst CDEK_CLIENT_SECRET = 'T8iMvgShV0p9OfJiysSBpCCWcXtOO0Hy';\nconst CDEK_API_URL = 'https://api.cdek.ru/v2';\n\nlet cachedToken: string | null = null;\nlet tokenExpiry: number = 0;\n\nasync function getCdekToken(): Promise<string> {\n  if (cachedToken && Date.now() < tokenExpiry) {\n    return cachedToken;\n  }\n\n  const credentials = Buffer.from(`${CDEK_CLIENT_ID}:${CDEK_CLIENT_SECRET}`).toString('base64');\n\n  const response = await apiRequestWithTimeout(`${CDEK_API_URL}/oauth/token`, {\n    method: 'POST',\n    headers: {"
    },
    "time": {
      "start": 1765805617089,
      "end": 1765805617093,
      "compacted": 1765813906383
    }
  }
}