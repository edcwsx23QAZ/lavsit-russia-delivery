{
  "id": "prt_9e1f57221001RwFGUkSkOa1y79",
  "messageID": "msg_9e1f5652a0021siI9h7JaMmW6v",
  "sessionID": "ses_6852784ecffeuHwynj83p2lr14",
  "type": "tool",
  "tool": "write",
  "callID": "toolu_017BCRTnm3sktLJc8CtowdDT",
  "state": {
    "status": "completed",
    "input": {
      "filePath": "/home/user/project/app/api/cdek/route.ts",
      "content": "import { NextRequest, NextResponse } from 'next/server';\nimport { apiRequestWithTimeout, PerformanceMonitor } from '@/lib/api-utils';\n\nconst CDEK_CLIENT_ID = 'wqGwiQx0gg8mLtiEKsUinjVSICCjtTEP';\nconst CDEK_CLIENT_SECRET = 'RmAmgvSgSl1yirlz9QupbzOJVqhCxcP5';\nconst CDEK_API_URL = 'https://api.cdek.ru/v2';\n\nlet cachedToken: string | null = null;\nlet tokenExpiry: number = 0;\n\nasync function getCdekToken(): Promise<string> {\n  if (cachedToken && Date.now() < tokenExpiry) {\n    return cachedToken;\n  }\n\n  const credentials = Buffer.from(`${CDEK_CLIENT_ID}:${CDEK_CLIENT_SECRET}`).toString('base64');\n\n  const response = await apiRequestWithTimeout(`${CDEK_API_URL}/oauth/token?parameters`, {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/x-www-form-urlencoded',\n      'Authorization': `Basic ${credentials}`\n    },\n    body: 'grant_type=client_credentials'\n  }, { timeout: 10000, retries: 2 });\n\n  if (!response.ok) {\n    throw new Error(`CDEK OAuth failed: ${response.status} ${response.statusText}`);\n  }\n\n  const data = await response.json();\n  cachedToken = data.access_token;\n  tokenExpiry = Date.now() + (data.expires_in - 60) * 1000;\n\n  return cachedToken;\n}\n\nasync function getCityCode(cityName: string, token: string): Promise<number | null> {\n  try {\n    const response = await apiRequestWithTimeout(\n      `${CDEK_API_URL}/location/cities?city=${encodeURIComponent(cityName)}&size=1`,\n      {\n        method: 'GET',\n        headers: {\n          'Authorization': `Bearer ${token}`,\n          'Content-Type': 'application/json'\n        }\n      },\n      { timeout: 8000, retries: 1 }\n    );\n\n    if (!response.ok) {\n      console.error(`CDEK city lookup failed for ${cityName}: ${response.status}`);\n      return null;\n    }\n\n    const data = await response.json();\n    if (data && data.length > 0 && data[0].code) {\n      return data[0].code;\n    }\n\n    return null;\n  } catch (error) {\n    console.error(`Error looking up city ${cityName}:`, error);\n    return null;\n  }\n}\n\nexport async function POST(request: NextRequest) {\n  const endTiming = PerformanceMonitor.startMeasurement('cdek_api_total');\n  \n  try {\n    const body = await request.json();\n    \n    console.log('üì¶ CDEK API –∑–∞–ø—Ä–æ—Å:', JSON.stringify(body, null, 2));\n\n    const token = await getCdekToken();\n\n    const fromCityCode = await getCityCode(body.from_city || '–ú–æ—Å–∫–≤–∞', token);\n    const toCityCode = await getCityCode(body.to_city || '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥', token);\n\n    if (!fromCityCode || !toCityCode) {\n      return NextResponse.json({\n        success: false,\n        error: '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–æ–¥—ã –≥–æ—Ä–æ–¥–æ–≤',\n        details: {\n          fromCity: body.from_city,\n          toCity: body.to_city,\n          fromCityCode,\n          toCityCode\n        }\n      }, { status: 400 });\n    }\n\n    const packages = body.packages || [{\n      height: body.height || 10,\n      length: body.length || 20,\n      width: body.width || 10,\n      weight: body.weight || 1000\n    }];\n\n    const requestData = {\n      type: 1,\n      date: new Date().toISOString(),\n      lang: 'rus',\n      from_location: {\n        code: fromCityCode\n      },\n      to_location: {\n        code: toCityCode\n      },\n      packages: packages\n    };\n\n    console.log('üì¶ CDEK –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –∑–∞–ø—Ä–æ—Å:', JSON.stringify(requestData, null, 2));\n\n    const response = await apiRequestWithTimeout(`${CDEK_API_URL}/calculator/tarifflist`, {\n      method: 'POST',\n      headers: {\n        'Authorization': `Bearer ${token}`,\n        'Content-Type': 'application/json'\n      },\n      body: JSON.stringify(requestData)\n    }, { timeout: 12000, retries: 1 });\n\n    console.log(`üì¶ CDEK API —Å—Ç–∞—Ç—É—Å: ${response.status} ${response.statusText}`);\n\n    if (!response.ok) {\n      const errorText = await response.text();\n      console.error('üì¶ CDEK API –æ—à–∏–±–∫–∞:', errorText);\n      \n      return NextResponse.json({\n        success: false,\n        error: `API –æ—à–∏–±–∫–∞: ${response.status} ${response.statusText}`,\n        details: errorText\n      }, { status: response.status });\n    }\n\n    const data = await response.json();\n    console.log('üì¶ CDEK API –æ—Ç–≤–µ—Ç:', JSON.stringify(data, null, 2));\n\n    if (data.errors && data.errors.length > 0) {\n      console.error('üì¶ CDEK API –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫–∏:', data.errors);\n      return NextResponse.json({\n        success: false,\n        error: data.errors[0].message || 'CDEK API error',\n        details: data.errors\n      }, { status: 400 });\n    }\n\n    endTiming();\n    return NextResponse.json(data);\n\n  } catch (error: any) {\n    console.error('üì¶ CDEK API –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:', error);\n    endTiming();\n    return NextResponse.json({\n      success: false,\n      error: error.message || '–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞',\n      details: error.stack\n    }, { status: 500 });\n  }\n}\n"
    },
    "output": "",
    "metadata": {
      "diagnostics": {},
      "filepath": "/home/user/project/app/api/cdek/route.ts",
      "exists": false
    },
    "title": "app/api/cdek/route.ts",
    "time": {
      "start": 1760432603901,
      "end": 1760432603907,
      "compacted": 1760450580040
    }
  }
}