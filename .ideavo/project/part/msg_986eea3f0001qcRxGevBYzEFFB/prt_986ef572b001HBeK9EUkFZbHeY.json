{
  "id": "prt_986ef572b001HBeK9EUkFZbHeY",
  "messageID": "msg_986eea3f0001qcRxGevBYzEFFB",
  "sessionID": "ses_6852784ecffeuHwynj83p2lr14",
  "type": "tool",
  "tool": "write",
  "callID": "toolu_01HySRpLXm4zZixWbvVcSezt",
  "state": {
    "status": "completed",
    "input": {
      "filePath": "/home/user/project/app/api/pek/route.ts",
      "content": "import { NextRequest, NextResponse } from 'next/server';\n\nexport async function POST(request: NextRequest) {\n  try {\n    console.log('üîß –ü–≠–ö –ü—Ä–æ–∫—Å–∏: –ü–æ–ª—É—á–µ–Ω –∑–∞–ø—Ä–æ—Å (–ø–æ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏)');\n    \n    const requestData = await request.json();\n    console.log('üìù –î–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å–∞:', JSON.stringify(requestData, null, 2));\n    \n    const { method, address, coordinates } = requestData;\n    \n    // –î–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –ü–≠–ö\n    const PEK_API_KEY = '624FC93CA677B23673BB476D4982294DC27E246F';\n    const PEK_LOGIN = 'demo'; // –ù—É–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π –ª–æ–≥–∏–Ω –∏–∑ –ª–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞\n    \n    // –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –±–∞–∑–æ–≤—ã–π URL —Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏\n    const BASE_URL = 'https://kabinet.pecom.ru/api/v1';\n    \n    let urlPath = '';\n    let body = {};\n    \n    switch (method) {\n      case 'findzonebyaddress':\n        urlPath = '/branches/findzonebyaddress/';\n        body = { address: address };\n        break;\n        \n      case 'findzonebycoordinates':\n        urlPath = '/branches/findzonebycoordinates/';\n        body = {\n          longitude: coordinates.longitude,\n          latitude: coordinates.latitude\n        };\n        break;\n        \n      case 'calculateprice':\n        urlPath = '/calculator/calculateprice/';\n        const { method: methodName, ...calculationData } = requestData;\n        body = calculationData;\n        break;\n        \n      case 'nearestdepartments':\n        urlPath = '/branches/nearestdepartments/';\n        const { method: nearestMethod, ...departmentData } = requestData;\n        body = departmentData;\n        break;\n        \n      case 'test':\n        console.log('üîß –¢–µ—Å—Ç–æ–≤—ã–π –º–µ—Ç–æ–¥ –ø—Ä–æ–∫—Å–∏');\n        return NextResponse.json({ \n          status: 'OK', \n          message: '–ü—Ä–æ–∫—Å–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç (–æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è)',\n          timestamp: new Date().toISOString(),\n          receivedData: requestData,\n          authMethod: 'Basic Auth',\n          baseUrl: BASE_URL\n        });\n        \n      default:\n        console.log('‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –º–µ—Ç–æ–¥:', method);\n        return NextResponse.json({ error: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –º–µ—Ç–æ–¥', method }, { status: 400 });\n    }\n    \n    const fullUrl = BASE_URL + urlPath;\n    \n    // Basic Auth —Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏: base64(login:api_key)\n    const credentials = Buffer.from(`${PEK_LOGIN}:${PEK_API_KEY}`).toString('base64');\n    \n    console.log('üåê –ó–∞–ø—Ä–æ—Å –∫ –ü–≠–ö API (–æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è):');\n    console.log('URL:', fullUrl);\n    console.log('Auth: Basic (–ª–æ–≥–∏–Ω + API –∫–ª—é—á)');\n    console.log('Body:', JSON.stringify(body, null, 2));\n    \n    try {\n      const response = await fetch(fullUrl, {\n        method: 'POST',\n        headers: {\n          // –ó–∞–≥–æ–ª–æ–≤–∫–∏ —Å–æ–≥–ª–∞—Å–Ω–æ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏\n          'Content-Type': 'application/json;charset=utf-8',\n          'Accept': 'application/json',\n          'Accept-Encoding': 'gzip',\n          'Authorization': `Basic ${credentials}`,\n        },\n        body: JSON.stringify(body)\n      });\n      \n      console.log('üì° –û—Ç–≤–µ—Ç –æ—Ç –ü–≠–ö API:');\n      console.log('Status:', response.status, response.statusText);\n      console.log('Headers:', Object.fromEntries(response.headers.entries()));\n      \n      if (!response.ok) {\n        const errorText = await response.text();\n        console.error('‚ùå –ü–≠–ö API –æ—à–∏–±–∫–∞:', response.status, response.statusText);\n        console.error('‚ùå –û—Ç–≤–µ—Ç:', errorText.substring(0, 1000));\n        \n        // –î–µ—Ç–∞–ª–∏–∑–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ —Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏\n        if (response.status === 404) {\n          return NextResponse.json({ \n            error: '–ú–µ—Ç–æ–¥ API –Ω–µ –Ω–∞–π–¥–µ–Ω',\n            details: 'URL –º–µ—Ç–æ–¥–∞ –Ω–µ–≤–µ—Ä–Ω—ã–π –∏–ª–∏ –º–µ—Ç–æ–¥ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç',\n            url: fullUrl,\n            suggestion: '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –ø—É—Ç–∏ –∫ –º–µ—Ç–æ–¥—É'\n          }, { status: 404 });\n        }\n        \n        if (response.status === 403) {\n          return NextResponse.json({ \n            error: '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω',\n            details: '–ù–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–µ—Ç–æ–¥—É',\n            suggestion: '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ –º–µ—Ç–æ–¥–∞'\n          }, { status: 403 });\n        }\n        \n        if (response.status === 401) {\n          return NextResponse.json({ \n            error: '–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏',\n            details: '–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ API –∫–ª—é—á',\n            suggestion: '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –ü–≠–ö'\n          }, { status: 401 });\n        }\n        \n        return NextResponse.json({ \n          error: `–ü–≠–ö API –æ—à–∏–±–∫–∞: ${response.status} ${response.statusText}`,\n          details: errorText,\n          url: fullUrl,\n          method,\n          requestBody: body\n        }, { status: response.status });\n      }\n      \n      const responseText = await response.text();\n      console.log('‚úÖ –£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç –ü–≠–ö:', responseText.substring(0, 500));\n      \n      try {\n        const data = JSON.parse(responseText);\n        \n        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç –æ—à–∏–±–∫–∏ —Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏\n        if (data.error) {\n          console.error('‚ùå –õ–æ–≥–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ü–≠–ö:', data.error);\n          return NextResponse.json({ \n            error: data.error.title || '–õ–æ–≥–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ API',\n            details: data.error.message || '–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã',\n            apiError: true,\n            originalError: data.error\n          }, { status: 400 });\n        }\n        \n        return NextResponse.json(data);\n      } catch (parseError) {\n        console.error('‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON:', parseError);\n        return NextResponse.json({ \n          error: '–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –æ—Ç–≤–µ—Ç–∞',\n          details: responseText.substring(0, 1000)\n        }, { status: 500 });\n      }\n      \n    } catch (fetchError) {\n      console.error('‚ùå –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞:', fetchError);\n      return NextResponse.json({ \n        error: '–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞',\n        details: fetchError instanceof Error ? fetchError.message : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞',\n        url: fullUrl\n      }, { status: 503 });\n    }\n    \n  } catch (error) {\n    console.error('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–æ–∫—Å–∏ –ü–≠–ö API:', error);\n    \n    if (error instanceof Error) {\n      console.error('Stack trace:', error.stack);\n    }\n    \n    return NextResponse.json({ \n      error: '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞',\n      details: error instanceof Error ? error.message : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞',\n      type: error instanceof Error ? error.name : 'Unknown',\n      stack: error instanceof Error ? error.stack : undefined\n    }, { status: 500 });\n  }\n}"
    },
    "output": "",
    "metadata": {
      "diagnostics": {},
      "filepath": "/home/user/project/app/api/pek/route.ts",
      "exists": true
    },
    "title": "app/api/pek/route.ts",
    "time": {
      "start": 1758905479558,
      "end": 1758905479560
    }
  }
}