{
  "id": "prt_ab46ccea400166kZerisLR14fZ",
  "sessionID": "ses_54b97e247ffenCZZa4jZiIWD0l",
  "messageID": "msg_ab46c03ef002daGZKwQiXt4UTD",
  "type": "tool",
  "callID": "call_a36f446342a74594b1671427",
  "tool": "write",
  "state": {
    "status": "completed",
    "input": {
      "filePath": "/home/user/project/lib/cache-manager.ts",
      "content": "// –°–∏—Å—Ç–µ–º–∞ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è API —Å–µ—Å—Å–∏–π –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ä–∞—Å—á–µ—Ç–æ–≤\n\ninterface CacheEntry<T> {\n  data: T;\n  timestamp: number;\n  expires: number;\n}\n\ninterface SessionCache {\n  token: string | null;\n  timestamp: number;\n  expires: number;\n}\n\ninterface CalculationCacheKey {\n  fromCity: string;\n  toCity: string;\n  cargos: Array<{ length: number; width: number; height: number; weight: number }>;\n  declaredValue: number;\n  needPackaging: boolean;\n  needInsurance: boolean;\n  fromAddressDelivery: boolean;\n  toAddressDelivery: boolean;\n  needLoading: boolean;\n  needCarry: boolean;\n  floor: number;\n  hasFreightLift: boolean;\n}\n\nclass CacheManager {\n  private sessionCache: Map<string, SessionCache> = new Map();\n  private calculationCache: Map<string, CacheEntry<any>> = new Map();\n  private cityCache: Map<string, CacheEntry<any>> = new Map();\n\n  // –ö—ç—à —Å–µ—Å—Å–∏–π API (5 –º–∏–Ω—É—Ç)\n  private readonly SESSION_TTL = 5 * 60 * 1000; // 5 –º–∏–Ω—É—Ç\n  \n  // –ö—ç—à —Ä–∞—Å—á–µ—Ç–æ–≤ (30 –º–∏–Ω—É—Ç)\n  private readonly CALCULATION_TTL = 30 * 60 * 1000; // 30 –º–∏–Ω—É—Ç\n  \n  // –ö—ç—à –≥–æ—Ä–æ–¥–æ–≤ (24 —á–∞—Å–∞)\n  private readonly CITY_TTL = 24 * 60 * 60 * 1000; // 24 —á–∞—Å–∞\n\n  // –ü–æ–ª—É—á–µ–Ω–∏–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å–µ—Å—Å–∏–∏\n  getSession(company: string): string | null {\n    const cache = this.sessionCache.get(company);\n    if (!cache) return null;\n    \n    if (Date.now() > cache.expires) {\n      this.sessionCache.delete(company);\n      return null;\n    }\n    \n    console.log(`üîë –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å–µ—Å—Å–∏—é –¥–ª—è ${company}`);\n    return cache.token;\n  }\n\n  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏\n  setSession(company: string, token: string): void {\n    this.sessionCache.set(company, {\n      token,\n      timestamp: Date.now(),\n      expires: Date.now() + this.SESSION_TTL\n    });\n    console.log(`üíæ –°–µ—Å—Å–∏—è –¥–ª—è ${company} –∑–∞–∫—ç—à–∏—Ä–æ–≤–∞–Ω–∞ –Ω–∞ ${this.SESSION_TTL / 1000}—Å`);\n  }\n\n  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–∞ –¥–ª—è –∫—ç—à–∞ —Ä–∞—Å—á–µ—Ç–æ–≤\n  private generateCalculationKey(key: CalculationCacheKey): string {\n    const sortedCargos = [...key.cargos]\n      .sort((a, b) => a.length - b.length || a.width - b.width || a.height - b.height || a.weight - b.weight);\n    \n    return JSON.stringify({\n      from: key.fromCity.toLowerCase().trim(),\n      to: key.toCity.toLowerCase().trim(),\n      cargos: sortedCargos,\n      value: key.declaredValue,\n      packaging: key.needPackaging,\n      insurance: key.needInsurance,\n      fromAddr: key.fromAddressDelivery,\n      toAddr: key.toAddressDelivery,\n      loading: key.needLoading,\n      carry: key.needCarry,\n      floor: key.floor,\n      lift: key.hasFreightLift\n    });\n  }\n\n  // –ü–æ–ª—É—á–µ–Ω–∏–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞\n  getCachedCalculation(company: string, key: CalculationCacheKey): any | null {\n    const cacheKey = `${company}_${this.generateCalculationKey(key)}`;\n    const cache = this.calculationCache.get(cacheKey);\n    \n    if (!cache) return null;\n    \n    if (Date.now() > cache.expires) {\n      this.calculationCache.delete(cacheKey);\n      return null;\n    }\n    \n    console.log(`üí∞ –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–∞—Å—á–µ—Ç –¥–ª—è ${company}`);\n    return cache.data;\n  }\n\n  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–∞—Å—á–µ—Ç–∞\n  setCachedCalculation(company: string, key: CalculationCacheKey, result: any): void {\n    const cacheKey = `${company}_${this.generateCalculationKey(key)}`;\n    this.calculationCache.set(cacheKey, {\n      data: result,\n      timestamp: Date.now(),\n      expires: Date.now() + this.CALCULATION_TTL\n    });\n    console.log(`üíæ –†–∞—Å—á–µ—Ç –¥–ª—è ${company} –∑–∞–∫—ç—à–∏—Ä–æ–≤–∞–Ω –Ω–∞ ${this.CALCULATION_TTL / 1000}—Å`);\n  }\n\n  // –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≥–æ—Ä–æ–¥–æ–≤\n  getCachedData(key: string): any | null {\n    const cache = this.cityCache.get(key);\n    if (!cache) return null;\n    \n    if (Date.now() > cache.expires) {\n      this.cityCache.delete(key);\n      return null;\n    }\n    \n    return cache.data;\n  }\n\n  setCachedData(key: string, data: any, ttl: number = this.CITY_TTL): void {\n    this.cityCache.set(key, {\n      data,\n      timestamp: Date.now(),\n      expires: Date.now() + ttl\n    });\n  }\n\n  // –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞\n  clearCache(type?: 'sessions' | 'calculations' | 'cities' | 'all'): void {\n    if (!type || type === 'all') {\n      this.sessionCache.clear();\n      this.calculationCache.clear();\n      this.cityCache.clear();\n      console.log('üßπ –í–µ—Å—å –∫—ç—à –æ—á–∏—â–µ–Ω');\n      return;\n    }\n\n    switch (type) {\n      case 'sessions':\n        this.sessionCache.clear();\n        console.log('üßπ –ö—ç—à —Å–µ—Å—Å–∏–π –æ—á–∏—â–µ–Ω');\n        break;\n      case 'calculations':\n        this.calculationCache.clear();\n        console.log('üßπ –ö—ç—à —Ä–∞—Å—á–µ—Ç–æ–≤ –æ—á–∏—â–µ–Ω');\n        break;\n      case 'cities':\n        this.cityCache.clear();\n        console.log('üßπ –ö—ç—à –≥–æ—Ä–æ–¥–æ–≤ –æ—á–∏—â–µ–Ω');\n        break;\n    }\n  }\n\n  // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∫—ç—à–∞\n  getCacheStats(): {\n    sessions: number;\n    calculations: number;\n    cities: number;\n    totalMemory: number;\n  } {\n    const sessions = this.sessionCache.size;\n    const calculations = this.calculationCache.size;\n    const cities = this.cityCache.size;\n    \n    // –ü—Ä–∏–º–µ—Ä–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ –ø–∞–º—è—Ç–∏ –≤ –±–∞–π—Ç–∞—Ö\n    const totalMemory = (sessions + calculations + cities) * 1024; // ~1KB –Ω–∞ –∑–∞–ø–∏—Å—å\n    \n    return {\n      sessions,\n      calculations,\n      cities,\n      totalMemory\n    };\n  }\n\n  // –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö —Å–µ—Å—Å–∏–π –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ\n  async preloadAllSessions(): Promise<void> {\n    console.log('üöÄ –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Å—Å–∏–π...');\n    \n    const sessionPromises = [\n      this.preloadDellinSession(),\n      this.preloadPekSession(),\n      // –î–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–≥–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ –ø–æ –º–µ—Ä–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏\n    ];\n\n    await Promise.allSettled(sessionPromises);\n    console.log('‚úÖ –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Å—Å–∏–π –∑–∞–≤–µ—Ä—à–µ–Ω–∞');\n  }\n\n  // –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Å—Å–∏–∏ –î–µ–ª–æ–≤—ã—Ö –õ–∏–Ω–∏–π\n  private async preloadDellinSession(): Promise<void> {\n    try {\n      const cached = this.getSession('dellin');\n      if (cached) return;\n\n      console.log('üîë –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Å—Å–∏–∏ –î–µ–ª–æ–≤—ã—Ö –õ–∏–Ω–∏–π...');\n      \n      const response = await fetch('https://api.dellin.ru/v3/auth/login.json', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          appkey: 'E6C50E91-8E93-440F-9CC6-DEF9F0D68F1B',\n          login: 'service@lavsit.ru',\n          password: 'edcwsx123QAZ'\n        })\n      });\n\n      const data = await response.json();\n      let sessionID = null;\n      \n      if (data.data?.sessionID) {\n        sessionID = data.data.sessionID;\n      } else if (data.sessionID) {\n        sessionID = data.sessionID;\n      } else if (data.data?.session) {\n        sessionID = data.data.session;\n      }\n\n      if (response.ok && sessionID) {\n        this.setSession('dellin', sessionID);\n        console.log('‚úÖ –°–µ—Å—Å–∏—è –î–µ–ª–æ–≤—ã—Ö –õ–∏–Ω–∏–π –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∂–µ–Ω–∞');\n      }\n    } catch (error) {\n      console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ—Å—Å–∏–∏ –î–µ–ª–æ–≤—ã—Ö –õ–∏–Ω–∏–π:', error);\n    }\n  }\n\n  // –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Å—Å–∏–∏ –ü–≠–ö\n  private async preloadPekSession(): Promise<void> {\n    try {\n      const cached = this.getSession('pek');\n      if (cached) return;\n\n      console.log('üîë –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Å—Å–∏–∏ –ü–≠–ö...');\n      \n      // –ü–≠–ö –∏—Å–ø–æ–ª—å–∑—É–µ—Ç API –∫–ª—é—á, –Ω–µ —Ç—Ä–µ–±—É–µ—Ç —Å–µ—Å—Å–∏–∏\n      // –ù–æ –º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å\n      const PEK_API_KEY = process.env.PEK_API_KEY || '624FC93CA677B23673BB476D4982294DC27E246F';\n      \n      if (PEK_API_KEY) {\n        this.setSession('pek', PEK_API_KEY);\n        console.log('‚úÖ –ö–ª—é—á –ü–≠–ö –∑–∞–∫—ç—à–∏—Ä–æ–≤–∞–Ω');\n      }\n    } catch (error) {\n      console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ—Å—Å–∏–∏ –ü–≠–ö:', error);\n    }\n  }\n}\n\n// –≠–∫—Å–ø–æ—Ä—Ç —Å–∏–Ω–≥–ª—Ç–æ–Ω–∞\nexport const cacheManager = new CacheManager();\n\n// –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫—ç—à–µ–º\nexport const createCalculationCacheKey = (form: any): CalculationCacheKey => ({\n  fromCity: form.fromCity || '',\n  toCity: form.toCity || '',\n  cargos: form.cargos || [],\n  declaredValue: form.declaredValue || 0,\n  needPackaging: form.needPackaging || false,\n  needInsurance: form.needInsurance || false,\n  fromAddressDelivery: form.fromAddressDelivery || false,\n  toAddressDelivery: form.toAddressDelivery || false,\n  needLoading: form.needLoading || false,\n  needCarry: form.needCarry || false,\n  floor: form.floor || 1,\n  hasFreightLift: form.hasFreightLift || false\n});\n\nexport default cacheManager;"
    },
    "output": "",
    "title": "lib/cache-manager.ts",
    "metadata": {
      "diagnostics": {},
      "filepath": "/home/user/project/lib/cache-manager.ts",
      "exists": false
    },
    "time": {
      "start": 1763963621040,
      "end": 1763963621041
    }
  }
}