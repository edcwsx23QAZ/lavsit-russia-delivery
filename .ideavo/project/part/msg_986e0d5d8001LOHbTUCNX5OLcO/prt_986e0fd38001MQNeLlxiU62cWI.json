{
  "id": "prt_986e0fd38001MQNeLlxiU62cWI",
  "messageID": "msg_986e0d5d8001LOHbTUCNX5OLcO",
  "sessionID": "ses_6852784ecffeuHwynj83p2lr14",
  "type": "tool",
  "tool": "write",
  "callID": "toolu_01Sw8Ug2SbZKjFe9K5juhfLg",
  "state": {
    "status": "completed",
    "input": {
      "filePath": "/home/user/project/app/pek-test/page.tsx",
      "content": "'use client';\n\nimport { useState } from 'react';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Textarea } from '@/components/ui/textarea';\n\nexport default function PekTestPage() {\n  const [results, setResults] = useState<{ [key: string]: any }>({});\n  const [loading, setLoading] = useState<{ [key: string]: boolean }>({});\n  const [testAddress, setTestAddress] = useState('г Москва, Шмитовский проезд, д 1, кв 39');\n\n  const runTest = async (testName: string, testFunction: () => Promise<any>) => {\n    setLoading(prev => ({ ...prev, [testName]: true }));\n    try {\n      const result = await testFunction();\n      setResults(prev => ({ ...prev, [testName]: result }));\n    } catch (error: any) {\n      setResults(prev => ({ \n        ...prev, \n        [testName]: { \n          error: true, \n          message: error.message,\n          stack: error.stack \n        } \n      }));\n    }\n    setLoading(prev => ({ ...prev, [testName]: false }));\n  };\n\n  // Тест 1: Проверка прокси API напрямую\n  const testProxyHealth = async () => {\n    const response = await fetch('/api/pek', {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({ method: 'test' })\n    });\n    \n    return {\n      status: response.status,\n      statusText: response.statusText,\n      ok: response.ok,\n      data: await response.json()\n    };\n  };\n\n  // Тест 2: Поиск зоны по адресу\n  const testFindZoneByAddress = async () => {\n    const response = await fetch('/api/pek', {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({\n        method: 'findzonebyaddress',\n        address: testAddress\n      })\n    });\n\n    return {\n      status: response.status,\n      statusText: response.statusText,\n      ok: response.ok,\n      data: await response.json()\n    };\n  };\n\n  // Тест 3: Прямой запрос к API ПЭК (для сравнения с сервера)\n  const testDirectPekApi = async () => {\n    const response = await fetch('https://api.pecom.ru/v1/branches/findzonebyaddress/', {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        'Authorization': 'Bearer 624FC93CA677B23673BB476D4982294DC27E246F'\n      },\n      body: JSON.stringify({\n        address: testAddress\n      })\n    });\n\n    return {\n      status: response.status,\n      statusText: response.statusText,\n      ok: response.ok,\n      corsBlocked: !response.ok && response.type === 'cors',\n      data: response.ok ? await response.json() : await response.text()\n    };\n  };\n\n  // Тест 4: Проверка всех вариантов токена\n  const testTokenVariants = async () => {\n    const tokens = [\n      { name: 'Bearer Token', value: 'Bearer 624FC93CA677B23673BB476D4982294DC27E246F' },\n      { name: 'Basic Auth', value: 'Basic ' + btoa('624FC93CA677B23673BB476D4982294DC27E246F:') },\n      { name: 'Plain Token', value: '624FC93CA677B23673BB476D4982294DC27E246F' }\n    ];\n\n    const results = [];\n    \n    for (const token of tokens) {\n      try {\n        const response = await fetch('https://api.pecom.ru/v1/branches/findzonebyaddress/', {\n          method: 'POST',\n          headers: {\n            'Content-Type': 'application/json',\n            'Authorization': token.value\n          },\n          body: JSON.stringify({ address: testAddress })\n        });\n\n        results.push({\n          tokenType: token.name,\n          status: response.status,\n          statusText: response.statusText,\n          ok: response.ok,\n          corsError: !response.ok && response.type === 'cors'\n        });\n      } catch (error: any) {\n        results.push({\n          tokenType: token.name,\n          error: error.message,\n          corsError: error.name === 'TypeError' && error.message.includes('fetch')\n        });\n      }\n    }\n\n    return results;\n  };\n\n  // Тест 5: Проверка альтернативных URL\n  const testApiUrls = async () => {\n    const urls = [\n      'https://api.pecom.ru/v1/branches/findzonebyaddress/',\n      'https://api.pecom.ru/v1/branches/findzonebyaddress',\n      'https://api.pecom.ru/branches/findzonebyaddress/',\n      'https://lk.pecom.ru/api/v1/branches/findzonebyaddress/',\n    ];\n\n    const results = [];\n    \n    for (const url of urls) {\n      try {\n        const response = await fetch(url, {\n          method: 'POST',\n          headers: {\n            'Content-Type': 'application/json',\n            'Authorization': 'Bearer 624FC93CA677B23673BB476D4982294DC27E246F'\n          },\n          body: JSON.stringify({ address: testAddress })\n        });\n\n        results.push({\n          url,\n          status: response.status,\n          statusText: response.statusText,\n          ok: response.ok,\n          accessible: true\n        });\n      } catch (error: any) {\n        results.push({\n          url,\n          error: error.message,\n          accessible: false,\n          corsError: error.name === 'TypeError'\n        });\n      }\n    }\n\n    return results;\n  };\n\n  const renderResult = (testName: string) => {\n    const result = results[testName];\n    const isLoading = loading[testName];\n\n    if (isLoading) {\n      return <div className=\"text-blue-600\">Загрузка...</div>;\n    }\n\n    if (!result) {\n      return <div className=\"text-gray-500\">Не запущен</div>;\n    }\n\n    return (\n      <pre className=\"text-xs bg-gray-50 p-2 rounded overflow-auto max-h-64\">\n        {JSON.stringify(result, null, 2)}\n      </pre>\n    );\n  };\n\n  return (\n    <div className=\"p-6 max-w-6xl mx-auto\">\n      <h1 className=\"text-2xl font-bold mb-6\">Диагностика API ПЭК</h1>\n      \n      <div className=\"mb-4\">\n        <label className=\"block text-sm font-medium mb-2\">Тестовый адрес:</label>\n        <Input \n          value={testAddress} \n          onChange={(e) => setTestAddress(e.target.value)}\n          className=\"max-w-md\"\n        />\n      </div>\n\n      <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-4\">\n        \n        <Card>\n          <CardHeader>\n            <CardTitle className=\"text-lg\">1. Проверка Прокси API</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <Button \n              onClick={() => runTest('proxy', testProxyHealth)}\n              disabled={loading.proxy}\n              className=\"mb-3\"\n            >\n              Проверить Прокси\n            </Button>\n            {renderResult('proxy')}\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"text-lg\">2. Поиск Зоны через Прокси</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <Button \n              onClick={() => runTest('zone', testFindZoneByAddress)}\n              disabled={loading.zone}\n              className=\"mb-3\"\n            >\n              Найти Зону\n            </Button>\n            {renderResult('zone')}\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"text-lg\">3. Прямой Запрос к ПЭК</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <Button \n              onClick={() => runTest('direct', testDirectPekApi)}\n              disabled={loading.direct}\n              className=\"mb-3\"\n            >\n              Прямой Запрос\n            </Button>\n            {renderResult('direct')}\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"text-lg\">4. Тест Токенов</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <Button \n              onClick={() => runTest('tokens', testTokenVariants)}\n              disabled={loading.tokens}\n              className=\"mb-3\"\n            >\n              Проверить Токены\n            </Button>\n            {renderResult('tokens')}\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"text-lg\">5. Тест URL Вариантов</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <Button \n              onClick={() => runTest('urls', testApiUrls)}\n              disabled={loading.urls}\n              className=\"mb-3\"\n            >\n              Проверить URLs\n            </Button>\n            {renderResult('urls')}\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"text-lg\">Запуск Всех Тестов</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <Button \n              onClick={async () => {\n                await runTest('proxy', testProxyHealth);\n                await runTest('zone', testFindZoneByAddress);\n                await runTest('direct', testDirectPekApi);\n                await runTest('tokens', testTokenVariants);\n                await runTest('urls', testApiUrls);\n              }}\n              disabled={Object.values(loading).some(Boolean)}\n              className=\"w-full\"\n            >\n              Запустить Все Тесты\n            </Button>\n          </CardContent>\n        </Card>\n      </div>\n\n      <div className=\"mt-6\">\n        <Card>\n          <CardHeader>\n            <CardTitle>Консоль Браузера</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <p className=\"text-sm text-gray-600\">\n              Откройте Developer Tools (F12) → Console для просмотра детальных логов запросов\n            </p>\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}"
    },
    "output": "",
    "metadata": {
      "diagnostics": {},
      "filepath": "/home/user/project/app/pek-test/page.tsx",
      "exists": false
    },
    "title": "app/pek-test/page.tsx",
    "time": {
      "start": 1758904547099,
      "end": 1758904547101
    }
  }
}