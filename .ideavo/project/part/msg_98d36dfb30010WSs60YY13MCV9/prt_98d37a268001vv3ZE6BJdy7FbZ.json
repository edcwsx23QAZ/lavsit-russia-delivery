{
  "id": "prt_98d37a268001vv3ZE6BJdy7FbZ",
  "messageID": "msg_98d36dfb30010WSs60YY13MCV9",
  "sessionID": "ses_6852784ecffeuHwynj83p2lr14",
  "type": "tool",
  "tool": "write",
  "callID": "toolu_01Hb4m5pUTecGttYKRSXQhUW",
  "state": {
    "status": "completed",
    "input": {
      "filePath": "/home/user/project/app/api/furniture-products/route.ts",
      "content": "import { NextRequest, NextResponse } from 'next/server';\n\n// üîß –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –¥–ª—è –¥–∞–Ω–Ω—ã—Ö –º–µ–±–µ–ª–∏\ninterface CargoPlace {\n  placeNumber: number;\n  weight: number; // –∫–≥\n  height: number; // —Å–º\n  depth: number;  // —Å–º (—à–∏—Ä–∏–Ω–∞)\n  length: number; // —Å–º\n}\n\ninterface FurnitureProduct {\n  id: string;\n  externalCode: string;\n  name: string;\n  retailPrice: number;\n  isActive: boolean;\n  cargoPlaces: CargoPlace[];\n}\n\n// –ö—ç—à –¥–ª—è –¥–∞–Ω–Ω—ã—Ö (–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç)\nlet cachedData: {\n  products: FurnitureProduct[];\n  lastUpdated: number;\n} | null = null;\n\nconst CACHE_DURATION = 30 * 60 * 1000; // 30 –º–∏–Ω—É—Ç\n\nexport async function GET(request: NextRequest) {\n  try {\n    const { searchParams } = new URL(request.url);\n    const query = searchParams.get('q')?.toLowerCase() || '';\n    \n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à\n    const now = Date.now();\n    if (!cachedData || (now - cachedData.lastUpdated) > CACHE_DURATION) {\n      console.log('üîÑ –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à –¥–∞–Ω–Ω—ã—Ö –º–µ–±–µ–ª–∏...');\n      cachedData = await fetchFurnitureData();\n    }\n    \n    // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –ø–æ–∏—Å–∫–æ–≤–æ–º—É –∑–∞–ø—Ä–æ—Å—É\n    let products = cachedData.products;\n    if (query) {\n      products = products.filter(product => \n        product.name.toLowerCase().includes(query) ||\n        product.externalCode.toLowerCase().includes(query)\n      );\n    }\n    \n    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–ª—è –∞–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç–∞\n    const limit = parseInt(searchParams.get('limit') || '20');\n    products = products.slice(0, limit);\n    \n    return NextResponse.json({\n      success: true,\n      data: products,\n      total: products.length,\n      cached: true,\n      lastUpdated: new Date(cachedData.lastUpdated).toISOString()\n    });\n    \n  } catch (error: any) {\n    console.error('‚ùå –û—à–∏–±–∫–∞ API furniture-products:', error);\n    return NextResponse.json({\n      success: false,\n      error: error.message,\n      data: []\n    }, { status: 500 });\n  }\n}\n\n// üîß –§—É–Ω–∫—Ü–∏—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ Google Sheets\nasync function fetchFurnitureData(): Promise<{products: FurnitureProduct[], lastUpdated: number}> {\n  try {\n    // Google Sheets ID –∏–∑ URL\n    const SHEET_ID = '1e0P91PfGKVIuSWDY0ceWkIE7jD-vzD_xrIesBeQno1Y';\n    \n    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—É–±–ª–∏—á–Ω—ã–π CSV —ç–∫—Å–ø–æ—Ä—Ç Google Sheets\n    const csvUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=0`;\n    \n    console.log('üìä –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ Google Sheets:', csvUrl);\n    \n    const response = await fetch(csvUrl);\n    if (!response.ok) {\n      throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${response.status}`);\n    }\n    \n    const csvText = await response.text();\n    console.log('üìÑ –ü–æ–ª—É—á–µ–Ω—ã CSV –¥–∞–Ω–Ω—ã–µ, —Ä–∞–∑–º–µ—Ä:', csvText.length);\n    \n    // –ü–∞—Ä—Å–∏–º CSV\n    const rows = parseCSV(csvText);\n    console.log('üìã –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫:', rows.length);\n    \n    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–æ–¥—É–∫—Ç–æ–≤\n    const products = await parseProductsFromRows(rows);\n    console.log('üõãÔ∏è –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤:', products.length);\n    \n    return {\n      products,\n      lastUpdated: Date.now()\n    };\n    \n  } catch (error) {\n    console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –º–µ–±–µ–ª–∏:', error);\n    throw error;\n  }\n}\n\n// üîß –ü—Ä–æ—Å—Ç–æ–π CSV –ø–∞—Ä—Å–µ—Ä\nfunction parseCSV(csvText: string): string[][] {\n  const lines = csvText.split('\\n');\n  const result: string[][] = [];\n  \n  for (const line of lines) {\n    if (line.trim()) {\n      // –ü—Ä–æ—Å—Ç–æ–π split –ø–æ –∑–∞–ø—è—Ç—ã–º (–º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è —É–ª—É—á—à–µ–Ω–∏–µ –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤)\n      const cells = line.split(',').map(cell => cell.trim().replace(/^\"(.*)\"$/, '$1'));\n      result.push(cells);\n    }\n  }\n  \n  return result;\n}\n\n// üîß –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–æ–∫ –≤ –ø—Ä–æ–¥—É–∫—Ç—ã\nasync function parseProductsFromRows(rows: string[][]): Promise<FurnitureProduct[]> {\n  const products: FurnitureProduct[] = [];\n  \n  if (rows.length < 2) {\n    console.warn('‚ö†Ô∏è –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –≤ —Ç–∞–±–ª–∏—Ü–µ');\n    return products;\n  }\n  \n  // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ (–ø–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞)\n  for (let i = 1; i < rows.length; i++) {\n    const row = rows[i];\n    \n    if (row.length < 6) {\n      console.warn(`‚ö†Ô∏è –°—Ç—Ä–æ–∫–∞ ${i + 1} —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö:`, row);\n      continue;\n    }\n    \n    try {\n      // –ú–∞–ø–ø–∏–Ω–≥ –∫–æ–ª–æ–Ω–æ–∫ (—Å–æ–≥–ª–∞—Å–Ω–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ —Ç–∞–±–ª–∏—Ü—ã)\n      const id = row[0] || '';\n      const externalCode = row[1] || '';\n      const isActive = row[2]?.toLowerCase() === '–¥–∞';\n      const name = row[3] || '';\n      const priceStr = row[4] || '0';\n      \n      // –û—á–∏—â–∞–µ–º —Ü–µ–Ω—É –æ—Ç –ª–∏—à–Ω–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤\n      const retailPrice = parseFloat(priceStr.replace(/[^0-9.]/g, '')) || 0;\n      \n      // –ò–∑–≤–ª–µ–∫–∞–µ–º –≥—Ä—É–∑–æ–≤—ã–µ –º–µ—Å—Ç–∞ (–Ω–∞—á–∏–Ω–∞—è —Å –∫–æ–ª–æ–Ω–∫–∏ 5)\n      const cargoPlaces: CargoPlace[] = [];\n      \n      // –í —Ç–∞–±–ª–∏—Ü–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –¥–æ 7 –º–µ—Å—Ç (–ú–µ—Å—Ç–æ 1-7)\n      for (let placeNum = 1; placeNum <= 7; placeNum++) {\n        const baseIndex = 4 + (placeNum - 1) * 4; // 5, 9, 13, 17, 21, 25, 29\n        \n        if (baseIndex + 3 < row.length) {\n          const weight = parseFloat(row[baseIndex + 1]) || 0;  // –í–µ—Å\n          const height = parseFloat(row[baseIndex + 2]) || 0;  // –í—ã—Å–æ—Ç–∞\n          const depth = parseFloat(row[baseIndex + 3]) || 0;   // –ì–ª—É–±–∏–Ω–∞ (—à–∏—Ä–∏–Ω–∞)\n          const length = parseFloat(row[baseIndex + 4]) || 0;  // –î–ª–∏–Ω–∞\n          \n          // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ\n          if (weight > 0 || height > 0 || depth > 0 || length > 0) {\n            cargoPlaces.push({\n              placeNumber: placeNum,\n              weight,\n              height,\n              depth,  // –≤ —Ç–∞–±–ª–∏—Ü–µ —ç—Ç–æ \"–≥–ª—É–±–∏–Ω–∞\", –Ω–æ –º—ã –Ω–∞–∑—ã–≤–∞–µ–º depth\n              length\n            });\n          }\n        }\n      }\n      \n      // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–¥—É–∫—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –∏–º—è –∏ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –≥—Ä—É–∑–æ–≤–æ–µ –º–µ—Å—Ç–æ\n      if (name && cargoPlaces.length > 0) {\n        products.push({\n          id,\n          externalCode,\n          name: name.trim(),\n          retailPrice,\n          isActive,\n          cargoPlaces\n        });\n      }\n      \n    } catch (error) {\n      console.warn(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å—Ç—Ä–æ–∫–∏ ${i + 1}:`, error, row);\n    }\n  }\n  \n  // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –∏–º–µ–Ω–∏\n  products.sort((a, b) => a.name.localeCompare(b.name, 'ru'));\n  \n  console.log(`‚úÖ –£—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ ${products.length} —Ç–æ–≤–∞—Ä–æ–≤`);\n  return products;\n}"
    },
    "output": "",
    "metadata": {
      "diagnostics": {},
      "filepath": "/home/user/project/app/api/furniture-products/route.ts",
      "exists": false
    },
    "title": "app/api/furniture-products/route.ts",
    "time": {
      "start": 1759010886913,
      "end": 1759010886914
    }
  }
}