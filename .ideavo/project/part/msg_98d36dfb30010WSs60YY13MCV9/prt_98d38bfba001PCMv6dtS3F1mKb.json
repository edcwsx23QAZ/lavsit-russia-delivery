{
  "id": "prt_98d38bfba001PCMv6dtS3F1mKb",
  "messageID": "msg_98d36dfb30010WSs60YY13MCV9",
  "sessionID": "ses_6852784ecffeuHwynj83p2lr14",
  "type": "tool",
  "tool": "write",
  "callID": "toolu_01Hu3u824qSefpD7YrteXbxQ",
  "state": {
    "status": "completed",
    "input": {
      "filePath": "/home/user/project/components/ProductSearch.tsx",
      "content": "'use client';\n\nimport React, { useState, useEffect, useRef, useCallback } from 'react';\nimport { Input } from '@/components/ui/input';\nimport { Button } from '@/components/ui/button';\nimport { Badge } from '@/components/ui/badge';\nimport { Card, CardContent } from '@/components/ui/card';\nimport { Plus, Search, Package, Loader2 } from 'lucide-react';\nimport { FurnitureProduct, ProductSearchState } from '@/lib/furniture-types';\nimport { searchProducts, formatPrice, getProductSummary } from '@/lib/furniture-utils';\n\ninterface ProductSearchProps {\n  onProductAdd: (product: FurnitureProduct) => void;\n  disabled?: boolean;\n}\n\nexport default function ProductSearch({ onProductAdd, disabled = false }: ProductSearchProps) {\n  const [searchState, setSearchState] = useState<ProductSearchState>({\n    query: '',\n    isLoading: false,\n    suggestions: [],\n    showSuggestions: false,\n    selectedIndex: -1\n  });\n  \n  const [allProducts, setAllProducts] = useState<FurnitureProduct[]>([]);\n  const [isLoadingProducts, setIsLoadingProducts] = useState(false);\n  const inputRef = useRef<HTMLInputElement>(null);\n  const suggestionsRef = useRef<HTMLDivElement>(null);\n  \n  // Загрузка продуктов при монтировании\n  useEffect(() => {\n    loadProducts();\n  }, []);\n  \n  // Загрузка продуктов с сервера\n  const loadProducts = async () => {\n    setIsLoadingProducts(true);\n    try {\n      const response = await fetch('/api/furniture-products');\n      const data = await response.json();\n      \n      if (data.success) {\n        setAllProducts(data.data);\n        console.log(`✅ Загружено ${data.data.length} товаров`);\n      } else {\n        console.error('❌ Ошибка загрузки товаров:', data.error);\n      }\n    } catch (error) {\n      console.error('❌ Ошибка загрузки товаров:', error);\n    } finally {\n      setIsLoadingProducts(false);\n    }\n  };\n  \n  // Обработка поискового запроса\n  const handleQueryChange = useCallback((query: string) => {\n    setSearchState(prev => ({\n      ...prev,\n      query,\n      selectedIndex: -1\n    }));\n    \n    if (query.trim().length >= 2) {\n      const filtered = searchProducts(allProducts, query);\n      setSearchState(prev => ({\n        ...prev,\n        suggestions: filtered,\n        showSuggestions: true\n      }));\n    } else {\n      setSearchState(prev => ({\n        ...prev,\n        suggestions: [],\n        showSuggestions: false\n      }));\n    }\n  }, [allProducts]);\n  \n  // Обработка выбора товара\n  const handleProductSelect = (product: FurnitureProduct) => {\n    onProductAdd(product);\n    setSearchState(prev => ({\n      ...prev,\n      query: '',\n      suggestions: [],\n      showSuggestions: false,\n      selectedIndex: -1\n    }));\n    inputRef.current?.focus();\n  };\n  \n  // Обработка клавиш\n  const handleKeyDown = (e: React.KeyboardEvent) => {\n    if (!searchState.showSuggestions || searchState.suggestions.length === 0) return;\n    \n    switch (e.key) {\n      case 'ArrowDown':\n        e.preventDefault();\n        setSearchState(prev => ({\n          ...prev,\n          selectedIndex: Math.min(prev.selectedIndex + 1, prev.suggestions.length - 1)\n        }));\n        break;\n        \n      case 'ArrowUp':\n        e.preventDefault();\n        setSearchState(prev => ({\n          ...prev,\n          selectedIndex: Math.max(prev.selectedIndex - 1, -1)\n        }));\n        break;\n        \n      case 'Enter':\n        e.preventDefault();\n        if (searchState.selectedIndex >= 0) {\n          handleProductSelect(searchState.suggestions[searchState.selectedIndex]);\n        }\n        break;\n        \n      case 'Escape':\n        setSearchState(prev => ({\n          ...prev,\n          showSuggestions: false,\n          selectedIndex: -1\n        }));\n        break;\n    }\n  };\n  \n  // Закрытие списка при клике вне\n  useEffect(() => {\n    const handleClickOutside = (event: MouseEvent) => {\n      if (suggestionsRef.current && !suggestionsRef.current.contains(event.target as Node) &&\n          inputRef.current && !inputRef.current.contains(event.target as Node)) {\n        setSearchState(prev => ({ ...prev, showSuggestions: false }));\n      }\n    };\n    \n    document.addEventListener('mousedown', handleClickOutside);\n    return () => document.removeEventListener('mousedown', handleClickOutside);\n  }, []);\n  \n  return (\n    <div className=\"relative w-full\">\n      {/* Поле поиска */}\n      <div className=\"flex gap-2\">\n        <div className=\"relative flex-1\">\n          <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400\" />\n          <Input\n            ref={inputRef}\n            type=\"text\"\n            value={searchState.query}\n            onChange={(e) => handleQueryChange(e.target.value)}\n            onKeyDown={handleKeyDown}\n            onFocus={() => {\n              if (searchState.suggestions.length > 0) {\n                setSearchState(prev => ({ ...prev, showSuggestions: true }));\n              }\n            }}\n            placeholder=\"Поиск мебели по названию...\"\n            className=\"bg-gray-700 border-gray-600 text-white pl-10 h-10\"\n            disabled={disabled || isLoadingProducts}\n          />\n          {isLoadingProducts && (\n            <Loader2 className=\"absolute right-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400 animate-spin\" />\n          )}\n        </div>\n        \n        <Button\n          type=\"button\"\n          onClick={() => {\n            if (searchState.selectedIndex >= 0) {\n              handleProductSelect(searchState.suggestions[searchState.selectedIndex]);\n            } else if (searchState.suggestions.length === 1) {\n              handleProductSelect(searchState.suggestions[0]);\n            }\n          }}\n          disabled={disabled || searchState.suggestions.length === 0}\n          className=\"bg-blue-600 hover:bg-blue-700 h-10 px-4\"\n        >\n          <Plus className=\"h-4 w-4 mr-2\" />\n          Добавить товар\n        </Button>\n      </div>\n      \n      {/* Список подсказок */}\n      {searchState.showSuggestions && searchState.suggestions.length > 0 && (\n        <Card \n          ref={suggestionsRef}\n          className=\"absolute top-full left-0 right-0 z-50 mt-1 bg-gray-800 border-gray-600 max-h-80 overflow-y-auto\"\n        >\n          <CardContent className=\"p-0\">\n            {searchState.suggestions.map((product, index) => (\n              <div\n                key={`${product.id}_${product.externalCode}`}\n                onClick={() => handleProductSelect(product)}\n                className={`p-3 cursor-pointer border-b border-gray-700 last:border-b-0 transition-colors ${\n                  index === searchState.selectedIndex \n                    ? 'bg-blue-600/20 border-blue-500' \n                    : 'hover:bg-gray-700'\n                }`}\n              >\n                <div className=\"flex items-start justify-between\">\n                  <div className=\"flex-1 min-w-0\">\n                    <h4 className=\"text-white font-medium text-sm truncate\">\n                      {product.name}\n                    </h4>\n                    <div className=\"flex items-center gap-2 mt-1\">\n                      <Badge variant=\"outline\" className=\"text-xs border-gray-600\">\n                        {product.externalCode}\n                      </Badge>\n                      <div className=\"flex items-center text-gray-400 text-xs\">\n                        <Package className=\"h-3 w-3 mr-1\" />\n                        {getProductSummary(product)}\n                      </div>\n                    </div>\n                  </div>\n                  <div className=\"text-right ml-3\">\n                    <div className=\"text-green-400 font-medium text-sm\">\n                      {formatPrice(product.retailPrice)}\n                    </div>\n                    {!product.isActive && (\n                      <Badge variant=\"destructive\" className=\"text-xs mt-1\">\n                        Неактивен\n                      </Badge>\n                    )}\n                  </div>\n                </div>\n              </div>\n            ))}\n          </CardContent>\n        </Card>\n      )}\n      \n      {/* Состояние загрузки */}\n      {isLoadingProducts && (\n        <div className=\"text-gray-400 text-sm mt-2 flex items-center\">\n          <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n          Загрузка каталога мебели...\n        </div>\n      )}\n      \n      {/* Пустой результат поиска */}\n      {searchState.query.length >= 2 && searchState.suggestions.length === 0 && !isLoadingProducts && (\n        <div className=\"text-gray-400 text-sm mt-2\">\n          Товары не найдены. Попробуйте изменить запрос.\n        </div>\n      )}\n      \n      {/* Подсказка */}\n      {!searchState.query && allProducts.length > 0 && (\n        <div className=\"text-gray-400 text-xs mt-2\">\n          Доступно {allProducts.length} товаров. Начните вводить название для поиска.\n        </div>\n      )}\n    </div>\n  );\n}"
    },
    "output": "",
    "metadata": {
      "diagnostics": {},
      "filepath": "/home/user/project/components/ProductSearch.tsx",
      "exists": false
    },
    "title": "components/ProductSearch.tsx",
    "time": {
      "start": 1759010959328,
      "end": 1759010959329
    }
  }
}