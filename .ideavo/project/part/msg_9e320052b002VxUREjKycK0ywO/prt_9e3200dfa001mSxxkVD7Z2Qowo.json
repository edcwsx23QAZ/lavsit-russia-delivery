{
  "id": "prt_9e3200dfa001mSxxkVD7Z2Qowo",
  "messageID": "msg_9e320052b002VxUREjKycK0ywO",
  "sessionID": "ses_6852784ecffeuHwynj83p2lr14",
  "type": "tool",
  "tool": "read",
  "callID": "call_04858385",
  "state": {
    "status": "completed",
    "input": {
      "filePath": "app/page.tsx",
      "offset": 800
    },
    "output": "<file>\n00801|   // üîß –§—É–Ω–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏ –ø—É—Å—Ç—ã—Ö –≥—Ä—É–∑–æ–≤\n00802|   const cleanEmptyCargos = (cargos: Cargo[], selectedProducts: ProductInForm[]) => {\n00803|     // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–π –≥—Ä—É–∑\n00804|     const hasFilledCargos = cargos.some(cargo => !isEmptyCargo(cargo));\n00805|     \n00806|     if (!hasFilledCargos) {\n00807|       // –ï—Å–ª–∏ –Ω–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –≥—Ä—É–∑–æ–≤, –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–π –ø—É—Å—Ç–æ–π\n00808|       return {\n00809|         cargos: cargos.length > 0 ? [{ id: '1', length: 0, width: 0, height: 0, weight: 0 }] : [{ id: '1', length: 0, width: 0, height: 0, weight: 0 }],\n00810|         products: selectedProducts\n00811|       };\n00812|     }\n00813| \n00814|     // –°–æ–∑–¥–∞–µ–º –º–∞–ø–ø–∏–Ω–≥ —Å—Ç–∞—Ä—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤ –∫ –Ω–æ–≤—ã–º\n00815|     const oldToNewIndexMap = new globalThis.Map<number, number>();\n00816|     let newIndex = 0;\n00817|     \n00818|     cargos.forEach((cargo, oldIndex) => {\n00819|       if (!isEmptyCargo(cargo)) {\n00820|         oldToNewIndexMap.set(oldIndex, newIndex);\n00821|         newIndex++;\n00822|       }\n00823|     });\n00824|     \n00825|     // –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –≥—Ä—É–∑—ã\n00826|     const filledCargos = cargos.filter(cargo => !isEmptyCargo(cargo));\n00827|     \n00828|     // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–µ–∫—Å—ã —É —Ç–æ–≤–∞—Ä–æ–≤\n00829|     const updatedProducts = selectedProducts.map(productItem => ({\n00830|       ...productItem,\n00831|       cargoIndexes: productItem.cargoIndexes\n00832|         .map(oldIndex => oldToNewIndexMap.get(oldIndex))\n00833|         .filter(newIdx => newIdx !== undefined) as number[]\n00834|     }));\n00835|     \n00836|     return {\n00837|       cargos: filledCargos,\n00838|       products: updatedProducts\n00839|     };\n00840|   };\n00841| \n00842|   // üîß –§—É–Ω–∫—Ü–∏—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –≥—Ä—É–∑–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è\n00843|   interface GroupedCargoDisplay {\n00844|     length: number;\n00845|     width: number;\n00846|     height: number;\n00847|     weight: number;\n00848|     quantity: number;\n00849|     indices: number[];\n00850|     isEmpty: boolean;\n00851|   }\n00852| \n00853|   const groupCargosForDisplay = (cargos: Cargo[]): GroupedCargoDisplay[] => {\n00854|     const groups = new globalThis.Map<string, GroupedCargoDisplay>();\n00855|     \n00856|     cargos.forEach((cargo, index) => {\n00857|       const isEmpty = isEmptyCargo(cargo);\n00858|       \n00859|       // –î–ª—è –ø—É—Å—Ç—ã—Ö –≥—Ä—É–∑–æ–≤ –Ω–µ –≥—Ä—É–ø–ø–∏—Ä—É–µ–º\n00860|       if (isEmpty) {\n00861|         groups.set(`empty_${index}`, {\n00862|           length: 0,\n00863|           width: 0,\n00864|           height: 0,\n00865|           weight: 0,\n00866|           quantity: 1,\n00867|           indices: [index],\n00868|           isEmpty: true\n00869|         });\n00870|         return;\n00871|       }\n00872|       \n00873|       // –°–æ–∑–¥–∞–µ–º –∫–ª—é—á –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≥–∞–±–∞—Ä–∏—Ç–æ–≤ –∏ –≤–µ—Å–∞\n00874|       const key = `${cargo.length}_${cargo.width}_${cargo.height}_${cargo.weight}`;\n00875|       \n00876|       if (groups.has(key)) {\n00877|         const existing = groups.get(key)!;\n00878|         existing.quantity += 1;\n00879|         existing.indices.push(index);\n00880|       } else {\n00881|         groups.set(key, {\n00882|           length: cargo.length,\n00883|           width: cargo.width,\n00884|           height: cargo.height,\n00885|           weight: cargo.weight,\n00886|           quantity: 1,\n00887|           indices: [index],\n00888|           isEmpty: false\n00889|         });\n00890|       }\n00891|     });\n00892|     \n00893|     // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –º–∞—Å—Å–∏–≤: —Å–Ω–∞—á–∞–ª–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ (–ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —É–±—ã–≤–∞–Ω–∏—è), –ø–æ—Ç–æ–º –ø—É—Å—Ç—ã–µ\n00894|     return Array.from(groups.values()).sort((a, b) => {\n00895|       if (a.isEmpty && !b.isEmpty) return 1;\n00896|       if (!a.isEmpty && b.isEmpty) return -1;\n00897|       if (!a.isEmpty && !b.isEmpty) {\n00898|         return b.quantity - a.quantity; // –ü–æ —É–±—ã–≤–∞–Ω–∏—é –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞\n00899|       }\n00900|       return a.indices[0] - b.indices[0]; // –ü—É—Å—Ç—ã–µ –ø–æ –ø–æ—Ä—è–¥–∫—É –∏–Ω–¥–µ–∫—Å–æ–≤\n00901|     });\n00902|   };\n00903| \n00904|   // üîß –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞–º–∏\n00905|   const handleProductAdd = (product: FurnitureProduct) => {\n00906|     const timestamp = Date.now();\n00907|     \n00908|     console.log(`‚ûï –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞: ${product.name} (${product.cargoPlaces.length} –≥—Ä—É–∑–æ–≤—ã—Ö –º–µ—Å—Ç)`);\n00909|     \n00910|     // –°–æ–∑–¥–∞–µ–º –≥—Ä—É–∑–æ–≤—ã–µ –º–µ—Å—Ç–∞ –¥–ª—è —Ç–æ–≤–∞—Ä–∞\n00911|     const newCargos = createCargosForProduct(product, 1, timestamp);\n00912|     \n00913|     console.log('–°–æ–∑–¥–∞–Ω–æ –Ω–æ–≤—ã—Ö –≥—Ä—É–∑–æ–≤:', newCargos.length);\n00914|     console.log('–ù–æ–≤—ã–µ –≥—Ä—É–∑—ã:', newCargos.map(c => ({ id: c.id, productId: c.productId, addedAt: c.addedAt })));\n00915|     \n00916|     // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç —Ç–æ–≤–∞—Ä–∞ –≤ —Ñ–æ—Ä–º–µ\n00917|     const productInForm: ProductInForm = {\n00918|       product,\n00919|       quantity: 1,\n00920|       totalPrice: product.retailPrice,\n00921|       cargoIndexes: [], // –ó–∞–ø–æ–ª–Ω–∏–º –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≥—Ä—É–∑–æ–≤\n00922|       addedAt: timestamp\n00923|     };\n00924|     \n00925|     setForm(prev => {\n00926|       let updatedCargos = [...prev.cargos];\n00927|       let cargoIndexes: number[] = [];\n00928|       \n00929|       // –ù–∞—Ö–æ–¥–∏–º –ø—É—Å—Ç—ã–µ –≥—Ä—É–∑—ã –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è\n00930|       const emptyCargos = updatedCargos\n00931|         .map((cargo, index) => ({ cargo, index }))\n00932|         .filter(item => isEmptyCargo(item.cargo));\n00933|       \n00934|       console.log('–ù–∞–π–¥–µ–Ω–æ –ø—É—Å—Ç—ã—Ö –≥—Ä—É–∑–æ–≤:', emptyCargos.length);\n00935|       console.log('–ù—É–∂–Ω–æ –∑–∞–ø–æ–ª–Ω–∏—Ç—å –≥—Ä—É–∑–æ–≤:', newCargos.length);\n00936|       \n00937|       // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø—É—Å—Ç—ã–µ –≥—Ä—É–∑—ã –¥–∞–Ω–Ω—ã–º–∏ —Ç–æ–≤–∞—Ä–∞\n00938|       let filledCount = 0;\n00939|       for (let i = 0; i < Math.min(emptyCargos.length, newCargos.length); i++) {\n00940|         const emptyCargoIndex = emptyCargos[i].index;\n00941|         const newCargoData = newCargos[i];\n00942|         \n00943|         updatedCargos[emptyCargoIndex] = {\n00944|           ...updatedCargos[emptyCargoIndex],\n00945|           length: newCargoData.length,\n00946|           width: newCargoData.width,\n00947|           height: newCargoData.height,\n00948|           weight: newCargoData.weight,\n00949|           productId: newCargoData.productId,\n00950|           placeNumber: newCargoData.placeNumber,\n00951|           isFromProduct: newCargoData.isFromProduct,\n00952|           addedAt: newCargoData.addedAt\n00953|         };\n00954|         \n00955|         cargoIndexes.push(emptyCargoIndex);\n00956|         filledCount++;\n00957|       }\n00958|       \n00959|       // –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –±–æ–ª—å—à–µ –≥—Ä—É–∑–æ–≤, —á–µ–º –µ—Å—Ç—å –ø—É—Å—Ç—ã—Ö - –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ\n00960|       if (filledCount < newCargos.length) {\n00961|         const remainingCargos = newCargos.slice(filledCount);\n00962|         const startIndex = updatedCargos.length;\n00963|         \n00964|         for (let i = 0; i < remainingCargos.length; i++) {\n00965|           updatedCargos.push(remainingCargos[i]);\n00966|           cargoIndexes.push(startIndex + i);\n00967|         }\n00968|       }\n00969|       \n00970|       productInForm.cargoIndexes = cargoIndexes;\n00971|       \n00972|       console.log('–ò–Ω–¥–µ–∫—Å—ã –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –≥—Ä—É–∑–æ–≤:', cargoIndexes);\n00973|       console.log('–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥—Ä—É–∑–æ–≤ –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è:', updatedCargos.length);\n00974|       \n00975|       // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±—ä—è–≤–ª–µ–Ω–Ω—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å\n00976|       const prevSelectedProducts = prev.selectedProducts || [];\n00977|       const newSelectedProducts = [...prevSelectedProducts, productInForm];\n00978|       const newDeclaredValue = calculateTotalValue(newSelectedProducts);\n00979|       \n00980|       // –û—á–∏—â–∞–µ–º –ø—É—Å—Ç—ã–µ –≥—Ä—É–∑—ã —Å–æ–≥–ª–∞—Å–Ω–æ –Ω–æ–≤–æ–π –ª–æ–≥–∏–∫–µ\n00981|       const cleanResult = cleanEmptyCargos(updatedCargos, newSelectedProducts);\n00982|       \n00983|       return {\n00984|         ...prev,\n00985|         cargos: cleanResult.cargos,\n00986|         selectedProducts: cleanResult.products,\n00987|         declaredValue: newDeclaredValue\n00988|       };\n00989|     });\n00990|     \n00991|     console.log(`‚úÖ –î–æ–±–∞–≤–ª–µ–Ω —Ç–æ–≤–∞—Ä: ${product.name} (${newCargos.length} –≥—Ä—É–∑–æ–≤—ã—Ö –º–µ—Å—Ç)`);\n00992|     console.log('–§–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≥—Ä—É–∑–æ–≤:', newCargos.length);\n00993|   };\n00994| \n00995|   const handleProductQuantityChange = (productId: string, addedAt: number, newQuantity: number) => {\n00996|     setForm(prev => {\n00997|       console.log(`üî¢ –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–æ–≤–∞—Ä–∞ ${productId} —Å ${prev.selectedProducts?.find(p => p.product.id === productId && p.addedAt === addedAt)?.quantity || 0} –Ω–∞ ${newQuantity}`);\n00998|       \n00999|       // –ù–∞—Ö–æ–¥–∏–º —Ç–æ–≤–∞—Ä\n01000|       const selectedProducts = prev.selectedProducts || [];\n01001|       const productIndex = selectedProducts.findIndex(p => \n01002|         p.product.id === productId && p.addedAt === addedAt\n01003|       );\n01004|       \n01005|       if (productIndex === -1) {\n01006|         console.warn('‚ùå –¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞');\n01007|         return prev;\n01008|       }\n01009|       \n01010|       const product = selectedProducts[productIndex];\n01011|       console.log('–ì—Ä—É–∑—ã –¥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞:', prev.cargos.length);\n01012|       \n01013|       // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –≥—Ä—É–∑—ã —ç—Ç–æ–≥–æ —Ç–æ–≤–∞—Ä–∞\n01014|       const cargosWithoutProduct = removeCargosForProduct(\n01015|         prev.cargos as CargoWithMetadata[], \n01016|         productId, \n01017|         addedAt\n01018|       );\n01019|       \n01020|       console.log('–ì—Ä—É–∑—ã –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç–∞—Ä—ã—Ö:', cargosWithoutProduct.length);\n01021|       \n01022|       // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–µ –≥—Ä—É–∑—ã —Å –Ω–æ–≤—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º\n01023|       const newCargos = createCargosForProduct(product.product, newQuantity, addedAt);\n01024|       const updatedCargos = [...cargosWithoutProduct, ...newCargos];\n01025|       \n01026|       console.log('–ì—Ä—É–∑—ã –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö:', updatedCargos.length);\n01027|       \n01028|       // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–≤–∞—Ä\n01029|       const updatedProduct = {\n01030|         ...product,\n01031|         quantity: newQuantity,\n01032|         totalPrice: product.product.retailPrice * newQuantity,\n01033|         cargoIndexes: findCargoIndexesForProduct(updatedCargos, productId, addedAt)\n01034|       };\n01035|       \n01036|       const updatedProducts = selectedProducts.map((p, index) => \n01037|         index === productIndex ? updatedProduct : p\n01038|       );\n01039|       \n01040|       // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±—ä—è–≤–ª–µ–Ω–Ω—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å\n01041|       const newDeclaredValue = calculateTotalValue(updatedProducts);\n01042|       \n01043|       // –û—á–∏—â–∞–µ–º –ø—É—Å—Ç—ã–µ –≥—Ä—É–∑—ã —Å–æ–≥–ª–∞—Å–Ω–æ –Ω–æ–≤–æ–π –ª–æ–≥–∏–∫–µ\n01044|       const cleanResult = cleanEmptyCargos(updatedCargos, updatedProducts);\n01045|       \n01046|       return {\n01047|         ...prev,\n01048|         cargos: cleanResult.cargos,\n01049|         selectedProducts: cleanResult.products,\n01050|         declaredValue: newDeclaredValue\n01051|       };\n01052|     });\n01053|     \n01054|     console.log(`üîÑ –ò–∑–º–µ–Ω–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–∞ ${productId}: ${newQuantity} —à—Ç.`);\n01055|   };\n01056| \n01057|   const handleProductRemove = (productId: string, addedAt: number) => {\n01058|     setForm(prev => {\n01059|       console.log(`üóëÔ∏è –£–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ ${productId} (addedAt: ${addedAt})`);\n01060|       \n01061|       // –ù–∞—Ö–æ–¥–∏–º —Ç–æ–≤–∞—Ä –∏ –µ–≥–æ –∏–Ω–¥–µ–∫—Å—ã –≥—Ä—É–∑–æ–≤\n01062|       const selectedProducts = prev.selectedProducts || [];\n01063|       const product = selectedProducts.find(p => \n01064|         p.product.id === productId && p.addedAt === addedAt\n01065|       );\n01066|       \n01067|       if (!product) {\n01068|         console.log('–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω');\n01069|         return prev;\n01070|       }\n01071|       \n01072|       // –û—á–∏—â–∞–µ–º –≥—Ä—É–∑—ã —Ç–æ–≤–∞—Ä–∞ (–¥–µ–ª–∞–µ–º –∏—Ö –ø—É—Å—Ç—ã–º–∏ –≤–º–µ—Å—Ç–æ —É–¥–∞–ª–µ–Ω–∏—è)\n01073|       const updatedCargos = prev.cargos.map((cargo, index) => {\n01074|         if (product.cargoIndexes.includes(index)) {\n01075|           return {\n01076|             ...cargo,\n01077|             length: 0,\n01078|             width: 0,\n01079|             height: 0,\n01080|             weight: 0,\n01081|             productId: undefined,\n01082|             placeNumber: undefined,\n01083|             isFromProduct: undefined,\n01084|             addedAt: undefined\n01085|           };\n01086|         }\n01087|         return cargo;\n01088|       });\n01089|       \n01090|       // –£–¥–∞–ª—è–µ–º —Ç–æ–≤–∞—Ä –∏–∑ —Å–ø–∏—Å–∫–∞\n01091|       const updatedProducts = selectedProducts.filter(p => \n01092|         !(p.product.id === productId && p.addedAt === addedAt)\n01093|       );\n01094|       \n01095|       // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±—ä—è–≤–ª–µ–Ω–Ω—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å\n01096|       const newDeclaredValue = calculateTotalValue(updatedProducts);\n01097|       \n01098|       // –û—á–∏—â–∞–µ–º –ø—É—Å—Ç—ã–µ –≥—Ä—É–∑—ã —Å–æ–≥–ª–∞—Å–Ω–æ –Ω–æ–≤–æ–π –ª–æ–≥–∏–∫–µ\n01099|       const cleanResult = cleanEmptyCargos(updatedCargos, updatedProducts);\n01100|       \n01101|       console.log('–ì—Ä—É–∑—ã –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏:', cleanResult.cargos.length);\n01102|       console.log('–£–¥–∞–ª–µ–Ω–æ –ø—É—Å—Ç—ã—Ö –≥—Ä—É–∑–æ–≤:', updatedCargos.length - cleanResult.cargos.length);\n01103|       \n01104|       return {\n01105|         ...prev,\n01106|         cargos: cleanResult.cargos,\n01107|         selectedProducts: cleanResult.products,\n01108|         declaredValue: newDeclaredValue\n01109|       };\n01110|     });\n01111|     \n01112|     console.log(`üóëÔ∏è –£–¥–∞–ª–µ–Ω —Ç–æ–≤–∞—Ä ${productId}`);\n01113|   };\n01114| \n01115|   // –ü–æ–ª—É—á–µ–Ω–∏–µ sessionID –¥–ª—è –î–µ–ª–æ–≤—ã—Ö –õ–∏–Ω–∏–π\n01116|   const getDellinSessionId = async (): Promise<string | null> => {\n01117|     try {\n01118|       const authResponse = await fetch('https://api.dellin.ru/v3/auth/login.json', {\n01119|         method: 'POST',\n01120|         headers: {\n01121|           'Content-Type': 'application/json'\n01122|         },\n01123|         body: JSON.stringify({\n01124|           appkey: 'E6C50E91-8E93-440F-9CC6-DEF9F0D68F1B',\n01125|           login: 'service@lavsit.ru',\n01126|           password: 'edcwsx123QAZ'\n01127|         })\n01128|       });\n01129| \n01130|       const authData = await authResponse.json();\n01131|       console.log('üîë –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø –î–õ response.ok:', authResponse.ok);\n01132|       console.log('üîë –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø –î–õ authData:', authData);\n01133|       console.log('üîë –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø –î–õ authData.data:', authData.data);\n01134|       console.log('üîë –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø –î–õ authData.data?.sessionID:', authData.data?.sessionID);\n01135|       \n01136|       // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –ø—É—Ç–∏ –∫ sessionID\n01137|       let sessionID = null;\n01138|       \n01139|       if (authData.data?.sessionID) {\n01140|         sessionID = authData.data.sessionID;\n01141|         console.log('‚úÖ SessionID –Ω–∞–π–¥–µ–Ω –≤ data.sessionID:', sessionID);\n01142|       } else if (authData.sessionID) {\n01143|         sessionID = authData.sessionID;\n01144|         console.log('‚úÖ SessionID –Ω–∞–π–¥–µ–Ω –≤ sessionID:', sessionID);\n01145|       } else if (authData.data?.session) {\n01146|         sessionID = authData.data.session;\n01147|         console.log('‚úÖ SessionID –Ω–∞–π–¥–µ–Ω –≤ data.session:', sessionID);\n01148|       }\n01149|       \n01150|       if (authResponse.ok && sessionID) {\n01151|         return sessionID;\n01152|       } else {\n01153|         console.error('‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –î–µ–ª–æ–≤—ã–µ –õ–∏–Ω–∏–∏:', authData);\n01154|         console.error('‚ùå –°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞:', authResponse.status);\n01155|         console.error('‚ùå –¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞:', authResponse.statusText);\n01156|         return null;\n01157|       }\n01158|     } catch (error) {\n01159|       console.error('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π –î–µ–ª–æ–≤—ã–µ –õ–∏–Ω–∏–∏:', error);\n01160|     }\n01161|     return null;\n01162|   };\n01163| \n01164|   // –ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ –≥–æ—Ä–æ–¥–æ–≤ –î–µ–ª–æ–≤—ã—Ö –õ–∏–Ω–∏–π\n01165|   const loadDellinCities = async () => {\n01166|     try {\n01167|       const response = await fetch('/data/dellin-cities.json');\n01168|       if (!response.ok) {\n01169|         console.error('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –≥–æ—Ä–æ–¥–æ–≤');\n01170|         return null;\n01171|       }\n01172|       const data = await response.json();\n01173|       return data.cities;\n01174|     } catch (error) {\n01175|       console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ –≥–æ—Ä–æ–¥–æ–≤:', error);\n01176|       return null;\n01177|     }\n01178|   };\n01179| \n01180|   // –ü–æ–∏—Å–∫ cityID –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ\n01181|   const getCityIDFromLocal = async (cityName: string): Promise<string | null> => {\n01182|     const cities = await loadDellinCities();\n01183|     if (!cities) return null;\n01184| \n01185|     const normalizedSearch = cityName.toLowerCase().trim()\n01186|       .replace(/^–≥\\s+/, '') // –£–±–∏—Ä–∞–µ–º –ø—Ä–µ—Ñ–∏–∫—Å \"–≥ \"\n01187|       .replace(/^–≥–æ—Ä–æ–¥\\s+/, '') // –£–±–∏—Ä–∞–µ–º –ø—Ä–µ—Ñ–∏–∫—Å \"–≥–æ—Ä–æ–¥ \"\n01188|       .replace(/\\s+/g, ' '); // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –ø—Ä–æ–±–µ–ª—ã\n01189| \n01190|     console.log(`üîç –ü–æ–∏—Å–∫ cityID –¥–ª—è –≥–æ—Ä–æ–¥–∞: \"${normalizedSearch}\"`);\n01191| \n01192|     // –ü–æ–∏—Å–∫ –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ\n01193|     for (const city of cities) {\n01194|       // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Å –∏–º–µ–Ω–µ–º –≥–æ—Ä–æ–¥–∞\n01195|       if (city.name.toLowerCase() === normalizedSearch) {\n01196|         console.log(`‚úÖ –¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ: \"${city.name}\" -> cityID: ${city.cityID}`);\n01197|         return city.cityID;\n01198|       }\n01199| \n01200|       // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Å –ø–æ–∏—Å–∫–æ–≤—ã–º–∏ —Å—Ç—Ä–æ–∫–∞–º–∏\n01201|       for (const searchString of city.searchStrings) {\n01202|         if (searchString === normalizedSearch) {\n01203|           console.log(`‚úÖ –ù–∞–π–¥–µ–Ω–æ –≤ –ø–æ–∏—Å–∫–æ–≤—ã—Ö —Å—Ç—Ä–æ–∫–∞—Ö: \"${searchString}\" –¥–ª—è –≥–æ—Ä–æ–¥–∞ \"${city.name}\" -> cityID: ${city.cityID}`);\n01204|           return city.cityID;\n01205|         }\n01206|       }\n01207|     }\n01208| \n01209|     console.warn(`‚ö†Ô∏è cityID –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ –¥–ª—è –≥–æ—Ä–æ–¥–∞: \"${normalizedSearch}\"`);\n01210|     return null;\n01211|   };\n01212| \n01213|   // –ü–æ–ª—É—á–µ–Ω–∏–µ cityID —á–µ—Ä–µ–∑ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π API –î–µ–ª–æ–≤—ã—Ö –õ–∏–Ω–∏–π\n01214|   const findCityInDellinDirectory = async (cityName: string): Promise<{cityID: number, code: string} | null> => {\n01215|     try {\n01216|       console.log(`üîç –ü–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–∞ –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ –î–õ: ${cityName}`);\n01217|       \n01218|       // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞\n01219|       const normalizedCity = cityName.toLowerCase().trim()\n01220|         .replace(/^–≥\\s+/, '') // –£–±–∏—Ä–∞–µ–º –ø—Ä–µ—Ñ–∏–∫—Å \"–≥ \"\n01221|         .replace(/^–≥–æ—Ä–æ–¥\\s+/, '') // –£–±–∏—Ä–∞–µ–º –ø—Ä–µ—Ñ–∏–∫—Å \"–≥–æ—Ä–æ–¥ \"\n01222|         .replace(/\\s+/g, ' '); // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –ø—Ä–æ–±–µ–ª—ã\n01223|       \n01224|       // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π API –¥–ª—è –ø–æ–∏—Å–∫–∞ –Ω–∞—Å–µ–ª–µ–Ω–Ω—ã—Ö –ø—É–Ω–∫—Ç–æ–≤\n01225|       const response = await fetch('https://api.dellin.ru/v2/public/kladr.json', {\n01226|         method: 'POST',\n01227|         headers: {\n01228|           'Content-Type': 'application/json'\n01229|         },\n01230|         body: JSON.stringify({\n01231|           appkey: 'E6C50E91-8E93-440F-9CC6-DEF9F0D68F1B',\n01232|           q: normalizedCity,\n01233|           limit: 10\n01234|         })\n01235|       });\n01236|       \n01237|       const data = await response.json();\n01238|       console.log(`üèôÔ∏è –ü–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–∞ \"${normalizedCity}\" response:`, data);\n01239|       \n01240|       if (response.ok && data.cities && Array.isArray(data.cities) && data.cities.length > 0) {\n01241|         // –ò—â–µ–º —Ç–æ—á–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∏–ª–∏ –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–π –≥–æ—Ä–æ–¥\n01242|         let bestMatch = data.cities.find((city: any) => \n01243|           city.searchString?.toLowerCase() === normalizedCity ||\n01244|           city.aString?.toLowerCase().includes(normalizedCity)\n01245|         );\n01246|         \n01247|         // –ï—Å–ª–∏ —Ç–æ—á–Ω–æ–≥–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –Ω–µ—Ç, –±–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π —Å —Ç–µ—Ä–º–∏–Ω–∞–ª–∞–º–∏\n01248|         if (!bestMatch) {\n01249|           bestMatch = data.cities.find((city: any) => city.isTerminal === 1);\n01250|         }\n01251|         \n01252|         // –ï—Å–ª–∏ –∏ —ç—Ç–æ–≥–æ –Ω–µ—Ç, –±–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π\n01253|         if (!bestMatch) {\n01254|           bestMatch = data.cities[0];\n01255|         }\n01256|         \n01257|         if (bestMatch) {\n01258|           console.log(`‚úÖ –ù–∞–π–¥–µ–Ω –≥–æ—Ä–æ–¥:`, {\n01259|             cityID: bestMatch.cityID,\n01260|             name: bestMatch.aString,\n01261|             code: bestMatch.code,\n01262|             hasTerminals: bestMatch.isTerminal === 1\n01263|           });\n01264|           \n01265|           return {\n01266|             cityID: bestMatch.cityID,\n01267|             code: bestMatch.code\n01268|           };\n01269|         }\n01270|       }\n01271|       \n01272|       console.warn(`‚ö†Ô∏è –ì–æ—Ä–æ–¥ \"${normalizedCity}\" –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ –î–õ`);\n01273|       return null;\n01274|       \n01275|     } catch (error) {\n01276|       console.error(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –≥–æ—Ä–æ–¥–∞ –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ –î–õ:`, error);\n01277|       return null;\n01278|     }\n01279|   };\n01280|   \n01281| \n01282|   \n01283|   // –ü–æ–∏—Å–∫ —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–≤ —á–µ—Ä–µ–∑ —Ä–∞–±–æ—á–∏–π v1 API (–∏–∑ test-dellin-terminals-simple.js)\n01284|   const getDellinTerminalByDirection = async (citySearch: string, direction: 'arrival' | 'derival'): Promise<string | null> => {\n01285|     try {\n01286|       console.log(`üîç –†–ê–ë–û–ß–ò–ô v1 API: –ü–æ–∏—Å–∫ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞ ${direction} –¥–ª—è –≥–æ—Ä–æ–¥–∞: ${citySearch}`);\n01287|       \n01288|       // –ü–æ–ª—É—á–∞–µ–º sessionID –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞\n01289|       const sessionID = await getDellinSessionId();\n01290|       if (!sessionID) {\n01291|         console.error('‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç sessionID –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–≤');\n01292|         return null;\n01293|       }\n01294|       \n01295|       // –ü—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å –∫ —Ä–∞–±–æ—á–µ–º—É API\n01296|       const requestData = {\n01297|         appkey: 'E6C50E91-8E93-440F-9CC6-DEF9F0D68F1B',\n01298|         sessionID: sessionID,\n01299|         search: citySearch,\n01300|         direction: direction\n01301|       };\n01302|       \n01303|       console.log(`üì§ –ó–∞–ø—Ä–æ—Å —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–≤:`, requestData);\n01304|       \n01305|       const response = await fetch('https://api.dellin.ru/v1/public/request_terminals.json', {\n01306|         method: 'POST',\n01307|         headers: {\n01308|           'Content-Type': 'application/json'\n01309|         },\n01310|         body: JSON.stringify(requestData)\n01311|       });\n01312|       \n01313|       const data = await response.json();\n01314|       console.log(`üì• –û—Ç–≤–µ—Ç —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–≤ (${response.status}):`, data);\n01315|       \n01316|       if (!response.ok) {\n01317|         console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–≤:', data);\n01318|         return null;\n01319|       }\n01320|       \n01321|       // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–≤ –≤ –æ—Ç–≤–µ—Ç–µ\n01322|       const terminals = data.terminals || [];\n01323|       if (terminals.length === 0) {\n01324|         console.warn(`‚ö†Ô∏è –¢–µ—Ä–º–∏–Ω–∞–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –¥–ª—è –≥–æ—Ä–æ–¥–∞ \"${citySearch}\"`);\n01325|         return null;\n01326|       }\n01327|       \n01328|       // –í—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—ã–π –¥–æ—Å—Ç—É–ø–Ω—ã–π —Ç–µ—Ä–º–∏–Ω–∞–ª\n01329|       const selectedTerminal = terminals[0];\n01330|       \n01331|       console.log(`‚úÖ –ù–∞–π–¥–µ–Ω —Ç–µ—Ä–º–∏–Ω–∞–ª ${direction}:`, {\n01332|         id: selectedTerminal.id,\n01333|         name: selectedTerminal.name,\n01334|         address: selectedTerminal.address\n01335|       });\n01336|       \n01337|       return selectedTerminal.id.toString();\n01338|       \n01339|     } catch (error) {\n01340|       console.error(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞ ${direction} (v1 API):`, error);\n01341|       return null;\n01342|     }\n01343|   };\n01344| \n01345|   // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–≤ –î–µ–ª–æ–≤—ã–µ –õ–∏–Ω–∏–∏ –¥–ª—è –≥–æ—Ä–æ–¥–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é —Å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º)\n01346|   const getDellinTerminal = async (citySearch: string): Promise<string | null> => {\n01347|     return getDellinTerminalByDirection(citySearch, 'arrival');\n01348|   };\n01349|   \n01350|   // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∞–¥—Ä–µ—Å–∞ —á–µ—Ä–µ–∑ DaData –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ –î–µ–ª–æ–≤—ã—Ö –õ–∏–Ω–∏–π\n01351|   const normalizeAddressForDellin = async (address: string): Promise<string> => {\n01352|     try {\n01353|       console.log(`üåê –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∞–¥—Ä–µ—Å–∞ —á–µ—Ä–µ–∑ DaData: ${address}`);\n01354|       \n01355|       const response = await fetch('/api/dadata', {\n01356|         method: 'POST',\n01357|         headers: {\n01358|           'Content-Type': 'application/json'\n01359|         },\n01360|         body: JSON.stringify({\n01361|           address: address,\n01362|           type: 'clean'\n01363|         })\n01364|       });\n01365|       \n01366|       const data = await response.json();\n01367|       console.log(`üåê DaData response:`, data);\n01368|       \n01369|       if (data.success && data.data?.dellinFormat) {\n01370|         console.log(`‚úÖ –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –∞–¥—Ä–µ—Å: ${data.data.dellinFormat}`);\n01371|         return data.data.dellinFormat;\n01372|       }\n01373|       \n01374|       // –ï—Å–ª–∏ DaData –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π –∞–¥—Ä–µ—Å\n01375|       console.warn(`‚ö†Ô∏è DaData –Ω–µ —Å–º–æ–≥ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å –∞–¥—Ä–µ—Å, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π`);\n01376|       return address;\n01377|       \n01378|     } catch (error) {\n01379|       console.error(`‚ùå –û—à–∏–±–∫–∞ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –∞–¥—Ä–µ—Å–∞ —á–µ—Ä–µ–∑ DaData:`, error);\n01380|       return address; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π –∞–¥—Ä–µ—Å –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏\n01381|     }\n01382|   };\n01383| \n01384|   // –ü–æ–ª—É—á–µ–Ω–∏–µ UID —É–ø–∞–∫–æ–≤–∫–∏ —á–µ—Ä–µ–∑ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π workflow —Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –î–õ\n01385|   const getDellinPackageUid = async (packageName: string = 'crate_with_bubble'): Promise<string | null> => {\n01386|     try {\n01387|       console.log(`üì¶ CSV WORKFLOW: –ü–æ–ª—É—á–µ–Ω–∏–µ UID —É–ø–∞–∫–æ–≤–∫–∏ \"${packageName}\" —á–µ—Ä–µ–∑ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π workflow...`);\n01388|       console.log('üì¶ CSV WORKFLOW: API –î–õ ‚Üí CSV —Å—Å—ã–ª–∫–∞ ‚Üí —Å–∫–∞—á–∞—Ç—å CSV ‚Üí –ø–∞—Ä—Å–∏—Ç—å ‚Üí –ø–æ–ª—É—á–∏—Ç—å UID');\n01389|       \n01390|       const response = await fetch('/api/dellin-packages', {\n01391|         method: 'GET',\n01392|         headers: {\n01393|           'Content-Type': 'application/json'\n01394|         }\n01395|       });\n01396| \n01397|       const data = await response.json();\n01398|       console.log('üì¶ CSV WORKFLOW response.ok:', response.ok);\n01399|       console.log('üì¶ CSV WORKFLOW status:', response.status);\n01400|       console.log('üì¶ CSV WORKFLOW workflow info:', data.workflow || 'not specified');\n01401|       \n01402|       if (response.ok && data.success && data.data && Array.isArray(data.data)) {\n01403|         console.log('üì¶ CSV WORKFLOW: —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫');\n01404|         console.log('üì¶ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–ø–∞–∫–æ–≤–æ–∫ –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ:', data.data.length);\n01405|         console.log('üì¶ –ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö:', data.cached ? '–∫—ç—à (24—á)' : '—Å–≤–µ–∂–∏–π CSV —Ñ–∞–π–ª');\n01406|         if (data.csvUrl) {\n01407|           console.log('üì¶ CSV URL:', data.csvUrl);\n01408|         }\n01409|         \n01410|         // –ü–æ–∏—Å–∫ –ø–æ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º –≤–∞—Ä–∏–∞–Ω—Ç–∞–º –Ω–∞–∑–≤–∞–Ω–∏—è\n01411|         const searchTerms = [\n01412|           packageName,\n01413|           '–æ–±—Ä–µ—à–µ—Ç–∫–∞',\n01414|           '–æ–±—Ä–µ—à—ë—Ç–∫–∞',\n01415|           '–∞–º–æ—Ä—Ç–∏–∑–∞—Ü–∏—è',\n01416|           'bubble',\n01417|           '–∑–∞—â–∏—Ç–Ω–∞—è —É–ø–∞–∫–æ–≤–∫–∞'\n01418|         ];\n01419|         \n01420|         let foundPackage: any = null;\n01421|         \n01422|         for (const term of searchTerms) {\n01423|           foundPackage = data.data.find((pkg: any) => \n01424|             pkg.name && pkg.name.toLowerCase().includes(term.toLowerCase())\n01425|           );\n01426|           \n01427|           if (foundPackage) {\n01428|             console.log(`‚úÖ CSV WORKFLOW: –ù–∞–π–¥–µ–Ω–∞ —É–ø–∞–∫–æ–≤–∫–∞ –ø–æ —Ç–µ—Ä–º–∏–Ω—É \"${term}\": ${foundPackage.name} ‚Üí ${foundPackage.uid}`);\n01429|             break;\n01430|           }\n01431|         }\n01432|         \n01433|         if (foundPackage && foundPackage.uid) {\n01434|           return foundPackage.uid;\n01435|         } else {\n01436|           console.log('‚ùå CSV WORKFLOW: –£–ø–∞–∫–æ–≤–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –ø–æ –ø–æ–∏—Å–∫–æ–≤—ã–º —Ç–µ—Ä–º–∏–Ω–∞–º');\n01437|           \n01438|           // –í—ã–≤–æ–¥–∏–º –ø–µ—Ä–≤—ã–µ 10 —É–ø–∞–∫–æ–≤–æ–∫ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏\n01439|           console.log('üì¶ –î–æ—Å—Ç—É–ø–Ω—ã–µ —É–ø–∞–∫–æ–≤–∫–∏ –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ (–ø–µ—Ä–≤—ã–µ 10):');\n01440|           data.data.slice(0, 10).forEach((pkg: any, index: number) => {\n01441|             console.log(`  ${index + 1}. ${pkg.name} (${pkg.uid})`);\n01442|           });\n01443|         }\n01444|       } else {\n01445|         console.error('‚ùå CSV WORKFLOW: –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞:', data);\n01446|       }\n01447|       \n01448|       return null;\n01449|         \n01450|     } catch (error) {\n01451|       console.error('‚ùå CSV WORKFLOW: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:', error);\n01452|       return null;\n01453|     }\n01454|   };\n01455| \n01456|   // –†–∞—Å—á–µ—Ç –¥–ª—è –î–µ–ª–æ–≤—ã—Ö –õ–∏–Ω–∏–π —á–µ—Ä–µ–∑ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π API v2/calculator.json —Å –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π\n01457|   const calculateDellin = async (): Promise<CalculationResult> => {\n01458|     const apiUrl = 'https://api.dellin.ru/v2/calculator.json';\n01459|     const maxRetries = 2;\n01460|     \n01461|     console.log('üöÄ === –ù–ê–ß–ê–õ–û –†–ê–°–ß–ï–¢–ê –î–ï–õ–û–í–´–• –õ–ò–ù–ò–ô ===');\n01462|     console.log('üöÄ API URL:', apiUrl);\n01463|     \n01464|     try {\n01465|       let sessionID = await getDellinSessionId();\n01466|       \n01467|       if (!sessionID) {\n01468|         return {\n01469|           company: '–î–µ–ª–æ–≤—ã–µ –õ–∏–Ω–∏–∏',\n01470|           price: 0,\n01471|           days: 0,\n01472|           error: '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å sessionID',\n01473|           apiUrl,\n01474|           requestData: null,\n01475|           responseData: null\n01476|         };\n01477|       }\n01478| \n01479|       // –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞–∑–º–µ—Ä—ã –∏ –æ–±—ä–µ–º—ã\n01480|       const totalWeight = form.cargos.reduce((sum, cargo) => sum + cargo.weight, 0);\n01481|       const totalVolume = form.cargos.reduce((sum, cargo) => \n01482|         sum + (cargo.length * cargo.width * cargo.height) / 1000000, 0\n01483|       );\n01484|       const maxLength = Math.max(...form.cargos.map(c => c.length)) / 100; // –≤ –º–µ—Ç—Ä–∞—Ö\n01485|       const maxWidth = Math.max(...form.cargos.map(c => c.width)) / 100;\n01486|       const maxHeight = Math.max(...form.cargos.map(c => c.height)) / 100;\n01487| \n01488|       // –ü–æ–ª—É—á–∞–µ–º —Ç–µ—Ä–º–∏–Ω–∞–ª—ã –∏ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∞–¥—Ä–µ—Å–∞\n01489|       let fromTerminalId: string | null = null;\n01490|       let toTerminalId: string | null = null;\n01491|       let normalizedFromAddress: string | null = null;\n01492|       let normalizedToAddress: string | null = null;\n01493|       \n01494|       // –î–ª—è —Ç–µ—Ä–º–∏–Ω–∞–ª—å–Ω–æ–π –¥–æ—Å—Ç–∞–≤–∫–∏ –ø–æ–ª—É—á–∞–µ–º —Ç–µ—Ä–º–∏–Ω–∞–ª—ã\n01495|       if (!form.fromAddressDelivery) {\n01496|         fromTerminalId = await getDellinTerminalByDirection(form.fromCity, 'derival');\n01497|       } else {\n01498|         // –î–ª—è –∞–¥—Ä–µ—Å–Ω–æ–π –¥–æ—Å—Ç–∞–≤–∫–∏ –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∞–¥—Ä–µ—Å\n01499|         const addressToNormalize = form.fromAddress || form.fromCity;\n01500|         normalizedFromAddress = await normalizeAddressForDellin(addressToNormalize);\n01501|       }\n01502|       \n01503|       if (!form.toAddressDelivery) {\n01504|         toTerminalId = await getDellinTerminalByDirection(form.toCity, 'arrival');\n01505|       } else {\n01506|         // –î–ª—è –∞–¥—Ä–µ—Å–Ω–æ–π –¥–æ—Å—Ç–∞–≤–∫–∏ –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∞–¥—Ä–µ—Å\n01507|         const addressToNormalize = form.toAddress || form.toCity;\n01508|         normalizedToAddress = await normalizeAddressForDellin(addressToNormalize);\n01509|       }\n01510|       \n01511|       console.log('üè¢ –î–ê–ù–ù–´–ï –î–õ:');\n01512|       console.log('üè¢ form.fromAddressDelivery:', form.fromAddressDelivery);\n01513|       console.log('üè¢ form.toAddressDelivery:', form.toAddressDelivery);\n01514|       console.log('üè¢ fromTerminalId:', fromTerminalId);\n01515|       console.log('üè¢ toTerminalId:', toTerminalId);\n01516|       console.log('üè¢ normalizedFromAddress:', normalizedFromAddress);\n01517|       console.log('üè¢ normalizedToAddress:', normalizedToAddress);\n01518|       \n01519|       // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ç–µ—Ä–º–∏–Ω–∞–ª—ã –Ω–∞–π–¥–µ–Ω—ã –¢–û–õ–¨–ö–û –¥–ª—è —Ç–µ—Ä–º–∏–Ω–∞–ª—å–Ω–æ–π –¥–æ—Å—Ç–∞–≤–∫–∏\n01520|       if (!form.fromAddressDelivery && !fromTerminalId) {\n01521|         console.error('‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω —Ç–µ—Ä–º–∏–Ω–∞–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è –≥–æ—Ä–æ–¥–∞:', form.fromCity);\n01522|         return {\n01523|           company: '–î–µ–ª–æ–≤—ã–µ –õ–∏–Ω–∏–∏',\n01524|           price: 0,\n01525|           days: 0,\n01526|           error: `–ù–µ –Ω–∞–π–¥–µ–Ω —Ç–µ—Ä–º–∏–Ω–∞–ª –î–µ–ª–æ–≤—ã—Ö –õ–∏–Ω–∏–π –≤ –≥–æ—Ä–æ–¥–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è: ${form.fromCity}`,\n01527|           apiUrl,\n01528|           requestData: null,\n01529|           responseData: null\n01530|         };\n01531|       }\n01532|       \n01533|       if (!form.toAddressDelivery && !toTerminalId) {\n01534|         console.error('‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω —Ç–µ—Ä–º–∏–Ω–∞–ª –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –≥–æ—Ä–æ–¥–∞:', form.toCity);\n01535|         return {\n01536|           company: '–î–µ–ª–æ–≤—ã–µ –õ–∏–Ω–∏–∏',\n01537|           price: 0,\n01538|           days: 0,\n01539|           error: `–ù–µ –Ω–∞–π–¥–µ–Ω —Ç–µ—Ä–º–∏–Ω–∞–ª –î–µ–ª–æ–≤—ã—Ö –õ–∏–Ω–∏–π –≤ –≥–æ—Ä–æ–¥–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è: ${form.toCity}`,\n01540|           apiUrl,\n01541|           requestData: null,\n01542|           responseData: null\n01543|         };\n01544|       }\n01545|       \n01546|       // –î–ª—è –∞–¥—Ä–µ—Å–Ω–æ–π –¥–æ—Å—Ç–∞–≤–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∞–¥—Ä–µ—Å–∞ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω—ã\n01547|       if (form.fromAddressDelivery && !normalizedFromAddress) {\n01548|         console.error('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å –∞–¥—Ä–µ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è:', form.fromAddress || form.fromCity);\n01549|         return {\n01550|           company: '–î–µ–ª–æ–≤—ã–µ –õ–∏–Ω–∏–∏',\n01551|           price: 0,\n01552|           days: 0,\n01553|           error: `–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∞–¥—Ä–µ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è: ${form.fromAddress || form.fromCity}`,\n01554|           apiUrl,\n01555|           requestData: null,\n01556|           responseData: null\n01557|         };\n01558|       }\n01559|       \n01560|       if (form.toAddressDelivery && !normalizedToAddress) {\n01561|         console.error('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å –∞–¥—Ä–µ—Å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è:', form.toAddress || form.toCity);\n01562|         return {\n01563|           company: '–î–µ–ª–æ–≤—ã–µ –õ–∏–Ω–∏–∏',\n01564|           price: 0,\n01565|           days: 0,\n01566|           error: `–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∞–¥—Ä–µ—Å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è: ${form.toAddress || form.toCity}`,\n01567|           apiUrl,\n01568|           requestData: null,\n01569|           responseData: null\n01570|         };\n01571|       }\n01572| \n01573|       // –ü–æ–ª—É—á–∞–µ–º UID —É–ø–∞–∫–æ–≤–∫–∏ crate_with_bubble (–µ—Å–ª–∏ –Ω—É–∂–Ω–∞ —É–ø–∞–∫–æ–≤–∫–∞)\n01574|       let packageUid: string | null = null;\n01575|       console.log('=== –ù–ê–ß–ê–õ–û –û–¢–õ–ê–î–ö–ò –£–ü–ê–ö–û–í–ö–ò ===');\n01576|       console.log('üîç –û–¢–õ–ê–î–ö–ê –£–ü–ê–ö–û–í–ö–ò: form.needPackaging =', form.needPackaging);\n01577|       console.log('üîç –û–¢–õ–ê–î–ö–ê –£–ü–ê–ö–û–í–ö–ò: typeof form.needPackaging =', typeof form.needPackaging);\n01578|       \n01579|       if (form.needPackaging) {\n01580|         console.log('üîç ‚úÖ –£–ü–ê–ö–û–í–ö–ê –¢–†–ï–ë–£–ï–¢–°–Ø - –ó–ê–ü–†–ê–®–ò–í–ê–ï–ú UID —á–µ—Ä–µ–∑ CSV WORKFLOW...');\n01581|         try {\n01582|           packageUid = await getDellinPackageUid('crate_with_bubble');\n01583|           console.log('üîç ‚úÖ –ü–û–õ–£–ß–ï–ù packageUid –∏–∑ CSV WORKFLOW:', packageUid);\n01584|           \n01585|           // –ï—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–∏ UID –∏–∑ CSV, –∏—Å–ø–æ–ª—å–∑—É–µ–º UID —Å —Å–∞–π—Ç–∞ –î–õ (–∏—Å–ø—Ä–∞–≤–ª—è–µ–º —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ 500‚ÇΩ)\n01586|           if (!packageUid) {\n01587|             packageUid = '0x9dd8901b0ecef10c11e8ed001199bf6e'; // UID —Å –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ —Å–∞–π—Ç–∞ –î–õ\n01588|             console.log('üîç üß™ –ò–°–ü–û–õ–¨–ó–£–ï–ú UID –° –°–ê–ô–¢–ê –î–õ (–∏—Å–ø—Ä–∞–≤–ª—è–µ–º —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ):', packageUid);\n01589|           }\n01590|           \n01591|           console.log('üîç ‚úÖ –§–ò–ù–ê–õ–¨–ù–´–ô packageUid:', packageUid);\n01592|           console.log('üîç ‚úÖ typeof packageUid:', typeof packageUid);\n01593|           console.log('üîç ‚úÖ packageUid truthy:', !!packageUid);\n01594|         } catch (error) {\n01595|           console.log('üîç ‚ùå –û–®–ò–ë–ö–ê –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ packageUid —á–µ—Ä–µ–∑ CSV WORKFLOW:', error);\n01596|           // –ò—Å–ø–æ–ª—å–∑—É–µ–º UID —Å —Å–∞–π—Ç–∞ –î–õ –∫–∞–∫ fallback (–∏—Å–ø—Ä–∞–≤–ª—è–µ–º —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ)\n01597|           packageUid = '0x9dd8901b0ecef10c11e8ed001199bf6e'; // UID —Å –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ —Å–∞–π—Ç–∞ –î–õ\n01598|           console.log('üîç üß™ –ò–°–ü–û–õ–¨–ó–£–ï–ú UID –° –°–ê–ô–¢–ê –î–õ –ø–æ—Å–ª–µ –æ—à–∏–±–∫–∏ (–∏—Å–ø—Ä–∞–≤–ª—è–µ–º —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ):', packageUid);\n01599|         }\n01600|       } else {\n01601|         console.log('üîç ‚ùå –£–ø–∞–∫–æ–≤–∫–∞ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø–æ–ª—É—á–µ–Ω–∏–µ UID');\n01602|       }\n01603|       console.log('=== –ö–û–ù–ï–¶ –û–¢–õ–ê–î–ö–ò –£–ü–ê–ö–û–í–ö–ò ===');\n01604| \n01605|       // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞—Ç—É –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–∞ –∑–∞–≤—Ç—Ä–∞\n01606|       const tomorrow = new Date();\n01607|       tomorrow.setDate(tomorrow.getDate() + 1);\n01608|       const produceDate = tomorrow.toISOString().split('T')[0];\n01609| \n01610|       // –û—Ç–ª–∞–¥–∫–∞ –ø–µ—Ä–µ–¥ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∑–∞–ø—Ä–æ—Å–∞\n01611|       console.log('=== –û–¢–õ–ê–î–ö–ê –§–û–†–ú–ò–†–û–í–ê–ù–ò–Ø –ó–ê–ü–†–û–°–ê ===');\n01612|       console.log('üîç form.needPackaging =', form.needPackaging, '(—Ç–∏–ø:', typeof form.needPackaging, ')');\n01613|       console.log('üîç packageUid =', packageUid, '(—Ç–∏–ø:', typeof packageUid, ')');\n01614|       console.log('üîç packageUid truthy =', !!packageUid);\n01615|       console.log('üîç –£—Å–ª–æ–≤–∏–µ (form.needPackaging && packageUid) =', form.needPackaging && packageUid);\n01616|       \n01617|       if (form.needPackaging && packageUid) {\n01618|         console.log('‚úÖ PACKAGES –ë–£–î–ï–¢ –î–û–ë–ê–í–õ–ï–ù –í –ó–ê–ü–†–û–°!');\n01619|       } else {\n01620|         console.log('‚ùå PACKAGES –ù–ï –ë–£–î–ï–¢ –î–û–ë–ê–í–õ–ï–ù:');\n01621|         if (!form.needPackaging) console.log('  - form.needPackaging = false');\n01622|         if (!packageUid) console.log('  - packageUid –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç/null');\n01623|       }\n01624| \n01625|       // –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∑–∞–ø—Ä–æ—Å–∞ —Å–æ–≥–ª–∞—Å–Ω–æ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏\n01626|       const requestData = {\n01627|         appkey: 'E6C50E91-8E93-440F-9CC6-DEF9F0D68F1B',\n01628|         sessionID: sessionID,\n01629|         delivery: {\n01630|           deliveryType: {\n01631|             type: 'auto'  // –í—Å–µ–≥–¥–∞ \"auto\" –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é\n01632|           },\n01633|           derival: {\n01634|             produceDate: produceDate,  // –û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è –¥–∞—Ç–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è\n01635|             variant: form.fromAddressDelivery ? 'address' : 'terminal',\n01636|             ...(form.fromAddressDelivery ? {\n01637|               address: {\n01638|                 search: normalizedFromAddress || form.fromAddress || form.fromCity\n01639|               }\n01640|             } : {\n01641|               terminalID: fromTerminalId\n01642|             }),\n01643|             time: {\n01644|               worktimeStart: '10:00',\n01645|               worktimeEnd: '18:00',\n01646|               breakStart: '13:00',\n01647|               breakEnd: '14:00',\n01648|               exactTime: false\n01649|             }\n01650|             // handling –≤ derival –≤—Å–µ–≥–¥–∞ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è —Å–æ–≥–ª–∞—Å–Ω–æ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏\n01651|           },\n01652|           arrival: {\n01653|             variant: form.toAddressDelivery ? 'address' : 'terminal',\n01654|             ...(form.toAddressDelivery ? {\n01655|               address: {\n01656|                 search: normalizedToAddress || form.toAddress || form.toCity\n01657|               }\n01658|             } : {\n01659|               terminalID: toTerminalId\n01660|             }),\n01661|             time: {\n01662|               worktimeStart: '10:00',\n01663|               worktimeEnd: '18:00',\n01664|               breakStart: '13:00',\n01665|               breakEnd: '14:00',\n01666|               exactTime: false\n01667|             },\n01668|             // handling –≤ arrival –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥—ä–µ–º\n01669|             ...(form.needCarry ? {\n01670|               handling: {\n01671|                 freightLift: form.hasFreightLift, // true —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –≥–∞–ª–æ—á–∫–∞ \"–Ω–∞–ª–∏—á–∏–µ –≥—Ä—É–∑–æ–≤–æ–≥–æ –ª–∏—Ñ—Ç–∞\"\n01672|                 toFloor: form.floor, // —ç—Ç–∞–∂ –∏–∑ —Ñ–æ—Ä–º—ã\n01673|                 carry: 0\n01674|               }\n01675|             } : {})\n01676|           },\n01677|           ...(form.needPackaging && packageUid ? {\n01678|             packages: [{\n01679|               uid: packageUid,  // UID —É–ø–∞–∫–æ–≤–∫–∏ crate_with_bubble –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞\n01680|               count: 1  // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 1\n01681|             }]\n01682|           } : {})\n01683|         },\n01684|         cargo: {\n01685|           quantity: form.cargos.length,\n01686|           length: maxLength,\n01687|           width: maxWidth,\n01688|           height: maxHeight,\n01689|           weight: totalWeight,\n01690|           totalVolume: totalVolume,\n01691|           totalWeight: totalWeight,\n01692|           oversizedWeight: 0,\n01693|           oversizedVolume: 0,\n01694|           hazardClass: 0,  // –í—Å–µ–≥–¥–∞ 0 –µ—Å–ª–∏ –Ω–µ—Ç –æ–ø–∞—Å–Ω—ã—Ö –≥—Ä—É–∑–æ–≤\n01695|           ...(form.needInsurance && form.declaredValue > 0 ? {\n01696|             insurance: {\n01697|               statedValue: form.declaredValue,\n01698|               term: true  // –í—Å–µ–≥–¥–∞ true –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ —Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏—è\n01699|             }\n01700|           } : {})\n01701|         },\n01702|         payment: {\n01703|           type: 'noncash',  // –í—Å–µ–≥–¥–∞ \"noncash\"\n01704|           paymentCitySearch: {\n01705|             search: form.fromCity  // –ì–æ—Ä–æ–¥ –æ–ø–ª–∞—Ç—ã\n01706|           }\n01707|         }\n01708|       };\n01709| \n01710|       console.log('üöÄ –ò–¢–û–ì–û–í–´–ô –ó–ê–ü–†–û–° –ö –î–õ:', JSON.stringify(requestData, null, 2));\n01711|       \n01712|       // –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –±–ª–æ–∫–∞ packages\n01713|       if (requestData.delivery.packages) {\n01714|         console.log('‚úÖ PACKAGES –ù–ê–ô–î–ï–ù –í –ó–ê–ü–†–û–°–ï:', requestData.delivery.packages);\n01715|       } else {\n01716|         console.log('‚ùå PACKAGES –ù–ï –ù–ê–ô–î–ï–ù –í –ó–ê–ü–†–û–°–ï');\n01717|         console.log('   form.needPackaging =', form.needPackaging);\n01718|         console.log('   packageUid =', packageUid);\n01719|         console.log('   –£—Å–ª–æ–≤–∏–µ:', form.needPackaging && packageUid);\n01720|       }\n01721| \n01722|       // –ü–æ–ø—ã—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–∞ —Å –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö\n01723|       let response: any = null;\n01724|       let data: any = null;\n01725|       \n01726|       for (let attempt = 1; attempt <= maxRetries; attempt++) {\n01727|         console.log(`üîÑ –î–õ: –ø–æ–ø—ã—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ ${attempt}/${maxRetries}`);\n01728|         \n01729|         response = await fetch(apiUrl, {\n01730|           method: 'POST',\n01731|           headers: {\n01732|             'Content-Type': 'application/json',\n01733|             'Accept': 'application/json'\n01734|           },\n01735|           body: JSON.stringify(requestData)\n01736|         });\n01737| \n01738|         try {\n01739|           data = await response.json();\n01740|         } catch (parseError) {\n01741|           console.error('‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON –æ—Ç–≤–µ—Ç–∞ –î–õ:', parseError);\n01742|           throw new Error(`–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –æ—Ç–≤–µ—Ç–∞ API: ${parseError instanceof Error ? parseError.message : '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);\n01743|         }\n01744|         \n01745|         console.log('üöÄ –û–¢–í–ï–¢ –î–õ response.ok:', response.ok);\n01746|         console.log('üöÄ –û–¢–í–ï–¢ –î–õ status:', response.status);\n01747|         console.log('üöÄ –û–¢–í–ï–¢ –î–õ data:', data);\n01748|         \n01749|         // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Ç–∏–ø—ã –æ—à–∏–±–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏\n01750|         const isAuthError = response.status === 401 || \n01751|                            response.status === 403 ||\n01752|                            (response.status === 400 && data?.errors?.some((err: any) => \n01753|                              err.detail?.toLowerCase()?.includes('session') ||\n01754|                              err.detail?.toLowerCase()?.includes('auth') ||\n01755|                              err.detail?.toLowerCase()?.includes('invalid')\n01756|                            ));\n01757| \n01758|         if (isAuthError && attempt < maxRetries) {\n01759|           console.log('üîÑ –î–õ: –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –æ—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏, –≤—ã–ø–æ–ª–Ω—è–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—É—é –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é...');\n01760|           const newSessionId = await getDellinSessionId();\n01761|           if (newSessionId) {\n01762|             console.log('‚úÖ –î–õ: –ø–æ–ª—É—á–µ–Ω –Ω–æ–≤—ã–π SessionID, –æ–±–Ω–æ–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å...');\n01763|             // –û–±–Ω–æ–≤–ª—è–µ–º sessionID –≤ –∑–∞–ø—Ä–æ—Å–µ\n01764|             requestData.sessionID = newSessionId;\n01765|             sessionID = newSessionId;\n01766|             continue; // –ü—Ä–æ–±—É–µ–º –µ—â–µ —Ä–∞–∑ —Å –Ω–æ–≤–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π\n01767|           } else {\n01768|             console.error('‚ùå –î–õ: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –Ω–æ–≤—ã–π SessionID');\n01769|             break;\n01770|           }\n01771|         }\n01772|         \n01773|         if (response.status === 400 && data?.errors) {\n01774|           console.log('=== –ê–ù–ê–õ–ò–ó –û–®–ò–ë–ö–ò 400 ===');\n01775|           console.log('üîç –û—à–∏–±–∫–∏:', data.errors);\n01776|           data.errors.forEach((error: any, index: number) => {\n01777|             console.log(`üîç –û—à–∏–±–∫–∞ ${index + 1}:`, error);\n01778|             console.log(`   - –ü–æ–ª–µ: ${error.field || '–Ω–µ —É–∫–∞–∑–∞–Ω–æ'}`);\n01779|             console.log(`   - –°–æ–æ–±—â–µ–Ω–∏–µ: ${error.detail || error.message || '–Ω–µ —É–∫–∞–∑–∞–Ω–æ'}`);\n01780|           });\n01781|           console.log('=== –ö–û–ù–ï–¶ –ê–ù–ê–õ–ò–ó–ê –û–®–ò–ë–ö–ò 400 ===');\n01782|         }\n01783| \n01784|         // –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å —É—Å–ø–µ—à–Ω—ã–π –∏–ª–∏ –Ω–µ —Å–≤—è–∑–∞–Ω —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É\n01785|         break;\n01786|       }\n01787| \n01788|       // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –æ—à–∏–±–∫–∏ –ü–ï–†–ï–î –∞–Ω–∞–ª–∏–∑–æ–º –¥–∞–Ω–Ω—ã—Ö\n01789|       if (!response.ok || !data.data) {\n01790|         console.log('‚ùå –û—à–∏–±–æ—á–Ω—ã–π –æ—Ç–≤–µ—Ç API - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∞–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö');\n01791|         const errorMessage = data.metadata?.detail || \n01792|                            data.metadata?.message || \n01793|                            data.errors?.[0]?.detail || \n01794|                            (data.metadata?.status !== 200 ? `HTTP ${data.metadata?.status}` : '') ||\n01795|                            `HTTP ${response.status} - ${response.statusText}` ||\n01796|                            '–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ –î–µ–ª–æ–≤—ã–µ –õ–∏–Ω–∏–∏';\n01797|         return {\n01798|           company: '–î–µ–ª–æ–≤—ã–µ –õ–∏–Ω–∏–∏',\n01799|           price: 0,\n01800|           days: 0,\n01801|           error: errorMessage,\n01802|           requestData,\n01803|           responseData: data,\n01804|           apiUrl,\n01805|           sessionId: sessionID\n01806|         };\n01807|       }\n01808|       \n01809|       // –î–ï–¢–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó –°–¢–†–£–ö–¢–£–†–´ –°–¢–†–ê–•–û–í–ö–ò (—Ç–æ–ª—å–∫–æ –¥–ª—è —É—Å–ø–µ—à–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞)\n01810|       console.log('=== –ü–û–õ–ù–´–ô –ê–ù–ê–õ–ò–ó –°–¢–†–£–ö–¢–£–†–´ –°–¢–†–ê–•–û–í–ö–ò ===');\n01811|       console.log('üîç –ü–†–û–í–ï–†–ö–ê –°–¢–†–£–ö–¢–£–†–´ –î–ê–ù–ù–´–•:');\n01812|       console.log('üîç data:', data ? '—Å—É—â–µ—Å—Ç–≤—É–µ—Ç' : 'undefined/null');\n01813|       console.log('üîç typeof data:', typeof data);\n01814|       console.log('üîç data.data:', data?.data ? '—Å—É—â–µ—Å—Ç–≤—É–µ—Ç' : 'undefined/null');\n01815|       console.log('üîç typeof data.data:', typeof data?.data);\n01816|       \n01817|       // –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤–æ–π—Å—Ç–≤ data.data\n01818|       if (data?.data) {\n01819|         console.log('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–≤–æ–π—Å—Ç–≤–∞ data.data:');\n01820|         console.log('üîç data.data.derival:', typeof data.data.derival, data.data.derival);\n01821|         console.log('üîç data.data.arrival:', typeof data.data.arrival, data.data.arrival);\n01822|         console.log('üîç data.data.intercity:', typeof data.data.intercity, data.data.intercity);\n01823|       }\n01824|       \n01825|       if (!data) {\n01826|         console.error('‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: data undefined/null');\n01827|         return {\n01828|           company: '–î–µ–ª–æ–≤—ã–µ –õ–∏–Ω–∏–∏',\n01829|           price: 0,\n01830|           days: 0,\n01831|           error: '–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç–≤–µ—Ç–∞ API: –¥–∞–Ω–Ω—ã–µ –Ω–µ –ø–æ–ª—É—á–µ–Ω—ã',\n01832|           apiUrl,\n01833|           requestData,\n01834|           responseData: null\n01835|         };\n01836|       }\n01837|       \n01838|       try {\n01839|         console.log('üîç –ü–û–õ–ù–ê–Ø –°–¢–†–£–ö–¢–£–†–ê data.data:', JSON.stringify(data.data, null, 2));\n01840|       } catch (jsonError) {\n01841|         console.error('‚ùå –û—à–∏–±–∫–∞ JSON.stringify –¥–ª—è data.data:', jsonError);\n01842|         console.log('üîç data.data (toString):', data.data?.toString?.() || '–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å');\n01843|       }\n01844|       \n01845|       // –ü–æ–∏—Å–∫ –≤—Å–µ—Ö –ø–æ–ª–µ–π —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å–æ —Å—Ç—Ä–∞—Ö–æ–≤–∫–æ–π\n01846|       console.log('üí≥ –ü–û–ò–°–ö –ö–û–ú–ü–û–ù–ï–ù–¢–û–í –°–¢–†–ê–•–û–í–ö–ò:');\n01847|       console.log('üí≥ data.data.insurance:', data.data?.insurance);\n01848|       console.log('üí≥ data.data.cargoInsurance:', data.data?.cargoInsurance);\n01849|       console.log('üí≥ data.data.termInsurance:', data.data?.termInsurance);\n01850|       console.log('üí≥ data.data.insuranceDetails:', data.data?.insuranceDetails);\n01851|       console.log('üí≥ data.data.services:', data.data?.services);\n01852|       console.log('üí≥ data.data.additionalServices:', data.data?.additionalServices);\n01853|       \n01854|       // –ü–æ–∏—Å–∫ —Å—Ç—Ä–∞—Ö–æ–≤–∫–∏ –≤ –¥—Ä—É–≥–∏—Ö —Ä–∞–∑–¥–µ–ª–∞—Ö\n01855|       try {\n01856|         console.log('üí≥ –ü—Ä–æ–≤–µ—Ä—è–µ–º derival...');\n01857|         if (data.data?.derival) {\n01858|           console.log('üí≥ derival –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–≤–µ—Ä—è–µ–º insurance...');\n01859|           console.log('üí≥ –°–¢–†–ê–•–û–í–ö–ê –í –ó–ê–ë–û–ï data.data.derival.insurance:', data.data.derival?.insurance);\n01860|         } else {\n01861|           console.log('üí≥ derival –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ null');\n01862|         }\n01863|         \n01864|         console.log('üí≥ –ü—Ä–æ–≤–µ—Ä—è–µ–º arrival...');\n01865|         if (data.data?.arrival) {\n01866|           console.log('üí≥ arrival –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–≤–µ—Ä—è–µ–º insurance...');\n01867|           console.log('üí≥ –°–¢–†–ê–•–û–í–ö–ê –í –î–û–°–¢–ê–í–ö–ï data.data.arrival.insurance:', data.data.arrival?.insurance);\n01868|         } else {\n01869|           console.log('üí≥ arrival –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ null');\n01870|         }\n01871|         \n01872|         console.log('üí≥ –ü—Ä–æ–≤–µ—Ä—è–µ–º intercity...');\n01873|         if (data.data?.intercity) {\n01874|           console.log('üí≥ intercity –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–≤–µ—Ä—è–µ–º insurance...');\n01875|           console.log('üí≥ –°–¢–†–ê–•–û–í–ö–ê –í –ü–ï–†–ï–í–û–ó–ö–ï data.data.intercity.insurance:', data.data.intercity?.insurance);\n01876|         } else {\n01877|           console.log('üí≥ intercity –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ null');\n01878|         }\n01879|       } catch (error) {\n01880|         console.error('‚ùå –û–®–ò–ë–ö–ê –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å–µ–∫—Ü–∏–π —Å—Ç—Ä–∞—Ö–æ–≤–∫–∏:', error);\n01881|         console.error('‚ùå –°—Ç–µ–∫ –æ—à–∏–±–∫–∏:', error instanceof Error ? error.stack : '–ù–µ—Ç —Å—Ç–µ–∫–∞');\n01882|       }\n01883|       \n01884|       // –†–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π –ø–æ–∏—Å–∫ –≤—Å–µ—Ö –ø–æ–ª–µ–π —Å–æ–¥–µ—Ä–∂–∞—â–∏—Ö \"insurance\"\n01885|       const findInsuranceFields = (obj: any, path = '') => {\n01886|         if (typeof obj !== 'object' || obj === null || obj === undefined) return;\n01887|         \n01888|         try {\n01889|           Object.keys(obj).forEach(key => {\n01890|             const fullPath = path ? `${path}.${key}` : key;\n01891|             if (key.toLowerCase().includes('insurance') || key.toLowerCase().includes('insur')) {\n01892|               console.log(`üí≥ –ù–ê–ô–î–ï–ù–û –ü–û–õ–ï –°–¢–†–ê–•–û–í–ö–ò [${fullPath}]:`, obj[key]);\n01893|             }\n01894|             if (typeof obj[key] === 'object' && obj[key] !== null && obj[key] !== undefined) {\n01895|               findInsuranceFields(obj[key], fullPath);\n01896|             }\n01897|           });\n01898|         } catch (error) {\n01899|           console.error(`üí≥ –û—à–∏–±–∫–∞ –≤ findInsuranceFields –¥–ª—è –ø—É—Ç–∏ ${path}:`, error);\n01900|         }\n01901|       };\n01902|       \n01903|       console.log('üí≥ –†–ï–ö–£–†–°–ò–í–ù–´–ô –ü–û–ò–°–ö –ü–û–õ–ï–ô –°–¢–†–ê–•–û–í–ö–ò:');\n01904|       try {\n01905|         if (data && data.data) {\n01906|           findInsuranceFields(data.data, 'data.data');\n01907|         } else {\n01908|           console.log('üí≥ –ü—Ä–æ–ø—É—Å–∫ —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞: data.data –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');\n01909|         }\n01910|       } catch (error) {\n01911|         console.error('‚ùå –û–®–ò–ë–ö–ê –≤ —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ–º –ø–æ–∏—Å–∫–µ:', error);\n01912|         console.error('‚ùå –°—Ç–µ–∫ –æ—à–∏–±–∫–∏:', error instanceof Error ? error.stack : '–ù–µ—Ç —Å—Ç–µ–∫–∞');\n01913|       }\n01914|       console.log('=== –ö–û–ù–ï–¶ –ê–ù–ê–õ–ò–ó–ê –°–¢–†–ê–•–û–í–ö–ò ===');\n01915|       \n01916|       // –°–ø–µ—Ü–∏–∞–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ packages –≤ –æ—Ç–≤–µ—Ç–µ\n01917|       console.log('=== –ü–û–ò–°–ö PACKAGES –í –û–¢–í–ï–¢–ï ===');\n01918|       console.log('üì¶ data.data =', data.data);\n01919|       console.log('üì¶ data.data.packages =', data.data?.packages);\n01920|       console.log('üì¶ –¢–∏–ø data.data.packages:', typeof data.data?.packages);\n01921|       if (data.data?.packages) {\n01922|         console.log('‚úÖ PACKAGES –ù–ê–ô–î–ï–ù –í –û–¢–í–ï–¢–ï!');\n01923|         try {\n01924|           console.log('üì¶ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ packages:', JSON.stringify(data.data.packages, null, 2));\n01925|         } catch (jsonError) {\n01926|           console.error('‚ùå –û—à–∏–±–∫–∞ JSON.stringify –¥–ª—è packages:', jsonError);\n01927|           console.log('üì¶ packages (toString):', data.data.packages?.toString?.() || '–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å');\n01928|         }\n01929|       } else {\n01930|         console.log('‚ùå PACKAGES –ù–ï –ù–ê–ô–î–ï–ù –í –û–¢–í–ï–¢–ï');\n01931|       }\n01932|       console.log('=== –ö–û–ù–ï–¶ –ü–û–ò–°–ö–ê PACKAGES ===');\n01933| \n01934|       if (response.ok && data.data && data.metadata?.status === 200) {\n01935|         let totalPrice = data.data.price || 0;\n01936|         console.log('üí∞ –†–ê–°–ß–ï–¢ –ò–¢–û–ì–û–í–û–ô –°–¢–û–ò–ú–û–°–¢–ò:');\n01937|         console.log('üí∞ –ë–∞–∑–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å data.data.price (–£–ñ–ï –í–ö–õ–Æ–ß–ê–ï–¢ –í–°–ï):', totalPrice);\n01938|         \n01939|         // –°–¢–†–ê–•–û–í–ö–ê –£–ñ–ï –í–ö–õ–Æ–ß–ï–ù–ê –≤ data.data.price - –ù–ï –¥–æ–±–∞–≤–ª—è–µ–º –ø–æ–≤—Ç–æ—Ä–Ω–æ\n01940|         if (data.data.insurance) {\n01941|           console.log('üí∞ –°—Ç—Ä–∞—Ö–æ–≤–∫–∞ data.data.insurance (–£–ñ–ï –≤–∫–ª—é—á–µ–Ω–∞ –≤ –±–∞–∑–æ–≤—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å):', data.data.insurance);\n01942|           console.log('üí∞ –ù–ï –¥–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–∞—Ö–æ–≤–∫—É –ø–æ–≤—Ç–æ—Ä–Ω–æ');\n01943|         } else {\n01944|           console.log('üí∞ –°—Ç—Ä–∞—Ö–æ–≤–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ –æ—Ç–≤–µ—Ç–µ');\n01945|         }\n01946|         \n01947|         // –£–ü–ê–ö–û–í–ö–ê –£–ñ–ï –í–ö–õ–Æ–ß–ï–ù–ê –≤ data.data.price - –ù–ï –¥–æ–±–∞–≤–ª—è–µ–º –ø–æ–≤—Ç–æ—Ä–Ω–æ\n01948|         console.log('üí∞ –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û–ë –£–ü–ê–ö–û–í–ö–ï (–£–ñ–ï –í–ö–õ–Æ–ß–ï–ù–ê –í –û–°–ù–û–í–ù–£–Æ –°–¢–û–ò–ú–û–°–¢–¨):');\n01949|         console.log('üí∞ data.data.packages =', data.data.packages);\n01950|         console.log('üí∞ form.needPackaging =', form.needPackaging);\n01951|         \n01952|         if (data.data.packages && form.needPackaging) {\n01953|           console.log('üí∞ ‚úÖ –£–ü–ê–ö–û–í–ö–ê –ü–†–ò–°–£–¢–°–¢–í–£–ï–¢ –í –û–¢–í–ï–¢–ï (—Ü–µ–Ω–∞ —É–∂–µ –≤–∫–ª—é—á–µ–Ω–∞ –≤ data.data.price)');\n01954|           console.log('üí∞ –¢–∏–ø packages:', Array.isArray(data.data.packages) ? 'Array' : 'Object');\n01955|           \n01956|           if (Array.isArray(data.data.packages)) {\n01957|             data.data.packages.forEach((pkg: any, index: number) => {\n01958|               console.log(`üí∞ Package [${index}] (–≤–∫–ª—é—á–µ–Ω–∞ –≤ –æ—Å–Ω–æ–≤–Ω—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å):`, pkg);\n01959|             });\n01960|           } else {\n01961|             Object.entries(data.data.packages).forEach(([key, pkg]: [string, any]) => {\n01962|               console.log(`üí∞ Package [${key}] (–≤–∫–ª—é—á–µ–Ω–∞ –≤ –æ—Å–Ω–æ–≤–Ω—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å):`, pkg);\n01963|             });\n01964|           }\n01965|         } else {\n01966|           console.log('üí∞ ‚ùå –£–ø–∞–∫–æ–≤–∫–∞ –Ω–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞–ª–∞—Å—å');\n01967|         }\n01968| \n01969|         // –í—ã—á–∏—Å–ª—è–µ–º —Å—Ä–æ–∫ –¥–æ—Å—Ç–∞–≤–∫–∏ –∫–∞–∫ —Ä–∞–∑–Ω–æ—Å—Ç—å –º–µ–∂–¥—É –¥–∞—Ç–∞–º–∏ pickup –∏ arrivalToOspReceiver\n01970|         let deliveryDays = 0;\n01971|         try {\n01972|           console.log('=== –ü–û–ò–°–ö –î–ê–¢ –í –û–¢–í–ï–¢–ï ===');\n01973|           \n01974|           // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –º–µ—Å—Ç–∞ –≥–¥–µ –º–æ–≥—É—Ç –±—ã—Ç—å –¥–∞—Ç—ã\n01975|           console.log('–ü—Ä–æ–≤–µ—Ä—è–µ–º data.data?.pickup:', data.data?.pickup);\n01976|           console.log('–ü—Ä–æ–≤–µ—Ä—è–µ–º data.pickup:', data.pickup);\n01977|           console.log('–ü—Ä–æ–≤–µ—Ä—è–µ–º data?.pickup:', data?.pickup);\n01978|           console.log('–ü—Ä–æ–≤–µ—Ä—è–µ–º data.data?.arrivalToOspReceiver:', data.data?.arrivalToOspReceiver);\n01979|           console.log('–ü—Ä–æ–≤–µ—Ä—è–µ–º data.arrivalToOspReceiver:', data.arrivalToOspReceiver);\n01980|           console.log('–ü—Ä–æ–≤–µ—Ä—è–µ–º data?.arrivalToOspReceiver:', data?.arrivalToOspReceiver);\n01981|           \n01982|           // –ë–æ–ª–µ–µ —à–∏—Ä–æ–∫–∏–π –ø–æ–∏—Å–∫ –≤–æ –≤—Å–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ data\n01983|           const findDateInObject = (obj: any, fieldName: string): string | null => {\n01984|             if (!obj || typeof obj !== 'object') return null;\n01985|             \n01986|             for (const [key, value] of Object.entries(obj)) {\n01987|               if (key === fieldName && typeof value === 'string') {\n01988|                 return value;\n01989|               }\n01990|               if (typeof value === 'object' && value !== null) {\n01991|                 const found = findDateInObject(value, fieldName);\n01992|                 if (found) return found;\n01993|               }\n01994|             }\n01995|             return null;\n01996|           };\n01997|           \n01998|           const pickup = findDateInObject(data, 'pickup');\n01999|           const arrivalToOspReceiver = findDateInObject(data, 'arrivalToOspReceiver');\n02000|           \n02001|           console.log('–ù–ê–ô–î–ï–ù–ù–´–ï –î–ê–¢–´:');\n02002|           console.log('pickup:', pickup);\n02003|           console.log('arrivalToOspReceiver:', arrivalToOspReceiver);\n02004|           \n02005|           if (pickup && arrivalToOspReceiver) {\n02006|             // –ü–∞—Ä—Å–∏–º –¥–∞—Ç—ã (—Ñ–æ—Ä–º–∞—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å \"2025-09-27\" –∏–ª–∏ \"2025-09-27 10:00:00\")\n02007|             const pickupDate = new Date(pickup);\n02008|             const arrivalDate = new Date(arrivalToOspReceiver);\n02009|             \n02010|             console.log('–ü–∞—Ä—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –¥–∞—Ç–∞ pickup:', pickupDate);\n02011|             console.log('–ü–∞—Ä—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –¥–∞—Ç–∞ arrival:', arrivalDate);\n02012|             \n02013|             // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–∞—Ç—ã –≤–∞–ª–∏–¥–Ω—ã\n02014|             if (!isNaN(pickupDate.getTime()) && !isNaN(arrivalDate.getTime())) {\n02015|               // –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞–∑–Ω–æ—Å—Ç—å –≤ –¥–Ω—è—Ö\n02016|               const timeDiff = arrivalDate.getTime() - pickupDate.getTime();\n02017|               deliveryDays = Math.max(1, Math.ceil(timeDiff / (1000 * 3600 * 24))); // –ú–∏–Ω–∏–º—É–º 1 –¥–µ–Ω—å\n02018|               \n02019|               console.log('–†–∞–∑–Ω–æ—Å—Ç—å –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö:', timeDiff);\n02020|               console.log('–î–µ–ª–æ–≤—ã–µ –õ–∏–Ω–∏–∏ - –í–´–ß–ò–°–õ–ï–ù —Å—Ä–æ–∫ –¥–æ—Å—Ç–∞–≤–∫–∏:', deliveryDays, '–¥–Ω–µ–π');\n02021|             } else {\n02022|               console.error('–î–µ–ª–æ–≤—ã–µ –õ–∏–Ω–∏–∏ - –ù–µ–≤–∞–ª–∏–¥–Ω—ã–µ –¥–∞—Ç—ã –ø–æ—Å–ª–µ –ø–∞—Ä—Å–∏–Ω–≥–∞');\n02023|               console.error('pickup Date object:', pickupDate);\n02024|               console.error('arrival Date object:', arrivalDate);\n02025|             }\n02026|           } else {\n02027|             console.warn('–î–µ–ª–æ–≤—ã–µ –õ–∏–Ω–∏–∏ - –ù–µ –Ω–∞–π–¥–µ–Ω—ã –¥–∞—Ç—ã pickup –∏–ª–∏ arrivalToOspReceiver');\n02028|             console.log('pickup –Ω–∞–π–¥–µ–Ω:', !!pickup, pickup);\n02029|             console.log('arrivalToOspReceiver –Ω–∞–π–¥–µ–Ω:', !!arrivalToOspReceiver, arrivalToOspReceiver);\n02030|           }\n02031|         } catch (error) {\n02032|           console.error('–î–µ–ª–æ–≤—ã–µ –õ–∏–Ω–∏–∏ - –û—à–∏–±–∫–∞ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è —Å—Ä–æ–∫–∞ –¥–æ—Å—Ç–∞–≤–∫–∏:', error);\n02033|         }\n02034| \n02035|         console.log('üí∞ –§–ò–ù–ê–õ–¨–ù–ê–Ø –ò–¢–û–ì–û–í–ê–Ø –°–¢–û–ò–ú–û–°–¢–¨:', Math.round(totalPrice));\n02036|         \n02037|         return {\n02038|           company: '–î–µ–ª–æ–≤—ã–µ –õ–∏–Ω–∏–∏',\n02039|           price: Math.round(totalPrice),\n02040|           days: deliveryDays || 0,\n02041|           details: data.data || {},\n02042|           requestData,\n02043|           responseData: data,\n02044|           apiUrl,\n02045|           sessionId: sessionID\n02046|         };\n02047|       } else {\n02048|         const errorMessage = data.metadata?.detail || \n02049|                            data.metadata?.message || \n02050|                            data.errors?.[0]?.detail || \n02051|                            (data.metadata?.status !== 200 ? `HTTP ${data.metadata?.status}` : '') ||\n02052|                            '–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ –î–µ–ª–æ–≤—ã–µ –õ–∏–Ω–∏–∏';\n02053|         return {\n02054|           company: '–î–µ–ª–æ–≤—ã–µ –õ–∏–Ω–∏–∏',\n02055|           price: 0,\n02056|           days: 0,\n02057|           error: errorMessage,\n02058|           requestData,\n02059|           responseData: data,\n02060|           apiUrl,\n02061|           sessionId: sessionID\n02062|         };\n02063|       }\n02064|     } catch (error: any) {\n02065|       return {\n02066|         company: '–î–µ–ª–æ–≤—ã–µ –õ–∏–Ω–∏–∏',\n02067|         price: 0,\n02068|         days: 0,\n02069|         error: `–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ${error.message}`,\n02070|         requestData: null,\n02071|         responseData: null,\n02072|         apiUrl\n02073|       };\n02074|     }\n02075|   };\n02076| \n02077| \n02078| \n02079|   // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–Ω–æ–π –∑–æ–Ω—ã –∏ —Å–∫–ª–∞–¥–∞ –ü–≠–ö –ø–æ –∞–¥—Ä–µ—Å—É —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏\n02080|   const getPekZoneByAddress = async (address: string) => {\n02081|     try {\n02082|       console.log(`üîç –ü–≠–ö: –ø–æ–∏—Å–∫ –∑–æ–Ω—ã –¥–ª—è –∞–¥—Ä–µ—Å–∞ \"${address}\"`);\n02083|       \n02084|       const response = await fetch('/api/pek', {\n02085|         method: 'POST',\n02086|         headers: {\n02087|           'Content-Type': 'application/json',\n02088|         },\n02089|         body: JSON.stringify({\n02090|           method: 'findzonebyaddress',\n02091|           address: address\n02092|         })\n02093|       });\n02094| \n02095|       console.log(`üì° –ü–≠–ö API —Å—Ç–∞—Ç—É—Å: ${response.status} ${response.statusText}`);\n02096|       \n02097|       if (!response.ok) {\n02098|         let errorData;\n02099|         try {\n02100|           errorData = await response.json();\n02101|         } catch {\n02102|           errorData = { error: '–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø–∞—Ä—Å–∏—Ç—å –æ—Ç–≤–µ—Ç' };\n02103|         }\n02104|         \n02105|         console.error(`‚ùå –ü–≠–ö API –æ—à–∏–±–∫–∞ ${response.status}:`, errorData);\n02106|         \n02107|         // –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –æ—à–∏–±–æ–∫\n02108|         if (response.status === 401) {\n02109|           console.error('‚ùå –ü–≠–ö: –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ - –Ω–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω');\n02110|         } else if (response.status === 404) {\n02111|           console.error('‚ùå –ü–≠–ö: –ú–µ—Ç–æ–¥ API –Ω–µ –Ω–∞–π–¥–µ–Ω');\n02112|         } else if (response.status === 400) {\n02113|           console.error('‚ùå –ü–≠–ö: –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞');\n02114|         } else if (response.status >= 500) {\n02115|           console.error('‚ùå –ü–≠–ö: –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –ü–≠–ö');\n02116|         }\n02117|         \n02118|         console.log(`üîÑ –ü–≠–ö: –ø–µ—Ä–µ—Ö–æ–¥ –∫ —Ñ–æ–ª–ª–±—ç–∫ –º–µ—Ç–æ–¥—É –¥–ª—è \"${address}\"`);\n02119|         return getPekZoneFallback(address);\n02120|       }\n02121| \n02122|       const data = await response.json();\n02123|       console.log(`‚úÖ –ü–≠–ö –∑–æ–Ω–∞ –Ω–∞–π–¥–µ–Ω–∞:`, data);\n02124|       \n02125|       if (data.zoneId && data.mainWarehouseId) {\n02126|         return {\n02127|           zoneId: data.zoneId,\n02128|           zoneName: data.zoneName,\n02129|           branchUID: data.branchUID,\n02130|           branchCode: data.branchCode,\n02131|           branchTitle: data.branchTitle,\n02132|           mainWarehouseId: data.mainWarehouseId,\n02133|           warehousePoint: data.warehousePoint,\n02134|           geoData: data.GeoData,\n02135|           precision: data.GeoData?.precision\n02136|         };\n02137|       }\n02138|       \n02139|       console.warn(`‚ö†Ô∏è –ü–≠–ö: –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç:`, data);\n02140|       return getPekZoneFallback(address);\n02141|       \n02142|     } catch (error) {\n02143|       console.error('‚ùå –ü–≠–ö: –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –∑–æ–Ω—ã:', error);\n02144|       return getPekZoneFallback(address);\n02145|     }\n02146|   };\n02147| \n02148|   // –§–æ–ª–ª–±—ç–∫ –º–µ—Ç–æ–¥ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∑–æ–Ω—ã –ü–≠–ö\n02149|   const getPekZoneFallback = (address: string) => {\n02150|     console.log(`üîÑ –ü–≠–ö —Ñ–æ–ª–ª–±—ç–∫: –∞–Ω–∞–ª–∏–∑ –∞–¥—Ä–µ—Å–∞ \"${address}\"`);\n02151|     \n02152|     const addressLower = address.toLowerCase();\n02153|     \n02154|     // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –≥–æ—Ä–æ–¥–∞ –∏ –∏—Ö –¥–∞–Ω–Ω—ã–µ\n02155|     const cityMappings: { [key: string]: any } = {\n02156|       '–º–æ—Å–∫–≤–∞': {\n02157|         zoneId: 'moscow-zone-001',\n02158|         zoneName: '–ú–æ—Å–∫–≤–∞',\n02159|         branchUID: 'moscow-branch-001',\n02160|         branchCode: '–ú–°–ö',\n02161|         branchTitle: '–ú–æ—Å–∫–≤–∞',\n02162|         mainWarehouseId: 'dc6c746d-812d-11e4-bbfc-001999d8b3c5',\n02163|         warehousePoint: {\n02164|           latitude: 55.755826,\n02165|           longitude: 37.6173\n02166|         }\n02167|       },\n02168|       '—Å–∞–Ω–∫—Ç-–ø–µ—Ç–µ—Ä–±—É—Ä–≥': {\n02169|         zoneId: 'spb-zone-001',\n02170|         zoneName: '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥',\n02171|         branchUID: 'spb-branch-001',\n02172|         branchCode: '–°–ü–ë',\n02173|         branchTitle: '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥',\n02174|         mainWarehouseId: 'b436c978-086d-11e6-b6ca-00155d668909',\n02175|         warehousePoint: {\n02176|           latitude: 59.9311,\n02177|           longitude: 30.3609\n02178|         }\n02179|       },\n02180|       '–µ–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥': {\n02181|         zoneId: 'ekb-zone-001',\n02182|         zoneName: '–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥',\n02183|         branchUID: 'ekb-branch-001',\n02184|         branchCode: '–ï–ö–ë',\n02185|         branchTitle: '–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥',\n02186|         mainWarehouseId: 'f8d9c8e3-8e2d-11e4-bbfc-001999d8b3c5',\n02187|         warehousePoint: {\n02188|           latitude: 56.8431,\n02189|           longitude: 60.6454\n02190|         }\n02191|       }\n02192|     };\n02193|     \n02194|     for (const [city, data] of Object.entries(cityMappings)) {\n02195|       if (addressLower.includes(city) || addressLower.includes(city.replace('-', ' '))) {\n02196|         console.log(`‚úÖ –ü–≠–ö —Ñ–æ–ª–ª–±—ç–∫: –Ω–∞–π–¥–µ–Ω –≥–æ—Ä–æ–¥ ${city}`);\n02197|         return {\n02198|           ...data,\n02199|           geoData: {\n02200|             precision: 'fallback',\n02201|             kind: 'locality'\n02202|           },\n02203|           precision: 'fallback'\n02204|         };\n02205|       }\n02206|     }\n02207|     \n02208|     console.warn(`‚ùå –ü–≠–ö —Ñ–æ–ª–ª–±—ç–∫: –≥–æ—Ä–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ \"${address}\"`);\n02209|     return null;\n02210|   };\n02211| \n02212|   // –ü–æ–ª—É—á–µ–Ω–∏–µ –±–ª–∏–∂–∞–π—à–∏—Ö –æ—Ç–¥–µ–ª–µ–Ω–∏–π –ü–≠–ö\n02213|   const getPekNearestDepartments = async (address: string, coordinates?: { latitude: string, longitude: string }) => {\n02214|     try {\n02215|       console.log(`üè¢ –ü–≠–ö: –ø–æ–∏—Å–∫ –±–ª–∏–∂–∞–π—à–∏—Ö –æ—Ç–¥–µ–ª–µ–Ω–∏–π –¥–ª—è \"${address}\"`);\n02216|       \n02217|       const requestBody: any = {\n02218|         departmentOperation: 3, // –≤—ã–¥–∞—á–∞ –≥—Ä—É–∑–æ–≤\n02219|         type: 3, // –∞–≤—Ç–æ-—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç\n02220|         searchRadius: 50, // –∫–º\n02221|         limit: 5\n02222|       };\n02223|       \n02224|       // –ü–≠–ö API —Ç—Ä–µ–±—É–µ—Ç –∏ –∞–¥—Ä–µ—Å, –∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ\n02225|       requestBody.address = address;\n02226|       \n02227|       if (coordinates) {\n02228|         requestBody.coordinates = coordinates;\n02229|         console.log(`üìç –ü–≠–ö: –ø–æ–∏—Å–∫ –ø–æ –∞–¥—Ä–µ—Å—É \"${address}\" –∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º`, coordinates);\n02230|       } else {\n02231|         console.log(`üìç –ü–≠–ö: –ø–æ–∏—Å–∫ —Ç–æ–ª—å–∫–æ –ø–æ –∞–¥—Ä–µ—Å—É \"${address}\"`);\n02232|       }\n02233|       \n02234|       const response = await fetch('/api/pek', {\n02235|         method: 'POST',\n02236|         headers: {\n02237|           'Content-Type': 'application/json',\n02238|         },\n02239|         body: JSON.stringify({\n02240|           method: 'nearestdepartments',\n02241|           ...requestBody\n02242|         })\n02243|       });\n02244| \n02245|       console.log(`üì° –ü–≠–ö –æ—Ç–¥–µ–ª–µ–Ω–∏—è API —Å—Ç–∞—Ç—É—Å: ${response.status}`);\n02246|       \n02247|       if (!response.ok) {\n02248|         const errorText = await response.text();\n02249|         console.error(`‚ùå –ü–≠–ö –æ—Ç–¥–µ–ª–µ–Ω–∏—è API –æ—à–∏–±–∫–∞: ${response.status} ${response.statusText}`);\n02250|         console.error(`‚ùå –û—Ç–≤–µ—Ç:`, errorText.substring(0, 500));\n02251|         return null;\n02252|       }\n02253| \n02254|       const data = await response.json();\n02255|       console.log(`‚úÖ –ü–≠–ö –æ—Ç–¥–µ–ª–µ–Ω–∏—è –Ω–∞–π–¥–µ–Ω—ã:`, data);\n02256|       \n02257|       // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–µ—Ä–≤–æ–µ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–µ –æ—Ç–¥–µ–ª–µ–Ω–∏–µ —Å –Ω–∞–∏–≤—ã—Å—à–∏–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º\n02258|       if (data.freeDepartments && data.freeDepartments.length > 0) {\n02259|         const bestDepartment = data.freeDepartments.sort((a: any, b: any) => b.priority - a.priority)[0];\n02260|         console.log(`‚úÖ –ü–≠–ö: –≤—ã–±—Ä–∞–Ω–æ –æ—Ç–¥–µ–ª–µ–Ω–∏–µ`, bestDepartment.divisionName);\n02261|         return {\n02262|           warehouseId: bestDepartment.warehouseId,\n02263|           branchId: bestDepartment.branchId,\n02264|           branchName: bestDepartment.branchName,\n02265|           divisionName: bestDepartment.divisionName,\n02266|           address: bestDepartment.address,\n02267|           coordinates: bestDepartment.coordinates,\n02268|           phone: bestDepartment.phone,\n02269|           email: bestDepartment.email\n02270|         };\n02271|       }\n02272|       \n02273|       console.warn(`‚ùå –ü–≠–ö: –æ—Ç–¥–µ–ª–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –¥–ª—è \"${address}\"`);\n02274|       return null;\n02275|     } catch (error) {\n02276|       console.error('‚ùå –ü–≠–ö: –æ—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –æ—Ç–¥–µ–ª–µ–Ω–∏–π:', error);\n02277|       return null;\n02278|     }\n02279|   };\n02280| \n02281|   // –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç —á–µ—Ä–µ–∑ –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç—ã (—Ä–µ–∑–µ—Ä–≤–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è –ü–≠–ö)\n02282|   const getYandexCoordinates = async (address: string): Promise<{ latitude: string, longitude: string } | null> => {\n02283|     try {\n02284|       const encodedAddress = encodeURIComponent(address);\n02285|       const response = await fetch(`https://geocode-maps.yandex.ru/1.x/?apikey=YOUR_API_KEY&geocode=${encodedAddress}&format=json`);\n02286|       \n02287|       if (!response.ok) return null;\n02288|       \n02289|       const data = await response.json();\n02290|       const coords = data?.response?.GeoObjectCollection?.featureMember?.[0]?.GeoObject?.Point?.pos?.split(' ');\n02291|       \n02292|       if (coords && coords.length === 2) {\n02293|         return {\n02294|           longitude: coords[0],\n02295|           latitude: coords[1]\n02296|         };\n02297|       }\n02298|       \n02299|       return null;\n02300|     } catch (error) {\n02301|       console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –Ø–Ω–¥–µ–∫—Å:', error);\n02302|       return null;\n02303|     }\n02304|   };\n02305| \n02306|   // –†–∞—Å—á–µ—Ç –¥–ª—è –ü–≠–ö —á–µ—Ä–µ–∑ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π API v1/calculateprice/\n02307|   const calculatePEK = async (): Promise<CalculationResult> => {\n02308|     const apiUrl = 'https://kabinet.pecom.ru/api/v1/calculateprice/';\n02309|     \n02310|     // –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç\n02311|     const validateCoordinates = (coords: any) => {\n02312|       console.log('üß™ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç:', coords);\n02313|       \n02314|       if (!coords) {\n02315|         console.log('‚ö†Ô∏è –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç');\n02316|         return null;\n02317|       }\n02318|       \n02319|       if (typeof coords.latitude !== 'number' || typeof coords.longitude !== 'number') {\n02320|         console.warn(`‚ö†Ô∏è –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –Ω–µ —è–≤–ª—è—é—Ç—Å—è —á–∏—Å–ª–∞–º–∏:`, { \n02321|           lat: coords.latitude, \n02322|           lng: coords.longitude,\n02323|           latType: typeof coords.latitude,\n02324|           lngType: typeof coords.longitude\n02325|         });\n02326|         return null;\n02327|       }\n02328|       \n02329|       const lat = Number(coords.latitude);\n02330|       const lng = Number(coords.longitude);\n02331|       \n02332|       console.log(`üìç –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: lat=${lat}, lng=${lng}`);\n02333|       \n02334|       // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω—ã\n02335|       if (lat < -90 || lat > 90 || lng < -180 || lng > 180 || isNaN(lat) || isNaN(lng)) {\n02336|         console.warn(`‚ö†Ô∏è –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤–Ω–µ –¥–æ–ø—É—Å—Ç–∏–º–æ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞:`, { \n02337|           lat, lng, \n02338|           latValid: lat >= -90 && lat <= 90,\n02339|           lngValid: lng >= -180 && lng <= 180,\n02340|           latIsNaN: isNaN(lat),\n02341|           lngIsNaN: isNaN(lng)\n02342|         });\n02343|         return null;\n02344|       }\n02345|       \n02346|       console.log('‚úÖ –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤–∞–ª–∏–¥–Ω—ã:', { latitude: lat, longitude: lng });\n02347|       return { latitude: lat, longitude: lng };\n02348|     };\n02349|     \n02350|     try {\n02351|       // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–æ–Ω–∞—Ö –∏ —Å–∫–ª–∞–¥–∞—Ö –ø–æ –∞–¥—Ä–µ—Å–∞–º\n02352|       console.log(`üöÄ –ü–≠–ö: –Ω–∞—á–∏–Ω–∞–µ–º —Ä–∞—Å—á–µ—Ç`);\n02353|       console.log(`üìç –û—Ç: ${form.fromAddress || form.fromCity}`);\n02354|       console.log(`üìç –î–æ: ${form.toAddress || form.toCity}`);\n02355|       \n02356|       const senderZone = await getPekZoneByAddress(form.fromAddress || `–≥ ${form.fromCity}`);\n02357|       const receiverZone = await getPekZoneByAddress(form.toAddress || `–≥ ${form.toCity}`);\n02358|       \n02359|       console.log(`üîç –ü–≠–ö –∑–æ–Ω—ã:`);\n02360|       console.log(`üìç –û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å:`, senderZone ? `${senderZone.branchTitle} (${senderZone.mainWarehouseId})` : '–ù–ï –ù–ê–ô–î–ï–ù–ê');\n02361|       console.log(`üìç –ü–æ–ª—É—á–∞—Ç–µ–ª—å:`, receiverZone ? `${receiverZone.branchTitle} (${receiverZone.mainWarehouseId})` : '–ù–ï –ù–ê–ô–î–ï–ù–ê');\n02362|       \n02363|       if (!senderZone || !receiverZone) {\n02364|         // –î–µ—Ç–∞–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞\n02365|         const debugInfo = {\n02366|           senderAddress: form.fromAddress || form.fromCity,\n02367|           receiverAddress: form.toAddress || form.toCity,\n02368|           senderZoneFound: !!senderZone,\n02369|           receiverZoneFound: !!receiverZone,\n02370|           apiTested: true\n02371|         };\n02372|         \n02373|         console.error(`‚ùå –ü–≠–ö: –∑–æ–Ω—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã`, debugInfo);\n02374|         \n02375|         return {\n02376|           company: '–ü–≠–ö',\n02377|           price: 0,\n02378|           days: 0,\n02379|           error: `–ó–æ–Ω–∞ –ü–≠–ö –Ω–µ –æ–±—Å–ª—É–∂–∏–≤–∞–µ—Ç—Å—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∞–¥—Ä–µ—Å–∞: ${!senderZone ? (form.fromAddress || form.fromCity) : ''} ${!receiverZone ? (form.toAddress || form.toCity) : ''}`.trim(),\n02380|           apiUrl,\n02381|           requestData: debugInfo,\n02382|           responseData: { senderZone, receiverZone }\n02383|         };\n02384|       }\n02385| \n02386|       // –ü–æ–ª—É—á–∞–µ–º –±–ª–∏–∂–∞–π—à–∏–µ –æ—Ç–¥–µ–ª–µ–Ω–∏—è –µ—Å–ª–∏ –Ω—É–∂–Ω–∞ –∞–¥—Ä–µ—Å–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞\n02387|       let senderWarehouseId = senderZone.mainWarehouseId;\n02388|       let receiverWarehouseId = receiverZone.mainWarehouseId;\n02389|       \n02390|       if (form.fromAddressDelivery && senderZone.warehousePoint) {\n02391|         const validSenderCoords = validateCoordinates(senderZone.warehousePoint);\n02392|         if (validSenderCoords) {\n02393|           try {\n02394|             const senderDepartment = await getPekNearestDepartments(\n02395|               form.fromAddress || form.fromCity,\n02396|               {\n02397|                 latitude: validSenderCoords.latitude.toString(),\n02398|                 longitude: validSenderCoords.longitude.toString()\n02399|               }\n02400|             );\n02401|             if (senderDepartment) {\n02402|               senderWarehouseId = senderDepartment.warehouseId;\n02403|               console.log('‚úÖ –ù–∞–π–¥–µ–Ω –±–ª–∏–∂–∞–π—à–∏–π —Å–∫–ª–∞–¥ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è:', senderDepartment.warehouseId);\n02404|             }\n02405|           } catch (error) {\n02406|             console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –±–ª–∏–∂–∞–π—à–∏—Ö –æ—Ç–¥–µ–ª–µ–Ω–∏–π –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è, –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π —Å–∫–ª–∞–¥:', error);\n02407|           }\n02408|         } else {\n02409|           console.warn('‚ö†Ô∏è –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è, –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π —Å–∫–ª–∞–¥');\n02410|         }\n02411|       }\n02412|       \n02413|       if (form.toAddressDelivery && receiverZone.warehousePoint) {\n02414|         const validReceiverCoords = validateCoordinates(receiverZone.warehousePoint);\n02415|         if (validReceiverCoords) {\n02416|           try {\n02417|             const receiverDepartment = await getPekNearestDepartments(\n02418|               form.toAddress || form.toCity,\n02419|               {\n02420|                 latitude: validReceiverCoords.latitude.toString(),\n02421|                 longitude: validReceiverCoords.longitude.toString()\n02422|               }\n02423|             );\n02424|             if (receiverDepartment) {\n02425|               receiverWarehouseId = receiverDepartment.warehouseId;\n02426|               console.log('‚úÖ –ù–∞–π–¥–µ–Ω –±–ª–∏–∂–∞–π—à–∏–π —Å–∫–ª–∞–¥ –ø–æ–ª—É—á–∞—Ç–µ–ª—è:', receiverDepartment.warehouseId);\n02427|             }\n02428|           } catch (error) {\n02429|             console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –±–ª–∏–∂–∞–π—à–∏—Ö –æ—Ç–¥–µ–ª–µ–Ω–∏–π –ø–æ–ª—É—á–∞—Ç–µ–ª—è, –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π —Å–∫–ª–∞–¥:', error);\n02430|           }\n02431|         } else {\n02432|           console.warn('‚ö†Ô∏è –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–æ–ª—É—á–∞—Ç–µ–ª—è, –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π —Å–∫–ª–∞–¥');\n02433|         }\n02434|       }\n02435| \n02436|       // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞—Ç—ã N –¥–Ω–µ–π –æ—Ç —Å–µ–≥–æ–¥–Ω—è\n02437|       const getDateForCalculation = (daysFromToday: number): string => {\n02438|         const date = new Date();\n02439|         date.setDate(date.getDate() + daysFromToday);\n02440|         return date.toISOString().slice(0, 19); // 2025-09-28T14:00:00\n02441|       };\n02442| \n02443|       // –ù–∞—á–∏–Ω–∞–µ–º —Å –∑–∞–≤—Ç—Ä–∞—à–Ω–µ–≥–æ –¥–Ω—è\n02444|       let currentDayOffset = 1;\n02445|       let plannedDateTime = getDateForCalculation(currentDayOffset);\n02446| \n02447|       // –§–æ—Ä–º–∏—Ä—É–µ–º –º–∞—Å—Å–∏–≤ –≥—Ä—É–∑–æ–≤ (–±–µ–∑ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç)\n02448|       const cargos = form.cargos.map(cargo => {\n02449|         const cargoData = {\n02450|           length: cargo.length / 100, // –ø–µ—Ä–µ–≤–æ–¥–∏–º —Å–º –≤ –º–µ—Ç—Ä—ã\n02451|           width: cargo.width / 100,\n02452|           height: cargo.height / 100,\n02453|           volume: (cargo.length * cargo.width * cargo.height) / 1000000, // –º3\n02454|           weight: cargo.weight,\n02455|           isHP: form.needPackaging, // –∑–∞—â–∏—Ç–Ω–∞—è —É–ø–∞–∫–æ–≤–∫–∞\n02456|           sealingPositionsCount: 0\n02457|         };\n02458|         \n02459|         console.log('üì¶ –ì—Ä—É–∑ –¥–ª—è –ü–≠–ö:', cargoData);\n02460|         return cargoData;\n02461|       });\n02462| \n02463|       // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ (–Ω—É–∂–Ω–∞ –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ)\n02464|       let finalRequestData: any = null;\n02465|       \n02466|       // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ø—ã—Ç–∫–∏ —Ä–∞—Å—á–µ—Ç–∞ —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –¥–∞—Ç–æ–π\n02467|       const tryCalculateWithDate = async (plannedDateTime: string): Promise<any> => {\n02468|         // –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –∫ API –ü–≠–ö —Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏\n02469|         const requestData: any = {\n02470|           currencyCode: \"643\", // —Ä—É–±–ª–∏\n02471|           types: [3], // —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ –ø–µ—Ä–µ–≤–æ–∑–∫–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –º–∞—Å—Å–∏–≤)\n02472|           senderWarehouseId,\n02473|           receiverWarehouseId,\n02474|           isOpenCarSender: false,\n02475|           isOpenCarReceiver: false,\n02476|           isHyperMarket: false,\n02477|           plannedDateTime,\n02478|           isInsurance: form.needInsurance && form.declaredValue > 0,\n02479|           isInsurancePrice: form.needInsurance ? form.declaredValue : 0,\n02480|           isPickUp: form.fromAddressDelivery,\n02481|           isDelivery: form.toAddressDelivery,\n02482|           needReturnDocuments: false,\n02483|           needArrangeTransportationDocuments: false,\n02484|           senderDistanceType: 0,\n02485|           receiverDistanceType: 0,\n02486|           cargos // –º–∞—Å—Å–∏–≤ –≥—Ä—É–∑–æ–≤\n02487|         };\n02488|         \n02489|         console.log('üìã –ü–≠–ö: —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ requestData:', JSON.stringify(requestData, null, 2));\n02490| \n02491|         // –î–æ–±–∞–≤–ª—è–µ–º —É—Å–ª—É–≥–∏ –ü–†–† –µ—Å–ª–∏ –Ω—É–∂–Ω–æ\n02492|         if (form.needCarry) {\n02493|           requestData.pickupServices = {\n02494|             isLoading: true,\n02495|             floor: Math.max(0, form.floor - 1), // –ü–≠–ö —Å—á–∏—Ç–∞–µ—Ç —Å 0\n02496|             carryingDistance: 0,\n02497|             isElevator: form.hasFreightLift\n02498|           };\n02499|           requestData.deliveryServices = {\n02500|             isLoading: true,\n02501|             floor: Math.max(0, form.floor - 1),\n02502|             carryingDistance: 0,\n02503|             isElevator: form.hasFreightLift\n02504|           };\n02505|         }\n02506| \n02507|         // –î–æ–±–∞–≤–ª—è–µ–º –±–ª–æ–∫–∏ pickup/delivery —Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –ü–≠–ö\n02508|         if (form.fromAddressDelivery) {\n02509|           console.log('üìç –ü–≠–ö: –¥–æ–±–∞–≤–ª—è–µ–º –±–ª–æ–∫ pickup –¥–ª—è –∑–∞–±–æ—Ä–∞');\n02510|           requestData.pickup = {\n02511|             address: form.fromAddress || `–†–æ—Å—Å–∏—è, ${form.fromCity}`\n02512|             // coordinates –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∂–µ –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏\n02513|           };\n02514|         }\n02515|         \n02516|         if (form.toAddressDelivery) {\n02517|           console.log('üìç –ü–≠–ö: –¥–æ–±–∞–≤–ª—è–µ–º –±–ª–æ–∫ delivery –¥–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏');\n02518|           requestData.delivery = {\n02519|             address: form.toAddress || `–†–æ—Å—Å–∏—è, ${form.toCity}`\n02520|             // coordinates –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∂–µ –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏\n02521|           };\n02522|         }\n02523| \n02524|         // –í–∞–ª–∏–¥–∞—Ü–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π —Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏\n02525|         const requiredFields = ['types', 'senderWarehouseId', 'receiverWarehouseId', 'plannedDateTime', 'cargos'];\n02526|         const missingFields = requiredFields.filter(field => !requestData[field]);\n02527|         \n02528|         if (missingFields.length > 0) {\n02529|           throw new Error(`–ü–≠–ö: –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: ${missingFields.join(', ')}`);\n02530|         }\n02531|         \n02532|         if (!Array.isArray(requestData.types) || requestData.types.length === 0) {\n02533|           throw new Error('–ü–≠–ö: –ø–æ–ª–µ types –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–µ–ø—É—Å—Ç—ã–º –º–∞—Å—Å–∏–≤–æ–º');\n02534|         }\n02535|         \n02536|         if (!Array.isArray(requestData.cargos) || requestData.cargos.length === 0) {\n02537|           throw new Error('–ü–≠–ö: –ø–æ–ª–µ cargos –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–µ–ø—É—Å—Ç—ã–º –º–∞—Å—Å–∏–≤–æ–º');\n02538|         }\n02539|         \n02540|         console.log('‚úÖ –ü–≠–ö: –≤–∞–ª–∏–¥–∞—Ü–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π –ø—Ä–æ–π–¥–µ–Ω–∞');\n02541| \n02542|         // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏ –≤–∏–¥–∏–º–æ—Å—Ç–∏ —Ñ—É–Ω–∫—Ü–∏–∏\n02543|         finalRequestData = {\n02544|           method: 'calculateprice',\n02545|           ...requestData\n02546|         };\n02547|         \n02548|         console.log('üöÄ –ü–≠–ö API –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å:', JSON.stringify(finalRequestData, null, 2));\n02549|         console.log('üåê –ü–≠–ö API URL:', apiUrl);\n02550|         console.log('üìã –ü–≠–ö: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–∏–ø–æ–≤ —Ç–∞—Ä–∏—Ñ–æ–≤:', requestData.types.length);\n02551|         console.log('üìã –ü–≠–ö: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥—Ä—É–∑–æ–≤:', requestData.cargos.length);\n02552|       \n02553|       // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π\n02554|       if (finalRequestData.pickup?.coordinates) {\n02555|         console.log('üìç –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã pickup:', finalRequestData.pickup.coordinates);\n02556|       }\n02557|       if (finalRequestData.delivery?.coordinates) {\n02558|         console.log('üìç –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã delivery:', finalRequestData.delivery.coordinates);\n02559|       }\n02560| \n02561|       const response = await fetch('/api/pek', {\n02562|         method: 'POST',\n02563|         headers: {\n02564|           'Content-Type': 'application/json',\n02565|         },\n02566|         body: JSON.stringify(finalRequestData)\n02567|       });\n02568| \n02569|       console.log(`üì° –ü–≠–ö API —Ä–∞—Å—á–µ—Ç —Å—Ç–∞—Ç—É—Å: ${response.status} ${response.statusText}`);\n02570|       console.log(`üì° –ü–≠–ö API URL: ${response.url}`);\n02571|       \n02572|       const responseText = await response.text();\n02573|       console.log(`üì° –ü–≠–ö API —Å—ã—Ä–æ–π –æ—Ç–≤–µ—Ç:`, responseText.substring(0, 1000));\n02574|       \n02575|       let data;\n02576|       try {\n02577|         data = JSON.parse(responseText);\n02578|         console.log('üöÄ –ü–≠–ö API –æ—Ç–≤–µ—Ç:', JSON.stringify(data, null, 2));\n02579|       } catch (parseError) {\n02580|         console.error('‚ùå –ü–≠–ö: –æ—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON:', parseError);\n02581|         throw new Error(`–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç API: ${responseText.substring(0, 200)}`);\n02582|       }\n02583| \n02584|         return { response, data };\n02585|       };\n02586| \n02587|       // –î–æ–±–∞–≤–ª—è–µ–º –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —Ä–∞—Å—á–µ—Ç–∞\n02588|       console.log('üîß –ü–≠–ö: –≥–æ—Ç–æ–≤–∏–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞...');\n02589|       console.log('üìç senderWarehouseId:', senderWarehouseId);\n02590|       console.log('üìç receiverWarehouseId:', receiverWarehouseId);\n02591|       console.log('üìÖ –ù–∞—á–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞:', plannedDateTime);\n02592|       console.log('üì¶ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥—Ä—É–∑–æ–≤:', cargos.length);\n02593|       console.log('üîß form.fromAddressDelivery:', form.fromAddressDelivery);\n02594|       console.log('üîß form.toAddressDelivery:', form.toAddressDelivery);\n02595|       \n02596|       // –¶–∏–∫–ª –ø–æ–ø—ã—Ç–æ–∫ —Å —Ä–∞–∑–Ω—ã–º–∏ –¥–∞—Ç–∞–º–∏ (–º–∞–∫—Å–∏–º—É–º 7 –¥–Ω–µ–π)\n02597|       const maxRetries = 7;\n02598|       let lastError: Error | null = null;\n02599|       \n02600|       console.log('üöÄ –ü–≠–ö: –∑–∞–ø—É—Å–∫–∞–µ–º —Ü–∏–∫–ª —Ä–∞—Å—á–µ—Ç–∞...');\n02601|       \n02602|       for (let attempt = 0; attempt < maxRetries; attempt++) {\n02603|         try {\n02604|           console.log(`üìÖ –ü–≠–ö: –ø–æ–ø—ã—Ç–∫–∞ ${attempt + 1}/${maxRetries}, –¥–∞—Ç–∞: ${plannedDateTime}`);\n02605|           \n02606|           const { response, data } = await tryCalculateWithDate(plannedDateTime);\n02607|           \n02608|           if (response.ok && !data.hasError && data.transfers && data.transfers.length > 0) {\n02609|             const transfer = data.transfers[0]; // –±–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π —Ç–∞—Ä–∏—Ñ (–∞–≤—Ç–æ)\n02610|             \n02611|             if (!transfer.hasError) {\n02612|           // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É —É—Å–ª—É–≥\n02613|           const services: { name: string; description: string; price: number }[] = [];\n02614|           let totalCalculated = 0;\n02615| \n02616|           const processServices = (servicesList: any[], parentName = '') => {\n02617|             servicesList.forEach(service => {\n02618|               const serviceName = parentName ? `${parentName} - ${service.info}` : service.info;\n02619|               const serviceCost = parseFloat(service.cost) || 0;\n02620|               \n02621|               if (serviceCost > 0) {\n02622|                 services.push({\n02623|                   name: serviceName,\n02624|                   description: service.serviceType || '',\n02625|                   price: serviceCost\n02626|                 });\n02627|                 totalCalculated += serviceCost;\n02628|               }\n02629| \n02630|               // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤–ª–æ–∂–µ–Ω–Ω—ã–µ —É—Å–ª—É–≥–∏\n02631|               if (service.services && Array.isArray(service.services)) {\n02632|                 processServices(service.services, serviceName);\n02633|               }\n02634|             });\n02635|           };\n02636| \n02637|           if (transfer.services) {\n02638|             processServices(transfer.services);\n02639|           }\n02640| \n02641|           // –ï—Å–ª–∏ –Ω–µ—Ç –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ —É—Å–ª—É–≥, –¥–æ–±–∞–≤–ª—è–µ–º –æ–±—â—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å\n02642|           if (services.length === 0) {\n02643|             services.push({\n02644|               name: '–î–æ—Å—Ç–∞–≤–∫–∞ –≥—Ä—É–∑–∞',\n02645|               description: `${senderZone.branchTitle} - ${receiverZone.branchTitle}`,\n02646|               price: Math.round(transfer.costTotal)\n02647|             });\n02648|           }\n02649| \n02650|           return {\n02651|             company: '–ü–≠–ö',\n02652|             price: Math.round(transfer.costTotal),\n02653|             days: transfer.estDeliveryTime || 3,\n02654|             details: {\n02655|               note: `–î–æ—Å—Ç–∞–≤–∫–∞ ${senderZone.branchTitle} - ${receiverZone.branchTitle} (–∞–≤—Ç–æ)`,\n02656|               services,\n02657|               senderZone: {\n02658|                 title: senderZone.branchTitle,\n02659|                 zone: senderZone.zoneName,\n02660|                 warehouseId: senderWarehouseId\n02661|               },\n02662|               receiverZone: {\n02663|                 title: receiverZone.branchTitle,\n02664|                 zone: receiverZone.zoneName,\n02665|                 warehouseId: receiverWarehouseId\n02666|               }\n02667|             },\n02668|             requestData: finalRequestData,\n02669|             responseData: data,\n02670|             apiUrl\n02671|               };\n02672|             } else {\n02673|               // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –æ—à–∏–±–∫–∞ –ø—Ä–æ–±–ª–µ–º–æ–π —Å –¥–∞—Ç–æ–π\n02674|               const errorMessage = transfer.errorMessage || '–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ —Ç–∞—Ä–∏—Ñ–∞ –ü–≠–ö';\n02675|               if (errorMessage.includes('–∑–∞–±–æ—Ä –≥—Ä—É–∑–∞ –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω') || errorMessage.includes('–≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–∞—Ç—ã')) {\n02676|                 console.log(`üìÖ –ü–≠–ö: ${errorMessage}. –ü—Ä–æ–±—É–µ–º —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å...`);\n02677|                 lastError = new Error(errorMessage);\n02678|                 // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –¥–Ω—é\n02679|                 currentDayOffset++;\n02680|                 plannedDateTime = getDateForCalculation(currentDayOffset);\n02681|                 continue; // –ü—Ä–æ–±—É–µ–º —Å–ª–µ–¥—É—é—â—É—é –¥–∞—Ç—É\n02682|               } else {\n02683|                 throw new Error(errorMessage);\n02684|               }\n02685|             }\n02686|           } else {\n02687|             // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—à–∏–±–∫—É –Ω–∞ —É—Ä–æ–≤–Ω–µ –¥–∞–Ω–Ω—ã—Ö\n02688|             const errorMessage = data.errorMessage || data.message || '–û—à–∏–±–∫–∞ API –ü–≠–ö';\n02689|             if (errorMessage.includes('–∑–∞–±–æ—Ä –≥—Ä—É–∑–∞ –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω') || errorMessage.includes('–≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–∞—Ç—ã')) {\n02690|               console.log(`üìÖ –ü–≠–ö: ${errorMessage}. –ü—Ä–æ–±—É–µ–º —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å...`);\n02691|               lastError = new Error(errorMessage);\n02692|               // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –¥–Ω—é\n02693|               currentDayOffset++;\n02694|               plannedDateTime = getDateForCalculation(currentDayOffset);\n02695|               continue; // –ü—Ä–æ–±—É–µ–º —Å–ª–µ–¥—É—é—â—É—é –¥–∞—Ç—É\n02696|             } else {\n02697|               throw new Error(errorMessage);\n02698|             }\n02699|           }\n02700|         } catch (error: any) {\n02701|           console.error(`‚ùå –ü–≠–ö: –æ—à–∏–±–∫–∞ –Ω–∞ –ø–æ–ø—ã—Ç–∫–µ ${attempt + 1}:`, error.message);\n02702|           \n02703|           // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –æ—à–∏–±–∫–∞ –ø—Ä–æ–±–ª–µ–º–æ–π —Å –¥–∞—Ç–æ–π\n02704|           if (error.message?.includes('–∑–∞–±–æ—Ä –≥—Ä—É–∑–∞ –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω') || error.message?.includes('–≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–∞—Ç—ã')) {\n02705|             console.log(`üìÖ –ü–≠–ö: –ø—Ä–æ–±–ª–µ–º–∞ —Å –¥–∞—Ç–æ–π. –ü—Ä–æ–±—É–µ–º —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å...`);\n02706|             lastError = error;\n02707|             // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –¥–Ω—é\n02708|             currentDayOffset++;\n02709|             plannedDateTime = getDateForCalculation(currentDayOffset);\n02710|             continue; // –ü—Ä–æ–±—É–µ–º —Å–ª–µ–¥—É—é—â—É—é –¥–∞—Ç—É\n02711|           } else {\n02712|             // –î—Ä—É–≥–∞—è –æ—à–∏–±–∫–∞ - –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ä–∞–∑—É\n02713|             throw error;\n02714|           }\n02715|         }\n02716|       }\n02717|       \n02718|       // –ï—Å–ª–∏ –¥–æ—à–ª–∏ –¥–æ —Å—é–¥–∞ - –≤—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –∏—Å—á–µ—Ä–ø–∞–Ω—ã\n02719|       console.error(`‚ùå –ü–≠–ö: –≤—Å–µ ${maxRetries} –ø–æ–ø—ã—Ç–æ–∫ –∏—Å—á–µ—Ä–ø–∞–Ω—ã. –ü–æ—Å–ª–µ–¥–Ω—è—è –æ—à–∏–±–∫–∞:`, lastError?.message);\n02720|       throw lastError || new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –¥–æ—Å—Ç—É–ø–Ω—É—é –¥–∞—Ç—É –¥–ª—è –∑–∞–±–æ—Ä–∞ –≥—Ä—É–∑–∞');\n02721|       \n02722|     } catch (error: any) {\n02723|       console.error('üö® –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ü–≠–ö API:', error);\n02724|       \n02725|       // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –æ—à–∏–±–∫–∏\n02726|       let errorDescription = '–û—à–∏–±–∫–∞ API –ü–≠–ö';\n02727|       \n02728|       if (error.message?.includes('Failed to fetch')) {\n02729|         errorDescription = 'API –ü–≠–ö –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω';\n02730|       } else if (error.message?.includes('401')) {\n02731|         errorDescription = '–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ü–≠–ö';\n02732|       } else if (error.message?.includes('400')) {\n02733|         errorDescription = '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞';\n02734|       } else if (error.message?.includes('timeout')) {\n02735|         errorDescription = '–¢–∞–π–º-–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞ –∫ API';\n02736|       }\n02737|       \n02738|       console.error(`üö® –ü–≠–ö: ${errorDescription}. –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Ñ–æ–ª–ª–±—ç–∫ —Ä–∞—Å—á–µ—Ç—É`);\n02739|       \n02740|       const totalWeight = form.cargos.reduce((sum, cargo) => sum + cargo.weight, 0);\n02741|       const totalVolume = form.cargos.reduce((sum, cargo) => \n02742|         sum + (cargo.length * cargo.width * cargo.height) / 1000000, 0\n02743|       );\n02744|       \n02745|       // –ë–æ–ª–µ–µ —Ç–æ—á–Ω—ã–π —Ñ–æ–ª–ª–±—ç–∫ —Ä–∞—Å—á–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–µ—Å–∞ –∏ –æ–±—ä–µ–º–∞\n02746|       let basePrice = Math.max(\n02747|         totalWeight * 18, // 18 —Ä—É–± –∑–∞ –∫–≥\n02748|         totalVolume * 4500 // 4500 —Ä—É–± –∑–∞ –º3\n02749|       );\n02750|       \n02751|       // –î–æ–±–∞–≤–ª—è–µ–º —É—Å–ª—É–≥–∏\n02752|       const services: { name: string; description: string; price: number }[] = [];\n02753|       \n02754|       services.push({\n02755|         name: '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞',\n02756|         description: `${form.fromCity} - ${form.toCity} (${totalWeight} –∫–≥, ${totalVolume.toFixed(3)} –º¬≥)`,\n02757|         price: Math.round(basePrice)\n02758|       });\n02759|       \n02760|       if (form.fromAddressDelivery) {\n02761|         const pickupCost = 600;\n02762|         basePrice += pickupCost;\n02763|         services.push({\n02764|           name: '–ó–∞–±–æ—Ä –≥—Ä—É–∑–∞',\n02765|           description: '–û—Ç –∞–¥—Ä–µ—Å–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è',\n02766|           price: pickupCost\n02767|         });\n02768|       }\n02769|       \n02770|       if (form.toAddressDelivery) {\n02771|         const deliveryCost = 600;\n02772|         basePrice += deliveryCost;\n02773|         services.push({\n02774|           name: '–î–æ—Å—Ç–∞–≤–∫–∞ –≥—Ä—É–∑–∞',\n02775|           description: '–î–æ –∞–¥—Ä–µ—Å–∞ –ø–æ–ª—É—á–∞—Ç–µ–ª—è',\n02776|           price: deliveryCost\n02777|         });\n02778|       }\n02779|       \n02780|       if (form.needInsurance && form.declaredValue > 0) {\n02781|         const insuranceCost = form.declaredValue * 0.012;\n02782|         basePrice += insuranceCost;\n02783|         services.push({\n02784|           name: '–°—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ',\n02785|           description: `–ù–∞ —Å—É–º–º—É ${form.declaredValue.toLocaleString()} ‚ÇΩ`,\n02786|           price: Math.round(insuranceCost)\n02787|         });\n02788|       }\n02789|       \n02790|       if (form.needPackaging) {\n02791|         const packagingCost = totalWeight * 25;\n02792|         basePrice += packagingCost;\n02793|         services.push({\n02794|           name: '–ó–∞—â–∏—Ç–Ω–∞—è —É–ø–∞–∫–æ–≤–∫–∞',\n02795|           description: '–£–ø–∞–∫–æ–≤–∫–∞ –≥—Ä—É–∑–∞',\n02796|           price: Math.round(packagingCost)\n02797|         });\n02798|       }\n02799|       \n02800|       if (form.needCarry) {\n\n(File has more lines. Use 'offset' parameter to read beyond line 2800)\n</file>",
    "metadata": {
      "preview": "  // üîß –§—É–Ω–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏ –ø—É—Å—Ç—ã—Ö –≥—Ä—É–∑–æ–≤\n  const cleanEmptyCargos = (cargos: Cargo[], selectedProducts: ProductInForm[]) => {\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–π –≥—Ä—É–∑\n    const hasFilledCargos = cargos.some(cargo => !isEmptyCargo(cargo));\n    \n    if (!hasFilledCargos) {\n      // –ï—Å–ª–∏ –Ω–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –≥—Ä—É–∑–æ–≤, –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–π –ø—É—Å—Ç–æ–π\n      return {\n        cargos: cargos.length > 0 ? [{ id: '1', length: 0, width: 0, height: 0, weight: 0 }] : [{ id: '1', length: 0, width: 0, height: 0, weight: 0 }],\n        products: selectedProducts\n      };\n    }\n\n    // –°–æ–∑–¥–∞–µ–º –º–∞–ø–ø–∏–Ω–≥ —Å—Ç–∞—Ä—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤ –∫ –Ω–æ–≤—ã–º\n    const oldToNewIndexMap = new globalThis.Map<number, number>();\n    let newIndex = 0;\n    \n    cargos.forEach((cargo, oldIndex) => {\n      if (!isEmptyCargo(cargo)) {\n        oldToNewIndexMap.set(oldIndex, newIndex);"
    },
    "title": "app/page.tsx",
    "time": {
      "start": 1760452152828,
      "end": 1760452152832
    }
  }
}