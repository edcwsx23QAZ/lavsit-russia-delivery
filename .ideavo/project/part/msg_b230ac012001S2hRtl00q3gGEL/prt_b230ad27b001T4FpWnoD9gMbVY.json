{
  "id": "prt_b230ad27b001T4FpWnoD9gMbVY",
  "sessionID": "ses_4dcf54091ffe1XHg1W7jdm1ovr",
  "messageID": "msg_b230ac012001S2hRtl00q3gGEL",
  "type": "tool",
  "callID": "toolu_01EeVZCxAshJeN41yLeAYmwb",
  "tool": "read",
  "state": {
    "status": "completed",
    "input": {
      "filePath": "/home/user/project/app/api/dellin-packages/route.ts"
    },
    "output": "<file>\n00001| import { NextRequest, NextResponse } from 'next/server'\n00002| import { apiRequestWithTimeout, validateApiInput, validationRules, PerformanceMonitor } from '@/lib/api-utils'\n00003| \n00004| // –ö—ç—à –¥–ª—è CSV –¥–∞–Ω–Ω—ã—Ö —É–ø–∞–∫–æ–≤–æ–∫ (24 —á–∞—Å–∞)\n00005| interface PackageCache {\n00006|   data: any[];\n00007|   timestamp: number;\n00008|   ttl: number;\n00009| }\n00010| \n00011| let packageCache: PackageCache | null = null;\n00012| const CACHE_TTL = 24 * 60 * 60 * 1000; // 24 —á–∞—Å–∞\n00013| \n00014| // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ CSV\n00015| function parseCSV(csvText: string): any[] {\n00016|   const lines = csvText.trim().split('\\n');\n00017|   if (lines.length < 2) return [];\n00018|   \n00019|   const headers = lines[0].split(',').map(h => h.trim().replace(/\"/g, ''));\n00020|   const result: any[] = [];\n00021|   \n00022|   for (let i = 1; i < lines.length; i++) {\n00023|     const values = lines[i].split(',').map(v => v.trim().replace(/\"/g, ''));\n00024|     const row: any = {};\n00025|     \n00026|     headers.forEach((header, index) => {\n00027|       row[header] = values[index] || '';\n00028|     });\n00029|     \n00030|     result.push(row);\n00031|   }\n00032|   \n00033|   return result;\n00034| }\n00035| \n00036| export async function GET() {\n00037|   const endTiming = PerformanceMonitor.startMeasurement('dellin_packages_get');\n00038|   \n00039|   try {\n00040|     // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à\n00041|     const now = Date.now();\n00042|     if (packageCache && (now - packageCache.timestamp) < packageCache.ttl) {\n00043|       console.log('üì¶ –í–æ–∑–≤—Ä–∞—â–∞–µ–º —É–ø–∞–∫–æ–≤–∫–∏ –∏–∑ –∫—ç—à–∞');\n00044|       const timing = endTiming();\n00045|       return NextResponse.json({\n00046|         success: true,\n00047|         data: packageCache.data,\n00048|         cached: true,\n00049|         timing\n00050|       }, {\n00051|         headers: {\n00052|           'Access-Control-Allow-Origin': '*',\n00053|           'Access-Control-Allow-Methods': 'GET, POST',\n00054|           'Access-Control-Allow-Headers': 'Content-Type',\n00055|         },\n00056|       });\n00057|     }\n00058| \n00059|     console.log('üì¶ –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ —É–ø–∞–∫–æ–≤–æ–∫ –ø–æ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –î–õ...');\n00060|     \n00061|     // –®–∞–≥ 1: –ü–æ–ª—É—á–∏—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ CSV —Ñ–∞–π–ª —Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏\n00062|     const servicesResponse = await apiRequestWithTimeout('https://api.dellin.ru/v1/public/request_services.json', {\n00063|       method: 'POST',\n00064|       headers: {\n00065|         'Content-Type': 'application/json',\n00066|       },\n00067|       body: JSON.stringify({\n00068|         appkey: process.env.DELLIN_APP_KEY || 'E6C50E91-8E93-440F-9CC6-DEF9F0D68F1B'\n00069|       })\n00070|     }, { timeout: 15000, retries: 2 });\n00071| \n00072|     if (!servicesResponse.ok) {\n00073|       console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Å—ã–ª–∫–∏ –Ω–∞ CSV:', servicesResponse.status, servicesResponse.statusText);\n00074|       endTiming();\n00075|       return NextResponse.json(\n00076|         { error: '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Å—ã–ª–∫–∏ –Ω–∞ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ —É–ø–∞–∫–æ–≤–æ–∫', status: servicesResponse.status },\n00077|         { status: servicesResponse.status }\n00078|       );\n00079|     }\n00080| \n00081|     const servicesData = await servicesResponse.json();\n00082|     console.log('üì¶ –û—Ç–≤–µ—Ç API services:', servicesData);\n00083| \n00084|     if (!servicesData.url) {\n00085|       console.error('‚ùå URL CSV —Ñ–∞–π–ª–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –æ—Ç–≤–µ—Ç–µ');\n00086|       endTiming();\n00087|       return NextResponse.json(\n00088|         { error: 'URL CSV —Ñ–∞–π–ª–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –æ—Ç–≤–µ—Ç–µ API' },\n00089|         { status: 500 }\n00090|       );\n00091|     }\n00092| \n00093|     // –®–∞–≥ 2: –°–∫–∞—á–∞—Ç—å CSV —Ñ–∞–π–ª\n00094|     console.log('üì¶ –°–∫–∞—á–∏–≤–∞–µ–º CSV —Ñ–∞–π–ª:', servicesData.url);\n00095|     const csvResponse = await apiRequestWithTimeout(servicesData.url, {\n00096|       method: 'GET',\n00097|       headers: {\n00098|         'Accept': 'text/csv,*/*',\n00099|       },\n00100|     }, { timeout: 30000, retries: 2 });\n00101| \n00102|     if (!csvResponse.ok) {\n00103|       console.error('‚ùå –û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è CSV —Ñ–∞–π–ª–∞:', csvResponse.status, csvResponse.statusText);\n00104|       endTiming();\n00105|       return NextResponse.json(\n00106|         { error: '–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è CSV —Ñ–∞–π–ª–∞', status: csvResponse.status },\n00107|         { status: csvResponse.status }\n00108|       );\n00109|     }\n00110| \n00111|     // –®–∞–≥ 3: –ü–∞—Ä—Å–∏—Ç—å CSV\n00112|     const csvText = await csvResponse.text();\n00113|     console.log('üì¶ CSV –ø–æ–ª—É—á–µ–Ω, —Ä–∞–∑–º–µ—Ä:', csvText.length, '—Å–∏–º–≤–æ–ª–æ–≤');\n00114|     \n00115|     const parsedData = parseCSV(csvText);\n00116|     console.log('üì¶ CSV —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω, –Ω–∞–π–¥–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π:', parsedData.length);\n00117| \n00118|     // –®–∞–≥ 4: –ö—ç—à–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç\n00119|     packageCache = {\n00120|       data: parsedData,\n00121|       timestamp: now,\n00122|       ttl: CACHE_TTL\n00123|     };\n00124| \n00125|     const timing = endTiming();\n00126|     return NextResponse.json({\n00127|       success: true,\n00128|       data: parsedData,\n00129|       cached: false,\n00130|       csvUrl: servicesData.url,\n00131|       recordsCount: parsedData.length,\n00132|       timing\n00133|     }, {\n00134|       headers: {\n00135|         'Access-Control-Allow-Origin': '*',\n00136|         'Access-Control-Allow-Methods': 'GET, POST',\n00137|         'Access-Control-Allow-Headers': 'Content-Type',\n00138|       },\n00139|     });\n00140| \n00141|   } catch (error) {\n00142|     endTiming();\n00143|     console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ —É–ø–∞–∫–æ–≤–æ–∫:', error);\n00144|     return NextResponse.json(\n00145|       { \n00146|         error: '–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ —É–ø–∞–∫–æ–≤–æ–∫',\n00147|         details: error instanceof Error ? error.message : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'\n00148|       },\n00149|       { status: 500 }\n00150|     );\n00151|   }\n00152| }\n00153| \n00154| export async function POST(request: NextRequest) {\n00155|   const endTiming = PerformanceMonitor.startMeasurement('dellin_api_total');\n00156|   \n00157|   try {\n00158|     const body = await request.json();\n00159|     console.log('üöõ Dellin API POST –∑–∞–ø—Ä–æ—Å:', JSON.stringify(body, null, 2));\n00160|     \n00161|     // Validate input\n00162|     if (body.method && typeof body.method !== 'string') {\n00163|       endTiming();\n00164|       return NextResponse.json({ \n00165|         error: 'Invalid method parameter',\n00166|         details: 'method must be a string'\n00167|       }, { status: 400 });\n00168|     }\n00169| \n00170|     // Handle test method\n00171|     if (body.method === 'test') {\n00172|       console.log('üß™ Dellin API —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å');\n00173|       const timing = endTiming();\n00174|       return NextResponse.json({ \n00175|         status: 'OK', \n00176|         service: '–î–µ–ª–æ–≤—ã–µ –õ–∏–Ω–∏–∏',\n00177|         message: 'API –î–µ–ª–æ–≤—ã—Ö –õ–∏–Ω–∏–π —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ',\n00178|         timestamp: new Date().toISOString(),\n00179|         features: [\n00180|           '–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ —É–ø–∞–∫–æ–≤–æ–∫',\n00181|           '–†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –¥–æ—Å—Ç–∞–≤–∫–∏',\n00182|           '–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–π'\n00183|         ],\n00184|         endpoints: {\n00185|           packages: '/api/dellin-packages (GET)',\n00186|           test: '/api/dellin-packages (POST)'\n00187|         },\n00188|         timing\n00189|       });\n00190|     }\n00191| \n00192|     // For other methods, use the GET endpoint (CSV workflow)\n00193|     try {\n00194|       // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ workflow —á—Ç–æ –∏ –≤ GET\n00195|       const getRequest = new NextRequest(new URL('/api/dellin-packages', request.url), { method: 'GET' });\n00196|       const getResponse = await GET();\n00197|       \n00198|       const timing = endTiming();\n00199|       \n00200|       // –ï—Å–ª–∏ GET —É—Å–ø–µ—à–µ–Ω, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –µ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π\n00201|       if (getResponse.status === 200) {\n00202|         const getData = await getResponse.json();\n00203|         return NextResponse.json({ \n00204|           success: true,\n00205|           data: getData.data,\n00206|           timing,\n00207|           requestMethod: body.method || 'csv_workflow',\n00208|           workflow: 'API –î–õ ‚Üí CSV —Å—Å—ã–ª–∫–∞ ‚Üí —Å–∫–∞—á–∞—Ç—å CSV ‚Üí –ø–∞—Ä—Å–∏—Ç—å ‚Üí –ø–æ–ª—É—á–∏—Ç—å UID'\n00209|         }, {\n00210|           headers: {\n00211|             'Access-Control-Allow-Origin': '*',\n00212|             'Access-Control-Allow-Methods': 'GET, POST',\n00213|             'Access-Control-Allow-Headers': 'Content-Type',\n00214|           },\n00215|         });\n00216|       } else {\n00217|         // –ï—Å–ª–∏ GET –Ω–µ —É–¥–∞–ª—Å—è, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –µ–≥–æ –æ—à–∏–±–∫—É\n00218|         const errorData = await getResponse.json();\n00219|         return NextResponse.json(errorData, { status: getResponse.status });\n00220|       }\n00221| \n00222|     } catch (fetchError) {\n00223|       console.error('‚ùå –û—à–∏–±–∫–∞ CSV workflow Dellin API:', fetchError);\n00224|       endTiming();\n00225|       return NextResponse.json({\n00226|         error: '–û—à–∏–±–∫–∞ CSV workflow –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ API –î–µ–ª–æ–≤—ã—Ö –õ–∏–Ω–∏–π',\n00227|         details: fetchError instanceof Error ? fetchError.message : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞',\n00228|         workflow: '–ü—Ä–æ–±–ª–µ–º–∞ –≤: API –î–õ ‚Üí CSV —Å—Å—ã–ª–∫–∞ ‚Üí —Å–∫–∞—á–∞—Ç—å CSV ‚Üí –ø–∞—Ä—Å–∏—Ç—å'\n00229|       }, { status: 503 });\n00230|     }\n00231| \n00232|   } catch (error) {\n00233|     endTiming();\n00234|     console.error('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ Dellin API:', error);\n00235|     \n00236|     return NextResponse.json({ \n00237|       error: '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞',\n00238|       details: error instanceof Error ? error.message : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞',\n00239|       type: error instanceof Error ? error.name : 'Unknown'\n00240|     }, { status: 500 });\n00241|   }\n00242| }\n00243| \n00244| export async function OPTIONS() {\n00245|   return new NextResponse(null, {\n00246|     status: 200,\n00247|     headers: {\n00248|       'Access-Control-Allow-Origin': '*',\n00249|       'Access-Control-Allow-Methods': 'GET',\n00250|       'Access-Control-Allow-Headers': 'Content-Type',\n00251|     },\n00252|   })\n00253| }\n\n(End of file - total 253 lines)\n</file>",
    "title": "app/api/dellin-packages/route.ts",
    "metadata": {
      "preview": "import { NextRequest, NextResponse } from 'next/server'\nimport { apiRequestWithTimeout, validateApiInput, validationRules, PerformanceMonitor } from '@/lib/api-utils'\n\n// –ö—ç—à –¥–ª—è CSV –¥–∞–Ω–Ω—ã—Ö —É–ø–∞–∫–æ–≤–æ–∫ (24 —á–∞—Å–∞)\ninterface PackageCache {\n  data: any[];\n  timestamp: number;\n  ttl: number;\n}\n\nlet packageCache: PackageCache | null = null;\nconst CACHE_TTL = 24 * 60 * 60 * 1000; // 24 —á–∞—Å–∞\n\n// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ CSV\nfunction parseCSV(csvText: string): any[] {\n  const lines = csvText.trim().split('\\n');\n  if (lines.length < 2) return [];\n  \n  const headers = lines[0].split(',').map(h => h.trim().replace(/\"/g, ''));\n  const result: any[] = [];"
    },
    "time": {
      "start": 1765819470769,
      "end": 1765819470782
    }
  }
}