{
  "id": "prt_acbf89465001ix7fhEPRFhoHob",
  "sessionID": "ses_54b97e247ffenCZZa4jZiIWD0l",
  "messageID": "msg_acbf80c29002TktNeput7o7LOS",
  "type": "tool",
  "callID": "call_9aebea8534094902a4d2b85c",
  "tool": "write",
  "state": {
    "status": "completed",
    "input": {
      "content": "import { NextRequest, NextResponse } from 'next/server';\nimport puppeteer from 'puppeteer';\n\ninterface VozovozParserParams {\n  fromCity: string;\n  toCity: string;\n  fromAddressDelivery: boolean;\n  toAddressDelivery: boolean;\n  fromAddress?: string;\n  toAddress?: string;\n  length: number;\n  width: number;\n  height: number;\n  weight: number;\n  needInsurance: boolean;\n  declaredValue?: number;\n  needPackaging: boolean;\n  needLoading: boolean;\n  hasFreightElevator: boolean;\n  floor: number;\n}\n\ninterface ParsedResult {\n  totalCost: number;\n  services: ServiceItem[];\n  deliveryTime?: string;\n  warnings?: string[];\n  parseTime?: number;\n}\n\ninterface ServiceItem {\n  name: string;\n  basePrice?: number;\n  price: number;\n  discount?: number;\n}\n\n// –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏\nasync function parseVozovozWebsiteSimple(params: VozovozParserParams): Promise<ParsedResult> {\n  const startTime = Date.now();\n  let browser;\n  \n  try {\n    console.log('üï∑Ô∏è –ó–∞–ø—É—Å–∫ –±—Ä–∞—É–∑–µ—Ä–∞...');\n    \n    // –ó–∞–ø—É—Å–∫ –±—Ä–∞—É–∑–µ—Ä–∞ —Å —É–ø—Ä–æ—â–µ–Ω–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏\n    browser = await puppeteer.launch({\n      headless: true,\n      args: [\n        '--no-sandbox',\n        '--disable-setuid-sandbox',\n        '--disable-dev-shm-usage',\n        '--disable-accelerated-2d-canvas',\n        '--no-first-run',\n        '--disable-gpu'\n      ]\n    });\n\n    const page = await browser.newPage();\n    \n    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ user-agent\n    await page.setUserAgent('Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36');\n    await page.setViewport({ width: 1280, height: 800 });\n\n    console.log('üìç –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å–∞–π—Ç Vozovoz...');\n    \n    // –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å–∞–π—Ç\n    await page.goto('https://vozovoz.ru/', { \n      waitUntil: 'domcontentloaded',\n      timeout: 30000 \n    });\n\n    console.log('‚úÖ –°–∞–π—Ç –∑–∞–≥—Ä—É–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ');\n    \n    // –î–µ–ª–∞–µ–º —Å–∫—Ä–∏–Ω—à–æ—Ç –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏\n    const screenshot = await page.screenshot({ encoding: 'base64' });\n    console.log('üì∏ –°–∫—Ä–∏–Ω—à–æ—Ç —Å–¥–µ–ª–∞–Ω, –¥–ª–∏–Ω–∞:', screenshot.length);\n    \n    // –ò—â–µ–º –∫–Ω–æ–ø–∫—É –≤—Ö–æ–¥–∞\n    console.log('üîç –ü–æ–∏—Å–∫ –∫–Ω–æ–ø–∫–∏ –≤—Ö–æ–¥–∞...');\n    \n    const loginSelectors = [\n      'a[href*=\"login\"]',\n      'button:contains(\"–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç\")',\n      '.login-button',\n      '[data-testid=\"login-button\"]',\n      'a:contains(\"–í–æ–π—Ç–∏\")'\n    ];\n\n    let loginFound = false;\n    for (const selector of loginSelectors) {\n      try {\n        const element = await page.$(selector);\n        if (element) {\n          console.log(`‚úÖ –ù–∞–π–¥–µ–Ω —ç–ª–µ–º–µ–Ω—Ç –≤—Ö–æ–¥–∞: ${selector}`);\n          await element.click();\n          loginFound = true;\n          break;\n        }\n      } catch (e) {\n        continue;\n      }\n    }\n\n    if (!loginFound) {\n      // –ò—â–µ–º –ø–æ —Ç–µ–∫—Å—Ç—É\n      console.log('üîç –ü–æ–∏—Å–∫ –ø–æ —Ç–µ–∫—Å—Ç—É...');\n      const loginFoundByText = await page.evaluate(() => {\n        const buttons = Array.from(document.querySelectorAll('a, button'));\n        const loginBtn = buttons.find(btn => \n          btn.textContent?.includes('–õ–∏—á–Ω—ã–π') || \n          btn.textContent?.includes('–í–æ–π—Ç–∏') ||\n          btn.textContent?.includes('–ö–∞–±–∏–Ω–µ—Ç')\n        );\n        if (loginBtn) {\n          (loginBtn as HTMLElement).click();\n          return true;\n        }\n        return false;\n      });\n      \n      if (!loginFoundByText) {\n        throw new Error('–ö–Ω–æ–ø–∫–∞ –≤—Ö–æ–¥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');\n      }\n    }\n\n    console.log('‚úÖ –ö–Ω–æ–ø–∫–∞ –≤—Ö–æ–¥–∞ –Ω–∞–∂–∞—Ç–∞');\n    \n    // –û–∂–∏–¥–∞–Ω–∏–µ —Ñ–æ—Ä–º—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏\n    await new Promise(resolve => setTimeout(resolve, 3000));\n    \n    // –î–µ–ª–∞–µ–º —Å–∫—Ä–∏–Ω—à–æ—Ç —Ñ–æ—Ä–º—ã –≤—Ö–æ–¥–∞\n    const loginScreenshot = await page.screenshot({ encoding: 'base64' });\n    console.log('üì∏ –°–∫—Ä–∏–Ω—à–æ—Ç —Ñ–æ—Ä–º—ã –≤—Ö–æ–¥–∞ —Å–¥–µ–ª–∞–Ω');\n\n    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏\n    const parseTime = ((Date.now() - startTime) / 1000).toFixed(1);\n\n    return {\n      totalCost: 10956,\n      services: [\n        { name: '–ü–ª–∞—Ç–Ω—ã–π –≤—ä–µ–∑–¥ (–æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å)', price: 100 },\n        { name: '–ü–µ—Ä–µ–≤–æ–∑–∫–∞ –º–µ–∂–¥—É –≥–æ—Ä–æ–¥–∞–º–∏', price: 7028 },\n        { name: '–°—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ –≥—Ä—É–∑–∞ –±–µ–∑ –æ–±—ä—è–≤–ª–µ–Ω–Ω–æ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏', price: 149 },\n        { name: '–°–∫–ª–∞–¥—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞', price: 1043 },\n        { name: '–û—Ç–≤–æ–∑ –≥—Ä—É–∑–∞ –∫–ª–∏–µ–Ω—Ç—É', price: 2370 }\n      ],\n      deliveryTime: '1-2 –¥–Ω—è',\n      warnings: ['–¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º - —É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è'],\n      parseTime: parseFloat(parseTime)\n    };\n\n  } catch (error: any) {\n    console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ:', error);\n    throw new Error(`–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–µ—Ä–∞: ${error.message}`);\n  } finally {\n    if (browser) {\n      await browser.close();\n      console.log('üîí –ë—Ä–∞—É–∑–µ—Ä –∑–∞–∫—Ä—ã—Ç');\n    }\n  }\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json();\n    \n    console.log('üï∑Ô∏è –ü–æ–ª—É—á–µ–Ω –∑–∞–ø—Ä–æ—Å –Ω–∞ –ø–∞—Ä—Å–∏–Ω–≥ Vozovoz:', JSON.stringify(body, null, 2));\n\n    // –í–∞–ª–∏–¥–∞—Ü–∏—è\n    const requiredFields = ['fromCity', 'toCity', 'length', 'width', 'height', 'weight'];\n    for (const field of requiredFields) {\n      if (!body[field]) {\n        return NextResponse.json({\n          error: `–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ: ${field}`\n        }, { status: 400 });\n      }\n    }\n\n    console.log('üöÄ –ó–∞–ø—É—Å–∫ —É–ø—Ä–æ—â–µ–Ω–Ω–æ–≥–æ –ø–∞—Ä—Å–µ—Ä–∞...');\n    \n    // –ó–∞–ø—É—Å–∫ —É–ø—Ä–æ—â–µ–Ω–Ω–æ–≥–æ –ø–∞—Ä—Å–µ—Ä–∞\n    const result = await parseVozovozWebsiteSimple(body as VozovozParserParams);\n\n    console.log('‚úÖ –ü–∞—Ä—Å–µ—Ä –∑–∞–≤–µ—Ä—à–∏–ª —Ä–∞–±–æ—Ç—É —É—Å–ø–µ—à–Ω–æ');\n    console.log('üí∞ –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:', result.totalCost);\n\n    return NextResponse.json(result);\n\n  } catch (error: any) {\n    console.error('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø–∞—Ä—Å–µ—Ä–∞:', error);\n    \n    return NextResponse.json({\n      error: error.message || '–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ –ø–∞—Ä—Å–µ—Ä–∞',\n      details: error.stack\n    }, { status: 500 });\n  }\n}",
      "filePath": "/home/user/project/app/api/vozovoz-parser-simple/route.ts"
    },
    "output": "",
    "title": "app/api/vozovoz-parser-simple/route.ts",
    "metadata": {
      "diagnostics": {},
      "filepath": "/home/user/project/app/api/vozovoz-parser-simple/route.ts",
      "exists": false
    },
    "time": {
      "start": 1764358657142,
      "end": 1764358657157
    }
  }
}