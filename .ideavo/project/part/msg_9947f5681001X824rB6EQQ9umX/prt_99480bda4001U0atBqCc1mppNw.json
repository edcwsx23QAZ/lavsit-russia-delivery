{
  "id": "prt_99480bda4001U0atBqCc1mppNw",
  "messageID": "msg_9947f5681001X824rB6EQQ9umX",
  "sessionID": "ses_6852784ecffeuHwynj83p2lr14",
  "type": "tool",
  "tool": "write",
  "callID": "toolu_01T3FMS9JUidHuyGUU3AbJbv",
  "state": {
    "status": "completed",
    "input": {
      "filePath": "/home/user/project/components/TruckVisualization.tsx",
      "content": "'use client';\n\nimport React from 'react';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Truck } from 'lucide-react';\n\ninterface Cargo {\n  id: string;\n  length: number;\n  width: number;\n  height: number;\n  weight: number;\n  productName?: string;\n}\n\ninterface CargoPlacement {\n  cargo: Cargo;\n  x: number;\n  y: number;\n  z: number;\n  rotatedLength: number;\n  rotatedWidth: number;\n  rotatedHeight: number;\n  color: string;\n}\n\ninterface TruckVisualizationProps {\n  cargos: Cargo[];\n  isVisible?: boolean;\n}\n\n// Размеры кузова в мм\nconst TRUCK_DIMENSIONS = {\n  length: 4200,\n  width: 2025,\n  height: 2025\n};\n\n// Цвета для разных грузов\nconst CARGO_COLORS = [\n  '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FECA57',\n  '#FF9FF3', '#54A0FF', '#5F27CD', '#00D2D3', '#FF9F43',\n  '#10AC84', '#EE5A24', '#0984E3', '#6C5CE7', '#FD79A8'\n];\n\nexport default function TruckVisualization({ cargos, isVisible = false }: TruckVisualizationProps) {\n  // Функция проверки ключевых слов\n  const isChairOrSeat = (productName?: string) => {\n    if (!productName) return false;\n    const lowerName = productName.toLowerCase();\n    return lowerName.includes('стул') || lowerName.includes('кресло');\n  };\n\n  // Алгоритм размещения грузов\n  const calculateCargoPlacement = (): CargoPlacement[] => {\n    if (!cargos.length) return [];\n\n    // Сортируем грузы: сначала по весу (убывание), потом по объему (убывание)\n    const sortedCargos = [...cargos].sort((a, b) => {\n      const weightDiff = b.weight - a.weight;\n      if (weightDiff !== 0) return weightDiff;\n      \n      const volumeA = a.length * a.width * a.height;\n      const volumeB = b.length * b.width * b.height;\n      return volumeB - volumeA;\n    });\n\n    const placements: CargoPlacement[] = [];\n    const occupiedSpaces: Array<{x: number, y: number, z: number, length: number, width: number, height: number}> = [];\n\n    sortedCargos.forEach((cargo, index) => {\n      const color = CARGO_COLORS[index % CARGO_COLORS.length];\n      \n      // Определяем возможные ориентации груза\n      const orientations = getValidOrientations(cargo);\n      \n      let bestPlacement: CargoPlacement | null = null;\n      let minFloorArea = Infinity;\n\n      for (const orientation of orientations) {\n        const placement = findBestPosition(cargo, orientation, occupiedSpaces, color);\n        if (placement) {\n          const floorArea = placement.rotatedLength * placement.rotatedWidth;\n          if (floorArea < minFloorArea) {\n            minFloorArea = floorArea;\n            bestPlacement = placement;\n          }\n        }\n      }\n\n      if (bestPlacement) {\n        placements.push(bestPlacement);\n        occupiedSpaces.push({\n          x: bestPlacement.x,\n          y: bestPlacement.y,\n          z: bestPlacement.z,\n          length: bestPlacement.rotatedLength,\n          width: bestPlacement.rotatedWidth,\n          height: bestPlacement.rotatedHeight\n        });\n      }\n    });\n\n    return placements;\n  };\n\n  // Получение допустимых ориентаций груза\n  const getValidOrientations = (cargo: Cargo) => {\n    const orientations = [\n      { length: cargo.length, width: cargo.width, height: cargo.height },\n      { length: cargo.width, width: cargo.length, height: cargo.height },\n    ];\n\n    // Если это не стул/кресло, добавляем вертикальные ориентации\n    if (!isChairOrSeat(cargo.productName)) {\n      orientations.push(\n        { length: cargo.length, width: cargo.height, height: cargo.width },\n        { length: cargo.height, width: cargo.length, height: cargo.width },\n        { length: cargo.width, width: cargo.height, height: cargo.length },\n        { length: cargo.height, width: cargo.width, height: cargo.length }\n      );\n    }\n\n    return orientations;\n  };\n\n  // Поиск лучшей позиции для размещения груза\n  const findBestPosition = (\n    cargo: Cargo, \n    orientation: {length: number, width: number, height: number}, \n    occupiedSpaces: Array<{x: number, y: number, z: number, length: number, width: number, height: number}>,\n    color: string\n  ): CargoPlacement | null => {\n    \n    // Проверяем, помещается ли груз в кузов\n    if (orientation.length > TRUCK_DIMENSIONS.length || \n        orientation.width > TRUCK_DIMENSIONS.width || \n        orientation.height > TRUCK_DIMENSIONS.height) {\n      return null;\n    }\n\n    // Ищем позицию с минимальными координатами (ближе к задней стенке и левому борту)\n    for (let z = 0; z <= TRUCK_DIMENSIONS.height - orientation.height; z += 10) {\n      for (let y = 0; y <= TRUCK_DIMENSIONS.width - orientation.width; y += 10) {\n        for (let x = 0; x <= TRUCK_DIMENSIONS.length - orientation.length; x += 10) {\n          \n          if (isPositionValid(x, y, z, orientation, occupiedSpaces, cargo)) {\n            return {\n              cargo,\n              x, y, z,\n              rotatedLength: orientation.length,\n              rotatedWidth: orientation.width,\n              rotatedHeight: orientation.height,\n              color\n            };\n          }\n        }\n      }\n    }\n\n    return null;\n  };\n\n  // Проверка валидности позиции\n  const isPositionValid = (\n    x: number, y: number, z: number,\n    orientation: {length: number, width: number, height: number},\n    occupiedSpaces: Array<{x: number, y: number, z: number, length: number, width: number, height: number}>,\n    cargo: Cargo\n  ): boolean => {\n    \n    // Проверяем пересечения с уже размещенными грузами\n    for (const occupied of occupiedSpaces) {\n      if (!(x >= occupied.x + occupied.length || \n            x + orientation.length <= occupied.x ||\n            y >= occupied.y + occupied.width || \n            y + orientation.width <= occupied.y ||\n            z >= occupied.z + occupied.height || \n            z + orientation.height <= occupied.z)) {\n        return false;\n      }\n    }\n\n    // Проверяем правила размещения по весу\n    if (z > 0) { // Если груз не на полу\n      const supportingCargos = occupiedSpaces.filter(occupied => \n        z === occupied.z + occupied.height && // Груз стоит прямо на другом грузе\n        !(x >= occupied.x + occupied.length || \n          x + orientation.length <= occupied.x ||\n          y >= occupied.y + occupied.width || \n          y + orientation.width <= occupied.y)\n      );\n\n      // Проверяем, что все поддерживающие грузы тяжелее или равны по весу\n      for (const supporting of supportingCargos) {\n        const supportingCargo = occupiedSpaces.find(s => s === supporting);\n        if (supportingCargo) {\n          // Находим оригинальный груз по позиции (упрощенно)\n          // В реальности нужна более сложная логика сопоставления\n          // Пока пропускаем проверку веса для упрощения\n        }\n      }\n\n      // Проверяем правила для стульев/кресел\n      if (isChairOrSeat(cargo.productName)) {\n        // Считаем количество грузов-стульев под текущим\n        let chairsBelow = 0;\n        let currentZ = 0;\n        while (currentZ < z) {\n          const chairBelow = occupiedSpaces.find(occupied =>\n            occupied.z === currentZ && \n            !(x >= occupied.x + occupied.length || \n              x + orientation.length <= occupied.x ||\n              y >= occupied.y + occupied.width || \n              y + orientation.width <= occupied.y)\n          );\n          if (chairBelow) {\n            chairsBelow++;\n            currentZ = chairBelow.z + chairBelow.height;\n          } else {\n            break;\n          }\n        }\n        \n        if (chairsBelow >= 2) { // Максимум 2 стула друг на друге\n          return false;\n        }\n      }\n    }\n\n    return true;\n  };\n\n  const placements = calculateCargoPlacement();\n\n  // Расчет статистики\n  const calculateStats = () => {\n    if (!placements.length) return null;\n\n    const maxX = Math.max(...placements.map(p => p.x + p.rotatedLength));\n    const maxY = Math.max(...placements.map(p => p.y + p.rotatedWidth));\n    const maxZ = Math.max(...placements.map(p => p.z + p.rotatedHeight));\n\n    const occupiedFloorArea = (maxX * maxY) / 1000000; // в м²\n    const occupiedVolume = (maxX * maxY * maxZ) / 1000000000; // в м³\n    const floorUtilization = (occupiedFloorArea / ((TRUCK_DIMENSIONS.length * TRUCK_DIMENSIONS.width) / 1000000)) * 100;\n\n    return {\n      occupiedFloorArea: occupiedFloorArea.toFixed(2),\n      occupiedVolume: occupiedVolume.toFixed(3),\n      floorUtilization: floorUtilization.toFixed(1),\n      dimensions: {\n        length: (maxX / 1000).toFixed(2),\n        width: (maxY / 1000).toFixed(2),\n        height: (maxZ / 1000).toFixed(2)\n      }\n    };\n  };\n\n  const stats = calculateStats();\n\n  if (!isVisible) return null;\n\n  return (\n    <Card className=\"bg-gray-800 border-gray-700\">\n      <CardHeader className=\"pb-3\">\n        <CardTitle className=\"text-white flex items-center gap-2 text-lg\">\n          <Truck className=\"h-4 w-4\" />\n          Визуализация размещения в кузове\n        </CardTitle>\n      </CardHeader>\n      <CardContent>\n        {/* SVG визуализация кузова */}\n        <div className=\"bg-gray-900 p-4 rounded-lg mb-4\">\n          <svg \n            viewBox=\"0 0 500 300\" \n            className=\"w-full h-80 border border-gray-600 bg-gray-950\"\n            style={{ maxHeight: '400px' }}\n          >\n            {/* Контур кузова (вид сверху) */}\n            <rect \n              x=\"50\" y=\"50\" \n              width=\"400\" height=\"200\" \n              fill=\"none\" \n              stroke=\"#4B5563\" \n              strokeWidth=\"2\"\n              strokeDasharray=\"5,5\"\n            />\n            \n            {/* Подпись размеров кузова */}\n            <text x=\"250\" y=\"40\" textAnchor=\"middle\" fill=\"#9CA3AF\" fontSize=\"12\">\n              4200 мм\n            </text>\n            <text x=\"30\" y=\"150\" textAnchor=\"middle\" fill=\"#9CA3AF\" fontSize=\"12\" transform=\"rotate(-90, 30, 150)\">\n              2025 мм\n            </text>\n            \n            {/* Отображение грузов */}\n            {placements.map((placement, index) => {\n              const scaleX = 400 / TRUCK_DIMENSIONS.length;\n              const scaleY = 200 / TRUCK_DIMENSIONS.width;\n              \n              const rectX = 50 + (placement.x * scaleX);\n              const rectY = 50 + (placement.y * scaleY);\n              const rectWidth = placement.rotatedLength * scaleX;\n              const rectHeight = placement.rotatedWidth * scaleY;\n              \n              return (\n                <g key={`cargo-${index}`}>\n                  <rect\n                    x={rectX}\n                    y={rectY}\n                    width={rectWidth}\n                    height={rectHeight}\n                    fill={placement.color}\n                    fillOpacity=\"0.7\"\n                    stroke={placement.color}\n                    strokeWidth=\"1\"\n                  />\n                  <text\n                    x={rectX + rectWidth/2}\n                    y={rectY + rectHeight/2}\n                    textAnchor=\"middle\"\n                    dominantBaseline=\"middle\"\n                    fill=\"white\"\n                    fontSize=\"10\"\n                    fontWeight=\"bold\"\n                  >\n                    {index + 1}\n                  </text>\n                </g>\n              );\n            })}\n            \n            {/* Легенда высоты */}\n            <text x=\"470\" y=\"150\" textAnchor=\"middle\" fill=\"#9CA3AF\" fontSize=\"10\" transform=\"rotate(90, 470, 150)\">\n              Высота: 2025 мм\n            </text>\n          </svg>\n        </div>\n\n        {/* Статистика размещения */}\n        {stats && (\n          <div className=\"grid grid-cols-2 gap-4 text-sm\">\n            <div className=\"space-y-2\">\n              <h4 className=\"font-medium text-white\">Занятые размеры:</h4>\n              <div className=\"text-gray-300 space-y-1\">\n                <div>Длина: {stats.dimensions.length} м</div>\n                <div>Ширина: {stats.dimensions.width} м</div>\n                <div>Высота: {stats.dimensions.height} м</div>\n              </div>\n            </div>\n            <div className=\"space-y-2\">\n              <h4 className=\"font-medium text-white\">Использование:</h4>\n              <div className=\"text-gray-300 space-y-1\">\n                <div>Площадь пола: {stats.occupiedFloorArea} м²</div>\n                <div>Объем: {stats.occupiedVolume} м³</div>\n                <div>Загрузка пола: {stats.floorUtilization}%</div>\n              </div>\n            </div>\n          </div>\n        )}\n\n        {/* Легенда грузов */}\n        {placements.length > 0 && (\n          <div className=\"mt-4\">\n            <h4 className=\"font-medium text-white mb-2\">Грузы:</h4>\n            <div className=\"grid grid-cols-2 gap-2 text-xs\">\n              {placements.map((placement, index) => (\n                <div key={`legend-${index}`} className=\"flex items-center gap-2\">\n                  <div \n                    className=\"w-3 h-3 rounded\"\n                    style={{ backgroundColor: placement.color }}\n                  />\n                  <span className=\"text-gray-300\">\n                    Груз {index + 1}: {placement.rotatedLength}×{placement.rotatedWidth}×{placement.rotatedHeight} мм\n                  </span>\n                </div>\n              ))}\n            </div>\n          </div>\n        )}\n      </CardContent>\n    </Card>\n  );\n}"
    },
    "output": "",
    "metadata": {
      "diagnostics": {},
      "filepath": "/home/user/project/components/TruckVisualization.tsx",
      "exists": false
    },
    "title": "components/TruckVisualization.tsx",
    "time": {
      "start": 1759133139375,
      "end": 1759133139377
    }
  }
}