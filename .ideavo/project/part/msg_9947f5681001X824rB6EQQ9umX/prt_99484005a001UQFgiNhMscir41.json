{
  "id": "prt_99484005a001UQFgiNhMscir41",
  "messageID": "msg_9947f5681001X824rB6EQQ9umX",
  "sessionID": "ses_6852784ecffeuHwynj83p2lr14",
  "type": "tool",
  "tool": "edit",
  "callID": "toolu_01F5Y1j3po89BKYKS6RgBbba",
  "state": {
    "status": "completed",
    "input": {
      "filePath": "/home/user/project/components/TruckVisualization.tsx",
      "oldString": "  // Проверка валидности позиции\n  const isPositionValid = (\n    x: number, y: number, z: number,\n    orientation: {length: number, width: number, height: number},\n    occupiedSpaces: Array<{x: number, y: number, z: number, length: number, width: number, height: number}>,\n    cargo: Cargo\n  ): boolean => {\n    \n    // Проверяем пересечения с уже размещенными грузами\n    for (const occupied of occupiedSpaces) {\n      if (!(x >= occupied.x + occupied.length || \n            x + orientation.length <= occupied.x ||\n            y >= occupied.y + occupied.width || \n            y + orientation.width <= occupied.y ||\n            z >= occupied.z + occupied.height || \n            z + orientation.height <= occupied.z)) {\n        return false;\n      }\n    }\n\n    // Проверяем правила размещения по весу\n    if (z > 0) { // Если груз не на полу\n      const supportingCargos = occupiedSpaces.filter(occupied => \n        z === occupied.z + occupied.height && // Груз стоит прямо на другом грузе\n        !(x >= occupied.x + occupied.length || \n          x + orientation.length <= occupied.x ||\n          y >= occupied.y + occupied.width || \n          y + orientation.width <= occupied.y)\n      );\n\n      // Проверяем, что все поддерживающие грузы тяжелее или равны по весу\n      for (const supporting of supportingCargos) {\n        const supportingCargo = occupiedSpaces.find(s => s === supporting);\n        if (supportingCargo) {\n          // Находим оригинальный груз по позиции (упрощенно)\n          // В реальности нужна более сложная логика сопоставления\n          // Пока пропускаем проверку веса для упрощения\n        }\n      }\n\n      // Проверяем правила для стульев/кресел\n      if (isChairOrSeat(cargo.productName)) {\n        // Считаем количество грузов-стульев под текущим\n        let chairsBelow = 0;\n        let currentZ = 0;\n        while (currentZ < z) {\n          const chairBelow = occupiedSpaces.find(occupied =>\n            occupied.z === currentZ && \n            !(x >= occupied.x + occupied.length || \n              x + orientation.length <= occupied.x ||\n              y >= occupied.y + occupied.width || \n              y + orientation.width <= occupied.y)\n          );\n          if (chairBelow) {\n            chairsBelow++;\n            currentZ = chairBelow.z + chairBelow.height;\n          } else {\n            break;\n          }\n        }\n        \n        if (chairsBelow >= 2) { // Максимум 2 стула друг на друге\n          return false;\n        }\n      }\n    }\n\n    return true;\n  };",
      "newString": "  // Проверка валидности позиции\n  const isPositionValid = (\n    x: number, y: number, z: number,\n    orientation: {length: number, width: number, height: number},\n    occupiedSpaces: Array<{\n      x: number, y: number, z: number, \n      length: number, width: number, height: number,\n      cargoId: string, weight: number, productName?: string\n    }>,\n    cargo: Cargo\n  ): boolean => {\n    \n    // Проверяем пересечения с уже размещенными грузами\n    for (const occupied of occupiedSpaces) {\n      if (!(x >= occupied.x + occupied.length || \n            x + orientation.length <= occupied.x ||\n            y >= occupied.y + occupied.width || \n            y + orientation.width <= occupied.y ||\n            z >= occupied.z + occupied.height || \n            z + orientation.height <= occupied.z)) {\n        return false;\n      }\n    }\n\n    // Проверяем правила размещения по весу и для стульев/кресел\n    if (z > 0) { // Если груз не на полу\n      const supportingCargos = occupiedSpaces.filter(occupied => \n        z === occupied.z + occupied.height && // Груз стоит прямо на другом грузе\n        !(x >= occupied.x + occupied.length || \n          x + orientation.length <= occupied.x ||\n          y >= occupied.y + occupied.width || \n          y + orientation.width <= occupied.y)\n      );\n\n      if (supportingCargos.length === 0) {\n        return false; // Груз должен на чем-то стоять\n      }\n\n      // Проверяем правило по весу: тяжелый груз нельзя ставить на легкий\n      for (const supporting of supportingCargos) {\n        if (cargo.weight > supporting.weight) {\n          return false;\n        }\n      }\n\n      // Проверяем правила для стульев/кресел\n      if (isChairOrSeat(cargo.productName)) {\n        // На стулья/кресла можно ставить только другие стулья/кресла\n        const allSupportingAreChairs = supportingCargos.every(supporting => \n          isChairOrSeat(supporting.productName)\n        );\n        \n        if (!allSupportingAreChairs) {\n          return false;\n        }\n\n        // Считаем количество стульев/кресел под текущим (максимум 2 друг на друге)\n        let chairLevels = 1; // Текущий уровень\n        let currentZ = z;\n        \n        while (currentZ > 0) {\n          const supportingChairs = occupiedSpaces.filter(occupied =>\n            occupied.z + occupied.height === currentZ &&\n            isChairOrSeat(occupied.productName) &&\n            !(x >= occupied.x + occupied.length || \n              x + orientation.length <= occupied.x ||\n              y >= occupied.y + occupied.width || \n              y + orientation.width <= occupied.y)\n          );\n          \n          if (supportingChairs.length > 0) {\n            chairLevels++;\n            currentZ = Math.min(...supportingChairs.map(c => c.z));\n          } else {\n            break;\n          }\n        }\n        \n        if (chairLevels > 2) { // Максимум 2 стула друг на друге\n          return false;\n        }\n      } else {\n        // Обычные грузы: нельзя ставить на стулья/кресла\n        const hasChairSupport = supportingCargos.some(supporting => \n          isChairOrSeat(supporting.productName)\n        );\n        \n        if (hasChairSupport) {\n          return false;\n        }\n      }\n    }\n\n    return true;\n  };"
    },
    "output": "",
    "metadata": {
      "diagnostics": {},
      "diff": "Index: /home/user/project/components/TruckVisualization.tsx\n===================================================================\n--- /home/user/project/components/TruckVisualization.tsx\n+++ /home/user/project/components/TruckVisualization.tsx\n@@ -194,9 +194,13 @@\n // Проверка валидности позиции\n const isPositionValid = (\n   x: number, y: number, z: number,\n   orientation: {length: number, width: number, height: number},\n-  occupiedSpaces: Array<{x: number, y: number, z: number, length: number, width: number, height: number}>,\n+  occupiedSpaces: Array<{\n+    x: number, y: number, z: number, \n+    length: number, width: number, height: number,\n+    cargoId: string, weight: number, productName?: string\n+  }>,\n   cargo: Cargo\n ): boolean => {\n   \n   // Проверяем пересечения с уже размещенными грузами\n@@ -210,9 +214,9 @@\n       return false;\n     }\n   }\n \n-  // Проверяем правила размещения по весу\n+  // Проверяем правила размещения по весу и для стульев/кресел\n   if (z > 0) { // Если груз не на полу\n     const supportingCargos = occupiedSpaces.filter(occupied => \n       z === occupied.z + occupied.height && // Груз стоит прямо на другом грузе\n       !(x >= occupied.x + occupied.length || \n@@ -220,42 +224,64 @@\n         y >= occupied.y + occupied.width || \n         y + orientation.width <= occupied.y)\n     );\n \n-    // Проверяем, что все поддерживающие грузы тяжелее или равны по весу\n+    if (supportingCargos.length === 0) {\n+      return false; // Груз должен на чем-то стоять\n+    }\n+\n+    // Проверяем правило по весу: тяжелый груз нельзя ставить на легкий\n     for (const supporting of supportingCargos) {\n-      const supportingCargo = occupiedSpaces.find(s => s === supporting);\n-      if (supportingCargo) {\n-        // Находим оригинальный груз по позиции (упрощенно)\n-        // В реальности нужна более сложная логика сопоставления\n-        // Пока пропускаем проверку веса для упрощения\n+      if (cargo.weight > supporting.weight) {\n+        return false;\n       }\n     }\n \n     // Проверяем правила для стульев/кресел\n     if (isChairOrSeat(cargo.productName)) {\n-      // Считаем количество грузов-стульев под текущим\n-      let chairsBelow = 0;\n-      let currentZ = 0;\n-      while (currentZ < z) {\n-        const chairBelow = occupiedSpaces.find(occupied =>\n-          occupied.z === currentZ && \n+      // На стулья/кресла можно ставить только другие стулья/кресла\n+      const allSupportingAreChairs = supportingCargos.every(supporting => \n+        isChairOrSeat(supporting.productName)\n+      );\n+      \n+      if (!allSupportingAreChairs) {\n+        return false;\n+      }\n+\n+      // Считаем количество стульев/кресел под текущим (максимум 2 друг на друге)\n+      let chairLevels = 1; // Текущий уровень\n+      let currentZ = z;\n+      \n+      while (currentZ > 0) {\n+        const supportingChairs = occupiedSpaces.filter(occupied =>\n+          occupied.z + occupied.height === currentZ &&\n+          isChairOrSeat(occupied.productName) &&\n           !(x >= occupied.x + occupied.length || \n             x + orientation.length <= occupied.x ||\n             y >= occupied.y + occupied.width || \n             y + orientation.width <= occupied.y)\n         );\n-        if (chairBelow) {\n-          chairsBelow++;\n-          currentZ = chairBelow.z + chairBelow.height;\n+        \n+        if (supportingChairs.length > 0) {\n+          chairLevels++;\n+          currentZ = Math.min(...supportingChairs.map(c => c.z));\n         } else {\n           break;\n         }\n       }\n       \n-      if (chairsBelow >= 2) { // Максимум 2 стула друг на друге\n+      if (chairLevels > 2) { // Максимум 2 стула друг на друге\n         return false;\n       }\n+    } else {\n+      // Обычные грузы: нельзя ставить на стулья/кресла\n+      const hasChairSupport = supportingCargos.some(supporting => \n+        isChairOrSeat(supporting.productName)\n+      );\n+      \n+      if (hasChairSupport) {\n+        return false;\n+      }\n     }\n   }\n \n   return true;\n"
    },
    "title": "components/TruckVisualization.tsx",
    "time": {
      "start": 1759133324045,
      "end": 1759133324054
    }
  }
}