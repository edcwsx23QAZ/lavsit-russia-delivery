{
  "id": "prt_9b8f26c35001dosmZtlzr1ILH7",
  "messageID": "msg_9b8f028e10016BVK2INrK8CHhs",
  "sessionID": "ses_6852784ecffeuHwynj83p2lr14",
  "type": "tool",
  "tool": "read",
  "callID": "toolu_01L6jV4k11PMKK8JWJM74qPn",
  "state": {
    "status": "completed",
    "input": {
      "filePath": "/home/user/project/app/diagnostic/page.tsx"
    },
    "output": "<file>\n00001| 'use client';\n00002| \n00003| import React, { useEffect, useCallback } from 'react';\n00004| import { useDiagnosticState } from '@/hooks/useDiagnosticState';\n00005| import DiagnosticHeader from '@/components/diagnostic/DiagnosticHeader';\n00006| import ApiTestingSection from '@/components/diagnostic/ApiTestingSection';\n00007| import { LazyFullTestingResults, LazyVehicleManagement } from '@/components/diagnostic/LazyLoadedComponents';\n00008| import { apiRequestWithTimeout, PerformanceMonitor } from '@/lib/api-utils';\n00009| \n00010| export default function OptimizedDiagnosticPage() {\n00011|   const { state, actions } = useDiagnosticState();\n00012| \n00013|   // Initialize data on mount\n00014|   useEffect(() => {\n00015|     try {\n00016|       const saved = localStorage.getItem('vehicleTypes');\n00017|       if (saved) {\n00018|         const parsedVehicleTypes = JSON.parse(saved);\n00019|         actions.initializeVehicleTypes(parsedVehicleTypes, null);\n00020|       }\n00021|       \n00022|       const lastUpdate = localStorage.getItem('lastProductDataUpdate');\n00023|       if (lastUpdate) {\n00024|         actions.setLastUpdateTime(new Date(lastUpdate).toLocaleString('ru-RU'));\n00025|       }\n00026|     } catch (error) {\n00027|       console.error('Ошибка загрузки сохранённых данных:', error);\n00028|     }\n00029|   }, [actions]);\n00030| \n00031|   // API testing functions with performance monitoring\n00032|   const testAPI = useCallback(async (service: string, endpoint: string, data: any = {}) => {\n00033|     const endTiming = PerformanceMonitor.startMeasurement(`diagnostic_${service}`);\n00034|     actions.setTestingState(service, true);\n00035|     \n00036|     try {\n00037|       const response = await apiRequestWithTimeout(endpoint, {\n00038|         method: 'POST',\n00039|         headers: { 'Content-Type': 'application/json' },\n00040|         body: JSON.stringify(data)\n00041|       }, { timeout: 15000, retries: 1 });\n00042| \n00043|       const result = await response.json();\n00044|       const timing = endTiming();\n00045| \n00046|       if (response.ok) {\n00047|         actions.setDiagnosticResult(service.toLowerCase(), {\n00048|           status: 'success',\n00049|           message: `✅ ${service} API работает корректно`,\n00050|           details: result,\n00051|           timing\n00052|         });\n00053|       } else {\n00054|         actions.setDiagnosticResult(service.toLowerCase(), {\n00055|           status: 'error',\n00056|           message: `❌ Ошибка ${service} API: ${result.error || 'Неизвестная ошибка'}`,\n00057|           details: result,\n00058|           timing\n00059|         });\n00060|       }\n00061|     } catch (error) {\n00062|       endTiming();\n00063|       actions.setDiagnosticResult(service.toLowerCase(), {\n00064|         status: 'error',\n00065|         message: `❌ Сетевая ошибка ${service} API`,\n00066|         details: error instanceof Error ? error.message : 'Неизвестная ошибка'\n00067|       });\n00068|     } finally {\n00069|       actions.setTestingState(service, false);\n00070|     }\n00071|   }, [actions]);\n00072| \n00073|   const testPEK = useCallback(() => {\n00074|     testAPI('PEK', '/api/pek', { method: 'test' });\n00075|   }, [testAPI]);\n00076| \n00077|   const testDellin = useCallback(() => {\n00078|     testAPI('Dellin', '/api/dellin-packages', { method: 'test' });\n00079|   }, [testAPI]);\n00080| \n00081|   const testRailContinent = useCallback(() => {\n00082|     testAPI('RailContinent', '/api/rail-continent', { method: 'test' });\n00083|   }, [testAPI]);\n00084| \n00085|   const testVozovoz = useCallback(() => {\n00086|     testAPI('Vozovoz', '/api/vozovoz', { method: 'test' });\n00087|   }, [testAPI]);\n00088| \n00089|   const testNordWheel = useCallback(() => {\n00090|     testAPI('NordWheel', '/api/test', { service: 'nordwheel' });\n00091|   }, [testAPI]);\n00092| \n00093|   const testAllAPIs = useCallback(async () => {\n00094|     actions.resetDiagnosticResults();\n00095|     \n00096|     const tests = [\n00097|       () => testPEK(),\n00098|       () => testDellin(), \n00099|       () => testRailContinent(),\n00100|       () => testVozovoz(),\n00101|       () => testNordWheel()\n00102|     ];\n00103| \n00104|     // Run tests in parallel for better performance\n00105|     await Promise.allSettled(tests.map(test => test()));\n00106|   }, [actions, testPEK, testDellin, testRailContinent, testVozovoz, testNordWheel]);\n00107| \n00108|   const runFullTesting = useCallback(async () => {\n00109|     actions.setFullTesting(true);\n00110|     actions.setTestProgress({ \n00111|       currentTK: 'Начинаем тестирование...', \n00112|       completedTests: 0, \n00113|       totalPlannedTests: 25, \n00114|       stage: 'Инициализация',\n00115|       progress: 0 \n00116|     });\n00117| \n00118|     const startTime = Date.now();\n00119|     const results: any[] = [];\n00120|     const errors: string[] = [];\n00121| \n00122|     const testCases = [\n00123|       { service: 'ПЭК', endpoint: '/api/pek', data: { method: 'test' } },\n00124|       { service: 'Деловые Линии', endpoint: '/api/dellin-packages', data: { method: 'test' } },\n00125|       { service: 'Rail Continent', endpoint: '/api/rail-continent', data: { method: 'test' } },\n00126|       { service: 'Возовоз', endpoint: '/api/vozovoz', data: { method: 'test' } },\n00127|       { service: 'Nord Wheel', endpoint: '/api/test', data: { service: 'nordwheel' } }\n00128|     ];\n00129| \n00130|     for (let i = 0; i < testCases.length; i++) {\n00131|       const testCase = testCases[i];\n00132|       const progress = Math.round(((i + 1) / testCases.length) * 100);\n00133|       \n00134|       actions.setTestProgress({\n00135|         currentTK: testCase.service,\n00136|         completedTests: i,\n00137|         totalPlannedTests: testCases.length,\n00138|         stage: 'Тестирование API',\n00139|         progress\n00140|       });\n00141| \n00142|       try {\n00143|         const response = await apiRequestWithTimeout(testCase.endpoint, {\n00144|           method: 'POST',\n00145|           headers: { 'Content-Type': 'application/json' },\n00146|           body: JSON.stringify(testCase.data)\n00147|         }, { timeout: 10000 });\n00148| \n00149|         const result = await response.json();\n00150|         \n00151|         results.push({\n00152|           company: testCase.service,\n00153|           status: response.ok ? 'passed' : 'failed',\n00154|           message: response.ok ? 'Тест пройден успешно' : result.error || 'Ошибка теста',\n00155|           details: result,\n00156|           timing: result.timing || 0,\n00157|           timestamp: new Date().toISOString()\n00158|         });\n00159| \n00160|         if (!response.ok) {\n00161|           errors.push(`${testCase.service}: ${result.error || 'Неизвестная ошибка'}`);\n00162|         }\n00163|       } catch (error) {\n00164|         results.push({\n00165|           company: testCase.service,\n00166|           status: 'failed',\n00167|           message: 'Сетевая ошибка или таймаут',\n00168|           details: error instanceof Error ? error.message : 'Неизвестная ошибка',\n00169|           timing: 0,\n00170|           timestamp: new Date().toISOString()\n00171|         });\n00172|         errors.push(`${testCase.service}: Сетевая ошибка`);\n00173|       }\n00174| \n00175|       // Small delay for UI updates\n00176|       await new Promise(resolve => setTimeout(resolve, 200));\n00177|     }\n00178| \n00179|     const endTime = Date.now();\n00180|     const totalTime = endTime - startTime;\n00181|     const successful = results.filter(r => r.status === 'passed').length;\n00182|     const failed = results.filter(r => r.status === 'failed').length;\n00183|     const averageTime = results.reduce((sum, r) => sum + r.timing, 0) / results.length;\n00184| \n00185|     actions.setFullTestResults({\n00186|       summary: {\n00187|         totalTests: results.length,\n00188|         successful,\n00189|         failed,\n00190|         skipped: 0,\n00191|         errors,\n00192|         averageResponseTime: Math.round(averageTime),\n00193|         successRate: (successful / results.length) * 100\n00194|       },\n00195|       details: results,\n00196|       progressInfo: null\n00197|     });\n00198| \n00199|     actions.setTestProgress(null);\n00200|     actions.setFullTesting(false);\n00201|   }, [actions]);\n00202| \n00203|   // Vehicle management functions\n00204|   const addVehicleType = useCallback(() => {\n00205|     const { name, length, width, height } = state.newVehicle;\n00206|     \n00207|     if (!name || !length || !width || !height) {\n00208|       alert('Пожалуйста, заполните все поля');\n00209|       return;\n00210|     }\n00211|     \n00212|     const newId = (state.vehicleTypes.length + 1).toString();\n00213|     const vehicleToAdd = {\n00214|       id: newId,\n00215|       name,\n00216|       length: parseInt(length),\n00217|       width: parseInt(width),\n00218|       height: parseInt(height)\n00219|     };\n00220|     \n00221|     actions.addVehicleType(vehicleToAdd);\n00222|   }, [state.newVehicle, state.vehicleTypes.length, actions]);\n00223| \n00224|   const saveVehicleTypes = useCallback(async () => {\n00225|     actions.setSavingState(true);\n00226|     actions.setSaveStatus('saving');\n00227|     \n00228|     try {\n00229|       localStorage.setItem('vehicleTypes', JSON.stringify(state.vehicleTypes));\n00230|       await new Promise(resolve => setTimeout(resolve, 1000));\n00231|       \n00232|       actions.setUnsavedChanges(false);\n00233|       actions.setSaveStatus('success');\n00234|       setTimeout(() => actions.setSaveStatus('idle'), 3000);\n00235|     } catch (error) {\n00236|       console.error('Ошибка сохранения:', error);\n00237|       actions.setSaveStatus('error');\n00238|       setTimeout(() => actions.setSaveStatus('idle'), 5000);\n00239|     } finally {\n00240|       actions.setSavingState(false);\n00241|     }\n00242|   }, [state.vehicleTypes, actions]);\n00243| \n00244|   const updateProductData = useCallback(async () => {\n00245|     actions.setUpdatingData(true);\n00246|     actions.setUpdateStatus('updating');\n00247|     \n00248|     try {\n00249|       const response = await apiRequestWithTimeout('/api/furniture-products?update=true&force=true&timestamp=' + Date.now(), {\n00250|         method: 'GET',\n00251|         headers: {\n00252|           'Cache-Control': 'no-cache, no-store, must-revalidate',\n00253|           'Pragma': 'no-cache',\n00254|           'Expires': '0'\n00255|         }\n00256|       }, { timeout: 30000 });\n00257| \n00258|       const result = await response.json();\n00259|       \n00260|       if (!result.success) {\n00261|         throw new Error(result.error || 'Ошибка обновления данных');\n00262|       }\n00263| \n00264|       const updateTime = new Date().toLocaleString('ru-RU');\n00265|       localStorage.setItem('lastProductDataUpdate', new Date().toISOString());\n00266|       actions.setLastUpdateTime(updateTime);\n00267|       actions.setUpdateStatus('success');\n00268|       \n00269|       setTimeout(() => actions.setUpdateStatus('idle'), 3000);\n00270|     } catch (error) {\n00271|       console.error('Ошибка обновления данных:', error);\n00272|       actions.setUpdateStatus('error');\n00273|       setTimeout(() => actions.setUpdateStatus('idle'), 5000);\n00274|     } finally {\n00275|       actions.setUpdatingData(false);\n00276|     }\n00277|   }, [actions]);\n00278| \n00279|   return (\n00280|     <div className=\"min-h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 p-6\">\n00281|       <div className=\"max-w-7xl mx-auto\">\n00282|         <DiagnosticHeader\n00283|           onTestAllAPIs={testAllAPIs}\n00284|           onRunFullTesting={runFullTesting}\n00285|           onUpdateProductData={updateProductData}\n00286|           isFullTesting={state.isFullTesting}\n00287|           isUpdatingData={state.isUpdatingData}\n00288|           updateStatus={state.updateStatus}\n00289|         />\n00290| \n00291|         <ApiTestingSection\n00292|           diagnosticResults={state.diagnosticResults}\n00293|           testStates={{\n00294|             isTestingPEK: state.isTestingPEK,\n00295|             isTestingDellin: state.isTestingDellin,\n00296|             isTestingRailContinent: state.isTestingRailContinent,\n00297|             isTestingVozovoz: state.isTestingVozovoz,\n00298|             isTestingNordWheel: state.isTestingNordWheel,\n00299|           }}\n00300|           onTestPEK={testPEK}\n00301|           onTestDellin={testDellin}\n00302|           onTestRailContinent={testRailContinent}\n00303|           onTestVozovoz={testVozovoz}\n00304|           onTestNordWheel={testNordWheel}\n00305|         />\n00306| \n00307|         <LazyFullTestingResults\n00308|           fullTestResults={state.fullTestResults}\n00309|           testProgress={state.testProgress?.progress || 0}\n00310|           isFullTesting={state.isFullTesting}\n00311|         />\n00312| \n00313|         <LazyVehicleManagement\n00314|           vehicleTypes={state.vehicleTypes}\n00315|           newVehicle={state.newVehicle}\n00316|           hasUnsavedChanges={state.hasUnsavedChanges}\n00317|           saveStatus={state.saveStatus}\n00318|           isSaving={state.isSaving}\n00319|           lastUpdateTime={state.lastUpdateTime}\n00320|           onAddVehicleType={addVehicleType}\n00321|           onRemoveVehicleType={actions.removeVehicleType}\n00322|           onUpdateVehicleType={actions.updateVehicleType}\n00323|           onSaveVehicleTypes={saveVehicleTypes}\n00324|           onSetNewVehicle={actions.setNewVehicle}\n00325|         />\n00326|       </div>\n00327|     </div>\n00328|   );\n00329| }\n</file>",
    "metadata": {
      "preview": "'use client';\n\nimport React, { useEffect, useCallback } from 'react';\nimport { useDiagnosticState } from '@/hooks/useDiagnosticState';\nimport DiagnosticHeader from '@/components/diagnostic/DiagnosticHeader';\nimport ApiTestingSection from '@/components/diagnostic/ApiTestingSection';\nimport { LazyFullTestingResults, LazyVehicleManagement } from '@/components/diagnostic/LazyLoadedComponents';\nimport { apiRequestWithTimeout, PerformanceMonitor } from '@/lib/api-utils';\n\nexport default function OptimizedDiagnosticPage() {\n  const { state, actions } = useDiagnosticState();\n\n  // Initialize data on mount\n  useEffect(() => {\n    try {\n      const saved = localStorage.getItem('vehicleTypes');\n      if (saved) {\n        const parsedVehicleTypes = JSON.parse(saved);\n        actions.initializeVehicleTypes(parsedVehicleTypes, null);\n      }"
    },
    "title": "app/diagnostic/page.tsx",
    "time": {
      "start": 1759744519795,
      "end": 1759744519799
    }
  }
}