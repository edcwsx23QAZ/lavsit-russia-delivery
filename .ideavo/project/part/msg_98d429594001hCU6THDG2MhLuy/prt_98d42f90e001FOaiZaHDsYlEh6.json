{
  "id": "prt_98d42f90e001FOaiZaHDsYlEh6",
  "messageID": "msg_98d429594001hCU6THDG2MhLuy",
  "sessionID": "ses_6852784ecffeuHwynj83p2lr14",
  "type": "tool",
  "tool": "read",
  "callID": "toolu_013PJLa8oYJJ6aksYkfWWbxx",
  "state": {
    "status": "completed",
    "input": {
      "filePath": "/home/user/project/components/ProductSearch.tsx"
    },
    "output": "<file>\n00001| 'use client';\n00002| \n00003| import React, { useState, useEffect, useRef, useCallback } from 'react';\n00004| import { Input } from '@/components/ui/input';\n00005| import { Button } from '@/components/ui/button';\n00006| import { Badge } from '@/components/ui/badge';\n00007| import { Card, CardContent } from '@/components/ui/card';\n00008| import { Plus, Search, Package, Loader2 } from 'lucide-react';\n00009| import { FurnitureProduct, ProductSearchState } from '@/lib/furniture-types';\n00010| import { searchProducts, formatPrice, getProductSummary } from '@/lib/furniture-utils';\n00011| \n00012| interface ProductSearchProps {\n00013|   onProductAdd: (product: FurnitureProduct) => void;\n00014|   disabled?: boolean;\n00015| }\n00016| \n00017| export default function ProductSearch({ onProductAdd, disabled = false }: ProductSearchProps) {\n00018|   const [searchState, setSearchState] = useState<ProductSearchState>({\n00019|     query: '',\n00020|     isLoading: false,\n00021|     suggestions: [],\n00022|     showSuggestions: false,\n00023|     selectedIndex: -1\n00024|   });\n00025|   \n00026|   const [allProducts, setAllProducts] = useState<FurnitureProduct[]>([]);\n00027|   const [isLoadingProducts, setIsLoadingProducts] = useState(false);\n00028|   const inputRef = useRef<HTMLInputElement>(null);\n00029|   const suggestionsRef = useRef<HTMLDivElement>(null);\n00030|   \n00031|   // Загрузка продуктов при монтировании\n00032|   useEffect(() => {\n00033|     loadProducts();\n00034|   }, []);\n00035|   \n00036|   // Загрузка продуктов с сервера\n00037|   const loadProducts = async () => {\n00038|     setIsLoadingProducts(true);\n00039|     try {\n00040|       const response = await fetch('/api/furniture-products');\n00041|       const data = await response.json();\n00042|       \n00043|       if (data.success) {\n00044|         setAllProducts(data.data);\n00045|         console.log(`✅ Загружено ${data.data.length} товаров`);\n00046|       } else {\n00047|         console.error('❌ Ошибка загрузки товаров:', data.error);\n00048|       }\n00049|     } catch (error) {\n00050|       console.error('❌ Ошибка загрузки товаров:', error);\n00051|     } finally {\n00052|       setIsLoadingProducts(false);\n00053|     }\n00054|   };\n00055|   \n00056|   // Обработка поискового запроса\n00057|   const handleQueryChange = useCallback((query: string) => {\n00058|     setSearchState(prev => ({\n00059|       ...prev,\n00060|       query,\n00061|       selectedIndex: -1\n00062|     }));\n00063|     \n00064|     if (query.trim().length >= 2) {\n00065|       const filtered = searchProducts(allProducts, query);\n00066|       setSearchState(prev => ({\n00067|         ...prev,\n00068|         suggestions: filtered,\n00069|         showSuggestions: true\n00070|       }));\n00071|     } else {\n00072|       setSearchState(prev => ({\n00073|         ...prev,\n00074|         suggestions: [],\n00075|         showSuggestions: false\n00076|       }));\n00077|     }\n00078|   }, [allProducts]);\n00079|   \n00080|   // Обработка выбора товара\n00081|   const handleProductSelect = (product: FurnitureProduct) => {\n00082|     onProductAdd(product);\n00083|     setSearchState(prev => ({\n00084|       ...prev,\n00085|       query: '',\n00086|       suggestions: [],\n00087|       showSuggestions: false,\n00088|       selectedIndex: -1\n00089|     }));\n00090|     inputRef.current?.focus();\n00091|   };\n00092|   \n00093|   // Обработка клавиш\n00094|   const handleKeyDown = (e: React.KeyboardEvent) => {\n00095|     if (!searchState.showSuggestions || searchState.suggestions.length === 0) return;\n00096|     \n00097|     switch (e.key) {\n00098|       case 'ArrowDown':\n00099|         e.preventDefault();\n00100|         setSearchState(prev => ({\n00101|           ...prev,\n00102|           selectedIndex: Math.min(prev.selectedIndex + 1, prev.suggestions.length - 1)\n00103|         }));\n00104|         break;\n00105|         \n00106|       case 'ArrowUp':\n00107|         e.preventDefault();\n00108|         setSearchState(prev => ({\n00109|           ...prev,\n00110|           selectedIndex: Math.max(prev.selectedIndex - 1, -1)\n00111|         }));\n00112|         break;\n00113|         \n00114|       case 'Enter':\n00115|         e.preventDefault();\n00116|         if (searchState.selectedIndex >= 0) {\n00117|           handleProductSelect(searchState.suggestions[searchState.selectedIndex]);\n00118|         }\n00119|         break;\n00120|         \n00121|       case 'Escape':\n00122|         setSearchState(prev => ({\n00123|           ...prev,\n00124|           showSuggestions: false,\n00125|           selectedIndex: -1\n00126|         }));\n00127|         break;\n00128|     }\n00129|   };\n00130|   \n00131|   // Закрытие списка при клике вне\n00132|   useEffect(() => {\n00133|     const handleClickOutside = (event: MouseEvent) => {\n00134|       if (suggestionsRef.current && !suggestionsRef.current.contains(event.target as Node) &&\n00135|           inputRef.current && !inputRef.current.contains(event.target as Node)) {\n00136|         setSearchState(prev => ({ ...prev, showSuggestions: false }));\n00137|       }\n00138|     };\n00139|     \n00140|     document.addEventListener('mousedown', handleClickOutside);\n00141|     return () => document.removeEventListener('mousedown', handleClickOutside);\n00142|   }, []);\n00143|   \n00144|   return (\n00145|     <div className=\"relative w-full\">\n00146|       {/* Поле поиска */}\n00147|       <div className=\"flex gap-2\">\n00148|         <div className=\"relative flex-1\">\n00149|           <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400\" />\n00150|           <Input\n00151|             ref={inputRef}\n00152|             type=\"text\"\n00153|             value={searchState.query}\n00154|             onChange={(e) => handleQueryChange(e.target.value)}\n00155|             onKeyDown={handleKeyDown}\n00156|             onFocus={() => {\n00157|               if (searchState.suggestions.length > 0) {\n00158|                 setSearchState(prev => ({ ...prev, showSuggestions: true }));\n00159|               }\n00160|             }}\n00161|             placeholder=\"Поиск мебели по названию...\"\n00162|             className=\"bg-gray-700 border-gray-600 text-white pl-10 h-10\"\n00163|             disabled={disabled || isLoadingProducts}\n00164|           />\n00165|           {isLoadingProducts && (\n00166|             <Loader2 className=\"absolute right-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400 animate-spin\" />\n00167|           )}\n00168|         </div>\n00169|         \n00170|         <Button\n00171|           type=\"button\"\n00172|           onClick={() => {\n00173|             if (searchState.selectedIndex >= 0) {\n00174|               handleProductSelect(searchState.suggestions[searchState.selectedIndex]);\n00175|             } else if (searchState.suggestions.length === 1) {\n00176|               handleProductSelect(searchState.suggestions[0]);\n00177|             }\n00178|           }}\n00179|           disabled={disabled || searchState.suggestions.length === 0}\n00180|           className=\"bg-blue-600 hover:bg-blue-700 h-10 px-4\"\n00181|         >\n00182|           <Plus className=\"h-4 w-4 mr-2\" />\n00183|           Добавить товар\n00184|         </Button>\n00185|       </div>\n00186|       \n00187|       {/* Список подсказок */}\n00188|       {searchState.showSuggestions && searchState.suggestions.length > 0 && (\n00189|         <Card \n00190|           ref={suggestionsRef}\n00191|           className=\"absolute top-full left-0 right-0 z-50 mt-1 bg-gray-800 border-gray-600 max-h-80 overflow-y-auto\"\n00192|         >\n00193|           <CardContent className=\"p-0\">\n00194|             {searchState.suggestions.map((product, index) => (\n00195|               <div\n00196|                 key={`${product.id}_${product.externalCode}`}\n00197|                 onClick={() => handleProductSelect(product)}\n00198|                 className={`p-3 cursor-pointer border-b border-gray-700 last:border-b-0 transition-colors ${\n00199|                   index === searchState.selectedIndex \n00200|                     ? 'bg-blue-600/20 border-blue-500' \n00201|                     : 'hover:bg-gray-700'\n00202|                 }`}\n00203|               >\n00204|                 <div className=\"flex items-start justify-between\">\n00205|                   <div className=\"flex-1 min-w-0\">\n00206|                     <h4 className=\"text-white font-medium text-sm truncate\">\n00207|                       {product.name}\n00208|                     </h4>\n00209|                     <div className=\"flex items-center gap-2 mt-1\">\n00210|                       <Badge variant=\"outline\" className=\"text-xs border-gray-600\">\n00211|                         {product.externalCode}\n00212|                       </Badge>\n00213|                       <div className=\"flex items-center text-gray-400 text-xs\">\n00214|                         <Package className=\"h-3 w-3 mr-1\" />\n00215|                         {getProductSummary(product)}\n00216|                       </div>\n00217|                     </div>\n00218|                   </div>\n00219|                   <div className=\"text-right ml-3\">\n00220|                     <div className=\"text-green-400 font-medium text-sm\">\n00221|                       {formatPrice(product.retailPrice)}\n00222|                     </div>\n00223|                     {!product.isActive && (\n00224|                       <Badge variant=\"destructive\" className=\"text-xs mt-1\">\n00225|                         Неактивен\n00226|                       </Badge>\n00227|                     )}\n00228|                   </div>\n00229|                 </div>\n00230|               </div>\n00231|             ))}\n00232|           </CardContent>\n00233|         </Card>\n00234|       )}\n00235|       \n00236|       {/* Состояние загрузки */}\n00237|       {isLoadingProducts && (\n00238|         <div className=\"text-gray-400 text-sm mt-2 flex items-center\">\n00239|           <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n00240|           Загрузка каталога мебели...\n00241|         </div>\n00242|       )}\n00243|       \n00244|       {/* Пустой результат поиска */}\n00245|       {searchState.query.length >= 2 && searchState.suggestions.length === 0 && !isLoadingProducts && (\n00246|         <div className=\"text-gray-400 text-sm mt-2\">\n00247|           Товары не найдены. Попробуйте изменить запрос.\n00248|         </div>\n00249|       )}\n00250|       \n00251|       {/* Подсказка */}\n00252|       {!searchState.query && allProducts.length > 0 && (\n00253|         <div className=\"text-gray-400 text-xs mt-2\">\n00254|           Доступно {allProducts.length} товаров. Начните вводить название для поиска.\n00255|         </div>\n00256|       )}\n00257|     </div>\n00258|   );\n00259| }\n</file>",
    "metadata": {
      "preview": "'use client';\n\nimport React, { useState, useEffect, useRef, useCallback } from 'react';\nimport { Input } from '@/components/ui/input';\nimport { Button } from '@/components/ui/button';\nimport { Badge } from '@/components/ui/badge';\nimport { Card, CardContent } from '@/components/ui/card';\nimport { Plus, Search, Package, Loader2 } from 'lucide-react';\nimport { FurnitureProduct, ProductSearchState } from '@/lib/furniture-types';\nimport { searchProducts, formatPrice, getProductSummary } from '@/lib/furniture-utils';\n\ninterface ProductSearchProps {\n  onProductAdd: (product: FurnitureProduct) => void;\n  disabled?: boolean;\n}\n\nexport default function ProductSearch({ onProductAdd, disabled = false }: ProductSearchProps) {\n  const [searchState, setSearchState] = useState<ProductSearchState>({\n    query: '',\n    isLoading: false,"
    },
    "title": "components/ProductSearch.tsx",
    "time": {
      "start": 1759011601084,
      "end": 1759011601088
    }
  }
}