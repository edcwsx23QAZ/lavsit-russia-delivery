{
  "id": "prt_98d437ea7002GM1Y6jOz4D1kpi",
  "messageID": "msg_98d429594001hCU6THDG2MhLuy",
  "sessionID": "ses_6852784ecffeuHwynj83p2lr14",
  "type": "tool",
  "tool": "edit",
  "callID": "toolu_0198A2voYW2VAvoce4B5hKYp",
  "state": {
    "status": "completed",
    "input": {
      "filePath": "/home/user/project/lib/furniture-utils.ts",
      "oldString": "/**\n * Поиск товаров по запросу\n */\nexport function searchProducts(products: FurnitureProduct[], query: string): FurnitureProduct[] {\n  if (!query.trim()) return [];\n  \n  const normalizedQuery = query.toLowerCase().trim();\n  \n  return products.filter(product => {\n    const nameMatch = product.name.toLowerCase().includes(normalizedQuery);\n    const codeMatch = product.externalCode.toLowerCase().includes(normalizedQuery);\n    return (nameMatch || codeMatch) && product.isActive;\n  }).slice(0, 20); // Ограничиваем результаты\n}",
      "newString": "/**\n * Поиск товаров по запросу с поддержкой нечеткого поиска\n */\nexport function searchProducts(products: FurnitureProduct[], query: string): FurnitureProduct[] {\n  if (!query.trim()) return [];\n  \n  const normalizedQuery = query.toLowerCase().trim();\n  \n  // Разбиваем запрос на отдельные слова\n  const queryWords = normalizedQuery.split(/\\s+/).filter(word => word.length > 0);\n  \n  const searchResults = products.filter(product => {\n    if (!product.isActive) return false;\n    \n    const productText = (product.name + ' ' + product.externalCode).toLowerCase();\n    \n    // Проверяем, что все слова из запроса содержатся в тексте товара\n    const allWordsMatch = queryWords.every(word => productText.includes(word));\n    \n    // Альтернативно: проверяем частичное совпадение любого слова\n    const anyWordMatch = queryWords.some(word => {\n      // Поиск по началу слов в названии товара\n      const productWords = productText.split(/\\s+/);\n      return productWords.some(productWord => \n        productWord.startsWith(word) || productWord.includes(word)\n      );\n    });\n    \n    return allWordsMatch || (queryWords.length === 1 && anyWordMatch);\n  });\n  \n  // Сортируем результаты по релевантности\n  return searchResults.sort((a, b) => {\n    const aText = a.name.toLowerCase();\n    const bText = b.name.toLowerCase();\n    \n    // Точное совпадение в начале названия имеет приоритет\n    const aStartsWithQuery = aText.startsWith(normalizedQuery);\n    const bStartsWithQuery = bText.startsWith(normalizedQuery);\n    \n    if (aStartsWithQuery && !bStartsWithQuery) return -1;\n    if (!aStartsWithQuery && bStartsWithQuery) return 1;\n    \n    // Если оба или ни один не начинается с запроса, сортируем по алфавиту\n    return aText.localeCompare(bText, 'ru');\n  }).slice(0, 50); // Увеличиваем лимит до 50 результатов\n}"
    },
    "output": "",
    "metadata": {
      "diagnostics": {},
      "diff": "Index: /home/user/project/lib/furniture-utils.ts\n===================================================================\n--- /home/user/project/lib/furniture-utils.ts\n+++ /home/user/project/lib/furniture-utils.ts\n@@ -27,20 +27,53 @@\n   };\n }\n \n /**\n- * Поиск товаров по запросу\n+ * Поиск товаров по запросу с поддержкой нечеткого поиска\n  */\n export function searchProducts(products: FurnitureProduct[], query: string): FurnitureProduct[] {\n   if (!query.trim()) return [];\n   \n   const normalizedQuery = query.toLowerCase().trim();\n   \n-  return products.filter(product => {\n-    const nameMatch = product.name.toLowerCase().includes(normalizedQuery);\n-    const codeMatch = product.externalCode.toLowerCase().includes(normalizedQuery);\n-    return (nameMatch || codeMatch) && product.isActive;\n-  }).slice(0, 20); // Ограничиваем результаты\n+  // Разбиваем запрос на отдельные слова\n+  const queryWords = normalizedQuery.split(/\\s+/).filter(word => word.length > 0);\n+  \n+  const searchResults = products.filter(product => {\n+    if (!product.isActive) return false;\n+    \n+    const productText = (product.name + ' ' + product.externalCode).toLowerCase();\n+    \n+    // Проверяем, что все слова из запроса содержатся в тексте товара\n+    const allWordsMatch = queryWords.every(word => productText.includes(word));\n+    \n+    // Альтернативно: проверяем частичное совпадение любого слова\n+    const anyWordMatch = queryWords.some(word => {\n+      // Поиск по началу слов в названии товара\n+      const productWords = productText.split(/\\s+/);\n+      return productWords.some(productWord => \n+        productWord.startsWith(word) || productWord.includes(word)\n+      );\n+    });\n+    \n+    return allWordsMatch || (queryWords.length === 1 && anyWordMatch);\n+  });\n+  \n+  // Сортируем результаты по релевантности\n+  return searchResults.sort((a, b) => {\n+    const aText = a.name.toLowerCase();\n+    const bText = b.name.toLowerCase();\n+    \n+    // Точное совпадение в начале названия имеет приоритет\n+    const aStartsWithQuery = aText.startsWith(normalizedQuery);\n+    const bStartsWithQuery = bText.startsWith(normalizedQuery);\n+    \n+    if (aStartsWithQuery && !bStartsWithQuery) return -1;\n+    if (!aStartsWithQuery && bStartsWithQuery) return 1;\n+    \n+    // Если оба или ни один не начинается с запроса, сортируем по алфавиту\n+    return aText.localeCompare(bText, 'ru');\n+  }).slice(0, 50); // Увеличиваем лимит до 50 результатов\n }\n \n /**\n  * Валидация товара\n"
    },
    "title": "lib/furniture-utils.ts",
    "time": {
      "start": 1759011645729,
      "end": 1759011645739
    }
  }
}