{
  "id": "prt_98d42ae29001slKLF211641xZY",
  "messageID": "msg_98d429594001hCU6THDG2MhLuy",
  "sessionID": "ses_6852784ecffeuHwynj83p2lr14",
  "type": "tool",
  "tool": "read",
  "callID": "toolu_01UkwKFcaTbhW1omiDzdBRCy",
  "state": {
    "status": "completed",
    "input": {
      "filePath": "/home/user/project/app/api/furniture-products/route.ts"
    },
    "output": "<file>\n00001| import { NextRequest, NextResponse } from 'next/server';\n00002| \n00003| // –û—Ç–∫–ª—é—á–∞–µ–º —Å—Ç–∞—Ç–∏—á–µ—Å–∫—É—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –¥–ª—è —ç—Ç–æ–≥–æ API\n00004| export const dynamic = 'force-dynamic';\n00005| \n00006| // üîß –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –¥–ª—è –¥–∞–Ω–Ω—ã—Ö –º–µ–±–µ–ª–∏\n00007| interface CargoPlace {\n00008|   placeNumber: number;\n00009|   weight: number; // –∫–≥\n00010|   height: number; // —Å–º\n00011|   depth: number;  // —Å–º (—à–∏—Ä–∏–Ω–∞)\n00012|   length: number; // —Å–º\n00013| }\n00014| \n00015| interface FurnitureProduct {\n00016|   id: string;\n00017|   externalCode: string;\n00018|   name: string;\n00019|   retailPrice: number;\n00020|   isActive: boolean;\n00021|   cargoPlaces: CargoPlace[];\n00022| }\n00023| \n00024| // –ö—ç—à –¥–ª—è –¥–∞–Ω–Ω—ã—Ö (–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç)\n00025| let cachedData: {\n00026|   products: FurnitureProduct[];\n00027|   lastUpdated: number;\n00028| } | null = null;\n00029| \n00030| const CACHE_DURATION = 30 * 60 * 1000; // 30 –º–∏–Ω—É—Ç\n00031| \n00032| export async function GET(request: NextRequest) {\n00033|   try {\n00034|     // –ò—Å–ø–æ–ª—å–∑—É–µ–º nextUrl –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –æ—à–∏–±–∫–∏ dynamic server usage\n00035|     const searchParams = request.nextUrl.searchParams;\n00036|     const query = searchParams.get('q')?.toLowerCase() || '';\n00037|     \n00038|     // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à\n00039|     const now = Date.now();\n00040|     if (!cachedData || (now - cachedData.lastUpdated) > CACHE_DURATION) {\n00041|       console.log('üîÑ –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à –¥–∞–Ω–Ω—ã—Ö –º–µ–±–µ–ª–∏...');\n00042|       cachedData = await fetchFurnitureData();\n00043|     }\n00044|     \n00045|     // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –ø–æ–∏—Å–∫–æ–≤–æ–º—É –∑–∞–ø—Ä–æ—Å—É\n00046|     let products = cachedData.products;\n00047|     if (query) {\n00048|       products = products.filter(product => \n00049|         product.name.toLowerCase().includes(query) ||\n00050|         product.externalCode.toLowerCase().includes(query)\n00051|       );\n00052|     }\n00053|     \n00054|     // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–ª—è –∞–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç–∞\n00055|     const limit = parseInt(searchParams.get('limit') || '20');\n00056|     products = products.slice(0, limit);\n00057|     \n00058|     return NextResponse.json({\n00059|       success: true,\n00060|       data: products,\n00061|       total: products.length,\n00062|       cached: true,\n00063|       lastUpdated: new Date(cachedData.lastUpdated).toISOString()\n00064|     });\n00065|     \n00066|   } catch (error: any) {\n00067|     console.error('‚ùå –û—à–∏–±–∫–∞ API furniture-products:', error);\n00068|     return NextResponse.json({\n00069|       success: false,\n00070|       error: error.message,\n00071|       data: []\n00072|     }, { status: 500 });\n00073|   }\n00074| }\n00075| \n00076| // üîß –§—É–Ω–∫—Ü–∏—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ Google Sheets\n00077| async function fetchFurnitureData(): Promise<{products: FurnitureProduct[], lastUpdated: number}> {\n00078|   try {\n00079|     // Google Sheets ID –∏–∑ URL\n00080|     const SHEET_ID = '1e0P91PfGKVIuSWDY0ceWkIE7jD-vzD_xrIesBeQno1Y';\n00081|     \n00082|     // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—É–±–ª–∏—á–Ω—ã–π CSV —ç–∫—Å–ø–æ—Ä—Ç Google Sheets\n00083|     const csvUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=0`;\n00084|     \n00085|     console.log('üìä –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ Google Sheets:', csvUrl);\n00086|     \n00087|     const response = await fetch(csvUrl);\n00088|     if (!response.ok) {\n00089|       throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${response.status}`);\n00090|     }\n00091|     \n00092|     const csvText = await response.text();\n00093|     console.log('üìÑ –ü–æ–ª—É—á–µ–Ω—ã CSV –¥–∞–Ω–Ω—ã–µ, —Ä–∞–∑–º–µ—Ä:', csvText.length);\n00094|     \n00095|     // –ü–∞—Ä—Å–∏–º CSV\n00096|     const rows = parseCSV(csvText);\n00097|     console.log('üìã –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫:', rows.length);\n00098|     \n00099|     // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–æ–¥—É–∫—Ç–æ–≤\n00100|     const products = await parseProductsFromRows(rows);\n00101|     console.log('üõãÔ∏è –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤:', products.length);\n00102|     \n00103|     return {\n00104|       products,\n00105|       lastUpdated: Date.now()\n00106|     };\n00107|     \n00108|   } catch (error) {\n00109|     console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –º–µ–±–µ–ª–∏:', error);\n00110|     throw error;\n00111|   }\n00112| }\n00113| \n00114| // üîß –£–ª—É—á—à–µ–Ω–Ω—ã–π CSV –ø–∞—Ä—Å–µ—Ä\n00115| function parseCSV(csvText: string): string[][] {\n00116|   const lines = csvText.split('\\n');\n00117|   const result: string[][] = [];\n00118|   \n00119|   for (const line of lines) {\n00120|     if (line.trim()) {\n00121|       const cells: string[] = [];\n00122|       let current = '';\n00123|       let inQuotes = false;\n00124|       \n00125|       for (let i = 0; i < line.length; i++) {\n00126|         const char = line[i];\n00127|         \n00128|         if (char === '\"') {\n00129|           inQuotes = !inQuotes;\n00130|         } else if (char === ',' && !inQuotes) {\n00131|           cells.push(current.trim());\n00132|           current = '';\n00133|         } else {\n00134|           current += char;\n00135|         }\n00136|       }\n00137|       \n00138|       // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é —è—á–µ–π–∫—É\n00139|       cells.push(current.trim());\n00140|       \n00141|       // –û—á–∏—â–∞–µ–º –∫–∞–≤—ã—á–∫–∏ –∏ –ª–∏—à–Ω–∏–µ —Å–∏–º–≤–æ–ª—ã\n00142|       const cleanedCells = cells.map(cell => \n00143|         cell.replace(/^\"(.*)\"$/, '$1').replace(/\\r/g, '').trim()\n00144|       );\n00145|       \n00146|       result.push(cleanedCells);\n00147|     }\n00148|   }\n00149|   \n00150|   return result;\n00151| }\n00152| \n00153| // üîß –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–æ–∫ –≤ –ø—Ä–æ–¥—É–∫—Ç—ã\n00154| async function parseProductsFromRows(rows: string[][]): Promise<FurnitureProduct[]> {\n00155|   const products: FurnitureProduct[] = [];\n00156|   \n00157|   if (rows.length < 2) {\n00158|     console.warn('‚ö†Ô∏è –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –≤ —Ç–∞–±–ª–∏—Ü–µ');\n00159|     return products;\n00160|   }\n00161|   \n00162|   // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ (–ø–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞)\n00163|   for (let i = 1; i < rows.length; i++) {\n00164|     const row = rows[i];\n00165|     \n00166|     if (row.length < 6) {\n00167|       console.warn(`‚ö†Ô∏è –°—Ç—Ä–æ–∫–∞ ${i + 1} —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö:`, row);\n00168|       continue;\n00169|     }\n00170|     \n00171|     try {\n00172|       // –ú–∞–ø–ø–∏–Ω–≥ –∫–æ–ª–æ–Ω–æ–∫ (—Å–æ–≥–ª–∞—Å–Ω–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ —Ç–∞–±–ª–∏—Ü—ã)\n00173|       const id = row[0] || '';\n00174|       const externalCode = row[1] || '';\n00175|       const isActive = row[2]?.toLowerCase() === '–¥–∞';\n00176|       const name = row[3] || '';\n00177|       const priceStr = row[4] || '0';\n00178|       \n00179|       // –û—á–∏—â–∞–µ–º —Ü–µ–Ω—É –æ—Ç –ª–∏—à–Ω–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤\n00180|       const retailPrice = parseFloat(priceStr.replace(/[^0-9.]/g, '')) || 0;\n00181|       \n00182|       // –ò–∑–≤–ª–µ–∫–∞–µ–º –≥—Ä—É–∑–æ–≤—ã–µ –º–µ—Å—Ç–∞ (–Ω–∞—á–∏–Ω–∞—è —Å –∫–æ–ª–æ–Ω–∫–∏ 5)\n00183|       const cargoPlaces: CargoPlace[] = [];\n00184|       \n00185|       // –í —Ç–∞–±–ª–∏—Ü–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –¥–æ 7 –º–µ—Å—Ç (–ú–µ—Å—Ç–æ 1-7)\n00186|       // –ö–æ–ª–æ–Ω–∫–∏: ID(0), –ö–æ–¥(1), –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å(2), –¢–æ–≤–∞—Ä(3), –¶–µ–Ω–∞(4), \n00187|       // –ú–µ—Å—Ç–æ1: –í–µ—Å(5), –í—ã—Å–æ—Ç–∞(6), –ì–ª—É–±–∏–Ω–∞(7), –î–ª–∏–Ω–∞(8)\n00188|       // –ú–µ—Å—Ç–æ2: –í–µ—Å(9), –í—ã—Å–æ—Ç–∞(10), –ì–ª—É–±–∏–Ω–∞(11), –î–ª–∏–Ω–∞(12) –∏ —Ç.–¥.\n00189|       for (let placeNum = 1; placeNum <= 7; placeNum++) {\n00190|         const baseIndex = 5 + (placeNum - 1) * 4; // 5, 9, 13, 17, 21, 25, 29\n00191|         \n00192|         if (baseIndex + 3 < row.length) {\n00193|           const weight = parseFloat(row[baseIndex]) || 0;      // –í–µ—Å\n00194|           const height = parseFloat(row[baseIndex + 1]) || 0;  // –í—ã—Å–æ—Ç–∞\n00195|           const depth = parseFloat(row[baseIndex + 2]) || 0;   // –ì–ª—É–±–∏–Ω–∞ (—à–∏—Ä–∏–Ω–∞)\n00196|           const length = parseFloat(row[baseIndex + 3]) || 0;  // –î–ª–∏–Ω–∞\n00197|           \n00198|           // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ –±–æ–ª—å—à–µ 0\n00199|           if (weight > 0 || height > 0 || depth > 0 || length > 0) {\n00200|             cargoPlaces.push({\n00201|               placeNumber: placeNum,\n00202|               weight,\n00203|               height,\n00204|               depth,  // –≤ —Ç–∞–±–ª–∏—Ü–µ —ç—Ç–æ \"–≥–ª—É–±–∏–Ω–∞\", –Ω–æ –º—ã –Ω–∞–∑—ã–≤–∞–µ–º depth\n00205|               length\n00206|             });\n00207|           }\n00208|         }\n00209|       }\n00210|       \n00211|       // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–¥—É–∫—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –∏–º—è –∏ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –≥—Ä—É–∑–æ–≤–æ–µ –º–µ—Å—Ç–æ\n00212|       if (name && cargoPlaces.length > 0) {\n00213|         products.push({\n00214|           id,\n00215|           externalCode,\n00216|           name: name.trim(),\n00217|           retailPrice,\n00218|           isActive,\n00219|           cargoPlaces\n00220|         });\n00221|       }\n00222|       \n00223|     } catch (error) {\n00224|       console.warn(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å—Ç—Ä–æ–∫–∏ ${i + 1}:`, error, row);\n00225|     }\n00226|   }\n00227|   \n00228|   // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –∏–º–µ–Ω–∏\n00229|   products.sort((a, b) => a.name.localeCompare(b.name, 'ru'));\n00230|   \n00231|   console.log(`‚úÖ –£—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ ${products.length} —Ç–æ–≤–∞—Ä–æ–≤`);\n00232|   return products;\n00233| }\n</file>",
    "metadata": {
      "preview": "import { NextRequest, NextResponse } from 'next/server';\n\n// –û—Ç–∫–ª—é—á–∞–µ–º —Å—Ç–∞—Ç–∏—á–µ—Å–∫—É—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –¥–ª—è —ç—Ç–æ–≥–æ API\nexport const dynamic = 'force-dynamic';\n\n// üîß –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –¥–ª—è –¥–∞–Ω–Ω—ã—Ö –º–µ–±–µ–ª–∏\ninterface CargoPlace {\n  placeNumber: number;\n  weight: number; // –∫–≥\n  height: number; // —Å–º\n  depth: number;  // —Å–º (—à–∏—Ä–∏–Ω–∞)\n  length: number; // —Å–º\n}\n\ninterface FurnitureProduct {\n  id: string;\n  externalCode: string;\n  name: string;\n  retailPrice: number;\n  isActive: boolean;"
    },
    "title": "app/api/furniture-products/route.ts",
    "time": {
      "start": 1759011582084,
      "end": 1759011582087
    }
  }
}