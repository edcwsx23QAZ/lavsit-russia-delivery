{
  "id": "prt_b230251e6001vS2pJpEBs5kFtT",
  "sessionID": "ses_4dcfe2ec6ffeGyMv3tDAZ25rFC",
  "messageID": "msg_b2302450e001iSou4wVaQrXERP",
  "type": "tool",
  "callID": "toolu_016NNda4LQyjU2nhgAcSz5Rk",
  "tool": "write",
  "state": {
    "status": "completed",
    "input": {
      "filePath": "/home/user/project/app/api/dellin-freight/route.ts",
      "content": "import { NextRequest, NextResponse } from 'next/server'\nimport { apiRequestWithTimeout, PerformanceMonitor } from '@/lib/api-utils'\n\n// –ö—ç—à –¥–ª—è freight types (24 —á–∞—Å–∞)\ninterface FreightCache {\n  data: any[];\n  timestamp: number;\n  ttl: number;\n}\n\nlet freightCache: FreightCache | null = null;\nconst CACHE_TTL = 24 * 60 * 60 * 1000; // 24 —á–∞—Å–∞\n\n/**\n * GET - –ü–æ–ª—É—á–µ–Ω–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞ –≥—Ä—É–∑–∞ \"–ú–µ–±–µ–ª—å\" –¥–ª—è –î–µ–ª–æ–≤—ã—Ö –õ–∏–Ω–∏–π\n * –í—Å–µ–≥–¥–∞ —Ñ–∏–∫—Å–∏—Ä—É–µ–º –ø–æ–∏—Å–∫ –ø–æ \"–ú–µ–±–µ–ª—å\" —Å–æ–≥–ª–∞—Å–Ω–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º\n */\nexport async function GET() {\n  const endTiming = PerformanceMonitor.startMeasurement('dellin_freight_get');\n  \n  try {\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à\n    const now = Date.now();\n    if (freightCache && (now - freightCache.timestamp) < freightCache.ttl) {\n      console.log('üì¶ –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ö–∞—Ä–∞–∫—Ç–µ—Ä –≥—Ä—É–∑–∞ –∏–∑ –∫—ç—à–∞');\n      const timing = endTiming();\n      return NextResponse.json({\n        success: true,\n        data: freightCache.data,\n        cached: true,\n        timing\n      }, {\n        headers: {\n          'Access-Control-Allow-Origin': '*',\n          'Access-Control-Allow-Methods': 'GET, POST',\n          'Access-Control-Allow-Headers': 'Content-Type',\n        },\n      });\n    }\n\n    console.log('üì¶ –ü–æ–ª—É—á–µ–Ω–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞ –≥—Ä—É–∑–∞ \"–ú–µ–±–µ–ª—å\" –æ—Ç API –î–µ–ª–æ–≤—ã—Ö –õ–∏–Ω–∏–π...');\n    \n    const appKey = process.env.DELLIN_APP_KEY || 'E6C50E91-8E93-440F-9CC6-DEF9F0D68F1B';\n    \n    // –ó–∞–ø—Ä–æ—Å –∫ API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞ –≥—Ä—É–∑–∞ \"–ú–µ–±–µ–ª—å\"\n    const response = await apiRequestWithTimeout('https://api.dellin.ru/v1/ftl/freight_types.json', {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n      },\n      body: JSON.stringify({\n        appKey: appKey,\n        search: '–ú–µ–±–µ–ª—å'\n      })\n    }, { timeout: 15000, retries: 2 });\n\n    if (!response.ok) {\n      console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞ –≥—Ä—É–∑–∞:', response.status, response.statusText);\n      endTiming();\n      return NextResponse.json(\n        { \n          error: '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞ –≥—Ä—É–∑–∞', \n          status: response.status,\n          details: response.statusText\n        },\n        { status: response.status }\n      );\n    }\n\n    const responseData = await response.json();\n    console.log('üì¶ –û—Ç–≤–µ—Ç API freight_types:', JSON.stringify(responseData, null, 2));\n\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –æ—Ç–≤–µ—Ç–∞\n    if (responseData.metadata?.status !== 200) {\n      console.error('‚ùå API –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É:', responseData.metadata?.status);\n      endTiming();\n      return NextResponse.json(\n        { \n          error: 'API –≤–µ—Ä–Ω—É–ª —Å—Ç–∞—Ç—É—Å –æ—à–∏–±–∫–∏',\n          apiStatus: responseData.metadata?.status,\n          details: responseData\n        },\n        { status: responseData.metadata?.status || 500 }\n      );\n    }\n\n    if (!responseData.data || !Array.isArray(responseData.data)) {\n      console.error('‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –æ—Ç–≤–µ—Ç–µ API');\n      endTiming();\n      return NextResponse.json(\n        { \n          error: '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö',\n          details: '–û–∂–∏–¥–∞–ª—Å—è –º–∞—Å—Å–∏–≤ data —Å —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞–º–∏ –≥—Ä—É–∑–∞'\n        },\n        { status: 500 }\n      );\n    }\n\n    const freightData = responseData.data;\n    console.log(`üì¶ –ü–æ–ª—É—á–µ–Ω–æ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–æ–≤ –≥—Ä—É–∑–∞ \"–ú–µ–±–µ–ª—å\": ${freightData.length}`);\n    \n    // –í—ã–≤–æ–¥–∏–º –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏\n    freightData.forEach((freight: any, index: number) => {\n      console.log(`  ${index + 1}. ${freight.name} ‚Üí UID: ${freight.uid}`);\n    });\n\n    // –ö—ç—à–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç\n    freightCache = {\n      data: freightData,\n      timestamp: now,\n      ttl: CACHE_TTL\n    };\n\n    const timing = endTiming();\n    return NextResponse.json({\n      success: true,\n      data: freightData,\n      cached: false,\n      search: '–ú–µ–±–µ–ª—å',\n      count: freightData.length,\n      generatedAt: responseData.metadata?.generated_at,\n      timing\n    }, {\n      headers: {\n        'Access-Control-Allow-Origin': '*',\n        'Access-Control-Allow-Methods': 'GET, POST',\n        'Access-Control-Allow-Headers': 'Content-Type',\n      },\n    });\n\n  } catch (error) {\n    endTiming();\n    console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞ –≥—Ä—É–∑–∞:', error);\n    return NextResponse.json(\n      { \n        error: '–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞ –≥—Ä—É–∑–∞',\n        details: error instanceof Error ? error.message : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'\n      },\n      { status: 500 }\n    );\n  }\n}\n\n/**\n * POST - –¢–µ—Å—Ç–æ–≤—ã–π –º–µ—Ç–æ–¥ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ API\n */\nexport async function POST(request: NextRequest) {\n  const endTiming = PerformanceMonitor.startMeasurement('dellin_freight_post');\n  \n  try {\n    const body = await request.json();\n    console.log('üöõ Dellin Freight API POST –∑–∞–ø—Ä–æ—Å:', JSON.stringify(body, null, 2));\n    \n    // Handle test method\n    if (body.method === 'test') {\n      console.log('üß™ Dellin Freight API —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å');\n      const timing = endTiming();\n      return NextResponse.json({ \n        status: 'OK', \n        service: '–î–µ–ª–æ–≤—ã–µ –õ–∏–Ω–∏–∏ - –•–∞—Ä–∞–∫—Ç–µ—Ä –≥—Ä—É–∑–∞',\n        message: 'API —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞ –≥—Ä—É–∑–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ',\n        timestamp: new Date().toISOString(),\n        defaultSearch: '–ú–µ–±–µ–ª—å',\n        endpoints: {\n          getFreightTypes: '/api/dellin-freight (GET)',\n          test: '/api/dellin-freight (POST)'\n        },\n        timing\n      });\n    }\n\n    // –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º GET endpoint\n    const getResponse = await GET();\n    const timing = endTiming();\n    \n    if (getResponse.status === 200) {\n      const getData = await getResponse.json();\n      return NextResponse.json({ \n        success: true,\n        data: getData.data,\n        timing,\n        requestMethod: body.method || 'get_freight_types',\n        workflow: 'API –î–õ ‚Üí freight_types ‚Üí –ø–æ–∏—Å–∫ \"–ú–µ–±–µ–ª—å\" ‚Üí –ø–æ–ª—É—á–∏—Ç—å UID'\n      }, {\n        headers: {\n          'Access-Control-Allow-Origin': '*',\n          'Access-Control-Allow-Methods': 'GET, POST',\n          'Access-Control-Allow-Headers': 'Content-Type',\n        },\n      });\n    } else {\n      const errorData = await getResponse.json();\n      return NextResponse.json(errorData, { status: getResponse.status });\n    }\n\n  } catch (error) {\n    endTiming();\n    console.error('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ Dellin Freight API:', error);\n    \n    return NextResponse.json({ \n      error: '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞',\n      details: error instanceof Error ? error.message : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞',\n      type: error instanceof Error ? error.name : 'Unknown'\n    }, { status: 500 });\n  }\n}\n\nexport async function OPTIONS() {\n  return new NextResponse(null, {\n    status: 200,\n    headers: {\n      'Access-Control-Allow-Origin': '*',\n      'Access-Control-Allow-Methods': 'GET, POST',\n      'Access-Control-Allow-Headers': 'Content-Type',\n    },\n  })\n}\n"
    },
    "output": "",
    "title": "app/api/dellin-freight/route.ts",
    "metadata": {
      "diagnostics": {},
      "filepath": "/home/user/project/app/api/dellin-freight/route.ts",
      "exists": false
    },
    "time": {
      "start": 1765818940484,
      "end": 1765818940503
    }
  }
}