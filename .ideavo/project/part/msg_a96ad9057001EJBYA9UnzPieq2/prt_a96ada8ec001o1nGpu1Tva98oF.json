{
  "id": "prt_a96ada8ec001o1nGpu1Tva98oF",
  "sessionID": "ses_6852784ecffeuHwynj83p2lr14",
  "messageID": "msg_a96ad9057001EJBYA9UnzPieq2",
  "type": "tool",
  "callID": "call_47414599",
  "tool": "read",
  "state": {
    "status": "completed",
    "input": {
      "filePath": "app/page.tsx",
      "offset": 3890
    },
    "output": "<file>\n03891|       let intercityPrice = 0;\n03892|       let derivalPrice = 0;\n03893|       let arrivalPrice = 0;\n03894|       let packagingPrice = 0;\n03895|       // packagingPremiums больше не используются - надбавки включены в pkg.price\n03896|       let insurancePrice = 0;\n03897|       \n03898|       // Межтерминальная перевозка\n03899|       if (calc.details?.intercity?.price) {\n03900|         intercityPrice = calc.details.intercity.price;\n03901|         details.push({\n03902|           service: 'Межтерминальная перевозка',\n03903|           description: `${form.fromCity} - ${form.toCity}`,\n03904|           price: intercityPrice\n03905|         });\n03906|       }\n03907|       \n03908|       // Забор груза\n03909|       if (calc.details?.derival?.price) {\n03910|         derivalPrice = calc.details.derival.price;\n03911|         details.push({\n03912|           service: 'Забор груза',\n03913|           description: 'От адреса',\n03914|           price: derivalPrice\n03915|         });\n03916|       }\n03917|       \n03918|       // Доставка груза\n03919|       if (calc.details?.arrival?.price) {\n03920|         arrivalPrice = calc.details.arrival.price;\n03921|         details.push({\n03922|           service: 'Отвоз груза',\n03923|           description: 'До адреса',\n03924|           price: arrivalPrice\n03925|         });\n03926|       }\n03927|       \n03928|       // Упаковка (надбавки уже включены в pkg.price, но показываем их для детализации)\n03929|       if (form.needPackaging && calc.details?.packages) {\n03930|         Object.entries(calc.details?.packages || {}).forEach(([key, pkg]: [string, any]) => {\n03931|           if (pkg.price && pkg.price > 0) {\n03932|             // Вычисляем базовую цену упаковки (без надбавок) для отображения\n03933|             let basePkgPrice = pkg.price;\n03934|             let totalPremiums = 0;\n03935|             \n03936|             if (pkg.premiumDetails && Array.isArray(pkg.premiumDetails)) {\n03937|               totalPremiums = pkg.premiumDetails.reduce((sum: number, premium: any) => \n03938|                 sum + (premium.value || 0), 0);\n03939|               basePkgPrice = pkg.price - totalPremiums;\n03940|             }\n03941|             \n03942|             packagingPrice += pkg.price; // В общую сумму добавляем полную цену\n03943|             \n03944|             // Показываем базовую упаковку\n03945|             details.push({\n03946|               service: 'Упаковка груза',\n03947|               description: 'Упаковать в комплекс «обрешётка + амортизация»',\n03948|               price: basePkgPrice\n03949|             });\n03950|             \n03951|             // Показываем надбавки отдельно (для детализации, но не добавляем к общей сумме)\n03952|             if (pkg.premiumDetails && Array.isArray(pkg.premiumDetails)) {\n03953|               pkg.premiumDetails.forEach((premium: any) => {\n03954|                 if (premium.value && premium.value > 0) {\n03955|                   details.push({\n03956|                     service: 'Надбавка к упаковке',\n03957|                     description: premium.name || 'Дополнительная надбавка',\n03958|                     price: premium.value\n03959|                   });\n03960|                 }\n03961|               });\n03962|             }\n03963|           }\n03964|         });\n03965|       }\n03966|       \n03967|       // Страхование\n03968|       if (form.needInsurance && calc.details?.insurance) {\n03969|         insurancePrice = calc.details.insurance;\n03970|         details.push({\n03971|           service: 'Страхование груза',\n03972|           description: `На сумму ${form.declaredValue.toLocaleString()} ₽`,\n03973|           price: insurancePrice\n03974|         });\n03975|       }\n03976|       \n03977|       // Дополнительные услуги\n03978|       details.push({\n03979|         service: 'Доп.услуги',\n03980|         description: 'Информирование о статусе груза',\n03981|         price: 15\n03982|       });\n03983|       \n03984|       // Если есть расхождение между суммой компонентов и общей стоимостью, добавляем остаток\n03985|       const calculatedSum = intercityPrice + derivalPrice + arrivalPrice + packagingPrice + insurancePrice + 15;\n03986|       const remainder = basePrice - calculatedSum;\n03987|       \n03988|       if (Math.abs(remainder) > 1) { // Если расхождение больше 1 рубля\n03989|         details.push({\n03990|           service: remainder > 0 ? 'Прочие услуги' : 'Скидка',\n03991|           description: 'Дополнительные сборы и корректировки',\n03992|           price: remainder\n03993|         });\n03994|       }\n03995|     } else if (calc.company === 'Nord Wheel' && calc.details) {\n03996|       // Расшифровка для Nord Wheel согласно требованиям\n03997|       if (calc.details.totalCost) {\n03998|         details.push({\n03999|           service: 'Общая стоимость доставки',\n04000|           description: '',\n04001|           price: calc.details.totalCost\n04002|         });\n04003|       }\n04004|       if (calc.details.deliveryCost) {\n04005|         details.push({\n04006|           service: 'Стоимость перевозки',\n04007|           description: '',\n04008|           price: calc.details.deliveryCost\n04009|         });\n04010|       }\n04011|       if (calc.details.terminalCost) {\n04012|         details.push({\n04013|           service: 'Стоимость межтерминальной перевозки',\n04014|           description: '',\n04015|           price: calc.details.terminalCost\n04016|         });\n04017|       }\n04018|       if (calc.details.pickupCost) {\n04019|         details.push({\n04020|           service: 'Стоимость забора',\n04021|           description: '',\n04022|           price: calc.details.pickupCost\n04023|         });\n04024|       }\n04025|       if (calc.details.deliveryToDoorCost) {\n04026|         details.push({\n04027|           service: 'Стоимость доставки до двери',\n04028|           description: '',\n04029|           price: calc.details.deliveryToDoorCost\n04030|         });\n04031|       }\n04032|       if (calc.details.additionalServices && calc.details.additionalServices > 0) {\n04033|         details.push({\n04034|           service: 'Стоимость доп.услуг',\n04035|           description: '',\n04036|           price: calc.details.additionalServices\n04037|         });\n04038|       }\n04039| \n04040|     } else if (calc.company === 'ПЭК' && calc.details?.services) {\n04041|       // Для ПЭК используем данные из API\n04042|       calc.details.services.forEach((service: any) => {\n04043|         if (service.price > 0) {\n04044|           details.push({\n04045|             service: service.name || 'Услуга ПЭК',\n04046|             description: service.description || '',\n04047|             price: service.price\n04048|           });\n04049|         }\n04050|       });\n04051|     } else if (calc.company === 'СДЭК' && calc.details) {\n04052|       const cdekServiceNames: Record<string, string> = {\n04053|         'INSURANCE': 'Страхование груза',\n04054|         'HEAVY_CARGO': 'Тяжеловесный груз',\n04055|         'DELIVERY_TO_DOOR': 'Доставка до двери',\n04056|         'PICKUP_FROM_SENDER': 'Забор от отправителя',\n04057|         'PACKAGE': 'Упаковка',\n04058|         'TRYING_ON': 'Примерка на дому',\n04059|         'PART_DELIVERY': 'Частичная доставка'\n04060|       };\n04061| \n04062|       if (calc.details.services && calc.details.services.length > 0) {\n04063|         calc.details.services.forEach((service: any) => {\n04064|           const serviceName = cdekServiceNames[service.code] || service.code || 'Услуга СДЭК';\n04065|           const servicePrice = service.total_sum || service.sum || 0;\n04066|           \n04067|           if (servicePrice > 0) {\n04068|             details.push({\n04069|               service: serviceName,\n04070|               description: service.code === 'HEAVY_CARGO' \n04071|                 ? `Сбор за габаритный груз (расчетный вес: ${(calc.details.weight_calc / 1000).toFixed(0)} кг)`\n04072|                 : service.code === 'INSURANCE'\n04073|                 ? `Объявленная стоимость: ${form.declaredValue?.toLocaleString() || 0} ₽`\n04074|                 : '',\n04075|               price: servicePrice\n04076|             });\n04077|           }\n04078|         });\n04079|         \n04080|         if (calc.details.delivery_sum && calc.details.total_sum) {\n04081|           details.push({\n04082|             service: '─────────────────────────',\n04083|             description: '',\n04084|             price: 0\n04085|           });\n04086|           details.push({\n04087|             service: 'Стоимость доставки',\n04088|             description: calc.details.tariff_name || 'Перевозка',\n04089|             price: Math.round(calc.details.delivery_sum)\n04090|           });\n04091|           \n04092|           const additionalSum = calc.details.services.reduce((sum: number, s: any) => \n04093|             sum + (s.total_sum || s.sum || 0), 0\n04094|           );\n04095|           \n04096|           if (additionalSum > 0) {\n04097|             details.push({\n04098|               service: 'Дополнительные услуги',\n04099|               description: 'Доп. сборы',\n04100|               price: Math.round(additionalSum)\n04101|             });\n04102|           }\n04103|           \n04104|           details.push({\n04105|             service: 'ИТОГО',\n04106|             description: 'К оплате',\n04107|             price: Math.round(calc.details.total_sum)\n04108|           });\n04109|         }\n04110|       } else {\n04111|         details.push({\n04112|           service: 'Тариф',\n04113|           description: calc.details.tariff_name || 'Не указан',\n04114|           price: calc.price\n04115|         });\n04116|         \n04117|         if (calc.details.delivery_mode) {\n04118|           details.push({\n04119|             service: 'Режим доставки',\n04120|             description: calc.details.delivery_mode,\n04121|             price: 0\n04122|           });\n04123|         }\n04124|       }\n04125|       \n04126|       if (calc.details.period_min && calc.details.period_max) {\n04127|         details.push({\n04128|           service: 'Срок доставки',\n04129|           description: `${calc.details.period_min}-${calc.details.period_max} дней`,\n04130|           price: 0\n04131|         });\n04132|       }\n04133|       \n04134|       if (calc.details.weight_calc) {\n04135|         details.push({\n04136|           service: 'Расчетный вес',\n04137|           description: `${calc.details.weight_calc} кг`,\n04138|           price: 0\n04139|         });\n04140|       }\n04141|     } else if (calc.company === 'Возовоз' && calc.details?.service) {\n04142|       // ✅ Детализация для Возовоз на основе API ответа\n04143|       const basePrice = calc.details.basePrice || 0;\n04144|       const finalPrice = calc.details.price || calc.price || 0;\n04145|       const totalDiscount = basePrice - finalPrice;\n04146|       \n04147|       // Показываем каждую услугу с базовой ценой и скидкой\n04148|       calc.details.service.forEach((service: any) => {\n04149|         const serviceDiscount = (service.basePrice || 0) - (service.price || 0);\n04150|         \n04151|         // Основная услуга\n04152|         details.push({\n04153|           service: service.name || 'Услуга Возовоз',\n04154|           description: '',\n04155|           price: service.price || 0\n04156|         });\n04157|         \n04158|         // Скидка на услугу (если есть)\n04159|         if (serviceDiscount > 0) {\n04160|           details.push({\n04161|             service: `Скидка на ${service.name?.toLowerCase() || 'услугу'}`,\n04162|             description: `${(service.basePrice || 0).toLocaleString()} - ${(service.price || 0).toLocaleString()}`,\n04163|             price: -serviceDiscount\n04164|           });\n04165|         }\n04166|       });\n04167|       \n04168|       // Итоговая строка с общими скидками\n04169|       if (totalDiscount > 0) {\n04170|         details.push({\n04171|           service: '─────────────────────────',\n04172|           description: '',\n04173|           price: 0\n04174|         });\n04175|         details.push({\n04176|           service: 'Базовая стоимость',\n04177|           description: 'До применения скидок',\n04178|           price: basePrice\n04179|         });\n04180|         details.push({\n04181|           service: 'Общие скидки',\n04182|           description: `Экономия ${totalDiscount.toLocaleString()} ₽`,\n04183|           price: -totalDiscount\n04184|         });\n04185|         details.push({\n04186|           service: 'ИТОГО',\n04187|           description: 'К оплате',\n04188|           price: finalPrice\n04189|         });\n04190|       }\n04191|     } else if (calc.company === 'КИТ' && calc.details?.services) {\n04192|       calc.details.services.forEach((service: any) => {\n04193|         details.push({\n04194|           service: service.name || 'Услуга КИТ',\n04195|           description: service.code || '',\n04196|           price: service.price || 0\n04197|         });\n04198|       });\n04199|       \n04200|       if (calc.details.tariff_name) {\n04201|         details.push({\n04202|           service: '─────────────────────────',\n04203|           description: '',\n04204|           price: 0\n04205|         });\n04206|         details.push({\n04207|           service: 'Тариф',\n04208|           description: calc.details.tariff_name,\n04209|           price: 0\n04210|         });\n04211|         details.push({\n04212|           service: 'ИТОГО',\n04213|           description: calc.details.currency || 'RUB',\n04214|           price: calc.price\n04215|         });\n04216|       }\n04217|     } else {\n04218|       // Для других ТК - базовая информация\n04219|       details.push({\n04220|         service: 'Доставка груза',\n04221|         description: `${form.fromCity} - ${form.toCity}`,\n04222|         price: calc.price\n04223|       });\n04224|       \n04225|       if (form.needInsurance && form.declaredValue > 0) {\n04226|         details.push({\n04227|           service: 'Страхование',\n04228|           description: `На сумму ${form.declaredValue.toLocaleString()} ₽`,\n04229|           price: Math.round(form.declaredValue * 0.02)\n04230|         });\n04231|       }\n04232|       \n04233|       if (form.needPackaging) {\n04234|         const totalWeight = form.cargos.reduce((sum, cargo) => sum + cargo.weight, 0);\n04235|         details.push({\n04236|           service: 'Упаковка',\n04237|           description: '',\n04238|           price: Math.round(totalWeight * 30)\n04239|         });\n04240|       }\n04241|     }\n04242|     \n04243|     return details;\n04244|   } catch (globalError) {\n04245|     console.error('❌ ГЛОБАЛЬНАЯ ОШИБКА в parseCalculationDetails:', globalError);\n04246|     console.error('❌ Стек ошибки:', globalError instanceof Error ? globalError.stack : 'Нет стека');\n04247|     console.log('❌ calc object:', calc);\n04248|     // Возвращаем минимальные данные при любой ошибке\n04249|     return [{\n04250|       service: 'Доставка',\n04251|       description: 'Ошибка обработки деталей расчета',\n04252|       price: calc?.price || 0\n04253|     }];\n04254|   }\n04255| };\n04256| \n04257|   // Показываем загрузку пока состояние не загрузилось (предотвращает ошибку гидратации)\n04258|   if (!isLoaded) {\n04259|     return (\n04260|       <div className=\"min-h-screen bg-gray-900 text-white p-4 relative flex items-center justify-center\">\n04261|         <div className=\"text-center\">\n04262|           <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-400 mx-auto mb-4\"></div>\n04263|           <p className=\"text-blue-400\">Загрузка...</p>\n04264|         </div>\n04265|       </div>\n04266|     );\n04267|   }\n04268| \n04269|   return (\n04270|     <div className=\"min-h-screen bg-gray-900 text-white p-4 relative\">\n04271|       <div className=\"max-w-7xl mx-auto\">\n04272|         <div className=\"flex items-center justify-between mb-3\">\n04273|           <h1 className=\"text-xl font-bold text-blue-400\">\n04274|             Междугородняя доставка Лавсит\n04275|           </h1>\n04276|           \n04277|           {/* Индикатор сохранения */}\n04278|           <div className=\"flex items-center gap-4\">\n04279|             {isFormChanged ? (\n04280|               <div className=\"flex items-center gap-2 text-yellow-400 text-sm\">\n04281|                 <div className=\"w-2 h-2 bg-yellow-400 rounded-full animate-pulse\"></div>\n04282|                 Сохранение...\n04283|               </div>\n04284|             ) : lastSaveTime ? (\n04285|               <div className=\"flex items-center gap-2 text-green-400 text-sm\">\n04286|                 <div className=\"w-2 h-2 bg-green-400 rounded-full\"></div>\n04287|                 Сохранено {lastSaveTime.toLocaleTimeString()}\n04288|               </div>\n04289|             ) : hasStoredFormData() ? (\n04290|               <div className=\"flex items-center gap-2 text-blue-400 text-sm\">\n04291|                 <div className=\"w-2 h-2 bg-blue-400 rounded-full\"></div>\n04292|                 Данные восстановлены\n04293|               </div>\n04294|             ) : null}\n04295|             \n04296|             {/* Кнопка очистки данных */}\n04297|             {hasStoredFormData() && (\n04298|               <Button\n04299|                 onClick={() => {\n04300|                   if (confirm('Очистить все сохраненные данные формы?')) {\n04301|                     clearFormData();\n04302|                     setForm(initialFormState);\n04303|                     setLastSaveTime(null);\n04304|                     setIsFormChanged(false);\n04305|                   }\n04306|                 }}\n04307|                 variant=\"outline\"\n04308|                 size=\"sm\"\n04309|                 className=\"border-red-500 text-red-400 hover:bg-red-900/20\"\n04310|               >\n04311|                 <Trash2 className=\"h-3 w-3 mr-1\" />\n04312|                 Очистить\n04313|               </Button>\n04314|             )}\n04315|           </div>\n04316|         </div>\n04317|         \n04318|         {/* Кнопки диагностики и документации */}\n04319|         <div className=\"flex justify-end gap-2 mb-4\">\n04320|           <Button \n04321|             onClick={() => window.open('/diagnostic?tab=api', '_blank')}\n04322|             variant=\"outline\" \n04323|             className=\"border-green-500 text-green-400 hover:bg-green-900/20\"\n04324|           >\n04325|             <Settings className=\"h-4 w-4 mr-2\" />\n04326|             Все API\n04327|           </Button>\n04328|           <Button \n04329|             onClick={() => window.open('/diagnostic?tab=docs', '_blank')}\n04330|             variant=\"outline\" \n04331|             className=\"border-purple-500 text-purple-400 hover:bg-purple-900/20\"\n04332|           >\n04333|             <Package2 className=\"h-4 w-4 mr-2\" />\n04334|             Документация\n04335|           </Button>\n04336|           <Button \n04337|             onClick={() => window.open('/diagnostic', '_blank')}\n04338|             variant=\"outline\" \n04339|             className=\"border-blue-500 text-blue-400 hover:bg-blue-900/20\"\n04340|           >\n04341|             <Settings className=\"h-4 w-4 mr-2\" />\n04342|             Диагностика\n04343|           </Button>\n04344|         </div>\n04345|         \n04346|         <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-3 h-[85vh]\">\n04347|           {/* Левая часть - форма */}\n04348|           <div className=\"space-y-2 overflow-y-auto pr-2\">\n04349|             {/* Каталог мебели */}\n04350|             <Card className=\"bg-gray-800 border-gray-700\">\n04351|               <CardHeader className=\"pb-2\">\n04352|                 <CardTitle className=\"text-white flex items-center gap-2 text-sm\">\n04353|                   <Package2 className=\"h-3 w-3\" />\n04354|                   Каталог мебели\n04355|                 </CardTitle>\n04356|               </CardHeader>\n04357|               <CardContent className=\"space-y-2\">\n04358|                 {/* Поиск и добавление товаров */}\n04359|                 <ProductSearch \n04360|                   onProductAdd={handleProductAdd}\n04361|                   disabled={calculating}\n04362|                 />\n04363|                 \n04364|                 {/* Управление добавленными товарами */}\n04365|                 <ProductManager\n04366|                   products={form.selectedProducts}\n04367|                   onQuantityChange={handleProductQuantityChange}\n04368|                   onProductRemove={handleProductRemove}\n04369|                   disabled={calculating}\n04370|                 />\n04371|               </CardContent>\n04372|             </Card>\n04373| \n04374|             {/* Грузы */}\n04375|             <Card className=\"bg-gray-800 border-gray-700\">\n04376|               <CardHeader className=\"pb-2\">\n04377|                 <CardTitle className=\"text-white flex items-center gap-2 text-sm\">\n04378|                   <Truck className=\"h-3 w-3\" />\n04379|                   Грузы\n04380|                 </CardTitle>\n04381|               </CardHeader>\n04382|               <CardContent className=\"space-y-2\">\n04383|                 {groupCargosForDisplay(form.cargos).map((group, groupIndex) => (\n04384|                    <div key={`group_${groupIndex}`} className=\"border border-gray-600 rounded p-2\">\n04385|                     <div className=\"flex justify-between items-center mb-2\">\n04386|                       <h4 className=\"text-sm font-medium text-white\">\n04387|                         {group.isEmpty ? (\n04388|                           `Груз №${group.indices[0] + 1}`\n04389|                         ) : group.quantity === 1 ? (\n04390|                           `Груз №${group.indices[0] + 1}`\n04391|                         ) : (\n04392|                           `Груз №${group.indices[0] + 1} - ${group.quantity} одинаковых места`\n04393|                         )}\n04394|                       </h4>\n04395|                       {form.cargos.length > 1 && group.quantity === 1 && (\n04396|                         <Button\n04397|                           variant=\"destructive\"\n04398|                           size=\"sm\"\n04399|                           onClick={() => removeCargo(form.cargos[group.indices[0]].id)}\n04400|                           className=\"h-6 text-xs\"\n04401|                         >\n04402|                           Удалить\n04403|                         </Button>\n04404|                       )}\n04405|                       {group.quantity > 1 && (\n04406|                         <Badge variant=\"secondary\" className=\"text-xs\">\n04407|                           {group.quantity} шт.\n04408|                         </Badge>\n04409|                       )}\n04410|                     </div>\n04411|                     \n04412|                     {group.isEmpty || group.quantity === 1 ? (\n04413|                       // Показываем поля ввода для пустых грузов или единичных\n04414|                       <div className=\"grid grid-cols-2 gap-2\">\n04415|                         <div>\n04416|                           <Label className=\"text-white text-xs\">Длина (см)</Label>\n04417|                           <Input\n04418|                             type=\"number\"\n04419|                             value={form.cargos[group.indices[0]].length || ''}\n04420|                             onChange={(e) => updateCargo(form.cargos[group.indices[0]].id, 'length', Number(e.target.value))}\n04421|                             className=\"bg-gray-700 border-gray-600 h-8 text-white\"\n04422|                           />\n04423|                         </div>\n04424|                         <div>\n04425|                           <Label className=\"text-white text-xs\">Ширина (см)</Label>\n04426|                           <Input\n04427|                             type=\"number\"\n04428|                             value={form.cargos[group.indices[0]].width || ''}\n04429|                             onChange={(e) => updateCargo(form.cargos[group.indices[0]].id, 'width', Number(e.target.value))}\n04430|                             className=\"bg-gray-700 border-gray-600 h-8 text-white\"\n04431|                           />\n04432|                         </div>\n04433|                         <div>\n04434|                           <Label className=\"text-white text-xs\">Высота (см)</Label>\n04435|                           <Input\n04436|                             type=\"number\"\n04437|                             value={form.cargos[group.indices[0]].height || ''}\n04438|                             onChange={(e) => updateCargo(form.cargos[group.indices[0]].id, 'height', Number(e.target.value))}\n04439|                             className=\"bg-gray-700 border-gray-600 h-8 text-white\"\n04440|                           />\n04441|                         </div>\n04442|                         <div>\n04443|                           <Label className=\"text-white text-xs\">Вес (кг)</Label>\n04444|                           <Input\n04445|                             type=\"number\"\n04446|                             value={form.cargos[group.indices[0]].weight || ''}\n04447|                             onChange={(e) => updateCargo(form.cargos[group.indices[0]].id, 'weight', Number(e.target.value))}\n04448|                             className=\"bg-gray-700 border-gray-600 h-8 text-white\"\n04449|                           />\n04450|                         </div>\n04451|                       </div>\n04452|                     ) : (\n04453|                       // Показываем только информацию для групп\n04454|                       <div className=\"grid grid-cols-2 gap-2 text-sm text-gray-300\">\n04455|                         <div>Длина: {group.length} см</div>\n04456|                         <div>Ширина: {group.width} см</div>\n04457|                         <div>Высота: {group.height} см</div>\n04458|                         <div>Вес: {group.weight} кг</div>\n04459|                         <div className=\"col-span-2 text-xs text-blue-300 mt-1\">\n04460|                           Общий вес: {(group.weight * group.quantity).toFixed(1)} кг, \n04461|                           объем: {((group.length * group.width * group.height * group.quantity) / 1000000).toFixed(3)} м³\n04462|                         </div>\n04463|                       </div>\n04464|                     )}\n04465|                   </div>\n04466|                 ))}\n04467|                  <Button onClick={addCargo} className=\"w-full h-7 text-xs\" variant=\"outline\">\n04468|                   <Plus className=\"h-3 w-3 mr-1\" />\n04469|                   Добавить груз\n04470|                 </Button>\n04471|               </CardContent>\n04472|             </Card>\n04473| \n04474|             {/* Маршрут */}\n04475|             <Card className=\"bg-gray-800 border-gray-700\">\n04476|               <CardHeader className=\"pb-2\">\n04477|                 <CardTitle className=\"text-white flex items-center gap-2 text-sm\">\n04478|                   <Map className=\"h-3 w-3\" />\n04479|                   Маршрут\n04480|                 </CardTitle>\n04481|               </CardHeader>\n04482|               <CardContent className=\"space-y-2\">\n04483|                 {/* Отправление */}\n04484|                 <div className=\"space-y-2\">\n04485|                   <Label className=\"text-sm font-medium text-white\">Отправление</Label>\n04486|                   <div className=\"flex gap-3 flex-wrap\">\n04487|                     <label className=\"flex items-center space-x-1\">\n04488|                       <input\n04489|                         type=\"radio\"\n04490|                         name=\"fromDelivery\"\n04491|                         checked={form.fromTerminal}\n04492|                         onChange={() => setForm(prev => ({ ...prev, fromTerminal: true, fromAddressDelivery: false, fromLavsiteWarehouse: false }))}\n04493|                       />\n04494|                       <span className=\"text-white text-xs\">От терминала</span>\n04495|                     </label>\n04496|                     <label className=\"flex items-center space-x-1\">\n04497|                       <input\n04498|                         type=\"radio\"\n04499|                         name=\"fromDelivery\"\n04500|                         checked={form.fromAddressDelivery && !form.fromLavsiteWarehouse}\n04501|                         onChange={() => setForm(prev => ({ ...prev, fromTerminal: false, fromAddressDelivery: true, fromLavsiteWarehouse: false }))}\n04502|                       />\n04503|                       <span className=\"text-white text-xs\">От адреса</span>\n04504|                     </label>\n04505|                     <label className=\"flex items-center space-x-1\">\n04506|                       <Checkbox\n04507|                         id=\"lavsiteWarehouse\"\n04508|                         checked={form.fromLavsiteWarehouse}\n04509|                         onCheckedChange={handleLavsiteWarehouseChange}\n04510|                       />\n04511|                       <span className=\"text-white text-xs cursor-pointer\">Со склада Лавсит</span>\n04512|                     </label>\n04513|                   </div>\n04514|                   \n04515|                   <div>\n04516|                     <Label className=\"text-white text-xs\">Город отправления</Label>\n04517|                     <Input\n04518|                       value={form.fromCity}\n04519|                       onChange={(e) => !form.fromLavsiteWarehouse && handleAddressChange('fromCity', e.target.value, e.target)}\n04520|                       placeholder=\"Начните вводить город\"\n04521|                       disabled={form.fromLavsiteWarehouse}\n04522|                       className={`bg-gray-700 border-gray-600 h-7 text-white text-xs ${form.fromLavsiteWarehouse ? 'opacity-50 cursor-not-allowed' : ''}`}\n04523|                     />\n04524|                   </div>\n04525|                   \n04526|                   {form.fromAddressDelivery && (\n04527|                     <div>\n04528|                       <Label className=\"text-white text-xs\">Адрес отправления</Label>\n04529|                       <Input\n04530|                         value={form.fromAddress}\n04531|                         onChange={(e) => !form.fromLavsiteWarehouse && handleAddressChange('fromAddress', e.target.value, e.target)}\n04532|                         placeholder=\"Начните вводить адрес\"\n04533|                         disabled={form.fromLavsiteWarehouse}\n04534|                         className={`bg-gray-700 border-gray-600 h-7 text-white text-xs ${form.fromLavsiteWarehouse ? 'opacity-50 cursor-not-allowed' : ''}`}\n04535|                       />\n04536|                     </div>\n04537|                   )}\n04538|                 </div>\n04539| \n04540|                 {/* Назначение */}\n04541|                 <div className=\"space-y-2\">\n04542|                   <Label className=\"text-sm font-medium text-white\">Назначение</Label>\n04543|                   <div className=\"flex gap-3 flex-wrap\">\n04544|                     <label className=\"flex items-center space-x-1\">\n04545|                       <input\n04546|                         type=\"radio\"\n04547|                         name=\"toDelivery\"\n04548|                         checked={form.toTerminal}\n04549|                         onChange={() => setForm(prev => ({ ...prev, toTerminal: true, toAddressDelivery: false }))}\n04550|                       />\n04551|                       <span className=\"text-white text-xs\">До терминала</span>\n04552|                     </label>\n04553|                     <label className=\"flex items-center space-x-1\">\n04554|                       <input\n04555|                         type=\"radio\"\n04556|                         name=\"toDelivery\"\n04557|                         checked={form.toAddressDelivery}\n04558|                         onChange={() => setForm(prev => ({ ...prev, toTerminal: false, toAddressDelivery: true }))}\n04559|                       />\n04560|                       <span className=\"text-white text-xs\">До адреса</span>\n04561|                     </label>\n04562|                   </div>\n04563|                   \n04564|                   <div>\n04565|                     <Label className=\"text-white text-xs\">Город назначения</Label>\n04566|                     <Input\n04567|                       value={form.toCity}\n04568|                       onChange={(e) => handleAddressChange('toCity', e.target.value, e.target)}\n04569|                       placeholder=\"Начните вводить город\"\n04570|                       className=\"bg-gray-700 border-gray-600 h-7 text-white text-xs\"\n04571|                     />\n04572|                   </div>\n04573|                   \n04574|                   {form.toAddressDelivery && (\n04575|                     <div>\n04576|                       <Label className=\"text-white text-xs\">Адрес назначения</Label>\n04577|                       <Input\n04578|                         value={form.toAddress}\n04579|                         onChange={(e) => handleAddressChange('toAddress', e.target.value, e.target)}\n04580|                         placeholder=\"Начните вводить адрес\"\n04581|                         className=\"bg-gray-700 border-gray-600 h-7 text-white text-xs\"\n04582|                       />\n04583|                     </div>\n04584|                   )}\n04585|                 </div>\n04586| \n04587|                 <div>\n04588|                   <Label className=\"text-white text-xs\">Объявленная стоимость (руб.)</Label>\n04589|                   <Input\n04590|                     type=\"number\"\n04591|                     value={form.declaredValue || ''}\n04592|                     onChange={(e) => setForm(prev => ({ ...prev, declaredValue: Number(e.target.value) }))}\n04593|                     className=\"bg-gray-700 border-gray-600 h-7 text-white text-xs\"\n04594|                   />\n04595|                 </div>\n04596|                 \n04597|                 <div className=\"space-y-2\">\n04598|                   <div className=\"flex items-center space-x-2\">\n04599|                     <Checkbox\n04600|                       id=\"packaging\"\n04601|                       checked={form.needPackaging}\n04602|                       onCheckedChange={(checked) => setForm(prev => ({ ...prev, needPackaging: checked as boolean }))}\n04603|                       className=\"border-white data-[state=checked]:bg-white data-[state=checked]:text-black\"\n04604|                     />\n04605|                     <Label htmlFor=\"packaging\" className=\"text-white text-xs\">Требуется упаковка</Label>\n04606|                   </div>\n04607|                   \n04608|                   <div className=\"flex items-center space-x-2\">\n04609|                     <Checkbox\n04610|                       id=\"insurance\"\n04611|                       checked={form.needInsurance}\n04612|                       onCheckedChange={(checked) => setForm(prev => ({ ...prev, needInsurance: checked as boolean }))}\n04613|                       className=\"border-white data-[state=checked]:bg-white data-[state=checked]:text-black\"\n04614|                     />\n04615|                     <Label htmlFor=\"insurance\" className=\"text-white text-xs\">Требуется страховка</Label>\n04616|                   </div>\n04617|                   \n04618|                   <div className=\"flex items-center space-x-2\">\n04619|                     <Checkbox\n04620|                       id=\"loading\"\n04621|                       checked={form.needLoading}\n04622|                       onCheckedChange={(checked) => setForm(prev => ({ ...prev, needLoading: checked as boolean }))}\n04623|                       className=\"border-white data-[state=checked]:bg-white data-[state=checked]:text-black\"\n04624|                     />\n04625|                     <Label htmlFor=\"loading\" className=\"text-white text-xs\">Требуется погрузка/разгрузка</Label>\n04626|                   </div>\n04627|                   \n04628|                   <div className=\"flex items-center space-x-2\">\n04629|                     <Checkbox\n04630|                       id=\"carry\"\n04631|                       checked={form.needCarry}\n04632|                       onCheckedChange={(checked) => setForm(prev => ({ ...prev, needCarry: checked as boolean }))}\n04633|                       className=\"border-white data-[state=checked]:bg-white data-[state=checked]:text-black\"\n04634|                     />\n04635|                     <Label htmlFor=\"carry\" className=\"text-white text-xs\">Требуется подъем</Label>\n04636|                   </div>\n04637|                   \n04638|                   {form.needCarry && (\n04639|                     <div className=\"ml-6 space-y-2 border-l-2 border-gray-600 pl-3\">\n04640|                       <div>\n04641|                         <Label className=\"text-white text-xs\">Этаж</Label>\n04642|                         <Input\n04643|                           type=\"number\"\n04644|                           value={form.floor}\n04645|                           onChange={(e) => setForm(prev => ({ ...prev, floor: Number(e.target.value) }))}\n04646|                           className=\"bg-gray-700 border-gray-600 h-7 text-white text-xs\"\n04647|                         />\n04648|                       </div>\n04649|                       <div className=\"flex items-center space-x-2\">\n04650|                         <Checkbox\n04651|                           id=\"freightLift\"\n04652|                           checked={form.hasFreightLift}\n04653|                           onCheckedChange={(checked) => setForm(prev => ({ ...prev, hasFreightLift: checked as boolean }))}\n04654|                         />\n04655|                         <Label htmlFor=\"freightLift\" className=\"text-white text-xs\">Наличие грузового лифта</Label>\n04656|                       </div>\n04657|                     </div>\n04658|                   )}\n04659|                 </div>\n04660|                 \n04661|                 <div className=\"space-y-2\">\n04662|                   <Button \n04663|                     onClick={handleCalculate} \n04664|                     className=\"w-full bg-blue-600 hover:bg-blue-700 h-7 text-xs\" \n04665|                     disabled={calculating}\n04666|                   >\n04667|                     {calculating ? 'Расчет...' : 'Рассчитать'}\n04668|                   </Button>\n04669|                   \n04670|                   <Button \n04671|                     onClick={handleReset} \n04672|                     variant=\"outline\" \n04673|                     className=\"w-full h-7 text-xs text-black border-gray-600 hover:bg-gray-700 hover:text-white\" \n04674|                     disabled={calculating}\n04675|                   >\n04676|                     Сбросить расчет\n04677|                   </Button>\n04678|                 </div>\n04679|               </CardContent>\n04680|             </Card>\n04681|           </div>\n04682| \n04683|           {/* Правая часть - результаты */}\n04684|           <div className=\"space-y-2 overflow-y-auto\">\n04685|             {calculations.length > 0 && (\n04686|                  <div className=\"space-y-2\">\n04687|                 <div className=\"flex justify-between items-center\">\n04688|                   <h2 className=\"text-lg font-bold text-blue-400\">Результаты расчета</h2>\n04689|                   <Button \n04690|                     onClick={exportToPDF} \n04691|                     variant=\"outline\" \n04692|                     size=\"sm\" \n04693|                     className=\"h-7 text-xs border-blue-500 text-blue-400 hover:bg-blue-900/20 print:hidden\"\n04694|                   >\n04695|                     Сохранить в PDF\n04696|                   </Button>\n04697|                 </div>\n04698|                 \n04699|                 {calculations.map((calc, index) => (\n04700|                    <Card key={index} className=\"bg-gray-800 border-gray-700 text-xs\">\n04701|                      <CardHeader className=\"pb-1\">\n04702|                       <div className=\"flex justify-between items-center\">\n04703|                          <CardTitle className=\"text-white flex items-center gap-2 text-xs\">\n04704|                            <Building2 className=\"h-3 w-3\" />\n04705|                           {calc.company}\n04706|                         </CardTitle>\n04707|                         {calc.error ? (\n04708|                           <Badge variant=\"destructive\" className=\"text-xs\">Ошибка</Badge>\n04709|                         ) : (\n04710|                           <Badge variant=\"default\" className=\"bg-green-600 text-xs\">\n04711|                             {calc.price.toLocaleString()} ₽\n04712|                           </Badge>\n04713|                         )}\n04714|                       </div>\n04715|                     </CardHeader>\n04716|                     <CardContent className=\"pt-0\">\n04717|                       <div className=\"space-y-2\">\n04718|                         {calc.error ? (\n04719|                           <div className=\"space-y-2\">\n04720|                             <Alert className=\"border-red-600\">\n04721|                               <AlertDescription className=\"text-white text-xs\">{calc.error}</AlertDescription>\n04722|                             </Alert>\n04723|                             {calc.price > 0 && (\n04724|                               <>\n04725|                                 <p className=\"text-white text-xs\"><strong>Примерная стоимость:</strong> {calc.price.toLocaleString()} ₽</p>\n04726|                                 <p className=\"text-white text-xs\"><strong>Примерный срок:</strong> {calc.days} дней</p>\n04727|                               </>\n04728|                             )}\n04729|                           </div>\n04730|                         ) : (\n04731|                           <>\n04732|                             <p className=\"text-white text-xs\"><strong>Стоимость:</strong> {calc.price.toLocaleString()} ₽</p>\n04733|                             <p className=\"text-white text-xs\"><strong>Срок доставки:</strong> {calc.days} дней</p>\n04734|                           </>\n04735|                         )}\n04736|                         \n04737|                         <div className=\"flex gap-2 mt-2\">\n04738|                           {!calc.error && (\n04739|                             <Button\n04740|                               variant=\"outline\"\n04741|                               size=\"sm\"\n04742|                               onClick={() => toggleDetails(calc.company)}\n04743|                               className=\"h-6 text-xs\"\n04744|                             >\n04745|                               {expandedDetails[calc.company] ? 'Скрыть подробнее' : 'Показать подробнее'}\n04746|                             </Button>\n04747|                           )}\n04748|                           <Button\n04749|                             variant=\"outline\"\n04750|                             size=\"sm\"\n04751|                             onClick={() => toggleDebugInfo(calc.company)}\n04752|                             className=\"h-6 text-xs\"\n04753|                           >\n04754|                             {expandedDebugInfo[calc.company] ? 'Скрыть отладку' : 'Отладочная информация'}\n04755|                           </Button>\n04756|                         </div>\n04757|                         \n04758|                         {/* Детали расчета */}\n04759|                         {!calc.error && (\n04760|                           <Collapsible open={expandedDetails[calc.company]}>\n04761|                             <CollapsibleContent className=\"mt-2\">\n04762|                               <div className=\"bg-gray-900 p-3 rounded text-xs\">\n04763|                                 <h4 className=\"font-bold mb-2 text-white\">Детали расчета:</h4>\n04764|                                 {(() => {\n04765|                                   const details = parseCalculationDetails(calc);\n04766|                                   const totalPrice = details.reduce((sum, detail) => sum + detail.price, 0);\n04767|                                   \n04768|                                   return (\n04769|                                     <div className=\"space-y-1\">\n04770|                                       {details.map((detail, idx) => (\n04771|                                         <div key={idx} className=\"flex justify-between text-white\">\n04772|                                           <div>\n04773|                                             <div className=\"font-medium\">{detail.service}</div>\n04774|                                             {detail.description && (\n04775|                                               <div className=\"text-gray-400 text-xs\">{detail.description}</div>\n04776|                                             )}\n04777|                                           </div>\n04778|                                           <div className=\"font-medium\">{detail.price.toLocaleString()} ₽</div>\n04779|                                         </div>\n04780|                                       ))}\n04781|                                     </div>\n04782|                                   );\n04783|                                 })()}\n04784|                               </div>\n04785|                             </CollapsibleContent>\n04786|                           </Collapsible>\n04787|                         )}\n04788|                         \n04789|                         {/* Отладочная информация - всегда доступна */}\n04790|                         <Collapsible open={expandedDebugInfo[calc.company]}>\n04791|                           <CollapsibleContent className=\"mt-2\">\n04792|                             <div className=\"bg-gray-900 p-3 rounded text-xs\">\n04793|                               <h4 className=\"font-bold mb-2 text-white\">Отладочная информация:</h4>\n04794|                               \n04795|                               {calc.apiUrl && (\n04796|                                 <div className=\"mb-3\">\n04797|                                   <h5 className=\"font-bold mb-1 text-white\">Запрос к API:</h5>\n04798|                                   <p className=\"text-gray-300 break-all text-xs\">URL: {calc.apiUrl}</p>\n04799|                                 </div>\n04800|                               )}\n04801|                               \n04802|                               {calc.sessionId && (\n04803|                                 <div className=\"mb-3\">\n04804|                                   <h5 className=\"font-bold mb-1 text-white\">Session ID:</h5>\n04805|                                   <p className=\"text-gray-300 text-xs\">{calc.sessionId}</p>\n04806|                                 </div>\n04807|                               )}\n04808|                               \n04809|                               {calc.requestData && (\n04810|                                 <div className=\"mb-3\">\n04811|                                   <h5 className=\"font-bold mb-1 text-white\">Отправленный запрос:</h5>\n04812|                                   <pre className=\"whitespace-pre-wrap overflow-auto max-h-32 text-gray-300 bg-gray-950 p-2 rounded text-xs\">\n04813|                                     {JSON.stringify(calc.requestData, null, 2)}\n04814|                                   </pre>\n04815|                                 </div>\n04816|                               )}\n04817|                               \n04818|                               {calc.responseData && (\n04819|                                 <div className=\"mb-3\">\n04820|                                   <h5 className=\"font-bold mb-1 text-white\">Полученный ответ:</h5>\n04821|                                   <pre className=\"whitespace-pre-wrap overflow-auto max-h-32 text-gray-300 bg-gray-950 p-2 rounded text-xs\">\n04822|                                     {JSON.stringify(calc.responseData, null, 2)}\n04823|                                   </pre>\n04824|                                 </div>\n04825|                               )}\n04826|                               \n04827|                               {calc.details && (\n04828|                                 <div className=\"mb-3\">\n04829|                                   <h5 className=\"font-bold mb-1 text-white\">Детали расчета (JSON):</h5>\n04830|                                   <pre className=\"whitespace-pre-wrap overflow-auto max-h-32 text-gray-300 bg-gray-950 p-2 rounded text-xs\">\n04831|                                     {JSON.stringify(calc.details, null, 2)}\n04832|                                   </pre>\n04833|                                 </div>\n04834|                               )}\n04835|                               \n04836|                               {calc.error && (\n04837|                                 <div className=\"mb-3\">\n04838|                                   <h5 className=\"font-bold mb-1 text-red-400\">Информация об ошибке:</h5>\n04839|                                   <p className=\"text-red-300 text-xs\">{calc.error}</p>\n04840|                                 </div>\n04841|                               )}\n04842|                             </div>\n04843|                           </CollapsibleContent>\n04844|                         </Collapsible>\n04845|                       </div>\n04846|                     </CardContent>\n04847|                   </Card>\n04848|                 ))}\n04849|               </div>\n04850|             )}\n04851| \n04852|             {/* Список подключенных ТК - всегда видимый */}\n04853|             <Card className=\"bg-gray-800 border-gray-700\">\n04854|               <CardHeader className=\"pb-2\">\n04855|                 <CardTitle className=\"text-white text-sm\">\n04856|                   Подключенные транспортные компании ({COMPANIES_BASE.length})\n04857|                 </CardTitle>\n04858|               </CardHeader>\n04859|               <CardContent>\n04860|                 <div className=\"grid grid-cols-2 gap-2\">\n04861|                   {COMPANIES_BASE.map((company, index) => {\n04862|                     const isConnected = apiStatus[company.apiKey as keyof typeof apiStatus] === 'подключено';\n04863|                     const statusText = apiStatus[company.apiKey as keyof typeof apiStatus];\n04864|                     const isEnabled = enabledCompanies[company.apiKey];\n04865|                     \n04866|                     // Отладка для первых 3 компаний\n04867|                     if (index < 3) {\n04868|                       console.log(`🔍 Компания ${index}: ${company.name}, apiKey: ${company.apiKey}, isEnabled: ${isEnabled}, statusText: ${statusText}`);\n04869|                     }\n04870|                     \n04871|                     return (\n04872|                       <div key={index} className=\"flex items-center justify-between p-1.5 bg-gray-700 rounded\">\n04873|                         <div className=\"flex items-center gap-2\">\n04874|                           <span className=\"text-lg\">{company.logo}</span>\n04875|                           <div>\n04876|                             <p className=\"font-medium text-white text-[10px] leading-tight\">{company.name}</p>\n04877|                             <Badge \n04878|                               variant={isConnected ? \"default\" : \"destructive\"} \n04879|                               className=\"text-[9px] py-0 px-1\"\n04880|                             >\n04881|                               {isConnected ? 'Подключена' : statusText === 'проверка...' ? 'Проверка...' : 'Ошибка'}\n04882|                             </Badge>\n04883|                           </div>\n04884|                         </div>\n04885|                         <div className=\"flex items-center gap-2\">\n04886|                           <span className=\"text-[9px] text-gray-300\">\n04887|                             {isEnabled ? 'Вкл' : 'Выкл'}\n04888|                           </span>\n04889|                           <Switch\n04890|                             checked={isEnabled}\n04891|                             onCheckedChange={(checked) => {\n04892|                               setEnabledCompanies(prev => ({\n04893|                                 ...prev,\n04894|                                 [company.apiKey]: checked\n04895|                               }));\n04896|                             }}\n04897|                             disabled={!isConnected}\n04898|                           />\n04899|                         </div>\n04900|                       </div>\n04901|                     );\n04902|                   })}\n04903|                 </div>\n04904|               </CardContent>\n04905|             </Card>\n04906| \n04907|             {/* Визуализация кузова */}\n04908|             {calculations.length > 0 && (\n04909|               <TruckVisualization \n04910|                 cargos={form.cargos.map(cargo => ({\n04911|                   id: cargo.id,\n04912|                   length: cargo.length * 10, // Переводим см в мм\n04913|                   width: cargo.width * 10,   // Переводим см в мм\n04914|                   height: cargo.height * 10, // Переводим см в мм\n04915|                   weight: cargo.weight,\n04916|                   productName: form.selectedProducts?.find(p => \n04917|                     p.cargoIndexes.includes(form.cargos.indexOf(cargo))\n04918|                   )?.product.name\n04919|                 }))}\n04920|                 isVisible={true}\n04921|               />\n04922|             )}\n04923|           </div>\n04924|         </div>\n04925|       </div>\n04926| \n04927|       {/* Автоподсказки */}\n04928|       {showSuggestions && suggestions.length > 0 && (\n04929|         <div \n04930|           className=\"fixed z-50 bg-gray-800 border border-gray-700 rounded-md shadow-lg max-w-sm w-full max-h-60 overflow-y-auto\"\n04931|           style={{\n04932|             top: suggestionPosition.top,\n04933|             left: suggestionPosition.left\n04934|           }}\n04935|         >\n04936|           <div className=\"p-1\">\n04937|             {suggestions.map((suggestion, index) => (\n04938|               <div\n04939|                 key={index}\n04940|                 className=\"p-2 hover:bg-gray-700 cursor-pointer text-xs text-white rounded transition-colors\"\n04941|                 onClick={() => selectSuggestion(suggestion)}\n04942|               >\n04943|                 {suggestion.value}\n04944|               </div>\n04945|             ))}\n04946|           </div>\n04947|         </div>\n04948|       )}\n04949|     </div>\n04950|   );\n04951| }\n</file>",
    "title": "app/page.tsx",
    "metadata": {
      "preview": "      let intercityPrice = 0;\n      let derivalPrice = 0;\n      let arrivalPrice = 0;\n      let packagingPrice = 0;\n      // packagingPremiums больше не используются - надбавки включены в pkg.price\n      let insurancePrice = 0;\n      \n      // Межтерминальная перевозка\n      if (calc.details?.intercity?.price) {\n        intercityPrice = calc.details.intercity.price;\n        details.push({\n          service: 'Межтерминальная перевозка',\n          description: `${form.fromCity} - ${form.toCity}`,\n          price: intercityPrice\n        });\n      }\n      \n      // Забор груза\n      if (calc.details?.derival?.price) {\n        derivalPrice = calc.details.derival.price;"
    },
    "time": {
      "start": 1763464554734,
      "end": 1763464554738
    }
  }
}