{
  "id": "prt_986472aa0001b1imL5GyT6e433",
  "messageID": "msg_98646aa07001Rn4mdpHrJDb4H1",
  "sessionID": "ses_6852784ecffeuHwynj83p2lr14",
  "type": "tool",
  "tool": "edit",
  "callID": "toolu_018nccUdzdJ9JSZCWcMDTg34",
  "state": {
    "status": "completed",
    "input": {
      "filePath": "/home/user/project/app/page.tsx",
      "oldString": "    if (calc.company === 'Деловые Линии' && calc.details) {\n      // Основная перевозка\n      if (calc.details.availableDeliveryTypes?.auto) {\n        details.push({\n          service: 'Межтерминальная перевозка',\n          description: `${form.fromCity} - ${form.toCity}`,\n          price: calc.details.availableDeliveryTypes.auto\n        });\n      }\n      \n      // Забор груза\n      if (!form.fromTerminal && calc.details.derival?.price) {\n        details.push({\n          service: 'Забор груза',\n          description: 'От адреса',\n          price: calc.details.derival.price\n        });\n      }\n      \n      // Доставка груза\n      if (!form.toTerminal && calc.details.arrival?.price) {\n        details.push({\n          service: 'Отвоз груза',\n          description: 'До адреса',\n          price: calc.details.arrival.price\n        });\n      }\n      \n      // Страхование - только из API\n      if (form.needInsurance && calc.details.insurance) {\n        details.push({\n          service: 'Страхование груза',\n          description: `На сумму ${form.declaredValue.toLocaleString()} ₽`,\n          price: calc.details.insurance // Используем только стоимость из API\n        });\n      }\n      \n      // Упаковка - теперь берется только из API packages\n      if (form.needPackaging && calc.details.packages) {\n        Object.entries(calc.details.packages).forEach(([key, pkg]: [string, any]) => {\n          if (pkg.price && pkg.price > 0) {\n            details.push({\n              service: 'Упаковка груза',\n              description: 'Упаковать в комплекс «обрешётка + амортизация»',\n              price: pkg.price\n            });\n          }\n        });\n      }\n      \n      // Дополнительные услуги\n      details.push({\n        service: 'Доп.услуги',\n        description: 'Информирование о статусе груза',\n        price: 15\n      });",
      "newString": "    if (calc.company === 'Деловые Линии' && calc.details) {\n      // Основная стоимость доставки (уже включает все базовые услуги и упаковку)\n      let basePrice = calc.details.price || calc.price || 0;\n      \n      // Разбиваем основную стоимость на компоненты если возможно\n      let intercityPrice = 0;\n      let derivalPrice = 0;\n      let arrivalPrice = 0;\n      let packagingPrice = 0;\n      let packagingPremiums = 0;\n      let insurancePrice = 0;\n      \n      // Межтерминальная перевозка\n      if (calc.details.intercity?.price) {\n        intercityPrice = calc.details.intercity.price;\n        details.push({\n          service: 'Межтерминальная перевозка',\n          description: `${form.fromCity} - ${form.toCity}`,\n          price: intercityPrice\n        });\n      }\n      \n      // Забор груза\n      if (calc.details.derival?.price) {\n        derivalPrice = calc.details.derival.price;\n        details.push({\n          service: 'Забор груза',\n          description: 'От адреса',\n          price: derivalPrice\n        });\n      }\n      \n      // Доставка груза\n      if (calc.details.arrival?.price) {\n        arrivalPrice = calc.details.arrival.price;\n        details.push({\n          service: 'Отвоз груза',\n          description: 'До адреса',\n          price: arrivalPrice\n        });\n      }\n      \n      // Упаковка с детализацией надбавок\n      if (form.needPackaging && calc.details.packages) {\n        Object.entries(calc.details.packages).forEach(([key, pkg]: [string, any]) => {\n          if (pkg.price && pkg.price > 0) {\n            // Базовая стоимость упаковки (без надбавок)\n            let basePackagingPrice = pkg.price;\n            packagingPrice += basePackagingPrice;\n            \n            details.push({\n              service: 'Упаковка груза',\n              description: 'Упаковать в комплекс «обрешётка + амортизация»',\n              price: basePackagingPrice\n            });\n            \n            // Добавляем детали надбавок если есть\n            if (pkg.premiumDetails && Array.isArray(pkg.premiumDetails)) {\n              pkg.premiumDetails.forEach((premium: any) => {\n                if (premium.value && premium.value > 0) {\n                  packagingPremiums += premium.value;\n                  details.push({\n                    service: 'Надбавка к упаковке',\n                    description: premium.name || 'Дополнительная надбавка',\n                    price: premium.value\n                  });\n                }\n              });\n            }\n          }\n        });\n      }\n      \n      // Страхование\n      if (form.needInsurance && calc.details.insurance) {\n        insurancePrice = calc.details.insurance;\n        details.push({\n          service: 'Страхование груза',\n          description: `На сумму ${form.declaredValue.toLocaleString()} ₽`,\n          price: insurancePrice\n        });\n      }\n      \n      // Дополнительные услуги\n      details.push({\n        service: 'Доп.услуги',\n        description: 'Информирование о статусе груза',\n        price: 15\n      });\n      \n      // Если есть расхождение между суммой компонентов и общей стоимостью, добавляем остаток\n      const calculatedSum = intercityPrice + derivalPrice + arrivalPrice + packagingPrice + packagingPremiums + insurancePrice + 15;\n      const remainder = basePrice - calculatedSum;\n      \n      if (Math.abs(remainder) > 1) { // Если расхождение больше 1 рубля\n        details.push({\n          service: remainder > 0 ? 'Прочие услуги' : 'Скидка',\n          description: 'Дополнительные сборы и корректировки',\n          price: remainder\n        });\n      }"
    },
    "output": "",
    "metadata": {
      "diagnostics": {},
      "diff": "Index: /home/user/project/app/page.tsx\n===================================================================\n--- /home/user/project/app/page.tsx\n+++ /home/user/project/app/page.tsx\n@@ -1219,63 +1219,108 @@\n const parseCalculationDetails = (calc: CalculationResult) => {\n   const details: { service: string; description: string; price: number }[] = [];\n   \n   if (calc.company === 'Деловые Линии' && calc.details) {\n-    // Основная перевозка\n-    if (calc.details.availableDeliveryTypes?.auto) {\n+    // Основная стоимость доставки (уже включает все базовые услуги и упаковку)\n+    let basePrice = calc.details.price || calc.price || 0;\n+    \n+    // Разбиваем основную стоимость на компоненты если возможно\n+    let intercityPrice = 0;\n+    let derivalPrice = 0;\n+    let arrivalPrice = 0;\n+    let packagingPrice = 0;\n+    let packagingPremiums = 0;\n+    let insurancePrice = 0;\n+    \n+    // Межтерминальная перевозка\n+    if (calc.details.intercity?.price) {\n+      intercityPrice = calc.details.intercity.price;\n       details.push({\n         service: 'Межтерминальная перевозка',\n         description: `${form.fromCity} - ${form.toCity}`,\n-        price: calc.details.availableDeliveryTypes.auto\n+        price: intercityPrice\n       });\n     }\n     \n     // Забор груза\n-    if (!form.fromTerminal && calc.details.derival?.price) {\n+    if (calc.details.derival?.price) {\n+      derivalPrice = calc.details.derival.price;\n       details.push({\n         service: 'Забор груза',\n         description: 'От адреса',\n-        price: calc.details.derival.price\n+        price: derivalPrice\n       });\n     }\n     \n     // Доставка груза\n-    if (!form.toTerminal && calc.details.arrival?.price) {\n+    if (calc.details.arrival?.price) {\n+      arrivalPrice = calc.details.arrival.price;\n       details.push({\n         service: 'Отвоз груза',\n         description: 'До адреса',\n-        price: calc.details.arrival.price\n+        price: arrivalPrice\n       });\n     }\n     \n-    // Страхование - только из API\n-    if (form.needInsurance && calc.details.insurance) {\n-      details.push({\n-        service: 'Страхование груза',\n-        description: `На сумму ${form.declaredValue.toLocaleString()} ₽`,\n-        price: calc.details.insurance // Используем только стоимость из API\n-      });\n-    }\n-    \n-    // Упаковка - теперь берется только из API packages\n+    // Упаковка с детализацией надбавок\n     if (form.needPackaging && calc.details.packages) {\n       Object.entries(calc.details.packages).forEach(([key, pkg]: [string, any]) => {\n         if (pkg.price && pkg.price > 0) {\n+          // Базовая стоимость упаковки (без надбавок)\n+          let basePackagingPrice = pkg.price;\n+          packagingPrice += basePackagingPrice;\n+          \n           details.push({\n             service: 'Упаковка груза',\n             description: 'Упаковать в комплекс «обрешётка + амортизация»',\n-            price: pkg.price\n+            price: basePackagingPrice\n           });\n+          \n+          // Добавляем детали надбавок если есть\n+          if (pkg.premiumDetails && Array.isArray(pkg.premiumDetails)) {\n+            pkg.premiumDetails.forEach((premium: any) => {\n+              if (premium.value && premium.value > 0) {\n+                packagingPremiums += premium.value;\n+                details.push({\n+                  service: 'Надбавка к упаковке',\n+                  description: premium.name || 'Дополнительная надбавка',\n+                  price: premium.value\n+                });\n+              }\n+            });\n+          }\n         }\n       });\n     }\n     \n+    // Страхование\n+    if (form.needInsurance && calc.details.insurance) {\n+      insurancePrice = calc.details.insurance;\n+      details.push({\n+        service: 'Страхование груза',\n+        description: `На сумму ${form.declaredValue.toLocaleString()} ₽`,\n+        price: insurancePrice\n+      });\n+    }\n+    \n     // Дополнительные услуги\n     details.push({\n       service: 'Доп.услуги',\n       description: 'Информирование о статусе груза',\n       price: 15\n     });\n+    \n+    // Если есть расхождение между суммой компонентов и общей стоимостью, добавляем остаток\n+    const calculatedSum = intercityPrice + derivalPrice + arrivalPrice + packagingPrice + packagingPremiums + insurancePrice + 15;\n+    const remainder = basePrice - calculatedSum;\n+    \n+    if (Math.abs(remainder) > 1) { // Если расхождение больше 1 рубля\n+      details.push({\n+        service: remainder > 0 ? 'Прочие услуги' : 'Скидка',\n+        description: 'Дополнительные сборы и корректировки',\n+        price: remainder\n+      });\n+    }\n   } else if (calc.company === 'Nord Wheel' && calc.details) {\n     // Расшифровка для Nord Wheel согласно требованиям\n     if (calc.details.totalCost) {\n       details.push({\n"
    },
    "title": "app/page.tsx",
    "time": {
      "start": 1758894452203,
      "end": 1758894452220
    }
  }
}