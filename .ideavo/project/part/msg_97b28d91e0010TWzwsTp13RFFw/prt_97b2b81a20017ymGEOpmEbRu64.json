{
  "id": "prt_97b2b81a20017ymGEOpmEbRu64",
  "messageID": "msg_97b28d91e0010TWzwsTp13RFFw",
  "sessionID": "ses_6852784ecffeuHwynj83p2lr14",
  "type": "tool",
  "tool": "read",
  "callID": "toolu_018ZyQxJ4nPsaKo846YGJqru",
  "state": {
    "status": "completed",
    "input": {
      "filePath": "/home/user/project/app/page.tsx",
      "offset": 430,
      "limit": 260
    },
    "output": "<file>\n00431|   // Получение списка городов ПЭК\n00432|   const [pekCities, setPekCities] = React.useState<{ [region: string]: { [id: string]: string } } | null>(null);\n00433|   \n00434|   const loadPekCities = async () => {\n00435|     try {\n00436|       const response = await fetch('https://api.allorigins.win/get?url=' + encodeURIComponent('https://pecom.ru/ru/calc/towns.php'));\n00437|       const proxyData = await response.json();\n00438|       if (proxyData.contents) {\n00439|         const cities = JSON.parse(proxyData.contents);\n00440|         setPekCities(cities);\n00441|         return cities;\n00442|       }\n00443|       return null;\n00444|     } catch (error) {\n00445|       console.error('Ошибка загрузки городов ПЭК:', error);\n00446|       return null;\n00447|     }\n00448|   };\n00449| \n00450|   React.useEffect(() => {\n00451|     loadPekCities();\n00452|   }, []);\n00453| \n00454|   // Поиск ID города ПЭК по названию\n00455|   const findPekCityId = async (cityName: string): Promise<number | null> => {\n00456|     try {\n00457|       let cities = pekCities;\n00458|       if (!cities) {\n00459|         cities = await loadPekCities();\n00460|         if (!cities) return null;\n00461|       }\n00462| \n00463|       const normalizedSearch = cityName.toLowerCase().trim()\n00464|         .replace(/ё/g, 'е')\n00465|         .replace(/[\\s\\-\\.]+/g, '');\n00466| \n00467|       // Поиск по всем регионам\n00468|       for (const region of Object.values(cities)) {\n00469|         for (const [cityId, cityNameInList] of Object.entries(region)) {\n00470|           const normalizedCity = cityNameInList.toLowerCase()\n00471|             .replace(/ё/g, 'е')\n00472|             .replace(/[\\s\\-\\.]+/g, '');\n00473|           \n00474|           if (normalizedCity.includes(normalizedSearch) || \n00475|               normalizedSearch.includes(normalizedCity) ||\n00476|               normalizedCity === normalizedSearch) {\n00477|             return parseInt(cityId);\n00478|           }\n00479|         }\n00480|       }\n00481|       \n00482|       // Фоллбэк для основных городов\n00483|       const fallbackCities: { [key: string]: number } = {\n00484|         'москва': -457,\n00485|         'moscow': -457,\n00486|         'санктпетербург': 64883,\n00487|         'спб': 64883,\n00488|         'питер': 64883\n00489|       };\n00490|       \n00491|       return fallbackCities[normalizedSearch] || null;\n00492|     } catch (error) {\n00493|       console.error('Ошибка поиска города ПЭК:', error);\n00494|       return null;\n00495|     }\n00496|   };\n00497| \n00498|   // Расчет для ПЭК - заглушка, так как API недоступен для внешних запросов\n00499|   // Расчет для ПЭК с использованием публичного API\n00500|   const calculatePEK = async (): Promise<CalculationResult> => {\n00501|     const apiUrl = 'http://calc.pecom.ru/bitrix/components/pecom/calc/ajax.php';\n00502|     \n00503|     try {\n00504|       // Получаем ID городов\n00505|       const fromCityId = await findPekCityId(form.fromCity);\n00506|       const toCityId = await findPekCityId(form.toCity);\n00507|       \n00508|       if (!fromCityId || !toCityId) {\n00509|         return {\n00510|           company: 'ПЭК',\n00511|           price: 0,\n00512|           days: 0,\n00513|           error: `Город не найден в базе ПЭК. Проверьте: ${!fromCityId ? form.fromCity : ''} ${!toCityId ? form.toCity : ''}`.trim(),\n00514|           apiUrl\n00515|         };\n00516|       }\n00517| \n00518|       // Формируем параметры запроса согласно документации\n00519|       const params = new URLSearchParams();\n00520|       \n00521|       // Добавляем грузы согласно формату: Ширина (м), Длина (м), Высота (м), Объем (м3), Вес (кг), Негабарит (0/1), ЗТУ (0/1)\n00522|       form.cargos.forEach((cargo, index) => {\n00523|         const width = cargo.width / 100; // переводим см в метры\n00524|         const length = cargo.length / 100;\n00525|         const height = cargo.height / 100;\n00526|         const volume = width * length * height;\n00527|         const weight = cargo.weight;\n00528|         const isOversized = (width > 2.4 || length > 12 || height > 2.7 || weight > 1500) ? 1 : 0;\n00529|         const needZTU = form.needPackaging ? 1 : 0;\n00530|         \n00531|         params.append(`places[${index}][]`, width.toString());\n00532|         params.append(`places[${index}][]`, length.toString());\n00533|         params.append(`places[${index}][]`, height.toString());\n00534|         params.append(`places[${index}][]`, volume.toString());\n00535|         params.append(`places[${index}][]`, weight.toString());\n00536|         params.append(`places[${index}][]`, isOversized.toString());\n00537|         params.append(`places[${index}][]`, needZTU.toString());\n00538|       });\n00539|       \n00540|       // Параметры забора\n00541|       params.append('take[town]', fromCityId.toString());\n00542|       params.append('take[tent]', '0'); // растентровка\n00543|       params.append('take[gidro]', form.needLoading ? '1' : '0'); // гидролифт\n00544|       params.append('take[manip]', '0'); // манипулятор\n00545|       params.append('take[speed]', '0'); // срочный забор\n00546|       params.append('take[moscow]', '0'); // ограничения по Москве\n00547|       \n00548|       // Параметры доставки\n00549|       params.append('deliver[town]', toCityId.toString());\n00550|       params.append('deliver[tent]', '0');\n00551|       params.append('deliver[gidro]', form.needLoading ? '1' : '0');\n00552|       params.append('deliver[manip]', '0');\n00553|       params.append('deliver[speed]', '0');\n00554|       params.append('deliver[moscow]', '0');\n00555|       \n00556|       // Дополнительные услуги\n00557|       params.append('plombir', '0'); // пломбы\n00558|       params.append('strah', form.needInsurance ? form.declaredValue.toString() : '0'); // страховка\n00559|       params.append('ashan', '0'); // доставка в Ашан\n00560|       params.append('night', '0'); // ночное время\n00561|       params.append('pal', '0'); // запаллечивание\n00562|       params.append('pallets', '0'); // паллетная перевозка\n00563| \n00564|       const fullUrl = `${apiUrl}?${params.toString()}`;\n00565|       const requestData = Object.fromEntries(params);\n00566| \n00567|       // Используем прокси для обхода CORS\n00568|       const proxyUrl = 'https://api.allorigins.win/get?url=' + encodeURIComponent(fullUrl);\n00569|       const response = await fetch(proxyUrl);\n00570|       const proxyData = await response.json();\n00571|       \n00572|       if (!response.ok || !proxyData.contents) {\n00573|         throw new Error('Ошибка загрузки данных через прокси');\n00574|       }\n00575|       \n00576|       const data = JSON.parse(proxyData.contents);\n00577| \n00578|       if (data && !data.error?.length) {\n00579|         let totalPrice = 0;\n00580|         let services: { name: string; description: string; price: number }[] = [];\n00581|         \n00582|         // Собираем стоимость услуг по документации\n00583|         if (data.take?.[2]) {\n00584|           const price = parseFloat(data.take[2]);\n00585|           totalPrice += price;\n00586|           services.push({ \n00587|             name: data.take[0] || 'Забор груза', \n00588|             description: data.take[1] || '', \n00589|             price \n00590|           });\n00591|         }\n00592|         \n00593|         // Выбираем тип перевозки\n00594|         let transportCost = 0;\n00595|         let transportName = '';\n00596|         if (data.autonegabarit?.[2] && parseFloat(data.autonegabarit[2]) > 0) {\n00597|           transportCost = parseFloat(data.autonegabarit[2]);\n00598|           transportName = data.autonegabarit[0] || 'Автоперевозка (негабарит)';\n00599|         } else if (data.auto?.[2]) {\n00600|           transportCost = parseFloat(data.auto[2]);\n00601|           transportName = data.auto[0] || 'Автоперевозка';\n00602|         } else if (data.avia?.[2]) {\n00603|           transportCost = parseFloat(data.avia[2]);\n00604|           transportName = data.avia[0] || 'Авиаперевозка';\n00605|         }\n00606|         \n00607|         if (transportCost > 0) {\n00608|           totalPrice += transportCost;\n00609|           services.push({ \n00610|             name: transportName, \n00611|             description: data.auto?.[1] || data.autonegabarit?.[1] || data.avia?.[1] || '', \n00612|             price: transportCost \n00613|           });\n00614|         }\n00615|         \n00616|         if (data.deliver?.[2]) {\n00617|           const price = parseFloat(data.deliver[2]);\n00618|           totalPrice += price;\n00619|           services.push({ \n00620|             name: data.deliver[0] || 'Доставка груза', \n00621|             description: data.deliver[1] || '', \n00622|             price \n00623|           });\n00624|         }\n00625|         \n00626|         // Дополнительные услуги\n00627|         ['ADD', 'ADD_1', 'ADD_2', 'ADD_3', 'ADD_4'].forEach(key => {\n00628|           if (data[key]?.[2] && parseFloat(data[key][2]) > 0) {\n00629|             const price = parseFloat(data[key][2]);\n00630|             totalPrice += price;\n00631|             services.push({ \n00632|               name: data[key][0] || `Доп. услуга ${key}`, \n00633|               description: data[key][1] || '', \n00634|               price \n00635|             });\n00636|           }\n00637|         });\n00638|         \n00639|         // Определяем срок доставки\n00640|         let deliveryDays = 3; // по умолчанию\n00641|         if (data.periods) {\n00642|           const daysMatch = data.periods.match(/(\\d+)\\s*дн/);\n00643|           if (daysMatch) {\n00644|             deliveryDays = parseInt(daysMatch[1]);\n00645|           }\n00646|         }\n00647| \n00648|         return {\n00649|           company: 'ПЭК',\n00650|           price: Math.round(totalPrice),\n00651|           days: deliveryDays,\n00652|           details: {\n00653|             services,\n00654|             periods: data.periods,\n00655|             aperiods: data.aperiods,\n00656|             rawData: data,\n00657|             fromCityId,\n00658|             toCityId\n00659|           },\n00660|           requestData,\n00661|           responseData: data,\n00662|           apiUrl: fullUrl\n00663|         };\n00664|       } else {\n00665|         const errorMessages = data.error?.join(', ') || 'Неизвестная ошибка ПЭК';\n00666|         return {\n00667|           company: 'ПЭК',\n00668|           price: 0,\n00669|           days: 0,\n00670|           error: errorMessages,\n00671|           requestData,\n00672|           responseData: data,\n00673|           apiUrl: fullUrl\n00674|         };\n00675|       }\n00676|     } catch (error: any) {\n00677|       return {\n00678|         company: 'ПЭК',\n00679|         price: 0,\n00680|         days: 0,\n00681|         error: `Ошибка соединения: ${error.message}`,\n00682|         requestData: null,\n00683|         responseData: null,\n00684|         apiUrl\n00685|       };\n00686|     }\n00687|   };\n00688| \n00689|   const calculateRailContinent = async (): Promise<CalculationResult> => {\n00690|     await new Promise(resolve => setTimeout(resolve, 1200));\n\n(File has more lines. Use 'offset' parameter to read beyond line 690)\n</file>",
    "metadata": {
      "preview": "  // Получение списка городов ПЭК\n  const [pekCities, setPekCities] = React.useState<{ [region: string]: { [id: string]: string } } | null>(null);\n  \n  const loadPekCities = async () => {\n    try {\n      const response = await fetch('https://api.allorigins.win/get?url=' + encodeURIComponent('https://pecom.ru/ru/calc/towns.php'));\n      const proxyData = await response.json();\n      if (proxyData.contents) {\n        const cities = JSON.parse(proxyData.contents);\n        setPekCities(cities);\n        return cities;\n      }\n      return null;\n    } catch (error) {\n      console.error('Ошибка загрузки городов ПЭК:', error);\n      return null;\n    }\n  };\n\n  React.useEffect(() => {"
    },
    "title": "app/page.tsx",
    "time": {
      "start": 1758708073507,
      "end": 1758708073514
    }
  }
}