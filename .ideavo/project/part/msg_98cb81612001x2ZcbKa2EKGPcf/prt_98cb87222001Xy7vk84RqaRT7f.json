{
  "id": "prt_98cb87222001Xy7vk84RqaRT7f",
  "messageID": "msg_98cb81612001x2ZcbKa2EKGPcf",
  "sessionID": "ses_6852784ecffeuHwynj83p2lr14",
  "type": "tool",
  "tool": "edit",
  "callID": "toolu_018FBpC495nvWYrjwmJvuEQ9",
  "state": {
    "status": "completed",
    "input": {
      "filePath": "/home/user/project/app/page.tsx",
      "oldString": "  const calculateRailContinent = async (): Promise<CalculationResult> => {\n    await new Promise(resolve => setTimeout(resolve, 1200));\n    const basePrice = form.cargos.reduce((sum, cargo) => sum + cargo.weight * 12, 0);\n    let totalPrice = basePrice;\n    \n    if (form.needInsurance) totalPrice += form.declaredValue * 0.025;\n    if (form.needPackaging) totalPrice += basePrice * 0.08;\n    \n    return {\n      company: 'Rail Continent',\n      price: totalPrice,\n      days: 5,\n      apiUrl: 'https://www.railcontinent.ru/services/prochie-gruzoperevozki/forshop/api-manual/',\n      details: { note: 'Заглушка - API не реализован' }\n    };\n  };",
      "newString": "  const calculateRailContinent = async (): Promise<CalculationResult> => {\n    const apiUrl = 'http://railcontinent.ru/ajax/api.php';\n    \n    try {\n      // Вычисляем основные параметры груза\n      const totalWeight = form.cargos.reduce((sum, cargo) => sum + cargo.weight, 0);\n      const totalVolume = form.cargos.reduce((sum, cargo) => \n        sum + (cargo.length * cargo.width * cargo.height) / 1000000, 0\n      );\n      \n      // Находим максимальные габариты\n      const maxLength = Math.max(...form.cargos.map(c => c.length));\n      const maxWidth = Math.max(...form.cargos.map(c => c.width));\n      const maxHeight = Math.max(...form.cargos.map(c => c.height));\n      \n      // Параметры для API Rail Continent\n      const params = new URLSearchParams({\n        city_sender: form.fromCity || 'Москва',\n        city_receiver: form.toCity || 'Санкт-Петербург',\n        weight: totalWeight.toString(),\n        volume: totalVolume.toString(),\n        length: (maxLength / 100).toString(), // переводим см в метры\n        width: (maxWidth / 100).toString(),\n        height: (maxHeight / 100).toString(),\n        declared_cost: form.declaredValue.toString(),\n        pickup: form.fromAddressDelivery ? '1' : '0',\n        delivery: form.toAddressDelivery ? '1' : '0',\n        packaging: form.needPackaging ? '1' : '0',\n        insurance: form.needInsurance ? '1' : '0',\n        tariff: 'auto' // Автоматический выбор оптимального тарифа\n      });\n\n      const requestData = Object.fromEntries(params);\n      const fullUrl = `${apiUrl}?${params.toString()}`;\n\n      const response = await fetch(fullUrl, {\n        method: 'GET',\n        headers: {\n          'Accept': 'application/json',\n        }\n      });\n\n      const data = await response.json();\n\n      if (response.ok && data.success) {\n        // Если есть несколько тарифов, выбираем самый дешевый\n        let selectedTariff = data.tariffs?.[0];\n        if (data.tariffs && data.tariffs.length > 1) {\n          selectedTariff = data.tariffs.reduce((cheapest: any, current: any) => \n            current.cost < cheapest.cost ? current : cheapest\n          );\n        }\n\n        return {\n          company: 'Rail Continent',\n          price: Math.round(selectedTariff?.cost || data.cost || 0),\n          days: selectedTariff?.days || data.days || 5,\n          details: {\n            tariff: selectedTariff?.name || data.tariff_name || 'Автоматический',\n            weight: totalWeight,\n            volume: totalVolume,\n            route: `${form.fromCity} - ${form.toCity}`,\n            services: {\n              pickup: form.fromAddressDelivery,\n              delivery: form.toAddressDelivery,\n              packaging: form.needPackaging,\n              insurance: form.needInsurance\n            },\n            allTariffs: data.tariffs || []\n          },\n          requestData,\n          responseData: data,\n          apiUrl: fullUrl\n        };\n      } else {\n        return {\n          company: 'Rail Continent',\n          price: 0,\n          days: 0,\n          error: data.error || 'Ошибка расчета Rail Continent',\n          requestData,\n          responseData: data,\n          apiUrl: fullUrl\n        };\n      }\n    } catch (error: any) {\n      return {\n        company: 'Rail Continent',\n        price: 0,\n        days: 0,\n        error: `Ошибка соединения: ${error.message}`,\n        apiUrl\n      };\n    }\n  };"
    },
    "output": "",
    "metadata": {
      "diagnostics": {},
      "diff": "Index: /home/user/project/app/page.tsx\n===================================================================\n--- /home/user/project/app/page.tsx\n+++ /home/user/project/app/page.tsx\n@@ -1661,22 +1661,101 @@\n \n \n \n const calculateRailContinent = async (): Promise<CalculationResult> => {\n-  await new Promise(resolve => setTimeout(resolve, 1200));\n-  const basePrice = form.cargos.reduce((sum, cargo) => sum + cargo.weight * 12, 0);\n-  let totalPrice = basePrice;\n+  const apiUrl = 'http://railcontinent.ru/ajax/api.php';\n   \n-  if (form.needInsurance) totalPrice += form.declaredValue * 0.025;\n-  if (form.needPackaging) totalPrice += basePrice * 0.08;\n-  \n-  return {\n-    company: 'Rail Continent',\n-    price: totalPrice,\n-    days: 5,\n-    apiUrl: 'https://www.railcontinent.ru/services/prochie-gruzoperevozki/forshop/api-manual/',\n-    details: { note: 'Заглушка - API не реализован' }\n-  };\n+  try {\n+    // Вычисляем основные параметры груза\n+    const totalWeight = form.cargos.reduce((sum, cargo) => sum + cargo.weight, 0);\n+    const totalVolume = form.cargos.reduce((sum, cargo) => \n+      sum + (cargo.length * cargo.width * cargo.height) / 1000000, 0\n+    );\n+    \n+    // Находим максимальные габариты\n+    const maxLength = Math.max(...form.cargos.map(c => c.length));\n+    const maxWidth = Math.max(...form.cargos.map(c => c.width));\n+    const maxHeight = Math.max(...form.cargos.map(c => c.height));\n+    \n+    // Параметры для API Rail Continent\n+    const params = new URLSearchParams({\n+      city_sender: form.fromCity || 'Москва',\n+      city_receiver: form.toCity || 'Санкт-Петербург',\n+      weight: totalWeight.toString(),\n+      volume: totalVolume.toString(),\n+      length: (maxLength / 100).toString(), // переводим см в метры\n+      width: (maxWidth / 100).toString(),\n+      height: (maxHeight / 100).toString(),\n+      declared_cost: form.declaredValue.toString(),\n+      pickup: form.fromAddressDelivery ? '1' : '0',\n+      delivery: form.toAddressDelivery ? '1' : '0',\n+      packaging: form.needPackaging ? '1' : '0',\n+      insurance: form.needInsurance ? '1' : '0',\n+      tariff: 'auto' // Автоматический выбор оптимального тарифа\n+    });\n+\n+    const requestData = Object.fromEntries(params);\n+    const fullUrl = `${apiUrl}?${params.toString()}`;\n+\n+    const response = await fetch(fullUrl, {\n+      method: 'GET',\n+      headers: {\n+        'Accept': 'application/json',\n+      }\n+    });\n+\n+    const data = await response.json();\n+\n+    if (response.ok && data.success) {\n+      // Если есть несколько тарифов, выбираем самый дешевый\n+      let selectedTariff = data.tariffs?.[0];\n+      if (data.tariffs && data.tariffs.length > 1) {\n+        selectedTariff = data.tariffs.reduce((cheapest: any, current: any) => \n+          current.cost < cheapest.cost ? current : cheapest\n+        );\n+      }\n+\n+      return {\n+        company: 'Rail Continent',\n+        price: Math.round(selectedTariff?.cost || data.cost || 0),\n+        days: selectedTariff?.days || data.days || 5,\n+        details: {\n+          tariff: selectedTariff?.name || data.tariff_name || 'Автоматический',\n+          weight: totalWeight,\n+          volume: totalVolume,\n+          route: `${form.fromCity} - ${form.toCity}`,\n+          services: {\n+            pickup: form.fromAddressDelivery,\n+            delivery: form.toAddressDelivery,\n+            packaging: form.needPackaging,\n+            insurance: form.needInsurance\n+          },\n+          allTariffs: data.tariffs || []\n+        },\n+        requestData,\n+        responseData: data,\n+        apiUrl: fullUrl\n+      };\n+    } else {\n+      return {\n+        company: 'Rail Continent',\n+        price: 0,\n+        days: 0,\n+        error: data.error || 'Ошибка расчета Rail Continent',\n+        requestData,\n+        responseData: data,\n+        apiUrl: fullUrl\n+      };\n+    }\n+  } catch (error: any) {\n+    return {\n+      company: 'Rail Continent',\n+      price: 0,\n+      days: 0,\n+      error: `Ошибка соединения: ${error.message}`,\n+      apiUrl\n+    };\n+  }\n };\n \n const handleCalculate = async () => {\n   setCalculating(true);\n"
    },
    "title": "app/page.tsx",
    "time": {
      "start": 1759002539833,
      "end": 1759002539862
    }
  }
}