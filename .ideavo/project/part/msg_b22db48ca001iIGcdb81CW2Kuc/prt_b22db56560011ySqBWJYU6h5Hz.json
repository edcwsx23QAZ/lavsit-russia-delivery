{
  "id": "prt_b22db56560011ySqBWJYU6h5Hz",
  "sessionID": "ses_4dd34592affehJqMoLA2ZOxuZo",
  "messageID": "msg_b22db48ca001iIGcdb81CW2Kuc",
  "type": "tool",
  "callID": "toolu_01RSygMG1hufRATqg89GqXZU",
  "tool": "read",
  "state": {
    "status": "completed",
    "input": {
      "filePath": "/home/user/project/app/api/dadata/route.ts"
    },
    "output": "<file>\n00001| import { NextRequest, NextResponse } from 'next/server';\n00002| \n00003| const DADATA_API_KEY = 'eb87bbb3789bb43ed465f796892ea951f9e91008';\n00004| const DADATA_SECRET_KEY = '90f3541a30ef6e1c40e665b69f1aa6d74242c3f2';\n00005| \n00006| // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∞–¥—Ä–µ—Å–∞ —á–µ—Ä–µ–∑ DaData\n00007| export async function POST(request: NextRequest) {\n00008|   try {\n00009|     const { address, type = 'clean' } = await request.json();\n00010| \n00011|     if (!address) {\n00012|       return NextResponse.json(\n00013|         { error: 'Address is required' },\n00014|         { status: 400 }\n00015|       );\n00016|     }\n00017| \n00018|     console.log('üåê DaData –∑–∞–ø—Ä–æ—Å:', { address, type });\n00019| \n00020|     let url = '';\n00021|     let body: any = '';\n00022|     let headers: HeadersInit = {\n00023|       'Content-Type': 'application/json',\n00024|       'Accept': 'application/json',\n00025|       'Authorization': `Token ${DADATA_API_KEY}`,\n00026|     };\n00027| \n00028|     if (type === 'clean') {\n00029|       // –û—á–∏—Å—Ç–∫–∞ –∏ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∞–¥—Ä–µ—Å–∞\n00030|       url = 'https://cleaner.dadata.ru/api/v1/clean/address';\n00031|       body = JSON.stringify([address]);\n00032|       headers['X-Secret'] = DADATA_SECRET_KEY;\n00033|     } else if (type === 'suggest') {\n00034|       // –ü–æ–¥—Å–∫–∞–∑–∫–∏ –∞–¥—Ä–µ—Å–æ–≤\n00035|       url = 'https://suggestions.dadata.ru/suggestions/api/4_1/rs/suggest/address';\n00036|       body = JSON.stringify({\n00037|         query: address,\n00038|         count: 10\n00039|       });\n00040|     }\n00041| \n00042|     console.log('üåê DaData URL:', url);\n00043|     console.log('üåê DaData Body:', body);\n00044| \n00045|     const response = await fetch(url, {\n00046|       method: 'POST',\n00047|       headers,\n00048|       body\n00049|     });\n00050| \n00051|     const data = await response.json();\n00052|     \n00053|     console.log('üåê DaData response status:', response.status);\n00054|     console.log('üåê DaData response:', JSON.stringify(data, null, 2));\n00055| \n00056|     if (!response.ok) {\n00057|       console.error('‚ùå DaData API error:', data);\n00058|       return NextResponse.json(\n00059|         { error: 'DaData API error', details: data },\n00060|         { status: response.status }\n00061|       );\n00062|     }\n00063| \n00064|     // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –∑–∞–ø—Ä–æ—Å–∞\n00065|     if (type === 'clean' && Array.isArray(data) && data.length > 0) {\n00066|       const cleanedAddress = data[0];\n00067|       \n00068|       // –§–æ—Ä–º–∏—Ä—É–µ–º –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –∞–¥—Ä–µ—Å –¥–ª—è –î–µ–ª–æ–≤—ã—Ö –õ–∏–Ω–∏–π\n00069|       const dellinFormat = formatAddressForDellin(cleanedAddress);\n00070|       \n00071|       return NextResponse.json({\n00072|         success: true,\n00073|         data: {\n00074|           original: address,\n00075|           cleaned: cleanedAddress,\n00076|           dellinFormat,\n00077|           region_kladr_id: cleanedAddress.region_kladr_id,\n00078|           city_kladr_id: cleanedAddress.city_kladr_id,\n00079|           street_kladr_id: cleanedAddress.street_kladr_id\n00080|         }\n00081|       });\n00082|     } else if (type === 'suggest' && data.suggestions && Array.isArray(data.suggestions)) {\n00083|       const suggestions = data.suggestions.map((suggestion: any) => ({\n00084|         value: suggestion.value,\n00085|         unrestricted_value: suggestion.unrestricted_value,\n00086|         data: suggestion.data,\n00087|         dellinFormat: formatAddressForDellin(suggestion.data)\n00088|       }));\n00089| \n00090|       return NextResponse.json({\n00091|         success: true,\n00092|         data: suggestions\n00093|       });\n00094|     }\n00095| \n00096|     return NextResponse.json({\n00097|       success: false,\n00098|       error: 'Invalid response format',\n00099|       data\n00100|     });\n00101| \n00102|   } catch (error) {\n00103|     console.error('‚ùå DaData API error:', error);\n00104|     return NextResponse.json(\n00105|       { \n00106|         error: 'Internal server error',\n00107|         details: error instanceof Error ? error.message : 'Unknown error'\n00108|       },\n00109|       { status: 500 }\n00110|     );\n00111|   }\n00112| }\n00113| \n00114| // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–¥—Ä–µ—Å–∞ –¥–ª—è API –î–µ–ª–æ–≤—ã—Ö –õ–∏–Ω–∏–π\n00115| function formatAddressForDellin(addressData: any): string {\n00116|   const parts: string[] = [];\n00117|   \n00118|   // –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–≥–∏–æ–Ω —Å —Ç–∏–ø–æ–º\n00119|   if (addressData.region_with_type) {\n00120|     parts.push(addressData.region_with_type);\n00121|   }\n00122|   \n00123|   // –î–æ–±–∞–≤–ª—è–µ–º –≥–æ—Ä–æ–¥ —Å —Ç–∏–ø–æ–º\n00124|   if (addressData.city_with_type) {\n00125|     parts.push(addressData.city_with_type);\n00126|   } else if (addressData.settlement_with_type) {\n00127|     parts.push(addressData.settlement_with_type);\n00128|   }\n00129|   \n00130|   // –î–æ–±–∞–≤–ª—è–µ–º —É–ª–∏—Ü—É —Å —Ç–∏–ø–æ–º\n00131|   if (addressData.street_with_type) {\n00132|     parts.push(addressData.street_with_type);\n00133|   }\n00134|   \n00135|   // –î–æ–±–∞–≤–ª—è–µ–º –¥–æ–º\n00136|   if (addressData.house) {\n00137|     let houseStr = `–¥. ${addressData.house}`;\n00138|     \n00139|     // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ—Ä–ø—É—Å –µ—Å–ª–∏ –µ—Å—Ç—å\n00140|     if (addressData.block) {\n00141|       houseStr += `, –∫–æ—Ä–ø. ${addressData.block}`;\n00142|     }\n00143|     \n00144|     parts.push(houseStr);\n00145|   }\n00146|   \n00147|   const formatted = parts.join(', ');\n00148|   console.log('üè† Formatted address for Dellin:', formatted);\n00149|   \n00150|   return formatted || addressData.result || '';\n00151| }\n00152| \n00153| // –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≥–æ—Ä–æ–¥–µ –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–≤\n00154| export async function GET(request: NextRequest) {\n00155|   try {\n00156|     const { searchParams } = new URL(request.url);\n00157|     const cityName = searchParams.get('city');\n00158|     const fiasId = searchParams.get('fias_id');\n00159|     const type = searchParams.get('type') || 'suggest';\n00160| \n00161|     // –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω fias_id –∏ type=findById, –∏—Å–ø–æ–ª—å–∑—É–µ–º findById API\n00162|     if (fiasId && type === 'findById') {\n00163|       console.log('üèôÔ∏è DaData findById –∑–∞–ø—Ä–æ—Å –¥–ª—è FIAS:', fiasId);\n00164| \n00165|       const response = await fetch('https://suggestions.dadata.ru/suggestions/api/4_1/rs/findById/address', {\n00166|         method: 'POST',\n00167|         headers: {\n00168|           'Content-Type': 'application/json',\n00169|           'Accept': 'application/json',\n00170|           'Authorization': `Token ${DADATA_API_KEY}`,\n00171|         },\n00172|         body: JSON.stringify({\n00173|           query: fiasId\n00174|         })\n00175|       });\n00176| \n00177|       const data = await response.json();\n00178|       \n00179|       console.log('üèôÔ∏è DaData findById response:', JSON.stringify(data, null, 2));\n00180| \n00181|       if (!response.ok) {\n00182|         return NextResponse.json(\n00183|           { error: 'DaData API error', details: data },\n00184|           { status: response.status }\n00185|         );\n00186|       }\n00187| \n00188|       if (data.suggestions && Array.isArray(data.suggestions) && data.suggestions.length > 0) {\n00189|         const suggestion = data.suggestions[0];\n00190|         return NextResponse.json({\n00191|           success: true,\n00192|           data: {\n00193|             value: suggestion.value,\n00194|             city: suggestion.data.city || suggestion.data.settlement,\n00195|             region: suggestion.data.region,\n00196|             city_fias_id: suggestion.data.city_fias_id || suggestion.data.settlement_fias_id,\n00197|             region_fias_id: suggestion.data.region_fias_id,\n00198|             city_kladr_id: suggestion.data.city_kladr_id || suggestion.data.settlement_kladr_id,\n00199|             region_kladr_id: suggestion.data.region_kladr_id,\n00200|             data: suggestion.data\n00201|           }\n00202|         });\n00203|       }\n00204| \n00205|       return NextResponse.json({\n00206|         success: false,\n00207|         error: 'FIAS code not found'\n00208|       });\n00209|     }\n00210| \n00211|     // –û–±—ã—á–Ω—ã–π –ø–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–∞ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é\n00212|     if (!cityName) {\n00213|       return NextResponse.json(\n00214|         { error: 'City name or FIAS ID is required' },\n00215|         { status: 400 }\n00216|       );\n00217|     }\n00218| \n00219|     console.log('üèôÔ∏è DaData city search:', cityName);\n00220| \n00221|     const response = await fetch('https://suggestions.dadata.ru/suggestions/api/4_1/rs/suggest/address', {\n00222|       method: 'POST',\n00223|       headers: {\n00224|         'Content-Type': 'application/json',\n00225|         'Accept': 'application/json',\n00226|         'Authorization': `Token ${DADATA_API_KEY}`,\n00227|       },\n00228|       body: JSON.stringify({\n00229|         query: cityName,\n00230|         count: 5,\n00231|         locations: [{ country: '*' }],\n00232|         restrict_value: true\n00233|       })\n00234|     });\n00235| \n00236|     const data = await response.json();\n00237|     \n00238|     console.log('üèôÔ∏è DaData city response:', JSON.stringify(data, null, 2));\n00239| \n00240|     if (!response.ok) {\n00241|       return NextResponse.json(\n00242|         { error: 'DaData API error', details: data },\n00243|         { status: response.status }\n00244|       );\n00245|     }\n00246| \n00247|     if (data.suggestions && Array.isArray(data.suggestions)) {\n00248|       const cities = data.suggestions\n00249|         .filter((s: any) => s.data.city || s.data.settlement)\n00250|         .map((suggestion: any) => ({\n00251|           value: suggestion.value,\n00252|           city: suggestion.data.city || suggestion.data.settlement,\n00253|           region: suggestion.data.region,\n00254|           city_kladr_id: suggestion.data.city_kladr_id || suggestion.data.settlement_kladr_id,\n00255|           region_kladr_id: suggestion.data.region_kladr_id,\n00256|           dellinFormat: formatAddressForDellin(suggestion.data)\n00257|         }));\n00258| \n00259|       return NextResponse.json({\n00260|         success: true,\n00261|         data: cities\n00262|       });\n00263|     }\n00264| \n00265|     return NextResponse.json({\n00266|       success: false,\n00267|       error: 'No cities found'\n00268|     });\n00269| \n00270|   } catch (error) {\n00271|     console.error('‚ùå DaData city search error:', error);\n00272|     return NextResponse.json(\n00273|       { \n00274|         error: 'Internal server error',\n00275|         details: error instanceof Error ? error.message : 'Unknown error'\n00276|       },\n00277|       { status: 500 }\n00278|     );\n00279|   }\n00280| }\n\n(End of file - total 280 lines)\n</file>",
    "title": "app/api/dadata/route.ts",
    "metadata": {
      "preview": "import { NextRequest, NextResponse } from 'next/server';\n\nconst DADATA_API_KEY = 'eb87bbb3789bb43ed465f796892ea951f9e91008';\nconst DADATA_SECRET_KEY = '90f3541a30ef6e1c40e665b69f1aa6d74242c3f2';\n\n// –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∞–¥—Ä–µ—Å–∞ —á–µ—Ä–µ–∑ DaData\nexport async function POST(request: NextRequest) {\n  try {\n    const { address, type = 'clean' } = await request.json();\n\n    if (!address) {\n      return NextResponse.json(\n        { error: 'Address is required' },\n        { status: 400 }\n      );\n    }\n\n    console.log('üåê DaData –∑–∞–ø—Ä–æ—Å:', { address, type });\n\n    let url = '';"
    },
    "time": {
      "start": 1765816358831,
      "end": 1765816358836
    }
  }
}