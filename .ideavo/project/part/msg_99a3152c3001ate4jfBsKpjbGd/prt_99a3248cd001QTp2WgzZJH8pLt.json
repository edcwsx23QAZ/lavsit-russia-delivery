{
  "id": "prt_99a3248cd001QTp2WgzZJH8pLt",
  "messageID": "msg_99a3152c3001ate4jfBsKpjbGd",
  "sessionID": "ses_6852784ecffeuHwynj83p2lr14",
  "type": "tool",
  "tool": "read",
  "callID": "toolu_01HqZ7DFWq68o8X2uoRMYbeX",
  "state": {
    "status": "completed",
    "input": {
      "filePath": "/home/user/project/app/api/furniture-products/route.ts"
    },
    "output": "<file>\n00001| import { NextRequest, NextResponse } from 'next/server';\n00002| \n00003| // –û—Ç–∫–ª—é—á–∞–µ–º —Å—Ç–∞—Ç–∏—á–µ—Å–∫—É—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –¥–ª—è —ç—Ç–æ–≥–æ API\n00004| export const dynamic = 'force-dynamic';\n00005| \n00006| // üîß –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –¥–ª—è –¥–∞–Ω–Ω—ã—Ö –º–µ–±–µ–ª–∏\n00007| interface CargoPlace {\n00008|   placeNumber: number;\n00009|   weight: number; // –∫–≥\n00010|   height: number; // —Å–º\n00011|   depth: number;  // —Å–º (—à–∏—Ä–∏–Ω–∞)\n00012|   length: number; // —Å–º\n00013| }\n00014| \n00015| interface FurnitureProduct {\n00016|   id: string;\n00017|   externalCode: string;\n00018|   name: string;\n00019|   retailPrice: number;\n00020|   isActive: boolean;\n00021|   cargoPlaces: CargoPlace[];\n00022| }\n00023| \n00024| // –ö—ç—à –¥–ª—è –¥–∞–Ω–Ω—ã—Ö (–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç)\n00025| let cachedData: {\n00026|   products: FurnitureProduct[];\n00027|   lastUpdated: number;\n00028| } | null = null;\n00029| \n00030| const CACHE_DURATION = 30 * 60 * 1000; // 30 –º–∏–Ω—É—Ç\n00031| \n00032| export async function GET(request: NextRequest) {\n00033|   try {\n00034|     // –ò—Å–ø–æ–ª—å–∑—É–µ–º nextUrl –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –æ—à–∏–±–∫–∏ dynamic server usage\n00035|     const searchParams = request.nextUrl.searchParams;\n00036|     const query = searchParams.get('q')?.toLowerCase() || '';\n00037|     const forceUpdate = searchParams.get('update') === 'true';\n00038|     \n00039|     // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à (—Å —É—á–µ—Ç–æ–º –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è)\n00040|     const now = Date.now();\n00041|     if (!cachedData || (now - cachedData.lastUpdated) > CACHE_DURATION || forceUpdate) {\n00042|       console.log(forceUpdate ? 'üîÑ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–Ω–æ–π –º–∞—Ç—Ä–∏—Ü—ã...' : 'üîÑ –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à –¥–∞–Ω–Ω—ã—Ö –º–µ–±–µ–ª–∏...');\n00043|       cachedData = await fetchFurnitureData();\n00044|     }\n00045|     \n00046|     // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –ø–æ–∏—Å–∫–æ–≤–æ–º—É –∑–∞–ø—Ä–æ—Å—É —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —á–∞—Å—Ç–∏—á–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞\n00047|     let products = cachedData.products;\n00048|     if (query) {\n00049|       // –†–∞–∑–±–∏–≤–∞–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Å–ª–æ–≤–∞\n00050|       const queryWords = query.split(/\\s+/).filter(word => word.length > 0);\n00051|       \n00052|       products = products.filter(product => {\n00053|         const productText = (product.name + ' ' + product.externalCode).toLowerCase();\n00054|         \n00055|         // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ —Å–ª–æ–≤–∞ –∏–∑ –∑–∞–ø—Ä–æ—Å–∞ —Å–æ–¥–µ—Ä–∂–∞—Ç—Å—è –≤ —Ç–µ–∫—Å—Ç–µ —Ç–æ–≤–∞—Ä–∞\n00056|         return queryWords.every(word => productText.includes(word));\n00057|       });\n00058|     }\n00059|     \n00060|     // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–ª—è –∞–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤—Å–µ —Ç–æ–≤–∞—Ä—ã)\n00061|     const limit = parseInt(searchParams.get('limit') || '0');\n00062|     if (limit > 0) {\n00063|       products = products.slice(0, limit);\n00064|     }\n00065|     \n00066|     return NextResponse.json({\n00067|       success: true,\n00068|       data: products,\n00069|       total: products.length,\n00070|       cached: true,\n00071|       lastUpdated: new Date(cachedData.lastUpdated).toISOString()\n00072|     });\n00073|     \n00074|   } catch (error: any) {\n00075|     console.error('‚ùå –û—à–∏–±–∫–∞ API furniture-products:', error);\n00076|     return NextResponse.json({\n00077|       success: false,\n00078|       error: error.message,\n00079|       data: []\n00080|     }, { status: 500 });\n00081|   }\n00082| }\n00083| \n00084| // üîß –§—É–Ω–∫—Ü–∏—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ Google Sheets\n00085| async function fetchFurnitureData(): Promise<{products: FurnitureProduct[], lastUpdated: number}> {\n00086|   try {\n00087|     // Google Sheets ID –∏–∑ URL\n00088|     const SHEET_ID = '1e0P91PfGKVIuSWDY0ceWkIE7jD-vzD_xrIesBeQno1Y';\n00089|     \n00090|     // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—É–±–ª–∏—á–Ω—ã–π CSV —ç–∫—Å–ø–æ—Ä—Ç Google Sheets\n00091|     const csvUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=0`;\n00092|     \n00093|     console.log('üìä –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ Google Sheets:', csvUrl);\n00094|     \n00095|     const response = await fetch(csvUrl);\n00096|     if (!response.ok) {\n00097|       throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${response.status}`);\n00098|     }\n00099|     \n00100|     const csvText = await response.text();\n00101|     console.log('üìÑ –ü–æ–ª—É—á–µ–Ω—ã CSV –¥–∞–Ω–Ω—ã–µ, —Ä–∞–∑–º–µ—Ä:', csvText.length);\n00102|     \n00103|     // –ü–∞—Ä—Å–∏–º CSV\n00104|     const rows = parseCSV(csvText);\n00105|     console.log('üìã –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫:', rows.length);\n00106|     \n00107|     // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–æ–¥—É–∫—Ç–æ–≤\n00108|     const products = await parseProductsFromRows(rows);\n00109|     console.log('üõãÔ∏è –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤:', products.length);\n00110|     \n00111|     return {\n00112|       products,\n00113|       lastUpdated: Date.now()\n00114|     };\n00115|     \n00116|   } catch (error) {\n00117|     console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –º–µ–±–µ–ª–∏:', error);\n00118|     throw error;\n00119|   }\n00120| }\n00121| \n00122| // üîß –£–ª—É—á—à–µ–Ω–Ω—ã–π CSV –ø–∞—Ä—Å–µ—Ä\n00123| function parseCSV(csvText: string): string[][] {\n00124|   const lines = csvText.split('\\n');\n00125|   const result: string[][] = [];\n00126|   \n00127|   for (const line of lines) {\n00128|     if (line.trim()) {\n00129|       const cells: string[] = [];\n00130|       let current = '';\n00131|       let inQuotes = false;\n00132|       \n00133|       for (let i = 0; i < line.length; i++) {\n00134|         const char = line[i];\n00135|         \n00136|         if (char === '\"') {\n00137|           inQuotes = !inQuotes;\n00138|         } else if (char === ',' && !inQuotes) {\n00139|           cells.push(current.trim());\n00140|           current = '';\n00141|         } else {\n00142|           current += char;\n00143|         }\n00144|       }\n00145|       \n00146|       // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é —è—á–µ–π–∫—É\n00147|       cells.push(current.trim());\n00148|       \n00149|       // –û—á–∏—â–∞–µ–º –∫–∞–≤—ã—á–∫–∏ –∏ –ª–∏—à–Ω–∏–µ —Å–∏–º–≤–æ–ª—ã\n00150|       const cleanedCells = cells.map(cell => \n00151|         cell.replace(/^\"(.*)\"$/, '$1').replace(/\\r/g, '').trim()\n00152|       );\n00153|       \n00154|       result.push(cleanedCells);\n00155|     }\n00156|   }\n00157|   \n00158|   return result;\n00159| }\n00160| \n00161| // üîß –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–æ–∫ –≤ –ø—Ä–æ–¥—É–∫—Ç—ã\n00162| async function parseProductsFromRows(rows: string[][]): Promise<FurnitureProduct[]> {\n00163|   const products: FurnitureProduct[] = [];\n00164|   \n00165|   if (rows.length < 2) {\n00166|     console.warn('‚ö†Ô∏è –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –≤ —Ç–∞–±–ª–∏—Ü–µ');\n00167|     return products;\n00168|   }\n00169|   \n00170|   // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ (–ø–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞)\n00171|   for (let i = 1; i < rows.length; i++) {\n00172|     const row = rows[i];\n00173|     \n00174|     if (row.length < 6) {\n00175|       console.warn(`‚ö†Ô∏è –°—Ç—Ä–æ–∫–∞ ${i + 1} —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö:`, row);\n00176|       continue;\n00177|     }\n00178|     \n00179|     try {\n00180|       // –ú–∞–ø–ø–∏–Ω–≥ –∫–æ–ª–æ–Ω–æ–∫ (—Å–æ–≥–ª–∞—Å–Ω–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ —Ç–∞–±–ª–∏—Ü—ã)\n00181|       const id = row[0] || '';\n00182|       const externalCode = row[1] || '';\n00183|       const isActive = row[2]?.toLowerCase() === '–¥–∞';\n00184|       const name = row[3] || '';\n00185|       const priceStr = row[4] || '0';\n00186|       \n00187|       // –û—á–∏—â–∞–µ–º —Ü–µ–Ω—É –æ—Ç –ª–∏—à–Ω–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤\n00188|       const retailPrice = parseFloat(priceStr.replace(/[^0-9.]/g, '')) || 0;\n00189|       \n00190|       // –ò–∑–≤–ª–µ–∫–∞–µ–º –≥—Ä—É–∑–æ–≤—ã–µ –º–µ—Å—Ç–∞ (–Ω–∞—á–∏–Ω–∞—è —Å –∫–æ–ª–æ–Ω–∫–∏ 5)\n00191|       const cargoPlaces: CargoPlace[] = [];\n00192|       \n00193|       // –í —Ç–∞–±–ª–∏—Ü–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –¥–æ 7 –º–µ—Å—Ç (–ú–µ—Å—Ç–æ 1-7)\n00194|       // –ö–æ–ª–æ–Ω–∫–∏: ID(0), –ö–æ–¥(1), –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å(2), –¢–æ–≤–∞—Ä(3), –¶–µ–Ω–∞(4), \n00195|       // –ú–µ—Å—Ç–æ1: –í–µ—Å(5), –í—ã—Å–æ—Ç–∞(6), –ì–ª—É–±–∏–Ω–∞(7), –î–ª–∏–Ω–∞(8)\n00196|       // –ú–µ—Å—Ç–æ2: –í–µ—Å(9), –í—ã—Å–æ—Ç–∞(10), –ì–ª—É–±–∏–Ω–∞(11), –î–ª–∏–Ω–∞(12) –∏ —Ç.–¥.\n00197|       for (let placeNum = 1; placeNum <= 7; placeNum++) {\n00198|         const baseIndex = 5 + (placeNum - 1) * 4; // 5, 9, 13, 17, 21, 25, 29\n00199|         \n00200|         if (baseIndex + 3 < row.length) {\n00201|           const weight = parseFloat(row[baseIndex]) || 0;      // –í–µ—Å\n00202|           const height = parseFloat(row[baseIndex + 1]) || 0;  // –í—ã—Å–æ—Ç–∞\n00203|           const depth = parseFloat(row[baseIndex + 2]) || 0;   // –ì–ª—É–±–∏–Ω–∞ (—à–∏—Ä–∏–Ω–∞)\n00204|           const length = parseFloat(row[baseIndex + 3]) || 0;  // –î–ª–∏–Ω–∞\n00205|           \n00206|           // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ –±–æ–ª—å—à–µ 0\n00207|           if (weight > 0 || height > 0 || depth > 0 || length > 0) {\n00208|             cargoPlaces.push({\n00209|               placeNumber: placeNum,\n00210|               weight,\n00211|               height,\n00212|               depth,  // –≤ —Ç–∞–±–ª–∏—Ü–µ —ç—Ç–æ \"–≥–ª—É–±–∏–Ω–∞\", –Ω–æ –º—ã –Ω–∞–∑—ã–≤–∞–µ–º depth\n00213|               length\n00214|             });\n00215|           }\n00216|         }\n00217|       }\n00218|       \n00219|       // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–¥—É–∫—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –∏–º—è –∏ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –≥—Ä—É–∑–æ–≤–æ–µ –º–µ—Å—Ç–æ\n00220|       if (name && cargoPlaces.length > 0) {\n00221|         products.push({\n00222|           id,\n00223|           externalCode,\n00224|           name: name.trim(),\n00225|           retailPrice,\n00226|           isActive,\n00227|           cargoPlaces\n00228|         });\n00229|       }\n00230|       \n00231|     } catch (error) {\n00232|       console.warn(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å—Ç—Ä–æ–∫–∏ ${i + 1}:`, error, row);\n00233|     }\n00234|   }\n00235|   \n00236|   // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –∏–º–µ–Ω–∏\n00237|   products.sort((a, b) => a.name.localeCompare(b.name, 'ru'));\n00238|   \n00239|   console.log(`‚úÖ –£—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ ${products.length} —Ç–æ–≤–∞—Ä–æ–≤`);\n00240|   return products;\n00241| }\n</file>",
    "metadata": {
      "preview": "import { NextRequest, NextResponse } from 'next/server';\n\n// –û—Ç–∫–ª—é—á–∞–µ–º —Å—Ç–∞—Ç–∏—á–µ—Å–∫—É—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –¥–ª—è —ç—Ç–æ–≥–æ API\nexport const dynamic = 'force-dynamic';\n\n// üîß –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –¥–ª—è –¥–∞–Ω–Ω—ã—Ö –º–µ–±–µ–ª–∏\ninterface CargoPlace {\n  placeNumber: number;\n  weight: number; // –∫–≥\n  height: number; // —Å–º\n  depth: number;  // —Å–º (—à–∏—Ä–∏–Ω–∞)\n  length: number; // —Å–º\n}\n\ninterface FurnitureProduct {\n  id: string;\n  externalCode: string;\n  name: string;\n  retailPrice: number;\n  isActive: boolean;"
    },
    "title": "app/api/furniture-products/route.ts",
    "time": {
      "start": 1759228611320,
      "end": 1759228611324
    }
  }
}