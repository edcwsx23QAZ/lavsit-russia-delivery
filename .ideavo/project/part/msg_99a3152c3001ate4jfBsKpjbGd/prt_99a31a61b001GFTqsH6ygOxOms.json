{
  "id": "prt_99a31a61b001GFTqsH6ygOxOms",
  "messageID": "msg_99a3152c3001ate4jfBsKpjbGd",
  "sessionID": "ses_6852784ecffeuHwynj83p2lr14",
  "type": "tool",
  "tool": "write",
  "callID": "toolu_01Y4ovrxqrevb4UEM3RHF9bd",
  "state": {
    "status": "error",
    "input": {
      "filePath": "/home/user/project/app/api/furniture-products/route.ts",
      "content": "import { NextRequest, NextResponse } from 'next/server';\n\n// Google Sheets CSV URL - –∏–∑–≤–ª–µ–∫–∞–µ–º ID –∏–∑ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–π —Å—Å—ã–ª–∫–∏\nconst GOOGLE_SHEETS_ID = '1e0P91PfGKVIuSWDY0ceWkIE7jD-vzD_xrIesBeQno1Y';\nconst GOOGLE_SHEETS_CSV_URL = `https://docs.google.com/spreadsheets/d/${GOOGLE_SHEETS_ID}/export?format=csv&gid=0`;\n\n// –ö—ç—à –¥–ª—è –¥–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤\nlet cachedProducts: any[] = [];\nlet lastFetchTime = 0;\nconst CACHE_DURATION = 5 * 60 * 1000; // 5 –º–∏–Ω—É—Ç\n\ninterface Product {\n  id: string;\n  name: string;\n  category?: string;\n  length: number;\n  width: number; \n  height: number;\n  weight?: number;\n  volume?: number;\n  description?: string;\n  keywords?: string[];\n  packaging?: string;\n  transport_notes?: string;\n}\n\n// –§—É–Ω–∫—Ü–∏—è –ø–∞—Ä—Å–∏–Ω–≥–∞ CSV\nfunction parseCSV(csvText: string): Product[] {\n  const lines = csvText.split('\\n').filter(line => line.trim());\n  if (lines.length < 2) return [];\n\n  const headers = lines[0].split(',').map(h => h.trim().replace(/\"/g, ''));\n  const products: Product[] = [];\n\n  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–Ω–¥–µ–∫—Å—ã –∫–æ–ª–æ–Ω–æ–∫ (–≥–∏–±–∫–∏–π –ø–æ–¥—Ö–æ–¥)\n  const nameIndex = headers.findIndex(h => \n    h.toLowerCase().includes('–Ω–∞–∑–≤–∞–Ω–∏–µ') || \n    h.toLowerCase().includes('–Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ') ||\n    h.toLowerCase().includes('—Ç–æ–≤–∞—Ä') ||\n    h.toLowerCase().includes('name')\n  );\n  \n  const categoryIndex = headers.findIndex(h => \n    h.toLowerCase().includes('–∫–∞—Ç–µ–≥–æ—Ä–∏—è') || \n    h.toLowerCase().includes('—Ç–∏–ø') ||\n    h.toLowerCase().includes('category')\n  );\n  \n  const lengthIndex = headers.findIndex(h => \n    h.toLowerCase().includes('–¥–ª–∏–Ω–∞') || \n    h.toLowerCase().includes('–¥–ª–∏–Ω–Ω–∞') ||\n    h.toLowerCase().includes('length')\n  );\n  \n  const widthIndex = headers.findIndex(h => \n    h.toLowerCase().includes('—à–∏—Ä–∏–Ω–∞') || \n    h.toLowerCase().includes('width')\n  );\n  \n  const heightIndex = headers.findIndex(h => \n    h.toLowerCase().includes('–≤—ã—Å–æ—Ç–∞') || \n    h.toLowerCase().includes('height')\n  );\n  \n  const weightIndex = headers.findIndex(h => \n    h.toLowerCase().includes('–≤–µ—Å') || \n    h.toLowerCase().includes('weight')\n  );\n\n  const descriptionIndex = headers.findIndex(h => \n    h.toLowerCase().includes('–æ–ø–∏—Å–∞–Ω–∏–µ') || \n    h.toLowerCase().includes('description') ||\n    h.toLowerCase().includes('–ø—Ä–∏–º–µ—á–∞–Ω–∏–µ')\n  );\n\n  console.log('üìä –ù–∞–π–¥–µ–Ω–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏:', {\n    name: nameIndex,\n    category: categoryIndex,\n    length: lengthIndex,\n    width: widthIndex,\n    height: heightIndex,\n    weight: weightIndex,\n    description: descriptionIndex\n  });\n\n  for (let i = 1; i < lines.length; i++) {\n    try {\n      const cells = lines[i].split(',').map(cell => cell.trim().replace(/\"/g, ''));\n      \n      // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å—Ç—Ä–æ–∫–∏ —Å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –¥–∞–Ω–Ω—ã—Ö\n      if (cells.length < Math.max(nameIndex, lengthIndex, widthIndex, heightIndex) + 1) {\n        continue;\n      }\n\n      const name = nameIndex >= 0 ? cells[nameIndex] : '';\n      const lengthStr = lengthIndex >= 0 ? cells[lengthIndex] : '';\n      const widthStr = widthIndex >= 0 ? cells[widthIndex] : '';\n      const heightStr = heightIndex >= 0 ? cells[heightIndex] : '';\n\n      // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å—Ç—Ä–æ–∫–∏ –±–µ–∑ –æ—Å–Ω–æ–≤–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö\n      if (!name || !lengthStr || !widthStr || !heightStr) {\n        continue;\n      }\n\n      // –ü–∞—Ä—Å–∏–Ω–≥ —á–∏—Å–ª–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π\n      const length = parseFloat(lengthStr.replace(/[^\\d.-]/g, ''));\n      const width = parseFloat(widthStr.replace(/[^\\d.-]/g, ''));\n      const height = parseFloat(heightStr.replace(/[^\\d.-]/g, ''));\n      const weight = weightIndex >= 0 ? parseFloat(cells[weightIndex]?.replace(/[^\\d.-]/g, '') || '0') : undefined;\n\n      // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ä–∞–∑–º–µ—Ä–æ–≤\n      if (isNaN(length) || isNaN(width) || isNaN(height) || \n          length <= 0 || width <= 0 || height <= 0) {\n        console.warn(`‚ö†Ô∏è –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –¥–ª—è —Ç–æ–≤–∞—Ä–∞ \"${name}\": ${length}x${width}x${height}`);\n        continue;\n      }\n\n      // –°–æ–∑–¥–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞\n      const product: Product = {\n        id: `product_${i}_${Date.now()}`,\n        name: name.trim(),\n        category: categoryIndex >= 0 ? cells[categoryIndex]?.trim() : undefined,\n        length: Math.round(length),\n        width: Math.round(width),\n        height: Math.round(height),\n        weight: weight && !isNaN(weight) ? Math.round(weight * 100) / 100 : undefined,\n        volume: Math.round((length * width * height) / 1000000 * 100) / 100, // –≤ –º¬≥\n        description: descriptionIndex >= 0 ? cells[descriptionIndex]?.trim() : undefined\n      };\n\n      // –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è –¥–ª—è –ø—Ä–∞–≤–∏–ª —Ä–∞–∑–º–µ—â–µ–Ω–∏—è\n      const keywords: string[] = [];\n      const lowerName = name.toLowerCase();\n      if (lowerName.includes('—Å—Ç—É–ª') || lowerName.includes('chair')) keywords.push('chair');\n      if (lowerName.includes('–∫—Ä–µ—Å–ª–æ') || lowerName.includes('armchair')) keywords.push('armchair');\n      if (lowerName.includes('—Å—Ç–æ–ª') || lowerName.includes('table')) keywords.push('table');\n      if (lowerName.includes('—à–∫–∞—Ñ') || lowerName.includes('wardrobe')) keywords.push('wardrobe');\n      if (lowerName.includes('–¥–∏–≤–∞–Ω') || lowerName.includes('sofa')) keywords.push('sofa');\n      \n      if (keywords.length > 0) {\n        product.keywords = keywords;\n      }\n\n      products.push(product);\n\n    } catch (error) {\n      console.warn(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å—Ç—Ä–æ–∫–∏ ${i}:`, error);\n      continue;\n    }\n  }\n\n  return products;\n}\n\n// –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Google Sheets\nasync function fetchGoogleSheetsData(): Promise<Product[]> {\n  try {\n    console.log('üì• –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ Google Sheets:', GOOGLE_SHEETS_CSV_URL);\n    \n    const response = await fetch(GOOGLE_SHEETS_CSV_URL, {\n      headers: {\n        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'\n      }\n    });\n\n    if (!response.ok) {\n      throw new Error(`HTTP ${response.status}: ${response.statusText}`);\n    }\n\n    const csvText = await response.text();\n    console.log('üìä –ü–æ–ª—É—á–µ–Ω CSV —Ä–∞–∑–º–µ—Ä–æ–º:', csvText.length, '—Å–∏–º–≤–æ–ª–æ–≤');\n    \n    if (!csvText || csvText.trim().length === 0) {\n      throw new Error('–ü–æ–ª—É—á–µ–Ω –ø—É—Å—Ç–æ–π CSV —Ñ–∞–π–ª');\n    }\n\n    const products = parseCSV(csvText);\n    console.log('‚úÖ –£—Å–ø–µ—à–Ω–æ —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤:', products.length);\n    \n    if (products.length === 0) {\n      console.warn('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å —Ç–æ–≤–∞—Ä—ã –∏–∑ CSV');\n    } else {\n      console.log('üì¶ –ü—Ä–∏–º–µ—Ä—ã —Ç–æ–≤–∞—Ä–æ–≤:', products.slice(0, 3).map(p => ({\n        name: p.name,\n        size: `${p.length}√ó${p.width}√ó${p.height}`,\n        volume: p.volume\n      })));\n    }\n\n    return products;\n\n  } catch (error) {\n    console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ Google Sheets:', error);\n    throw error;\n  }\n}\n\nexport async function GET(request: NextRequest) {\n  try {\n    const { searchParams } = new URL(request.url);\n    const forceUpdate = searchParams.get('update') === 'true';\n    \n    console.log('üîÑ GET /api/furniture-products', { forceUpdate, cacheAge: Date.now() - lastFetchTime });\n\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à\n    const now = Date.now();\n    const cacheExpired = now - lastFetchTime > CACHE_DURATION;\n    \n    if (forceUpdate || cacheExpired || cachedProducts.length === 0) {\n      console.log('üîÑ –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à —Ç–æ–≤–∞—Ä–æ–≤...', {\n        reason: forceUpdate ? '–ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ' : \n               cacheExpired ? '–∫—ç—à —É—Å—Ç–∞—Ä–µ–ª' : '–∫—ç—à –ø—É—Å—Ç'\n      });\n      \n      // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ\n      const freshProducts = await fetchGoogleSheetsData();\n      \n      // –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à\n      cachedProducts = freshProducts;\n      lastFetchTime = now;\n      \n      console.log('‚úÖ –ö—ç—à –æ–±–Ω–æ–≤–ª—ë–Ω:', {\n        productsCount: cachedProducts.length,\n        lastUpdate: new Date(lastFetchTime).toLocaleString('ru-RU')\n      });\n    } else {\n      console.log('üì¶ –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:', {\n        productsCount: cachedProducts.length,\n        cacheAge: Math.round((now - lastFetchTime) / 1000) + 's'\n      });\n    }\n\n    return NextResponse.json({\n      success: true,\n      data: cachedProducts,\n      metadata: {\n        count: cachedProducts.length,\n        lastUpdated: new Date(lastFetchTime).toISOString(),\n        source: 'google_sheets',\n        cacheAge: now - lastFetchTime\n      }\n    });\n\n  } catch (error: any) {\n    console.error('‚ùå –û—à–∏–±–∫–∞ API furniture-products:', error);\n    \n    return NextResponse.json({\n      success: false,\n      error: error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞',\n      details: process.env.NODE_ENV === 'development' ? error.stack : undefined,\n      data: [], // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏\n      metadata: {\n        count: 0,\n        lastUpdated: null,\n        source: 'error'\n      }\n    }, { status: 500 });\n  }\n}\n\n// POST –º–µ—Ç–æ–¥ –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è\nexport async function POST(request: NextRequest) {\n  try {\n    console.log('üîÑ POST /api/furniture-products - –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ');\n    \n    // –û—á–∏—â–∞–µ–º –∫—ç—à\n    cachedProducts = [];\n    lastFetchTime = 0;\n    \n    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ\n    const freshProducts = await fetchGoogleSheetsData();\n    \n    // –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à\n    cachedProducts = freshProducts;\n    lastFetchTime = Date.now();\n    \n    console.log('‚úÖ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ:', {\n      productsCount: cachedProducts.length,\n      timestamp: new Date(lastFetchTime).toLocaleString('ru-RU')\n    });\n\n    return NextResponse.json({\n      success: true,\n      message: '–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã –∏–∑ Google Sheets',\n      data: cachedProducts,\n      metadata: {\n        count: cachedProducts.length,\n        lastUpdated: new Date(lastFetchTime).toISOString(),\n        source: 'google_sheets_forced',\n        cacheAge: 0\n      }\n    });\n\n  } catch (error: any) {\n    console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', error);\n    \n    return NextResponse.json({\n      success: false,\n      error: error.message || '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö',\n      details: process.env.NODE_ENV === 'development' ? error.stack : undefined,\n      data: cachedProducts, // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –µ—Å–ª–∏ –µ—Å—Ç—å\n      metadata: {\n        count: cachedProducts.length,\n        lastUpdated: lastFetchTime > 0 ? new Date(lastFetchTime).toISOString() : null,\n        source: 'error_with_cache'\n      }\n    }, { status: 500 });\n  }\n}"
    },
    "error": "Error: You must read the file /home/user/project/app/api/furniture-products/route.ts before overwriting it. Use the Read tool first",
    "time": {
      "start": 1759228608483,
      "end": 1759228608484
    }
  }
}