{
  "id": "prt_97fd8b350001ELrxsNXz2E4C29",
  "messageID": "msg_97fd60f4d001yy9Td7wYtCNPPV",
  "sessionID": "ses_6852784ecffeuHwynj83p2lr14",
  "type": "tool",
  "tool": "read",
  "callID": "toolu_0192SSi4WtiB7ro4eXGuPFzB",
  "state": {
    "status": "completed",
    "input": {
      "filePath": "/home/user/project/app/page.tsx",
      "offset": 477,
      "limit": 200
    },
    "output": "<file>\n00478|       'калининград': '3013',\n00479|       'курск': '3014',\n00480|       'тверь': '3016',\n00481|       'брянск': '3017',\n00482|       'иваново': '3018',\n00483|       'белгород': '3019',\n00484|       'сочи': '3020',\n00485|       'архангельск': '3022',\n00486|       'калуга': '3025',\n00487|       'владимир': '3026',\n00488|       'мурманск': '3027',\n00489|       'тамбов': '3030',\n00490|       'орел': '3035',\n00491|       'кострома': '3033'\n00492|     };\n00493| \n00494|     try {\n00495|       const normalizedSearchCity = cityName.toLowerCase().trim()\n00496|         .replace(/ё/g, 'е')\n00497|         .replace(/[\\s\\-\\.г\\.]+/g, '')\n00498|         .replace(/область|обл|край|республика|респ|автономный округ|ао/g, '');\n00499| \n00500|       console.log(`Поиск города ПЭК: \"${cityName}\" -> \"${normalizedSearchCity}\"`);\n00501| \n00502|       // Прямое совпадение\n00503|       if (pekCities[normalizedSearchCity]) {\n00504|         console.log(`Найден прямой ID для \"${normalizedSearchCity}\": ${pekCities[normalizedSearchCity]}`);\n00505|         return pekCities[normalizedSearchCity];\n00506|       }\n00507| \n00508|       // Поиск по частичному совпадению\n00509|       for (const [cityKey, cityId] of Object.entries(pekCities)) {\n00510|         const normalizedCityKey = cityKey.replace(/[\\s\\-\\.г\\.]+/g, '');\n00511|         \n00512|         if (normalizedSearchCity.includes(normalizedCityKey) || \n00513|             normalizedCityKey.includes(normalizedSearchCity)) {\n00514|           console.log(`Найден частичный ID для \"${normalizedSearchCity}\" через \"${cityKey}\": ${cityId}`);\n00515|           return cityId;\n00516|         }\n00517|       }\n00518| \n00519|       console.log(`Город ПЭК \"${cityName}\" не найден в базе`);\n00520|       return null;\n00521|     } catch (error) {\n00522|       console.error('Ошибка поиска города ПЭК:', error);\n00523|       \n00524|       // Последняя попытка для основных городов\n00525|       const normalizedCity = cityName.toLowerCase().trim();\n00526|       \n00527|       if (normalizedCity.includes('москва') || normalizedCity.includes('moscow')) {\n00528|         return '2974';\n00529|       }\n00530|       if (normalizedCity.includes('петербург') || normalizedCity.includes('спб')) {\n00531|         return '2975';\n00532|       }\n00533|       if (normalizedCity.includes('екатеринбург')) {\n00534|         return '2976';\n00535|       }\n00536|       \n00537|       return null;\n00538|     }\n00539|   };\n00540| \n00541|   // Получение ID склада ПЭК по адресу через API\n00542|   const findPekWarehouseId = async (address: string): Promise<string | null> => {\n00543|     try {\n00544|       // Используем API ПЭК для поиска склада по адресу\n00545|       const response = await fetch('https://api.pecom.ru/v1/branches/findzonebyaddress', {\n00546|         method: 'POST',\n00547|         headers: {\n00548|           'Content-Type': 'application/json',\n00549|           'Authorization': 'Basic ' + btoa('C04C5BF2AE367BDCBDC71E7DA520A69B167D1984:')\n00550|         },\n00551|         body: JSON.stringify({\n00552|           address: address\n00553|         })\n00554|       });\n00555| \n00556|       if (response.ok) {\n00557|         const data = await response.json();\n00558|         return data.mainWarehouseId || null;\n00559|       }\n00560|       \n00561|       // Фоллбэк для основных городов\n00562|       const fallbackWarehouses: { [key: string]: string } = {\n00563|         'москва': 'dc6c746d-812d-11e4-bbfc-001999d8b3c5',\n00564|         'санкт-петербург': 'b436c978-086d-11e6-b6ca-00155d668909',\n00565|         'екатеринбург': '550e8400-e29b-41d4-a716-446655440000'\n00566|       };\n00567|       \n00568|       const normalizedCity = address.toLowerCase().trim()\n00569|         .replace(/ё/g, 'е')\n00570|         .replace(/[\\s\\-\\.]+/g, '');\n00571|       \n00572|       for (const [city, warehouseId] of Object.entries(fallbackWarehouses)) {\n00573|         const normalizedCityKey = city.replace(/[\\s\\-\\.]+/g, '');\n00574|         if (normalizedCity.includes(normalizedCityKey) || normalizedCityKey.includes(normalizedCity)) {\n00575|           return warehouseId;\n00576|         }\n00577|       }\n00578|       \n00579|       return null;\n00580|     } catch (error) {\n00581|       console.error('Ошибка поиска склада ПЭК:', error);\n00582|       return null;\n00583|     }\n00584|   };\n00585| \n00586|   // Расчет для ПЭК - заглушка, так как API недоступен для внешних запросов\n00587|   // Расчет для ПЭК с использованием публичного API\n00588|   const calculatePEK = async (): Promise<CalculationResult> => {\n00589|     const apiUrl = 'http://calc.pecom.ru/bitrix/components/pecom/calc/ajax.php';\n00590|     \n00591|     try {\n00592|       // Получаем ID городов\n00593|       const fromCityId = await findPekCityId(form.fromCity);\n00594|       const toCityId = await findPekCityId(form.toCity);\n00595|       \n00596|       if (!fromCityId || !toCityId) {\n00597|         return {\n00598|           company: 'ПЭК',\n00599|           price: 0,\n00600|           days: 0,\n00601|           error: `Город не найден в базе ПЭК. Проверьте: ${!fromCityId ? form.fromCity : ''} ${!toCityId ? form.toCity : ''}`.trim(),\n00602|           apiUrl\n00603|         };\n00604|       }\n00605| \n00606|       // Формируем параметры запроса согласно документации\n00607|       const params = new URLSearchParams();\n00608|       \n00609|       // Добавляем грузы согласно формату: Ширина (м), Длина (м), Высота (м), Объем (м3), Вес (кг), Негабарит (0/1), ЗТУ (0/1)\n00610|       form.cargos.forEach((cargo, index) => {\n00611|         const width = cargo.width / 100; // переводим см в метры\n00612|         const length = cargo.length / 100;\n00613|         const height = cargo.height / 100;\n00614|         const volume = width * length * height;\n00615|         const weight = cargo.weight;\n00616|         const isOversized = (width > 2.4 || length > 12 || height > 2.7 || weight > 1500) ? 1 : 0;\n00617|         const needZTU = form.needPackaging ? 1 : 0;\n00618|         \n00619|         params.append(`places[${index}][]`, width.toString());\n00620|         params.append(`places[${index}][]`, length.toString());\n00621|         params.append(`places[${index}][]`, height.toString());\n00622|         params.append(`places[${index}][]`, volume.toString());\n00623|         params.append(`places[${index}][]`, weight.toString());\n00624|         params.append(`places[${index}][]`, isOversized.toString());\n00625|         params.append(`places[${index}][]`, needZTU.toString());\n00626|       });\n00627|       \n00628|       // Параметры забора\n00629|       params.append('take[town]', fromCityId.toString());\n00630|       params.append('take[tent]', '0'); // растентровка\n00631|       params.append('take[gidro]', form.needLoading ? '1' : '0'); // гидролифт\n00632|       params.append('take[manip]', '0'); // манипулятор\n00633|       params.append('take[speed]', '0'); // срочный забор\n00634|       params.append('take[moscow]', '0'); // ограничения по Москве\n00635|       \n00636|       // Параметры доставки\n00637|       params.append('deliver[town]', toCityId.toString());\n00638|       params.append('deliver[tent]', '0');\n00639|       params.append('deliver[gidro]', form.needLoading ? '1' : '0');\n00640|       params.append('deliver[manip]', '0');\n00641|       params.append('deliver[speed]', '0');\n00642|       params.append('deliver[moscow]', '0');\n00643|       \n00644|       // Дополнительные услуги\n00645|       params.append('plombir', '0'); // пломбы\n00646|       params.append('strah', form.needInsurance ? form.declaredValue.toString() : '0'); // страховка\n00647|       params.append('ashan', '0'); // доставка в Ашан\n00648|       params.append('night', '0'); // ночное время\n00649|       params.append('pal', '0'); // запаллечивание\n00650|       params.append('pallets', '0'); // паллетная перевозка\n00651| \n00652|       const fullUrl = `${apiUrl}?${params.toString()}`;\n00653|       const requestData = Object.fromEntries(params);\n00654| \n00655|       // Используем прокси для обхода CORS\n00656|       const proxyUrl = 'https://api.allorigins.win/get?url=' + encodeURIComponent(fullUrl);\n00657|       const response = await fetch(proxyUrl);\n00658|       const proxyData = await response.json();\n00659|       \n00660|       if (!response.ok || !proxyData.contents) {\n00661|         throw new Error('Ошибка загрузки данных через прокси');\n00662|       }\n00663|       \n00664|       const data = JSON.parse(proxyData.contents);\n00665| \n00666|       if (data && !data.error?.length) {\n00667|         let totalPrice = 0;\n00668|         let services: { name: string; description: string; price: number }[] = [];\n00669|         \n00670|         // Собираем стоимость услуг по документации\n00671|         if (data.take?.[2]) {\n00672|           const price = parseFloat(data.take[2]);\n00673|           totalPrice += price;\n00674|           services.push({ \n00675|             name: data.take[0] || 'Забор груза', \n00676|             description: data.take[1] || '', \n00677|             price \n\n(File has more lines. Use 'offset' parameter to read beyond line 677)\n</file>",
    "metadata": {
      "preview": "      'калининград': '3013',\n      'курск': '3014',\n      'тверь': '3016',\n      'брянск': '3017',\n      'иваново': '3018',\n      'белгород': '3019',\n      'сочи': '3020',\n      'архангельск': '3022',\n      'калуга': '3025',\n      'владимир': '3026',\n      'мурманск': '3027',\n      'тамбов': '3030',\n      'орел': '3035',\n      'кострома': '3033'\n    };\n\n    try {\n      const normalizedSearchCity = cityName.toLowerCase().trim()\n        .replace(/ё/g, 'е')\n        .replace(/[\\s\\-\\.г\\.]+/g, '')"
    },
    "title": "app/page.tsx",
    "time": {
      "start": 1758786532770,
      "end": 1758786532777
    }
  }
}