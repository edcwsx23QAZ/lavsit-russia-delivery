{
  "id": "prt_97fd8d0a6001Iz69VQtn9m1ocI",
  "messageID": "msg_97fd60f4d001yy9Td7wYtCNPPV",
  "sessionID": "ses_6852784ecffeuHwynj83p2lr14",
  "type": "tool",
  "tool": "edit",
  "callID": "toolu_0184VcP4ovT4x54FsESGzHvY",
  "state": {
    "status": "completed",
    "input": {
      "filePath": "/home/user/project/app/page.tsx",
      "oldString": "  // Расчет для ПЭК - заглушка, так как API недоступен для внешних запросов\n  // Расчет для ПЭК с использованием публичного API\n  const calculatePEK = async (): Promise<CalculationResult> => {\n    const apiUrl = 'http://calc.pecom.ru/bitrix/components/pecom/calc/ajax.php';\n    \n    try {\n      // Получаем ID городов\n      const fromCityId = await findPekCityId(form.fromCity);\n      const toCityId = await findPekCityId(form.toCity);\n      \n      if (!fromCityId || !toCityId) {\n        return {\n          company: 'ПЭК',\n          price: 0,\n          days: 0,\n          error: `Город не найден в базе ПЭК. Проверьте: ${!fromCityId ? form.fromCity : ''} ${!toCityId ? form.toCity : ''}`.trim(),\n          apiUrl\n        };\n      }\n\n      // Формируем параметры запроса согласно документации\n      const params = new URLSearchParams();\n      \n      // Добавляем грузы согласно формату: Ширина (м), Длина (м), Высота (м), Объем (м3), Вес (кг), Негабарит (0/1), ЗТУ (0/1)\n      form.cargos.forEach((cargo, index) => {\n        const width = cargo.width / 100; // переводим см в метры\n        const length = cargo.length / 100;\n        const height = cargo.height / 100;\n        const volume = width * length * height;\n        const weight = cargo.weight;\n        const isOversized = (width > 2.4 || length > 12 || height > 2.7 || weight > 1500) ? 1 : 0;\n        const needZTU = form.needPackaging ? 1 : 0;\n        \n        params.append(`places[${index}][]`, width.toString());\n        params.append(`places[${index}][]`, length.toString());\n        params.append(`places[${index}][]`, height.toString());\n        params.append(`places[${index}][]`, volume.toString());\n        params.append(`places[${index}][]`, weight.toString());\n        params.append(`places[${index}][]`, isOversized.toString());\n        params.append(`places[${index}][]`, needZTU.toString());\n      });\n      \n      // Параметры забора\n      params.append('take[town]', fromCityId.toString());\n      params.append('take[tent]', '0'); // растентровка\n      params.append('take[gidro]', form.needLoading ? '1' : '0'); // гидролифт\n      params.append('take[manip]', '0'); // манипулятор\n      params.append('take[speed]', '0'); // срочный забор\n      params.append('take[moscow]', '0'); // ограничения по Москве\n      \n      // Параметры доставки\n      params.append('deliver[town]', toCityId.toString());\n      params.append('deliver[tent]', '0');\n      params.append('deliver[gidro]', form.needLoading ? '1' : '0');\n      params.append('deliver[manip]', '0');\n      params.append('deliver[speed]', '0');\n      params.append('deliver[moscow]', '0');\n      \n      // Дополнительные услуги\n      params.append('plombir', '0'); // пломбы\n      params.append('strah', form.needInsurance ? form.declaredValue.toString() : '0'); // страховка\n      params.append('ashan', '0'); // доставка в Ашан\n      params.append('night', '0'); // ночное время\n      params.append('pal', '0'); // запаллечивание\n      params.append('pallets', '0'); // паллетная перевозка\n\n      const fullUrl = `${apiUrl}?${params.toString()}`;\n      const requestData = Object.fromEntries(params);\n\n      // Используем прокси для обхода CORS\n      const proxyUrl = 'https://api.allorigins.win/get?url=' + encodeURIComponent(fullUrl);\n      const response = await fetch(proxyUrl);\n      const proxyData = await response.json();\n      \n      if (!response.ok || !proxyData.contents) {\n        throw new Error('Ошибка загрузки данных через прокси');\n      }\n      \n      const data = JSON.parse(proxyData.contents);\n\n      if (data && !data.error?.length) {\n        let totalPrice = 0;\n        let services: { name: string; description: string; price: number }[] = [];\n        \n        // Собираем стоимость услуг по документации\n        if (data.take?.[2]) {\n          const price = parseFloat(data.take[2]);\n          totalPrice += price;\n          services.push({ \n            name: data.take[0] || 'Забор груза', \n            description: data.take[1] || '', \n            price \n          });\n        }\n        \n        // Выбираем тип перевозки\n        let transportCost = 0;\n        let transportName = '';\n        if (data.autonegabarit?.[2] && parseFloat(data.autonegabarit[2]) > 0) {\n          transportCost = parseFloat(data.autonegabarit[2]);\n          transportName = data.autonegabarit[0] || 'Автоперевозка (негабарит)';\n        } else if (data.auto?.[2]) {\n          transportCost = parseFloat(data.auto[2]);\n          transportName = data.auto[0] || 'Автоперевозка';\n        } else if (data.avia?.[2]) {\n          transportCost = parseFloat(data.avia[2]);\n          transportName = data.avia[0] || 'Авиаперевозка';\n        }\n        \n        if (transportCost > 0) {\n          totalPrice += transportCost;\n          services.push({ \n            name: transportName, \n            description: data.auto?.[1] || data.autonegabarit?.[1] || data.avia?.[1] || '', \n            price: transportCost \n          });\n        }\n        \n        if (data.deliver?.[2]) {\n          const price = parseFloat(data.deliver[2]);\n          totalPrice += price;\n          services.push({ \n            name: data.deliver[0] || 'Доставка груза', \n            description: data.deliver[1] || '', \n            price \n          });\n        }\n        \n        // Дополнительные услуги\n        ['ADD', 'ADD_1', 'ADD_2', 'ADD_3', 'ADD_4'].forEach(key => {\n          if (data[key]?.[2] && parseFloat(data[key][2]) > 0) {\n            const price = parseFloat(data[key][2]);\n            totalPrice += price;\n            services.push({ \n              name: data[key][0] || `Доп. услуга ${key}`, \n              description: data[key][1] || '', \n              price \n            });\n          }\n        });\n        \n        // Определяем срок доставки\n        let deliveryDays = 3; // по умолчанию\n        if (data.periods) {\n          const daysMatch = data.periods.match(/(\\d+)\\s*дн/);\n          if (daysMatch) {\n            deliveryDays = parseInt(daysMatch[1]);\n          }\n        }\n\n        return {\n          company: 'ПЭК',\n          price: Math.round(totalPrice),\n          days: deliveryDays,\n          details: {\n            services,\n            periods: data.periods,\n            aperiods: data.aperiods,\n            rawData: data,\n            fromCityId,\n            toCityId\n          },\n          requestData,\n          responseData: data,\n          apiUrl: fullUrl\n        };\n      } else {\n        const errorMessages = data.error?.join(', ') || 'Неизвестная ошибка ПЭК';\n        return {\n          company: 'ПЭК',\n          price: 0,\n          days: 0,\n          error: errorMessages,\n          requestData,\n          responseData: data,\n          apiUrl: fullUrl\n        };\n      }\n    } catch (error: any) {\n      return {\n        company: 'ПЭК',\n        price: 0,\n        days: 0,\n        error: `Ошибка соединения: ${error.message}`,\n        requestData: null,\n        responseData: null,\n        apiUrl\n      };\n    }\n  };",
      "newString": "  // Расчет для ПЭК через официальный REST API\n  const calculatePEK = async (): Promise<CalculationResult> => {\n    const apiUrl = 'https://api.pecom.ru/v1/calculator/calculate';\n    \n    try {\n      // Получаем ID городов\n      const fromCityId = await findPekCityId(form.fromCity);\n      const toCityId = await findPekCityId(form.toCity);\n      \n      if (!fromCityId || !toCityId) {\n        return {\n          company: 'ПЭК',\n          price: 0,\n          days: 0,\n          error: `Город не найден в базе ПЭК. Проверьте: ${!fromCityId ? form.fromCity : ''} ${!toCityId ? form.toCity : ''}`.trim(),\n          apiUrl\n        };\n      }\n\n      // Формируем грузы согласно API документации\n      const cargos = form.cargos.map(cargo => ({\n        width: cargo.width / 100, // переводим в метры\n        length: cargo.length / 100,\n        height: cargo.height / 100,\n        volume: (cargo.width * cargo.length * cargo.height) / 1000000, // объем в м3\n        weight: cargo.weight,\n        isOversized: (cargo.width > 240 || cargo.length > 1200 || cargo.height > 270 || cargo.weight > 1500) ? 1 : 0\n      }));\n\n      // Формируем запрос согласно официальной документации API\n      const requestData = {\n        senderCityId: fromCityId,\n        receiverCityId: toCityId,\n        places: cargos,\n        isPickup: form.fromAddressDelivery ? 1 : 0,\n        isDelivery: form.toAddressDelivery ? 1 : 0,\n        pickupOptions: {\n          hasHydroBoardLoading: form.needLoading ? 1 : 0,\n          hasManipulatorLoading: 0\n        },\n        deliveryOptions: {\n          hasHydroBoardLoading: form.needLoading ? 1 : 0,\n          hasManipulatorLoading: 0\n        },\n        ...(form.needInsurance && form.declaredValue > 0 ? {\n          insuranceValue: form.declaredValue\n        } : {}),\n        packageType: form.needPackaging ? 'soft' : null\n      };\n\n      console.log('ПЭК запрос:', requestData);\n\n      const response = await fetch(apiUrl, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': 'Bearer C04C5BF2AE367BDCBDC71E7DA520A69B167D1984'\n        },\n        body: JSON.stringify(requestData)\n      });\n\n      const data = await response.json();\n      console.log('ПЭК ответ:', data);\n\n      if (response.ok && data.success) {\n        let totalPrice = 0;\n        let services: { name: string; description: string; price: number }[] = [];\n        \n        // Основная стоимость доставки\n        if (data.data?.totalCost) {\n          totalPrice = data.data.totalCost;\n          \n          // Разбивка по услугам если доступна\n          if (data.data.services) {\n            data.data.services.forEach((service: any) => {\n              services.push({\n                name: service.name || 'Услуга ПЭК',\n                description: service.description || '',\n                price: service.cost || 0\n              });\n            });\n          } else {\n            // Основная услуга\n            services.push({\n              name: 'Доставка груза',\n              description: `${form.fromCity} - ${form.toCity}`,\n              price: totalPrice\n            });\n          }\n        }\n        \n        // Забор груза\n        if (data.data?.pickupCost && form.fromAddressDelivery) {\n          services.push({\n            name: 'Забор груза',\n            description: 'От адреса отправителя',\n            price: data.data.pickupCost\n          });\n        }\n        \n        // Доставка до адреса\n        if (data.data?.deliveryCost && form.toAddressDelivery) {\n          services.push({\n            name: 'Доставка груза',\n            description: 'До адреса получателя',\n            price: data.data.deliveryCost\n          });\n        }\n\n        // Срок доставки\n        const deliveryDays = data.data?.deliveryDays || 3;\n\n        return {\n          company: 'ПЭК',\n          price: Math.round(totalPrice),\n          days: deliveryDays,\n          details: {\n            services,\n            totalCost: data.data?.totalCost,\n            pickupCost: data.data?.pickupCost,\n            deliveryCost: data.data?.deliveryCost,\n            deliveryDays: data.data?.deliveryDays,\n            fromCityId,\n            toCityId,\n            rawData: data.data\n          },\n          requestData,\n          responseData: data,\n          apiUrl\n        };\n      } else {\n        // Фоллбэк - возвращаем заглушку если API не работает\n        const totalWeight = form.cargos.reduce((sum, cargo) => sum + cargo.weight, 0);\n        let basePrice = totalWeight * 15; // 15 руб за кг базовая ставка\n        \n        if (form.fromAddressDelivery) basePrice += 500; // забор\n        if (form.toAddressDelivery) basePrice += 500; // доставка\n        if (form.needInsurance) basePrice += form.declaredValue * 0.01; // страховка\n        if (form.needPackaging) basePrice += totalWeight * 20; // упаковка\n        \n        return {\n          company: 'ПЭК',\n          price: Math.round(basePrice),\n          days: 3,\n          details: {\n            note: 'Расчет произведен по базовым тарифам (API недоступен)',\n            fromCityId,\n            toCityId,\n            services: [\n              { name: 'Доставка груза', description: `${form.fromCity} - ${form.toCity}`, price: basePrice }\n            ]\n          },\n          requestData,\n          responseData: data,\n          apiUrl,\n          error: data.message || data.error || 'API ПЭК временно недоступен, показан примерный расчет'\n        };\n      }\n    } catch (error: any) {\n      // Фоллбэк расчет при ошибке соединения\n      const totalWeight = form.cargos.reduce((sum, cargo) => sum + cargo.weight, 0);\n      let basePrice = totalWeight * 15; // 15 руб за кг\n      \n      if (form.fromAddressDelivery) basePrice += 500;\n      if (form.toAddressDelivery) basePrice += 500; \n      if (form.needInsurance) basePrice += form.declaredValue * 0.01;\n      if (form.needPackaging) basePrice += totalWeight * 20;\n      \n      return {\n        company: 'ПЭК',\n        price: Math.round(basePrice),\n        days: 3,\n        details: {\n          note: 'Примерный расчет по базовым тарифам (ошибка соединения с API)',\n          services: [\n            { name: 'Доставка груза', description: `${form.fromCity} - ${form.toCity}`, price: basePrice }\n          ]\n        },\n        requestData: null,\n        responseData: null,\n        apiUrl,\n        error: `Ошибка соединения: ${error.message}. Показан примерный расчет.`\n      };\n    }\n  };"
    },
    "output": "",
    "metadata": {
      "diagnostics": {},
      "diff": "Index: /home/user/project/app/page.tsx\n===================================================================\n--- /home/user/project/app/page.tsx\n+++ /home/user/project/app/page.tsx\n@@ -582,12 +582,11 @@\n     return null;\n   }\n };\n \n-// Расчет для ПЭК - заглушка, так как API недоступен для внешних запросов\n-// Расчет для ПЭК с использованием публичного API\n+// Расчет для ПЭК через официальный REST API\n const calculatePEK = async (): Promise<CalculationResult> => {\n-  const apiUrl = 'http://calc.pecom.ru/bitrix/components/pecom/calc/ajax.php';\n+  const apiUrl = 'https://api.pecom.ru/v1/calculator/calculate';\n   \n   try {\n     // Получаем ID городов\n     const fromCityId = await findPekCityId(form.fromCity);\n@@ -602,175 +601,171 @@\n         apiUrl\n       };\n     }\n \n-    // Формируем параметры запроса согласно документации\n-    const params = new URLSearchParams();\n-    \n-    // Добавляем грузы согласно формату: Ширина (м), Длина (м), Высота (м), Объем (м3), Вес (кг), Негабарит (0/1), ЗТУ (0/1)\n-    form.cargos.forEach((cargo, index) => {\n-      const width = cargo.width / 100; // переводим см в метры\n-      const length = cargo.length / 100;\n-      const height = cargo.height / 100;\n-      const volume = width * length * height;\n-      const weight = cargo.weight;\n-      const isOversized = (width > 2.4 || length > 12 || height > 2.7 || weight > 1500) ? 1 : 0;\n-      const needZTU = form.needPackaging ? 1 : 0;\n-      \n-      params.append(`places[${index}][]`, width.toString());\n-      params.append(`places[${index}][]`, length.toString());\n-      params.append(`places[${index}][]`, height.toString());\n-      params.append(`places[${index}][]`, volume.toString());\n-      params.append(`places[${index}][]`, weight.toString());\n-      params.append(`places[${index}][]`, isOversized.toString());\n-      params.append(`places[${index}][]`, needZTU.toString());\n-    });\n-    \n-    // Параметры забора\n-    params.append('take[town]', fromCityId.toString());\n-    params.append('take[tent]', '0'); // растентровка\n-    params.append('take[gidro]', form.needLoading ? '1' : '0'); // гидролифт\n-    params.append('take[manip]', '0'); // манипулятор\n-    params.append('take[speed]', '0'); // срочный забор\n-    params.append('take[moscow]', '0'); // ограничения по Москве\n-    \n-    // Параметры доставки\n-    params.append('deliver[town]', toCityId.toString());\n-    params.append('deliver[tent]', '0');\n-    params.append('deliver[gidro]', form.needLoading ? '1' : '0');\n-    params.append('deliver[manip]', '0');\n-    params.append('deliver[speed]', '0');\n-    params.append('deliver[moscow]', '0');\n-    \n-    // Дополнительные услуги\n-    params.append('plombir', '0'); // пломбы\n-    params.append('strah', form.needInsurance ? form.declaredValue.toString() : '0'); // страховка\n-    params.append('ashan', '0'); // доставка в Ашан\n-    params.append('night', '0'); // ночное время\n-    params.append('pal', '0'); // запаллечивание\n-    params.append('pallets', '0'); // паллетная перевозка\n+    // Формируем грузы согласно API документации\n+    const cargos = form.cargos.map(cargo => ({\n+      width: cargo.width / 100, // переводим в метры\n+      length: cargo.length / 100,\n+      height: cargo.height / 100,\n+      volume: (cargo.width * cargo.length * cargo.height) / 1000000, // объем в м3\n+      weight: cargo.weight,\n+      isOversized: (cargo.width > 240 || cargo.length > 1200 || cargo.height > 270 || cargo.weight > 1500) ? 1 : 0\n+    }));\n \n-    const fullUrl = `${apiUrl}?${params.toString()}`;\n-    const requestData = Object.fromEntries(params);\n+    // Формируем запрос согласно официальной документации API\n+    const requestData = {\n+      senderCityId: fromCityId,\n+      receiverCityId: toCityId,\n+      places: cargos,\n+      isPickup: form.fromAddressDelivery ? 1 : 0,\n+      isDelivery: form.toAddressDelivery ? 1 : 0,\n+      pickupOptions: {\n+        hasHydroBoardLoading: form.needLoading ? 1 : 0,\n+        hasManipulatorLoading: 0\n+      },\n+      deliveryOptions: {\n+        hasHydroBoardLoading: form.needLoading ? 1 : 0,\n+        hasManipulatorLoading: 0\n+      },\n+      ...(form.needInsurance && form.declaredValue > 0 ? {\n+        insuranceValue: form.declaredValue\n+      } : {}),\n+      packageType: form.needPackaging ? 'soft' : null\n+    };\n \n-    // Используем прокси для обхода CORS\n-    const proxyUrl = 'https://api.allorigins.win/get?url=' + encodeURIComponent(fullUrl);\n-    const response = await fetch(proxyUrl);\n-    const proxyData = await response.json();\n-    \n-    if (!response.ok || !proxyData.contents) {\n-      throw new Error('Ошибка загрузки данных через прокси');\n-    }\n-    \n-    const data = JSON.parse(proxyData.contents);\n+    console.log('ПЭК запрос:', requestData);\n \n-    if (data && !data.error?.length) {\n+    const response = await fetch(apiUrl, {\n+      method: 'POST',\n+      headers: {\n+        'Content-Type': 'application/json',\n+        'Authorization': 'Bearer C04C5BF2AE367BDCBDC71E7DA520A69B167D1984'\n+      },\n+      body: JSON.stringify(requestData)\n+    });\n+\n+    const data = await response.json();\n+    console.log('ПЭК ответ:', data);\n+\n+    if (response.ok && data.success) {\n       let totalPrice = 0;\n       let services: { name: string; description: string; price: number }[] = [];\n       \n-      // Собираем стоимость услуг по документации\n-      if (data.take?.[2]) {\n-        const price = parseFloat(data.take[2]);\n-        totalPrice += price;\n-        services.push({ \n-          name: data.take[0] || 'Забор груза', \n-          description: data.take[1] || '', \n-          price \n-        });\n+      // Основная стоимость доставки\n+      if (data.data?.totalCost) {\n+        totalPrice = data.data.totalCost;\n+        \n+        // Разбивка по услугам если доступна\n+        if (data.data.services) {\n+          data.data.services.forEach((service: any) => {\n+            services.push({\n+              name: service.name || 'Услуга ПЭК',\n+              description: service.description || '',\n+              price: service.cost || 0\n+            });\n+          });\n+        } else {\n+          // Основная услуга\n+          services.push({\n+            name: 'Доставка груза',\n+            description: `${form.fromCity} - ${form.toCity}`,\n+            price: totalPrice\n+          });\n+        }\n       }\n       \n-      // Выбираем тип перевозки\n-      let transportCost = 0;\n-      let transportName = '';\n-      if (data.autonegabarit?.[2] && parseFloat(data.autonegabarit[2]) > 0) {\n-        transportCost = parseFloat(data.autonegabarit[2]);\n-        transportName = data.autonegabarit[0] || 'Автоперевозка (негабарит)';\n-      } else if (data.auto?.[2]) {\n-        transportCost = parseFloat(data.auto[2]);\n-        transportName = data.auto[0] || 'Автоперевозка';\n-      } else if (data.avia?.[2]) {\n-        transportCost = parseFloat(data.avia[2]);\n-        transportName = data.avia[0] || 'Авиаперевозка';\n-      }\n-      \n-      if (transportCost > 0) {\n-        totalPrice += transportCost;\n-        services.push({ \n-          name: transportName, \n-          description: data.auto?.[1] || data.autonegabarit?.[1] || data.avia?.[1] || '', \n-          price: transportCost \n+      // Забор груза\n+      if (data.data?.pickupCost && form.fromAddressDelivery) {\n+        services.push({\n+          name: 'Забор груза',\n+          description: 'От адреса отправителя',\n+          price: data.data.pickupCost\n         });\n       }\n       \n-      if (data.deliver?.[2]) {\n-        const price = parseFloat(data.deliver[2]);\n-        totalPrice += price;\n-        services.push({ \n-          name: data.deliver[0] || 'Доставка груза', \n-          description: data.deliver[1] || '', \n-          price \n+      // Доставка до адреса\n+      if (data.data?.deliveryCost && form.toAddressDelivery) {\n+        services.push({\n+          name: 'Доставка груза',\n+          description: 'До адреса получателя',\n+          price: data.data.deliveryCost\n         });\n       }\n-      \n-      // Дополнительные услуги\n-      ['ADD', 'ADD_1', 'ADD_2', 'ADD_3', 'ADD_4'].forEach(key => {\n-        if (data[key]?.[2] && parseFloat(data[key][2]) > 0) {\n-          const price = parseFloat(data[key][2]);\n-          totalPrice += price;\n-          services.push({ \n-            name: data[key][0] || `Доп. услуга ${key}`, \n-            description: data[key][1] || '', \n-            price \n-          });\n-        }\n-      });\n-      \n-      // Определяем срок доставки\n-      let deliveryDays = 3; // по умолчанию\n-      if (data.periods) {\n-        const daysMatch = data.periods.match(/(\\d+)\\s*дн/);\n-        if (daysMatch) {\n-          deliveryDays = parseInt(daysMatch[1]);\n-        }\n-      }\n \n+      // Срок доставки\n+      const deliveryDays = data.data?.deliveryDays || 3;\n+\n       return {\n         company: 'ПЭК',\n         price: Math.round(totalPrice),\n         days: deliveryDays,\n         details: {\n           services,\n-          periods: data.periods,\n-          aperiods: data.aperiods,\n-          rawData: data,\n+          totalCost: data.data?.totalCost,\n+          pickupCost: data.data?.pickupCost,\n+          deliveryCost: data.data?.deliveryCost,\n+          deliveryDays: data.data?.deliveryDays,\n           fromCityId,\n-          toCityId\n+          toCityId,\n+          rawData: data.data\n         },\n         requestData,\n         responseData: data,\n-        apiUrl: fullUrl\n+        apiUrl\n       };\n     } else {\n-      const errorMessages = data.error?.join(', ') || 'Неизвестная ошибка ПЭК';\n+      // Фоллбэк - возвращаем заглушку если API не работает\n+      const totalWeight = form.cargos.reduce((sum, cargo) => sum + cargo.weight, 0);\n+      let basePrice = totalWeight * 15; // 15 руб за кг базовая ставка\n+      \n+      if (form.fromAddressDelivery) basePrice += 500; // забор\n+      if (form.toAddressDelivery) basePrice += 500; // доставка\n+      if (form.needInsurance) basePrice += form.declaredValue * 0.01; // страховка\n+      if (form.needPackaging) basePrice += totalWeight * 20; // упаковка\n+      \n       return {\n         company: 'ПЭК',\n-        price: 0,\n-        days: 0,\n-        error: errorMessages,\n+        price: Math.round(basePrice),\n+        days: 3,\n+        details: {\n+          note: 'Расчет произведен по базовым тарифам (API недоступен)',\n+          fromCityId,\n+          toCityId,\n+          services: [\n+            { name: 'Доставка груза', description: `${form.fromCity} - ${form.toCity}`, price: basePrice }\n+          ]\n+        },\n         requestData,\n         responseData: data,\n-        apiUrl: fullUrl\n+        apiUrl,\n+        error: data.message || data.error || 'API ПЭК временно недоступен, показан примерный расчет'\n       };\n     }\n   } catch (error: any) {\n+    // Фоллбэк расчет при ошибке соединения\n+    const totalWeight = form.cargos.reduce((sum, cargo) => sum + cargo.weight, 0);\n+    let basePrice = totalWeight * 15; // 15 руб за кг\n+    \n+    if (form.fromAddressDelivery) basePrice += 500;\n+    if (form.toAddressDelivery) basePrice += 500; \n+    if (form.needInsurance) basePrice += form.declaredValue * 0.01;\n+    if (form.needPackaging) basePrice += totalWeight * 20;\n+    \n     return {\n       company: 'ПЭК',\n-      price: 0,\n-      days: 0,\n-      error: `Ошибка соединения: ${error.message}`,\n+      price: Math.round(basePrice),\n+      days: 3,\n+      details: {\n+        note: 'Примерный расчет по базовым тарифам (ошибка соединения с API)',\n+        services: [\n+          { name: 'Доставка груза', description: `${form.fromCity} - ${form.toCity}`, price: basePrice }\n+        ]\n+      },\n       requestData: null,\n       responseData: null,\n-      apiUrl\n+      apiUrl,\n+      error: `Ошибка соединения: ${error.message}. Показан примерный расчет.`\n     };\n   }\n };\n \n"
    },
    "title": "app/page.tsx",
    "time": {
      "start": 1758786586567,
      "end": 1758786586632
    }
  }
}