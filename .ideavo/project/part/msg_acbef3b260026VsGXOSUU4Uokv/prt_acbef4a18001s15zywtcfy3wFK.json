{
  "id": "prt_acbef4a18001s15zywtcfy3wFK",
  "sessionID": "ses_54b97e247ffenCZZa4jZiIWD0l",
  "messageID": "msg_acbef3b260026VsGXOSUU4Uokv",
  "type": "tool",
  "callID": "call_59a26313b18e4f0e91753efc",
  "tool": "edit",
  "state": {
    "status": "completed",
    "input": {
      "filePath": "/home/user/project/app/api/vozovoz-parser/route.ts",
      "oldString": "    await page.waitForTimeout(2000);",
      "newString": "    await new Promise(resolve => setTimeout(resolve, 2000));",
      "replaceAll": true
    },
    "output": "",
    "title": "app/api/vozovoz-parser/route.ts",
    "metadata": {
      "diagnostics": {},
      "diff": "Index: /home/user/project/app/api/vozovoz-parser/route.ts\n===================================================================\n--- /home/user/project/app/api/vozovoz-parser/route.ts\n+++ /home/user/project/app/api/vozovoz-parser/route.ts\n@@ -154,9 +154,9 @@\n   );\n   if (nextBtn) (nextBtn as HTMLElement).click();\n });\n \n-await page.waitForTimeout(2000);\n+await new Promise(resolve => setTimeout(resolve, 2000));\n \n // –í–≤–æ–¥ –ø–∞—Ä–æ–ª—è\n const passwordSelectors = [\n   'input[name=\"password\"]',\n@@ -269,9 +269,9 @@\n     continue;\n   }\n }\n \n-await page.waitForTimeout(2000);\n+await new Promise(resolve => setTimeout(resolve, 2000));\n \n // –í—ã–±–æ—Ä —Ç–∏–ø–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è\n if (params.fromAddressDelivery) {\n   // –í—ã–±–æ—Ä \"–ê–¥—Ä–µ—Å\"\n@@ -359,9 +359,9 @@\n     if (terminalLabel) (terminalLabel as HTMLElement).click();\n   });\n }\n \n-await page.waitForTimeout(2000);\n+await new Promise(resolve => setTimeout(resolve, 2000));\n \n // –®–∞–≥ 5: –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –≥—Ä—É–∑–∞\n console.log('üì¶ –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –≥—Ä—É–∑–∞...');\n \n@@ -406,9 +406,9 @@\n     }\n   }\n }\n \n-await page.waitForTimeout(2000);\n+await new Promise(resolve => setTimeout(resolve, 2000));\n \n // –®–∞–≥ 6: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏\n console.log('üõ°Ô∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —É—Å–ª—É–≥...');\n \n",
      "filediff": {
        "file": "/home/user/project/app/api/vozovoz-parser/route.ts",
        "before": "import { NextRequest, NextResponse } from 'next/server';\nimport puppeteer from 'puppeteer';\n\ninterface VozovozParserParams {\n  fromCity: string;\n  toCity: string;\n  fromAddressDelivery: boolean;\n  toAddressDelivery: boolean;\n  fromAddress?: string;\n  toAddress?: string;\n  length: number;\n  width: number;\n  height: number;\n  weight: number;\n  needInsurance: boolean;\n  declaredValue?: number;\n  needPackaging: boolean;\n  needLoading: boolean;\n  hasFreightElevator: boolean;\n  floor: number;\n}\n\ninterface ServiceItem {\n  name: string;\n  basePrice?: number;\n  price: number;\n  discount?: number;\n}\n\ninterface ParsedResult {\n  totalCost: number;\n  services: ServiceItem[];\n  deliveryTime?: string;\n  warnings?: string[];\n  parseTime?: number;\n}\n\n// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ —Ü–µ–Ω—ã –∏–∑ —Å—Ç—Ä–æ–∫–∏\nfunction parsePrice(priceText: string): number {\n  if (!priceText) return 0;\n  const cleaned = priceText.replace(/[^\\d]/g, '');\n  return parseInt(cleaned) || 0;\n}\n\n// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–∂–∏–¥–∞–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–∞ —Å —Ç–∞–π–º–∞—É—Ç–æ–º\nasync function waitForSelectorWithTimeout(page: any, selector: string, timeout: number = 30000) {\n  try {\n    await page.waitForSelector(selector, { timeout });\n    return true;\n  } catch (error) {\n    console.error(`–≠–ª–µ–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω: ${selector}`, error);\n    return false;\n  }\n}\n\n// –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–∞—Ä—Å–∏–Ω–≥–∞\nasync function parseVozovozWebsite(params: VozovozParserParams): Promise<ParsedResult> {\n  const startTime = Date.now();\n  let browser;\n  \n  try {\n    // –ó–∞–ø—É—Å–∫ –±—Ä–∞—É–∑–µ—Ä–∞ —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –¥–ª—è –æ–±—Ö–æ–¥–∞ –¥–µ—Ç–µ–∫—Ü–∏–∏\n    browser = await puppeteer.launch({\n      headless: true,\n      args: [\n        '--no-sandbox',\n        '--disable-setuid-sandbox',\n        '--disable-dev-shm-usage',\n        '--disable-accelerated-2d-canvas',\n        '--no-first-run',\n        '--no-zygote',\n        '--single-process',\n        '--disable-gpu'\n      ]\n    });\n\n    const page = await browser.newPage();\n    \n    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ user-agent –∏ viewport\n    await page.setUserAgent('Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36');\n    await page.setViewport({ width: 1920, height: 1080 });\n\n    console.log('üï∑Ô∏è –ó–∞–ø—É—Å–∫ –ø–∞—Ä—Å–µ—Ä–∞ Vozovoz...');\n\n    // –®–∞–≥ 1: –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å–∞–π—Ç\n    console.log('üìç –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å–∞–π—Ç...');\n    await page.goto('https://vozovoz.ru/', { waitUntil: 'networkidle2' });\n\n    // –®–∞–≥ 2: –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è\n    console.log('üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è...');\n    \n    // –ò—â–µ–º –∫–Ω–æ–ø–∫—É \"–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç\"\n    const loginButtonSelectors = [\n      'a[href*=\"login\"]',\n      'button:contains(\"–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç\")',\n      '.login-button',\n      '[data-testid=\"login-button\"]',\n      'a:contains(\"–í–æ–π—Ç–∏\")'\n    ];\n\n    let loginButtonFound = false;\n    for (const selector of loginButtonSelectors) {\n      try {\n        await page.waitForSelector(selector, { timeout: 5000 });\n        await page.click(selector);\n        loginButtonFound = true;\n        break;\n      } catch (e) {\n        continue;\n      }\n    }\n\n    if (!loginButtonFound) {\n      // –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –ø–æ —Ç–µ–∫—Å—Ç—É\n      await page.evaluate(() => {\n        const buttons = Array.from(document.querySelectorAll('a, button'));\n        const loginBtn = buttons.find(btn => \n          btn.textContent?.includes('–õ–∏—á–Ω—ã–π') || \n          btn.textContent?.includes('–í–æ–π—Ç–∏') ||\n          btn.textContent?.includes('–ö–∞–±–∏–Ω–µ—Ç')\n        );\n        if (loginBtn) (loginBtn as HTMLElement).click();\n      });\n    }\n\n    // –û–∂–∏–¥–∞–Ω–∏–µ —Ñ–æ—Ä–º—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏\n    await new Promise(resolve => setTimeout(resolve, 2000));\n\n    // –í–≤–æ–¥ –ª–æ–≥–∏–Ω–∞\n    const phoneSelectors = [\n      'input[name=\"phone\"]',\n      'input[type=\"tel\"]',\n      'input[placeholder*=\"—Ç–µ–ª–µ—Ñ–æ–Ω\"]',\n      'input[placeholder*=\"phone\"]',\n      '[data-testid=\"phone-input\"]'\n    ];\n\n    for (const selector of phoneSelectors) {\n      try {\n        await page.waitForSelector(selector, { timeout: 3000 });\n        await page.type(selector, '79015199496', { delay: 100 });\n        break;\n      } catch (e) {\n        continue;\n      }\n    }\n\n    // –ù–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏ \"–î–∞–ª–µ–µ\"\n    await page.evaluate(() => {\n      const buttons = Array.from(document.querySelectorAll('button'));\n      const nextBtn = buttons.find(btn => \n        btn.textContent?.includes('–î–∞–ª–µ–µ') ||\n        btn.textContent?.includes('Next')\n      );\n      if (nextBtn) (nextBtn as HTMLElement).click();\n    });\n\n    await page.waitForTimeout(2000);\n\n    // –í–≤–æ–¥ –ø–∞—Ä–æ–ª—è\n    const passwordSelectors = [\n      'input[name=\"password\"]',\n      'input[type=\"password\"]',\n      '[data-testid=\"password-input\"]'\n    ];\n\n    for (const selector of passwordSelectors) {\n      try {\n        await page.waitForSelector(selector, { timeout: 3000 });\n        await page.type(selector, 'LAv$it_2o21', { delay: 100 });\n        break;\n      } catch (e) {\n        continue;\n      }\n    }\n\n    // –ù–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏ \"–í–æ–π—Ç–∏\"\n    await page.evaluate(() => {\n      const buttons = Array.from(document.querySelectorAll('button'));\n      const loginBtn = buttons.find(btn => \n        btn.textContent?.includes('–í–æ–π—Ç–∏') ||\n        btn.textContent?.includes('–í—Ö–æ–¥')\n      );\n      if (loginBtn) (loginBtn as HTMLElement).click();\n    });\n\n    // –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏\n    await page.waitForTimeout(5000);\n\n    // –®–∞–≥ 3: –ü–µ—Ä–µ—Ö–æ–¥ –∫ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—é –∑–∞–∫–∞–∑–∞\n    console.log('üìã –ü–µ—Ä–µ—Ö–æ–¥ –∫ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—é –∑–∞–∫–∞–∑–∞...');\n    \n    const orderButtonSelectors = [\n      'a[href*=\"order\"]',\n      'button:contains(\"–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑\")',\n      '.order-button',\n      '[data-testid=\"create-order\"]'\n    ];\n\n    for (const selector of orderButtonSelectors) {\n      try {\n        await page.waitForSelector(selector, { timeout: 5000 });\n        await page.click(selector);\n        break;\n      } catch (e) {\n        continue;\n      }\n    }\n\n    // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏, –∏—â–µ–º –ø–æ —Ç–µ–∫—Å—Ç—É\n    await page.evaluate(() => {\n      const links = Array.from(document.querySelectorAll('a, button'));\n      const orderLink = links.find(link => \n        link.textContent?.includes('–û—Ñ–æ—Ä–º–∏—Ç—å') ||\n        link.textContent?.includes('–ó–∞–∫–∞–∑')\n      );\n      if (orderLink) (orderLink as HTMLElement).click();\n    });\n\n    await page.waitForTimeout(3000);\n\n    // –®–∞–≥ 4: –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã —Ä–∞—Å—á–µ—Ç–∞\n    console.log('üìù –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã —Ä–∞—Å—á–µ—Ç–∞...');\n\n    // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –≥–æ—Ä–æ–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è\n    const fromCitySelectors = [\n      'input[name=\"from\"]',\n      'input[placeholder*=\"–û—Ç–ø—Ä–∞–≤–∫–∞\"]',\n      'input[placeholder*=\"–æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è\"]',\n      '[data-testid=\"dispatch-city\"]'\n    ];\n\n    for (const selector of fromCitySelectors) {\n      try {\n        await page.waitForSelector(selector, { timeout: 5000 });\n        await page.click(selector);\n        await page.keyboard.down('Control');\n        await page.keyboard.press('a');\n        await page.keyboard.up('Control');\n        await page.type(selector, params.fromCity, { delay: 100 });\n        await page.waitForTimeout(1000);\n        await page.keyboard.press('Enter');\n        break;\n      } catch (e) {\n        continue;\n      }\n    }\n\n    // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –≥–æ—Ä–æ–¥–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è\n    const toCitySelectors = [\n      'input[name=\"to\"]',\n      'input[placeholder*=\"–ü—Ä–∏–±—ã—Ç–∏–µ\"]',\n      'input[placeholder*=\"–Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è\"]',\n      '[data-testid=\"destination-city\"]'\n    ];\n\n    for (const selector of toCitySelectors) {\n      try {\n        await page.waitForSelector(selector, { timeout: 5000 });\n        await page.click(selector);\n        await page.keyboard.down('Control');\n        await page.keyboard.press('a');\n        await page.keyboard.up('Control');\n        await page.type(selector, params.toCity, { delay: 100 });\n        await page.waitForTimeout(1000);\n        await page.keyboard.press('Enter');\n        break;\n      } catch (e) {\n        continue;\n      }\n    }\n\n    await page.waitForTimeout(2000);\n\n    // –í—ã–±–æ—Ä —Ç–∏–ø–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è\n    if (params.fromAddressDelivery) {\n      // –í—ã–±–æ—Ä \"–ê–¥—Ä–µ—Å\"\n      await page.evaluate(() => {\n        const labels = Array.from(document.querySelectorAll('label, span, div'));\n        const addressLabel = labels.find(label => \n          label.textContent?.includes('–ê–¥—Ä–µ—Å') && \n          label.textContent?.includes('–û—Ç–ø—Ä–∞–≤–∫–∞')\n        );\n        if (addressLabel) (addressLabel as HTMLElement).click();\n      });\n\n      // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è\n      if (params.fromAddress) {\n        await page.waitForTimeout(1000);\n        const fromAddressSelectors = [\n          'input[placeholder*=\"–∞–¥—Ä–µ—Å\"]',\n          'input[name=\"from_address\"]',\n          '[data-testid=\"dispatch-address-input\"]'\n        ];\n\n        for (const selector of fromAddressSelectors) {\n          try {\n            await page.waitForSelector(selector, { timeout: 3000 });\n            await page.type(selector, params.fromAddress!, { delay: 100 });\n            break;\n          } catch (e) {\n            continue;\n          }\n        }\n      }\n    } else {\n      // –í—ã–±–æ—Ä \"–¢–µ—Ä–º–∏–Ω–∞–ª\"\n      await page.evaluate(() => {\n        const labels = Array.from(document.querySelectorAll('label, span, div'));\n        const terminalLabel = labels.find(label => \n          label.textContent?.includes('–¢–µ—Ä–º–∏–Ω–∞–ª') && \n          label.textContent?.includes('–û—Ç–ø—Ä–∞–≤–∫–∞')\n        );\n        if (terminalLabel) (terminalLabel as HTMLElement).click();\n      });\n    }\n\n    await page.waitForTimeout(1000);\n\n    // –í—ã–±–æ—Ä —Ç–∏–ø–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è\n    if (params.toAddressDelivery) {\n      // –í—ã–±–æ—Ä \"–ê–¥—Ä–µ—Å\"\n      await page.evaluate(() => {\n        const labels = Array.from(document.querySelectorAll('label, span, div'));\n        const addressLabel = labels.find(label => \n          label.textContent?.includes('–ê–¥—Ä–µ—Å') && \n          label.textContent?.includes('–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ')\n        );\n        if (addressLabel) (addressLabel as HTMLElement).click();\n      });\n\n      // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è\n      if (params.toAddress) {\n        await page.waitForTimeout(1000);\n        const toAddressSelectors = [\n          'input[placeholder*=\"–∞–¥—Ä–µ—Å\"]',\n          'input[name=\"to_address\"]',\n          '[data-testid=\"destination-address-input\"]'\n        ];\n\n        for (const selector of toAddressSelectors) {\n          try {\n            await page.waitForSelector(selector, { timeout: 3000 });\n            await page.type(selector, params.toAddress!, { delay: 100 });\n            break;\n          } catch (e) {\n            continue;\n          }\n        }\n      }\n    } else {\n      // –í—ã–±–æ—Ä \"–¢–µ—Ä–º–∏–Ω–∞–ª\"\n      await page.evaluate(() => {\n        const labels = Array.from(document.querySelectorAll('label, span, div'));\n        const terminalLabel = labels.find(label => \n          label.textContent?.includes('–¢–µ—Ä–º–∏–Ω–∞–ª') && \n          label.textContent?.includes('–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ')\n        );\n        if (terminalLabel) (terminalLabel as HTMLElement).click();\n      });\n    }\n\n    await page.waitForTimeout(2000);\n\n    // –®–∞–≥ 5: –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –≥—Ä—É–∑–∞\n    console.log('üì¶ –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –≥—Ä—É–∑–∞...');\n\n    // –í—ã–±–æ—Ä \"–ú–µ—Å—Ç–∞\"\n    await page.evaluate(() => {\n      const labels = Array.from(document.querySelectorAll('label, span, div'));\n      const placesLabel = labels.find(label => \n        label.textContent?.includes('–ú–µ—Å—Ç–∞')\n      );\n      if (placesLabel) (placesLabel as HTMLElement).click();\n    });\n\n    await page.waitForTimeout(1000);\n\n    // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –≥–∞–±–∞—Ä–∏—Ç–æ–≤\n    const dimensionSelectors = {\n      length: ['input[name=\"length\"]', 'input[placeholder*=\"–¥–ª–∏–Ω\"]', '[data-testid=\"cargo-length\"]'],\n      width: ['input[name=\"width\"]', 'input[placeholder*=\"—à–∏—Ä–∏–Ω\"]', '[data-testid=\"cargo-width\"]'],\n      height: ['input[name=\"height\"]', 'input[placeholder*=\"–≤—ã—Å–æ—Ç\"]', '[data-testid=\"cargo-height\"]'],\n      weight: ['input[name=\"weight\"]', 'input[placeholder*=\"–≤–µ—Å\"]', '[data-testid=\"cargo-weight\"]']\n    };\n\n    const dimensions = {\n      length: params.length,\n      width: params.width,\n      height: params.height,\n      weight: params.weight\n    };\n\n    for (const [dim, selectors] of Object.entries(dimensionSelectors)) {\n      for (const selector of selectors) {\n        try {\n          await page.waitForSelector(selector, { timeout: 3000 });\n          await page.click(selector);\n          await page.keyboard.down('Control');\n          await page.keyboard.press('a');\n          await page.keyboard.up('Control');\n          await page.type(selector, dimensions[dim as keyof typeof dimensions].toString(), { delay: 50 });\n          break;\n        } catch (e) {\n          continue;\n        }\n      }\n    }\n\n    await page.waitForTimeout(2000);\n\n    // –®–∞–≥ 6: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏\n    console.log('üõ°Ô∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —É—Å–ª—É–≥...');\n\n    // –°—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ\n    if (params.needInsurance && params.declaredValue && params.declaredValue > 0) {\n      await page.evaluate(() => {\n        const checkboxes = Array.from(document.querySelectorAll('input[type=\"checkbox\"]'));\n        const insuranceCheckbox = checkboxes.find(cb => \n          cb.parentElement?.textContent?.includes('—Å—Ç—Ä–∞—Ö') ||\n          cb.parentElement?.textContent?.includes('–°—Ç—Ä–∞—Ö')\n        );\n        if (insuranceCheckbox) (insuranceCheckbox as HTMLElement).click();\n      });\n\n      await page.waitForTimeout(1000);\n\n      // –í–≤–æ–¥ –æ–±—ä—è–≤–ª–µ–Ω–Ω–æ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏\n      const insuranceValueSelectors = [\n        'input[name=\"insurance_value\"]',\n        'input[placeholder*=\"—Å—Ç–æ–∏–º–æ—Å—Ç—å\"]',\n        'input[placeholder*=\"—Å—É–º–º–∞\"]'\n      ];\n\n      for (const selector of insuranceValueSelectors) {\n        try {\n          await page.waitForSelector(selector, { timeout: 3000 });\n          await page.type(selector, params.declaredValue!.toString(), { delay: 100 });\n          break;\n        } catch (e) {\n          continue;\n        }\n      }\n    }\n\n    // –£–ø–∞–∫–æ–≤–∫–∞\n    if (params.needPackaging) {\n      await page.evaluate(() => {\n        const checkboxes = Array.from(document.querySelectorAll('input[type=\"checkbox\"]'));\n        const packagingCheckbox = checkboxes.find(cb => \n          cb.parentElement?.textContent?.includes('—É–ø–∞–∫–æ–≤–∫') ||\n          cb.parentElement?.textContent?.includes('–£–ø–∞–∫–æ–≤')\n        );\n        if (packagingCheckbox) (packagingCheckbox as HTMLElement).click();\n      });\n\n      await page.waitForTimeout(1000);\n\n      // –í—ã–±–æ—Ä —Ç–∏–ø–∞ —É–ø–∞–∫–æ–≤–∫–∏ \"–∑–∞—â–∏—Ç–Ω–∞—è —É–ø–∞–∫–æ–≤–∫–∞ + —Ñ–æ—Ç–æ\"\n      await page.evaluate(() => {\n        const options = Array.from(document.querySelectorAll('option, label, div'));\n        const protectiveOption = options.find(opt => \n          opt.textContent?.includes('–∑–∞—â–∏—Ç–Ω–∞—è') &&\n          opt.textContent?.includes('—Ñ–æ—Ç–æ')\n        );\n        if (protectiveOption) (protectiveOption as HTMLElement).click();\n      });\n    }\n\n    // –ü–æ–≥—Ä—É–∑–∫–∞/—Ä–∞–∑–≥—Ä—É–∑–∫–∞\n    if (params.needLoading) {\n      await page.evaluate(() => {\n        const checkboxes = Array.from(document.querySelectorAll('input[type=\"checkbox\"]'));\n        const loadingCheckbox = checkboxes.find(cb => \n          cb.parentElement?.textContent?.includes('–ø–æ–≥—Ä—É–∑–∫') ||\n          cb.parentElement?.textContent?.includes('—Ä–∞–∑–≥—Ä—É–∑–∫')\n        );\n        if (loadingCheckbox) (loadingCheckbox as HTMLElement).click();\n      });\n\n      await page.waitForTimeout(1000);\n\n      // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–∏—Ñ—Ç–∞ –∏ —ç—Ç–∞–∂–∞\n      await page.evaluate((hasFreightElevator, floor) => {\n        // –í—ã–±–æ—Ä —Ç–∏–ø–∞ –ª–∏—Ñ—Ç–∞\n        const elevatorOptions = Array.from(document.querySelectorAll('option, label, div'));\n        const elevatorOption = elevatorOptions.find(opt => \n          opt.textContent?.includes(hasFreightElevator ? '–≥—Ä—É–∑–æ–≤–æ–π' : '–ø–∞—Å—Å–∞–∂–∏—Ä')\n        );\n        if (elevatorOption) (elevatorOption as HTMLElement).click();\n\n        // –í–≤–æ–¥ —ç—Ç–∞–∂–∞\n        const floorInputs = Array.from(document.querySelectorAll('input[type=\"number\"]'));\n        const floorInput = floorInputs.find(input => \n          (input as HTMLInputElement).placeholder?.includes('—ç—Ç–∞–∂') ||\n          (input as HTMLInputElement).name?.includes('floor')\n        );\n        if (floorInput) {\n          (floorInput as HTMLInputElement).value = floor.toString();\n        }\n      }, params.hasFreightElevator, params.floor);\n    }\n\n    // –®–∞–≥ 7: –û–∂–∏–¥–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤\n    console.log('‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ä–∞—Å—á–µ—Ç–∞...');\n    await page.waitForTimeout(5000);\n\n    // –®–∞–≥ 8: –ü–∞—Ä—Å–∏–Ω–≥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤\n    console.log('üìä –ü–∞—Ä—Å–∏–Ω–≥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤...');\n    \n    const results = await page.evaluate(() => {\n      const result: any = {\n        totalCost: 0,\n        services: [],\n        deliveryTime: null,\n        warnings: []\n      };\n\n      // –ü–æ–∏—Å–∫ –æ–±—â–µ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏\n      const totalCostSelectors = [\n        '.total-cost',\n        '.price-total',\n        '[data-testid=\"total-cost\"]',\n        'div:contains(\"–°—Ç–æ–∏–º–æ—Å—Ç—å\")',\n        'span:contains(\"–ò—Ç–æ–≥–æ\")'\n      ];\n\n      for (const selector of totalCostSelectors) {\n        try {\n          const element = document.querySelector(selector);\n          if (element) {\n            const text = element.textContent || '';\n            const match = text.match(/[\\d\\s]+‚ÇΩ/);\n            if (match) {\n              result.totalCost = parseInt(match[0].replace(/[^\\d]/g, ''));\n              break;\n            }\n          }\n        } catch (e) {\n          continue;\n        }\n      }\n\n      // –ü–æ–∏—Å–∫ —É—Å–ª—É–≥\n      const serviceItems = document.querySelectorAll('.service-item, .calculation-item, div[class*=\"service\"]');\n      serviceItems.forEach(item => {\n        try {\n          const nameElement = item.querySelector('.service-name, .item-name, [class*=\"name\"]');\n          const priceElement = item.querySelector('.service-price, .item-price, [class*=\"price\"]');\n          \n          if (nameElement && priceElement) {\n            const name = nameElement.textContent?.trim() || '';\n            const priceText = priceElement.textContent || '';\n            const price = parseInt(priceText.replace(/[^\\d]/g, '')) || 0;\n            \n            if (name && price > 0) {\n              result.services.push({ name, price });\n            }\n          }\n        } catch (e) {\n          // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤\n        }\n      });\n\n      // –ï—Å–ª–∏ —É—Å–ª—É–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, –∏—â–µ–º –ø–æ —Ç–µ–∫—Å—Ç–æ–≤—ã–º –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º\n      if (result.services.length === 0) {\n        const allText = document.body.textContent || '';\n        \n        // –ò—â–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω—ã —Ç–∏–ø–∞ \"–ù–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏\\n123 ‚ÇΩ\"\n        const serviceMatches = allText.match(/([^\\n]+?)\\s*[\\d\\s]+‚ÇΩ/g);\n        if (serviceMatches) {\n          serviceMatches.forEach(match => {\n            const parts = match.split(/[\\d\\s]+‚ÇΩ/);\n            if (parts.length > 0) {\n              const name = parts[0].trim();\n              const priceMatch = match.match(/([\\d\\s]+)‚ÇΩ/);\n              if (name && priceMatch) {\n                const price = parseInt(priceMatch[1].replace(/\\s/g, '')) || 0;\n                if (price > 0) {\n                  result.services.push({ name, price });\n                }\n              }\n            }\n          });\n        }\n      }\n\n      // –ü–æ–∏—Å–∫ —Å—Ä–æ–∫–æ–≤ –¥–æ—Å—Ç–∞–≤–∫–∏\n      const deliverySelectors = [\n        '.delivery-time',\n        '[data-testid=\"delivery-time\"]',\n        'div:contains(\"–¥–æ—Å—Ç–∞–≤–∫\")',\n        'span:contains(\"–¥–Ω–µ–π\")'\n      ];\n\n      for (const selector of deliverySelectors) {\n        try {\n          const element = document.querySelector(selector);\n          if (element) {\n            result.deliveryTime = element.textContent?.trim() || null;\n            break;\n          }\n        } catch (e) {\n          continue;\n        }\n      }\n\n      return result;\n    });\n\n    const parseTime = ((Date.now() - startTime) / 1000).toFixed(1);\n\n    return {\n      totalCost: results.totalCost,\n      services: results.services,\n      deliveryTime: results.deliveryTime,\n      warnings: results.warnings,\n      parseTime: parseFloat(parseTime)\n    };\n\n  } catch (error: any) {\n    console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ Vozovoz:', error);\n    throw new Error(`–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–µ—Ä–∞: ${error.message}`);\n  } finally {\n    if (browser) {\n      await browser.close();\n    }\n  }\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json();\n    \n    // –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö\n    const requiredFields = ['fromCity', 'toCity', 'length', 'width', 'height', 'weight'];\n    for (const field of requiredFields) {\n      if (!body[field]) {\n        return NextResponse.json({\n          error: `–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ: ${field}`\n        }, { status: 400 });\n      }\n    }\n\n    console.log('üï∑Ô∏è –ó–∞–ø—É—Å–∫ –ø–∞—Ä—Å–µ—Ä–∞ Vozovoz —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏:', body);\n\n    // –ó–∞–ø—É—Å–∫ –ø–∞—Ä—Å–µ—Ä–∞\n    const result = await parseVozovozWebsite(body as VozovozParserParams);\n\n    console.log('‚úÖ –ü–∞—Ä—Å–µ—Ä Vozovoz —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–∏–ª —Ä–∞–±–æ—Ç—É');\n    console.log('üí∞ –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:', result.totalCost);\n    console.log('üì¶ –ù–∞–π–¥–µ–Ω–æ —É—Å–ª—É–≥:', result.services.length);\n\n    return NextResponse.json(result);\n\n  } catch (error: any) {\n    console.error('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø–∞—Ä—Å–µ—Ä–∞ Vozovoz:', error);\n    \n    return NextResponse.json({\n      error: error.message || '–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ –ø–∞—Ä—Å–µ—Ä–∞',\n      details: error.stack\n    }, { status: 500 });\n  }\n}",
        "after": "import { NextRequest, NextResponse } from 'next/server';\nimport puppeteer from 'puppeteer';\n\ninterface VozovozParserParams {\n  fromCity: string;\n  toCity: string;\n  fromAddressDelivery: boolean;\n  toAddressDelivery: boolean;\n  fromAddress?: string;\n  toAddress?: string;\n  length: number;\n  width: number;\n  height: number;\n  weight: number;\n  needInsurance: boolean;\n  declaredValue?: number;\n  needPackaging: boolean;\n  needLoading: boolean;\n  hasFreightElevator: boolean;\n  floor: number;\n}\n\ninterface ServiceItem {\n  name: string;\n  basePrice?: number;\n  price: number;\n  discount?: number;\n}\n\ninterface ParsedResult {\n  totalCost: number;\n  services: ServiceItem[];\n  deliveryTime?: string;\n  warnings?: string[];\n  parseTime?: number;\n}\n\n// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ —Ü–µ–Ω—ã –∏–∑ —Å—Ç—Ä–æ–∫–∏\nfunction parsePrice(priceText: string): number {\n  if (!priceText) return 0;\n  const cleaned = priceText.replace(/[^\\d]/g, '');\n  return parseInt(cleaned) || 0;\n}\n\n// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–∂–∏–¥–∞–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–∞ —Å —Ç–∞–π–º–∞—É—Ç–æ–º\nasync function waitForSelectorWithTimeout(page: any, selector: string, timeout: number = 30000) {\n  try {\n    await page.waitForSelector(selector, { timeout });\n    return true;\n  } catch (error) {\n    console.error(`–≠–ª–µ–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω: ${selector}`, error);\n    return false;\n  }\n}\n\n// –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–∞—Ä—Å–∏–Ω–≥–∞\nasync function parseVozovozWebsite(params: VozovozParserParams): Promise<ParsedResult> {\n  const startTime = Date.now();\n  let browser;\n  \n  try {\n    // –ó–∞–ø—É—Å–∫ –±—Ä–∞—É–∑–µ—Ä–∞ —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –¥–ª—è –æ–±—Ö–æ–¥–∞ –¥–µ—Ç–µ–∫—Ü–∏–∏\n    browser = await puppeteer.launch({\n      headless: true,\n      args: [\n        '--no-sandbox',\n        '--disable-setuid-sandbox',\n        '--disable-dev-shm-usage',\n        '--disable-accelerated-2d-canvas',\n        '--no-first-run',\n        '--no-zygote',\n        '--single-process',\n        '--disable-gpu'\n      ]\n    });\n\n    const page = await browser.newPage();\n    \n    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ user-agent –∏ viewport\n    await page.setUserAgent('Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36');\n    await page.setViewport({ width: 1920, height: 1080 });\n\n    console.log('üï∑Ô∏è –ó–∞–ø—É—Å–∫ –ø–∞—Ä—Å–µ—Ä–∞ Vozovoz...');\n\n    // –®–∞–≥ 1: –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å–∞–π—Ç\n    console.log('üìç –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å–∞–π—Ç...');\n    await page.goto('https://vozovoz.ru/', { waitUntil: 'networkidle2' });\n\n    // –®–∞–≥ 2: –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è\n    console.log('üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è...');\n    \n    // –ò—â–µ–º –∫–Ω–æ–ø–∫—É \"–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç\"\n    const loginButtonSelectors = [\n      'a[href*=\"login\"]',\n      'button:contains(\"–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç\")',\n      '.login-button',\n      '[data-testid=\"login-button\"]',\n      'a:contains(\"–í–æ–π—Ç–∏\")'\n    ];\n\n    let loginButtonFound = false;\n    for (const selector of loginButtonSelectors) {\n      try {\n        await page.waitForSelector(selector, { timeout: 5000 });\n        await page.click(selector);\n        loginButtonFound = true;\n        break;\n      } catch (e) {\n        continue;\n      }\n    }\n\n    if (!loginButtonFound) {\n      // –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –ø–æ —Ç–µ–∫—Å—Ç—É\n      await page.evaluate(() => {\n        const buttons = Array.from(document.querySelectorAll('a, button'));\n        const loginBtn = buttons.find(btn => \n          btn.textContent?.includes('–õ–∏—á–Ω—ã–π') || \n          btn.textContent?.includes('–í–æ–π—Ç–∏') ||\n          btn.textContent?.includes('–ö–∞–±–∏–Ω–µ—Ç')\n        );\n        if (loginBtn) (loginBtn as HTMLElement).click();\n      });\n    }\n\n    // –û–∂–∏–¥–∞–Ω–∏–µ —Ñ–æ—Ä–º—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏\n    await new Promise(resolve => setTimeout(resolve, 2000));\n\n    // –í–≤–æ–¥ –ª–æ–≥–∏–Ω–∞\n    const phoneSelectors = [\n      'input[name=\"phone\"]',\n      'input[type=\"tel\"]',\n      'input[placeholder*=\"—Ç–µ–ª–µ—Ñ–æ–Ω\"]',\n      'input[placeholder*=\"phone\"]',\n      '[data-testid=\"phone-input\"]'\n    ];\n\n    for (const selector of phoneSelectors) {\n      try {\n        await page.waitForSelector(selector, { timeout: 3000 });\n        await page.type(selector, '79015199496', { delay: 100 });\n        break;\n      } catch (e) {\n        continue;\n      }\n    }\n\n    // –ù–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏ \"–î–∞–ª–µ–µ\"\n    await page.evaluate(() => {\n      const buttons = Array.from(document.querySelectorAll('button'));\n      const nextBtn = buttons.find(btn => \n        btn.textContent?.includes('–î–∞–ª–µ–µ') ||\n        btn.textContent?.includes('Next')\n      );\n      if (nextBtn) (nextBtn as HTMLElement).click();\n    });\n\n    await new Promise(resolve => setTimeout(resolve, 2000));\n\n    // –í–≤–æ–¥ –ø–∞—Ä–æ–ª—è\n    const passwordSelectors = [\n      'input[name=\"password\"]',\n      'input[type=\"password\"]',\n      '[data-testid=\"password-input\"]'\n    ];\n\n    for (const selector of passwordSelectors) {\n      try {\n        await page.waitForSelector(selector, { timeout: 3000 });\n        await page.type(selector, 'LAv$it_2o21', { delay: 100 });\n        break;\n      } catch (e) {\n        continue;\n      }\n    }\n\n    // –ù–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏ \"–í–æ–π—Ç–∏\"\n    await page.evaluate(() => {\n      const buttons = Array.from(document.querySelectorAll('button'));\n      const loginBtn = buttons.find(btn => \n        btn.textContent?.includes('–í–æ–π—Ç–∏') ||\n        btn.textContent?.includes('–í—Ö–æ–¥')\n      );\n      if (loginBtn) (loginBtn as HTMLElement).click();\n    });\n\n    // –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏\n    await page.waitForTimeout(5000);\n\n    // –®–∞–≥ 3: –ü–µ—Ä–µ—Ö–æ–¥ –∫ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—é –∑–∞–∫–∞–∑–∞\n    console.log('üìã –ü–µ—Ä–µ—Ö–æ–¥ –∫ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—é –∑–∞–∫–∞–∑–∞...');\n    \n    const orderButtonSelectors = [\n      'a[href*=\"order\"]',\n      'button:contains(\"–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑\")',\n      '.order-button',\n      '[data-testid=\"create-order\"]'\n    ];\n\n    for (const selector of orderButtonSelectors) {\n      try {\n        await page.waitForSelector(selector, { timeout: 5000 });\n        await page.click(selector);\n        break;\n      } catch (e) {\n        continue;\n      }\n    }\n\n    // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏, –∏—â–µ–º –ø–æ —Ç–µ–∫—Å—Ç—É\n    await page.evaluate(() => {\n      const links = Array.from(document.querySelectorAll('a, button'));\n      const orderLink = links.find(link => \n        link.textContent?.includes('–û—Ñ–æ—Ä–º–∏—Ç—å') ||\n        link.textContent?.includes('–ó–∞–∫–∞–∑')\n      );\n      if (orderLink) (orderLink as HTMLElement).click();\n    });\n\n    await page.waitForTimeout(3000);\n\n    // –®–∞–≥ 4: –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã —Ä–∞—Å—á–µ—Ç–∞\n    console.log('üìù –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã —Ä–∞—Å—á–µ—Ç–∞...');\n\n    // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –≥–æ—Ä–æ–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è\n    const fromCitySelectors = [\n      'input[name=\"from\"]',\n      'input[placeholder*=\"–û—Ç–ø—Ä–∞–≤–∫–∞\"]',\n      'input[placeholder*=\"–æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è\"]',\n      '[data-testid=\"dispatch-city\"]'\n    ];\n\n    for (const selector of fromCitySelectors) {\n      try {\n        await page.waitForSelector(selector, { timeout: 5000 });\n        await page.click(selector);\n        await page.keyboard.down('Control');\n        await page.keyboard.press('a');\n        await page.keyboard.up('Control');\n        await page.type(selector, params.fromCity, { delay: 100 });\n        await page.waitForTimeout(1000);\n        await page.keyboard.press('Enter');\n        break;\n      } catch (e) {\n        continue;\n      }\n    }\n\n    // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –≥–æ—Ä–æ–¥–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è\n    const toCitySelectors = [\n      'input[name=\"to\"]',\n      'input[placeholder*=\"–ü—Ä–∏–±—ã—Ç–∏–µ\"]',\n      'input[placeholder*=\"–Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è\"]',\n      '[data-testid=\"destination-city\"]'\n    ];\n\n    for (const selector of toCitySelectors) {\n      try {\n        await page.waitForSelector(selector, { timeout: 5000 });\n        await page.click(selector);\n        await page.keyboard.down('Control');\n        await page.keyboard.press('a');\n        await page.keyboard.up('Control');\n        await page.type(selector, params.toCity, { delay: 100 });\n        await page.waitForTimeout(1000);\n        await page.keyboard.press('Enter');\n        break;\n      } catch (e) {\n        continue;\n      }\n    }\n\n    await new Promise(resolve => setTimeout(resolve, 2000));\n\n    // –í—ã–±–æ—Ä —Ç–∏–ø–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è\n    if (params.fromAddressDelivery) {\n      // –í—ã–±–æ—Ä \"–ê–¥—Ä–µ—Å\"\n      await page.evaluate(() => {\n        const labels = Array.from(document.querySelectorAll('label, span, div'));\n        const addressLabel = labels.find(label => \n          label.textContent?.includes('–ê–¥—Ä–µ—Å') && \n          label.textContent?.includes('–û—Ç–ø—Ä–∞–≤–∫–∞')\n        );\n        if (addressLabel) (addressLabel as HTMLElement).click();\n      });\n\n      // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è\n      if (params.fromAddress) {\n        await page.waitForTimeout(1000);\n        const fromAddressSelectors = [\n          'input[placeholder*=\"–∞–¥—Ä–µ—Å\"]',\n          'input[name=\"from_address\"]',\n          '[data-testid=\"dispatch-address-input\"]'\n        ];\n\n        for (const selector of fromAddressSelectors) {\n          try {\n            await page.waitForSelector(selector, { timeout: 3000 });\n            await page.type(selector, params.fromAddress!, { delay: 100 });\n            break;\n          } catch (e) {\n            continue;\n          }\n        }\n      }\n    } else {\n      // –í—ã–±–æ—Ä \"–¢–µ—Ä–º–∏–Ω–∞–ª\"\n      await page.evaluate(() => {\n        const labels = Array.from(document.querySelectorAll('label, span, div'));\n        const terminalLabel = labels.find(label => \n          label.textContent?.includes('–¢–µ—Ä–º–∏–Ω–∞–ª') && \n          label.textContent?.includes('–û—Ç–ø—Ä–∞–≤–∫–∞')\n        );\n        if (terminalLabel) (terminalLabel as HTMLElement).click();\n      });\n    }\n\n    await page.waitForTimeout(1000);\n\n    // –í—ã–±–æ—Ä —Ç–∏–ø–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è\n    if (params.toAddressDelivery) {\n      // –í—ã–±–æ—Ä \"–ê–¥—Ä–µ—Å\"\n      await page.evaluate(() => {\n        const labels = Array.from(document.querySelectorAll('label, span, div'));\n        const addressLabel = labels.find(label => \n          label.textContent?.includes('–ê–¥—Ä–µ—Å') && \n          label.textContent?.includes('–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ')\n        );\n        if (addressLabel) (addressLabel as HTMLElement).click();\n      });\n\n      // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è\n      if (params.toAddress) {\n        await page.waitForTimeout(1000);\n        const toAddressSelectors = [\n          'input[placeholder*=\"–∞–¥—Ä–µ—Å\"]',\n          'input[name=\"to_address\"]',\n          '[data-testid=\"destination-address-input\"]'\n        ];\n\n        for (const selector of toAddressSelectors) {\n          try {\n            await page.waitForSelector(selector, { timeout: 3000 });\n            await page.type(selector, params.toAddress!, { delay: 100 });\n            break;\n          } catch (e) {\n            continue;\n          }\n        }\n      }\n    } else {\n      // –í—ã–±–æ—Ä \"–¢–µ—Ä–º–∏–Ω–∞–ª\"\n      await page.evaluate(() => {\n        const labels = Array.from(document.querySelectorAll('label, span, div'));\n        const terminalLabel = labels.find(label => \n          label.textContent?.includes('–¢–µ—Ä–º–∏–Ω–∞–ª') && \n          label.textContent?.includes('–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ')\n        );\n        if (terminalLabel) (terminalLabel as HTMLElement).click();\n      });\n    }\n\n    await new Promise(resolve => setTimeout(resolve, 2000));\n\n    // –®–∞–≥ 5: –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –≥—Ä—É–∑–∞\n    console.log('üì¶ –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –≥—Ä—É–∑–∞...');\n\n    // –í—ã–±–æ—Ä \"–ú–µ—Å—Ç–∞\"\n    await page.evaluate(() => {\n      const labels = Array.from(document.querySelectorAll('label, span, div'));\n      const placesLabel = labels.find(label => \n        label.textContent?.includes('–ú–µ—Å—Ç–∞')\n      );\n      if (placesLabel) (placesLabel as HTMLElement).click();\n    });\n\n    await page.waitForTimeout(1000);\n\n    // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –≥–∞–±–∞—Ä–∏—Ç–æ–≤\n    const dimensionSelectors = {\n      length: ['input[name=\"length\"]', 'input[placeholder*=\"–¥–ª–∏–Ω\"]', '[data-testid=\"cargo-length\"]'],\n      width: ['input[name=\"width\"]', 'input[placeholder*=\"—à–∏—Ä–∏–Ω\"]', '[data-testid=\"cargo-width\"]'],\n      height: ['input[name=\"height\"]', 'input[placeholder*=\"–≤—ã—Å–æ—Ç\"]', '[data-testid=\"cargo-height\"]'],\n      weight: ['input[name=\"weight\"]', 'input[placeholder*=\"–≤–µ—Å\"]', '[data-testid=\"cargo-weight\"]']\n    };\n\n    const dimensions = {\n      length: params.length,\n      width: params.width,\n      height: params.height,\n      weight: params.weight\n    };\n\n    for (const [dim, selectors] of Object.entries(dimensionSelectors)) {\n      for (const selector of selectors) {\n        try {\n          await page.waitForSelector(selector, { timeout: 3000 });\n          await page.click(selector);\n          await page.keyboard.down('Control');\n          await page.keyboard.press('a');\n          await page.keyboard.up('Control');\n          await page.type(selector, dimensions[dim as keyof typeof dimensions].toString(), { delay: 50 });\n          break;\n        } catch (e) {\n          continue;\n        }\n      }\n    }\n\n    await new Promise(resolve => setTimeout(resolve, 2000));\n\n    // –®–∞–≥ 6: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏\n    console.log('üõ°Ô∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —É—Å–ª—É–≥...');\n\n    // –°—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ\n    if (params.needInsurance && params.declaredValue && params.declaredValue > 0) {\n      await page.evaluate(() => {\n        const checkboxes = Array.from(document.querySelectorAll('input[type=\"checkbox\"]'));\n        const insuranceCheckbox = checkboxes.find(cb => \n          cb.parentElement?.textContent?.includes('—Å—Ç—Ä–∞—Ö') ||\n          cb.parentElement?.textContent?.includes('–°—Ç—Ä–∞—Ö')\n        );\n        if (insuranceCheckbox) (insuranceCheckbox as HTMLElement).click();\n      });\n\n      await page.waitForTimeout(1000);\n\n      // –í–≤–æ–¥ –æ–±—ä—è–≤–ª–µ–Ω–Ω–æ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏\n      const insuranceValueSelectors = [\n        'input[name=\"insurance_value\"]',\n        'input[placeholder*=\"—Å—Ç–æ–∏–º–æ—Å—Ç—å\"]',\n        'input[placeholder*=\"—Å—É–º–º–∞\"]'\n      ];\n\n      for (const selector of insuranceValueSelectors) {\n        try {\n          await page.waitForSelector(selector, { timeout: 3000 });\n          await page.type(selector, params.declaredValue!.toString(), { delay: 100 });\n          break;\n        } catch (e) {\n          continue;\n        }\n      }\n    }\n\n    // –£–ø–∞–∫–æ–≤–∫–∞\n    if (params.needPackaging) {\n      await page.evaluate(() => {\n        const checkboxes = Array.from(document.querySelectorAll('input[type=\"checkbox\"]'));\n        const packagingCheckbox = checkboxes.find(cb => \n          cb.parentElement?.textContent?.includes('—É–ø–∞–∫–æ–≤–∫') ||\n          cb.parentElement?.textContent?.includes('–£–ø–∞–∫–æ–≤')\n        );\n        if (packagingCheckbox) (packagingCheckbox as HTMLElement).click();\n      });\n\n      await page.waitForTimeout(1000);\n\n      // –í—ã–±–æ—Ä —Ç–∏–ø–∞ —É–ø–∞–∫–æ–≤–∫–∏ \"–∑–∞—â–∏—Ç–Ω–∞—è —É–ø–∞–∫–æ–≤–∫–∞ + —Ñ–æ—Ç–æ\"\n      await page.evaluate(() => {\n        const options = Array.from(document.querySelectorAll('option, label, div'));\n        const protectiveOption = options.find(opt => \n          opt.textContent?.includes('–∑–∞—â–∏—Ç–Ω–∞—è') &&\n          opt.textContent?.includes('—Ñ–æ—Ç–æ')\n        );\n        if (protectiveOption) (protectiveOption as HTMLElement).click();\n      });\n    }\n\n    // –ü–æ–≥—Ä—É–∑–∫–∞/—Ä–∞–∑–≥—Ä—É–∑–∫–∞\n    if (params.needLoading) {\n      await page.evaluate(() => {\n        const checkboxes = Array.from(document.querySelectorAll('input[type=\"checkbox\"]'));\n        const loadingCheckbox = checkboxes.find(cb => \n          cb.parentElement?.textContent?.includes('–ø–æ–≥—Ä—É–∑–∫') ||\n          cb.parentElement?.textContent?.includes('—Ä–∞–∑–≥—Ä—É–∑–∫')\n        );\n        if (loadingCheckbox) (loadingCheckbox as HTMLElement).click();\n      });\n\n      await page.waitForTimeout(1000);\n\n      // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–∏—Ñ—Ç–∞ –∏ —ç—Ç–∞–∂–∞\n      await page.evaluate((hasFreightElevator, floor) => {\n        // –í—ã–±–æ—Ä —Ç–∏–ø–∞ –ª–∏—Ñ—Ç–∞\n        const elevatorOptions = Array.from(document.querySelectorAll('option, label, div'));\n        const elevatorOption = elevatorOptions.find(opt => \n          opt.textContent?.includes(hasFreightElevator ? '–≥—Ä—É–∑–æ–≤–æ–π' : '–ø–∞—Å—Å–∞–∂–∏—Ä')\n        );\n        if (elevatorOption) (elevatorOption as HTMLElement).click();\n\n        // –í–≤–æ–¥ —ç—Ç–∞–∂–∞\n        const floorInputs = Array.from(document.querySelectorAll('input[type=\"number\"]'));\n        const floorInput = floorInputs.find(input => \n          (input as HTMLInputElement).placeholder?.includes('—ç—Ç–∞–∂') ||\n          (input as HTMLInputElement).name?.includes('floor')\n        );\n        if (floorInput) {\n          (floorInput as HTMLInputElement).value = floor.toString();\n        }\n      }, params.hasFreightElevator, params.floor);\n    }\n\n    // –®–∞–≥ 7: –û–∂–∏–¥–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤\n    console.log('‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ä–∞—Å—á–µ—Ç–∞...');\n    await page.waitForTimeout(5000);\n\n    // –®–∞–≥ 8: –ü–∞—Ä—Å–∏–Ω–≥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤\n    console.log('üìä –ü–∞—Ä—Å–∏–Ω–≥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤...');\n    \n    const results = await page.evaluate(() => {\n      const result: any = {\n        totalCost: 0,\n        services: [],\n        deliveryTime: null,\n        warnings: []\n      };\n\n      // –ü–æ–∏—Å–∫ –æ–±—â–µ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏\n      const totalCostSelectors = [\n        '.total-cost',\n        '.price-total',\n        '[data-testid=\"total-cost\"]',\n        'div:contains(\"–°—Ç–æ–∏–º–æ—Å—Ç—å\")',\n        'span:contains(\"–ò—Ç–æ–≥–æ\")'\n      ];\n\n      for (const selector of totalCostSelectors) {\n        try {\n          const element = document.querySelector(selector);\n          if (element) {\n            const text = element.textContent || '';\n            const match = text.match(/[\\d\\s]+‚ÇΩ/);\n            if (match) {\n              result.totalCost = parseInt(match[0].replace(/[^\\d]/g, ''));\n              break;\n            }\n          }\n        } catch (e) {\n          continue;\n        }\n      }\n\n      // –ü–æ–∏—Å–∫ —É—Å–ª—É–≥\n      const serviceItems = document.querySelectorAll('.service-item, .calculation-item, div[class*=\"service\"]');\n      serviceItems.forEach(item => {\n        try {\n          const nameElement = item.querySelector('.service-name, .item-name, [class*=\"name\"]');\n          const priceElement = item.querySelector('.service-price, .item-price, [class*=\"price\"]');\n          \n          if (nameElement && priceElement) {\n            const name = nameElement.textContent?.trim() || '';\n            const priceText = priceElement.textContent || '';\n            const price = parseInt(priceText.replace(/[^\\d]/g, '')) || 0;\n            \n            if (name && price > 0) {\n              result.services.push({ name, price });\n            }\n          }\n        } catch (e) {\n          // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤\n        }\n      });\n\n      // –ï—Å–ª–∏ —É—Å–ª—É–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, –∏—â–µ–º –ø–æ —Ç–µ–∫—Å—Ç–æ–≤—ã–º –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º\n      if (result.services.length === 0) {\n        const allText = document.body.textContent || '';\n        \n        // –ò—â–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω—ã —Ç–∏–ø–∞ \"–ù–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏\\n123 ‚ÇΩ\"\n        const serviceMatches = allText.match(/([^\\n]+?)\\s*[\\d\\s]+‚ÇΩ/g);\n        if (serviceMatches) {\n          serviceMatches.forEach(match => {\n            const parts = match.split(/[\\d\\s]+‚ÇΩ/);\n            if (parts.length > 0) {\n              const name = parts[0].trim();\n              const priceMatch = match.match(/([\\d\\s]+)‚ÇΩ/);\n              if (name && priceMatch) {\n                const price = parseInt(priceMatch[1].replace(/\\s/g, '')) || 0;\n                if (price > 0) {\n                  result.services.push({ name, price });\n                }\n              }\n            }\n          });\n        }\n      }\n\n      // –ü–æ–∏—Å–∫ —Å—Ä–æ–∫–æ–≤ –¥–æ—Å—Ç–∞–≤–∫–∏\n      const deliverySelectors = [\n        '.delivery-time',\n        '[data-testid=\"delivery-time\"]',\n        'div:contains(\"–¥–æ—Å—Ç–∞–≤–∫\")',\n        'span:contains(\"–¥–Ω–µ–π\")'\n      ];\n\n      for (const selector of deliverySelectors) {\n        try {\n          const element = document.querySelector(selector);\n          if (element) {\n            result.deliveryTime = element.textContent?.trim() || null;\n            break;\n          }\n        } catch (e) {\n          continue;\n        }\n      }\n\n      return result;\n    });\n\n    const parseTime = ((Date.now() - startTime) / 1000).toFixed(1);\n\n    return {\n      totalCost: results.totalCost,\n      services: results.services,\n      deliveryTime: results.deliveryTime,\n      warnings: results.warnings,\n      parseTime: parseFloat(parseTime)\n    };\n\n  } catch (error: any) {\n    console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ Vozovoz:', error);\n    throw new Error(`–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–µ—Ä–∞: ${error.message}`);\n  } finally {\n    if (browser) {\n      await browser.close();\n    }\n  }\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json();\n    \n    // –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö\n    const requiredFields = ['fromCity', 'toCity', 'length', 'width', 'height', 'weight'];\n    for (const field of requiredFields) {\n      if (!body[field]) {\n        return NextResponse.json({\n          error: `–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ: ${field}`\n        }, { status: 400 });\n      }\n    }\n\n    console.log('üï∑Ô∏è –ó–∞–ø—É—Å–∫ –ø–∞—Ä—Å–µ—Ä–∞ Vozovoz —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏:', body);\n\n    // –ó–∞–ø—É—Å–∫ –ø–∞—Ä—Å–µ—Ä–∞\n    const result = await parseVozovozWebsite(body as VozovozParserParams);\n\n    console.log('‚úÖ –ü–∞—Ä—Å–µ—Ä Vozovoz —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–∏–ª —Ä–∞–±–æ—Ç—É');\n    console.log('üí∞ –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:', result.totalCost);\n    console.log('üì¶ –ù–∞–π–¥–µ–Ω–æ —É—Å–ª—É–≥:', result.services.length);\n\n    return NextResponse.json(result);\n\n  } catch (error: any) {\n    console.error('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø–∞—Ä—Å–µ—Ä–∞ Vozovoz:', error);\n    \n    return NextResponse.json({\n      error: error.message || '–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ –ø–∞—Ä—Å–µ—Ä–∞',\n      details: error.stack\n    }, { status: 500 });\n  }\n}",
        "additions": 4,
        "deletions": 4
      }
    },
    "time": {
      "start": 1764358048283,
      "end": 1764358048294
    }
  }
}