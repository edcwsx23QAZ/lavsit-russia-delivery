{
  "id": "prt_9ba2d3624001qpCG3pN2nf2XwM",
  "messageID": "msg_9ba2ae2cb0018NHVP712deEusw",
  "sessionID": "ses_6852784ecffeuHwynj83p2lr14",
  "type": "tool",
  "tool": "read",
  "callID": "toolu_01CsFpvAdHVf6AzC5bkQELxJ",
  "state": {
    "status": "completed",
    "input": {
      "filePath": "/home/user/project/public/persistent-form-guardian.js"
    },
    "output": "<file>\n00001| // PERSISTENT FORM DATA GUARDIAN\n00002| // Защищает данные формы от любых видов очистки localStorage\n00003| (function() {\n00004|   'use strict';\n00005|   \n00006|   console.log('[FORM-GUARDIAN] Инициализация защиты данных формы...');\n00007|   \n00008|   const FORM_DATA_KEY = 'deliveryFormData';\n00009|   const APP_VERSION_KEY = 'appVersion';\n00010|   const BACKUP_KEYS = ['formBackup1', 'formBackup2', 'formBackup3'];\n00011|   \n00012|   let formDataBackup = null;\n00013|   let appVersionBackup = null;\n00014|   let guardianActive = false;\n00015|   \n00016|   // Функция сохранения данных в резервные копии\n00017|   function createBackups() {\n00018|     try {\n00019|       const formData = localStorage.getItem(FORM_DATA_KEY);\n00020|       const appVersion = localStorage.getItem(APP_VERSION_KEY);\n00021|       \n00022|       if (formData) {\n00023|         formDataBackup = formData;\n00024|         // Создаем несколько резервных копий в localStorage\n00025|         BACKUP_KEYS.forEach((key, index) => {\n00026|           setTimeout(() => {\n00027|             try {\n00028|               localStorage.setItem(key, formData);\n00029|             } catch (e) {\n00030|               console.warn('[FORM-GUARDIAN] Backup failed for:', key, e);\n00031|             }\n00032|           }, index * 10);\n00033|         });\n00034|       }\n00035|       \n00036|       if (appVersion) {\n00037|         appVersionBackup = appVersion;\n00038|         localStorage.setItem('appVersionBackup', appVersion);\n00039|       }\n00040|       \n00041|       console.log('[FORM-GUARDIAN] Backup created:', !!formData, !!appVersion);\n00042|     } catch (e) {\n00043|       console.warn('[FORM-GUARDIAN] Backup creation failed:', e);\n00044|     }\n00045|   }\n00046|   \n00047|   // Функция восстановления данных\n00048|   function restoreFormData() {\n00049|     try {\n00050|       let restored = false;\n00051|       \n00052|       // Проверяем, нужно ли восстановление\n00053|       const currentFormData = localStorage.getItem(FORM_DATA_KEY);\n00054|       if (currentFormData) {\n00055|         console.log('[FORM-GUARDIAN] Form data already exists, no restore needed');\n00056|         return;\n00057|       }\n00058|       \n00059|       // Пытаемся восстановить из memory backup\n00060|       if (formDataBackup) {\n00061|         localStorage.setItem(FORM_DATA_KEY, formDataBackup);\n00062|         console.log('[FORM-GUARDIAN] Restored from memory backup');\n00063|         restored = true;\n00064|       }\n00065|       \n00066|       // Пытаемся восстановить из localStorage backups\n00067|       if (!restored) {\n00068|         for (const backupKey of BACKUP_KEYS) {\n00069|           const backup = localStorage.getItem(backupKey);\n00070|           if (backup) {\n00071|             localStorage.setItem(FORM_DATA_KEY, backup);\n00072|             console.log('[FORM-GUARDIAN] Restored from', backupKey);\n00073|             restored = true;\n00074|             break;\n00075|           }\n00076|         }\n00077|       }\n00078|       \n00079|       // Восстанавливаем версию приложения\n00080|       if (appVersionBackup && !localStorage.getItem(APP_VERSION_KEY)) {\n00081|         localStorage.setItem(APP_VERSION_KEY, appVersionBackup);\n00082|         console.log('[FORM-GUARDIAN] App version restored');\n00083|       }\n00084|       \n00085|       if (restored) {\n00086|         console.log('[FORM-GUARDIAN] ✅ Form data successfully restored');\n00087|         // Пересоздаем backup после восстановления\n00088|         setTimeout(createBackups, 100);\n00089|       } else {\n00090|         console.log('[FORM-GUARDIAN] No backup data found for restoration');\n00091|       }\n00092|       \n00093|     } catch (e) {\n00094|       console.warn('[FORM-GUARDIAN] Restore failed:', e);\n00095|     }\n00096|   }\n00097|   \n00098|   // Мониторинг изменений localStorage\n00099|   function monitorLocalStorage() {\n00100|     if (guardianActive) return;\n00101|     \n00102|     guardianActive = true;\n00103|     console.log('[FORM-GUARDIAN] Monitoring localStorage changes...');\n00104|     \n00105|     // Сохраняем текущие данные\n00106|     createBackups();\n00107|     \n00108|     // Периодически проверяем и восстанавливаем данные\n00109|     const restoreInterval = setInterval(() => {\n00110|       const formData = localStorage.getItem(FORM_DATA_KEY);\n00111|       if (!formData && (formDataBackup || localStorage.getItem(BACKUP_KEYS[0]))) {\n00112|         console.log('[FORM-GUARDIAN] Detected data loss, restoring...');\n00113|         restoreFormData();\n00114|       }\n00115|     }, 500);\n00116|     \n00117|     // Отложенное восстановление после загрузки страницы\n00118|     setTimeout(() => {\n00119|       restoreFormData();\n00120|     }, 1000);\n00121|     \n00122|     // Дополнительное восстановление через 3 секунды (после всех Clear-Site-Data)\n00123|     setTimeout(() => {\n00124|       restoreFormData();\n00125|     }, 3000);\n00126|     \n00127|     // Обновляем backup при изменениях\n00128|     const originalSetItem = localStorage.setItem;\n00129|     localStorage.setItem = function(key, value) {\n00130|       originalSetItem.call(this, key, value);\n00131|       if (key === FORM_DATA_KEY || key === APP_VERSION_KEY) {\n00132|         setTimeout(createBackups, 50);\n00133|       }\n00134|     };\n00135|     \n00136|     // Восстанавливаем при storage events\n00137|     window.addEventListener('storage', function(e) {\n00138|       if (e.key === FORM_DATA_KEY && !e.newValue && formDataBackup) {\n00139|         console.log('[FORM-GUARDIAN] Storage event detected data loss, restoring...');\n00140|         setTimeout(restoreFormData, 100);\n00141|       }\n00142|     });\n00143|     \n00144|     console.log('[FORM-GUARDIAN] ✅ Guardian activated');\n00145|   }\n00146|   \n00147|   // Запускаем мониторинг\n00148|   if (document.readyState === 'loading') {\n00149|     document.addEventListener('DOMContentLoaded', monitorLocalStorage);\n00150|   } else {\n00151|     monitorLocalStorage();\n00152|   }\n00153|   \n00154|   // Запускаем немедленно\n00155|   setTimeout(monitorLocalStorage, 0);\n00156|   \n00157| })();\n</file>",
    "metadata": {
      "preview": "// PERSISTENT FORM DATA GUARDIAN\n// Защищает данные формы от любых видов очистки localStorage\n(function() {\n  'use strict';\n  \n  console.log('[FORM-GUARDIAN] Инициализация защиты данных формы...');\n  \n  const FORM_DATA_KEY = 'deliveryFormData';\n  const APP_VERSION_KEY = 'appVersion';\n  const BACKUP_KEYS = ['formBackup1', 'formBackup2', 'formBackup3'];\n  \n  let formDataBackup = null;\n  let appVersionBackup = null;\n  let guardianActive = false;\n  \n  // Функция сохранения данных в резервные копии\n  function createBackups() {\n    try {\n      const formData = localStorage.getItem(FORM_DATA_KEY);\n      const appVersion = localStorage.getItem(APP_VERSION_KEY);"
    },
    "title": "public/persistent-form-guardian.js",
    "time": {
      "start": 1759765149585,
      "end": 1759765149588
    }
  }
}