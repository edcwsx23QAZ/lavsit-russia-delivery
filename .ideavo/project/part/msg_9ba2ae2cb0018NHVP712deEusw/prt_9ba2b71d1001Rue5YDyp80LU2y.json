{
  "id": "prt_9ba2b71d1001Rue5YDyp80LU2y",
  "messageID": "msg_9ba2ae2cb0018NHVP712deEusw",
  "sessionID": "ses_6852784ecffeuHwynj83p2lr14",
  "type": "tool",
  "tool": "write",
  "callID": "toolu_01PqcVtnsPEEmZvFXmYCvqjf",
  "state": {
    "status": "completed",
    "input": {
      "filePath": "/home/user/project/lib/indexeddb-storage.ts",
      "content": "'use client';\n\n// IndexedDB storage for form data - survives Clear-Site-Data headers\nconst DB_NAME = 'LavsitFormStorage';\nconst DB_VERSION = 1;\nconst STORE_NAME = 'formData';\nconst FORM_DATA_KEY = 'deliveryFormData';\nconst APP_VERSION_KEY = 'appVersion';\n\ninterface IndexedDBFormData {\n  key: string;\n  value: string;\n  timestamp: number;\n}\n\nclass IndexedDBStorage {\n  private db: IDBDatabase | null = null;\n  private initPromise: Promise<void> | null = null;\n\n  async init(): Promise<void> {\n    if (this.initPromise) {\n      return this.initPromise;\n    }\n\n    this.initPromise = new Promise((resolve, reject) => {\n      if (typeof window === 'undefined') {\n        reject(new Error('IndexedDB not available in SSR'));\n        return;\n      }\n\n      const request = indexedDB.open(DB_NAME, DB_VERSION);\n\n      request.onerror = () => {\n        console.error('[INDEXEDDB] Failed to open database:', request.error);\n        reject(request.error);\n      };\n\n      request.onsuccess = () => {\n        this.db = request.result;\n        console.log('[INDEXEDDB] Database opened successfully');\n        resolve();\n      };\n\n      request.onupgradeneeded = (event) => {\n        const db = (event.target as IDBOpenDBRequest).result;\n        \n        if (!db.objectStoreNames.contains(STORE_NAME)) {\n          const store = db.createObjectStore(STORE_NAME, { keyPath: 'key' });\n          store.createIndex('timestamp', 'timestamp', { unique: false });\n          console.log('[INDEXEDDB] Object store created');\n        }\n      };\n    });\n\n    return this.initPromise;\n  }\n\n  async setItem(key: string, value: string): Promise<boolean> {\n    try {\n      await this.init();\n      if (!this.db) throw new Error('Database not initialized');\n\n      return new Promise((resolve, reject) => {\n        const transaction = this.db!.transaction([STORE_NAME], 'readwrite');\n        const store = transaction.objectStore(STORE_NAME);\n        \n        const data: IndexedDBFormData = {\n          key,\n          value,\n          timestamp: Date.now()\n        };\n\n        const request = store.put(data);\n\n        request.onsuccess = () => {\n          console.log(`[INDEXEDDB] Saved ${key}`);\n          resolve(true);\n        };\n\n        request.onerror = () => {\n          console.error(`[INDEXEDDB] Failed to save ${key}:`, request.error);\n          reject(request.error);\n        };\n      });\n    } catch (error) {\n      console.error(`[INDEXEDDB] Error saving ${key}:`, error);\n      return false;\n    }\n  }\n\n  async getItem(key: string): Promise<string | null> {\n    try {\n      await this.init();\n      if (!this.db) throw new Error('Database not initialized');\n\n      return new Promise((resolve, reject) => {\n        const transaction = this.db!.transaction([STORE_NAME], 'readonly');\n        const store = transaction.objectStore(STORE_NAME);\n        const request = store.get(key);\n\n        request.onsuccess = () => {\n          const result = request.result;\n          if (result) {\n            console.log(`[INDEXEDDB] Retrieved ${key}`);\n            resolve(result.value);\n          } else {\n            console.log(`[INDEXEDDB] No data found for ${key}`);\n            resolve(null);\n          }\n        };\n\n        request.onerror = () => {\n          console.error(`[INDEXEDDB] Failed to retrieve ${key}:`, request.error);\n          reject(request.error);\n        };\n      });\n    } catch (error) {\n      console.error(`[INDEXEDDB] Error retrieving ${key}:`, error);\n      return null;\n    }\n  }\n\n  async removeItem(key: string): Promise<boolean> {\n    try {\n      await this.init();\n      if (!this.db) throw new Error('Database not initialized');\n\n      return new Promise((resolve, reject) => {\n        const transaction = this.db!.transaction([STORE_NAME], 'readwrite');\n        const store = transaction.objectStore(STORE_NAME);\n        const request = store.delete(key);\n\n        request.onsuccess = () => {\n          console.log(`[INDEXEDDB] Removed ${key}`);\n          resolve(true);\n        };\n\n        request.onerror = () => {\n          console.error(`[INDEXEDDB] Failed to remove ${key}:`, request.error);\n          reject(request.error);\n        };\n      });\n    } catch (error) {\n      console.error(`[INDEXEDDB] Error removing ${key}:`, error);\n      return false;\n    }\n  }\n\n  async clear(): Promise<boolean> {\n    try {\n      await this.init();\n      if (!this.db) throw new Error('Database not initialized');\n\n      return new Promise((resolve, reject) => {\n        const transaction = this.db!.transaction([STORE_NAME], 'readwrite');\n        const store = transaction.objectStore(STORE_NAME);\n        const request = store.clear();\n\n        request.onsuccess = () => {\n          console.log('[INDEXEDDB] All data cleared');\n          resolve(true);\n        };\n\n        request.onerror = () => {\n          console.error('[INDEXEDDB] Failed to clear data:', request.error);\n          reject(request.error);\n        };\n      });\n    } catch (error) {\n      console.error('[INDEXEDDB] Error clearing data:', error);\n      return false;\n    }\n  }\n\n  async getAllKeys(): Promise<string[]> {\n    try {\n      await this.init();\n      if (!this.db) throw new Error('Database not initialized');\n\n      return new Promise((resolve, reject) => {\n        const transaction = this.db!.transaction([STORE_NAME], 'readonly');\n        const store = transaction.objectStore(STORE_NAME);\n        const request = store.getAllKeys();\n\n        request.onsuccess = () => {\n          resolve(request.result as string[]);\n        };\n\n        request.onerror = () => {\n          console.error('[INDEXEDDB] Failed to get keys:', request.error);\n          reject(request.error);\n        };\n      });\n    } catch (error) {\n      console.error('[INDEXEDDB] Error getting keys:', error);\n      return [];\n    }\n  }\n}\n\n// Singleton instance\nconst indexedDBStorage = new IndexedDBStorage();\n\n// Public API functions\nexport const saveFormDataToIndexedDB = async (formData: string): Promise<boolean> => {\n  return await indexedDBStorage.setItem(FORM_DATA_KEY, formData);\n};\n\nexport const loadFormDataFromIndexedDB = async (): Promise<string | null> => {\n  return await indexedDBStorage.getItem(FORM_DATA_KEY);\n};\n\nexport const saveAppVersionToIndexedDB = async (version: string): Promise<boolean> => {\n  return await indexedDBStorage.setItem(APP_VERSION_KEY, version);\n};\n\nexport const loadAppVersionFromIndexedDB = async (): Promise<string | null> => {\n  return await indexedDBStorage.getItem(APP_VERSION_KEY);\n};\n\nexport const clearFormDataFromIndexedDB = async (): Promise<boolean> => {\n  const success1 = await indexedDBStorage.removeItem(FORM_DATA_KEY);\n  const success2 = await indexedDBStorage.removeItem(APP_VERSION_KEY);\n  return success1 && success2;\n};\n\nexport const clearAllIndexedDBData = async (): Promise<boolean> => {\n  return await indexedDBStorage.clear();\n};\n\n// Helper function to check if IndexedDB is available\nexport const isIndexedDBAvailable = (): boolean => {\n  return typeof window !== 'undefined' && 'indexedDB' in window;\n};\n\nconsole.log('[INDEXEDDB] Storage module initialized');"
    },
    "output": "",
    "metadata": {
      "diagnostics": {},
      "filepath": "/home/user/project/lib/indexeddb-storage.ts",
      "exists": false
    },
    "title": "lib/indexeddb-storage.ts",
    "time": {
      "start": 1759765053896,
      "end": 1759765053899
    }
  }
}