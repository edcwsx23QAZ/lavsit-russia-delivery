{
  "id": "prt_a930ef73d001aq1ySYMyLi1s2C",
  "sessionID": "ses_6852784ecffeuHwynj83p2lr14",
  "messageID": "msg_a930eebb5001VXyXjAdIhTiM8U",
  "type": "tool",
  "callID": "call_43066289",
  "tool": "read",
  "state": {
    "status": "completed",
    "input": {
      "filePath": "app/diagnostic/page.tsx"
    },
    "output": "<file>\n00001| 'use client';\n00002| \n00003| import React, { useEffect, useCallback, useState, Suspense } from 'react';\n00004| import { useSearchParams } from 'next/navigation';\n00005| import { useDiagnosticState } from '@/hooks/useDiagnosticState';\n00006| import DiagnosticHeader from '@/components/diagnostic/DiagnosticHeader';\n00007| import ApiTestingSection from '@/components/diagnostic/ApiTestingSection';\n00008| import ManualTesting from '@/components/diagnostic/ManualTesting';\n00009| import { LazyFullTestingResults, LazyVehicleManagement } from '@/components/diagnostic/LazyLoadedComponents';\n00010| import TechnicalDocumentation from '@/components/diagnostic/TechnicalDocumentation';\n00011| import ApiMasterTab from '@/components/diagnostic/ApiMasterTab';\n00012| import { apiRequestWithTimeout, PerformanceMonitor } from '@/lib/api-utils';\n00013| import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';\n00014| \n00015| function DiagnosticContent() {\n00016|   const { state, actions } = useDiagnosticState();\n00017|   const searchParams = useSearchParams();\n00018|   const [activeTab, setActiveTab] = useState('api-testing');\n00019| \n00020|   // Initialize data on mount and handle URL params\n00021|   useEffect(() => {\n00022|     try {\n00023|       const saved = localStorage.getItem('vehicleTypes');\n00024|       if (saved) {\n00025|         const parsedVehicleTypes = JSON.parse(saved);\n00026|         actions.initializeVehicleTypes(parsedVehicleTypes, null);\n00027|       }\n00028|       \n00029|       const lastUpdate = localStorage.getItem('lastProductDataUpdate');\n00030|       if (lastUpdate) {\n00031|         actions.setLastUpdateTime(new Date(lastUpdate).toLocaleString('ru-RU'));\n00032|       }\n00033| \n00034|       // Handle URL parameters for tab selection\n00035|       const tabParam = searchParams.get('tab');\n00036|       if (tabParam === 'api') {\n00037|         setActiveTab('all-api');\n00038|       } else if (tabParam === 'docs') {\n00039|         setActiveTab('documentation');\n00040|       }\n00041|     } catch (error) {\n00042|       console.error('Ошибка загрузки сохранённых данных:', error);\n00043|     }\n00044|   }, [actions, searchParams]);\n00045| \n00046|   // API testing functions with performance monitoring\n00047|   const testAPI = useCallback(async (service: string, endpoint: string, data: any = {}) => {\n00048|     const endTiming = PerformanceMonitor.startMeasurement(`diagnostic_${service}`);\n00049|     actions.setTestingState(service, true);\n00050|     \n00051|     try {\n00052|       const response = await apiRequestWithTimeout(endpoint, {\n00053|         method: 'POST',\n00054|         headers: { 'Content-Type': 'application/json' },\n00055|         body: JSON.stringify(data)\n00056|       }, { timeout: 15000, retries: 1 });\n00057| \n00058|       const result = await response.json();\n00059|       const timing = endTiming();\n00060| \n00061|       if (response.ok) {\n00062|         actions.setDiagnosticResult(service.toLowerCase(), {\n00063|           status: 'success',\n00064|           message: `✅ ${service} API работает корректно`,\n00065|           details: result,\n00066|           timing\n00067|         });\n00068|       } else {\n00069|         actions.setDiagnosticResult(service.toLowerCase(), {\n00070|           status: 'error',\n00071|           message: `❌ Ошибка ${service} API: ${result.error || 'Неизвестная ошибка'}`,\n00072|           details: result,\n00073|           timing\n00074|         });\n00075|       }\n00076|     } catch (error) {\n00077|       endTiming();\n00078|       actions.setDiagnosticResult(service.toLowerCase(), {\n00079|         status: 'error',\n00080|         message: `❌ Сетевая ошибка ${service} API`,\n00081|         details: error instanceof Error ? error.message : 'Неизвестная ошибка'\n00082|       });\n00083|     } finally {\n00084|       actions.setTestingState(service, false);\n00085|     }\n00086|   }, [actions]);\n00087| \n00088|   const testPEK = useCallback(() => {\n00089|     testAPI('PEK', '/api/pek', { method: 'test' });\n00090|   }, [testAPI]);\n00091| \n00092|   const testDellin = useCallback(() => {\n00093|     testAPI('Dellin', '/api/dellin-packages', { method: 'test' });\n00094|   }, [testAPI]);\n00095| \n00096|   const testRailContinent = useCallback(() => {\n00097|     testAPI('RailContinent', '/api/rail-continent', { method: 'test' });\n00098|   }, [testAPI]);\n00099| \n00100|   const testVozovoz = useCallback(() => {\n00101|     testAPI('Vozovoz', '/api/vozovoz', { method: 'test' });\n00102|   }, [testAPI]);\n00103| \n00104|   const testNordWheel = useCallback(() => {\n00105|     testAPI('NordWheel', '/api/test', { service: 'nordwheel' });\n00106|   }, [testAPI]);\n00107| \n00108|   const testAllAPIs = useCallback(async () => {\n00109|     actions.resetDiagnosticResults();\n00110|     \n00111|     const tests = [\n00112|       () => testPEK(),\n00113|       () => testDellin(), \n00114|       () => testRailContinent(),\n00115|       () => testVozovoz(),\n00116|       () => testNordWheel()\n00117|     ];\n00118| \n00119|     // Run tests in parallel for better performance\n00120|     await Promise.allSettled(tests.map(test => test()));\n00121|   }, [actions, testPEK, testDellin, testRailContinent, testVozovoz, testNordWheel]);\n00122| \n00123|   const runFullTesting = useCallback(async () => {\n00124|     actions.setFullTesting(true);\n00125|     actions.setTestProgress({ \n00126|       currentTK: 'Начинаем тестирование...', \n00127|       completedTests: 0, \n00128|       totalPlannedTests: 25, \n00129|       stage: 'Инициализация',\n00130|       progress: 0 \n00131|     });\n00132| \n00133|     const startTime = Date.now();\n00134|     const results: any[] = [];\n00135|     const errors: string[] = [];\n00136| \n00137|     const testCases = [\n00138|       { service: 'ПЭК', endpoint: '/api/pek', data: { method: 'test' } },\n00139|       { service: 'Деловые Линии', endpoint: '/api/dellin-packages', data: { method: 'test' } },\n00140|       { service: 'Rail Continent', endpoint: '/api/rail-continent', data: { method: 'test' } },\n00141|       { service: 'Возовоз', endpoint: '/api/vozovoz', data: { method: 'test' } },\n00142|       { service: 'Nord Wheel', endpoint: '/api/test', data: { service: 'nordwheel' } }\n00143|     ];\n00144| \n00145|     for (let i = 0; i < testCases.length; i++) {\n00146|       const testCase = testCases[i];\n00147|       const progress = Math.round(((i + 1) / testCases.length) * 100);\n00148|       \n00149|       actions.setTestProgress({\n00150|         currentTK: testCase.service,\n00151|         completedTests: i,\n00152|         totalPlannedTests: testCases.length,\n00153|         stage: 'Тестирование API',\n00154|         progress\n00155|       });\n00156| \n00157|       try {\n00158|         const response = await apiRequestWithTimeout(testCase.endpoint, {\n00159|           method: 'POST',\n00160|           headers: { 'Content-Type': 'application/json' },\n00161|           body: JSON.stringify(testCase.data)\n00162|         }, { timeout: 10000 });\n00163| \n00164|         const result = await response.json();\n00165|         \n00166|         results.push({\n00167|           company: testCase.service,\n00168|           status: response.ok ? 'passed' : 'failed',\n00169|           message: response.ok ? 'Тест пройден успешно' : result.error || 'Ошибка теста',\n00170|           details: result,\n00171|           timing: result.timing || 0,\n00172|           timestamp: new Date().toISOString()\n00173|         });\n00174| \n00175|         if (!response.ok) {\n00176|           errors.push(`${testCase.service}: ${result.error || 'Неизвестная ошибка'}`);\n00177|         }\n00178|       } catch (error) {\n00179|         results.push({\n00180|           company: testCase.service,\n00181|           status: 'failed',\n00182|           message: 'Сетевая ошибка или таймаут',\n00183|           details: error instanceof Error ? error.message : 'Неизвестная ошибка',\n00184|           timing: 0,\n00185|           timestamp: new Date().toISOString()\n00186|         });\n00187|         errors.push(`${testCase.service}: Сетевая ошибка`);\n00188|       }\n00189| \n00190|       // Small delay for UI updates\n00191|       await new Promise(resolve => setTimeout(resolve, 200));\n00192|     }\n00193| \n00194|     const endTime = Date.now();\n00195|     const totalTime = endTime - startTime;\n00196|     const successful = results.filter(r => r.status === 'passed').length;\n00197|     const failed = results.filter(r => r.status === 'failed').length;\n00198|     const averageTime = results.reduce((sum, r) => sum + r.timing, 0) / results.length;\n00199| \n00200|     actions.setFullTestResults({\n00201|       summary: {\n00202|         totalTests: results.length,\n00203|         successful,\n00204|         failed,\n00205|         skipped: 0,\n00206|         errors,\n00207|         averageResponseTime: Math.round(averageTime),\n00208|         successRate: (successful / results.length) * 100\n00209|       },\n00210|       details: results,\n00211|       progressInfo: null\n00212|     });\n00213| \n00214|     actions.setTestProgress(null);\n00215|     actions.setFullTesting(false);\n00216|   }, [actions]);\n00217| \n00218|   // Vehicle management functions\n00219|   const addVehicleType = useCallback(() => {\n00220|     const { name, length, width, height } = state.newVehicle;\n00221|     \n00222|     if (!name || !length || !width || !height) {\n00223|       alert('Пожалуйста, заполните все поля');\n00224|       return;\n00225|     }\n00226|     \n00227|     const newId = (state.vehicleTypes.length + 1).toString();\n00228|     const vehicleToAdd = {\n00229|       id: newId,\n00230|       name,\n00231|       length: parseInt(length),\n00232|       width: parseInt(width),\n00233|       height: parseInt(height)\n00234|     };\n00235|     \n00236|     actions.addVehicleType(vehicleToAdd);\n00237|   }, [state.newVehicle, state.vehicleTypes.length, actions]);\n00238| \n00239|   const saveVehicleTypes = useCallback(async () => {\n00240|     actions.setSavingState(true);\n00241|     actions.setSaveStatus('saving');\n00242|     \n00243|     try {\n00244|       localStorage.setItem('vehicleTypes', JSON.stringify(state.vehicleTypes));\n00245|       await new Promise(resolve => setTimeout(resolve, 1000));\n00246|       \n00247|       actions.setUnsavedChanges(false);\n00248|       actions.setSaveStatus('success');\n00249|       setTimeout(() => actions.setSaveStatus('idle'), 3000);\n00250|     } catch (error) {\n00251|       console.error('Ошибка сохранения:', error);\n00252|       actions.setSaveStatus('error');\n00253|       setTimeout(() => actions.setSaveStatus('idle'), 5000);\n00254|     } finally {\n00255|       actions.setSavingState(false);\n00256|     }\n00257|   }, [state.vehicleTypes, actions]);\n00258| \n00259|   const updateProductData = useCallback(async () => {\n00260|     actions.setUpdatingData(true);\n00261|     actions.setUpdateStatus('updating');\n00262|     \n00263|     try {\n00264|       const response = await apiRequestWithTimeout('/api/furniture-products?update=true&force=true&timestamp=' + Date.now(), {\n00265|         method: 'GET',\n00266|         headers: {\n00267|           'Cache-Control': 'no-cache, no-store, must-revalidate',\n00268|           'Pragma': 'no-cache',\n00269|           'Expires': '0'\n00270|         }\n00271|       }, { timeout: 30000 });\n00272| \n00273|       const result = await response.json();\n00274|       \n00275|       if (!result.success) {\n00276|         throw new Error(result.error || 'Ошибка обновления данных');\n00277|       }\n00278| \n00279|       const updateTime = new Date().toLocaleString('ru-RU');\n00280|       localStorage.setItem('lastProductDataUpdate', new Date().toISOString());\n00281|       actions.setLastUpdateTime(updateTime);\n00282|       actions.setUpdateStatus('success');\n00283|       \n00284|       setTimeout(() => actions.setUpdateStatus('idle'), 3000);\n00285|     } catch (error) {\n00286|       console.error('Ошибка обновления данных:', error);\n00287|       actions.setUpdateStatus('error');\n00288|       setTimeout(() => actions.setUpdateStatus('idle'), 5000);\n00289|     } finally {\n00290|       actions.setUpdatingData(false);\n00291|     }\n00292|   }, [actions]);\n00293| \n00294|   return (\n00295|     <div className=\"min-h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 p-6\">\n00296|       <div className=\"max-w-7xl mx-auto\">\n00297|         <DiagnosticHeader\n00298|           onTestAllAPIs={testAllAPIs}\n00299|           onRunFullTesting={runFullTesting}\n00300|           onUpdateProductData={updateProductData}\n00301|           isFullTesting={state.isFullTesting}\n00302|           isUpdatingData={state.isUpdatingData}\n00303|           updateStatus={state.updateStatus}\n00304|         />\n00305| \n00306|         <Tabs value={activeTab} onValueChange={setActiveTab} className=\"w-full\">\n00307|           <TabsList className=\"grid w-full grid-cols-4 bg-gray-800 border-gray-700\">\n00308|             <TabsTrigger value=\"api-testing\" className=\"text-white data-[state=active]:bg-blue-600\">\n00309|               Тестирование API\n00310|             </TabsTrigger>\n00311|             <TabsTrigger value=\"full-testing\" className=\"text-white data-[state=active]:bg-purple-600\">\n00312|               Полное тестирование\n00313|             </TabsTrigger>\n00314|             <TabsTrigger value=\"all-api\" className=\"text-white data-[state=active]:bg-green-600\">\n00315|               Все API\n00316|             </TabsTrigger>\n00317|             <TabsTrigger value=\"documentation\" className=\"text-white data-[state=active]:bg-orange-600\">\n00318|               Техническая документация\n00319|             </TabsTrigger>\n00320|           </TabsList>\n00321| \n00322|           <TabsContent value=\"api-testing\" className=\"mt-6\">\n00323|             <ApiTestingSection\n00324|               diagnosticResults={state.diagnosticResults}\n00325|               testStates={{\n00326|                 isTestingPEK: state.isTestingPEK,\n00327|                 isTestingDellin: state.isTestingDellin,\n00328|                 isTestingRailContinent: state.isTestingRailContinent,\n00329|                 isTestingVozovoz: state.isTestingVozovoz,\n00330|                 isTestingNordWheel: state.isTestingNordWheel,\n00331|               }}\n00332|               onTestPEK={testPEK}\n00333|               onTestDellin={testDellin}\n00334|               onTestRailContinent={testRailContinent}\n00335|               onTestVozovoz={testVozovoz}\n00336|               onTestNordWheel={testNordWheel}\n00337|             />\n00338| \n00339|             <LazyFullTestingResults\n00340|               fullTestResults={state.fullTestResults}\n00341|               testProgress={state.testProgress?.progress || 0}\n00342|               isFullTesting={state.isFullTesting}\n00343|             />\n00344|           </TabsContent>\n00345| \n00346|           <TabsContent value=\"full-testing\" className=\"mt-6\">\n00347|             <ManualTesting />\n00348|           </TabsContent>\n00349| \n00350|           <TabsContent value=\"all-api\" className=\"mt-6\">\n00351|             <ApiMasterTab />\n00352|           </TabsContent>\n00353| \n00354|           <TabsContent value=\"documentation\" className=\"mt-6\">\n00355|             <TechnicalDocumentation />\n00356|           </TabsContent>\n00357|         </Tabs>\n00358| \n00359|         <LazyVehicleManagement\n00360|           vehicleTypes={state.vehicleTypes}\n00361|           newVehicle={state.newVehicle}\n00362|           hasUnsavedChanges={state.hasUnsavedChanges}\n00363|           saveStatus={state.saveStatus}\n00364|           isSaving={state.isSaving}\n00365|           lastUpdateTime={state.lastUpdateTime}\n00366|           onAddVehicleType={addVehicleType}\n00367|           onRemoveVehicleType={actions.removeVehicleType}\n00368|           onUpdateVehicleType={actions.updateVehicleType}\n00369|           onSaveVehicleTypes={saveVehicleTypes}\n00370|           onSetNewVehicle={actions.setNewVehicle}\n00371|         />\n00372|       </div>\n00373|     </div>\n00374|   );\n00375| }\n00376| \n00377| export default function OptimizedDiagnosticPage() {\n00378|   return (\n00379|     <Suspense fallback={\n00380|       <div className=\"min-h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 p-6 flex items-center justify-center\">\n00381|         <div className=\"text-white text-xl\">Загрузка...</div>\n00382|       </div>\n00383|     }>\n00384|       <DiagnosticContent />\n00385|     </Suspense>\n00386|   );\n00387| }\n</file>",
    "title": "app/diagnostic/page.tsx",
    "metadata": {
      "preview": "'use client';\n\nimport React, { useEffect, useCallback, useState, Suspense } from 'react';\nimport { useSearchParams } from 'next/navigation';\nimport { useDiagnosticState } from '@/hooks/useDiagnosticState';\nimport DiagnosticHeader from '@/components/diagnostic/DiagnosticHeader';\nimport ApiTestingSection from '@/components/diagnostic/ApiTestingSection';\nimport ManualTesting from '@/components/diagnostic/ManualTesting';\nimport { LazyFullTestingResults, LazyVehicleManagement } from '@/components/diagnostic/LazyLoadedComponents';\nimport TechnicalDocumentation from '@/components/diagnostic/TechnicalDocumentation';\nimport ApiMasterTab from '@/components/diagnostic/ApiMasterTab';\nimport { apiRequestWithTimeout, PerformanceMonitor } from '@/lib/api-utils';\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';\n\nfunction DiagnosticContent() {\n  const { state, actions } = useDiagnosticState();\n  const searchParams = useSearchParams();\n  const [activeTab, setActiveTab] = useState('api-testing');\n\n  // Initialize data on mount and handle URL params"
    },
    "time": {
      "start": 1763403822911,
      "end": 1763403822913
    }
  }
}