{
  "id": "prt_ae4570a01001u92g2s5TWVY8d4",
  "sessionID": "ses_533b8e2fbffeGf4K6SZ0fxy9mZ",
  "messageID": "msg_ae456f0ae001qkgFv57fakRW9m",
  "type": "tool",
  "callID": "call_d78e5e4306ae4d62b335bdcf",
  "tool": "edit",
  "state": {
    "status": "completed",
    "input": {
      "filePath": "/home/user/project/lib/form-storage.ts",
      "oldString": "      enabledCompanies: oldData.enabledCompanies || {},",
      "newString": "      enabledCompanies: oldData.enabledCompanies || {},\n      hiddenCompanies: oldData.hiddenCompanies || {},"
    },
    "output": "",
    "title": "lib/form-storage.ts",
    "metadata": {
      "diagnostics": {},
      "diff": "Index: /home/user/project/lib/form-storage.ts\n===================================================================\n--- /home/user/project/lib/form-storage.ts\n+++ /home/user/project/lib/form-storage.ts\n@@ -256,8 +256,9 @@\n   toAddressDelivery: oldData.toAddressDelivery || false,\n   fromLavsiteWarehouse: oldData.fromLavsiteWarehouse || false,\n   selectedProducts: oldData.selectedProducts || [],\n   enabledCompanies: oldData.enabledCompanies || {},\n+  hiddenCompanies: oldData.hiddenCompanies || {},\n };\n \n // –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ\n localStorage.setItem(FORM_DATA_KEY, JSON.stringify(migratedData));\n",
      "filediff": {
        "file": "/home/user/project/lib/form-storage.ts",
        "before": "'use client';\n\nimport { \n  saveFormDataToIndexedDB, \n  loadFormDataFromIndexedDB, \n  clearFormDataFromIndexedDB,\n  isIndexedDBAvailable \n} from './indexeddb-storage';\nimport { \n  saveFormDataToCookies, \n  loadFormDataFromCookies, \n  clearFormDataFromCookies,\n  isCookieStorageAvailable \n} from './cookie-storage';\n\n// –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è –∫–ª—é—á–µ–π localStorage\nconst FORM_DATA_KEY = 'deliveryFormData';\nconst FORM_VERSION = '1.2'; // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–æ–ª–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ñ–æ—Ä–º—ã + enabledCompanies\n\nexport interface StoredFormData {\n  version: string;\n  timestamp: number;\n  cargos: Array<{\n    id: string;\n    length: number;\n    width: number;\n    height: number;\n    weight: number;\n    productId?: string;\n    placeNumber?: number;\n    isFromProduct?: boolean;\n    addedAt?: number;\n  }>;\n  fromCity: string;\n  toCity: string;\n  fromAddress: string;\n  toAddress: string;\n  declaredValue: number;\n  needPackaging: boolean;\n  needLoading: boolean;\n  needCarry: boolean;\n  floor: number;\n  hasFreightLift: boolean;\n  needInsurance: boolean;\n  fromTerminal: boolean;\n  toTerminal: boolean;\n  fromAddressDelivery: boolean;\n  toAddressDelivery: boolean;\n  fromLavsiteWarehouse: boolean;\n  selectedProducts: Array<{\n    product: {\n      id: string;\n      externalCode: string;\n      name: string;\n      retailPrice: number;\n      isActive: boolean;\n      cargoPlaces: Array<{\n        placeNumber: number;\n        weight: number;\n        height: number;\n        depth: number;\n        length: number;\n      }>;\n    };\n    quantity: number;\n    totalPrice: number;\n    cargoIndexes: number[];\n    addedAt: number;\n  }>;\n  enabledCompanies?: Record<string, boolean>;\n  hiddenCompanies?: Record<string, boolean>;\n}\n\n/**\n * –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã –≤ localStorage, IndexedDB –∏ cookies (—Ç—Ä–æ–π–Ω–∞—è –∑–∞—â–∏—Ç–∞)\n * –ù–ï —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—Å—á–µ—Ç–æ–≤ - —Ç–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –≤–≤–æ–¥\n */\nexport const saveFormData = (formData: Partial<StoredFormData>): boolean => {\n  try {\n    if (typeof window === 'undefined') {\n      return false; // SSR safe\n    }\n\n    const dataToSave: StoredFormData = {\n      version: FORM_VERSION,\n      timestamp: Date.now(),\n      cargos: formData.cargos || [],\n      fromCity: formData.fromCity || '',\n      toCity: formData.toCity || '',\n      fromAddress: formData.fromAddress || '',\n      toAddress: formData.toAddress || '',\n      declaredValue: formData.declaredValue || 0,\n      needPackaging: formData.needPackaging || false,\n      needLoading: formData.needLoading || false,\n      needCarry: formData.needCarry || false,\n      floor: formData.floor || 1,\n      hasFreightLift: formData.hasFreightLift || false,\n      needInsurance: formData.needInsurance || false,\n      fromTerminal: formData.fromTerminal ?? true,\n      toTerminal: formData.toTerminal ?? true,\n      fromAddressDelivery: formData.fromAddressDelivery || false,\n      toAddressDelivery: formData.toAddressDelivery || false,\n      fromLavsiteWarehouse: formData.fromLavsiteWarehouse || false,\n      selectedProducts: formData.selectedProducts || [],\n      enabledCompanies: formData.enabledCompanies || {},\n      hiddenCompanies: formData.hiddenCompanies || {},\n    };\n\n    const serializedData = JSON.stringify(dataToSave);\n    \n    // –¢—Ä–æ–π–Ω–∞—è –∑–∞—â–∏—Ç–∞: —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage, IndexedDB –∏ cookies\n    let localStorageSuccess = false;\n    let indexedDBSuccess = false;\n    let cookieSuccess = false;\n    \n    // 1. localStorage (–æ—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥)\n    try {\n      localStorage.setItem(FORM_DATA_KEY, serializedData);\n      localStorageSuccess = true;\n      console.log('üíæ –î–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ localStorage');\n    } catch (error) {\n      console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ localStorage:', error);\n    }\n    \n    // 2. IndexedDB (–∑–∞—â–∏—Ç–∞ –æ—Ç Clear-Site-Data –¥–ª—è storage)\n    if (isIndexedDBAvailable()) {\n      saveFormDataToIndexedDB(serializedData).then(success => {\n        if (success) {\n          console.log('üíæ –î–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ IndexedDB');\n        }\n      }).catch(error => {\n        console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ IndexedDB:', error);\n      });\n    }\n    \n    // 3. Cookies (–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞)\n    if (isCookieStorageAvailable()) {\n      try {\n        cookieSuccess = saveFormDataToCookies(serializedData);\n        if (cookieSuccess) {\n          console.log('üíæ –î–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ cookies');\n        }\n      } catch (error) {\n        console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ cookies:', error);\n      }\n    }\n    \n    console.log(`üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ: localStorage=${localStorageSuccess}, IndexedDB=async, cookies=${cookieSuccess}`);\n    return localStorageSuccess; // localStorage –æ—Å—Ç–∞–µ—Ç—Å—è –æ—Å–Ω–æ–≤–Ω—ã–º –∫—Ä–∏—Ç–µ—Ä–∏–µ–º —É—Å–ø–µ—Ö–∞\n  } catch (error) {\n    console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Ñ–æ—Ä–º—ã:', error);\n    return false;\n  }\n};\n\n/**\n * –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã —Å —Ç—Ä–æ–π–Ω–æ–π –∑–∞—â–∏—Ç–æ–π (localStorage -> IndexedDB -> cookies)\n */\nexport const loadFormData = (): StoredFormData | null => {\n  try {\n    if (typeof window === 'undefined') {\n      return null; // SSR safe\n    }\n\n    let savedData = localStorage.getItem(FORM_DATA_KEY);\n    let dataSource = 'localStorage';\n    \n    // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç –≤ localStorage, –ø—Ä–æ–±—É–µ–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ –¥—Ä—É–≥–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤\n    if (!savedData) {\n      console.log('üìù –î–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ localStorage, –ø—Ä–æ–≤–µ—Ä—è–µ–º –¥—Ä—É–≥–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏...');\n      \n      // –ü—Ä–æ–±—É–µ–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ IndexedDB (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)\n      loadFormDataFromIndexedDB().then(indexedData => {\n        if (indexedData) {\n          console.log('üìÇ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –∏–∑ IndexedDB');\n          try {\n            localStorage.setItem(FORM_DATA_KEY, indexedData);\n            console.log('üíæ –î–∞–Ω–Ω—ã–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –≤ localStorage –∏–∑ IndexedDB');\n          } catch (error) {\n            console.warn('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å localStorage –∏–∑ IndexedDB:', error);\n          }\n        }\n      }).catch(error => {\n        console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑ IndexedDB:', error);\n      });\n      \n      // –ü—Ä–æ–±—É–µ–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ cookies (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)\n      const cookieData = loadFormDataFromCookies();\n      if (cookieData) {\n        savedData = cookieData;\n        dataSource = 'cookies';\n        console.log('üìÇ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –∏–∑ cookies');\n        try {\n          localStorage.setItem(FORM_DATA_KEY, cookieData);\n          console.log('üíæ –î–∞–Ω–Ω—ã–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –≤ localStorage –∏–∑ cookies');\n        } catch (error) {\n          console.warn('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å localStorage –∏–∑ cookies:', error);\n        }\n      }\n    }\n    \n    if (!savedData) {\n      console.log('üìù –°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –Ω–∏ –≤ –æ–¥–Ω–æ–º –∏—Å—Ç–æ—á–Ω–∏–∫–µ');\n      return null;\n    }\n\n    const parsedData = JSON.parse(savedData) as StoredFormData;\n    \n    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–∏ –¥–∞–Ω–Ω—ã—Ö\n    if (parsedData.version !== FORM_VERSION) {\n      console.warn('‚ö†Ô∏è –í–µ—Ä—Å–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç, –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –º–∏–≥—Ä–∞—Ü–∏—è...');\n      // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã\n      return migrateFormData(parsedData);\n    }\n\n    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ä–æ–∫–∞ –¥–∞–≤–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ - —É–¥–∞–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π)\n    const thirtyDaysInMs = 30 * 24 * 60 * 60 * 1000;\n    if (Date.now() - parsedData.timestamp > thirtyDaysInMs) {\n      console.log('üóëÔ∏è –°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–ª–∏—à–∫–æ–º —Å—Ç–∞—Ä—ã–µ, —É–¥–∞–ª—è–µ–º...');\n      clearFormData();\n      return null;\n    }\n\n    console.log(`üìÇ –î–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ ${dataSource}:`, parsedData);\n    return parsedData;\n  } catch (error) {\n    console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Ñ–æ—Ä–º—ã:', error);\n    return null;\n  }\n};\n\n/**\n * –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –≤–µ—Ä—Å–∏–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã\n */\nconst migrateFormData = (oldData: any): StoredFormData | null => {\n  try {\n    // –ë–∞–∑–æ–≤–∞—è –º–∏–≥—Ä–∞—Ü–∏—è - –ø—Ä–∏–≤–æ–¥–∏–º –∫ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ\n    const migratedData: StoredFormData = {\n      version: FORM_VERSION,\n      timestamp: Date.now(),\n      cargos: oldData.cargos || [{ id: '1', length: 0, width: 0, height: 0, weight: 0 }],\n      fromCity: oldData.fromCity || '',\n      toCity: oldData.toCity || '',\n      fromAddress: oldData.fromAddress || '',\n      toAddress: oldData.toAddress || '',\n      declaredValue: oldData.declaredValue || 0,\n      needPackaging: oldData.needPackaging || false,\n      needLoading: oldData.needLoading || false,\n      needCarry: oldData.needCarry || false,\n      floor: oldData.floor || 1,\n      hasFreightLift: oldData.hasFreightLift || false,\n      needInsurance: oldData.needInsurance || false,\n      fromTerminal: oldData.fromTerminal ?? true,\n      toTerminal: oldData.toTerminal ?? true,\n      fromAddressDelivery: oldData.fromAddressDelivery || false,\n      toAddressDelivery: oldData.toAddressDelivery || false,\n      fromLavsiteWarehouse: oldData.fromLavsiteWarehouse || false,\n      selectedProducts: oldData.selectedProducts || [],\n      enabledCompanies: oldData.enabledCompanies || {},\n    };\n\n    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ\n    localStorage.setItem(FORM_DATA_KEY, JSON.stringify(migratedData));\n    console.log('‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã');\n    return migratedData;\n  } catch (error) {\n    console.error('‚ùå –û—à–∏–±–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö:', error);\n    return null;\n  }\n};\n\n/**\n * –û—á–∏—â–∞–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã –∏–∑ –≤—Å–µ—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ (localStorage, IndexedDB, cookies)\n */\nexport const clearFormData = (): boolean => {\n  try {\n    if (typeof window === 'undefined') {\n      return false;\n    }\n\n    let localStorageSuccess = false;\n    let indexedDBSuccess = false;\n    let cookieSuccess = false;\n    \n    // –û—á–∏—â–∞–µ–º localStorage\n    try {\n      localStorage.removeItem(FORM_DATA_KEY);\n      localStorageSuccess = true;\n      console.log('üóëÔ∏è –î–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã —É–¥–∞–ª–µ–Ω—ã –∏–∑ localStorage');\n    } catch (error) {\n      console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∏–∑ localStorage:', error);\n    }\n    \n    // –û—á–∏—â–∞–µ–º IndexedDB\n    if (isIndexedDBAvailable()) {\n      clearFormDataFromIndexedDB().then(success => {\n        if (success) {\n          console.log('üóëÔ∏è –î–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã —É–¥–∞–ª–µ–Ω—ã –∏–∑ IndexedDB');\n        }\n      }).catch(error => {\n        console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∏–∑ IndexedDB:', error);\n      });\n    }\n    \n    // –û—á–∏—â–∞–µ–º cookies\n    if (isCookieStorageAvailable()) {\n      try {\n        cookieSuccess = clearFormDataFromCookies();\n        if (cookieSuccess) {\n          console.log('üóëÔ∏è –î–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã —É–¥–∞–ª–µ–Ω—ã –∏–∑ cookies');\n        }\n      } catch (error) {\n        console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∏–∑ cookies:', error);\n      }\n    }\n    \n    console.log(`üóëÔ∏è –£–¥–∞–ª–µ–Ω–∏–µ: localStorage=${localStorageSuccess}, IndexedDB=async, cookies=${cookieSuccess}`);\n    return localStorageSuccess;\n  } catch (error) {\n    console.error('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Ñ–æ—Ä–º—ã:', error);\n    return false;\n  }\n};\n\n/**\n * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –µ—Å—Ç—å –ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –ª—é–±–æ–º –∏–∑ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤\n */\nexport const hasStoredFormData = (): boolean => {\n  try {\n    if (typeof window === 'undefined') {\n      return false;\n    }\n\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º localStorage\n    const hasLocalStorage = localStorage.getItem(FORM_DATA_KEY) !== null;\n    if (hasLocalStorage) {\n      return true;\n    }\n    \n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º cookies\n    if (isCookieStorageAvailable()) {\n      const hasCookies = loadFormDataFromCookies() !== null;\n      if (hasCookies) {\n        return true;\n      }\n    }\n    \n    // IndexedDB –ø—Ä–æ–≤–µ—Ä—è–µ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ (–Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç)\n    if (isIndexedDBAvailable()) {\n      loadFormDataFromIndexedDB().then(data => {\n        if (data) {\n          console.log('üìÇ –ù–∞–π–¥–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –≤ IndexedDB –¥–ª—è –±—É–¥—É—â–µ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è');\n        }\n      }).catch(() => {});\n    }\n    \n    return false;\n  } catch (error) {\n    return false;\n  }\n};\n\n/**\n * –î–µ–±–∞—É–Ω—Å —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —á–∞—Å—Ç–æ—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è\n */\nexport const createDebouncedSaver = (delay: number = 1000) => {\n  let timeoutId: NodeJS.Timeout;\n  \n  return (formData: Partial<StoredFormData>) => {\n    clearTimeout(timeoutId);\n    timeoutId = setTimeout(() => {\n      saveFormData(formData);\n    }, delay);\n  };\n};",
        "after": "'use client';\n\nimport { \n  saveFormDataToIndexedDB, \n  loadFormDataFromIndexedDB, \n  clearFormDataFromIndexedDB,\n  isIndexedDBAvailable \n} from './indexeddb-storage';\nimport { \n  saveFormDataToCookies, \n  loadFormDataFromCookies, \n  clearFormDataFromCookies,\n  isCookieStorageAvailable \n} from './cookie-storage';\n\n// –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è –∫–ª—é—á–µ–π localStorage\nconst FORM_DATA_KEY = 'deliveryFormData';\nconst FORM_VERSION = '1.2'; // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–æ–ª–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ñ–æ—Ä–º—ã + enabledCompanies\n\nexport interface StoredFormData {\n  version: string;\n  timestamp: number;\n  cargos: Array<{\n    id: string;\n    length: number;\n    width: number;\n    height: number;\n    weight: number;\n    productId?: string;\n    placeNumber?: number;\n    isFromProduct?: boolean;\n    addedAt?: number;\n  }>;\n  fromCity: string;\n  toCity: string;\n  fromAddress: string;\n  toAddress: string;\n  declaredValue: number;\n  needPackaging: boolean;\n  needLoading: boolean;\n  needCarry: boolean;\n  floor: number;\n  hasFreightLift: boolean;\n  needInsurance: boolean;\n  fromTerminal: boolean;\n  toTerminal: boolean;\n  fromAddressDelivery: boolean;\n  toAddressDelivery: boolean;\n  fromLavsiteWarehouse: boolean;\n  selectedProducts: Array<{\n    product: {\n      id: string;\n      externalCode: string;\n      name: string;\n      retailPrice: number;\n      isActive: boolean;\n      cargoPlaces: Array<{\n        placeNumber: number;\n        weight: number;\n        height: number;\n        depth: number;\n        length: number;\n      }>;\n    };\n    quantity: number;\n    totalPrice: number;\n    cargoIndexes: number[];\n    addedAt: number;\n  }>;\n  enabledCompanies?: Record<string, boolean>;\n  hiddenCompanies?: Record<string, boolean>;\n}\n\n/**\n * –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã –≤ localStorage, IndexedDB –∏ cookies (—Ç—Ä–æ–π–Ω–∞—è –∑–∞—â–∏—Ç–∞)\n * –ù–ï —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—Å—á–µ—Ç–æ–≤ - —Ç–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –≤–≤–æ–¥\n */\nexport const saveFormData = (formData: Partial<StoredFormData>): boolean => {\n  try {\n    if (typeof window === 'undefined') {\n      return false; // SSR safe\n    }\n\n    const dataToSave: StoredFormData = {\n      version: FORM_VERSION,\n      timestamp: Date.now(),\n      cargos: formData.cargos || [],\n      fromCity: formData.fromCity || '',\n      toCity: formData.toCity || '',\n      fromAddress: formData.fromAddress || '',\n      toAddress: formData.toAddress || '',\n      declaredValue: formData.declaredValue || 0,\n      needPackaging: formData.needPackaging || false,\n      needLoading: formData.needLoading || false,\n      needCarry: formData.needCarry || false,\n      floor: formData.floor || 1,\n      hasFreightLift: formData.hasFreightLift || false,\n      needInsurance: formData.needInsurance || false,\n      fromTerminal: formData.fromTerminal ?? true,\n      toTerminal: formData.toTerminal ?? true,\n      fromAddressDelivery: formData.fromAddressDelivery || false,\n      toAddressDelivery: formData.toAddressDelivery || false,\n      fromLavsiteWarehouse: formData.fromLavsiteWarehouse || false,\n      selectedProducts: formData.selectedProducts || [],\n      enabledCompanies: formData.enabledCompanies || {},\n      hiddenCompanies: formData.hiddenCompanies || {},\n    };\n\n    const serializedData = JSON.stringify(dataToSave);\n    \n    // –¢—Ä–æ–π–Ω–∞—è –∑–∞—â–∏—Ç–∞: —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage, IndexedDB –∏ cookies\n    let localStorageSuccess = false;\n    let indexedDBSuccess = false;\n    let cookieSuccess = false;\n    \n    // 1. localStorage (–æ—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥)\n    try {\n      localStorage.setItem(FORM_DATA_KEY, serializedData);\n      localStorageSuccess = true;\n      console.log('üíæ –î–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ localStorage');\n    } catch (error) {\n      console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ localStorage:', error);\n    }\n    \n    // 2. IndexedDB (–∑–∞—â–∏—Ç–∞ –æ—Ç Clear-Site-Data –¥–ª—è storage)\n    if (isIndexedDBAvailable()) {\n      saveFormDataToIndexedDB(serializedData).then(success => {\n        if (success) {\n          console.log('üíæ –î–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ IndexedDB');\n        }\n      }).catch(error => {\n        console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ IndexedDB:', error);\n      });\n    }\n    \n    // 3. Cookies (–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞)\n    if (isCookieStorageAvailable()) {\n      try {\n        cookieSuccess = saveFormDataToCookies(serializedData);\n        if (cookieSuccess) {\n          console.log('üíæ –î–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ cookies');\n        }\n      } catch (error) {\n        console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ cookies:', error);\n      }\n    }\n    \n    console.log(`üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ: localStorage=${localStorageSuccess}, IndexedDB=async, cookies=${cookieSuccess}`);\n    return localStorageSuccess; // localStorage –æ—Å—Ç–∞–µ—Ç—Å—è –æ—Å–Ω–æ–≤–Ω—ã–º –∫—Ä–∏—Ç–µ—Ä–∏–µ–º —É—Å–ø–µ—Ö–∞\n  } catch (error) {\n    console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Ñ–æ—Ä–º—ã:', error);\n    return false;\n  }\n};\n\n/**\n * –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã —Å —Ç—Ä–æ–π–Ω–æ–π –∑–∞—â–∏—Ç–æ–π (localStorage -> IndexedDB -> cookies)\n */\nexport const loadFormData = (): StoredFormData | null => {\n  try {\n    if (typeof window === 'undefined') {\n      return null; // SSR safe\n    }\n\n    let savedData = localStorage.getItem(FORM_DATA_KEY);\n    let dataSource = 'localStorage';\n    \n    // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç –≤ localStorage, –ø—Ä–æ–±—É–µ–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ –¥—Ä—É–≥–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤\n    if (!savedData) {\n      console.log('üìù –î–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ localStorage, –ø—Ä–æ–≤–µ—Ä—è–µ–º –¥—Ä—É–≥–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏...');\n      \n      // –ü—Ä–æ–±—É–µ–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ IndexedDB (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)\n      loadFormDataFromIndexedDB().then(indexedData => {\n        if (indexedData) {\n          console.log('üìÇ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –∏–∑ IndexedDB');\n          try {\n            localStorage.setItem(FORM_DATA_KEY, indexedData);\n            console.log('üíæ –î–∞–Ω–Ω—ã–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –≤ localStorage –∏–∑ IndexedDB');\n          } catch (error) {\n            console.warn('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å localStorage –∏–∑ IndexedDB:', error);\n          }\n        }\n      }).catch(error => {\n        console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑ IndexedDB:', error);\n      });\n      \n      // –ü—Ä–æ–±—É–µ–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ cookies (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)\n      const cookieData = loadFormDataFromCookies();\n      if (cookieData) {\n        savedData = cookieData;\n        dataSource = 'cookies';\n        console.log('üìÇ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –∏–∑ cookies');\n        try {\n          localStorage.setItem(FORM_DATA_KEY, cookieData);\n          console.log('üíæ –î–∞–Ω–Ω—ã–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –≤ localStorage –∏–∑ cookies');\n        } catch (error) {\n          console.warn('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å localStorage –∏–∑ cookies:', error);\n        }\n      }\n    }\n    \n    if (!savedData) {\n      console.log('üìù –°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –Ω–∏ –≤ –æ–¥–Ω–æ–º –∏—Å—Ç–æ—á–Ω–∏–∫–µ');\n      return null;\n    }\n\n    const parsedData = JSON.parse(savedData) as StoredFormData;\n    \n    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–∏ –¥–∞–Ω–Ω—ã—Ö\n    if (parsedData.version !== FORM_VERSION) {\n      console.warn('‚ö†Ô∏è –í–µ—Ä—Å–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç, –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –º–∏–≥—Ä–∞—Ü–∏—è...');\n      // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã\n      return migrateFormData(parsedData);\n    }\n\n    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ä–æ–∫–∞ –¥–∞–≤–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ - —É–¥–∞–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π)\n    const thirtyDaysInMs = 30 * 24 * 60 * 60 * 1000;\n    if (Date.now() - parsedData.timestamp > thirtyDaysInMs) {\n      console.log('üóëÔ∏è –°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–ª–∏—à–∫–æ–º —Å—Ç–∞—Ä—ã–µ, —É–¥–∞–ª—è–µ–º...');\n      clearFormData();\n      return null;\n    }\n\n    console.log(`üìÇ –î–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ ${dataSource}:`, parsedData);\n    return parsedData;\n  } catch (error) {\n    console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Ñ–æ—Ä–º—ã:', error);\n    return null;\n  }\n};\n\n/**\n * –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –≤–µ—Ä—Å–∏–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã\n */\nconst migrateFormData = (oldData: any): StoredFormData | null => {\n  try {\n    // –ë–∞–∑–æ–≤–∞—è –º–∏–≥—Ä–∞—Ü–∏—è - –ø—Ä–∏–≤–æ–¥–∏–º –∫ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ\n    const migratedData: StoredFormData = {\n      version: FORM_VERSION,\n      timestamp: Date.now(),\n      cargos: oldData.cargos || [{ id: '1', length: 0, width: 0, height: 0, weight: 0 }],\n      fromCity: oldData.fromCity || '',\n      toCity: oldData.toCity || '',\n      fromAddress: oldData.fromAddress || '',\n      toAddress: oldData.toAddress || '',\n      declaredValue: oldData.declaredValue || 0,\n      needPackaging: oldData.needPackaging || false,\n      needLoading: oldData.needLoading || false,\n      needCarry: oldData.needCarry || false,\n      floor: oldData.floor || 1,\n      hasFreightLift: oldData.hasFreightLift || false,\n      needInsurance: oldData.needInsurance || false,\n      fromTerminal: oldData.fromTerminal ?? true,\n      toTerminal: oldData.toTerminal ?? true,\n      fromAddressDelivery: oldData.fromAddressDelivery || false,\n      toAddressDelivery: oldData.toAddressDelivery || false,\n      fromLavsiteWarehouse: oldData.fromLavsiteWarehouse || false,\n      selectedProducts: oldData.selectedProducts || [],\n      enabledCompanies: oldData.enabledCompanies || {},\n      hiddenCompanies: oldData.hiddenCompanies || {},\n    };\n\n    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ\n    localStorage.setItem(FORM_DATA_KEY, JSON.stringify(migratedData));\n    console.log('‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã');\n    return migratedData;\n  } catch (error) {\n    console.error('‚ùå –û—à–∏–±–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö:', error);\n    return null;\n  }\n};\n\n/**\n * –û—á–∏—â–∞–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã –∏–∑ –≤—Å–µ—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ (localStorage, IndexedDB, cookies)\n */\nexport const clearFormData = (): boolean => {\n  try {\n    if (typeof window === 'undefined') {\n      return false;\n    }\n\n    let localStorageSuccess = false;\n    let indexedDBSuccess = false;\n    let cookieSuccess = false;\n    \n    // –û—á–∏—â–∞–µ–º localStorage\n    try {\n      localStorage.removeItem(FORM_DATA_KEY);\n      localStorageSuccess = true;\n      console.log('üóëÔ∏è –î–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã —É–¥–∞–ª–µ–Ω—ã –∏–∑ localStorage');\n    } catch (error) {\n      console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∏–∑ localStorage:', error);\n    }\n    \n    // –û—á–∏—â–∞–µ–º IndexedDB\n    if (isIndexedDBAvailable()) {\n      clearFormDataFromIndexedDB().then(success => {\n        if (success) {\n          console.log('üóëÔ∏è –î–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã —É–¥–∞–ª–µ–Ω—ã –∏–∑ IndexedDB');\n        }\n      }).catch(error => {\n        console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∏–∑ IndexedDB:', error);\n      });\n    }\n    \n    // –û—á–∏—â–∞–µ–º cookies\n    if (isCookieStorageAvailable()) {\n      try {\n        cookieSuccess = clearFormDataFromCookies();\n        if (cookieSuccess) {\n          console.log('üóëÔ∏è –î–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã —É–¥–∞–ª–µ–Ω—ã –∏–∑ cookies');\n        }\n      } catch (error) {\n        console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∏–∑ cookies:', error);\n      }\n    }\n    \n    console.log(`üóëÔ∏è –£–¥–∞–ª–µ–Ω–∏–µ: localStorage=${localStorageSuccess}, IndexedDB=async, cookies=${cookieSuccess}`);\n    return localStorageSuccess;\n  } catch (error) {\n    console.error('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Ñ–æ—Ä–º—ã:', error);\n    return false;\n  }\n};\n\n/**\n * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –µ—Å—Ç—å –ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –ª—é–±–æ–º –∏–∑ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤\n */\nexport const hasStoredFormData = (): boolean => {\n  try {\n    if (typeof window === 'undefined') {\n      return false;\n    }\n\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º localStorage\n    const hasLocalStorage = localStorage.getItem(FORM_DATA_KEY) !== null;\n    if (hasLocalStorage) {\n      return true;\n    }\n    \n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º cookies\n    if (isCookieStorageAvailable()) {\n      const hasCookies = loadFormDataFromCookies() !== null;\n      if (hasCookies) {\n        return true;\n      }\n    }\n    \n    // IndexedDB –ø—Ä–æ–≤–µ—Ä—è–µ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ (–Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç)\n    if (isIndexedDBAvailable()) {\n      loadFormDataFromIndexedDB().then(data => {\n        if (data) {\n          console.log('üìÇ –ù–∞–π–¥–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –≤ IndexedDB –¥–ª—è –±—É–¥—É—â–µ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è');\n        }\n      }).catch(() => {});\n    }\n    \n    return false;\n  } catch (error) {\n    return false;\n  }\n};\n\n/**\n * –î–µ–±–∞—É–Ω—Å —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —á–∞—Å—Ç–æ—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è\n */\nexport const createDebouncedSaver = (delay: number = 1000) => {\n  let timeoutId: NodeJS.Timeout;\n  \n  return (formData: Partial<StoredFormData>) => {\n    clearTimeout(timeoutId);\n    timeoutId = setTimeout(() => {\n      saveFormData(formData);\n    }, delay);\n  };\n};",
        "additions": 1,
        "deletions": 0
      }
    },
    "time": {
      "start": 1764767500803,
      "end": 1764767500809
    }
  }
}