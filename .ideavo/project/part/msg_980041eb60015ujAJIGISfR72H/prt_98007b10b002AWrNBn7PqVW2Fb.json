{
  "id": "prt_98007b10b002AWrNBn7PqVW2Fb",
  "messageID": "msg_980041eb60015ujAJIGISfR72H",
  "sessionID": "ses_6852784ecffeuHwynj83p2lr14",
  "type": "tool",
  "tool": "edit",
  "callID": "toolu_01LNczbDdGFBTFvnrwqyUBC5",
  "state": {
    "status": "completed",
    "input": {
      "filePath": "/home/user/project/app/page.tsx",
      "oldString": "      if (!fromCityId || !toCityId) {\n        return {\n          company: 'ПЭК',\n          price: 0,\n          days: 0,\n          error: `Город не найден в базе ПЭК. Проверьте: ${!fromCityId ? form.fromCity : ''} ${!toCityId ? form.toCity : ''}`.trim(),\n          apiUrl\n        };\n      }\n\n      // Формируем грузы согласно API документации\n      const cargos = form.cargos.map(cargo => ({\n        width: cargo.width / 100, // переводим в метры\n        length: cargo.length / 100,\n        height: cargo.height / 100,\n        volume: (cargo.width * cargo.length * cargo.height) / 1000000, // объем в м3\n        weight: cargo.weight,\n        isOversized: (cargo.width > 240 || cargo.length > 1200 || cargo.height > 270 || cargo.weight > 1500) ? 1 : 0\n      }));\n\n      // Формируем запрос согласно официальной документации API\n      const requestData = {\n        senderCityId: fromCityId,\n        receiverCityId: toCityId,\n        places: cargos,\n        isPickup: form.fromAddressDelivery ? 1 : 0,\n        isDelivery: form.toAddressDelivery ? 1 : 0,\n        pickupOptions: {\n          hasHydroBoardLoading: form.needLoading ? 1 : 0,\n          hasManipulatorLoading: 0\n        },\n        deliveryOptions: {\n          hasHydroBoardLoading: form.needLoading ? 1 : 0,\n          hasManipulatorLoading: 0\n        },\n        ...(form.needInsurance && form.declaredValue > 0 ? {\n          insuranceValue: form.declaredValue\n        } : {}),\n        packageType: form.needPackaging ? 'soft' : null\n      };\n\n      console.log('ПЭК запрос:', requestData);\n\n      const response = await fetch(apiUrl, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': 'Bearer C04C5BF2AE367BDCBDC71E7DA520A69B167D1984'\n        },\n        body: JSON.stringify(requestData)\n      });\n\n      const data = await response.json();\n      console.log('ПЭК ответ:', data);",
      "newString": "      if (!fromCityId || !toCityId) {\n        return {\n          company: 'ПЭК',\n          price: 0,\n          days: 0,\n          error: `Город не найден в базе ПЭК. Проверьте: ${!fromCityId ? form.fromCity : ''} ${!toCityId ? form.toCity : ''}`.trim(),\n          apiUrl,\n          requestData: { fromCity: form.fromCity, toCity: form.toCity, fromCityId, toCityId },\n          responseData: null\n        };\n      }\n\n      // Формируем параметры запроса согласно публичной документации\n      const params = new URLSearchParams();\n      \n      // Добавляем грузы согласно формату: Ширина (м), Длина (м), Высота (м), Объем (м3), Вес (кг), Негабарит (0/1), ЗТУ (0/1)\n      form.cargos.forEach((cargo, index) => {\n        const width = cargo.width / 100; // переводим см в метры\n        const length = cargo.length / 100;\n        const height = cargo.height / 100;\n        const volume = width * length * height;\n        const weight = cargo.weight;\n        const isOversized = (width > 2.4 || length > 12 || height > 2.7 || weight > 1500) ? 1 : 0;\n        const needZTU = form.needPackaging ? 1 : 0;\n        \n        params.append(`places[${index}][]`, width.toString());\n        params.append(`places[${index}][]`, length.toString());\n        params.append(`places[${index}][]`, height.toString());\n        params.append(`places[${index}][]`, volume.toString());\n        params.append(`places[${index}][]`, weight.toString());\n        params.append(`places[${index}][]`, isOversized.toString());\n        params.append(`places[${index}][]`, needZTU.toString());\n      });\n      \n      // Параметры забора\n      params.append('take[town]', fromCityId.toString());\n      params.append('take[tent]', '0'); // растентровка\n      params.append('take[gidro]', form.needLoading ? '1' : '0'); // гидролифт\n      params.append('take[manip]', '0'); // манипулятор\n      params.append('take[speed]', '0'); // срочный забор\n      params.append('take[moscow]', '0'); // ограничения по Москве\n      \n      // Параметры доставки\n      params.append('deliver[town]', toCityId.toString());\n      params.append('deliver[tent]', '0');\n      params.append('deliver[gidro]', form.needLoading ? '1' : '0');\n      params.append('deliver[manip]', '0');\n      params.append('deliver[speed]', '0');\n      params.append('deliver[moscow]', '0');\n      \n      // Дополнительные услуги\n      params.append('plombir', '0'); // пломбы\n      params.append('strah', form.needInsurance ? form.declaredValue.toString() : '0'); // страховка\n      params.append('ashan', '0'); // доставка в Ашан\n      params.append('night', '0'); // ночное время\n      params.append('pal', '0'); // запаллечивание\n      params.append('pallets', '0'); // паллетная перевозка\n\n      const fullUrl = `${apiUrl}?${params.toString()}`;\n      const requestData = Object.fromEntries(params);\n\n      console.log('ПЭК запрос URL:', fullUrl);\n      console.log('ПЭК параметры:', requestData);\n\n      // Прямой запрос к API (без прокси, так как HTTPS сайт может делать HTTP запросы)\n      const response = await fetch(fullUrl);\n      const data = await response.json();\n      \n      console.log('ПЭК ответ:', data);"
    },
    "output": "",
    "metadata": {
      "diagnostics": {},
      "diff": "Index: /home/user/project/app/page.tsx\n===================================================================\n--- /home/user/project/app/page.tsx\n+++ /home/user/project/app/page.tsx\n@@ -586,55 +586,70 @@\n     company: 'ПЭК',\n     price: 0,\n     days: 0,\n     error: `Город не найден в базе ПЭК. Проверьте: ${!fromCityId ? form.fromCity : ''} ${!toCityId ? form.toCity : ''}`.trim(),\n-    apiUrl\n+    apiUrl,\n+    requestData: { fromCity: form.fromCity, toCity: form.toCity, fromCityId, toCityId },\n+    responseData: null\n   };\n }\n \n-// Формируем грузы согласно API документации\n-const cargos = form.cargos.map(cargo => ({\n-  width: cargo.width / 100, // переводим в метры\n-  length: cargo.length / 100,\n-  height: cargo.height / 100,\n-  volume: (cargo.width * cargo.length * cargo.height) / 1000000, // объем в м3\n-  weight: cargo.weight,\n-  isOversized: (cargo.width > 240 || cargo.length > 1200 || cargo.height > 270 || cargo.weight > 1500) ? 1 : 0\n-}));\n+// Формируем параметры запроса согласно публичной документации\n+const params = new URLSearchParams();\n+\n+// Добавляем грузы согласно формату: Ширина (м), Длина (м), Высота (м), Объем (м3), Вес (кг), Негабарит (0/1), ЗТУ (0/1)\n+form.cargos.forEach((cargo, index) => {\n+  const width = cargo.width / 100; // переводим см в метры\n+  const length = cargo.length / 100;\n+  const height = cargo.height / 100;\n+  const volume = width * length * height;\n+  const weight = cargo.weight;\n+  const isOversized = (width > 2.4 || length > 12 || height > 2.7 || weight > 1500) ? 1 : 0;\n+  const needZTU = form.needPackaging ? 1 : 0;\n+  \n+  params.append(`places[${index}][]`, width.toString());\n+  params.append(`places[${index}][]`, length.toString());\n+  params.append(`places[${index}][]`, height.toString());\n+  params.append(`places[${index}][]`, volume.toString());\n+  params.append(`places[${index}][]`, weight.toString());\n+  params.append(`places[${index}][]`, isOversized.toString());\n+  params.append(`places[${index}][]`, needZTU.toString());\n+});\n+\n+// Параметры забора\n+params.append('take[town]', fromCityId.toString());\n+params.append('take[tent]', '0'); // растентровка\n+params.append('take[gidro]', form.needLoading ? '1' : '0'); // гидролифт\n+params.append('take[manip]', '0'); // манипулятор\n+params.append('take[speed]', '0'); // срочный забор\n+params.append('take[moscow]', '0'); // ограничения по Москве\n+\n+// Параметры доставки\n+params.append('deliver[town]', toCityId.toString());\n+params.append('deliver[tent]', '0');\n+params.append('deliver[gidro]', form.needLoading ? '1' : '0');\n+params.append('deliver[manip]', '0');\n+params.append('deliver[speed]', '0');\n+params.append('deliver[moscow]', '0');\n+\n+// Дополнительные услуги\n+params.append('plombir', '0'); // пломбы\n+params.append('strah', form.needInsurance ? form.declaredValue.toString() : '0'); // страховка\n+params.append('ashan', '0'); // доставка в Ашан\n+params.append('night', '0'); // ночное время\n+params.append('pal', '0'); // запаллечивание\n+params.append('pallets', '0'); // паллетная перевозка\n \n-// Формируем запрос согласно официальной документации API\n-const requestData = {\n-  senderCityId: fromCityId,\n-  receiverCityId: toCityId,\n-  places: cargos,\n-  isPickup: form.fromAddressDelivery ? 1 : 0,\n-  isDelivery: form.toAddressDelivery ? 1 : 0,\n-  pickupOptions: {\n-    hasHydroBoardLoading: form.needLoading ? 1 : 0,\n-    hasManipulatorLoading: 0\n-  },\n-  deliveryOptions: {\n-    hasHydroBoardLoading: form.needLoading ? 1 : 0,\n-    hasManipulatorLoading: 0\n-  },\n-  ...(form.needInsurance && form.declaredValue > 0 ? {\n-    insuranceValue: form.declaredValue\n-  } : {}),\n-  packageType: form.needPackaging ? 'soft' : null\n-};\n+const fullUrl = `${apiUrl}?${params.toString()}`;\n+const requestData = Object.fromEntries(params);\n \n-console.log('ПЭК запрос:', requestData);\n+console.log('ПЭК запрос URL:', fullUrl);\n+console.log('ПЭК параметры:', requestData);\n \n-const response = await fetch(apiUrl, {\n-  method: 'POST',\n-  headers: {\n-    'Content-Type': 'application/json',\n-    'Authorization': 'Bearer C04C5BF2AE367BDCBDC71E7DA520A69B167D1984'\n-  },\n-  body: JSON.stringify(requestData)\n-});\n-\n+// Прямой запрос к API (без прокси, так как HTTPS сайт может делать HTTP запросы)\n+const response = await fetch(fullUrl);\n const data = await response.json();\n+\n console.log('ПЭК ответ:', data);\n \n if (response.ok && data.success) {\n   let totalPrice = 0;\n"
    },
    "title": "app/page.tsx",
    "time": {
      "start": 1758789632862,
      "end": 1758789632881
    }
  }
}