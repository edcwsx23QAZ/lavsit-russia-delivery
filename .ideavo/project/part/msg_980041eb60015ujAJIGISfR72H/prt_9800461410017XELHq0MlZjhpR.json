{
  "id": "prt_9800461410017XELHq0MlZjhpR",
  "messageID": "msg_980041eb60015ujAJIGISfR72H",
  "sessionID": "ses_6852784ecffeuHwynj83p2lr14",
  "type": "tool",
  "tool": "multiedit",
  "callID": "toolu_01VDR1fp2buedSJoQUwLgDLN",
  "state": {
    "status": "error",
    "input": {
      "filePath": "/home/user/project/app/page.tsx",
      "edits": [
        {
          "oldString": "  // Получение ID города ПЭК с локальной базой городов (без внешних API)\n  const findPekCityId = async (cityName: string): Promise<string | null> => {\n    // Расширенная база городов ПЭК с реальными ID\n    const pekCities: { [key: string]: string } = {\n      // Основные города\n      'москва': '2974',\n      'санкт-петербург': '2975', \n      'спб': '2975',\n      'петербург': '2975',\n      'екатеринбург': '2976',\n      'новосибирск': '2977',\n      'нижний новгород': '2978',\n      'самара': '2979',\n      'омск': '2980',\n      'казань': '2981',\n      'ростов-на-дону': '2982',\n      'ростов': '2982',\n      'челябинск': '2983',\n      'уфа': '2984',\n      'волгоград': '2985',\n      \n      // Дополнительные города\n      'краснодар': '2986',\n      'воронеж': '2987',\n      'пермь': '2988',\n      'саратов': '2990',\n      'тольятти': '2991',\n      'красноярск': '2992',\n      'ижевск': '2993',\n      'барнаул': '2994',\n      'ульяновск': '2995',\n      'иркутск': '2996',\n      'хабаровск': '2997',\n      'владивосток': '2998',\n      'ярославль': '2999',\n      'тюмень': '3000',\n      'оренбург': '3002',\n      'новокузнецк': '3003',\n      'кемерово': '3004',\n      'рязань': '3005',\n      'томск': '3006',\n      'астрахань': '3007',\n      'пенза': '3008',\n      'липецк': '3009',\n      'тула': '3010',\n      'киров': '3011',\n      'чебоксары': '3012',\n      'калининград': '3013',\n      'курск': '3014',\n      'тверь': '3016',\n      'брянск': '3017',\n      'иваново': '3018',\n      'белгород': '3019',\n      'сочи': '3020',\n      'архангельск': '3022',\n      'калуга': '3025',\n      'владимир': '3026',\n      'мурманск': '3027',\n      'тамбов': '3030',\n      'орел': '3035',\n      'кострома': '3033'\n    };\n\n    try {\n      const normalizedSearchCity = cityName.toLowerCase().trim()\n        .replace(/ё/g, 'е')\n        .replace(/[\\s\\-\\.г\\.]+/g, '')\n        .replace(/область|обл|край|республика|респ|автономный округ|ао/g, '');\n\n      console.log(`Поиск города ПЭК: \"${cityName}\" -> \"${normalizedSearchCity}\"`);\n\n      // Прямое совпадение\n      if (pekCities[normalizedSearchCity]) {\n        console.log(`Найден прямой ID для \"${normalizedSearchCity}\": ${pekCities[normalizedSearchCity]}`);\n        return pekCities[normalizedSearchCity];\n      }\n\n      // Поиск по частичному совпадению\n      for (const [cityKey, cityId] of Object.entries(pekCities)) {\n        const normalizedCityKey = cityKey.replace(/[\\s\\-\\.г\\.]+/g, '');\n        \n        if (normalizedSearchCity.includes(normalizedCityKey) || \n            normalizedCityKey.includes(normalizedSearchCity)) {\n          console.log(`Найден частичный ID для \"${normalizedSearchCity}\" через \"${cityKey}\": ${cityId}`);\n          return cityId;\n        }\n      }\n\n      console.log(`Город ПЭК \"${cityName}\" не найден в базе`);\n      return null;\n    } catch (error) {\n      console.error('Ошибка поиска города ПЭК:', error);\n      \n      // Последняя попытка для основных городов\n      const normalizedCity = cityName.toLowerCase().trim();\n      \n      if (normalizedCity.includes('москва') || normalizedCity.includes('moscow')) {\n        return '2974';\n      }\n      if (normalizedCity.includes('петербург') || normalizedCity.includes('спб')) {\n        return '2975';\n      }\n      if (normalizedCity.includes('екатеринбург')) {\n        return '2976';\n      }\n      \n      return null;\n    }\n  };",
          "newString": "  // Загрузка городов ПЭК с публичного API\n  const loadPekCities = async (): Promise<{ [key: string]: string }> => {\n    try {\n      const response = await fetch('https://pecom.ru/ru/calc/towns.php');\n      const data = await response.json();\n      \n      const cities: { [key: string]: string } = {};\n      \n      // Парсим структуру: {'регион1': {id1: 'Город1', id2: 'Город2'}, ...}\n      Object.values(data).forEach((region: any) => {\n        if (typeof region === 'object') {\n          Object.entries(region).forEach(([cityId, cityName]) => {\n            if (typeof cityName === 'string') {\n              const normalizedName = cityName.toLowerCase()\n                .replace(/ё/g, 'е')\n                .replace(/[\\s\\-\\.г\\.]+/g, '')\n                .replace(/область|обл|край|республика|респ|автономный округ|ао/g, '');\n              cities[normalizedName] = cityId;\n            }\n          });\n        }\n      });\n      \n      return cities;\n    } catch (error) {\n      console.warn('Не удалось загрузить города ПЭК с API, используем локальную базу:', error);\n      \n      // Фоллбэк - локальная база городов\n      return {\n        'москва': '-457',\n        'санкт-петербург': '64883', \n        'спб': '64883',\n        'петербург': '64883',\n        'екатеринбург': '65479',\n        'новосибирск': '65951',\n        'нижний новгород': '65806',\n        'самара': '66358',\n        'омск': '66044',\n        'казань': '65652',\n        'ростов-на-дону': '66302',\n        'ростов': '66302',\n        'челябинск': '66821',\n        'уфа': '66695',\n        'волгоград': '65341',\n        'краснодар': '65704',\n        'воронеж': '65369',\n        'пермь': '66159',\n        'саратов': '66372',\n        'тольятти': '66601',\n        'красноярск': '65724',\n        'ижевск': '65613',\n        'барнаул': '65169',\n        'ульяновск': '66661',\n        'иркутск': '65625',\n        'хабаровск': '66756',\n        'владивосток': '65313',\n        'ярославль': '66937',\n        'тюмень': '66651',\n        'калининград': '65640',\n        'кострома': '65697'\n      };\n    }\n  };\n\n  // Получение ID города ПЭК\n  const findPekCityId = async (cityName: string): Promise<string | null> => {\n    try {\n      const pekCities = await loadPekCities();\n      \n      const normalizedSearchCity = cityName.toLowerCase().trim()\n        .replace(/ё/g, 'е')\n        .replace(/[\\s\\-\\.г\\.]+/g, '')\n        .replace(/область|обл|край|республика|респ|автономный округ|ао/g, '');\n\n      console.log(`Поиск города ПЭК: \"${cityName}\" -> \"${normalizedSearchCity}\"`);\n\n      // Прямое совпадение\n      if (pekCities[normalizedSearchCity]) {\n        console.log(`Найден прямой ID для \"${normalizedSearchCity}\": ${pekCities[normalizedSearchCity]}`);\n        return pekCities[normalizedSearchCity];\n      }\n\n      // Поиск по частичному совпадению\n      for (const [cityKey, cityId] of Object.entries(pekCities)) {\n        if (normalizedSearchCity.includes(cityKey) || \n            cityKey.includes(normalizedSearchCity)) {\n          console.log(`Найден частичный ID для \"${normalizedSearchCity}\" через \"${cityKey}\": ${cityId}`);\n          return cityId;\n        }\n      }\n\n      console.log(`Город ПЭК \"${cityName}\" не найден в базе`);\n      return null;\n    } catch (error) {\n      console.error('Ошибка поиска города ПЭК:', error);\n      return null;\n    }\n  };"
        },
        {
          "oldString": "  // Получение sessionID для Деловых Линий\n  const getDellinSessionId = async (): Promise<string | null> => {\n    try {\n      const authResponse = await fetch('https://api.dellin.ru/v3/auth/login.json', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json'\n        },\n        body: JSON.stringify({\n          appkey: 'E6C50E91-8E93-440F-9CC6-DEF9F0D68F1B',\n          login: 'service@lavsit.ru',\n          password: 'edcwsx123QAZ'\n        })\n      });\n\n      if (authResponse.ok) {\n        const authData = await authResponse.json();\n        return authData.data?.sessionID || null;\n      }\n    } catch (error) {\n      console.error('Ошибка авторизации Деловые Линии:', error);\n    }\n    return null;\n  };",
          "newString": "  // Получение sessionID для Деловых Линий\n  const getDellinSessionId = async (): Promise<string | null> => {\n    try {\n      const authResponse = await fetch('https://api.dellin.ru/v3/auth/login.json', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json'\n        },\n        body: JSON.stringify({\n          appkey: 'E6C50E91-8E93-440F-9CC6-DEF9F0D68F1B',\n          login: 'service@lavsit.ru',\n          password: 'edcwsx123QAZ'\n        })\n      });\n\n      const authData = await authResponse.json();\n      console.log('Деловые Линии авторизация:', authData);\n      \n      if (authResponse.ok && authData.data?.sessionID) {\n        return authData.data.sessionID;\n      } else {\n        console.error('Ошибка авторизации Деловые Линии:', authData);\n        return null;\n      }\n    } catch (error) {\n      console.error('Ошибка соединения с авторизацией Деловые Линии:', error);\n    }\n    return null;\n  };"
        },
        {
          "oldString": "  // Расчет для Деловых Линий по новой документации\n  const calculateDellin = async (): Promise<CalculationResult> => {\n    const apiUrl = 'https://api.dellin.ru/v2/calculator';\n    \n    try {\n      const sessionID = await getDellinSessionId();\n      \n      if (!sessionID) {\n        return {\n          company: 'Деловые Линии',\n          price: 0,\n          days: 0,\n          error: 'Не удалось получить sessionID',\n          apiUrl\n        };\n      }\n\n      const totalWeight = form.cargos.reduce((sum, cargo) => sum + cargo.weight, 0);\n      const totalVolume = form.cargos.reduce((sum, cargo) => \n        sum + (cargo.length * cargo.width * cargo.height) / 1000000, 0\n      );\n\n      // Правильная структура запроса согласно документации\n      const requestData = {\n        appkey: 'E6C50E91-8E93-440F-9CC6-DEF9F0D68F1B',\n        sessionID: sessionID,\n        delivery: {\n          deliveryType: {\n            type: 'auto'\n          },\n          derival: {\n            variant: form.fromAddressDelivery ? 'address' : 'terminal',\n            address: {\n              search: form.fromAddressDelivery ? (form.fromAddress || form.fromCity) : form.fromCity\n            }\n          },\n          arrival: {\n            variant: form.toAddressDelivery ? 'address' : 'terminal', \n            address: {\n              search: form.toAddressDelivery ? (form.toAddress || form.toCity) : form.toCity\n            }\n          }\n        },\n        cargo: {\n          quantity: form.cargos.length,\n          weight: totalWeight,\n          totalVolume: totalVolume,\n          totalWeight: totalWeight,\n          oversizedWeight: 0,\n          oversizedVolume: 0,\n          ...(form.needInsurance && form.declaredValue > 0 ? {\n            insurance: {\n              statedValue: form.declaredValue,\n              term: false\n            }\n          } : {})\n        },\n        ...(form.needPackaging ? {\n          packages: [{\n            uid: 'bag'\n          }]\n        } : {})\n      };\n\n      const response = await fetch(apiUrl, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Accept': 'application/json'\n        },\n        body: JSON.stringify(requestData)\n      });\n\n      const data = await response.json();\n\n      if (response.ok && data.data && data.metadata?.status === 200) {\n        let totalPrice = data.data.price || 0;\n        \n        // Добавляем страховку если есть\n        if (data.data.insurance) {\n          totalPrice += data.data.insurance;\n        }\n        \n        // Добавляем услуги упаковки если есть\n        if (data.data.packages && form.needPackaging) {\n          Object.values(data.data.packages).forEach((pkg: any) => {\n            if (pkg.price) totalPrice += pkg.price;\n          });\n        }\n\n        return {\n          company: 'Деловые Линии',\n          price: Math.round(totalPrice),\n          days: data.data.deliveryTerm || 0,\n          details: data.data,\n          requestData,\n          responseData: data,\n          apiUrl,\n          sessionId: sessionID\n        };\n      } else {\n        const errorMessage = data.metadata?.detail || \n                           data.metadata?.message || \n                           data.errors?.[0]?.detail || \n                           (data.metadata?.status !== 200 ? `HTTP ${data.metadata?.status}` : '') ||\n                           'Ошибка расчета Деловые Линии';\n        return {\n          company: 'Деловые Линии',\n          price: 0,\n          days: 0,\n          error: errorMessage,\n          requestData,\n          responseData: data,\n          apiUrl,\n          sessionId: sessionID\n        };\n      }\n    } catch (error: any) {\n      return {\n        company: 'Деловые Линии',\n        price: 0,\n        days: 0,\n        error: `Ошибка соединения: ${error.message}`,\n        requestData: null,\n        responseData: null,\n        apiUrl\n      };\n    }\n  };",
          "newString": "  // Расчет для Деловых Линий через правильный API v2/calculator.json\n  const calculateDellin = async (): Promise<CalculationResult> => {\n    const apiUrl = 'https://api.dellin.ru/v2/calculator.json';\n    \n    try {\n      const sessionID = await getDellinSessionId();\n      \n      if (!sessionID) {\n        return {\n          company: 'Деловые Линии',\n          price: 0,\n          days: 0,\n          error: 'Не удалось получить sessionID',\n          apiUrl,\n          requestData: null,\n          responseData: null\n        };\n      }\n\n      const totalWeight = form.cargos.reduce((sum, cargo) => sum + cargo.weight, 0);\n      const totalVolume = form.cargos.reduce((sum, cargo) => \n        sum + (cargo.length * cargo.width * cargo.height) / 1000000, 0\n      );\n\n      // Структура запроса согласно документации v2/calculator.json\n      const requestData = {\n        appkey: 'E6C50E91-8E93-440F-9CC6-DEF9F0D68F1B',\n        sessionID: sessionID,\n        delivery: {\n          deliveryType: {\n            type: 'auto' // express, auto, letter\n          },\n          derival: {\n            variant: form.fromAddressDelivery ? 'address' : 'terminal',\n            address: {\n              search: form.fromAddressDelivery ? (form.fromAddress || form.fromCity) : form.fromCity\n            },\n            ...(form.fromAddressDelivery && form.needCarry ? {\n              handling: {\n                freightLift: form.hasFreightLift,\n                toFloor: form.floor,\n                carry: 50\n              }\n            } : {})\n          },\n          arrival: {\n            variant: form.toAddressDelivery ? 'address' : 'terminal',\n            address: {\n              search: form.toAddressDelivery ? (form.toAddress || form.toCity) : form.toCity\n            },\n            ...(form.toAddressDelivery && form.needCarry ? {\n              handling: {\n                freightLift: form.hasFreightLift,\n                toFloor: form.floor,\n                carry: 50\n              }\n            } : {})\n          },\n          ...(form.needPackaging ? {\n            packages: [{\n              uid: 'bag'\n            }]\n          } : {})\n        },\n        cargo: {\n          quantity: form.cargos.length,\n          length: Math.max(...form.cargos.map(c => c.length)) / 100, // в метрах\n          width: Math.max(...form.cargos.map(c => c.width)) / 100,\n          height: Math.max(...form.cargos.map(c => c.height)) / 100,\n          weight: totalWeight,\n          totalVolume: totalVolume,\n          totalWeight: totalWeight,\n          oversizedWeight: 0,\n          oversizedVolume: 0,\n          ...(form.needInsurance && form.declaredValue > 0 ? {\n            insurance: {\n              statedValue: form.declaredValue,\n              term: false\n            }\n          } : {})\n        },\n        payment: {\n          type: 'cash'\n        }\n      };\n\n      console.log('Деловые Линии запрос:', requestData);\n\n      const response = await fetch(apiUrl, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Accept': 'application/json'\n        },\n        body: JSON.stringify(requestData)\n      });\n\n      const data = await response.json();\n      console.log('Деловые Линии ответ:', data);\n\n      if (response.ok && data.data && data.metadata?.status === 200) {\n        let totalPrice = data.data.price || 0;\n        \n        // Добавляем страховку если есть\n        if (data.data.insurance) {\n          totalPrice += data.data.insurance;\n        }\n        \n        // Добавляем услуги упаковки если есть\n        if (data.data.packages && form.needPackaging) {\n          Object.values(data.data.packages).forEach((pkg: any) => {\n            if (pkg.price) totalPrice += pkg.price;\n          });\n        }\n\n        return {\n          company: 'Деловые Линии',\n          price: Math.round(totalPrice),\n          days: data.data.deliveryTerm || 0,\n          details: data.data,\n          requestData,\n          responseData: data,\n          apiUrl,\n          sessionId: sessionID\n        };\n      } else {\n        const errorMessage = data.metadata?.detail || \n                           data.metadata?.message || \n                           data.errors?.[0]?.detail ||\n                           data.errors?.[0]?.message ||\n                           (data.metadata?.status !== 200 ? `HTTP ${data.metadata?.status}` : '') ||\n                           'Ошибка расчета Деловые Линии';\n        return {\n          company: 'Деловые Линии',\n          price: 0,\n          days: 0,\n          error: errorMessage,\n          requestData,\n          responseData: data,\n          apiUrl,\n          sessionId: sessionID\n        };\n      }\n    } catch (error: any) {\n      return {\n        company: 'Деловые Линии',\n        price: 0,\n        days: 0,\n        error: `Ошибка соединения: ${error.message}`,\n        requestData: null,\n        responseData: null,\n        apiUrl\n      };\n    }\n  };"
        },
        {
          "oldString": "  // Расчет для ПЭК через официальный REST API\n  const calculatePEK = async (): Promise<CalculationResult> => {\n    const apiUrl = 'https://api.pecom.ru/v1/calculator/calculate';\n    \n    try {\n      // Получаем ID городов\n      const fromCityId = await findPekCityId(form.fromCity);\n      const toCityId = await findPekCityId(form.toCity);\n      \n      if (!fromCityId || !toCityId) {\n        return {\n          company: 'ПЭК',\n          price: 0,\n          days: 0,\n          error: `Город не найден в базе ПЭК. Проверьте: ${!fromCityId ? form.fromCity : ''} ${!toCityId ? form.toCity : ''}`.trim(),\n          apiUrl\n        };\n      }\n\n      // Формируем грузы согласно API документации\n      const cargos = form.cargos.map(cargo => ({\n        width: cargo.width / 100, // переводим в метры\n        length: cargo.length / 100,\n        height: cargo.height / 100,\n        volume: (cargo.width * cargo.length * cargo.height) / 1000000, // объем в м3\n        weight: cargo.weight,\n        isOversized: (cargo.width > 240 || cargo.length > 1200 || cargo.height > 270 || cargo.weight > 1500) ? 1 : 0\n      }));\n\n      // Формируем запрос согласно официальной документации API\n      const requestData = {\n        senderCityId: fromCityId,\n        receiverCityId: toCityId,\n        places: cargos,\n        isPickup: form.fromAddressDelivery ? 1 : 0,\n        isDelivery: form.toAddressDelivery ? 1 : 0,\n        pickupOptions: {\n          hasHydroBoardLoading: form.needLoading ? 1 : 0,\n          hasManipulatorLoading: 0\n        },\n        deliveryOptions: {\n          hasHydroBoardLoading: form.needLoading ? 1 : 0,\n          hasManipulatorLoading: 0\n        },\n        ...(form.needInsurance && form.declaredValue > 0 ? {\n          insuranceValue: form.declaredValue\n        } : {}),\n        packageType: form.needPackaging ? 'soft' : null\n      };\n\n      console.log('ПЭК запрос:', requestData);\n\n      const response = await fetch(apiUrl, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': 'Bearer C04C5BF2AE367BDCBDC71E7DA520A69B167D1984'\n        },\n        body: JSON.stringify(requestData)\n      });\n\n      const data = await response.json();\n      console.log('ПЭК ответ:', data);\n\n      if (response.ok && data.success) {\n        let totalPrice = 0;\n        let services: { name: string; description: string; price: number }[] = [];\n        \n        // Основная стоимость доставки\n        if (data.data?.totalCost) {\n          totalPrice = data.data.totalCost;\n          \n          // Разбивка по услугам если доступна\n          if (data.data.services) {\n            data.data.services.forEach((service: any) => {\n              services.push({\n                name: service.name || 'Услуга ПЭК',\n                description: service.description || '',\n                price: service.cost || 0\n              });\n            });\n          } else {\n            // Основная услуга\n            services.push({\n              name: 'Доставка груза',\n              description: `${form.fromCity} - ${form.toCity}`,\n              price: totalPrice\n            });\n          }\n        }\n        \n        // Забор груза\n        if (data.data?.pickupCost && form.fromAddressDelivery) {\n          services.push({\n            name: 'Забор груза',\n            description: 'От адреса отправителя',\n            price: data.data.pickupCost\n          });\n        }\n        \n        // Доставка до адреса\n        if (data.data?.deliveryCost && form.toAddressDelivery) {\n          services.push({\n            name: 'Доставка груза',\n            description: 'До адреса получателя',\n            price: data.data.deliveryCost\n          });\n        }\n\n        // Срок доставки\n        const deliveryDays = data.data?.deliveryDays || 3;\n\n        return {\n          company: 'ПЭК',\n          price: Math.round(totalPrice),\n          days: deliveryDays,\n          details: {\n            services,\n            totalCost: data.data?.totalCost,\n            pickupCost: data.data?.pickupCost,\n            deliveryCost: data.data?.deliveryCost,\n            deliveryDays: data.data?.deliveryDays,\n            fromCityId,\n            toCityId,\n            rawData: data.data\n          },\n          requestData,\n          responseData: data,\n          apiUrl\n        };\n      } else {\n        // Фоллбэк - возвращаем заглушку если API не работает\n        const totalWeight = form.cargos.reduce((sum, cargo) => sum + cargo.weight, 0);\n        let basePrice = totalWeight * 15; // 15 руб за кг базовая ставка\n        \n        if (form.fromAddressDelivery) basePrice += 500; // забор\n        if (form.toAddressDelivery) basePrice += 500; // доставка\n        if (form.needInsurance) basePrice += form.declaredValue * 0.01; // страховка\n        if (form.needPackaging) basePrice += totalWeight * 20; // упаковка\n        \n        return {\n          company: 'ПЭК',\n          price: Math.round(basePrice),\n          days: 3,\n          details: {\n            note: 'Расчет произведен по базовым тарифам (API недоступен)',\n            fromCityId,\n            toCityId,\n            services: [\n              { name: 'Доставка груза', description: `${form.fromCity} - ${form.toCity}`, price: basePrice }\n            ]\n          },\n          requestData,\n          responseData: data,\n          apiUrl,\n          error: data.message || data.error || 'API ПЭК временно недоступен, показан примерный расчет'\n        };\n      }\n    } catch (error: any) {\n      // Фоллбэк расчет при ошибке соединения\n      const totalWeight = form.cargos.reduce((sum, cargo) => sum + cargo.weight, 0);\n      let basePrice = totalWeight * 15; // 15 руб за кг\n      \n      if (form.fromAddressDelivery) basePrice += 500;\n      if (form.toAddressDelivery) basePrice += 500; \n      if (form.needInsurance) basePrice += form.declaredValue * 0.01;\n      if (form.needPackaging) basePrice += totalWeight * 20;\n      \n      return {\n        company: 'ПЭК',\n        price: Math.round(basePrice),\n        days: 3,\n        details: {\n          note: 'Примерный расчет по базовым тарифам (ошибка соединения с API)',\n          services: [\n            { name: 'Доставка груза', description: `${form.fromCity} - ${form.toCity}`, price: basePrice }\n          ]\n        },\n        requestData: null,\n        responseData: null,\n        apiUrl,\n        error: `Ошибка соединения: ${error.message}. Показан примерный расчет.`\n      };\n    }\n  };",
          "newString": "  // Расчет для ПЭК через публичный API\n  const calculatePEK = async (): Promise<CalculationResult> => {\n    const apiUrl = 'http://calc.pecom.ru/bitrix/components/pecom/calc/ajax.php';\n    \n    try {\n      // Получаем ID городов\n      const fromCityId = await findPekCityId(form.fromCity);\n      const toCityId = await findPekCityId(form.toCity);\n      \n      if (!fromCityId || !toCityId) {\n        return {\n          company: 'ПЭК',\n          price: 0,\n          days: 0,\n          error: `Город не найден в базе ПЭК. Проверьте: ${!fromCityId ? form.fromCity : ''} ${!toCityId ? form.toCity : ''}`.trim(),\n          apiUrl,\n          requestData: { fromCity: form.fromCity, toCity: form.toCity, fromCityId, toCityId },\n          responseData: null\n        };\n      }\n\n      // Формируем параметры запроса согласно публичной документации\n      const params = new URLSearchParams();\n      \n      // Добавляем грузы согласно формату: Ширина (м), Длина (м), Высота (м), Объем (м3), Вес (кг), Негабарит (0/1), ЗТУ (0/1)\n      form.cargos.forEach((cargo, index) => {\n        const width = cargo.width / 100; // переводим см в метры\n        const length = cargo.length / 100;\n        const height = cargo.height / 100;\n        const volume = width * length * height;\n        const weight = cargo.weight;\n        const isOversized = (width > 2.4 || length > 12 || height > 2.7 || weight > 1500) ? 1 : 0;\n        const needZTU = form.needPackaging ? 1 : 0;\n        \n        params.append(`places[${index}][]`, width.toString());\n        params.append(`places[${index}][]`, length.toString());\n        params.append(`places[${index}][]`, height.toString());\n        params.append(`places[${index}][]`, volume.toString());\n        params.append(`places[${index}][]`, weight.toString());\n        params.append(`places[${index}][]`, isOversized.toString());\n        params.append(`places[${index}][]`, needZTU.toString());\n      });\n      \n      // Параметры забора\n      params.append('take[town]', fromCityId.toString());\n      params.append('take[tent]', '0'); // растентровка\n      params.append('take[gidro]', form.needLoading ? '1' : '0'); // гидролифт\n      params.append('take[manip]', '0'); // манипулятор\n      params.append('take[speed]', '0'); // срочный забор\n      params.append('take[moscow]', '0'); // ограничения по Москве\n      \n      // Параметры доставки\n      params.append('deliver[town]', toCityId.toString());\n      params.append('deliver[tent]', '0');\n      params.append('deliver[gidro]', form.needLoading ? '1' : '0');\n      params.append('deliver[manip]', '0');\n      params.append('deliver[speed]', '0');\n      params.append('deliver[moscow]', '0');\n      \n      // Дополнительные услуги\n      params.append('plombir', '0'); // пломбы\n      params.append('strah', form.needInsurance ? form.declaredValue.toString() : '0'); // страховка\n      params.append('ashan', '0'); // доставка в Ашан\n      params.append('night', '0'); // ночное время\n      params.append('pal', '0'); // запаллечивание\n      params.append('pallets', '0'); // паллетная перевозка\n\n      const fullUrl = `${apiUrl}?${params.toString()}`;\n      const requestData = Object.fromEntries(params);\n\n      console.log('ПЭК запрос URL:', fullUrl);\n      console.log('ПЭК параметры:', requestData);\n\n      // Прямой запрос к API (без прокси, так как HTTPS сайт может делать HTTP запросы)\n      const response = await fetch(fullUrl);\n      const data = await response.json();\n      \n      console.log('ПЭК ответ:', data);\n\n      if (response.ok && data && !data.error?.length) {\n        let totalPrice = 0;\n        let services: { name: string; description: string; price: number }[] = [];\n        \n        // Собираем стоимость услуг по документации\n        if (data.take?.[2]) {\n          const price = parseFloat(data.take[2]);\n          totalPrice += price;\n          services.push({ \n            name: data.take[0] || 'Забор груза', \n            description: data.take[1] || '', \n            price \n          });\n        }\n        \n        // Выбираем тип перевозки\n        let transportCost = 0;\n        let transportName = '';\n        if (data.autonegabarit?.[2] && parseFloat(data.autonegabarit[2]) > 0) {\n          transportCost = parseFloat(data.autonegabarit[2]);\n          transportName = data.autonegabarit[0] || 'Автоперевозка (негабарит)';\n        } else if (data.auto?.[2]) {\n          transportCost = parseFloat(data.auto[2]);\n          transportName = data.auto[0] || 'Автоперевозка';\n        } else if (data.avia?.[2]) {\n          transportCost = parseFloat(data.avia[2]);\n          transportName = data.avia[0] || 'Авиаперевозка';\n        }\n        \n        if (transportCost > 0) {\n          totalPrice += transportCost;\n          services.push({ \n            name: transportName, \n            description: data.auto?.[1] || data.autonegabarit?.[1] || data.avia?.[1] || '', \n            price: transportCost \n          });\n        }\n        \n        if (data.deliver?.[2]) {\n          const price = parseFloat(data.deliver[2]);\n          totalPrice += price;\n          services.push({ \n            name: data.deliver[0] || 'Доставка груза', \n            description: data.deliver[1] || '', \n            price \n          });\n        }\n        \n        // Дополнительные услуги\n        ['ADD', 'ADD_1', 'ADD_2', 'ADD_3', 'ADD_4'].forEach(key => {\n          if (data[key]?.[2] && parseFloat(data[key][2]) > 0) {\n            const price = parseFloat(data[key][2]);\n            totalPrice += price;\n            services.push({ \n              name: data[key][0] || `Доп. услуга ${key}`, \n              description: data[key][1] || '', \n              price \n            });\n          }\n        });\n        \n        // Определяем срок доставки\n        let deliveryDays = 3; // по умолчанию\n        if (data.periods) {\n          const daysMatch = data.periods.match(/(\\d+)\\s*дн/);\n          if (daysMatch) {\n            deliveryDays = parseInt(daysMatch[1]);\n          }\n        }\n\n        return {\n          company: 'ПЭК',\n          price: Math.round(totalPrice),\n          days: deliveryDays,\n          details: {\n            services,\n            periods: data.periods,\n            aperiods: data.aperiods,\n            rawData: data,\n            fromCityId,\n            toCityId\n          },\n          requestData,\n          responseData: data,\n          apiUrl: fullUrl\n        };\n      } else {\n        const errorMessages = data?.error?.join(', ') || 'Неизвестная ошибка ПЭК';\n        return {\n          company: 'ПЭК',\n          price: 0,\n          days: 0,\n          error: errorMessages,\n          requestData,\n          responseData: data,\n          apiUrl: fullUrl\n        };\n      }\n    } catch (error: any) {\n      // Фоллбэк расчет при ошибке соединения\n      const totalWeight = form.cargos.reduce((sum, cargo) => sum + cargo.weight, 0);\n      let basePrice = totalWeight * 15; // 15 руб за кг\n      \n      if (form.fromAddressDelivery) basePrice += 500;\n      if (form.toAddressDelivery) basePrice += 500; \n      if (form.needInsurance) basePrice += form.declaredValue * 0.01;\n      if (form.needPackaging) basePrice += totalWeight * 20;\n      \n      return {\n        company: 'ПЭК',\n        price: Math.round(basePrice),\n        days: 3,\n        details: {\n          note: 'Примерный расчет по базовым тарифам (ошибка соединения с API)',\n          services: [\n            { name: 'Доставка груза', description: `${form.fromCity} - ${form.toCity}`, price: basePrice }\n          ]\n        },\n        requestData: null,\n        responseData: null,\n        apiUrl,\n        error: `Ошибка соединения: ${error.message}. Показан примерный расчет.`\n      };\n    }\n  };"
        },
        {
          "oldString": "                      {calc.error ? (\n                        <Alert className=\"border-red-600\">\n                          <AlertDescription className=\"text-white text-xs\">{calc.error}</AlertDescription>\n                        </Alert>\n                      ) : (\n                        <div className=\"space-y-2\">\n                          <p className=\"text-white text-xs\"><strong>Стоимость:</strong> {calc.price.toLocaleString()} ₽</p>\n                          <p className=\"text-white text-xs\"><strong>Срок доставки:</strong> {calc.days} дней</p>\n                          \n                          <div className=\"flex gap-2 mt-2\">\n                            <Button\n                              variant=\"outline\"\n                              size=\"sm\"\n                              onClick={() => toggleDetails(calc.company)}\n                              className=\"h-6 text-xs\"\n                            >\n                              {expandedDetails[calc.company] ? 'Скрыть подробнее' : 'Показать подробнее'}\n                            </Button>\n                            <Button\n                              variant=\"outline\"\n                              size=\"sm\"\n                              onClick={() => toggleDebugInfo(calc.company)}\n                              className=\"h-6 text-xs\"\n                            >\n                              {expandedDebugInfo[calc.company] ? 'Скрыть отладку' : 'Отладочная информация'}\n                            </Button>\n                          </div>\n                          \n                          {/* Детали расчета */}\n                          <Collapsible open={expandedDetails[calc.company]}>\n                            <CollapsibleContent className=\"mt-2\">\n                              <div className=\"bg-gray-900 p-3 rounded text-xs\">\n                                <h4 className=\"font-bold mb-2 text-white\">Детали расчета:</h4>\n                                {(() => {\n                                  const details = parseCalculationDetails(calc);\n                                  const totalPrice = details.reduce((sum, detail) => sum + detail.price, 0);\n                                  \n                                  return (\n                                    <div className=\"space-y-1\">\n                                      {details.map((detail, idx) => (\n                                        <div key={idx} className=\"flex justify-between text-white\">\n                                          <div>\n                                            <div className=\"font-medium\">{detail.service}</div>\n                                            {detail.description && (\n                                              <div className=\"text-gray-400 text-xs\">{detail.description}</div>\n                                            )}\n                                          </div>\n                                          <div className=\"font-medium\">{detail.price.toLocaleString()} ₽</div>\n                                        </div>\n                                      ))}\n\n                                    </div>\n                                  );\n                                })()}\n                              </div>\n                            </CollapsibleContent>\n                          </Collapsible>\n                          \n                          {/* Отладочная информация */}\n                          <Collapsible open={expandedDebugInfo[calc.company]}>\n                            <CollapsibleContent className=\"mt-2\">\n                              <div className=\"bg-gray-900 p-3 rounded text-xs\">\n                                <h4 className=\"font-bold mb-2 text-white\">Отладочная информация:</h4>\n                                \n                                {calc.apiUrl && (\n                                  <div className=\"mb-3\">\n                                    <h5 className=\"font-bold mb-1 text-white\">Запрос к API:</h5>\n                                    <p className=\"text-gray-300 break-all\">URL: {calc.apiUrl}</p>\n                                  </div>\n                                )}\n                                \n                                {calc.sessionId && (\n                                  <div className=\"mb-3\">\n                                    <h5 className=\"font-bold mb-1 text-white\">Session ID:</h5>\n                                    <p className=\"text-gray-300\">{calc.sessionId}</p>\n                                  </div>\n                                )}\n                                \n                                {calc.requestData && (\n                                  <div className=\"mb-3\">\n                                    <h5 className=\"font-bold mb-1 text-white\">Отправленный запрос:</h5>\n                                    <pre className=\"whitespace-pre-wrap overflow-auto max-h-32 text-gray-300 bg-gray-950 p-2 rounded text-xs\">\n                                      {JSON.stringify(calc.requestData, null, 2)}\n                                    </pre>\n                                  </div>\n                                )}\n                                \n                                {calc.responseData && (\n                                  <div className=\"mb-3\">\n                                    <h5 className=\"font-bold mb-1 text-white\">Полученный ответ:</h5>\n                                    <pre className=\"whitespace-pre-wrap overflow-auto max-h-32 text-gray-300 bg-gray-950 p-2 rounded text-xs\">\n                                      {JSON.stringify(calc.responseData, null, 2)}\n                                    </pre>\n                                  </div>\n                                )}\n                                \n                                {calc.details && (\n                                  <div className=\"mb-3\">\n                                    <h5 className=\"font-bold mb-1 text-white\">Детали расчета (JSON):</h5>\n                                    <pre className=\"whitespace-pre-wrap overflow-auto max-h-32 text-gray-300 bg-gray-950 p-2 rounded text-xs\">\n                                      {JSON.stringify(calc.details, null, 2)}\n                                    </pre>\n                                  </div>\n                                )}\n                              </div>\n                            </CollapsibleContent>\n                          </Collapsible>\n                        </div>\n                      )}",
          "newString": "                      <div className=\"space-y-2\">\n                        {calc.error ? (\n                          <div className=\"space-y-2\">\n                            <Alert className=\"border-red-600\">\n                              <AlertDescription className=\"text-white text-xs\">{calc.error}</AlertDescription>\n                            </Alert>\n                            {calc.price > 0 && (\n                              <>\n                                <p className=\"text-white text-xs\"><strong>Примерная стоимость:</strong> {calc.price.toLocaleString()} ₽</p>\n                                <p className=\"text-white text-xs\"><strong>Примерный срок:</strong> {calc.days} дней</p>\n                              </>\n                            )}\n                          </div>\n                        ) : (\n                          <>\n                            <p className=\"text-white text-xs\"><strong>Стоимость:</strong> {calc.price.toLocaleString()} ₽</p>\n                            <p className=\"text-white text-xs\"><strong>Срок доставки:</strong> {calc.days} дней</p>\n                          </>\n                        )}\n                        \n                        <div className=\"flex gap-2 mt-2\">\n                          {!calc.error && (\n                            <Button\n                              variant=\"outline\"\n                              size=\"sm\"\n                              onClick={() => toggleDetails(calc.company)}\n                              className=\"h-6 text-xs\"\n                            >\n                              {expandedDetails[calc.company] ? 'Скрыть подробнее' : 'Показать подробнее'}\n                            </Button>\n                          )}\n                          <Button\n                            variant=\"outline\"\n                            size=\"sm\"\n                            onClick={() => toggleDebugInfo(calc.company)}\n                            className=\"h-6 text-xs\"\n                          >\n                            {expandedDebugInfo[calc.company] ? 'Скрыть отладку' : 'Отладочная информация'}\n                          </Button>\n                        </div>\n                        \n                        {/* Детали расчета */}\n                        {!calc.error && (\n                          <Collapsible open={expandedDetails[calc.company]}>\n                            <CollapsibleContent className=\"mt-2\">\n                              <div className=\"bg-gray-900 p-3 rounded text-xs\">\n                                <h4 className=\"font-bold mb-2 text-white\">Детали расчета:</h4>\n                                {(() => {\n                                  const details = parseCalculationDetails(calc);\n                                  const totalPrice = details.reduce((sum, detail) => sum + detail.price, 0);\n                                  \n                                  return (\n                                    <div className=\"space-y-1\">\n                                      {details.map((detail, idx) => (\n                                        <div key={idx} className=\"flex justify-between text-white\">\n                                          <div>\n                                            <div className=\"font-medium\">{detail.service}</div>\n                                            {detail.description && (\n                                              <div className=\"text-gray-400 text-xs\">{detail.description}</div>\n                                            )}\n                                          </div>\n                                          <div className=\"font-medium\">{detail.price.toLocaleString()} ₽</div>\n                                        </div>\n                                      ))}\n                                    </div>\n                                  );\n                                })()}\n                              </div>\n                            </CollapsibleContent>\n                          </Collapsible>\n                        )}\n                        \n                        {/* Отладочная информация - всегда доступна */}\n                        <Collapsible open={expandedDebugInfo[calc.company]}>\n                          <CollapsibleContent className=\"mt-2\">\n                            <div className=\"bg-gray-900 p-3 rounded text-xs\">\n                              <h4 className=\"font-bold mb-2 text-white\">Отладочная информация:</h4>\n                              \n                              {calc.apiUrl && (\n                                <div className=\"mb-3\">\n                                  <h5 className=\"font-bold mb-1 text-white\">Запрос к API:</h5>\n                                  <p className=\"text-gray-300 break-all text-xs\">URL: {calc.apiUrl}</p>\n                                </div>\n                              )}\n                              \n                              {calc.sessionId && (\n                                <div className=\"mb-3\">\n                                  <h5 className=\"font-bold mb-1 text-white\">Session ID:</h5>\n                                  <p className=\"text-gray-300 text-xs\">{calc.sessionId}</p>\n                                </div>\n                              )}\n                              \n                              {calc.requestData && (\n                                <div className=\"mb-3\">\n                                  <h5 className=\"font-bold mb-1 text-white\">Отправленный запрос:</h5>\n                                  <pre className=\"whitespace-pre-wrap overflow-auto max-h-32 text-gray-300 bg-gray-950 p-2 rounded text-xs\">\n                                    {JSON.stringify(calc.requestData, null, 2)}\n                                  </pre>\n                                </div>\n                              )}\n                              \n                              {calc.responseData && (\n                                <div className=\"mb-3\">\n                                  <h5 className=\"font-bold mb-1 text-white\">Полученный ответ:</h5>\n                                  <pre className=\"whitespace-pre-wrap overflow-auto max-h-32 text-gray-300 bg-gray-950 p-2 rounded text-xs\">\n                                    {JSON.stringify(calc.responseData, null, 2)}\n                                  </pre>\n                                </div>\n                              )}\n                              \n                              {calc.details && (\n                                <div className=\"mb-3\">\n                                  <h5 className=\"font-bold mb-1 text-white\">Детали расчета (JSON):</h5>\n                                  <pre className=\"whitespace-pre-wrap overflow-auto max-h-32 text-gray-300 bg-gray-950 p-2 rounded text-xs\">\n                                    {JSON.stringify(calc.details, null, 2)}\n                                  </pre>\n                                </div>\n                              )}\n                              \n                              {calc.error && (\n                                <div className=\"mb-3\">\n                                  <h5 className=\"font-bold mb-1 text-red-400\">Информация об ошибке:</h5>\n                                  <p className=\"text-red-300 text-xs\">{calc.error}</p>\n                                </div>\n                              )}\n                            </div>\n                          </CollapsibleContent>\n                        </Collapsible>\n                      </div>"
        }
      ]
    },
    "error": "Error: You must read the file /home/user/project/app/page.tsx before overwriting it. Use the Read tool first",
    "time": {
      "start": 1758789556865,
      "end": 1758789556868
    }
  }
}