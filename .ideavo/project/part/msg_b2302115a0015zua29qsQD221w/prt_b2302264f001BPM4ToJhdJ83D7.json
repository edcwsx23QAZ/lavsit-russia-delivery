{
  "id": "prt_b2302264f001BPM4ToJhdJ83D7",
  "sessionID": "ses_4dcfe2ec6ffeGyMv3tDAZ25rFC",
  "messageID": "msg_b2302115a0015zua29qsQD221w",
  "type": "tool",
  "callID": "toolu_01C9iVNFDvsuJL2usjv22bBn",
  "tool": "read",
  "state": {
    "status": "completed",
    "input": {
      "filePath": "/home/user/project/lib/optimized-api-client.ts",
      "offset": 0,
      "limit": 200
    },
    "output": "<file>\n00001| import { cacheManager, createCalculationCacheKey } from './cache-manager';\n00002| import { enhancedApiRequest, PerformanceMonitor } from './api-utils';\n00003| \n00004| interface ApiRequest {\n00005|   company: string;\n00006|   method: string;\n00007|   url: string;\n00008|   options: RequestInit;\n00009|   context: { operation: string; company: string };\n00010|   requiresAuth?: boolean;\n00011|   cacheKey?: string;\n00012| }\n00013| \n00014| interface BatchResult {\n00015|   company: string;\n00016|   result: any;\n00017|   error?: string;\n00018|   duration: number;\n00019|   fromCache?: boolean;\n00020| }\n00021| \n00022| class OptimizedApiClient {\n00023|   // –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö API –∑–∞–ø—Ä–æ—Å–æ–≤\n00024|   async batchApiRequests(requests: ApiRequest[]): Promise<BatchResult[]> {\n00025|     const startTime = performance.now();\n00026|     \n00027|     console.log(`üöÄ –ó–∞–ø—É—Å–∫ ${requests.length} –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö API –∑–∞–ø—Ä–æ—Å–æ–≤...`);\n00028|     \n00029|     // –°–æ–∑–¥–∞–µ–º –º–∞—Å—Å–∏–≤ –ø—Ä–æ–º–∏—Å–æ–≤ —Å —Ç–∞–π–º–∞—É—Ç–∞–º–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º\n00030|     const requestPromises = requests.map(async (request): Promise<BatchResult> => {\n00031|       const requestStart = performance.now();\n00032|       const endTiming = PerformanceMonitor.startMeasurement(`${request.company}_${request.method}`);\n00033|       \n00034|       try {\n00035|         // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à –¥–ª—è GET –∑–∞–ø—Ä–æ—Å–æ–≤\n00036|         if (request.method === 'GET' && request.cacheKey) {\n00037|           const cached = cacheManager.getCachedData(request.cacheKey);\n00038|           if (cached) {\n00039|             const duration = performance.now() - requestStart;\n00040|             endTiming();\n00041|             return {\n00042|               company: request.company,\n00043|               result: cached,\n00044|               duration,\n00045|               fromCache: true\n00046|             };\n00047|           }\n00048|         }\n00049| \n00050|         // –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å\n00051|         const response = await enhancedApiRequest(\n00052|           request.url,\n00053|           request.options,\n00054|           request.context,\n00055|           { maxRetries: 2, baseDelay: 1000 }\n00056|         );\n00057| \n00058|         if (response && typeof response === 'object' && 'success' in response && !response.success) {\n00059|           throw new Error(response.error?.message || 'API request failed');\n00060|         }\n00061| \n00062|         const result = response as Response;\n00063|         let data;\n00064|         \n00065|         try {\n00066|           data = await result.json();\n00067|         } catch (parseError) {\n00068|           throw new Error(`Failed to parse API response: ${parseError}`);\n00069|         }\n00070| \n00071|         // –ö—ç—à–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω—ã–µ GET –∑–∞–ø—Ä–æ—Å—ã\n00072|         if (request.method === 'GET' && result.ok && request.cacheKey) {\n00073|           cacheManager.setCachedData(request.cacheKey, data);\n00074|         }\n00075| \n00076|         const duration = performance.now() - requestStart;\n00077|         endTiming();\n00078|         \n00079|         return {\n00080|           company: request.company,\n00081|           result: data,\n00082|           duration,\n00083|           fromCache: false\n00084|         };\n00085| \n00086|       } catch (error) {\n00087|         const duration = performance.now() - requestStart;\n00088|         endTiming();\n00089|         \n00090|         console.error(`‚ùå –û—à–∏–±–∫–∞ API –∑–∞–ø—Ä–æ—Å–∞ ${request.company}:`, error);\n00091|         \n00092|         return {\n00093|           company: request.company,\n00094|           result: null,\n00095|           error: error instanceof Error ? error.message : 'Unknown error',\n00096|           duration\n00097|         };\n00098|       }\n00099|     });\n00100| \n00101|     // –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤\n00102|     const results = await Promise.allSettled(requestPromises);\n00103|     \n00104|     // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã\n00105|     const batchResults: BatchResult[] = results.map((result, index) => {\n00106|       if (result.status === 'fulfilled') {\n00107|         return result.value;\n00108|       } else {\n00109|         console.error(`‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ ${requests[index].company}:`, result.reason);\n00110|         return {\n00111|           company: requests[index].company,\n00112|           result: null,\n00113|           error: `Critical error: ${result.reason}`,\n00114|           duration: 0\n00115|         };\n00116|       }\n00117|     });\n00118| \n00119|     const totalDuration = performance.now() - startTime;\n00120|     const successCount = batchResults.filter(r => !r.error).length;\n00121|     const cacheHitCount = batchResults.filter(r => r.fromCache).length;\n00122|     \n00123|     console.log(`‚úÖ –ü–∞–∫–µ—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∑–∞–≤–µ—Ä—à–µ–Ω –∑–∞ ${totalDuration.toFixed(0)}–º—Å`);\n00124|     console.log(`üìä –£—Å–ø–µ—à–Ω–æ: ${successCount}/${requests.length}, –ò–∑ –∫—ç—à–∞: ${cacheHitCount}`);\n00125|     \n00126|     return batchResults;\n00127|   }\n00128| \n00129|   // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º\n00130|   async calculateWithCache(\n00131|     company: string,\n00132|     calculationFunction: () => Promise<any>,\n00133|     form: any\n00134|   ): Promise<any> {\n00135|     const cacheKey = createCalculationCacheKey(form);\n00136|     \n00137|     // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à\n00138|     const cached = cacheManager.getCachedCalculation(company, cacheKey);\n00139|     if (cached) {\n00140|       console.log(`üí∞ –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–∞—Å—á–µ—Ç –¥–ª—è ${company}`);\n00141|       return cached;\n00142|     }\n00143| \n00144|     // –í—ã–ø–æ–ª–Ω—è–µ–º —Ä–∞—Å—á–µ—Ç\n00145|     console.log(`üîÑ –í—ã–ø–æ–ª–Ω—è–µ–º —Ä–∞—Å—á–µ—Ç –¥–ª—è ${company}...`);\n00146|     const result = await calculationFunction();\n00147|     \n00148|     // –ö—ç—à–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç\n00149|     if (result && !result.error) {\n00150|       cacheManager.setCachedCalculation(company, cacheKey, result);\n00151|     }\n00152|     \n00153|     return result;\n00154|   }\n00155| \n00156|   // –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö\n00157|   async preloadCalculationData(form: any): Promise<void> {\n00158|     console.log('üöÄ –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–∞—Å—á–µ—Ç–æ–≤...');\n00159|     \n00160|     const preloadPromises: Promise<void>[] = [];\n00161|     \n00162|     // –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Å—Å–∏–π\n00163|     preloadPromises.push(cacheManager.preloadAllSessions());\n00164|     \n00165|     // –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≥–æ—Ä–æ–¥–æ–≤ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ\n00166|     if (form.fromCity && form.toCity) {\n00167|       preloadPromises.push(this.preloadCityData(form.fromCity, form.toCity));\n00168|     }\n00169|     \n00170|     await Promise.allSettled(preloadPromises);\n00171|     console.log('‚úÖ –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∑–∞–≤–µ—Ä—à–µ–Ω–∞');\n00172|   }\n00173| \n00174|   // –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≥–æ—Ä–æ–¥–æ–≤\n00175|   private async preloadCityData(fromCity: string, toCity: string): Promise<void> {\n00176|     const cityPromises = [\n00177|       this.preloadDellinCities(fromCity, toCity),\n00178|       this.preloadPekZones(fromCity, toCity)\n00179|     ];\n00180|     \n00181|     await Promise.allSettled(cityPromises);\n00182|   }\n00183| \n00184|   // –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –≥–æ—Ä–æ–¥–æ–≤ –î–µ–ª–æ–≤—ã—Ö –õ–∏–Ω–∏–π\n00185|   private async preloadDellinCities(fromCity: string, toCity: string): Promise<void> {\n00186|     try {\n00187|       const cacheKey = `dellin_cities_${fromCity}_${toCity}`;\n00188|       const cached = cacheManager.getCachedData(cacheKey);\n00189|       \n00190|       if (cached) return;\n00191|       \n00192|       console.log('üèôÔ∏è –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –≥–æ—Ä–æ–¥–æ–≤ –î–µ–ª–æ–≤—ã—Ö –õ–∏–Ω–∏–π...');\n00193|       \n00194|       // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –≥–æ—Ä–æ–¥–æ–≤\n00195|       const response = await fetch('/data/dellin-cities.json');\n00196|       if (response.ok) {\n00197|         const data = await response.json();\n00198|         cacheManager.setCachedData(cacheKey, data.cities, 24 * 60 * 60 * 1000); // 24 —á–∞—Å–∞\n00199|         console.log('‚úÖ –ì–æ—Ä–æ–¥–∞ –î–µ–ª–æ–≤—ã—Ö –õ–∏–Ω–∏–π –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∂–µ–Ω—ã');\n00200|       }\n\n(File has more lines. Use 'offset' parameter to read beyond line 200)\n</file>",
    "title": "lib/optimized-api-client.ts",
    "metadata": {
      "preview": "import { cacheManager, createCalculationCacheKey } from './cache-manager';\nimport { enhancedApiRequest, PerformanceMonitor } from './api-utils';\n\ninterface ApiRequest {\n  company: string;\n  method: string;\n  url: string;\n  options: RequestInit;\n  context: { operation: string; company: string };\n  requiresAuth?: boolean;\n  cacheKey?: string;\n}\n\ninterface BatchResult {\n  company: string;\n  result: any;\n  error?: string;\n  duration: number;\n  fromCache?: boolean;\n}"
    },
    "time": {
      "start": 1765818902774,
      "end": 1765818902776
    }
  }
}