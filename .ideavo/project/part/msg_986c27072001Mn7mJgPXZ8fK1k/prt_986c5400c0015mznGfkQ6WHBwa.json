{
  "id": "prt_986c5400c0015mznGfkQ6WHBwa",
  "messageID": "msg_986c27072001Mn7mJgPXZ8fK1k",
  "sessionID": "ses_6852784ecffeuHwynj83p2lr14",
  "type": "tool",
  "tool": "edit",
  "callID": "toolu_01DmcKd1M4w3DuMG5mqnKaVp",
  "state": {
    "status": "completed",
    "input": {
      "filePath": "/home/user/project/app/page.tsx",
      "oldString": "  // –ü–æ–ª—É—á–µ–Ω–∏–µ ID –≥–æ—Ä–æ–¥–∞ –ü–≠–ö\n  const findPekCityId = async (cityName: string): Promise<string | null> => {\n    try {\n      const pekCities = await loadPekCities();\n      \n      const normalizedSearchCity = cityName.toLowerCase().trim()\n        .replace(/—ë/g, '–µ')\n        .replace(/[\\s\\-\\.–≥\\.]+/g, '')\n        .replace(/–æ–±–ª–∞—Å—Ç—å|–æ–±–ª|–∫—Ä–∞–π|—Ä–µ—Å–ø—É–±–ª–∏–∫–∞|—Ä–µ—Å–ø|–∞–≤—Ç–æ–Ω–æ–º–Ω—ã–π –æ–∫—Ä—É–≥|–∞–æ/g, '');\n\n      console.log(`–ü–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–∞ –ü–≠–ö: \"${cityName}\" -> \"${normalizedSearchCity}\"`);\n\n      // –ü—Ä—è–º–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ\n      if (pekCities[normalizedSearchCity]) {\n        console.log(`–ù–∞–π–¥–µ–Ω –ø—Ä—è–º–æ–π ID –¥–ª—è \"${normalizedSearchCity}\": ${pekCities[normalizedSearchCity]}`);\n        return pekCities[normalizedSearchCity];\n      }\n\n      // –ü–æ–∏—Å–∫ –ø–æ —á–∞—Å—Ç–∏—á–Ω–æ–º—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é\n      for (const [cityKey, cityId] of Object.entries(pekCities)) {\n        if (normalizedSearchCity.includes(cityKey) || \n            cityKey.includes(normalizedSearchCity)) {\n          console.log(`–ù–∞–π–¥–µ–Ω —á–∞—Å—Ç–∏—á–Ω—ã–π ID –¥–ª—è \"${normalizedSearchCity}\" —á–µ—Ä–µ–∑ \"${cityKey}\": ${cityId}`);\n          return cityId;\n        }\n      }\n\n      console.log(`–ì–æ—Ä–æ–¥ –ü–≠–ö \"${cityName}\" –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ`);\n      return null;\n    } catch (error) {\n      console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –≥–æ—Ä–æ–¥–∞ –ü–≠–ö:', error);\n      return null;\n    }\n  };\n\n  // –ü–æ–ª—É—á–µ–Ω–∏–µ ID —Å–∫–ª–∞–¥–∞ –ü–≠–ö –ø–æ –∞–¥—Ä–µ—Å—É —á–µ—Ä–µ–∑ API\n  const findPekWarehouseId = async (address: string): Promise<string | null> => {\n    try {\n      // –ò—Å–ø–æ–ª—å–∑—É–µ–º API –ü–≠–ö –¥–ª—è –ø–æ–∏—Å–∫–∞ —Å–∫–ª–∞–¥–∞ –ø–æ –∞–¥—Ä–µ—Å—É\n      const response = await fetch('https://api.pecom.ru/v1/branches/findzonebyaddress', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Accept': 'application/json'\n        },\n        body: JSON.stringify({\n          query: address\n        })\n      });\n\n      if (!response.ok) {\n        console.warn(`–ü–≠–ö API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (${response.status}), –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback`);\n        return null;\n      }\n\n      const data = await response.json();\n      \n      if (data && data.length > 0) {\n        const warehouse = data[0];\n        console.log(`–ù–∞–π–¥–µ–Ω —Å–∫–ª–∞–¥ –ü–≠–ö: ${warehouse.branch_id} –¥–ª—è –∞–¥—Ä–µ—Å–∞: ${address}`);\n        return warehouse.branch_id;\n      }\n\n      console.log(`–°–∫–ª–∞–¥ –ü–≠–ö –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è –∞–¥—Ä–µ—Å–∞: ${address}`);\n      return null;\n    } catch (error) {\n      console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ —Å–∫–ª–∞–¥–∞ –ü–≠–ö:', error);\n      return null;\n    }\n  };\n\n  // –†–∞—Å—á–µ—Ç –¥–ª—è –ü–≠–ö —á–µ—Ä–µ–∑ –ø—É–±–ª–∏—á–Ω—ã–π API\n  const calculatePEK = async (): Promise<CalculationResult> => {\n    const apiUrl = 'http://calc.pecom.ru/bitrix/components/pecom/calc/ajax.php';\n    \n    try {\n      // –ü–æ–ª—É—á–∞–µ–º ID –≥–æ—Ä–æ–¥–æ–≤\n      const fromCityId = await findPekCityId(form.fromCity);\n      const toCityId = await findPekCityId(form.toCity);\n      \n      if (!fromCityId || !toCityId) {\n        return {\n          company: '–ü–≠–ö',\n          price: 0,\n          days: 0,\n          error: `–ì–æ—Ä–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ –ü–≠–ö. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ: ${!fromCityId ? form.fromCity : ''} ${!toCityId ? form.toCity : ''}`.trim(),\n          apiUrl,\n          requestData: { fromCity: form.fromCity, toCity: form.toCity, fromCityId, toCityId },\n          responseData: null\n        };\n      }\n\n      // –§–æ—Ä–º–∏—Ä—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞ —Å–æ–≥–ª–∞—Å–Ω–æ –ø—É–±–ª–∏—á–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏\n      const params = new URLSearchParams();\n      \n      // –î–æ–±–∞–≤–ª—è–µ–º –≥—Ä—É–∑—ã —Å–æ–≥–ª–∞—Å–Ω–æ —Ñ–æ—Ä–º–∞—Ç—É: –®–∏—Ä–∏–Ω–∞ (–º), –î–ª–∏–Ω–∞ (–º), –í—ã—Å–æ—Ç–∞ (–º), –û–±—ä–µ–º (–º3), –í–µ—Å (–∫–≥), –ù–µ–≥–∞–±–∞—Ä–∏—Ç (0/1), –ó–¢–£ (0/1)\n      form.cargos.forEach((cargo, index) => {\n        const width = cargo.width / 100; // –ø–µ—Ä–µ–≤–æ–¥–∏–º —Å–º –≤ –º–µ—Ç—Ä—ã\n        const length = cargo.length / 100;\n        const height = cargo.height / 100;\n        const volume = width * length * height;\n        const weight = cargo.weight;\n        const isOversized = (width > 2.4 || length > 12 || height > 2.7 || weight > 1500) ? 1 : 0;\n        const needZTU = form.needPackaging ? 1 : 0;\n        \n        params.append(`places[${index}][]`, width.toString());\n        params.append(`places[${index}][]`, length.toString());\n        params.append(`places[${index}][]`, height.toString());\n        params.append(`places[${index}][]`, volume.toString());\n        params.append(`places[${index}][]`, weight.toString());\n        params.append(`places[${index}][]`, isOversized.toString());\n        params.append(`places[${index}][]`, needZTU.toString());\n      });\n      \n      // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–±–æ—Ä–∞\n      params.append('take[town]', fromCityId.toString());\n      params.append('take[tent]', '0'); // —Ä–∞—Å—Ç–µ–Ω—Ç—Ä–æ–≤–∫–∞\n      params.append('take[gidro]', form.needLoading ? '1' : '0'); // –≥–∏–¥—Ä–æ–ª–∏—Ñ—Ç\n      params.append('take[manip]', '0'); // –º–∞–Ω–∏–ø—É–ª—è—Ç–æ—Ä\n      params.append('take[speed]', '0'); // —Å—Ä–æ—á–Ω—ã–π –∑–∞–±–æ—Ä\n      params.append('take[moscow]', '0'); // –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ –ú–æ—Å–∫–≤–µ\n      params.append('take[address_get]', form.fromAddressDelivery ? '1' : '0'); // –∑–∞–±–æ—Ä —Å –∞–¥—Ä–µ—Å–∞\n      \n      // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–æ—Å—Ç–∞–≤–∫–∏\n      params.append('give[town]', toCityId.toString());\n      params.append('give[address_give]', form.toAddressDelivery ? '1' : '0'); // –¥–æ—Å—Ç–∞–≤–∫–∞ –ø–æ –∞–¥—Ä–µ—Å—É\n      params.append('give[gidro]', form.needCarry ? '1' : '0'); // –≥–∏–¥—Ä–æ–ª–∏—Ñ—Ç –ø—Ä–∏ –¥–æ—Å—Ç–∞–≤–∫–µ\n      \n      // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã\n      params.append('calc', '1');\n      params.append('service', form.needInsurance ? '1' : '0'); // —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞\n      if (form.needInsurance && form.declaredValue > 0) {\n        params.append('value', form.declaredValue.toString());\n      }\n\n      const fullUrl = `${apiUrl}?${params.toString()}`;\n      \n      console.log('–ü–≠–ö –∑–∞–ø—Ä–æ—Å URL:', fullUrl);\n      console.log('–ü–≠–ö –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:', requestData);\n\n      const response = await fetch(fullUrl, {\n        method: 'GET',\n        headers: {\n          'Accept': 'application/json',\n        }\n      });\n\n      const data = await response.json();\n      console.log('–ü–≠–ö –æ—Ç–≤–µ—Ç:', data);\n\n      if (response.ok && data && !data.error) {\n        // –ü–∞—Ä—Å–∏–º –æ—Ç–≤–µ—Ç –ø—É–±–ª–∏—á–Ω–æ–≥–æ API –ü–≠–ö\n        let totalPrice = parseFloat(data.total) || 0;\n        const services = [];\n        \n        if (data.services && Array.isArray(data.services)) {\n          data.services.forEach((service: any) => {\n            if (service.cost > 0) {\n              services.push({\n                name: service.name || '–£—Å–ª—É–≥–∞ –ü–≠–ö',\n                description: service.description || '',\n                price: parseFloat(service.cost)\n              });\n            }\n          });\n        }\n\n        return {\n          company: '–ü–≠–ö',\n          price: Math.round(totalPrice),\n          days: parseInt(data.days) || 3,\n          details: {\n            note: data.note || `–î–æ—Å—Ç–∞–≤–∫–∞ ${form.fromCity} - ${form.toCity}`,\n            services: services.length > 0 ? services : [\n              {\n                name: '–î–æ—Å—Ç–∞–≤–∫–∞ –≥—Ä—É–∑–∞',\n                description: `${form.fromCity} - ${form.toCity}`,\n                price: Math.round(totalPrice)\n              }\n            ]\n          },\n          requestData: { params: params.toString(), fromCityId, toCityId },\n          responseData: data,\n          apiUrl: fullUrl\n        };\n      } else {\n        // API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–ª–∏ –æ—à–∏–±–∫–∞ - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ñ–æ–ª–ª–±—ç–∫\n        console.warn('–ü–≠–ö API –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω:', data);\n        \n        const totalWeight = form.cargos.reduce((sum, cargo) => sum + cargo.weight, 0);\n        let basePrice = totalWeight * 18; // 18 —Ä—É–± –∑–∞ –∫–≥ –¥–ª—è –ü–≠–ö\n        \n        if (form.fromAddressDelivery) basePrice += 600;\n        if (form.toAddressDelivery) basePrice += 600;\n        if (form.needInsurance) basePrice += form.declaredValue * 0.012;\n        if (form.needPackaging) basePrice += totalWeight * 25;\n        \n        return {\n          company: '–ü–≠–ö',\n          price: Math.round(basePrice),\n          days: 3,\n          details: {\n            note: '–ü—Ä–∏–º–µ—Ä–Ω—ã–π —Ä–∞—Å—á–µ—Ç –ø–æ –±–∞–∑–æ–≤—ã–º —Ç–∞—Ä–∏—Ñ–∞–º –ü–≠–ö',\n            services: [\n              {\n                name: '–î–æ—Å—Ç–∞–≤–∫–∞ –≥—Ä—É–∑–∞',\n                description: `${form.fromCity} - ${form.toCity}`,\n                price: Math.round(basePrice)\n              }\n            ]\n          },\n          requestData: data,\n          responseData: data,\n          apiUrl,\n          error: data.message || data.error || 'API –ü–≠–ö –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –ø–æ–∫–∞–∑–∞–Ω –ø—Ä–∏–º–µ—Ä–Ω—ã–π —Ä–∞—Å—á–µ—Ç'\n        };\n      }\n    } catch (error: any) {\n      // –§–æ–ª–ª–±—ç–∫ —Ä–∞—Å—á–µ—Ç –ø—Ä–∏ –æ—à–∏–±–∫–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è\n      const totalWeight = form.cargos.reduce((sum, cargo) => sum + cargo.weight, 0);\n      let basePrice = totalWeight * 15; // 15 —Ä—É–± –∑–∞ –∫–≥\n      \n      if (form.fromAddressDelivery) basePrice += 500;\n      if (form.toAddressDelivery) basePrice += 500; \n      if (form.needInsurance) basePrice += form.declaredValue * 0.01;\n      if (form.needPackaging) basePrice += totalWeight * 20;\n      \n      return {\n        company: '–ü–≠–ö',\n        price: Math.round(basePrice),\n        days: 3,\n        details: {\n          note: '–ü—Ä–∏–º–µ—Ä–Ω—ã–π —Ä–∞—Å—á–µ—Ç –ø–æ –±–∞–∑–æ–≤—ã–º —Ç–∞—Ä–∏—Ñ–∞–º (–æ—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å API)',\n          services: [\n            { name: '–î–æ—Å—Ç–∞–≤–∫–∞ –≥—Ä—É–∑–∞', description: `${form.fromCity} - ${form.toCity}`, price: basePrice }\n          ]\n        },\n        requestData: null,\n        responseData: null,\n        apiUrl,\n        error: `–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ${error.message}. –ü–æ–∫–∞–∑–∞–Ω –ø—Ä–∏–º–µ—Ä–Ω—ã–π —Ä–∞—Å—á–µ—Ç.`\n      };\n    }\n  };",
      "newString": "  // –†–∞—Å—á–µ—Ç –¥–ª—è –ü–≠–ö —á–µ—Ä–µ–∑ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π API\n  const calculatePEK = async (): Promise<CalculationResult> => {\n    const apiUrl = 'https://kabinet.pecom.ru/api/v1/calculateprice/';\n    \n    try {\n      // –ü–æ–ª—É—á–∞–µ–º ID —Å–∫–ª–∞–¥–æ–≤ –ø–æ –≥–æ—Ä–æ–¥–∞–º\n      const senderWarehouseId = getPekWarehouseId(form.fromCity);\n      const receiverWarehouseId = getPekWarehouseId(form.toCity);\n      \n      if (!senderWarehouseId || !receiverWarehouseId) {\n        return {\n          company: '–ü–≠–ö',\n          price: 0,\n          days: 0,\n          error: `–°–∫–ª–∞–¥ –ü–≠–ö –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≥–æ—Ä–æ–¥–∞: ${!senderWarehouseId ? form.fromCity : ''} ${!receiverWarehouseId ? form.toCity : ''}`.trim(),\n          apiUrl,\n          requestData: { fromCity: form.fromCity, toCity: form.toCity },\n          responseData: null\n        };\n      }\n\n      // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞—Ç—É –∑–∞–≤—Ç—Ä–∞ –¥–ª—è –∑–∞–±–æ—Ä–∞\n      const tomorrow = new Date();\n      tomorrow.setDate(tomorrow.getDate() + 1);\n      const plannedDateTime = tomorrow.toISOString().slice(0, 19); // 2023-02-28T14:00:00\n\n      // –§–æ—Ä–º–∏—Ä—É–µ–º –º–∞—Å—Å–∏–≤ –≥—Ä—É–∑–æ–≤\n      const cargos = form.cargos.map(cargo => ({\n        length: cargo.length / 100, // –ø–µ—Ä–µ–≤–æ–¥–∏–º —Å–º –≤ –º–µ—Ç—Ä—ã\n        width: cargo.width / 100,\n        height: cargo.height / 100,\n        volume: (cargo.length * cargo.width * cargo.height) / 1000000, // –º3\n        weight: cargo.weight,\n        isHP: form.needPackaging, // –∑–∞—â–∏—Ç–Ω–∞—è —É–ø–∞–∫–æ–≤–∫–∞\n        sealingPositionsCount: 0\n      }));\n\n      // –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –∫ API –ü–≠–ö\n      const requestData = {\n        currencyCode: \"643\", // —Ä—É–±–ª–∏\n        types: [3], // —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ –ø–µ—Ä–µ–≤–æ–∑–∫–∞\n        senderWarehouseId,\n        receiverWarehouseId,\n        isOpenCarSender: false,\n        isOpenCarReceiver: false,\n        isHyperMarket: false,\n        plannedDateTime,\n        isInsurance: form.needInsurance && form.declaredValue > 0,\n        isInsurancePrice: form.needInsurance ? form.declaredValue : 0,\n        isPickUp: form.fromAddressDelivery,\n        isDelivery: form.toAddressDelivery,\n        needReturnDocuments: false,\n        needArrangeTransportationDocuments: false,\n        senderDistanceType: 0,\n        receiverDistanceType: 0,\n        cargos\n      };\n\n      // –î–æ–±–∞–≤–ª—è–µ–º —É—Å–ª—É–≥–∏ –ü–†–† –µ—Å–ª–∏ –Ω—É–∂–Ω–æ\n      if (form.needCarry) {\n        requestData.pickupServices = {\n          isLoading: true,\n          floor: 0,\n          carryingDistance: 0,\n          isElevator: false\n        };\n        requestData.deliveryServices = {\n          isLoading: true,\n          floor: 0,\n          carryingDistance: 0,\n          isElevator: false\n        };\n      }\n\n      // –î–æ–±–∞–≤–ª—è–µ–º –∞–¥—Ä–µ—Å–∞ –µ—Å–ª–∏ –Ω—É–∂–Ω–∞ –¥–æ—Å—Ç–∞–≤–∫–∞\n      if (form.fromAddressDelivery) {\n        requestData.pickup = {\n          address: form.fromAddress || `–†–æ—Å—Å–∏—è, ${form.fromCity}`\n        };\n      }\n      \n      if (form.toAddressDelivery) {\n        requestData.delivery = {\n          address: form.toAddress || `–†–æ—Å—Å–∏—è, ${form.toCity}`\n        };\n      }\n\n      console.log('üöÄ –ü–≠–ö API –∑–∞–ø—Ä–æ—Å:', requestData);\n\n      const response = await fetch(apiUrl, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json;charset=utf-8',\n          'Accept': 'application/json',\n          'Authorization': `Bearer 624FC93CA677B23673BB476D4982294DC27E246F`\n        },\n        body: JSON.stringify(requestData)\n      });\n\n      const data = await response.json();\n      console.log('üöÄ –ü–≠–ö API –æ—Ç–≤–µ—Ç:', data);\n\n      if (response.ok && !data.hasError && data.transfers && data.transfers.length > 0) {\n        const transfer = data.transfers[0]; // –±–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π —Ç–∞—Ä–∏—Ñ (–∞–≤—Ç–æ)\n        \n        if (!transfer.hasError) {\n          // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É —É—Å–ª—É–≥\n          const services = [];\n          let totalCalculated = 0;\n\n          const processServices = (servicesList: any[], parentName = '') => {\n            servicesList.forEach(service => {\n              const serviceName = parentName ? `${parentName} - ${service.info}` : service.info;\n              const serviceCost = parseFloat(service.cost) || 0;\n              \n              if (serviceCost > 0) {\n                services.push({\n                  name: serviceName,\n                  description: service.serviceType,\n                  price: serviceCost\n                });\n                totalCalculated += serviceCost;\n              }\n\n              // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤–ª–æ–∂–µ–Ω–Ω—ã–µ —É—Å–ª—É–≥–∏\n              if (service.services && Array.isArray(service.services)) {\n                processServices(service.services, serviceName);\n              }\n            });\n          };\n\n          if (transfer.services) {\n            processServices(transfer.services);\n          }\n\n          return {\n            company: '–ü–≠–ö',\n            price: Math.round(transfer.costTotal),\n            days: transfer.estDeliveryTime || 3,\n            details: {\n              note: `–î–æ—Å—Ç–∞–≤–∫–∞ ${form.fromCity} - ${form.toCity} (—Ç–∞—Ä–∏—Ñ ${transfer.type})`,\n              services: services.length > 0 ? services : [\n                {\n                  name: '–î–æ—Å—Ç–∞–≤–∫–∞ –≥—Ä—É–∑–∞',\n                  description: `${form.fromCity} - ${form.toCity}`,\n                  price: Math.round(transfer.costTotal)\n                }\n              ]\n            },\n            requestData,\n            responseData: data,\n            apiUrl\n          };\n        } else {\n          throw new Error(transfer.errorMessage || '–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ —Ç–∞—Ä–∏—Ñ–∞ –ü–≠–ö');\n        }\n      } else {\n        throw new Error(data.errorMessage || '–û—à–∏–±–∫–∞ API –ü–≠–ö');\n      }\n      \n    } catch (error: any) {\n      console.error('üö® –û—à–∏–±–∫–∞ –ü–≠–ö API:', error);\n      \n      // –§–æ–ª–ª–±—ç–∫ —Ä–∞—Å—á–µ—Ç –ø—Ä–∏ –æ—à–∏–±–∫–µ\n      const totalWeight = form.cargos.reduce((sum, cargo) => sum + cargo.weight, 0);\n      let basePrice = totalWeight * 18; // 18 —Ä—É–± –∑–∞ –∫–≥ –¥–ª—è –ü–≠–ö\n      \n      if (form.fromAddressDelivery) basePrice += 600;\n      if (form.toAddressDelivery) basePrice += 600;\n      if (form.needInsurance && form.declaredValue > 0) basePrice += form.declaredValue * 0.012;\n      if (form.needPackaging) basePrice += totalWeight * 25;\n      if (form.needCarry) basePrice += 500;\n      \n      return {\n        company: '–ü–≠–ö',\n        price: Math.round(basePrice),\n        days: 3,\n        details: {\n          note: '–ü—Ä–∏–º–µ—Ä–Ω—ã–π —Ä–∞—Å—á–µ—Ç –ø–æ –±–∞–∑–æ–≤—ã–º —Ç–∞—Ä–∏—Ñ–∞–º –ü–≠–ö (–æ—à–∏–±–∫–∞ API)',\n          services: [\n            {\n              name: '–î–æ—Å—Ç–∞–≤–∫–∞ –≥—Ä—É–∑–∞',\n              description: `${form.fromCity} - ${form.toCity}`,\n              price: Math.round(basePrice)\n            }\n          ]\n        },\n        requestData: null,\n        responseData: null,\n        apiUrl,\n        error: `–û—à–∏–±–∫–∞ API –ü–≠–ö: ${error.message}. –ü–æ–∫–∞–∑–∞–Ω –ø—Ä–∏–º–µ—Ä–Ω—ã–π —Ä–∞—Å—á–µ—Ç.`\n      };\n    }\n  };"
    },
    "output": "",
    "metadata": {
      "diagnostics": {},
      "diff": "Index: /home/user/project/app/page.tsx\n===================================================================\n--- /home/user/project/app/page.tsx\n+++ /home/user/project/app/page.tsx\n@@ -897,40 +897,200 @@\n };\n   }\n };\n \n-// –ü–æ–ª—É—á–µ–Ω–∏–µ ID –≥–æ—Ä–æ–¥–∞ –ü–≠–ö\n-const findPekCityId = async (cityName: string): Promise<string | null> => {\n+// –†–∞—Å—á–µ—Ç –¥–ª—è –ü–≠–ö —á–µ—Ä–µ–∑ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π API\n+const calculatePEK = async (): Promise<CalculationResult> => {\n+  const apiUrl = 'https://kabinet.pecom.ru/api/v1/calculateprice/';\n+  \n   try {\n-    const pekCities = await loadPekCities();\n+    // –ü–æ–ª—É—á–∞–µ–º ID —Å–∫–ª–∞–¥–æ–≤ –ø–æ –≥–æ—Ä–æ–¥–∞–º\n+    const senderWarehouseId = getPekWarehouseId(form.fromCity);\n+    const receiverWarehouseId = getPekWarehouseId(form.toCity);\n     \n-    const normalizedSearchCity = cityName.toLowerCase().trim()\n-      .replace(/—ë/g, '–µ')\n-      .replace(/[\\s\\-\\.–≥\\.]+/g, '')\n-      .replace(/–æ–±–ª–∞—Å—Ç—å|–æ–±–ª|–∫—Ä–∞–π|—Ä–µ—Å–ø—É–±–ª–∏–∫–∞|—Ä–µ—Å–ø|–∞–≤—Ç–æ–Ω–æ–º–Ω—ã–π –æ–∫—Ä—É–≥|–∞–æ/g, '');\n+    if (!senderWarehouseId || !receiverWarehouseId) {\n+      return {\n+        company: '–ü–≠–ö',\n+        price: 0,\n+        days: 0,\n+        error: `–°–∫–ª–∞–¥ –ü–≠–ö –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≥–æ—Ä–æ–¥–∞: ${!senderWarehouseId ? form.fromCity : ''} ${!receiverWarehouseId ? form.toCity : ''}`.trim(),\n+        apiUrl,\n+        requestData: { fromCity: form.fromCity, toCity: form.toCity },\n+        responseData: null\n+      };\n+    }\n \n-    console.log(`–ü–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–∞ –ü–≠–ö: \"${cityName}\" -> \"${normalizedSearchCity}\"`);\n+    // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞—Ç—É –∑–∞–≤—Ç—Ä–∞ –¥–ª—è –∑–∞–±–æ—Ä–∞\n+    const tomorrow = new Date();\n+    tomorrow.setDate(tomorrow.getDate() + 1);\n+    const plannedDateTime = tomorrow.toISOString().slice(0, 19); // 2023-02-28T14:00:00\n \n-    // –ü—Ä—è–º–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ\n-    if (pekCities[normalizedSearchCity]) {\n-      console.log(`–ù–∞–π–¥–µ–Ω –ø—Ä—è–º–æ–π ID –¥–ª—è \"${normalizedSearchCity}\": ${pekCities[normalizedSearchCity]}`);\n-      return pekCities[normalizedSearchCity];\n+    // –§–æ—Ä–º–∏—Ä—É–µ–º –º–∞—Å—Å–∏–≤ –≥—Ä—É–∑–æ–≤\n+    const cargos = form.cargos.map(cargo => ({\n+      length: cargo.length / 100, // –ø–µ—Ä–µ–≤–æ–¥–∏–º —Å–º –≤ –º–µ—Ç—Ä—ã\n+      width: cargo.width / 100,\n+      height: cargo.height / 100,\n+      volume: (cargo.length * cargo.width * cargo.height) / 1000000, // –º3\n+      weight: cargo.weight,\n+      isHP: form.needPackaging, // –∑–∞—â–∏—Ç–Ω–∞—è —É–ø–∞–∫–æ–≤–∫–∞\n+      sealingPositionsCount: 0\n+    }));\n+\n+    // –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –∫ API –ü–≠–ö\n+    const requestData = {\n+      currencyCode: \"643\", // —Ä—É–±–ª–∏\n+      types: [3], // —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ –ø–µ—Ä–µ–≤–æ–∑–∫–∞\n+      senderWarehouseId,\n+      receiverWarehouseId,\n+      isOpenCarSender: false,\n+      isOpenCarReceiver: false,\n+      isHyperMarket: false,\n+      plannedDateTime,\n+      isInsurance: form.needInsurance && form.declaredValue > 0,\n+      isInsurancePrice: form.needInsurance ? form.declaredValue : 0,\n+      isPickUp: form.fromAddressDelivery,\n+      isDelivery: form.toAddressDelivery,\n+      needReturnDocuments: false,\n+      needArrangeTransportationDocuments: false,\n+      senderDistanceType: 0,\n+      receiverDistanceType: 0,\n+      cargos\n+    };\n+\n+    // –î–æ–±–∞–≤–ª—è–µ–º —É—Å–ª—É–≥–∏ –ü–†–† –µ—Å–ª–∏ –Ω—É–∂–Ω–æ\n+    if (form.needCarry) {\n+      requestData.pickupServices = {\n+        isLoading: true,\n+        floor: 0,\n+        carryingDistance: 0,\n+        isElevator: false\n+      };\n+      requestData.deliveryServices = {\n+        isLoading: true,\n+        floor: 0,\n+        carryingDistance: 0,\n+        isElevator: false\n+      };\n     }\n \n-    // –ü–æ–∏—Å–∫ –ø–æ —á–∞—Å—Ç–∏—á–Ω–æ–º—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é\n-    for (const [cityKey, cityId] of Object.entries(pekCities)) {\n-      if (normalizedSearchCity.includes(cityKey) || \n-          cityKey.includes(normalizedSearchCity)) {\n-        console.log(`–ù–∞–π–¥–µ–Ω —á–∞—Å—Ç–∏—á–Ω—ã–π ID –¥–ª—è \"${normalizedSearchCity}\" —á–µ—Ä–µ–∑ \"${cityKey}\": ${cityId}`);\n-        return cityId;\n-      }\n+    // –î–æ–±–∞–≤–ª—è–µ–º –∞–¥—Ä–µ—Å–∞ –µ—Å–ª–∏ –Ω—É–∂–Ω–∞ –¥–æ—Å—Ç–∞–≤–∫–∞\n+    if (form.fromAddressDelivery) {\n+      requestData.pickup = {\n+        address: form.fromAddress || `–†–æ—Å—Å–∏—è, ${form.fromCity}`\n+      };\n     }\n+    \n+    if (form.toAddressDelivery) {\n+      requestData.delivery = {\n+        address: form.toAddress || `–†–æ—Å—Å–∏—è, ${form.toCity}`\n+      };\n+    }\n \n-    console.log(`–ì–æ—Ä–æ–¥ –ü–≠–ö \"${cityName}\" –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ`);\n-    return null;\n-  } catch (error) {\n-    console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –≥–æ—Ä–æ–¥–∞ –ü–≠–ö:', error);\n-    return null;\n+    console.log('üöÄ –ü–≠–ö API –∑–∞–ø—Ä–æ—Å:', requestData);\n+\n+    const response = await fetch(apiUrl, {\n+      method: 'POST',\n+      headers: {\n+        'Content-Type': 'application/json;charset=utf-8',\n+        'Accept': 'application/json',\n+        'Authorization': `Bearer 624FC93CA677B23673BB476D4982294DC27E246F`\n+      },\n+      body: JSON.stringify(requestData)\n+    });\n+\n+    const data = await response.json();\n+    console.log('üöÄ –ü–≠–ö API –æ—Ç–≤–µ—Ç:', data);\n+\n+    if (response.ok && !data.hasError && data.transfers && data.transfers.length > 0) {\n+      const transfer = data.transfers[0]; // –±–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π —Ç–∞—Ä–∏—Ñ (–∞–≤—Ç–æ)\n+      \n+      if (!transfer.hasError) {\n+        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É —É—Å–ª—É–≥\n+        const services = [];\n+        let totalCalculated = 0;\n+\n+        const processServices = (servicesList: any[], parentName = '') => {\n+          servicesList.forEach(service => {\n+            const serviceName = parentName ? `${parentName} - ${service.info}` : service.info;\n+            const serviceCost = parseFloat(service.cost) || 0;\n+            \n+            if (serviceCost > 0) {\n+              services.push({\n+                name: serviceName,\n+                description: service.serviceType,\n+                price: serviceCost\n+              });\n+              totalCalculated += serviceCost;\n+            }\n+\n+            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤–ª–æ–∂–µ–Ω–Ω—ã–µ —É—Å–ª—É–≥–∏\n+            if (service.services && Array.isArray(service.services)) {\n+              processServices(service.services, serviceName);\n+            }\n+          });\n+        };\n+\n+        if (transfer.services) {\n+          processServices(transfer.services);\n+        }\n+\n+        return {\n+          company: '–ü–≠–ö',\n+          price: Math.round(transfer.costTotal),\n+          days: transfer.estDeliveryTime || 3,\n+          details: {\n+            note: `–î–æ—Å—Ç–∞–≤–∫–∞ ${form.fromCity} - ${form.toCity} (—Ç–∞—Ä–∏—Ñ ${transfer.type})`,\n+            services: services.length > 0 ? services : [\n+              {\n+                name: '–î–æ—Å—Ç–∞–≤–∫–∞ –≥—Ä—É–∑–∞',\n+                description: `${form.fromCity} - ${form.toCity}`,\n+                price: Math.round(transfer.costTotal)\n+              }\n+            ]\n+          },\n+          requestData,\n+          responseData: data,\n+          apiUrl\n+        };\n+      } else {\n+        throw new Error(transfer.errorMessage || '–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ —Ç–∞—Ä–∏—Ñ–∞ –ü–≠–ö');\n+      }\n+    } else {\n+      throw new Error(data.errorMessage || '–û—à–∏–±–∫–∞ API –ü–≠–ö');\n+    }\n+    \n+  } catch (error: any) {\n+    console.error('üö® –û—à–∏–±–∫–∞ –ü–≠–ö API:', error);\n+    \n+    // –§–æ–ª–ª–±—ç–∫ —Ä–∞—Å—á–µ—Ç –ø—Ä–∏ –æ—à–∏–±–∫–µ\n+    const totalWeight = form.cargos.reduce((sum, cargo) => sum + cargo.weight, 0);\n+    let basePrice = totalWeight * 18; // 18 —Ä—É–± –∑–∞ –∫–≥ –¥–ª—è –ü–≠–ö\n+    \n+    if (form.fromAddressDelivery) basePrice += 600;\n+    if (form.toAddressDelivery) basePrice += 600;\n+    if (form.needInsurance && form.declaredValue > 0) basePrice += form.declaredValue * 0.012;\n+    if (form.needPackaging) basePrice += totalWeight * 25;\n+    if (form.needCarry) basePrice += 500;\n+    \n+    return {\n+      company: '–ü–≠–ö',\n+      price: Math.round(basePrice),\n+      days: 3,\n+      details: {\n+        note: '–ü—Ä–∏–º–µ—Ä–Ω—ã–π —Ä–∞—Å—á–µ—Ç –ø–æ –±–∞–∑–æ–≤—ã–º —Ç–∞—Ä–∏—Ñ–∞–º –ü–≠–ö (–æ—à–∏–±–∫–∞ API)',\n+        services: [\n+          {\n+            name: '–î–æ—Å—Ç–∞–≤–∫–∞ –≥—Ä—É–∑–∞',\n+            description: `${form.fromCity} - ${form.toCity}`,\n+            price: Math.round(basePrice)\n+          }\n+        ]\n+      },\n+      requestData: null,\n+      responseData: null,\n+      apiUrl,\n+      error: `–û—à–∏–±–∫–∞ API –ü–≠–ö: ${error.message}. –ü–æ–∫–∞–∑–∞–Ω –ø—Ä–∏–º–µ—Ä–Ω—ã–π —Ä–∞—Å—á–µ—Ç.`\n+    };\n   }\n };\n \n // –ü–æ–ª—É—á–µ–Ω–∏–µ ID —Å–∫–ª–∞–¥–∞ –ü–≠–ö –ø–æ –∞–¥—Ä–µ—Å—É —á–µ—Ä–µ–∑ API\n"
    },
    "title": "app/page.tsx",
    "time": {
      "start": 1758902761572,
      "end": 1758902761610
    }
  }
}