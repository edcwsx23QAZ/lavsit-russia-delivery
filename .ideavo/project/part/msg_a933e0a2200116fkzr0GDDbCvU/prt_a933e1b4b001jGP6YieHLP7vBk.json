{
  "id": "prt_a933e1b4b001jGP6YieHLP7vBk",
  "sessionID": "ses_6852784ecffeuHwynj83p2lr14",
  "messageID": "msg_a933e0a2200116fkzr0GDDbCvU",
  "type": "tool",
  "callID": "call_30372809",
  "tool": "read",
  "state": {
    "status": "completed",
    "input": {
      "filePath": "app/api/kit/route.ts"
    },
    "output": "<file>\n00001| import { NextRequest, NextResponse } from 'next/server';\n00002| import { apiRequestWithTimeout, PerformanceMonitor } from '@/lib/api-utils';\n00003| \n00004| const KIT_API_URL = 'https://capi.tk-kit.com';\n00005| const KIT_TOKEN = process.env.KIT_API_TOKEN || '';\n00006| \n00007| async function searchCityByName(cityName: string): Promise<any> {\n00008|   try {\n00009|     const response = await apiRequestWithTimeout(\n00010|       `${KIT_API_URL}/1.1/tdd/search/by-name`,\n00011|       {\n00012|         method: 'POST',\n00013|         headers: {\n00014|           'Content-Type': 'application/json',\n00015|           'Authorization': `Bearer ${KIT_TOKEN}`\n00016|         },\n00017|         body: JSON.stringify({ title: cityName })\n00018|       },\n00019|       { timeout: 8000, retries: 1 }\n00020|     );\n00021| \n00022|     if (!response.ok) {\n00023|       console.error(`–ö–ò–¢ –ø–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–∞ ${cityName} –Ω–µ—É—Å–ø–µ—à–µ–Ω: ${response.status}`);\n00024|       return null;\n00025|     }\n00026| \n00027|     const data = await response.json();\n00028|     if (data && data.length > 0) {\n00029|       return data[0];\n00030|     }\n00031| \n00032|     return null;\n00033|   } catch (error) {\n00034|     console.error(`–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –≥–æ—Ä–æ–¥–∞ ${cityName}:`, error);\n00035|     return null;\n00036|   }\n00037| }\n00038| \n00039| export async function POST(request: NextRequest) {\n00040|   const endTiming = PerformanceMonitor.startMeasurement('kit_api_total');\n00041|   \n00042|   try {\n00043|     const body = await request.json();\n00044|     \n00045|     console.log('üöõ –ö–ò–¢ API –∑–∞–ø—Ä–æ—Å:', JSON.stringify(body, null, 2));\n00046| \n00047|     const fromCity = await searchCityByName(body.from_city || '–ú–æ—Å–∫–≤–∞');\n00048|     const toCity = await searchCityByName(body.to_city || '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥');\n00049| \n00050|     if (!fromCity || !toCity) {\n00051|       return NextResponse.json({\n00052|         success: false,\n00053|         error: '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–æ–¥—ã –≥–æ—Ä–æ–¥–æ–≤',\n00054|         details: {\n00055|           fromCity: body.from_city,\n00056|           toCity: body.to_city,\n00057|           fromCityCode: fromCity?.code,\n00058|           toCityCode: toCity?.code\n00059|         }\n00060|       }, { status: 400 });\n00061|     }\n00062| \n00063|     console.log('üöõ –ö–ò–¢ –∫–æ–¥—ã –≥–æ—Ä–æ–¥–æ–≤:', {\n00064|       from: fromCity.code,\n00065|       to: toCity.code\n00066|     });\n00067| \n00068|     const requestData = {\n00069|       city_pickup_code: fromCity.code,\n00070|       city_delivery_code: toCity.code,\n00071|       declared_price: body.declared_price || 10000,\n00072|       post_type: '02',\n00073|       currency_code: ['RUB']\n00074|     };\n00075| \n00076|     if (body.declared_price >= 10000) {\n00077|       requestData['insurance'] = '1';\n00078|       requestData['insurance_agent_code'] = '8000152423';\n00079|     }\n00080| \n00081|     if (body.service && body.service.length > 0) {\n00082|       requestData['service'] = body.service;\n00083|     }\n00084| \n00085|     console.log('üöõ –ö–ò–¢ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –∑–∞–ø—Ä–æ—Å:', JSON.stringify(requestData, null, 2));\n00086| \n00087|     const response = await apiRequestWithTimeout(\n00088|       `${KIT_API_URL}/1.0/order/calculate-post`,\n00089|       {\n00090|         method: 'POST',\n00091|         headers: {\n00092|           'Content-Type': 'application/json',\n00093|           'Authorization': `Bearer ${KIT_TOKEN}`\n00094|         },\n00095|         body: JSON.stringify(requestData)\n00096|       },\n00097|       { timeout: 12000, retries: 1 }\n00098|     );\n00099| \n00100|     console.log(`üöõ –ö–ò–¢ API —Å—Ç–∞—Ç—É—Å: ${response.status} ${response.statusText}`);\n00101| \n00102|     if (!response.ok) {\n00103|       const errorText = await response.text();\n00104|       console.error('üöõ –ö–ò–¢ API –æ—à–∏–±–∫–∞:', errorText);\n00105|       \n00106|       return NextResponse.json({\n00107|         success: false,\n00108|         error: `API –æ—à–∏–±–∫–∞: ${response.status} ${response.statusText}`,\n00109|         details: errorText\n00110|       }, { status: response.status });\n00111|     }\n00112| \n00113|     const data = await response.json();\n00114|     console.log('üöõ –ö–ò–¢ API –æ—Ç–≤–µ—Ç:', JSON.stringify(data, null, 2));\n00115| \n00116|     if (data.name === 'Too Many Requests') {\n00117|       return NextResponse.json({\n00118|         success: false,\n00119|         error: '–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤',\n00120|         details: data\n00121|       }, { status: 429 });\n00122|     }\n00123| \n00124|     endTiming();\n00125|     return NextResponse.json(data);\n00126| \n00127|   } catch (error: any) {\n00128|     console.error('üöõ –ö–ò–¢ API –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:', error);\n00129|     endTiming();\n00130|     return NextResponse.json({\n00131|       success: false,\n00132|       error: error.message || '–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞',\n00133|       details: error.stack\n00134|     }, { status: 500 });\n00135|   }\n00136| }\n00137| \n</file>",
    "title": "app/api/kit/route.ts",
    "metadata": {
      "preview": "import { NextRequest, NextResponse } from 'next/server';\nimport { apiRequestWithTimeout, PerformanceMonitor } from '@/lib/api-utils';\n\nconst KIT_API_URL = 'https://capi.tk-kit.com';\nconst KIT_TOKEN = process.env.KIT_API_TOKEN || '';\n\nasync function searchCityByName(cityName: string): Promise<any> {\n  try {\n    const response = await apiRequestWithTimeout(\n      `${KIT_API_URL}/1.1/tdd/search/by-name`,\n      {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${KIT_TOKEN}`\n        },\n        body: JSON.stringify({ title: cityName })\n      },\n      { timeout: 8000, retries: 1 }\n    );"
    },
    "time": {
      "start": 1763406912337,
      "end": 1763406912342
    }
  }
}