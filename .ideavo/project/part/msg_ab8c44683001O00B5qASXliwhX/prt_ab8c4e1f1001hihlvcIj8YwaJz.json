{
  "id": "prt_ab8c4e1f1001hihlvcIj8YwaJz",
  "sessionID": "ses_54b97e247ffenCZZa4jZiIWD0l",
  "messageID": "msg_ab8c44683001O00B5qASXliwhX",
  "type": "tool",
  "callID": "call_2321fd48d1374e38ad2ebf29",
  "tool": "write",
  "state": {
    "status": "completed",
    "input": {
      "content": "'use client';\n\nimport React, { useState } from 'react';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { Alert, AlertDescription } from '@/components/ui/alert';\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from '@/components/ui/dialog';\nimport { Save, Download, Camera, CheckCircle, AlertCircle } from 'lucide-react';\n\ninterface SaveCalculationProps {\n  formData: any;\n  calculations: any[];\n  enabledCompanies: Record<string, boolean>;\n  onSave?: (result: any) => void;\n}\n\nexport default function SaveCalculation({ \n  formData, \n  calculations, \n  enabledCompanies, \n  onSave \n}: SaveCalculationProps) {\n  const [isOpen, setIsOpen] = useState(false);\n  const [orderNumber, setOrderNumber] = useState('');\n  const [isSaving, setIsSaving] = useState(false);\n  const [saveResult, setSaveResult] = useState<{\n    success: boolean;\n    message: string;\n    data?: any;\n  } | null>(null);\n\n  const handleSave = async () => {\n    if (!orderNumber.trim()) {\n      setSaveResult({\n        success: false,\n        message: '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞'\n      });\n      return;\n    }\n\n    setIsSaving(true);\n    setSaveResult(null);\n\n    try {\n      console.log('üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–∞—Å—á–µ—Ç–∞...', { orderNumber });\n\n      // –°–æ–∑–¥–∞–Ω–∏–µ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ\n      const screenshotResponse = await fetch('/api/screenshot', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json'\n        },\n        body: JSON.stringify({\n          formData,\n          calculations,\n          enabledCompanies\n        })\n      });\n\n      let screenshot = null;\n      if (screenshotResponse.ok) {\n        const screenshotData = await screenshotResponse.json();\n        screenshot = screenshotData.screenshot;\n      } else {\n        console.warn('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç, —Å–æ—Ö—Ä–∞–Ω—è—é –±–µ–∑ –Ω–µ–≥–æ');\n      }\n\n      // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–∞—Å—á–µ—Ç–∞ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö\n      const saveResponse = await fetch('/api/calculations', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json'\n        },\n        body: JSON.stringify({\n          orderNumber: orderNumber.trim(),\n          formData,\n          results: calculations,\n          screenshot\n        })\n      });\n\n      const result = await saveResponse.json();\n\n      if (result.success) {\n        setSaveResult({\n          success: true,\n          message: `–†–∞—Å—á–µ—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω! ID: ${result.data.id}`,\n          data: result.data\n        });\n\n        if (onSave) {\n          onSave(result.data);\n        }\n\n        // –ó–∞–∫—Ä—ã—Ç–∏–µ –¥–∏–∞–ª–æ–≥–∞ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã\n        setTimeout(() => {\n          setIsOpen(false);\n          setOrderNumber('');\n          setSaveResult(null);\n        }, 2000);\n\n      } else {\n        setSaveResult({\n          success: false,\n          message: result.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ä–∞—Å—á–µ—Ç–∞'\n        });\n      }\n\n    } catch (error: any) {\n      console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);\n      setSaveResult({\n        success: false,\n        message: `–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ${error.message}`\n      });\n    } finally {\n      setIsSaving(false);\n    }\n  };\n\n  const handleDownload = async () => {\n    try {\n      // –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Ñ–∞–π–ª–∞ —Å –¥–∞–Ω–Ω—ã–º–∏ —Ä–∞—Å—á–µ—Ç–∞\n      const calculationText = generateCalculationText();\n      \n      const blob = new Blob([calculationText], { type: 'text/plain;charset=utf-8' });\n      const url = URL.createObjectURL(blob);\n      \n      const a = document.createElement('a');\n      a.href = url;\n      a.download = `—Ä–∞—Å—á–µ—Ç-–¥–æ—Å—Ç–∞–≤–∫–∏-${orderNumber || '–±–µ–∑-–Ω–æ–º–µ—Ä–∞'}-${new Date().toISOString().split('T')[0]}.txt`;\n      document.body.appendChild(a);\n      a.click();\n      document.body.removeChild(a);\n      URL.revokeObjectURL(url);\n\n    } catch (error) {\n      console.error('‚ùå –û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è:', error);\n    }\n  };\n\n  const generateCalculationText = () => {\n    const currentDate = new Date().toLocaleString('ru-RU');\n    const validCalculations = calculations.filter(calc => \n      calc.price > 0 && enabledCompanies[calc.company.toLowerCase().replace(/\\s+/g, '')]\n    );\n\n    let text = `–†–ê–°–ß–ï–¢ –°–¢–û–ò–ú–û–°–¢–ò –î–û–°–¢–ê–í–ö–ò\\n`;\n    text += `–î–∞—Ç–∞ —Ä–∞—Å—á–µ—Ç–∞: ${currentDate}\\n`;\n    text += `–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞: ${orderNumber || '–ù–µ —É–∫–∞–∑–∞–Ω'}\\n`;\n    text += `${'='.repeat(50)}\\n\\n`;\n\n    text += `–ú–ê–†–®–†–£–¢:\\n`;\n    text += `–û—Ç–∫—É–¥–∞: ${formData.fromCity}\\n`;\n    text += `–ö—É–¥–∞: ${formData.toCity}\\n`;\n    if (formData.fromAddress) text += `–ê–¥—Ä–µ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è: ${formData.fromAddress}\\n`;\n    if (formData.toAddress) text += `–ê–¥—Ä–µ—Å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è: ${formData.toAddress}\\n`;\n    text += `\\n`;\n\n    text += `–ì–†–£–ó–´ (${formData.cargos.length} —à—Ç.):\\n`;\n    formData.cargos.forEach((cargo: any, index: number) => {\n      text += `${index + 1}. ${cargo.length}√ó${cargo.width}√ó${cargo.height} —Å–º, ${cargo.weight} –∫–≥\\n`;\n    });\n    text += `\\n`;\n\n    text += `–£–°–õ–£–ì–ò:\\n`;\n    const services = [];\n    if (formData.needPackaging) services.push('–£–ø–∞–∫–æ–≤–∫–∞');\n    if (formData.needLoading) services.push('–ü–æ–≥—Ä—É–∑–∫–∞');\n    if (formData.needCarry) services.push('–ü–µ—Ä–µ–Ω–æ—Å–∫–∞');\n    if (formData.needInsurance) services.push(`–°—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ (${formData.declaredValue}‚ÇΩ)`);\n    text += services.length > 0 ? services.join(', ') : '–ù–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —É—Å–ª—É–≥';\n    text += `\\n\\n`;\n\n    text += `–†–ï–ó–£–õ–¨–¢–ê–¢–´ –†–ê–°–ß–ï–¢–ê:\\n`;\n    text += `${'='.repeat(50)}\\n`;\n    \n    if (validCalculations.length === 0) {\n      text += '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ä–∞—Å—á–µ—Ç–æ–≤\\n';\n    } else {\n      const sortedCalculations = [...validCalculations].sort((a, b) => a.price - b.price);\n      sortedCalculations.forEach((calc, index) => {\n        text += `${index + 1}. ${calc.company}\\n`;\n        text += `   –°—Ç–æ–∏–º–æ—Å—Ç—å: ${calc.price.toLocaleString('ru-RU')} ‚ÇΩ\\n`;\n        text += `   –°—Ä–æ–∫: ${calc.days} –¥–Ω–µ–π\\n`;\n        if (calc.error) text += `   –û—à–∏–±–∫–∞: ${calc.error}\\n`;\n        text += '\\n';\n      });\n    }\n\n    return text;\n  };\n\n  return (\n    <Dialog open={isOpen} onOpenChange={setIsOpen}>\n      <DialogTrigger asChild>\n        <Button variant=\"outline\" className=\"flex items-center gap-2\">\n          <Save className=\"w-4 h-4\" />\n          –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∞—Å—á–µ—Ç\n        </Button>\n      </DialogTrigger>\n      \n      <DialogContent className=\"sm:max-w-md\">\n        <DialogHeader>\n          <DialogTitle className=\"flex items-center gap-2\">\n            <Save className=\"w-5 h-5\" />\n            –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–∞—Å—á–µ—Ç–∞\n          </DialogTitle>\n        </DialogHeader>\n        \n        <div className=\"space-y-4\">\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"orderNumber\">–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞ *</Label>\n            <Input\n              id=\"orderNumber\"\n              placeholder=\"–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞\"\n              value={orderNumber}\n              onChange={(e) => setOrderNumber(e.target.value)}\n              disabled={isSaving}\n            />\n            <p className=\"text-sm text-muted-foreground\">\n              –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Ä–∞—Å—á–µ—Ç–∞\n            </p>\n          </div>\n\n          {saveResult && (\n            <Alert className={saveResult.success ? 'border-green-200 bg-green-50' : 'border-red-200 bg-red-50'}>\n              <div className=\"flex items-center gap-2\">\n                {saveResult.success ? (\n                  <CheckCircle className=\"w-4 h-4 text-green-600\" />\n                ) : (\n                  <AlertCircle className=\"w-4 h-4 text-red-600\" />\n                )}\n                <AlertDescription className={saveResult.success ? 'text-green-800' : 'text-red-800'}>\n                  {saveResult.message}\n                </AlertDescription>\n              </div>\n            </Alert>\n          )}\n\n          <div className=\"flex gap-2 pt-4\">\n            <Button \n              onClick={handleSave} \n              disabled={isSaving || !orderNumber.trim()}\n              className=\"flex-1\"\n            >\n              {isSaving ? (\n                <>\n                  <Camera className=\"w-4 h-4 mr-2 animate-pulse\" />\n                  –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...\n                </>\n              ) : (\n                <>\n                  <Save className=\"w-4 h-4 mr-2\" />\n                  –°–æ—Ö—Ä–∞–Ω–∏—Ç—å\n                </>\n              )}\n            </Button>\n            \n            <Button \n              variant=\"outline\" \n              onClick={handleDownload}\n              disabled={!orderNumber.trim()}\n            >\n              <Download className=\"w-4 h-4 mr-2\" />\n              –°–∫–∞—á–∞—Ç—å\n            </Button>\n          </div>\n\n          <div className=\"text-xs text-muted-foreground\">\n            <p>‚Ä¢ –†–∞—Å—á–µ—Ç –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω —Å —Ç–µ–∫—É—â–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏ —Ñ–æ—Ä–º—ã</p>\n            <p>‚Ä¢ –ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω —Å–∫—Ä–∏–Ω—à–æ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏</p>\n            <p>‚Ä¢ –î–∞—Ç–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: {new Date().toLocaleDateString('ru-RU')}</p>\n          </div>\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n}",
      "filePath": "/home/user/project/components/SaveCalculation.tsx"
    },
    "output": "",
    "title": "components/SaveCalculation.tsx",
    "metadata": {
      "diagnostics": {},
      "filepath": "/home/user/project/components/SaveCalculation.tsx",
      "exists": false
    },
    "time": {
      "start": 1764036502008,
      "end": 1764036502009
    }
  }
}