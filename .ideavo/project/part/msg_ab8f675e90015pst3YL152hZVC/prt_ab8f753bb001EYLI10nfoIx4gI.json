{
  "id": "prt_ab8f753bb001EYLI10nfoIx4gI",
  "sessionID": "ses_54b97e247ffenCZZa4jZiIWD0l",
  "messageID": "msg_ab8f675e90015pst3YL152hZVC",
  "type": "tool",
  "callID": "call_cc9d13491f874dccb531c604",
  "tool": "write",
  "state": {
    "status": "completed",
    "input": {
      "filePath": "/home/user/project/components/CalculationHistory.tsx",
      "content": "'use client';\n\nimport React, { useState, useEffect } from 'react';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Badge } from '@/components/ui/badge';\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from '@/components/ui/dialog';\nimport { ScrollArea } from '@/components/ui/scroll-area';\nimport { Separator } from '@/components/ui/separator';\nimport { Alert, AlertDescription } from '@/components/ui/alert';\nimport { History, Eye, Calendar, MapPin, Package, Trash2, Download } from 'lucide-react';\n\ninterface Calculation {\n  id: string;\n  orderNumber: string | null;\n  formData: any;\n  results: any;\n  screenshot: string | null;\n  status: string;\n  createdAt: string;\n  note?: string;\n}\n\ninterface CalculationHistoryProps {\n  onLoadCalculation?: (calculation: Calculation) => void;\n}\n\nexport default function CalculationHistory({ onLoadCalculation }: CalculationHistoryProps) {\n  const [isOpen, setIsOpen] = useState(false);\n  const [calculations, setCalculations] = useState<Calculation[]>([]);\n  const [loading, setLoading] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n  const [selectedCalculation, setSelectedCalculation] = useState<Calculation | null>(null);\n  const [showDetails, setShowDetails] = useState(false);\n\n  // Загрузка истории расчетов\n  const loadCalculations = async () => {\n    setLoading(true);\n    setError(null);\n    \n    try {\n      const response = await fetch('/api/calculations');\n      const data = await response.json();\n      \n      if (data.success) {\n        setCalculations(data.data || []);\n      } else {\n        setError(data.error || 'Ошибка загрузки истории');\n      }\n    } catch (err) {\n      setError('Ошибка соединения с сервером');\n      console.error('Error loading calculations:', err);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  // Загрузка при открытии диалога\n  useEffect(() => {\n    if (isOpen) {\n      loadCalculations();\n    }\n  }, [isOpen]);\n\n  // Форматирование даты\n  const formatDate = (dateString: string) => {\n    return new Date(dateString).toLocaleString('ru-RU', {\n      day: '2-digit',\n      month: '2-digit',\n      year: 'numeric',\n      hour: '2-digit',\n      minute: '2-digit'\n    });\n  };\n\n  // Получение информации о маршруте\n  const getRouteInfo = (formData: any) => {\n    return `${formData.fromCity || 'Не указано'} → ${formData.toCity || 'Не указано'}`;\n  };\n\n  // Получение количества грузов\n  const getCargoCount = (formData: any) => {\n    return formData.cargos?.filter((cargo: any) => \n      cargo.length > 0 || cargo.width > 0 || cargo.height > 0 || cargo.weight > 0\n    ).length || 0;\n  };\n\n  // Получение лучшей цены\n  const getBestPrice = (results: any[]) => {\n    if (!results || results.length === 0) return null;\n    \n    const validResults = results.filter((result: any) => !result.error && result.price > 0);\n    if (validResults.length === 0) return null;\n    \n    return Math.min(...validResults.map((result: any) => result.price));\n  };\n\n  // Получение количества компаний с результатами\n  const getResultsCount = (results: any[]) => {\n    if (!results) return 0;\n    return results.filter((result: any) => !result.error).length;\n  };\n\n  return (\n    <Dialog open={isOpen} onOpenChange={setIsOpen}>\n      <DialogTrigger asChild>\n        <Button variant=\"outline\" className=\"flex items-center gap-2 text-black\">\n          <History className=\"w-4 h-4\" />\n          История расчетов\n        </Button>\n      </DialogTrigger>\n      \n      <DialogContent className=\"sm:max-w-4xl max-h-[80vh]\">\n        <DialogHeader>\n          <DialogTitle className=\"flex items-center gap-2\">\n            <History className=\"w-5 h-5\" />\n            История расчетов\n          </DialogTitle>\n        </DialogHeader>\n        \n        <div className=\"space-y-4\">\n          {error && (\n            <Alert className=\"border-red-200 bg-red-50\">\n              <AlertDescription className=\"text-red-800\">\n                {error}\n              </AlertDescription>\n            </Alert>\n          )}\n\n          {loading ? (\n            <div className=\"flex justify-center py-8\">\n              <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600\"></div>\n            </div>\n          ) : calculations.length === 0 ? (\n            <div className=\"text-center py-8 text-gray-500\">\n              <History className=\"w-12 h-12 mx-auto mb-4 opacity-50\" />\n              <p>Сохраненных расчетов пока нет</p>\n              <p className=\"text-sm\">Сделайте расчет и сохраните его, чтобы увидеть здесь</p>\n            </div>\n          ) : (\n            <ScrollArea className=\"h-[60vh]\">\n              <div className=\"space-y-3\">\n                {calculations.map((calc) => (\n                  <Card key={calc.id} className=\"hover:shadow-md transition-shadow\">\n                    <CardHeader className=\"pb-2\">\n                      <div className=\"flex justify-between items-start\">\n                        <div className=\"space-y-1\">\n                          <CardTitle className=\"text-sm flex items-center gap-2\">\n                            {calc.orderNumber ? (\n                              <Badge variant=\"default\" className=\"text-xs\">\n                                #{calc.orderNumber}\n                              </Badge>\n                            ) : (\n                              <Badge variant=\"outline\" className=\"text-xs\">\n                                Без номера\n                              </Badge>\n                            )}\n                            <span className=\"font-normal text-gray-600\">\n                              {formatDate(calc.createdAt)}\n                            </span>\n                          </CardTitle>\n                          <div className=\"flex items-center gap-4 text-xs text-gray-600\">\n                            <div className=\"flex items-center gap-1\">\n                              <MapPin className=\"w-3 h-3\" />\n                              <span>{getRouteInfo(calc.formData)}</span>\n                            </div>\n                            <div className=\"flex items-center gap-1\">\n                              <Package className=\"w-3 h-3\" />\n                              <span>{getCargoCount(calc.formData)} груз(ов)</span>\n                            </div>\n                          </div>\n                        </div>\n                        \n                        <div className=\"text-right\">\n                          {getBestPrice(calc.results) && (\n                            <div className=\"text-lg font-bold text-green-600\">\n                              {getBestPrice(calc.results)?.toLocaleString()} ₽\n                            </div>\n                          )}\n                          <div className=\"text-xs text-gray-500\">\n                            {getResultsCount(calc.results)} из {calc.results?.length || 0} компаний\n                          </div>\n                        </div>\n                      </div>\n                    </CardHeader>\n                    \n                    <CardContent className=\"pt-0\">\n                      <div className=\"flex gap-2 flex-wrap\">\n                        <Button\n                          variant=\"outline\"\n                          size=\"sm\"\n                          onClick={() => {\n                            setSelectedCalculation(calc);\n                            setShowDetails(true);\n                          }}\n                          className=\"h-8 text-xs\"\n                        >\n                          <Eye className=\"w-3 h-3 mr-1\" />\n                          Подробнее\n                        </Button>\n                        \n                        {onLoadCalculation && (\n                          <Button\n                            variant=\"outline\"\n                            size=\"sm\"\n                            onClick={() => {\n                              onLoadCalculation(calc);\n                              setIsOpen(false);\n                            }}\n                            className=\"h-8 text-xs\"\n                          >\n                            <Package className=\"w-3 h-3 mr-1\" />\n                            Загрузить\n                          </Button>\n                        )}\n                        \n                        {calc.screenshot && (\n                          <Button\n                            variant=\"outline\"\n                            size=\"sm\"\n                            onClick={() => {\n                              const link = document.createElement('a');\n                              link.href = calc.screenshot!;\n                              link.download = `calculation_${calc.orderNumber || calc.id}.jpg`;\n                              link.click();\n                            }}\n                            className=\"h-8 text-xs\"\n                          >\n                            <Download className=\"w-3 h-3 mr-1\" />\n                            Скриншот\n                          </Button>\n                        )}\n                      </div>\n                    </CardContent>\n                  </Card>\n                ))}\n              </div>\n            </ScrollArea>\n          )}\n\n          {calculations.length > 0 && (\n            <div className=\"text-xs text-gray-500 text-center\">\n              {calculations.length} сохраненных расчетов\n              {calculations.some(calc => calc.note) && ' (сохранено в памяти)'}\n            </div>\n          )}\n        </div>\n      </DialogContent>\n\n      {/* Диалог с деталями расчета */}\n      <Dialog open={showDetails} onOpenChange={setShowDetails}>\n        <DialogContent className=\"sm:max-w-2xl max-h-[80vh]\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <Eye className=\"w-5 h-5\" />\n              Детали расчета\n            </DialogTitle>\n          </DialogHeader>\n          \n          {selectedCalculation && (\n            <ScrollArea className=\"h-[60vh]\">\n              <div className=\"space-y-4\">\n                {/* Информация о расчете */}\n                <Card>\n                  <CardHeader>\n                    <CardTitle className=\"text-sm\">Информация о расчете</CardTitle>\n                  </CardHeader>\n                  <CardContent className=\"space-y-2 text-sm\">\n                    <div className=\"flex justify-between\">\n                      <span className=\"text-gray-600\">Номер заказа:</span>\n                      <span>{selectedCalculation.orderNumber || 'Без номера'}</span>\n                    </div>\n                    <div className=\"flex justify-between\">\n                      <span className=\"text-gray-600\">Дата создания:</span>\n                      <span>{formatDate(selectedCalculation.createdAt)}</span>\n                    </div>\n                    <div className=\"flex justify-between\">\n                      <span className=\"text-gray-600\">Статус:</span>\n                      <Badge variant=\"outline\">{selectedCalculation.status}</Badge>\n                    </div>\n                    {selectedCalculation.note && (\n                      <div className=\"flex justify-between\">\n                        <span className=\"text-gray-600\">Примечание:</span>\n                        <span className=\"text-xs\">{selectedCalculation.note}</span>\n                      </div>\n                    )}\n                  </CardContent>\n                </Card>\n\n                {/* Маршрут */}\n                <Card>\n                  <CardHeader>\n                    <CardTitle className=\"text-sm\">Маршрут</CardTitle>\n                  </CardHeader>\n                  <CardContent className=\"space-y-2 text-sm\">\n                    <div className=\"flex justify-between\">\n                      <span className=\"text-gray-600\">Откуда:</span>\n                      <span>{selectedCalculation.formData.fromCity}</span>\n                    </div>\n                    <div className=\"flex justify-between\">\n                      <span className=\"text-gray-600\">Куда:</span>\n                      <span>{selectedCalculation.formData.toCity}</span>\n                    </div>\n                    {selectedCalculation.formData.fromAddress && (\n                      <div className=\"flex justify-between\">\n                        <span className=\"text-gray-600\">Адрес отправления:</span>\n                        <span>{selectedCalculation.formData.fromAddress}</span>\n                      </div>\n                    )}\n                    {selectedCalculation.formData.toAddress && (\n                      <div className=\"flex justify-between\">\n                        <span className=\"text-gray-600\">Адрес доставки:</span>\n                        <span>{selectedCalculation.formData.toAddress}</span>\n                      </div>\n                    )}\n                  </CardContent>\n                </Card>\n\n                {/* Грузы */}\n                <Card>\n                  <CardHeader>\n                    <CardTitle className=\"text-sm\">Грузы ({getCargoCount(selectedCalculation.formData)})</CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"space-y-2\">\n                      {selectedCalculation.formData.cargos\n                        .filter((cargo: any) => \n                          cargo.length > 0 || cargo.width > 0 || cargo.height > 0 || cargo.weight > 0\n                        )\n                        .map((cargo: any, index: number) => (\n                          <div key={index} className=\"flex justify-between text-sm p-2 bg-gray-50 rounded\">\n                            <span>Груз {index + 1}</span>\n                            <span>\n                              {cargo.length}×{cargo.width}×{cargo.height} см, {cargo.weight} кг\n                            </span>\n                          </div>\n                        ))}\n                    </div>\n                  </CardContent>\n                </Card>\n\n                {/* Результаты расчета */}\n                <Card>\n                  <CardHeader>\n                    <CardTitle className=\"text-sm\">Результаты расчета</CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"space-y-2\">\n                      {selectedCalculation.results.map((result: any, index: number) => (\n                        <div key={index} className=\"flex justify-between items-center p-2 bg-gray-50 rounded\">\n                          <div>\n                            <div className=\"font-medium text-sm\">{result.company}</div>\n                            {result.error && (\n                              <div className=\"text-xs text-red-600\">{result.error}</div>\n                            )}\n                          </div>\n                          <div className=\"text-right\">\n                            {!result.error && (\n                              <>\n                                <div className=\"font-bold text-sm\">{result.price.toLocaleString()} ₽</div>\n                                <div className=\"text-xs text-gray-600\">{result.days} дней</div>\n                              </>\n                            )}\n                          </div>\n                        </div>\n                      ))}\n                    </div>\n                  </CardContent>\n                </Card>\n\n                {/* Скриншот */}\n                {selectedCalculation.screenshot && (\n                  <Card>\n                    <CardHeader>\n                      <CardTitle className=\"text-sm\">Скриншот расчета</CardTitle>\n                    </CardHeader>\n                    <CardContent>\n                      <img \n                        src={selectedCalculation.screenshot} \n                        alt=\"Скриншот расчета\"\n                        className=\"w-full rounded border\"\n                      />\n                    </CardContent>\n                  </Card>\n                )}\n              </div>\n            </ScrollArea>\n          )}\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}"
    },
    "output": "",
    "title": "components/CalculationHistory.tsx",
    "metadata": {
      "diagnostics": {},
      "filepath": "/home/user/project/components/CalculationHistory.tsx",
      "exists": false
    },
    "time": {
      "start": 1764039807949,
      "end": 1764039807951
    }
  }
}