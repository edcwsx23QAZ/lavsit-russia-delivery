{
  "id": "prt_ab479e0c7001TwNjTg4j9okAW3",
  "sessionID": "ses_54b97e247ffenCZZa4jZiIWD0l",
  "messageID": "msg_ab479d0b00013uqH9abWpH1zdA",
  "type": "tool",
  "callID": "call_8aabb1f172be451f80f1eb16",
  "tool": "read",
  "state": {
    "status": "completed",
    "input": {
      "filePath": "/home/user/project/lib/cache-manager.ts"
    },
    "output": "<file>\n00001| // –°–∏—Å—Ç–µ–º–∞ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è API —Å–µ—Å—Å–∏–π –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ä–∞—Å—á–µ—Ç–æ–≤\n00002| \n00003| interface CacheEntry<T> {\n00004|   data: T;\n00005|   timestamp: number;\n00006|   expires: number;\n00007| }\n00008| \n00009| interface SessionCache {\n00010|   token: string | null;\n00011|   timestamp: number;\n00012|   expires: number;\n00013| }\n00014| \n00015| interface CalculationCacheKey {\n00016|   fromCity: string;\n00017|   toCity: string;\n00018|   cargos: Array<{ length: number; width: number; height: number; weight: number }>;\n00019|   declaredValue: number;\n00020|   needPackaging: boolean;\n00021|   needInsurance: boolean;\n00022|   fromAddressDelivery: boolean;\n00023|   toAddressDelivery: boolean;\n00024|   needLoading: boolean;\n00025|   needCarry: boolean;\n00026|   floor: number;\n00027|   hasFreightLift: boolean;\n00028| }\n00029| \n00030| class CacheManager {\n00031|   private sessionCache: Map<string, SessionCache> = new Map();\n00032|   private calculationCache: Map<string, CacheEntry<any>> = new Map();\n00033|   private cityCache: Map<string, CacheEntry<any>> = new Map();\n00034| \n00035|   // –ö—ç—à —Å–µ—Å—Å–∏–π API (5 –º–∏–Ω—É—Ç)\n00036|   private readonly SESSION_TTL = 5 * 60 * 1000; // 5 –º–∏–Ω—É—Ç\n00037|   \n00038|   // –ö—ç—à —Ä–∞—Å—á–µ—Ç–æ–≤ (30 –º–∏–Ω—É—Ç)\n00039|   private readonly CALCULATION_TTL = 30 * 60 * 1000; // 30 –º–∏–Ω—É—Ç\n00040|   \n00041|   // –ö—ç—à –≥–æ—Ä–æ–¥–æ–≤ (24 —á–∞—Å–∞)\n00042|   private readonly CITY_TTL = 24 * 60 * 60 * 1000; // 24 —á–∞—Å–∞\n00043| \n00044|   // –ü–æ–ª—É—á–µ–Ω–∏–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å–µ—Å—Å–∏–∏\n00045|   getSession(company: string): string | null {\n00046|     const cache = this.sessionCache.get(company);\n00047|     if (!cache) return null;\n00048|     \n00049|     if (Date.now() > cache.expires) {\n00050|       this.sessionCache.delete(company);\n00051|       return null;\n00052|     }\n00053|     \n00054|     console.log(`üîë –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å–µ—Å—Å–∏—é –¥–ª—è ${company}`);\n00055|     return cache.token;\n00056|   }\n00057| \n00058|   // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏\n00059|   setSession(company: string, token: string): void {\n00060|     this.sessionCache.set(company, {\n00061|       token,\n00062|       timestamp: Date.now(),\n00063|       expires: Date.now() + this.SESSION_TTL\n00064|     });\n00065|     console.log(`üíæ –°–µ—Å—Å–∏—è –¥–ª—è ${company} –∑–∞–∫—ç—à–∏—Ä–æ–≤–∞–Ω–∞ –Ω–∞ ${this.SESSION_TTL / 1000}—Å`);\n00066|   }\n00067| \n00068|   // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–∞ –¥–ª—è –∫—ç—à–∞ —Ä–∞—Å—á–µ—Ç–æ–≤\n00069|   private generateCalculationKey(key: CalculationCacheKey): string {\n00070|     const sortedCargos = [...key.cargos]\n00071|       .sort((a, b) => a.length - b.length || a.width - b.width || a.height - b.height || a.weight - b.weight);\n00072|     \n00073|     return JSON.stringify({\n00074|       from: key.fromCity.toLowerCase().trim(),\n00075|       to: key.toCity.toLowerCase().trim(),\n00076|       cargos: sortedCargos,\n00077|       value: key.declaredValue,\n00078|       packaging: key.needPackaging,\n00079|       insurance: key.needInsurance,\n00080|       fromAddr: key.fromAddressDelivery,\n00081|       toAddr: key.toAddressDelivery,\n00082|       loading: key.needLoading,\n00083|       carry: key.needCarry,\n00084|       floor: key.floor,\n00085|       lift: key.hasFreightLift\n00086|     });\n00087|   }\n00088| \n00089|   // –ü–æ–ª—É—á–µ–Ω–∏–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞\n00090|   getCachedCalculation(company: string, key: CalculationCacheKey): any | null {\n00091|     const cacheKey = `${company}_${this.generateCalculationKey(key)}`;\n00092|     const cache = this.calculationCache.get(cacheKey);\n00093|     \n00094|     if (!cache) return null;\n00095|     \n00096|     if (Date.now() > cache.expires) {\n00097|       this.calculationCache.delete(cacheKey);\n00098|       return null;\n00099|     }\n00100|     \n00101|     console.log(`üí∞ –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–∞—Å—á–µ—Ç –¥–ª—è ${company}`);\n00102|     return cache.data;\n00103|   }\n00104| \n00105|   // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–∞—Å—á–µ—Ç–∞\n00106|   setCachedCalculation(company: string, key: CalculationCacheKey, result: any): void {\n00107|     const cacheKey = `${company}_${this.generateCalculationKey(key)}`;\n00108|     this.calculationCache.set(cacheKey, {\n00109|       data: result,\n00110|       timestamp: Date.now(),\n00111|       expires: Date.now() + this.CALCULATION_TTL\n00112|     });\n00113|     console.log(`üíæ –†–∞—Å—á–µ—Ç –¥–ª—è ${company} –∑–∞–∫—ç—à–∏—Ä–æ–≤–∞–Ω –Ω–∞ ${this.CALCULATION_TTL / 1000}—Å`);\n00114|   }\n00115| \n00116|   // –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≥–æ—Ä–æ–¥–æ–≤\n00117|   getCachedData(key: string): any | null {\n00118|     const cache = this.cityCache.get(key);\n00119|     if (!cache) return null;\n00120|     \n00121|     if (Date.now() > cache.expires) {\n00122|       this.cityCache.delete(key);\n00123|       return null;\n00124|     }\n00125|     \n00126|     return cache.data;\n00127|   }\n00128| \n00129|   setCachedData(key: string, data: any, ttl: number = this.CITY_TTL): void {\n00130|     this.cityCache.set(key, {\n00131|       data,\n00132|       timestamp: Date.now(),\n00133|       expires: Date.now() + ttl\n00134|     });\n00135|   }\n00136| \n00137|   // –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞\n00138|   clearCache(type?: 'sessions' | 'calculations' | 'cities' | 'all'): void {\n00139|     if (!type || type === 'all') {\n00140|       this.sessionCache.clear();\n00141|       this.calculationCache.clear();\n00142|       this.cityCache.clear();\n00143|       console.log('üßπ –í–µ—Å—å –∫—ç—à –æ—á–∏—â–µ–Ω');\n00144|       return;\n00145|     }\n00146| \n00147|     switch (type) {\n00148|       case 'sessions':\n00149|         this.sessionCache.clear();\n00150|         console.log('üßπ –ö—ç—à —Å–µ—Å—Å–∏–π –æ—á–∏—â–µ–Ω');\n00151|         break;\n00152|       case 'calculations':\n00153|         this.calculationCache.clear();\n00154|         console.log('üßπ –ö—ç—à —Ä–∞—Å—á–µ—Ç–æ–≤ –æ—á–∏—â–µ–Ω');\n00155|         break;\n00156|       case 'cities':\n00157|         this.cityCache.clear();\n00158|         console.log('üßπ –ö—ç—à –≥–æ—Ä–æ–¥–æ–≤ –æ—á–∏—â–µ–Ω');\n00159|         break;\n00160|     }\n00161|   }\n00162| \n00163|   // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∫—ç—à–∞\n00164|   getCacheStats(): {\n00165|     sessions: number;\n00166|     calculations: number;\n00167|     cities: number;\n00168|     totalMemory: number;\n00169|   } {\n00170|     const sessions = this.sessionCache.size;\n00171|     const calculations = this.calculationCache.size;\n00172|     const cities = this.cityCache.size;\n00173|     \n00174|     // –ü—Ä–∏–º–µ—Ä–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ –ø–∞–º—è—Ç–∏ –≤ –±–∞–π—Ç–∞—Ö\n00175|     const totalMemory = (sessions + calculations + cities) * 1024; // ~1KB –Ω–∞ –∑–∞–ø–∏—Å—å\n00176|     \n00177|     return {\n00178|       sessions,\n00179|       calculations,\n00180|       cities,\n00181|       totalMemory\n00182|     };\n00183|   }\n00184| \n00185|   // –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö —Å–µ—Å—Å–∏–π –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ\n00186|   async preloadAllSessions(): Promise<void> {\n00187|     console.log('üöÄ –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Å—Å–∏–π...');\n00188|     \n00189|     const sessionPromises = [\n00190|       this.preloadDellinSession(),\n00191|       this.preloadPekSession(),\n00192|       // –î–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–≥–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ –ø–æ –º–µ—Ä–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏\n00193|     ];\n00194| \n00195|     await Promise.allSettled(sessionPromises);\n00196|     console.log('‚úÖ –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Å—Å–∏–π –∑–∞–≤–µ—Ä—à–µ–Ω–∞');\n00197|   }\n00198| \n00199|   // –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Å—Å–∏–∏ –î–µ–ª–æ–≤—ã—Ö –õ–∏–Ω–∏–π\n00200|   private async preloadDellinSession(): Promise<void> {\n00201|     try {\n00202|       const cached = this.getSession('dellin');\n00203|       if (cached) return;\n00204| \n00205|       console.log('üîë –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Å—Å–∏–∏ –î–µ–ª–æ–≤—ã—Ö –õ–∏–Ω–∏–π...');\n00206|       \n00207|       const response = await fetch('https://api.dellin.ru/v3/auth/login.json', {\n00208|         method: 'POST',\n00209|         headers: { 'Content-Type': 'application/json' },\n00210|         body: JSON.stringify({\n00211|           appkey: 'E6C50E91-8E93-440F-9CC6-DEF9F0D68F1B',\n00212|           login: 'service@lavsit.ru',\n00213|           password: 'edcwsx123QAZ'\n00214|         })\n00215|       });\n00216| \n00217|       const data = await response.json();\n00218|       let sessionID = null;\n00219|       \n00220|       if (data.data?.sessionID) {\n00221|         sessionID = data.data.sessionID;\n00222|       } else if (data.sessionID) {\n00223|         sessionID = data.sessionID;\n00224|       } else if (data.data?.session) {\n00225|         sessionID = data.data.session;\n00226|       }\n00227| \n00228|       if (response.ok && sessionID) {\n00229|         this.setSession('dellin', sessionID);\n00230|         console.log('‚úÖ –°–µ—Å—Å–∏—è –î–µ–ª–æ–≤—ã—Ö –õ–∏–Ω–∏–π –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∂–µ–Ω–∞');\n00231|       }\n00232|     } catch (error) {\n00233|       console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ—Å—Å–∏–∏ –î–µ–ª–æ–≤—ã—Ö –õ–∏–Ω–∏–π:', error);\n00234|     }\n00235|   }\n00236| \n00237|   // –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Å—Å–∏–∏ –ü–≠–ö\n00238|   private async preloadPekSession(): Promise<void> {\n00239|     try {\n00240|       const cached = this.getSession('pek');\n00241|       if (cached) return;\n00242| \n00243|       console.log('üîë –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Å—Å–∏–∏ –ü–≠–ö...');\n00244|       \n00245|       // –ü–≠–ö –∏—Å–ø–æ–ª—å–∑—É–µ—Ç API –∫–ª—é—á, –Ω–µ —Ç—Ä–µ–±—É–µ—Ç —Å–µ—Å—Å–∏–∏\n00246|       // –ù–æ –º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å\n00247|       const PEK_API_KEY = process.env.PEK_API_KEY || '624FC93CA677B23673BB476D4982294DC27E246F';\n00248|       \n00249|       if (PEK_API_KEY) {\n00250|         this.setSession('pek', PEK_API_KEY);\n00251|         console.log('‚úÖ –ö–ª—é—á –ü–≠–ö –∑–∞–∫—ç—à–∏—Ä–æ–≤–∞–Ω');\n00252|       }\n00253|     } catch (error) {\n00254|       console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ—Å—Å–∏–∏ –ü–≠–ö:', error);\n00255|     }\n00256|   }\n00257| }\n00258| \n00259| // –≠–∫—Å–ø–æ—Ä—Ç —Å–∏–Ω–≥–ª—Ç–æ–Ω–∞\n00260| export const cacheManager = new CacheManager();\n00261| \n00262| // –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫—ç—à–µ–º\n00263| export const createCalculationCacheKey = (form: any): CalculationCacheKey => ({\n00264|   fromCity: form.fromCity || '',\n00265|   toCity: form.toCity || '',\n00266|   cargos: form.cargos || [],\n00267|   declaredValue: form.declaredValue || 0,\n00268|   needPackaging: form.needPackaging || false,\n00269|   needInsurance: form.needInsurance || false,\n00270|   fromAddressDelivery: form.fromAddressDelivery || false,\n00271|   toAddressDelivery: form.toAddressDelivery || false,\n00272|   needLoading: form.needLoading || false,\n00273|   needCarry: form.needCarry || false,\n00274|   floor: form.floor || 1,\n00275|   hasFreightLift: form.hasFreightLift || false\n00276| });\n00277| \n00278| export default cacheManager;\n</file>",
    "title": "lib/cache-manager.ts",
    "metadata": {
      "preview": "// –°–∏—Å—Ç–µ–º–∞ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è API —Å–µ—Å—Å–∏–π –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ä–∞—Å—á–µ—Ç–æ–≤\n\ninterface CacheEntry<T> {\n  data: T;\n  timestamp: number;\n  expires: number;\n}\n\ninterface SessionCache {\n  token: string | null;\n  timestamp: number;\n  expires: number;\n}\n\ninterface CalculationCacheKey {\n  fromCity: string;\n  toCity: string;\n  cargos: Array<{ length: number; width: number; height: number; weight: number }>;\n  declaredValue: number;\n  needPackaging: boolean;"
    },
    "time": {
      "start": 1763964477647,
      "end": 1763964477666
    }
  }
}