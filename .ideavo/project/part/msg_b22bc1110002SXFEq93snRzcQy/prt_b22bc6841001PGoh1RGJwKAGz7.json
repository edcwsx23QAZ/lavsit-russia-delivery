{
  "id": "prt_b22bc6841001PGoh1RGJwKAGz7",
  "sessionID": "ses_4ec400949ffekDUyPGFumLInaA",
  "messageID": "msg_b22bc1110002SXFEq93snRzcQy",
  "type": "tool",
  "callID": "call_67491292",
  "tool": "multiedit",
  "state": {
    "status": "completed",
    "input": {
      "edits": [
        {
          "newString": "import { NextRequest, NextResponse } from 'next/server';\nimport { enhancedApiRequest } from '@/lib/api-utils';\n\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json();\n    \n    // NordWheel API endpoint\n    const apiUrl = 'https://api.nordw.orog.ru/api/v1/calculate';\n    \n    // Get API key from environment variables or use default\n    const apiKey = process.env.NORDWHEEL_API_KEY || '5|WYpV9f788Y2ASobpv3xy6N5qxtIUaKhxFF4yWETOfc398950';\n    \n    console.log('ðŸš› NordWheel API Route: Forwarding request to:', apiUrl);\n    console.log('ðŸš› NordWheel API Route: Request body:', JSON.stringify(body, null, 2));\n    \n    // Use enhanced API request with longer timeout for NordWheel\n    const result = await enhancedApiRequest(\n      apiUrl,\n      {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${apiKey}`,\n          'User-Agent': 'DeliveryCalculator/1.0',\n          'Accept': 'application/json'\n        },\n        body: JSON.stringify(body)\n      },\n      { operation: 'calculate', company: 'NordWheel API' },\n      { maxRetries: 2, baseDelay: 2000 } // Reduced retries, increased delay\n    );\n    \n    // Handle error result from enhancedApiRequest\n    if (result && typeof result === 'object' && 'success' in result && !result.success) {\n      console.error('ðŸš› NordWheel API Route: Enhanced API error:', result.error);\n      return NextResponse.json(\n        {\n          success: false,\n          error: {\n            message: result.error.userMessage || result.error.message,\n            details: result.error.technicalDetails,\n            type: result.error.type\n          }\n        },\n        { status: 500 }\n      );\n    }\n    \n    // Get the response object\n    const response = result as Response;\n    const responseText = await response.text();\n    console.log('ðŸš› NordWheel API Route: Response status:', response.status, response.statusText);\n    console.log('ðŸš› NordWheel API Route: Response body:', responseText.substring(0, 1000));\n    \n    // Try to parse JSON\n    let data;\n    try {\n      data = JSON.parse(responseText);\n    } catch (parseError) {\n      console.error('ðŸš› NordWheel API Route: JSON parse error:', parseError);\n      return NextResponse.json(\n        { \n          success: false, \n          error: { \n            message: 'Invalid JSON response from NordWheel API',\n            details: responseText.substring(0, 500)\n          }\n        },\n        { status: 500 }\n      );\n    }\n    \n    // Return the response with the same status code\n    if (response.ok) {\n      return NextResponse.json(data, { status: 200 });\n    } else {\n      // Handle API errors\n      const errorMessage = data?.message || data?.error || `HTTP ${response.status}`;\n      const errorDetails = data?.errors || data?.details || null;\n      \n      return NextResponse.json(\n        {\n          success: false,\n          error: {\n            message: errorMessage,\n            details: errorDetails,\n            status: response.status\n          }\n        },\n        { status: response.status }\n      );\n    }\n    \n  } catch (error: any) {\n    console.error('ðŸš› NordWheel API Route: Critical error:', error);\n    \n    return NextResponse.json(\n      { \n        success: false, \n        error: { \n          message: 'Internal server error',\n          details: error.message\n        }\n      },\n      { status: 500 }\n    );\n  }\n}",
          "oldString": "import { NextRequest, NextResponse } from 'next/server';\n\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json();\n    \n    // NordWheel API endpoint\n    const apiUrl = 'https://api.nordw.orog.ru/api/v1/calculate';\n    \n    // Get API key from environment variables or use default\n    const apiKey = process.env.NORDWHEEL_API_KEY || '5|WYpV9f788Y2ASobpv3xy6N5qxtIUaKhxFF4yWETOfc398950';\n    \n    console.log('ðŸš› NordWheel API Route: Forwarding request to:', apiUrl);\n    console.log('ðŸš› NordWheel API Route: Request body:', JSON.stringify(body, null, 2));\n    \n    // Make request to NordWheel API\n    const response = await fetch(apiUrl, {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        'Authorization': `Bearer ${apiKey}`,\n        'User-Agent': 'DeliveryCalculator/1.0',\n        'Accept': 'application/json'\n      },\n      body: JSON.stringify(body)\n    });\n    \n    // Get response text first for better error handling\n    const responseText = await response.text();\n    console.log('ðŸš› NordWheel API Route: Response status:', response.status, response.statusText);\n    console.log('ðŸš› NordWheel API Route: Response body:', responseText.substring(0, 1000));\n    \n    // Try to parse JSON\n    let data;\n    try {\n      data = JSON.parse(responseText);\n    } catch (parseError) {\n      console.error('ðŸš› NordWheel API Route: JSON parse error:', parseError);\n      return NextResponse.json(\n        { \n          success: false, \n          error: { \n            message: 'Invalid JSON response from NordWheel API',\n            details: responseText.substring(0, 500)\n          }\n        },\n        { status: 500 }\n      );\n    }\n    \n    // Return the response with the same status code\n    if (response.ok) {\n      return NextResponse.json(data, { status: 200 });\n    } else {\n      // Handle API errors\n      const errorMessage = data?.message || data?.error || `HTTP ${response.status}`;\n      const errorDetails = data?.errors || data?.details || null;\n      \n      return NextResponse.json(\n        {\n          success: false,\n          error: {\n            message: errorMessage,\n            details: errorDetails,\n            status: response.status\n          }\n        },\n        { status: response.status }\n      );\n    }\n    \n  } catch (error: any) {\n    console.error('ðŸš› NordWheel API Route: Critical error:', error);\n    \n    return NextResponse.json(\n      { \n        success: false, \n        error: { \n          message: 'Internal server error',\n          details: error.message\n        }\n      },\n      { status: 500 }\n    );\n  }\n}"
        }
      ],
      "filePath": "app/api/nordwheel/route.ts"
    },
    "output": "",
    "title": "app/api/nordwheel/route.ts",
    "metadata": {
      "results": [
        {
          "diagnostics": {},
          "diff": "Index: /home/user/project/app/api/nordwheel/route.ts\n===================================================================\n--- /home/user/project/app/api/nordwheel/route.ts\n+++ /home/user/project/app/api/nordwheel/route.ts\n@@ -1,5 +1,6 @@\n import { NextRequest, NextResponse } from 'next/server';\n+import { enhancedApiRequest } from '@/lib/api-utils';\n \n export async function POST(request: NextRequest) {\n   try {\n     const body = await request.json();\n@@ -12,21 +13,43 @@\n     \n     console.log('ðŸš› NordWheel API Route: Forwarding request to:', apiUrl);\n     console.log('ðŸš› NordWheel API Route: Request body:', JSON.stringify(body, null, 2));\n     \n-    // Make request to NordWheel API\n-    const response = await fetch(apiUrl, {\n-      method: 'POST',\n-      headers: {\n-        'Content-Type': 'application/json',\n-        'Authorization': `Bearer ${apiKey}`,\n-        'User-Agent': 'DeliveryCalculator/1.0',\n-        'Accept': 'application/json'\n+    // Use enhanced API request with longer timeout for NordWheel\n+    const result = await enhancedApiRequest(\n+      apiUrl,\n+      {\n+        method: 'POST',\n+        headers: {\n+          'Content-Type': 'application/json',\n+          'Authorization': `Bearer ${apiKey}`,\n+          'User-Agent': 'DeliveryCalculator/1.0',\n+          'Accept': 'application/json'\n+        },\n+        body: JSON.stringify(body)\n       },\n-      body: JSON.stringify(body)\n-    });\n+      { operation: 'calculate', company: 'NordWheel API' },\n+      { maxRetries: 2, baseDelay: 2000 } // Reduced retries, increased delay\n+    );\n     \n-    // Get response text first for better error handling\n+    // Handle error result from enhancedApiRequest\n+    if (result && typeof result === 'object' && 'success' in result && !result.success) {\n+      console.error('ðŸš› NordWheel API Route: Enhanced API error:', result.error);\n+      return NextResponse.json(\n+        {\n+          success: false,\n+          error: {\n+            message: result.error.userMessage || result.error.message,\n+            details: result.error.technicalDetails,\n+            type: result.error.type\n+          }\n+        },\n+        { status: 500 }\n+      );\n+    }\n+    \n+    // Get the response object\n+    const response = result as Response;\n     const responseText = await response.text();\n     console.log('ðŸš› NordWheel API Route: Response status:', response.status, response.statusText);\n     console.log('ðŸš› NordWheel API Route: Response body:', responseText.substring(0, 1000));\n     \n",
          "filediff": {
            "file": "/home/user/project/app/api/nordwheel/route.ts",
            "before": "import { NextRequest, NextResponse } from 'next/server';\n\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json();\n    \n    // NordWheel API endpoint\n    const apiUrl = 'https://api.nordw.orog.ru/api/v1/calculate';\n    \n    // Get API key from environment variables or use default\n    const apiKey = process.env.NORDWHEEL_API_KEY || '5|WYpV9f788Y2ASobpv3xy6N5qxtIUaKhxFF4yWETOfc398950';\n    \n    console.log('ðŸš› NordWheel API Route: Forwarding request to:', apiUrl);\n    console.log('ðŸš› NordWheel API Route: Request body:', JSON.stringify(body, null, 2));\n    \n    // Make request to NordWheel API\n    const response = await fetch(apiUrl, {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        'Authorization': `Bearer ${apiKey}`,\n        'User-Agent': 'DeliveryCalculator/1.0',\n        'Accept': 'application/json'\n      },\n      body: JSON.stringify(body)\n    });\n    \n    // Get response text first for better error handling\n    const responseText = await response.text();\n    console.log('ðŸš› NordWheel API Route: Response status:', response.status, response.statusText);\n    console.log('ðŸš› NordWheel API Route: Response body:', responseText.substring(0, 1000));\n    \n    // Try to parse JSON\n    let data;\n    try {\n      data = JSON.parse(responseText);\n    } catch (parseError) {\n      console.error('ðŸš› NordWheel API Route: JSON parse error:', parseError);\n      return NextResponse.json(\n        { \n          success: false, \n          error: { \n            message: 'Invalid JSON response from NordWheel API',\n            details: responseText.substring(0, 500)\n          }\n        },\n        { status: 500 }\n      );\n    }\n    \n    // Return the response with the same status code\n    if (response.ok) {\n      return NextResponse.json(data, { status: 200 });\n    } else {\n      // Handle API errors\n      const errorMessage = data?.message || data?.error || `HTTP ${response.status}`;\n      const errorDetails = data?.errors || data?.details || null;\n      \n      return NextResponse.json(\n        {\n          success: false,\n          error: {\n            message: errorMessage,\n            details: errorDetails,\n            status: response.status\n          }\n        },\n        { status: response.status }\n      );\n    }\n    \n  } catch (error: any) {\n    console.error('ðŸš› NordWheel API Route: Critical error:', error);\n    \n    return NextResponse.json(\n      { \n        success: false, \n        error: { \n          message: 'Internal server error',\n          details: error.message\n        }\n      },\n      { status: 500 }\n    );\n  }\n}",
            "after": "import { NextRequest, NextResponse } from 'next/server';\nimport { enhancedApiRequest } from '@/lib/api-utils';\n\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json();\n    \n    // NordWheel API endpoint\n    const apiUrl = 'https://api.nordw.orog.ru/api/v1/calculate';\n    \n    // Get API key from environment variables or use default\n    const apiKey = process.env.NORDWHEEL_API_KEY || '5|WYpV9f788Y2ASobpv3xy6N5qxtIUaKhxFF4yWETOfc398950';\n    \n    console.log('ðŸš› NordWheel API Route: Forwarding request to:', apiUrl);\n    console.log('ðŸš› NordWheel API Route: Request body:', JSON.stringify(body, null, 2));\n    \n    // Use enhanced API request with longer timeout for NordWheel\n    const result = await enhancedApiRequest(\n      apiUrl,\n      {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${apiKey}`,\n          'User-Agent': 'DeliveryCalculator/1.0',\n          'Accept': 'application/json'\n        },\n        body: JSON.stringify(body)\n      },\n      { operation: 'calculate', company: 'NordWheel API' },\n      { maxRetries: 2, baseDelay: 2000 } // Reduced retries, increased delay\n    );\n    \n    // Handle error result from enhancedApiRequest\n    if (result && typeof result === 'object' && 'success' in result && !result.success) {\n      console.error('ðŸš› NordWheel API Route: Enhanced API error:', result.error);\n      return NextResponse.json(\n        {\n          success: false,\n          error: {\n            message: result.error.userMessage || result.error.message,\n            details: result.error.technicalDetails,\n            type: result.error.type\n          }\n        },\n        { status: 500 }\n      );\n    }\n    \n    // Get the response object\n    const response = result as Response;\n    const responseText = await response.text();\n    console.log('ðŸš› NordWheel API Route: Response status:', response.status, response.statusText);\n    console.log('ðŸš› NordWheel API Route: Response body:', responseText.substring(0, 1000));\n    \n    // Try to parse JSON\n    let data;\n    try {\n      data = JSON.parse(responseText);\n    } catch (parseError) {\n      console.error('ðŸš› NordWheel API Route: JSON parse error:', parseError);\n      return NextResponse.json(\n        { \n          success: false, \n          error: { \n            message: 'Invalid JSON response from NordWheel API',\n            details: responseText.substring(0, 500)\n          }\n        },\n        { status: 500 }\n      );\n    }\n    \n    // Return the response with the same status code\n    if (response.ok) {\n      return NextResponse.json(data, { status: 200 });\n    } else {\n      // Handle API errors\n      const errorMessage = data?.message || data?.error || `HTTP ${response.status}`;\n      const errorDetails = data?.errors || data?.details || null;\n      \n      return NextResponse.json(\n        {\n          success: false,\n          error: {\n            message: errorMessage,\n            details: errorDetails,\n            status: response.status\n          }\n        },\n        { status: response.status }\n      );\n    }\n    \n  } catch (error: any) {\n    console.error('ðŸš› NordWheel API Route: Critical error:', error);\n    \n    return NextResponse.json(\n      { \n        success: false, \n        error: { \n          message: 'Internal server error',\n          details: error.message\n        }\n      },\n      { status: 500 }\n    );\n  }\n}",
            "additions": 34,
            "deletions": 11
          }
        }
      ]
    },
    "time": {
      "start": 1765814331460,
      "end": 1765814331473
    }
  }
}