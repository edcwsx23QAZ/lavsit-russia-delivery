{
  "id": "prt_97fc52613001FRWsKBDz3qU8O7",
  "messageID": "msg_97fc50208001vfqf6xI671WOsW",
  "sessionID": "ses_6852784ecffeuHwynj83p2lr14",
  "type": "tool",
  "tool": "edit",
  "callID": "toolu_01UTTKE587SVFswNiKizWS44",
  "state": {
    "status": "completed",
    "input": {
      "filePath": "/home/user/project/app/page.tsx",
      "oldString": "  // Получение ID склада ПЭК по адресу через API\n  const findPekWarehouseId = async (address: string): Promise<string | null> => {\n    try {\n      // Используем API ПЭК для поиска склада по адресу\n      const response = await fetch('https://api.pecom.ru/v1/branches/findzonebyaddress', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': 'Basic ' + btoa('C04C5BF2AE367BDCBDC71E7DA520A69B167D1984:')\n        },\n        body: JSON.stringify({\n          address: address\n        })\n      });\n\n      if (response.ok) {\n        const data = await response.json();\n        return data.mainWarehouseId || null;\n      }\n      \n      // Фоллбэк для основных городов\n      const fallbackWarehouses: { [key: string]: string } = {\n        'москва': 'dc6c746d-812d-11e4-bbfc-001999d8b3c5',\n        'санкт-петербург': 'b436c978-086d-11e6-b6ca-00155d668909',\n        'екатеринбург': '550e8400-e29b-41d4-a716-446655440000'\n      };\n      \n      const normalizedCity = address.toLowerCase().trim()\n        .replace(/ё/g, 'е')\n        .replace(/[\\s\\-\\.]+/g, '');\n      \n      for (const [city, warehouseId] of Object.entries(fallbackWarehouses)) {\n        const normalizedCityKey = city.replace(/[\\s\\-\\.]+/g, '');\n        if (normalizedCity.includes(normalizedCityKey) || normalizedCityKey.includes(normalizedCity)) {\n          return warehouseId;\n        }\n      }\n      \n      return null;\n    } catch (error) {\n      console.error('Ошибка поиска склада ПЭК:', error);\n      return null;\n    }\n  };",
      "newString": "  // Получение ID города ПЭК через публичный API\n  const findPekCityId = async (cityName: string): Promise<string | null> => {\n    try {\n      // Используем прокси для загрузки списка городов ПЭК\n      const proxyUrl = 'https://api.allorigins.win/get?url=' + encodeURIComponent('https://pecom.ru/ru/calc/towns.php');\n      const response = await fetch(proxyUrl);\n      const proxyData = await response.json();\n      \n      if (!response.ok || !proxyData.contents) {\n        throw new Error('Ошибка загрузки списка городов ПЭК');\n      }\n      \n      // Парсим JavaScript-массив городов\n      const citiesText = proxyData.contents;\n      const citiesMatch = citiesText.match(/var\\s+towns\\s*=\\s*(\\[[\\s\\S]*?\\]);/);\n      \n      if (citiesMatch) {\n        // Безопасно парсим массив городов\n        const citiesArray = eval(citiesMatch[1]);\n        \n        const normalizedSearchCity = cityName.toLowerCase().trim()\n          .replace(/ё/g, 'е')\n          .replace(/[\\s\\-\\.]+/g, '');\n        \n        // Ищем город по названию\n        for (const city of citiesArray) {\n          if (Array.isArray(city) && city.length >= 2) {\n            const cityNameFromApi = city[1].toLowerCase()\n              .replace(/ё/g, 'е')\n              .replace(/[\\s\\-\\.]+/g, '');\n            \n            if (cityNameFromApi.includes(normalizedSearchCity) || \n                normalizedSearchCity.includes(cityNameFromApi)) {\n              return city[0]; // Возвращаем ID города\n            }\n          }\n        }\n      }\n      \n      // Фоллбэк для основных городов если API не сработал\n      const fallbackCities: { [key: string]: string } = {\n        'москва': '2974',\n        'санкт-петербург': '2975',\n        'екатеринбург': '2976',\n        'новосибирск': '2977',\n        'нижний новгород': '2978',\n        'самара': '2979',\n        'омск': '2980',\n        'казань': '2981',\n        'ростов-на-дону': '2982',\n        'челябинск': '2983',\n        'уфа': '2984',\n        'волгоград': '2985'\n      };\n      \n      const normalizedCity = cityName.toLowerCase().trim()\n        .replace(/ё/g, 'е')\n        .replace(/[\\s\\-\\.]+/g, '');\n      \n      for (const [city, cityId] of Object.entries(fallbackCities)) {\n        const normalizedCityKey = city.replace(/[\\s\\-\\.]+/g, '');\n        if (normalizedCity.includes(normalizedCityKey) || normalizedCityKey.includes(normalizedCity)) {\n          return cityId;\n        }\n      }\n      \n      return null;\n    } catch (error) {\n      console.error('Ошибка поиска города ПЭК:', error);\n      \n      // Возвращаем фоллбэк города по умолчанию\n      const fallbackCities: { [key: string]: string } = {\n        'москва': '2974',\n        'санкт-петербург': '2975',\n      };\n      \n      const normalizedCity = cityName.toLowerCase().trim();\n      \n      if (normalizedCity.includes('москва') || normalizedCity.includes('moscow')) {\n        return '2974';\n      }\n      if (normalizedCity.includes('санкт-петербург') || normalizedCity.includes('спб') || normalizedCity.includes('петербург')) {\n        return '2975';\n      }\n      \n      return null;\n    }\n  };\n\n  // Получение ID склада ПЭК по адресу через API\n  const findPekWarehouseId = async (address: string): Promise<string | null> => {\n    try {\n      // Используем API ПЭК для поиска склада по адресу\n      const response = await fetch('https://api.pecom.ru/v1/branches/findzonebyaddress', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': 'Basic ' + btoa('C04C5BF2AE367BDCBDC71E7DA520A69B167D1984:')\n        },\n        body: JSON.stringify({\n          address: address\n        })\n      });\n\n      if (response.ok) {\n        const data = await response.json();\n        return data.mainWarehouseId || null;\n      }\n      \n      // Фоллбэк для основных городов\n      const fallbackWarehouses: { [key: string]: string } = {\n        'москва': 'dc6c746d-812d-11e4-bbfc-001999d8b3c5',\n        'санкт-петербург': 'b436c978-086d-11e6-b6ca-00155d668909',\n        'екатеринбург': '550e8400-e29b-41d4-a716-446655440000'\n      };\n      \n      const normalizedCity = address.toLowerCase().trim()\n        .replace(/ё/g, 'е')\n        .replace(/[\\s\\-\\.]+/g, '');\n      \n      for (const [city, warehouseId] of Object.entries(fallbackWarehouses)) {\n        const normalizedCityKey = city.replace(/[\\s\\-\\.]+/g, '');\n        if (normalizedCity.includes(normalizedCityKey) || normalizedCityKey.includes(normalizedCity)) {\n          return warehouseId;\n        }\n      }\n      \n      return null;\n    } catch (error) {\n      console.error('Ошибка поиска склада ПЭК:', error);\n      return null;\n    }\n  };"
    },
    "output": "",
    "metadata": {
      "diagnostics": {},
      "diff": "Index: /home/user/project/app/page.tsx\n===================================================================\n--- /home/user/project/app/page.tsx\n+++ /home/user/project/app/page.tsx\n@@ -427,8 +427,97 @@\n     };\n   }\n };\n \n+// Получение ID города ПЭК через публичный API\n+const findPekCityId = async (cityName: string): Promise<string | null> => {\n+  try {\n+    // Используем прокси для загрузки списка городов ПЭК\n+    const proxyUrl = 'https://api.allorigins.win/get?url=' + encodeURIComponent('https://pecom.ru/ru/calc/towns.php');\n+    const response = await fetch(proxyUrl);\n+    const proxyData = await response.json();\n+    \n+    if (!response.ok || !proxyData.contents) {\n+      throw new Error('Ошибка загрузки списка городов ПЭК');\n+    }\n+    \n+    // Парсим JavaScript-массив городов\n+    const citiesText = proxyData.contents;\n+    const citiesMatch = citiesText.match(/var\\s+towns\\s*=\\s*(\\[[\\s\\S]*?\\]);/);\n+    \n+    if (citiesMatch) {\n+      // Безопасно парсим массив городов\n+      const citiesArray = eval(citiesMatch[1]);\n+      \n+      const normalizedSearchCity = cityName.toLowerCase().trim()\n+        .replace(/ё/g, 'е')\n+        .replace(/[\\s\\-\\.]+/g, '');\n+      \n+      // Ищем город по названию\n+      for (const city of citiesArray) {\n+        if (Array.isArray(city) && city.length >= 2) {\n+          const cityNameFromApi = city[1].toLowerCase()\n+            .replace(/ё/g, 'е')\n+            .replace(/[\\s\\-\\.]+/g, '');\n+          \n+          if (cityNameFromApi.includes(normalizedSearchCity) || \n+              normalizedSearchCity.includes(cityNameFromApi)) {\n+            return city[0]; // Возвращаем ID города\n+          }\n+        }\n+      }\n+    }\n+    \n+    // Фоллбэк для основных городов если API не сработал\n+    const fallbackCities: { [key: string]: string } = {\n+      'москва': '2974',\n+      'санкт-петербург': '2975',\n+      'екатеринбург': '2976',\n+      'новосибирск': '2977',\n+      'нижний новгород': '2978',\n+      'самара': '2979',\n+      'омск': '2980',\n+      'казань': '2981',\n+      'ростов-на-дону': '2982',\n+      'челябинск': '2983',\n+      'уфа': '2984',\n+      'волгоград': '2985'\n+    };\n+    \n+    const normalizedCity = cityName.toLowerCase().trim()\n+      .replace(/ё/g, 'е')\n+      .replace(/[\\s\\-\\.]+/g, '');\n+    \n+    for (const [city, cityId] of Object.entries(fallbackCities)) {\n+      const normalizedCityKey = city.replace(/[\\s\\-\\.]+/g, '');\n+      if (normalizedCity.includes(normalizedCityKey) || normalizedCityKey.includes(normalizedCity)) {\n+        return cityId;\n+      }\n+    }\n+    \n+    return null;\n+  } catch (error) {\n+    console.error('Ошибка поиска города ПЭК:', error);\n+    \n+    // Возвращаем фоллбэк города по умолчанию\n+    const fallbackCities: { [key: string]: string } = {\n+      'москва': '2974',\n+      'санкт-петербург': '2975',\n+    };\n+    \n+    const normalizedCity = cityName.toLowerCase().trim();\n+    \n+    if (normalizedCity.includes('москва') || normalizedCity.includes('moscow')) {\n+      return '2974';\n+    }\n+    if (normalizedCity.includes('санкт-петербург') || normalizedCity.includes('спб') || normalizedCity.includes('петербург')) {\n+      return '2975';\n+    }\n+    \n+    return null;\n+  }\n+};\n+\n // Получение ID склада ПЭК по адресу через API\n const findPekWarehouseId = async (address: string): Promise<string | null> => {\n   try {\n     // Используем API ПЭК для поиска склада по адресу\n"
    },
    "title": "app/page.tsx",
    "time": {
      "start": 1758785278099,
      "end": 1758785278149
    }
  }
}