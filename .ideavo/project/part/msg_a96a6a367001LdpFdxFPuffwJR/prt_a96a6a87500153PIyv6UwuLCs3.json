{
  "id": "prt_a96a6a87500153PIyv6UwuLCs3",
  "sessionID": "ses_6852784ecffeuHwynj83p2lr14",
  "messageID": "msg_a96a6a367001LdpFdxFPuffwJR",
  "type": "tool",
  "callID": "call_84324357",
  "tool": "read",
  "state": {
    "status": "completed",
    "input": {
      "filePath": "components/diagnostic/ApiMasterTab.tsx",
      "offset": 100
    },
    "output": "<file>\n00101|   {\n00102|     name: 'Rail Continent',\n00103|     key: 'railcontinent',\n00104|     category: 'transport',\n00105|     status: 'unknown',\n00106|     credentials: {},\n00107|     endpoints: ['/api/rail-continent'],\n00108|     description: 'Железнодорожная доставка Rail Continent'\n00109|   },\n00110|   {\n00111|     name: 'DaData',\n00112|     key: 'dadata',\n00113|     category: 'service',\n00114|     status: 'unknown',\n00115|     credentials: {\n00116|       apiKey: 'eb87bbb3789bb43ed465f796892ea951f9e91008'\n00117|     },\n00118|     endpoints: ['https://suggestions.dadata.ru/suggestions/api/4_1/rs/suggest/address'],\n00119|     description: 'Сервис подсказок адресов DaData'\n00120|   },\n00121|   {\n00122|     name: 'Google Sheets',\n00123|     key: 'sheets',\n00124|     category: 'internal',\n00125|     status: 'unknown',\n00126|     credentials: {},\n00127|     endpoints: ['https://docs.google.com/spreadsheets/d/1e0P91PfGKVIuSWDY0ceWkIE7jD-vzD_xrIesBeQno1Y'],\n00128|     description: 'База данных товаров в Google Sheets'\n00129|   }\n00130| ];\n00131| \n00132| const ApiMasterTab: React.FC = () => {\n00133|   const [apis, setApis] = useState<ApiConfig[]>(API_CONFIGS);\n00134|   const [testingAll, setTestingAll] = useState(false);\n00135|   const [editingApi, setEditingApi] = useState<string | null>(null);\n00136|   const [editCredentials, setEditCredentials] = useState<{ [key: string]: string }>({});\n00137| \n00138|   // Load saved API configurations\n00139|   useEffect(() => {\n00140|     try {\n00141|       const saved = localStorage.getItem('apiConfigurations');\n00142|       if (saved) {\n00143|         const savedConfigs = JSON.parse(saved);\n00144|         setApis(prev => prev.map(api => ({\n00145|           ...api,\n00146|           credentials: savedConfigs[api.key] || api.credentials,\n00147|           status: savedConfigs[api.key + '_status'] || api.status,\n00148|           lastChecked: savedConfigs[api.key + '_lastChecked'] ? new Date(savedConfigs[api.key + '_lastChecked']) : api.lastChecked\n00149|         })));\n00150|       }\n00151|     } catch (error) {\n00152|       console.error('Error loading API configurations:', error);\n00153|     }\n00154|   }, []);\n00155| \n00156|   const saveApiConfigurations = useCallback(() => {\n00157|     try {\n00158|       const configToSave: { [key: string]: any } = {};\n00159|       apis.forEach(api => {\n00160|         configToSave[api.key] = api.credentials;\n00161|         configToSave[api.key + '_status'] = api.status;\n00162|         configToSave[api.key + '_lastChecked'] = api.lastChecked?.toISOString();\n00163|       });\n00164|       localStorage.setItem('apiConfigurations', JSON.stringify(configToSave));\n00165|     } catch (error) {\n00166|       console.error('Error saving API configurations:', error);\n00167|     }\n00168|   }, [apis]);\n00169| \n00170|   const testApi = useCallback(async (api: ApiConfig) => {\n00171|     setApis(prev => prev.map(a =>\n00172|       a.key === api.key ? { ...a, status: 'unknown' as const } : a\n00173|     ));\n00174| \n00175|     try {\n00176|       let testResult = false;\n00177|       let errorMessage = '';\n00178| \n00179|       // Test based on API type\n00180|       switch (api.key) {\n00181|         case 'pek':\n00182|           const pekResponse = await apiRequestWithTimeout('/api/pek', {\n00183|             method: 'POST',\n00184|             headers: { 'Content-Type': 'application/json' },\n00185|             body: JSON.stringify({ method: 'test' })\n00186|           });\n00187|           testResult = pekResponse.ok;\n00188|           if (!pekResponse.ok) {\n00189|             const errorData = await pekResponse.text();\n00190|             errorMessage = errorData.includes('<!DOCTYPE') ? 'Неверные учетные данные' : errorData;\n00191|           }\n00192|           break;\n00193| \n00194|         case 'vozovoz':\n00195|           const vozResponse = await apiRequestWithTimeout('/api/vozovoz', {\n00196|             method: 'POST',\n00197|             headers: { 'Content-Type': 'application/json' },\n00198|             body: JSON.stringify({\n00199|               object: \"price\",\n00200|               action: \"get\",\n00201|               params: {\n00202|                 cargo: { dimension: { quantity: 1, volume: 0.1, weight: 10 } },\n00203|                 gateway: {\n00204|                   dispatch: { point: { location: \"Москва\", terminal: \"default\" } },\n00205|                   destination: { point: { location: \"СПб\", terminal: \"default\" } }\n00206|                 }\n00207|               }\n00208|             })\n00209|           });\n00210|           testResult = vozResponse.ok;\n00211|           if (!vozResponse.ok) {\n00212|             const errorData = await vozResponse.text();\n00213|             errorMessage = errorData.includes('<!DOCTYPE') ? 'Токен устарел' : 'Ошибка API';\n00214|           }\n00215|           break;\n00216| \n00217|         case 'cdek':\n00218|           const cdekResponse = await apiRequestWithTimeout('/api/cdek', {\n00219|             method: 'POST',\n00220|             headers: { 'Content-Type': 'application/json' },\n00221|             body: JSON.stringify({\n00222|               from_city: 'Москва',\n00223|               to_city: 'СПб',\n00224|               packages: [{ height: 10, length: 20, width: 10, weight: 1000 }]\n00225|             })\n00226|           });\n00227|           testResult = cdekResponse.ok;\n00228|           if (!cdekResponse.ok) {\n00229|             const errorData = await cdekResponse.text();\n00230|             errorMessage = errorData.includes('<!DOCTYPE') ? 'Учетные данные устарели' : 'Ошибка API';\n00231|           }\n00232|           break;\n00233| \n00234|         case 'kit':\n00235|           const kitResponse = await apiRequestWithTimeout('/api/kit', {\n00236|             method: 'POST',\n00237|             headers: { 'Content-Type': 'application/json' },\n00238|             body: JSON.stringify({\n00239|               from_city: 'Москва',\n00240|               to_city: 'СПб',\n00241|               declared_price: 10000\n00242|             })\n00243|           });\n00244|           testResult = kitResponse.ok;\n00245|           if (!kitResponse.ok) {\n00246|             const errorData = await kitResponse.json().catch(() => ({}));\n00247|             if (kitResponse.status === 500 && errorData.error?.includes('не настроен')) {\n00248|               errorMessage = 'Токен API не настроен';\n00249|             } else if (kitResponse.status === 400 && errorData.error?.includes('Не удалось определить коды городов')) {\n00250|               errorMessage = 'Ошибка определения городов - проверьте токен';\n00251|             } else {\n00252|               errorMessage = errorData.error || 'Ошибка API';\n00253|             }\n00254|           }\n00255|           break;\n00256| \n00257|         case 'dellin':\n00258|           const dellinResponse = await apiRequestWithTimeout('/api/dellin-packages', {\n00259|             method: 'POST',\n00260|             headers: { 'Content-Type': 'application/json' },\n00261|             body: JSON.stringify({ method: 'test' })\n00262|           });\n00263|           testResult = dellinResponse.ok;\n00264|           break;\n00265| \n00266|         case 'railcontinent':\n00267|           const railResponse = await apiRequestWithTimeout('/api/rail-continent', {\n00268|             method: 'POST',\n00269|             headers: { 'Content-Type': 'application/json' },\n00270|             body: JSON.stringify({ method: 'test' })\n00271|           });\n00272|           testResult = railResponse.ok;\n00273|           break;\n00274| \n00275|         case 'dadata':\n00276|           const dadataResponse = await fetch('https://suggestions.dadata.ru/suggestions/api/4_1/rs/suggest/address', {\n00277|             method: 'POST',\n00278|             headers: {\n00279|               'Content-Type': 'application/json',\n00280|               'Authorization': `Token ${api.credentials.apiKey}`\n00281|             },\n00282|             body: JSON.stringify({ query: 'Москва', count: 1 })\n00283|           });\n00284|           testResult = dadataResponse.ok;\n00285|           break;\n00286| \n00287|         default:\n00288|           testResult = true; // For internal APIs, assume working\n00289|       }\n00290| \n00291|       setApis(prev => prev.map(a =>\n00292|         a.key === api.key ? {\n00293|           ...a,\n00294|           status: testResult ? 'working' : 'error',\n00295|           lastChecked: new Date(),\n00296|           errorMessage: testResult ? undefined : errorMessage\n00297|         } : a\n00298|       ));\n00299| \n00300|     } catch (error) {\n00301|       setApis(prev => prev.map(a =>\n00302|         a.key === api.key ? {\n00303|           ...a,\n00304|           status: 'error',\n00305|           lastChecked: new Date(),\n00306|           errorMessage: 'Сетевая ошибка'\n00307|         } : a\n00308|       ));\n00309|     }\n00310|   }, []);\n00311| \n00312|   const testAllApis = useCallback(async () => {\n00313|     setTestingAll(true);\n00314|     for (const api of apis) {\n00315|       await testApi(api);\n00316|       await new Promise(resolve => setTimeout(resolve, 500)); // Delay between tests\n00317|     }\n00318|     setTestingAll(false);\n00319|     saveApiConfigurations();\n00320|   }, [apis, testApi, saveApiConfigurations]);\n00321| \n00322|   const startEditing = useCallback((apiKey: string) => {\n00323|     const api = apis.find(a => a.key === apiKey);\n00324|     if (api) {\n00325|       setEditingApi(apiKey);\n00326|       setEditCredentials({ ...api.credentials });\n00327|     }\n00328|   }, [apis]);\n00329| \n00330|   const saveCredentials = useCallback(() => {\n00331|     if (editingApi) {\n00332|       setApis(prev => prev.map(a =>\n00333|         a.key === editingApi ? { ...a, credentials: { ...editCredentials } } : a\n00334|       ));\n00335|       setEditingApi(null);\n00336|       saveApiConfigurations();\n00337|     }\n00338|   }, [editingApi, editCredentials, saveApiConfigurations]);\n00339| \n00340|   const getStatusIcon = (status: string) => {\n00341|     switch (status) {\n00342|       case 'working': return <CheckCircle className=\"h-4 w-4 text-green-500\" />;\n00343|       case 'error': return <XCircle className=\"h-4 w-4 text-red-500\" />;\n00344|       case 'expired': return <AlertTriangle className=\"h-4 w-4 text-yellow-500\" />;\n00345|       default: return <RefreshCw className=\"h-4 w-4 text-gray-500\" />;\n00346|     }\n00347|   };\n00348| \n00349|   const getStatusText = (status: string) => {\n00350|     switch (status) {\n00351|       case 'working': return 'Работает';\n00352|       case 'error': return 'Ошибка';\n00353|       case 'expired': return 'Устарел';\n00354|       default: return 'Неизвестно';\n00355|     }\n00356|   };\n00357| \n00358|   const getCategoryIcon = (category: string) => {\n00359|     switch (category) {\n00360|       case 'transport': return <Truck className=\"h-4 w-4\" />;\n00361|       case 'service': return <Globe className=\"h-4 w-4\" />;\n00362|       case 'internal': return <Database className=\"h-4 w-4\" />;\n00363|       default: return <Settings className=\"h-4 w-4\" />;\n00364|     }\n00365|   };\n00366| \n00367|   const transportApis = apis.filter(api => api.category === 'transport');\n00368|   const serviceApis = apis.filter(api => api.category === 'service');\n00369|   const internalApis = apis.filter(api => api.category === 'internal');\n00370| \n00371|   return (\n00372|     <div className=\"space-y-6\">\n00373|       <div className=\"flex justify-between items-center\">\n00374|         <div>\n00375|           <h2 className=\"text-2xl font-bold text-white mb-2\">Все API</h2>\n00376|           <p className=\"text-gray-400\">Централизованное управление всеми API приложения</p>\n00377|         </div>\n00378|         <Button\n00379|           onClick={testAllApis}\n00380|           disabled={testingAll}\n00381|           className=\"bg-blue-600 hover:bg-blue-700\"\n00382|         >\n00383|           {testingAll ? (\n00384|             <>\n00385|               <RefreshCw className=\"h-4 w-4 mr-2 animate-spin\" />\n00386|               Тестирование...\n00387|             </>\n00388|           ) : (\n00389|             <>\n00390|               <Play className=\"h-4 w-4 mr-2\" />\n00391|               Протестировать все\n00392|             </>\n00393|           )}\n00394|         </Button>\n00395|       </div>\n00396| \n00397|       <Tabs defaultValue=\"transport\" className=\"w-full\">\n00398|         <TabsList className=\"grid w-full grid-cols-3 bg-gray-800 border-gray-700\">\n00399|           <TabsTrigger value=\"transport\" className=\"text-white\">\n00400|             <Truck className=\"h-4 w-4 mr-2\" />\n00401|             Транспорт ({transportApis.length})\n00402|           </TabsTrigger>\n00403|           <TabsTrigger value=\"service\" className=\"text-white\">\n00404|             <Globe className=\"h-4 w-4 mr-2\" />\n00405|             Сервисы ({serviceApis.length})\n00406|           </TabsTrigger>\n00407|           <TabsTrigger value=\"internal\" className=\"text-white\">\n00408|             <Database className=\"h-4 w-4 mr-2\" />\n00409|             Внутренние ({internalApis.length})\n00410|           </TabsTrigger>\n00411|         </TabsList>\n00412| \n00413|         <TabsContent value=\"transport\" className=\"mt-6\">\n00414|           <div className=\"grid gap-4\">\n00415|             {transportApis.map((api) => (\n00416|               <Card key={api.key} className=\"bg-gray-800 border-gray-700\">\n00417|                 <CardHeader className=\"pb-3\">\n00418|                   <div className=\"flex items-center justify-between\">\n00419|                     <div className=\"flex items-center gap-3\">\n00420|                       {getCategoryIcon(api.category)}\n00421|                       <div>\n00422|                         <CardTitle className=\"text-white text-lg\">{api.name}</CardTitle>\n00423|                         <p className=\"text-gray-400 text-sm\">{api.description}</p>\n00424|                       </div>\n00425|                     </div>\n00426|                     <div className=\"flex items-center gap-2\">\n00427|                       {getStatusIcon(api.status)}\n00428|                       <Badge variant={api.status === 'working' ? 'default' : 'destructive'}>\n00429|                         {getStatusText(api.status)}\n00430|                       </Badge>\n00431|                     </div>\n00432|                   </div>\n00433|                 </CardHeader>\n00434|                 <CardContent>\n00435|                   <div className=\"space-y-4\">\n00436|                     {api.errorMessage && (\n00437|                       <Alert className=\"border-red-500 bg-red-900/20\">\n00438|                         <AlertTriangle className=\"h-4 w-4\" />\n00439|                         <AlertDescription className=\"text-red-400\">\n00440|                           {api.errorMessage}\n00441|                         </AlertDescription>\n00442|                       </Alert>\n00443|                     )}\n00444| \n00445|                     <div className=\"grid grid-cols-2 gap-4\">\n00446|                       <div>\n00447|                         <Label className=\"text-gray-300 text-sm\">Последняя проверка</Label>\n00448|                         <p className=\"text-white text-sm\">\n00449|                           {api.lastChecked ? api.lastChecked.toLocaleString('ru-RU') : 'Не проверялся'}\n00450|                         </p>\n00451|                       </div>\n00452|                       <div>\n00453|                         <Label className=\"text-gray-300 text-sm\">Эндпоинты</Label>\n00454|                         <div className=\"flex flex-wrap gap-1\">\n00455|                           {api.endpoints.map((endpoint, idx) => (\n00456|                             <Badge key={idx} variant=\"outline\" className=\"text-xs\">\n00457|                               {endpoint}\n00458|                             </Badge>\n00459|                           ))}\n00460|                         </div>\n00461|                       </div>\n00462|                     </div>\n00463| \n00464|                     <div className=\"flex gap-2\">\n00465|                       <Button\n00466|                         onClick={() => testApi(api)}\n00467|                         variant=\"outline\"\n00468|                         size=\"sm\"\n00469|                         className=\"border-blue-500 text-blue-400 hover:bg-blue-900/20\"\n00470|                       >\n00471|                         <Play className=\"h-3 w-3 mr-1\" />\n00472|                         Тест\n00473|                       </Button>\n00474|                       <Button\n00475|                         onClick={() => startEditing(api.key)}\n00476|                         variant=\"outline\"\n00477|                         size=\"sm\"\n00478|                         className=\"border-green-500 text-green-400 hover:bg-green-900/20\"\n00479|                       >\n00480|                         <Key className=\"h-3 w-3 mr-1\" />\n00481|                         Ключи\n00482|                       </Button>\n00483|                     </div>\n00484| \n00485|                     {editingApi === api.key && (\n00486|                       <Card className=\"bg-gray-700 border-gray-600 mt-4\">\n00487|                         <CardHeader className=\"pb-2\">\n00488|                           <CardTitle className=\"text-white text-sm\">Редактирование учетных данных</CardTitle>\n00489|                         </CardHeader>\n00490|                         <CardContent className=\"space-y-3\">\n00491|                           {Object.keys(api.credentials).map((key) => (\n00492|                             <div key={key}>\n00493|                               <Label className=\"text-gray-300 text-sm capitalize\">{key}</Label>\n00494|                               <Input\n00495|                                 type={key.includes('secret') || key.includes('password') ? 'password' : 'text'}\n00496|                                 value={editCredentials[key] || ''}\n00497|                                 onChange={(e) => setEditCredentials(prev => ({ ...prev, [key]: e.target.value }))}\n00498|                                 className=\"bg-gray-600 border-gray-500 text-white\"\n00499|                               />\n00500|                             </div>\n00501|                           ))}\n00502|                           <div className=\"flex gap-2\">\n00503|                             <Button onClick={saveCredentials} size=\"sm\" className=\"bg-green-600 hover:bg-green-700\">\n00504|                               Сохранить\n00505|                             </Button>\n00506|                             <Button onClick={() => setEditingApi(null)} variant=\"outline\" size=\"sm\">\n00507|                               Отмена\n00508|                             </Button>\n00509|                           </div>\n00510|                         </CardContent>\n00511|                       </Card>\n00512|                     )}\n00513|                   </div>\n00514|                 </CardContent>\n00515|               </Card>\n00516|             ))}\n00517|           </div>\n00518|         </TabsContent>\n00519| \n00520|         <TabsContent value=\"service\" className=\"mt-6\">\n00521|           <div className=\"grid gap-4\">\n00522|             {serviceApis.map((api) => (\n00523|               <Card key={api.key} className=\"bg-gray-800 border-gray-700\">\n00524|                 <CardHeader className=\"pb-3\">\n00525|                   <div className=\"flex items-center justify-between\">\n00526|                     <div className=\"flex items-center gap-3\">\n00527|                       {getCategoryIcon(api.category)}\n00528|                       <div>\n00529|                         <CardTitle className=\"text-white text-lg\">{api.name}</CardTitle>\n00530|                         <p className=\"text-gray-400 text-sm\">{api.description}</p>\n00531|                       </div>\n00532|                     </div>\n00533|                     <div className=\"flex items-center gap-2\">\n00534|                       {getStatusIcon(api.status)}\n00535|                       <Badge variant={api.status === 'working' ? 'default' : 'destructive'}>\n00536|                         {getStatusText(api.status)}\n00537|                       </Badge>\n00538|                     </div>\n00539|                   </div>\n00540|                 </CardHeader>\n00541|                 <CardContent>\n00542|                   <div className=\"space-y-4\">\n00543|                     {api.errorMessage && (\n00544|                       <Alert className=\"border-red-500 bg-red-900/20\">\n00545|                         <AlertTriangle className=\"h-4 w-4\" />\n00546|                         <AlertDescription className=\"text-red-400\">\n00547|                           {api.errorMessage}\n00548|                         </AlertDescription>\n00549|                       </Alert>\n00550|                     )}\n00551| \n00552|                     <div className=\"flex gap-2\">\n00553|                       <Button\n00554|                         onClick={() => testApi(api)}\n00555|                         variant=\"outline\"\n00556|                         size=\"sm\"\n00557|                         className=\"border-blue-500 text-blue-400 hover:bg-blue-900/20\"\n00558|                       >\n00559|                         <Play className=\"h-3 w-3 mr-1\" />\n00560|                         Тест\n00561|                       </Button>\n00562|                       <Button\n00563|                         onClick={() => startEditing(api.key)}\n00564|                         variant=\"outline\"\n00565|                         size=\"sm\"\n00566|                         className=\"border-green-500 text-green-400 hover:bg-green-900/20\"\n00567|                       >\n00568|                         <Key className=\"h-3 w-3 mr-1\" />\n00569|                         Ключи\n00570|                       </Button>\n00571|                     </div>\n00572|                   </div>\n00573|                 </CardContent>\n00574|               </Card>\n00575|             ))}\n00576|           </div>\n00577|         </TabsContent>\n00578| \n00579|         <TabsContent value=\"internal\" className=\"mt-6\">\n00580|           <div className=\"grid gap-4\">\n00581|             {internalApis.map((api) => (\n00582|               <Card key={api.key} className=\"bg-gray-800 border-gray-700\">\n00583|                 <CardHeader className=\"pb-3\">\n00584|                   <div className=\"flex items-center justify-between\">\n00585|                     <div className=\"flex items-center gap-3\">\n00586|                       {getCategoryIcon(api.category)}\n00587|                       <div>\n00588|                         <CardTitle className=\"text-white text-lg\">{api.name}</CardTitle>\n00589|                         <p className=\"text-gray-400 text-sm\">{api.description}</p>\n00590|                       </div>\n00591|                     </div>\n00592|                     <div className=\"flex items-center gap-2\">\n00593|                       {getStatusIcon(api.status)}\n00594|                       <Badge variant={api.status === 'working' ? 'default' : 'destructive'}>\n00595|                         {getStatusText(api.status)}\n00596|                       </Badge>\n00597|                       <Button\n00598|                         onClick={() => window.open(api.endpoints[0], '_blank')}\n00599|                         variant=\"outline\"\n00600|                         size=\"sm\"\n00601|                         className=\"border-purple-500 text-purple-400 hover:bg-purple-900/20\"\n00602|                       >\n00603|                         <ExternalLink className=\"h-3 w-3 mr-1\" />\n00604|                         Открыть\n00605|                       </Button>\n00606|                     </div>\n00607|                   </div>\n00608|                 </CardHeader>\n00609|               </Card>\n00610|             ))}\n00611|           </div>\n00612|         </TabsContent>\n00613|       </Tabs>\n00614|     </div>\n00615|   );\n00616| };\n00617| \n00618| export default ApiMasterTab;\n</file>",
    "title": "components/diagnostic/ApiMasterTab.tsx",
    "metadata": {
      "preview": "  {\n    name: 'Rail Continent',\n    key: 'railcontinent',\n    category: 'transport',\n    status: 'unknown',\n    credentials: {},\n    endpoints: ['/api/rail-continent'],\n    description: 'Железнодорожная доставка Rail Continent'\n  },\n  {\n    name: 'DaData',\n    key: 'dadata',\n    category: 'service',\n    status: 'unknown',\n    credentials: {\n      apiKey: 'eb87bbb3789bb43ed465f796892ea951f9e91008'\n    },\n    endpoints: ['https://suggestions.dadata.ru/suggestions/api/4_1/rs/suggest/address'],\n    description: 'Сервис подсказок адресов DaData'\n  },"
    },
    "time": {
      "start": 1763464095863,
      "end": 1763464095868
    }
  }
}