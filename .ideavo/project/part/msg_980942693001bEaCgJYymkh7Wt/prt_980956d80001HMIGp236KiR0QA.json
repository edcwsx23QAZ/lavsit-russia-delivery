{
  "id": "prt_980956d80001HMIGp236KiR0QA",
  "messageID": "msg_980942693001bEaCgJYymkh7Wt",
  "sessionID": "ses_6852784ecffeuHwynj83p2lr14",
  "type": "tool",
  "tool": "edit",
  "callID": "toolu_01Whh6QK5dfPBdbNz7tAbEWz",
  "state": {
    "status": "completed",
    "input": {
      "filePath": "/home/user/project/app/page.tsx",
      "oldString": "  // Расчет для Деловых Линий по новой документации\n  const calculateDellin = async (): Promise<CalculationResult> => {\n    const apiUrl = 'https://api.dellin.ru/v2/calculator';\n    \n    try {\n      const sessionID = await getDellinSessionId();\n      \n      if (!sessionID) {\n        return {\n          company: 'Деловые Линии',\n          price: 0,\n          days: 0,\n          error: 'Не удалось получить sessionID',\n          apiUrl\n        };\n      }\n\n      const totalWeight = form.cargos.reduce((sum, cargo) => sum + cargo.weight, 0);\n      const totalVolume = form.cargos.reduce((sum, cargo) => \n        sum + (cargo.length * cargo.width * cargo.height) / 1000000, 0\n      );\n\n      // Правильная структура запроса согласно документации\n      const requestData = {\n        appkey: 'E6C50E91-8E93-440F-9CC6-DEF9F0D68F1B',\n        sessionID: sessionID,\n        delivery: {\n          deliveryType: {\n            type: 'auto'\n          },\n          derival: {\n            variant: form.fromAddressDelivery ? 'address' : 'terminal',\n            address: {\n              search: form.fromAddressDelivery ? (form.fromAddress || form.fromCity) : form.fromCity\n            }\n          },\n          arrival: {\n            variant: form.toAddressDelivery ? 'address' : 'terminal', \n            address: {\n              search: form.toAddressDelivery ? (form.toAddress || form.toCity) : form.toCity\n            }\n          }\n        },\n        cargo: {\n          quantity: form.cargos.length,\n          weight: totalWeight,\n          totalVolume: totalVolume,\n          totalWeight: totalWeight,\n          oversizedWeight: 0,\n          oversizedVolume: 0,\n          ...(form.needInsurance && form.declaredValue > 0 ? {\n            insurance: {\n              statedValue: form.declaredValue,\n              term: false\n            }\n          } : {})\n        },\n        ...(form.needPackaging ? {\n          packages: [{\n            uid: 'bag'\n          }]\n        } : {})\n      };\n\n      const response = await fetch(apiUrl, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Accept': 'application/json'\n        },\n        body: JSON.stringify(requestData)\n      });\n\n      const data = await response.json();",
      "newString": "  // Расчет для Деловых Линий через корректный API v2/calculator.json\n  const calculateDellin = async (): Promise<CalculationResult> => {\n    const apiUrl = 'https://api.dellin.ru/v2/calculator.json';\n    \n    try {\n      const sessionID = await getDellinSessionId();\n      \n      if (!sessionID) {\n        return {\n          company: 'Деловые Линии',\n          price: 0,\n          days: 0,\n          error: 'Не удалось получить sessionID',\n          apiUrl,\n          requestData: null,\n          responseData: null\n        };\n      }\n\n      // Вычисляем размеры и объемы\n      const totalWeight = form.cargos.reduce((sum, cargo) => sum + cargo.weight, 0);\n      const totalVolume = form.cargos.reduce((sum, cargo) => \n        sum + (cargo.length * cargo.width * cargo.height) / 1000000, 0\n      );\n      const maxLength = Math.max(...form.cargos.map(c => c.length)) / 100; // в метрах\n      const maxWidth = Math.max(...form.cargos.map(c => c.width)) / 100;\n      const maxHeight = Math.max(...form.cargos.map(c => c.height)) / 100;\n\n      // Получаем терминалы для городов (если нужно)\n      const fromTerminalId = !form.fromAddressDelivery ? await getDellinTerminal(form.fromCity) : null;\n      const toTerminalId = !form.toAddressDelivery ? await getDellinTerminal(form.toCity) : null;\n\n      // Формируем дату отправления на завтра\n      const tomorrow = new Date();\n      tomorrow.setDate(tomorrow.getDate() + 1);\n      const produceDate = tomorrow.toISOString().split('T')[0];\n\n      // Формируем корректную структуру запроса согласно инструкции\n      const requestData = {\n        appkey: 'E6C50E91-8E93-440F-9CC6-DEF9F0D68F1B',\n        sessionID: sessionID,\n        delivery: {\n          deliveryType: {\n            type: 'auto'  // Всегда \"auto\" по умолчанию\n          },\n          derival: {\n            produceDate: produceDate,  // Обязательная дата отправления\n            variant: form.fromAddressDelivery ? 'address' : 'terminal',\n            ...(form.fromAddressDelivery ? {\n              address: {\n                search: form.fromAddress || form.fromCity\n              }\n            } : {\n              terminalID: fromTerminalId\n            }),\n            time: {\n              worktimeStart: '10:00',\n              worktimeEnd: '18:00',\n              breakStart: '13:00',\n              breakEnd: '14:00',\n              exactTime: false\n            },\n            handling: {\n              freightLift: true,\n              toFloor: 5,\n              carry: 0\n            }\n          },\n          arrival: {\n            variant: form.toAddressDelivery ? 'address' : 'terminal',\n            ...(form.toAddressDelivery ? {\n              address: {\n                search: form.toAddress || form.toCity\n              }\n            } : {\n              terminalID: toTerminalId\n            }),\n            time: {\n              worktimeStart: '10:00',\n              worktimeEnd: '18:00',\n              breakStart: '13:00',\n              breakEnd: '14:00',\n              exactTime: false\n            },\n            handling: {\n              freightLift: true,\n              toFloor: 5,\n              carry: 0\n            }\n          },\n          ...(form.needPackaging ? {\n            packages: [{\n              uid: 'crate_with_bubble',  // Правильный uid упаковки\n              count: 1\n            }]\n          } : {})\n        },\n        cargo: {\n          quantity: form.cargos.length,\n          length: maxLength,\n          width: maxWidth,\n          height: maxHeight,\n          weight: totalWeight,\n          totalVolume: totalVolume,\n          totalWeight: totalWeight,\n          oversizedWeight: 0,\n          oversizedVolume: 0,\n          hazardClass: 0,  // Всегда 0 если нет опасных грузов\n          ...(form.needInsurance && form.declaredValue > 0 ? {\n            insurance: {\n              statedValue: form.declaredValue,\n              term: true  // Всегда true при наличии страхования\n            }\n          } : {})\n        },\n        payment: {\n          type: 'noncash',  // Всегда \"noncash\"\n          paymentCitySearch: {\n            search: form.fromCity  // Город оплаты\n          }\n        }\n      };\n\n      console.log('Деловые Линии запрос:', JSON.stringify(requestData, null, 2));\n\n      const response = await fetch(apiUrl, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Accept': 'application/json'\n        },\n        body: JSON.stringify(requestData)\n      });\n\n      const data = await response.json();\n      console.log('Деловые Линии ответ:', data);"
    },
    "output": "",
    "metadata": {
      "diagnostics": {},
      "diff": "Index: /home/user/project/app/page.tsx\n===================================================================\n--- /home/user/project/app/page.tsx\n+++ /home/user/project/app/page.tsx\n@@ -264,11 +264,11 @@\n     return null;\n   }\n };\n \n-// Расчет для Деловых Линий по новой документации\n+// Расчет для Деловых Линий через корректный API v2/calculator.json\n const calculateDellin = async (): Promise<CalculationResult> => {\n-  const apiUrl = 'https://api.dellin.ru/v2/calculator';\n+  const apiUrl = 'https://api.dellin.ru/v2/calculator.json';\n   \n   try {\n     const sessionID = await getDellinSessionId();\n     \n@@ -277,59 +277,120 @@\n         company: 'Деловые Линии',\n         price: 0,\n         days: 0,\n         error: 'Не удалось получить sessionID',\n-        apiUrl\n+        apiUrl,\n+        requestData: null,\n+        responseData: null\n       };\n     }\n \n+    // Вычисляем размеры и объемы\n     const totalWeight = form.cargos.reduce((sum, cargo) => sum + cargo.weight, 0);\n     const totalVolume = form.cargos.reduce((sum, cargo) => \n       sum + (cargo.length * cargo.width * cargo.height) / 1000000, 0\n     );\n+    const maxLength = Math.max(...form.cargos.map(c => c.length)) / 100; // в метрах\n+    const maxWidth = Math.max(...form.cargos.map(c => c.width)) / 100;\n+    const maxHeight = Math.max(...form.cargos.map(c => c.height)) / 100;\n \n-    // Правильная структура запроса согласно документации\n+    // Получаем терминалы для городов (если нужно)\n+    const fromTerminalId = !form.fromAddressDelivery ? await getDellinTerminal(form.fromCity) : null;\n+    const toTerminalId = !form.toAddressDelivery ? await getDellinTerminal(form.toCity) : null;\n+\n+    // Формируем дату отправления на завтра\n+    const tomorrow = new Date();\n+    tomorrow.setDate(tomorrow.getDate() + 1);\n+    const produceDate = tomorrow.toISOString().split('T')[0];\n+\n+    // Формируем корректную структуру запроса согласно инструкции\n     const requestData = {\n       appkey: 'E6C50E91-8E93-440F-9CC6-DEF9F0D68F1B',\n       sessionID: sessionID,\n       delivery: {\n         deliveryType: {\n-          type: 'auto'\n+          type: 'auto'  // Всегда \"auto\" по умолчанию\n         },\n         derival: {\n+          produceDate: produceDate,  // Обязательная дата отправления\n           variant: form.fromAddressDelivery ? 'address' : 'terminal',\n-          address: {\n-            search: form.fromAddressDelivery ? (form.fromAddress || form.fromCity) : form.fromCity\n+          ...(form.fromAddressDelivery ? {\n+            address: {\n+              search: form.fromAddress || form.fromCity\n+            }\n+          } : {\n+            terminalID: fromTerminalId\n+          }),\n+          time: {\n+            worktimeStart: '10:00',\n+            worktimeEnd: '18:00',\n+            breakStart: '13:00',\n+            breakEnd: '14:00',\n+            exactTime: false\n+          },\n+          handling: {\n+            freightLift: true,\n+            toFloor: 5,\n+            carry: 0\n           }\n         },\n         arrival: {\n-          variant: form.toAddressDelivery ? 'address' : 'terminal', \n-          address: {\n-            search: form.toAddressDelivery ? (form.toAddress || form.toCity) : form.toCity\n+          variant: form.toAddressDelivery ? 'address' : 'terminal',\n+          ...(form.toAddressDelivery ? {\n+            address: {\n+              search: form.toAddress || form.toCity\n+            }\n+          } : {\n+            terminalID: toTerminalId\n+          }),\n+          time: {\n+            worktimeStart: '10:00',\n+            worktimeEnd: '18:00',\n+            breakStart: '13:00',\n+            breakEnd: '14:00',\n+            exactTime: false\n+          },\n+          handling: {\n+            freightLift: true,\n+            toFloor: 5,\n+            carry: 0\n           }\n-        }\n+        },\n+        ...(form.needPackaging ? {\n+          packages: [{\n+            uid: 'crate_with_bubble',  // Правильный uid упаковки\n+            count: 1\n+          }]\n+        } : {})\n       },\n       cargo: {\n         quantity: form.cargos.length,\n+        length: maxLength,\n+        width: maxWidth,\n+        height: maxHeight,\n         weight: totalWeight,\n         totalVolume: totalVolume,\n         totalWeight: totalWeight,\n         oversizedWeight: 0,\n         oversizedVolume: 0,\n+        hazardClass: 0,  // Всегда 0 если нет опасных грузов\n         ...(form.needInsurance && form.declaredValue > 0 ? {\n           insurance: {\n             statedValue: form.declaredValue,\n-            term: false\n+            term: true  // Всегда true при наличии страхования\n           }\n         } : {})\n       },\n-      ...(form.needPackaging ? {\n-        packages: [{\n-          uid: 'bag'\n-        }]\n-      } : {})\n+      payment: {\n+        type: 'noncash',  // Всегда \"noncash\"\n+        paymentCitySearch: {\n+          search: form.fromCity  // Город оплаты\n+        }\n+      }\n     };\n \n+    console.log('Деловые Линии запрос:', JSON.stringify(requestData, null, 2));\n+\n     const response = await fetch(apiUrl, {\n       method: 'POST',\n       headers: {\n         'Content-Type': 'application/json',\n@@ -338,8 +399,9 @@\n       body: JSON.stringify(requestData)\n     });\n \n     const data = await response.json();\n+    console.log('Деловые Линии ответ:', data);\n \n     if (response.ok && data.data && data.metadata?.status === 200) {\n       let totalPrice = data.data.price || 0;\n       \n"
    },
    "title": "app/page.tsx",
    "time": {
      "start": 1758798924601,
      "end": 1758798924632
    }
  }
}