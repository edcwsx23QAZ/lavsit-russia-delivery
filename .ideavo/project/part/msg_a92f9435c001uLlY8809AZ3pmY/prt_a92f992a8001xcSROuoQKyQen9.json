{
  "id": "prt_a92f992a8001xcSROuoQKyQen9",
  "sessionID": "ses_6852784ecffeuHwynj83p2lr14",
  "messageID": "msg_a92f9435c001uLlY8809AZ3pmY",
  "type": "tool",
  "callID": "call_0b1a8ef6b83743c8bfa94efe",
  "tool": "read",
  "state": {
    "status": "completed",
    "input": {
      "filePath": "app/diagnostic/page.tsx"
    },
    "output": "<file>\n00001| 'use client';\n00002| \n00003| import React, { useEffect, useCallback } from 'react';\n00004| import { useDiagnosticState } from '@/hooks/useDiagnosticState';\n00005| import DiagnosticHeader from '@/components/diagnostic/DiagnosticHeader';\n00006| import ApiTestingSection from '@/components/diagnostic/ApiTestingSection';\n00007| import ManualTesting from '@/components/diagnostic/ManualTesting';\n00008| import { LazyFullTestingResults, LazyVehicleManagement } from '@/components/diagnostic/LazyLoadedComponents';\n00009| import { apiRequestWithTimeout, PerformanceMonitor } from '@/lib/api-utils';\n00010| \n00011| export default function OptimizedDiagnosticPage() {\n00012|   const { state, actions } = useDiagnosticState();\n00013| \n00014|   // Initialize data on mount\n00015|   useEffect(() => {\n00016|     try {\n00017|       const saved = localStorage.getItem('vehicleTypes');\n00018|       if (saved) {\n00019|         const parsedVehicleTypes = JSON.parse(saved);\n00020|         actions.initializeVehicleTypes(parsedVehicleTypes, null);\n00021|       }\n00022|       \n00023|       const lastUpdate = localStorage.getItem('lastProductDataUpdate');\n00024|       if (lastUpdate) {\n00025|         actions.setLastUpdateTime(new Date(lastUpdate).toLocaleString('ru-RU'));\n00026|       }\n00027|     } catch (error) {\n00028|       console.error('Ошибка загрузки сохранённых данных:', error);\n00029|     }\n00030|   }, [actions]);\n00031| \n00032|   // API testing functions with performance monitoring\n00033|   const testAPI = useCallback(async (service: string, endpoint: string, data: any = {}) => {\n00034|     const endTiming = PerformanceMonitor.startMeasurement(`diagnostic_${service}`);\n00035|     actions.setTestingState(service, true);\n00036|     \n00037|     try {\n00038|       const response = await apiRequestWithTimeout(endpoint, {\n00039|         method: 'POST',\n00040|         headers: { 'Content-Type': 'application/json' },\n00041|         body: JSON.stringify(data)\n00042|       }, { timeout: 15000, retries: 1 });\n00043| \n00044|       const result = await response.json();\n00045|       const timing = endTiming();\n00046| \n00047|       if (response.ok) {\n00048|         actions.setDiagnosticResult(service.toLowerCase(), {\n00049|           status: 'success',\n00050|           message: `✅ ${service} API работает корректно`,\n00051|           details: result,\n00052|           timing\n00053|         });\n00054|       } else {\n00055|         actions.setDiagnosticResult(service.toLowerCase(), {\n00056|           status: 'error',\n00057|           message: `❌ Ошибка ${service} API: ${result.error || 'Неизвестная ошибка'}`,\n00058|           details: result,\n00059|           timing\n00060|         });\n00061|       }\n00062|     } catch (error) {\n00063|       endTiming();\n00064|       actions.setDiagnosticResult(service.toLowerCase(), {\n00065|         status: 'error',\n00066|         message: `❌ Сетевая ошибка ${service} API`,\n00067|         details: error instanceof Error ? error.message : 'Неизвестная ошибка'\n00068|       });\n00069|     } finally {\n00070|       actions.setTestingState(service, false);\n00071|     }\n00072|   }, [actions]);\n00073| \n00074|   const testPEK = useCallback(() => {\n00075|     testAPI('PEK', '/api/pek', { method: 'test' });\n00076|   }, [testAPI]);\n00077| \n00078|   const testDellin = useCallback(() => {\n00079|     testAPI('Dellin', '/api/dellin-packages', { method: 'test' });\n00080|   }, [testAPI]);\n00081| \n00082|   const testRailContinent = useCallback(() => {\n00083|     testAPI('RailContinent', '/api/rail-continent', { method: 'test' });\n00084|   }, [testAPI]);\n00085| \n00086|   const testVozovoz = useCallback(() => {\n00087|     testAPI('Vozovoz', '/api/vozovoz', { method: 'test' });\n00088|   }, [testAPI]);\n00089| \n00090|   const testNordWheel = useCallback(() => {\n00091|     testAPI('NordWheel', '/api/test', { service: 'nordwheel' });\n00092|   }, [testAPI]);\n00093| \n00094|   const testAllAPIs = useCallback(async () => {\n00095|     actions.resetDiagnosticResults();\n00096|     \n00097|     const tests = [\n00098|       () => testPEK(),\n00099|       () => testDellin(), \n00100|       () => testRailContinent(),\n00101|       () => testVozovoz(),\n00102|       () => testNordWheel()\n00103|     ];\n00104| \n00105|     // Run tests in parallel for better performance\n00106|     await Promise.allSettled(tests.map(test => test()));\n00107|   }, [actions, testPEK, testDellin, testRailContinent, testVozovoz, testNordWheel]);\n00108| \n00109|   const runFullTesting = useCallback(async () => {\n00110|     actions.setFullTesting(true);\n00111|     actions.setTestProgress({ \n00112|       currentTK: 'Начинаем тестирование...', \n00113|       completedTests: 0, \n00114|       totalPlannedTests: 25, \n00115|       stage: 'Инициализация',\n00116|       progress: 0 \n00117|     });\n00118| \n00119|     const startTime = Date.now();\n00120|     const results: any[] = [];\n00121|     const errors: string[] = [];\n00122| \n00123|     const testCases = [\n00124|       { service: 'ПЭК', endpoint: '/api/pek', data: { method: 'test' } },\n00125|       { service: 'Деловые Линии', endpoint: '/api/dellin-packages', data: { method: 'test' } },\n00126|       { service: 'Rail Continent', endpoint: '/api/rail-continent', data: { method: 'test' } },\n00127|       { service: 'Возовоз', endpoint: '/api/vozovoz', data: { method: 'test' } },\n00128|       { service: 'Nord Wheel', endpoint: '/api/test', data: { service: 'nordwheel' } }\n00129|     ];\n00130| \n00131|     for (let i = 0; i < testCases.length; i++) {\n00132|       const testCase = testCases[i];\n00133|       const progress = Math.round(((i + 1) / testCases.length) * 100);\n00134|       \n00135|       actions.setTestProgress({\n00136|         currentTK: testCase.service,\n00137|         completedTests: i,\n00138|         totalPlannedTests: testCases.length,\n00139|         stage: 'Тестирование API',\n00140|         progress\n00141|       });\n00142| \n00143|       try {\n00144|         const response = await apiRequestWithTimeout(testCase.endpoint, {\n00145|           method: 'POST',\n00146|           headers: { 'Content-Type': 'application/json' },\n00147|           body: JSON.stringify(testCase.data)\n00148|         }, { timeout: 10000 });\n00149| \n00150|         const result = await response.json();\n00151|         \n00152|         results.push({\n00153|           company: testCase.service,\n00154|           status: response.ok ? 'passed' : 'failed',\n00155|           message: response.ok ? 'Тест пройден успешно' : result.error || 'Ошибка теста',\n00156|           details: result,\n00157|           timing: result.timing || 0,\n00158|           timestamp: new Date().toISOString()\n00159|         });\n00160| \n00161|         if (!response.ok) {\n00162|           errors.push(`${testCase.service}: ${result.error || 'Неизвестная ошибка'}`);\n00163|         }\n00164|       } catch (error) {\n00165|         results.push({\n00166|           company: testCase.service,\n00167|           status: 'failed',\n00168|           message: 'Сетевая ошибка или таймаут',\n00169|           details: error instanceof Error ? error.message : 'Неизвестная ошибка',\n00170|           timing: 0,\n00171|           timestamp: new Date().toISOString()\n00172|         });\n00173|         errors.push(`${testCase.service}: Сетевая ошибка`);\n00174|       }\n00175| \n00176|       // Small delay for UI updates\n00177|       await new Promise(resolve => setTimeout(resolve, 200));\n00178|     }\n00179| \n00180|     const endTime = Date.now();\n00181|     const totalTime = endTime - startTime;\n00182|     const successful = results.filter(r => r.status === 'passed').length;\n00183|     const failed = results.filter(r => r.status === 'failed').length;\n00184|     const averageTime = results.reduce((sum, r) => sum + r.timing, 0) / results.length;\n00185| \n00186|     actions.setFullTestResults({\n00187|       summary: {\n00188|         totalTests: results.length,\n00189|         successful,\n00190|         failed,\n00191|         skipped: 0,\n00192|         errors,\n00193|         averageResponseTime: Math.round(averageTime),\n00194|         successRate: (successful / results.length) * 100\n00195|       },\n00196|       details: results,\n00197|       progressInfo: null\n00198|     });\n00199| \n00200|     actions.setTestProgress(null);\n00201|     actions.setFullTesting(false);\n00202|   }, [actions]);\n00203| \n00204|   // Vehicle management functions\n00205|   const addVehicleType = useCallback(() => {\n00206|     const { name, length, width, height } = state.newVehicle;\n00207|     \n00208|     if (!name || !length || !width || !height) {\n00209|       alert('Пожалуйста, заполните все поля');\n00210|       return;\n00211|     }\n00212|     \n00213|     const newId = (state.vehicleTypes.length + 1).toString();\n00214|     const vehicleToAdd = {\n00215|       id: newId,\n00216|       name,\n00217|       length: parseInt(length),\n00218|       width: parseInt(width),\n00219|       height: parseInt(height)\n00220|     };\n00221|     \n00222|     actions.addVehicleType(vehicleToAdd);\n00223|   }, [state.newVehicle, state.vehicleTypes.length, actions]);\n00224| \n00225|   const saveVehicleTypes = useCallback(async () => {\n00226|     actions.setSavingState(true);\n00227|     actions.setSaveStatus('saving');\n00228|     \n00229|     try {\n00230|       localStorage.setItem('vehicleTypes', JSON.stringify(state.vehicleTypes));\n00231|       await new Promise(resolve => setTimeout(resolve, 1000));\n00232|       \n00233|       actions.setUnsavedChanges(false);\n00234|       actions.setSaveStatus('success');\n00235|       setTimeout(() => actions.setSaveStatus('idle'), 3000);\n00236|     } catch (error) {\n00237|       console.error('Ошибка сохранения:', error);\n00238|       actions.setSaveStatus('error');\n00239|       setTimeout(() => actions.setSaveStatus('idle'), 5000);\n00240|     } finally {\n00241|       actions.setSavingState(false);\n00242|     }\n00243|   }, [state.vehicleTypes, actions]);\n00244| \n00245|   const updateProductData = useCallback(async () => {\n00246|     actions.setUpdatingData(true);\n00247|     actions.setUpdateStatus('updating');\n00248|     \n00249|     try {\n00250|       const response = await apiRequestWithTimeout('/api/furniture-products?update=true&force=true&timestamp=' + Date.now(), {\n00251|         method: 'GET',\n00252|         headers: {\n00253|           'Cache-Control': 'no-cache, no-store, must-revalidate',\n00254|           'Pragma': 'no-cache',\n00255|           'Expires': '0'\n00256|         }\n00257|       }, { timeout: 30000 });\n00258| \n00259|       const result = await response.json();\n00260|       \n00261|       if (!result.success) {\n00262|         throw new Error(result.error || 'Ошибка обновления данных');\n00263|       }\n00264| \n00265|       const updateTime = new Date().toLocaleString('ru-RU');\n00266|       localStorage.setItem('lastProductDataUpdate', new Date().toISOString());\n00267|       actions.setLastUpdateTime(updateTime);\n00268|       actions.setUpdateStatus('success');\n00269|       \n00270|       setTimeout(() => actions.setUpdateStatus('idle'), 3000);\n00271|     } catch (error) {\n00272|       console.error('Ошибка обновления данных:', error);\n00273|       actions.setUpdateStatus('error');\n00274|       setTimeout(() => actions.setUpdateStatus('idle'), 5000);\n00275|     } finally {\n00276|       actions.setUpdatingData(false);\n00277|     }\n00278|   }, [actions]);\n00279| \n00280|   return (\n00281|     <div className=\"min-h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 p-6\">\n00282|       <div className=\"max-w-7xl mx-auto\">\n00283|         <DiagnosticHeader\n00284|           onTestAllAPIs={testAllAPIs}\n00285|           onRunFullTesting={runFullTesting}\n00286|           onUpdateProductData={updateProductData}\n00287|           isFullTesting={state.isFullTesting}\n00288|           isUpdatingData={state.isUpdatingData}\n00289|           updateStatus={state.updateStatus}\n00290|         />\n00291| \n00292|         <ApiTestingSection\n00293|           diagnosticResults={state.diagnosticResults}\n00294|           testStates={{\n00295|             isTestingPEK: state.isTestingPEK,\n00296|             isTestingDellin: state.isTestingDellin,\n00297|             isTestingRailContinent: state.isTestingRailContinent,\n00298|             isTestingVozovoz: state.isTestingVozovoz,\n00299|             isTestingNordWheel: state.isTestingNordWheel,\n00300|           }}\n00301|           onTestPEK={testPEK}\n00302|           onTestDellin={testDellin}\n00303|           onTestRailContinent={testRailContinent}\n00304|           onTestVozovoz={testVozovoz}\n00305|           onTestNordWheel={testNordWheel}\n00306|         />\n00307| \n00308|         <LazyFullTestingResults\n00309|           fullTestResults={state.fullTestResults}\n00310|           testProgress={state.testProgress?.progress || 0}\n00311|           isFullTesting={state.isFullTesting}\n00312|         />\n00313| \n00314|         <ManualTesting />\n00315| \n00316|         <LazyVehicleManagement\n00317|           vehicleTypes={state.vehicleTypes}\n00318|           newVehicle={state.newVehicle}\n00319|           hasUnsavedChanges={state.hasUnsavedChanges}\n00320|           saveStatus={state.saveStatus}\n00321|           isSaving={state.isSaving}\n00322|           lastUpdateTime={state.lastUpdateTime}\n00323|           onAddVehicleType={addVehicleType}\n00324|           onRemoveVehicleType={actions.removeVehicleType}\n00325|           onUpdateVehicleType={actions.updateVehicleType}\n00326|           onSaveVehicleTypes={saveVehicleTypes}\n00327|           onSetNewVehicle={actions.setNewVehicle}\n00328|         />\n00329|       </div>\n00330|     </div>\n00331|   );\n00332| }\n</file>",
    "title": "app/diagnostic/page.tsx",
    "metadata": {
      "preview": "'use client';\n\nimport React, { useEffect, useCallback } from 'react';\nimport { useDiagnosticState } from '@/hooks/useDiagnosticState';\nimport DiagnosticHeader from '@/components/diagnostic/DiagnosticHeader';\nimport ApiTestingSection from '@/components/diagnostic/ApiTestingSection';\nimport ManualTesting from '@/components/diagnostic/ManualTesting';\nimport { LazyFullTestingResults, LazyVehicleManagement } from '@/components/diagnostic/LazyLoadedComponents';\nimport { apiRequestWithTimeout, PerformanceMonitor } from '@/lib/api-utils';\n\nexport default function OptimizedDiagnosticPage() {\n  const { state, actions } = useDiagnosticState();\n\n  // Initialize data on mount\n  useEffect(() => {\n    try {\n      const saved = localStorage.getItem('vehicleTypes');\n      if (saved) {\n        const parsedVehicleTypes = JSON.parse(saved);\n        actions.initializeVehicleTypes(parsedVehicleTypes, null);"
    },
    "time": {
      "start": 1763402420910,
      "end": 1763402420915
    }
  }
}