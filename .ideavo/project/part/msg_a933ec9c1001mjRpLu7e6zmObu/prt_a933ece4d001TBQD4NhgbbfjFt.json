{
  "id": "prt_a933ece4d001TBQD4NhgbbfjFt",
  "sessionID": "ses_6852784ecffeuHwynj83p2lr14",
  "messageID": "msg_a933ec9c1001mjRpLu7e6zmObu",
  "type": "tool",
  "callID": "call_36498101",
  "tool": "read",
  "state": {
    "status": "completed",
    "input": {
      "filePath": "components/diagnostic/ApiMasterTab.tsx",
      "offset": 75
    },
    "output": "<file>\n00076|   },\n00077|   {\n00078|     name: 'КИТ',\n00079|     key: 'kit',\n00080|     category: 'transport',\n00081|     status: 'unknown',\n00082|     credentials: {\n00083|       token: process.env.KIT_API_TOKEN || ''\n00084|     },\n00085|     endpoints: ['/api/kit'],\n00086|     description: 'Транспортная компания КИТ - доставка посылок'\n00087|   },\n00088|   {\n00089|     name: 'Деловые Линии',\n00090|     key: 'dellin',\n00091|     category: 'transport',\n00092|     status: 'unknown',\n00093|     credentials: {\n00094|       appkey: 'E6C50E91-8E93-440F-9CC6-DEF9F0D68F1B',\n00095|       login: 'service@lavsit.ru',\n00096|       password: 'edcwsx123QAZ'\n00097|     },\n00098|     endpoints: ['/api/dellin-packages'],\n00099|     description: 'Транспортная компания Деловые Линии'\n00100|   },\n00101|   {\n00102|     name: 'Rail Continent',\n00103|     key: 'railcontinent',\n00104|     category: 'transport',\n00105|     status: 'unknown',\n00106|     credentials: {},\n00107|     endpoints: ['/api/rail-continent'],\n00108|     description: 'Железнодорожная доставка Rail Continent'\n00109|   },\n00110|   {\n00111|     name: 'DaData',\n00112|     key: 'dadata',\n00113|     category: 'service',\n00114|     status: 'unknown',\n00115|     credentials: {\n00116|       apiKey: 'eb87bbb3789bb43ed465f796892ea951f9e91008'\n00117|     },\n00118|     endpoints: ['https://suggestions.dadata.ru/suggestions/api/4_1/rs/suggest/address'],\n00119|     description: 'Сервис подсказок адресов DaData'\n00120|   },\n00121|   {\n00122|     name: 'Google Sheets',\n00123|     key: 'sheets',\n00124|     category: 'internal',\n00125|     status: 'unknown',\n00126|     credentials: {},\n00127|     endpoints: ['https://docs.google.com/spreadsheets/d/1e0P91PfGKVIuSWDY0ceWkIE7jD-vzD_xrIesBeQno1Y'],\n00128|     description: 'База данных товаров в Google Sheets'\n00129|   }\n00130| ];\n00131| \n00132| const ApiMasterTab: React.FC = () => {\n00133|   const [apis, setApis] = useState<ApiConfig[]>(API_CONFIGS);\n00134|   const [testingAll, setTestingAll] = useState(false);\n00135|   const [editingApi, setEditingApi] = useState<string | null>(null);\n00136|   const [editCredentials, setEditCredentials] = useState<{ [key: string]: string }>({});\n00137| \n00138|   // Load saved API configurations\n00139|   useEffect(() => {\n00140|     try {\n00141|       const saved = localStorage.getItem('apiConfigurations');\n00142|       if (saved) {\n00143|         const savedConfigs = JSON.parse(saved);\n00144|         setApis(prev => prev.map(api => ({\n00145|           ...api,\n00146|           credentials: savedConfigs[api.key] || api.credentials,\n00147|           status: savedConfigs[api.key + '_status'] || api.status,\n00148|           lastChecked: savedConfigs[api.key + '_lastChecked'] ? new Date(savedConfigs[api.key + '_lastChecked']) : api.lastChecked\n00149|         })));\n00150|       }\n00151|     } catch (error) {\n00152|       console.error('Error loading API configurations:', error);\n00153|     }\n00154|   }, []);\n00155| \n00156|   const saveApiConfigurations = useCallback(() => {\n00157|     try {\n00158|       const configToSave: { [key: string]: any } = {};\n00159|       apis.forEach(api => {\n00160|         configToSave[api.key] = api.credentials;\n00161|         configToSave[api.key + '_status'] = api.status;\n00162|         configToSave[api.key + '_lastChecked'] = api.lastChecked?.toISOString();\n00163|       });\n00164|       localStorage.setItem('apiConfigurations', JSON.stringify(configToSave));\n00165|     } catch (error) {\n00166|       console.error('Error saving API configurations:', error);\n00167|     }\n00168|   }, [apis]);\n00169| \n00170|   const testApi = useCallback(async (api: ApiConfig) => {\n00171|     setApis(prev => prev.map(a =>\n00172|       a.key === api.key ? { ...a, status: 'unknown' as const } : a\n00173|     ));\n00174| \n00175|     try {\n00176|       let testResult = false;\n00177|       let errorMessage = '';\n00178| \n00179|       // Test based on API type\n00180|       switch (api.key) {\n00181|         case 'pek':\n00182|           const pekResponse = await apiRequestWithTimeout('/api/pek', {\n00183|             method: 'POST',\n00184|             headers: { 'Content-Type': 'application/json' },\n00185|             body: JSON.stringify({ method: 'test' })\n00186|           });\n00187|           testResult = pekResponse.ok;\n00188|           if (!pekResponse.ok) {\n00189|             const errorData = await pekResponse.text();\n00190|             errorMessage = errorData.includes('<!DOCTYPE') ? 'Неверные учетные данные' : errorData;\n00191|           }\n00192|           break;\n00193| \n00194|         case 'vozovoz':\n00195|           const vozResponse = await apiRequestWithTimeout('/api/vozovoz', {\n00196|             method: 'POST',\n00197|             headers: { 'Content-Type': 'application/json' },\n00198|             body: JSON.stringify({\n00199|               object: \"price\",\n00200|               action: \"get\",\n00201|               params: {\n00202|                 cargo: { dimension: { quantity: 1, volume: 0.1, weight: 10 } },\n00203|                 gateway: {\n00204|                   dispatch: { point: { location: \"Москва\", terminal: \"default\" } },\n00205|                   destination: { point: { location: \"СПб\", terminal: \"default\" } }\n00206|                 }\n00207|               }\n00208|             })\n00209|           });\n00210|           testResult = vozResponse.ok;\n00211|           if (!vozResponse.ok) {\n00212|             const errorData = await vozResponse.text();\n00213|             errorMessage = errorData.includes('<!DOCTYPE') ? 'Токен устарел' : 'Ошибка API';\n00214|           }\n00215|           break;\n00216| \n00217|         case 'cdek':\n00218|           const cdekResponse = await apiRequestWithTimeout('/api/cdek', {\n00219|             method: 'POST',\n00220|             headers: { 'Content-Type': 'application/json' },\n00221|             body: JSON.stringify({\n00222|               from_city: 'Москва',\n00223|               to_city: 'СПб',\n00224|               packages: [{ height: 10, length: 20, width: 10, weight: 1000 }]\n00225|             })\n00226|           });\n00227|           testResult = cdekResponse.ok;\n00228|           if (!cdekResponse.ok) {\n00229|             const errorData = await cdekResponse.text();\n00230|             errorMessage = errorData.includes('<!DOCTYPE') ? 'Учетные данные устарели' : 'Ошибка API';\n00231|           }\n00232|           break;\n00233| \n00234|         case 'kit':\n00235|           const kitResponse = await apiRequestWithTimeout('/api/kit', {\n00236|             method: 'POST',\n00237|             headers: { 'Content-Type': 'application/json' },\n00238|             body: JSON.stringify({\n00239|               from_city: 'Москва',\n00240|               to_city: 'СПб',\n00241|               declared_price: 10000\n00242|             })\n00243|           });\n00244|           testResult = kitResponse.ok;\n00245|           if (!kitResponse.ok) {\n00246|             const errorData = await kitResponse.text();\n00247|             errorMessage = errorData.includes('<!DOCTYPE') ? 'Токен отсутствует' : 'Ошибка API';\n00248|           }\n00249|           break;\n00250| \n00251|         case 'dellin':\n00252|           const dellinResponse = await apiRequestWithTimeout('/api/dellin-packages', {\n00253|             method: 'POST',\n00254|             headers: { 'Content-Type': 'application/json' },\n00255|             body: JSON.stringify({ method: 'test' })\n00256|           });\n00257|           testResult = dellinResponse.ok;\n00258|           break;\n00259| \n00260|         case 'railcontinent':\n00261|           const railResponse = await apiRequestWithTimeout('/api/rail-continent', {\n00262|             method: 'POST',\n00263|             headers: { 'Content-Type': 'application/json' },\n00264|             body: JSON.stringify({ method: 'test' })\n00265|           });\n00266|           testResult = railResponse.ok;\n00267|           break;\n00268| \n00269|         case 'dadata':\n00270|           const dadataResponse = await fetch('https://suggestions.dadata.ru/suggestions/api/4_1/rs/suggest/address', {\n00271|             method: 'POST',\n00272|             headers: {\n00273|               'Content-Type': 'application/json',\n00274|               'Authorization': `Token ${api.credentials.apiKey}`\n00275|             },\n00276|             body: JSON.stringify({ query: 'Москва', count: 1 })\n00277|           });\n00278|           testResult = dadataResponse.ok;\n00279|           break;\n00280| \n00281|         default:\n00282|           testResult = true; // For internal APIs, assume working\n00283|       }\n00284| \n00285|       setApis(prev => prev.map(a =>\n00286|         a.key === api.key ? {\n00287|           ...a,\n00288|           status: testResult ? 'working' : 'error',\n00289|           lastChecked: new Date(),\n00290|           errorMessage: testResult ? undefined : errorMessage\n00291|         } : a\n00292|       ));\n00293| \n00294|     } catch (error) {\n00295|       setApis(prev => prev.map(a =>\n00296|         a.key === api.key ? {\n00297|           ...a,\n00298|           status: 'error',\n00299|           lastChecked: new Date(),\n00300|           errorMessage: 'Сетевая ошибка'\n00301|         } : a\n00302|       ));\n00303|     }\n00304|   }, []);\n00305| \n00306|   const testAllApis = useCallback(async () => {\n00307|     setTestingAll(true);\n00308|     for (const api of apis) {\n00309|       await testApi(api);\n00310|       await new Promise(resolve => setTimeout(resolve, 500)); // Delay between tests\n00311|     }\n00312|     setTestingAll(false);\n00313|     saveApiConfigurations();\n00314|   }, [apis, testApi, saveApiConfigurations]);\n00315| \n00316|   const startEditing = useCallback((apiKey: string) => {\n00317|     const api = apis.find(a => a.key === apiKey);\n00318|     if (api) {\n00319|       setEditingApi(apiKey);\n00320|       setEditCredentials({ ...api.credentials });\n00321|     }\n00322|   }, [apis]);\n00323| \n00324|   const saveCredentials = useCallback(() => {\n00325|     if (editingApi) {\n00326|       setApis(prev => prev.map(a =>\n00327|         a.key === editingApi ? { ...a, credentials: { ...editCredentials } } : a\n00328|       ));\n00329|       setEditingApi(null);\n00330|       saveApiConfigurations();\n00331|     }\n00332|   }, [editingApi, editCredentials, saveApiConfigurations]);\n00333| \n00334|   const getStatusIcon = (status: string) => {\n00335|     switch (status) {\n00336|       case 'working': return <CheckCircle className=\"h-4 w-4 text-green-500\" />;\n00337|       case 'error': return <XCircle className=\"h-4 w-4 text-red-500\" />;\n00338|       case 'expired': return <AlertTriangle className=\"h-4 w-4 text-yellow-500\" />;\n00339|       default: return <RefreshCw className=\"h-4 w-4 text-gray-500\" />;\n00340|     }\n00341|   };\n00342| \n00343|   const getStatusText = (status: string) => {\n00344|     switch (status) {\n00345|       case 'working': return 'Работает';\n00346|       case 'error': return 'Ошибка';\n00347|       case 'expired': return 'Устарел';\n00348|       default: return 'Неизвестно';\n00349|     }\n00350|   };\n00351| \n00352|   const getCategoryIcon = (category: string) => {\n00353|     switch (category) {\n00354|       case 'transport': return <Truck className=\"h-4 w-4\" />;\n00355|       case 'service': return <Globe className=\"h-4 w-4\" />;\n00356|       case 'internal': return <Database className=\"h-4 w-4\" />;\n00357|       default: return <Settings className=\"h-4 w-4\" />;\n00358|     }\n00359|   };\n00360| \n00361|   const transportApis = apis.filter(api => api.category === 'transport');\n00362|   const serviceApis = apis.filter(api => api.category === 'service');\n00363|   const internalApis = apis.filter(api => api.category === 'internal');\n00364| \n00365|   return (\n00366|     <div className=\"space-y-6\">\n00367|       <div className=\"flex justify-between items-center\">\n00368|         <div>\n00369|           <h2 className=\"text-2xl font-bold text-white mb-2\">Все API</h2>\n00370|           <p className=\"text-gray-400\">Централизованное управление всеми API приложения</p>\n00371|         </div>\n00372|         <Button\n00373|           onClick={testAllApis}\n00374|           disabled={testingAll}\n00375|           className=\"bg-blue-600 hover:bg-blue-700\"\n00376|         >\n00377|           {testingAll ? (\n00378|             <>\n00379|               <RefreshCw className=\"h-4 w-4 mr-2 animate-spin\" />\n00380|               Тестирование...\n00381|             </>\n00382|           ) : (\n00383|             <>\n00384|               <Play className=\"h-4 w-4 mr-2\" />\n00385|               Протестировать все\n00386|             </>\n00387|           )}\n00388|         </Button>\n00389|       </div>\n00390| \n00391|       <Tabs defaultValue=\"transport\" className=\"w-full\">\n00392|         <TabsList className=\"grid w-full grid-cols-3 bg-gray-800 border-gray-700\">\n00393|           <TabsTrigger value=\"transport\" className=\"text-white\">\n00394|             <Truck className=\"h-4 w-4 mr-2\" />\n00395|             Транспорт ({transportApis.length})\n00396|           </TabsTrigger>\n00397|           <TabsTrigger value=\"service\" className=\"text-white\">\n00398|             <Globe className=\"h-4 w-4 mr-2\" />\n00399|             Сервисы ({serviceApis.length})\n00400|           </TabsTrigger>\n00401|           <TabsTrigger value=\"internal\" className=\"text-white\">\n00402|             <Database className=\"h-4 w-4 mr-2\" />\n00403|             Внутренние ({internalApis.length})\n00404|           </TabsTrigger>\n00405|         </TabsList>\n00406| \n00407|         <TabsContent value=\"transport\" className=\"mt-6\">\n00408|           <div className=\"grid gap-4\">\n00409|             {transportApis.map((api) => (\n00410|               <Card key={api.key} className=\"bg-gray-800 border-gray-700\">\n00411|                 <CardHeader className=\"pb-3\">\n00412|                   <div className=\"flex items-center justify-between\">\n00413|                     <div className=\"flex items-center gap-3\">\n00414|                       {getCategoryIcon(api.category)}\n00415|                       <div>\n00416|                         <CardTitle className=\"text-white text-lg\">{api.name}</CardTitle>\n00417|                         <p className=\"text-gray-400 text-sm\">{api.description}</p>\n00418|                       </div>\n00419|                     </div>\n00420|                     <div className=\"flex items-center gap-2\">\n00421|                       {getStatusIcon(api.status)}\n00422|                       <Badge variant={api.status === 'working' ? 'default' : 'destructive'}>\n00423|                         {getStatusText(api.status)}\n00424|                       </Badge>\n00425|                     </div>\n00426|                   </div>\n00427|                 </CardHeader>\n00428|                 <CardContent>\n00429|                   <div className=\"space-y-4\">\n00430|                     {api.errorMessage && (\n00431|                       <Alert className=\"border-red-500 bg-red-900/20\">\n00432|                         <AlertTriangle className=\"h-4 w-4\" />\n00433|                         <AlertDescription className=\"text-red-400\">\n00434|                           {api.errorMessage}\n00435|                         </AlertDescription>\n00436|                       </Alert>\n00437|                     )}\n00438| \n00439|                     <div className=\"grid grid-cols-2 gap-4\">\n00440|                       <div>\n00441|                         <Label className=\"text-gray-300 text-sm\">Последняя проверка</Label>\n00442|                         <p className=\"text-white text-sm\">\n00443|                           {api.lastChecked ? api.lastChecked.toLocaleString('ru-RU') : 'Не проверялся'}\n00444|                         </p>\n00445|                       </div>\n00446|                       <div>\n00447|                         <Label className=\"text-gray-300 text-sm\">Эндпоинты</Label>\n00448|                         <div className=\"flex flex-wrap gap-1\">\n00449|                           {api.endpoints.map((endpoint, idx) => (\n00450|                             <Badge key={idx} variant=\"outline\" className=\"text-xs\">\n00451|                               {endpoint}\n00452|                             </Badge>\n00453|                           ))}\n00454|                         </div>\n00455|                       </div>\n00456|                     </div>\n00457| \n00458|                     <div className=\"flex gap-2\">\n00459|                       <Button\n00460|                         onClick={() => testApi(api)}\n00461|                         variant=\"outline\"\n00462|                         size=\"sm\"\n00463|                         className=\"border-blue-500 text-blue-400 hover:bg-blue-900/20\"\n00464|                       >\n00465|                         <Play className=\"h-3 w-3 mr-1\" />\n00466|                         Тест\n00467|                       </Button>\n00468|                       <Button\n00469|                         onClick={() => startEditing(api.key)}\n00470|                         variant=\"outline\"\n00471|                         size=\"sm\"\n00472|                         className=\"border-green-500 text-green-400 hover:bg-green-900/20\"\n00473|                       >\n00474|                         <Key className=\"h-3 w-3 mr-1\" />\n00475|                         Ключи\n00476|                       </Button>\n00477|                     </div>\n00478| \n00479|                     {editingApi === api.key && (\n00480|                       <Card className=\"bg-gray-700 border-gray-600 mt-4\">\n00481|                         <CardHeader className=\"pb-2\">\n00482|                           <CardTitle className=\"text-white text-sm\">Редактирование учетных данных</CardTitle>\n00483|                         </CardHeader>\n00484|                         <CardContent className=\"space-y-3\">\n00485|                           {Object.keys(api.credentials).map((key) => (\n00486|                             <div key={key}>\n00487|                               <Label className=\"text-gray-300 text-sm capitalize\">{key}</Label>\n00488|                               <Input\n00489|                                 type={key.includes('secret') || key.includes('password') ? 'password' : 'text'}\n00490|                                 value={editCredentials[key] || ''}\n00491|                                 onChange={(e) => setEditCredentials(prev => ({ ...prev, [key]: e.target.value }))}\n00492|                                 className=\"bg-gray-600 border-gray-500 text-white\"\n00493|                               />\n00494|                             </div>\n00495|                           ))}\n00496|                           <div className=\"flex gap-2\">\n00497|                             <Button onClick={saveCredentials} size=\"sm\" className=\"bg-green-600 hover:bg-green-700\">\n00498|                               Сохранить\n00499|                             </Button>\n00500|                             <Button onClick={() => setEditingApi(null)} variant=\"outline\" size=\"sm\">\n00501|                               Отмена\n00502|                             </Button>\n00503|                           </div>\n00504|                         </CardContent>\n00505|                       </Card>\n00506|                     )}\n00507|                   </div>\n00508|                 </CardContent>\n00509|               </Card>\n00510|             ))}\n00511|           </div>\n00512|         </TabsContent>\n00513| \n00514|         <TabsContent value=\"service\" className=\"mt-6\">\n00515|           <div className=\"grid gap-4\">\n00516|             {serviceApis.map((api) => (\n00517|               <Card key={api.key} className=\"bg-gray-800 border-gray-700\">\n00518|                 <CardHeader className=\"pb-3\">\n00519|                   <div className=\"flex items-center justify-between\">\n00520|                     <div className=\"flex items-center gap-3\">\n00521|                       {getCategoryIcon(api.category)}\n00522|                       <div>\n00523|                         <CardTitle className=\"text-white text-lg\">{api.name}</CardTitle>\n00524|                         <p className=\"text-gray-400 text-sm\">{api.description}</p>\n00525|                       </div>\n00526|                     </div>\n00527|                     <div className=\"flex items-center gap-2\">\n00528|                       {getStatusIcon(api.status)}\n00529|                       <Badge variant={api.status === 'working' ? 'default' : 'destructive'}>\n00530|                         {getStatusText(api.status)}\n00531|                       </Badge>\n00532|                     </div>\n00533|                   </div>\n00534|                 </CardHeader>\n00535|                 <CardContent>\n00536|                   <div className=\"space-y-4\">\n00537|                     {api.errorMessage && (\n00538|                       <Alert className=\"border-red-500 bg-red-900/20\">\n00539|                         <AlertTriangle className=\"h-4 w-4\" />\n00540|                         <AlertDescription className=\"text-red-400\">\n00541|                           {api.errorMessage}\n00542|                         </AlertDescription>\n00543|                       </Alert>\n00544|                     )}\n00545| \n00546|                     <div className=\"flex gap-2\">\n00547|                       <Button\n00548|                         onClick={() => testApi(api)}\n00549|                         variant=\"outline\"\n00550|                         size=\"sm\"\n00551|                         className=\"border-blue-500 text-blue-400 hover:bg-blue-900/20\"\n00552|                       >\n00553|                         <Play className=\"h-3 w-3 mr-1\" />\n00554|                         Тест\n00555|                       </Button>\n00556|                       <Button\n00557|                         onClick={() => startEditing(api.key)}\n00558|                         variant=\"outline\"\n00559|                         size=\"sm\"\n00560|                         className=\"border-green-500 text-green-400 hover:bg-green-900/20\"\n00561|                       >\n00562|                         <Key className=\"h-3 w-3 mr-1\" />\n00563|                         Ключи\n00564|                       </Button>\n00565|                     </div>\n00566|                   </div>\n00567|                 </CardContent>\n00568|               </Card>\n00569|             ))}\n00570|           </div>\n00571|         </TabsContent>\n00572| \n00573|         <TabsContent value=\"internal\" className=\"mt-6\">\n00574|           <div className=\"grid gap-4\">\n00575|             {internalApis.map((api) => (\n00576|               <Card key={api.key} className=\"bg-gray-800 border-gray-700\">\n00577|                 <CardHeader className=\"pb-3\">\n00578|                   <div className=\"flex items-center justify-between\">\n00579|                     <div className=\"flex items-center gap-3\">\n00580|                       {getCategoryIcon(api.category)}\n00581|                       <div>\n00582|                         <CardTitle className=\"text-white text-lg\">{api.name}</CardTitle>\n00583|                         <p className=\"text-gray-400 text-sm\">{api.description}</p>\n00584|                       </div>\n00585|                     </div>\n00586|                     <div className=\"flex items-center gap-2\">\n00587|                       {getStatusIcon(api.status)}\n00588|                       <Badge variant={api.status === 'working' ? 'default' : 'destructive'}>\n00589|                         {getStatusText(api.status)}\n00590|                       </Badge>\n00591|                       <Button\n00592|                         onClick={() => window.open(api.endpoints[0], '_blank')}\n00593|                         variant=\"outline\"\n00594|                         size=\"sm\"\n00595|                         className=\"border-purple-500 text-purple-400 hover:bg-purple-900/20\"\n00596|                       >\n00597|                         <ExternalLink className=\"h-3 w-3 mr-1\" />\n00598|                         Открыть\n00599|                       </Button>\n00600|                     </div>\n00601|                   </div>\n00602|                 </CardHeader>\n00603|               </Card>\n00604|             ))}\n00605|           </div>\n00606|         </TabsContent>\n00607|       </Tabs>\n00608|     </div>\n00609|   );\n00610| };\n00611| \n00612| export default ApiMasterTab;\n</file>",
    "title": "components/diagnostic/ApiMasterTab.tsx",
    "metadata": {
      "preview": "  },\n  {\n    name: 'КИТ',\n    key: 'kit',\n    category: 'transport',\n    status: 'unknown',\n    credentials: {\n      token: process.env.KIT_API_TOKEN || ''\n    },\n    endpoints: ['/api/kit'],\n    description: 'Транспортная компания КИТ - доставка посылок'\n  },\n  {\n    name: 'Деловые Линии',\n    key: 'dellin',\n    category: 'transport',\n    status: 'unknown',\n    credentials: {\n      appkey: 'E6C50E91-8E93-440F-9CC6-DEF9F0D68F1B',\n      login: 'service@lavsit.ru',"
    },
    "time": {
      "start": 1763406958158,
      "end": 1763406958160
    }
  }
}