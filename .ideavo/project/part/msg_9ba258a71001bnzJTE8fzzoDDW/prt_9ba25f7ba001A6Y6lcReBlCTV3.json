{
  "id": "prt_9ba25f7ba001A6Y6lcReBlCTV3",
  "messageID": "msg_9ba258a71001bnzJTE8fzzoDDW",
  "sessionID": "ses_6852784ecffeuHwynj83p2lr14",
  "type": "tool",
  "tool": "write",
  "callID": "toolu_013rnCsmHYEuut4fb4ENs2LG",
  "state": {
    "status": "completed",
    "input": {
      "filePath": "/home/user/project/public/persistent-form-guardian.js",
      "content": "// PERSISTENT FORM DATA GUARDIAN\n// Защищает данные формы от любых видов очистки localStorage\n(function() {\n  'use strict';\n  \n  console.log('[FORM-GUARDIAN] Инициализация защиты данных формы...');\n  \n  const FORM_DATA_KEY = 'deliveryFormData';\n  const APP_VERSION_KEY = 'appVersion';\n  const BACKUP_KEYS = ['formBackup1', 'formBackup2', 'formBackup3'];\n  \n  let formDataBackup = null;\n  let appVersionBackup = null;\n  let guardianActive = false;\n  \n  // Функция сохранения данных в резервные копии\n  function createBackups() {\n    try {\n      const formData = localStorage.getItem(FORM_DATA_KEY);\n      const appVersion = localStorage.getItem(APP_VERSION_KEY);\n      \n      if (formData) {\n        formDataBackup = formData;\n        // Создаем несколько резервных копий в localStorage\n        BACKUP_KEYS.forEach((key, index) => {\n          setTimeout(() => {\n            try {\n              localStorage.setItem(key, formData);\n            } catch (e) {\n              console.warn('[FORM-GUARDIAN] Backup failed for:', key, e);\n            }\n          }, index * 10);\n        });\n      }\n      \n      if (appVersion) {\n        appVersionBackup = appVersion;\n        localStorage.setItem('appVersionBackup', appVersion);\n      }\n      \n      console.log('[FORM-GUARDIAN] Backup created:', !!formData, !!appVersion);\n    } catch (e) {\n      console.warn('[FORM-GUARDIAN] Backup creation failed:', e);\n    }\n  }\n  \n  // Функция восстановления данных\n  function restoreFormData() {\n    try {\n      let restored = false;\n      \n      // Проверяем, нужно ли восстановление\n      const currentFormData = localStorage.getItem(FORM_DATA_KEY);\n      if (currentFormData) {\n        console.log('[FORM-GUARDIAN] Form data already exists, no restore needed');\n        return;\n      }\n      \n      // Пытаемся восстановить из memory backup\n      if (formDataBackup) {\n        localStorage.setItem(FORM_DATA_KEY, formDataBackup);\n        console.log('[FORM-GUARDIAN] Restored from memory backup');\n        restored = true;\n      }\n      \n      // Пытаемся восстановить из localStorage backups\n      if (!restored) {\n        for (const backupKey of BACKUP_KEYS) {\n          const backup = localStorage.getItem(backupKey);\n          if (backup) {\n            localStorage.setItem(FORM_DATA_KEY, backup);\n            console.log('[FORM-GUARDIAN] Restored from', backupKey);\n            restored = true;\n            break;\n          }\n        }\n      }\n      \n      // Восстанавливаем версию приложения\n      if (appVersionBackup && !localStorage.getItem(APP_VERSION_KEY)) {\n        localStorage.setItem(APP_VERSION_KEY, appVersionBackup);\n        console.log('[FORM-GUARDIAN] App version restored');\n      }\n      \n      if (restored) {\n        console.log('[FORM-GUARDIAN] ✅ Form data successfully restored');\n        // Пересоздаем backup после восстановления\n        setTimeout(createBackups, 100);\n      } else {\n        console.log('[FORM-GUARDIAN] No backup data found for restoration');\n      }\n      \n    } catch (e) {\n      console.warn('[FORM-GUARDIAN] Restore failed:', e);\n    }\n  }\n  \n  // Мониторинг изменений localStorage\n  function monitorLocalStorage() {\n    if (guardianActive) return;\n    \n    guardianActive = true;\n    console.log('[FORM-GUARDIAN] Monitoring localStorage changes...');\n    \n    // Сохраняем текущие данные\n    createBackups();\n    \n    // Периодически проверяем и восстанавливаем данные\n    const restoreInterval = setInterval(() => {\n      const formData = localStorage.getItem(FORM_DATA_KEY);\n      if (!formData && (formDataBackup || localStorage.getItem(BACKUP_KEYS[0]))) {\n        console.log('[FORM-GUARDIAN] Detected data loss, restoring...');\n        restoreFormData();\n      }\n    }, 500);\n    \n    // Отложенное восстановление после загрузки страницы\n    setTimeout(() => {\n      restoreFormData();\n    }, 1000);\n    \n    // Дополнительное восстановление через 3 секунды (после всех Clear-Site-Data)\n    setTimeout(() => {\n      restoreFormData();\n    }, 3000);\n    \n    // Обновляем backup при изменениях\n    const originalSetItem = localStorage.setItem;\n    localStorage.setItem = function(key, value) {\n      originalSetItem.call(this, key, value);\n      if (key === FORM_DATA_KEY || key === APP_VERSION_KEY) {\n        setTimeout(createBackups, 50);\n      }\n    };\n    \n    // Восстанавливаем при storage events\n    window.addEventListener('storage', function(e) {\n      if (e.key === FORM_DATA_KEY && !e.newValue && formDataBackup) {\n        console.log('[FORM-GUARDIAN] Storage event detected data loss, restoring...');\n        setTimeout(restoreFormData, 100);\n      }\n    });\n    \n    console.log('[FORM-GUARDIAN] ✅ Guardian activated');\n  }\n  \n  // Запускаем мониторинг\n  if (document.readyState === 'loading') {\n    document.addEventListener('DOMContentLoaded', monitorLocalStorage);\n  } else {\n    monitorLocalStorage();\n  }\n  \n  // Запускаем немедленно\n  setTimeout(monitorLocalStorage, 0);\n  \n})();"
    },
    "output": "",
    "metadata": {
      "diagnostics": {},
      "filepath": "/home/user/project/public/persistent-form-guardian.js",
      "exists": false
    },
    "title": "public/persistent-form-guardian.js",
    "time": {
      "start": 1759764695137,
      "end": 1759764695139
    }
  }
}