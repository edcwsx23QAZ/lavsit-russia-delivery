{
  "id": "prt_99b19db35001svCdUjE0h01c5V",
  "messageID": "msg_99b16aa1e001QfQg1JT69eYmBJ",
  "sessionID": "ses_6852784ecffeuHwynj83p2lr14",
  "type": "tool",
  "tool": "write",
  "callID": "toolu_013LpFdjeyDHmHJ5qNmTDMXy",
  "state": {
    "status": "completed",
    "input": {
      "filePath": "/home/user/project/app/diagnostic/optimized-page.tsx",
      "content": "'use client';\n\nimport React, { useEffect, useCallback } from 'react';\nimport { useDiagnosticState } from '@/hooks/useDiagnosticState';\nimport DiagnosticHeader from '@/components/diagnostic/DiagnosticHeader';\nimport ApiTestingSection from '@/components/diagnostic/ApiTestingSection';\nimport { LazyFullTestingResults, LazyVehicleManagement } from '@/components/diagnostic/LazyLoadedComponents';\nimport { apiRequestWithTimeout, PerformanceMonitor } from '@/lib/api-utils';\n\nexport default function OptimizedDiagnosticPage() {\n  const { state, actions } = useDiagnosticState();\n\n  // Initialize data on mount\n  useEffect(() => {\n    try {\n      const saved = localStorage.getItem('vehicleTypes');\n      if (saved) {\n        const parsedVehicleTypes = JSON.parse(saved);\n        actions.initializeVehicleTypes(parsedVehicleTypes, null);\n      }\n      \n      const lastUpdate = localStorage.getItem('lastProductDataUpdate');\n      if (lastUpdate) {\n        actions.setLastUpdateTime(new Date(lastUpdate).toLocaleString('ru-RU'));\n      }\n    } catch (error) {\n      console.error('Ошибка загрузки сохранённых данных:', error);\n    }\n  }, [actions]);\n\n  // API testing functions with performance monitoring\n  const testAPI = useCallback(async (service: string, endpoint: string, data: any = {}) => {\n    const endTiming = PerformanceMonitor.startMeasurement(`diagnostic_${service}`);\n    actions.setTestingState(service, true);\n    \n    try {\n      const response = await apiRequestWithTimeout(endpoint, {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify(data)\n      }, { timeout: 15000, retries: 1 });\n\n      const result = await response.json();\n      const timing = endTiming();\n\n      if (response.ok) {\n        actions.setDiagnosticResult(service.toLowerCase(), {\n          status: 'success',\n          message: `✅ ${service} API работает корректно`,\n          details: result,\n          timing\n        });\n      } else {\n        actions.setDiagnosticResult(service.toLowerCase(), {\n          status: 'error',\n          message: `❌ Ошибка ${service} API: ${result.error || 'Неизвестная ошибка'}`,\n          details: result,\n          timing\n        });\n      }\n    } catch (error) {\n      endTiming();\n      actions.setDiagnosticResult(service.toLowerCase(), {\n        status: 'error',\n        message: `❌ Сетевая ошибка ${service} API`,\n        details: error instanceof Error ? error.message : 'Неизвестная ошибка'\n      });\n    } finally {\n      actions.setTestingState(service, false);\n    }\n  }, [actions]);\n\n  const testPEK = useCallback(() => {\n    testAPI('PEK', '/api/pek', { method: 'test' });\n  }, [testAPI]);\n\n  const testDellin = useCallback(() => {\n    testAPI('Dellin', '/api/dellin-packages', { method: 'test' });\n  }, [testAPI]);\n\n  const testRailContinent = useCallback(() => {\n    testAPI('RailContinent', '/api/rail-continent', { method: 'test' });\n  }, [testAPI]);\n\n  const testVozovoz = useCallback(() => {\n    testAPI('Vozovoz', '/api/vozovoz', { method: 'test' });\n  }, [testAPI]);\n\n  const testNordWheel = useCallback(() => {\n    testAPI('NordWheel', '/api/test', { service: 'nordwheel' });\n  }, [testAPI]);\n\n  const testAllAPIs = useCallback(async () => {\n    actions.resetDiagnosticResults();\n    \n    const tests = [\n      () => testPEK(),\n      () => testDellin(), \n      () => testRailContinent(),\n      () => testVozovoz(),\n      () => testNordWheel()\n    ];\n\n    // Run tests in parallel for better performance\n    await Promise.allSettled(tests.map(test => test()));\n  }, [actions, testPEK, testDellin, testRailContinent, testVozovoz, testNordWheel]);\n\n  const runFullTesting = useCallback(async () => {\n    actions.setFullTesting(true);\n    actions.setTestProgress({ \n      currentTK: 'Начинаем тестирование...', \n      completedTests: 0, \n      totalPlannedTests: 25, \n      stage: 'Инициализация',\n      progress: 0 \n    });\n\n    const startTime = Date.now();\n    const results: any[] = [];\n    const errors: string[] = [];\n\n    const testCases = [\n      { service: 'ПЭК', endpoint: '/api/pek', data: { method: 'test' } },\n      { service: 'Деловые Линии', endpoint: '/api/dellin-packages', data: { method: 'test' } },\n      { service: 'Rail Continent', endpoint: '/api/rail-continent', data: { method: 'test' } },\n      { service: 'Возовоз', endpoint: '/api/vozovoz', data: { method: 'test' } },\n      { service: 'Nord Wheel', endpoint: '/api/test', data: { service: 'nordwheel' } }\n    ];\n\n    for (let i = 0; i < testCases.length; i++) {\n      const testCase = testCases[i];\n      const progress = Math.round(((i + 1) / testCases.length) * 100);\n      \n      actions.setTestProgress({\n        currentTK: testCase.service,\n        completedTests: i,\n        totalPlannedTests: testCases.length,\n        stage: 'Тестирование API',\n        progress\n      });\n\n      try {\n        const response = await apiRequestWithTimeout(testCase.endpoint, {\n          method: 'POST',\n          headers: { 'Content-Type': 'application/json' },\n          body: JSON.stringify(testCase.data)\n        }, { timeout: 10000 });\n\n        const result = await response.json();\n        \n        results.push({\n          company: testCase.service,\n          status: response.ok ? 'passed' : 'failed',\n          message: response.ok ? 'Тест пройден успешно' : result.error || 'Ошибка теста',\n          details: result,\n          timing: result.timing || 0,\n          timestamp: new Date().toISOString()\n        });\n\n        if (!response.ok) {\n          errors.push(`${testCase.service}: ${result.error || 'Неизвестная ошибка'}`);\n        }\n      } catch (error) {\n        results.push({\n          company: testCase.service,\n          status: 'failed',\n          message: 'Сетевая ошибка или таймаут',\n          details: error instanceof Error ? error.message : 'Неизвестная ошибка',\n          timing: 0,\n          timestamp: new Date().toISOString()\n        });\n        errors.push(`${testCase.service}: Сетевая ошибка`);\n      }\n\n      // Small delay for UI updates\n      await new Promise(resolve => setTimeout(resolve, 200));\n    }\n\n    const endTime = Date.now();\n    const totalTime = endTime - startTime;\n    const successful = results.filter(r => r.status === 'passed').length;\n    const failed = results.filter(r => r.status === 'failed').length;\n    const averageTime = results.reduce((sum, r) => sum + r.timing, 0) / results.length;\n\n    actions.setFullTestResults({\n      summary: {\n        totalTests: results.length,\n        successful,\n        failed,\n        skipped: 0,\n        errors,\n        averageResponseTime: Math.round(averageTime),\n        successRate: (successful / results.length) * 100\n      },\n      details: results,\n      progressInfo: null\n    });\n\n    actions.setTestProgress(null);\n    actions.setFullTesting(false);\n  }, [actions]);\n\n  // Vehicle management functions\n  const addVehicleType = useCallback(() => {\n    const { name, length, width, height } = state.newVehicle;\n    \n    if (!name || !length || !width || !height) {\n      alert('Пожалуйста, заполните все поля');\n      return;\n    }\n    \n    const newId = (state.vehicleTypes.length + 1).toString();\n    const vehicleToAdd = {\n      id: newId,\n      name,\n      length: parseInt(length),\n      width: parseInt(width),\n      height: parseInt(height)\n    };\n    \n    actions.addVehicleType(vehicleToAdd);\n  }, [state.newVehicle, state.vehicleTypes.length, actions]);\n\n  const saveVehicleTypes = useCallback(async () => {\n    actions.setSavingState(true);\n    actions.setSaveStatus('saving');\n    \n    try {\n      localStorage.setItem('vehicleTypes', JSON.stringify(state.vehicleTypes));\n      await new Promise(resolve => setTimeout(resolve, 1000));\n      \n      actions.setUnsavedChanges(false);\n      actions.setSaveStatus('success');\n      setTimeout(() => actions.setSaveStatus('idle'), 3000);\n    } catch (error) {\n      console.error('Ошибка сохранения:', error);\n      actions.setSaveStatus('error');\n      setTimeout(() => actions.setSaveStatus('idle'), 5000);\n    } finally {\n      actions.setSavingState(false);\n    }\n  }, [state.vehicleTypes, actions]);\n\n  const updateProductData = useCallback(async () => {\n    actions.setUpdatingData(true);\n    actions.setUpdateStatus('updating');\n    \n    try {\n      const response = await apiRequestWithTimeout('/api/furniture-products?update=true&force=true&timestamp=' + Date.now(), {\n        method: 'GET',\n        headers: {\n          'Cache-Control': 'no-cache, no-store, must-revalidate',\n          'Pragma': 'no-cache',\n          'Expires': '0'\n        }\n      }, { timeout: 30000 });\n\n      const result = await response.json();\n      \n      if (!result.success) {\n        throw new Error(result.error || 'Ошибка обновления данных');\n      }\n\n      const updateTime = new Date().toLocaleString('ru-RU');\n      localStorage.setItem('lastProductDataUpdate', new Date().toISOString());\n      actions.setLastUpdateTime(updateTime);\n      actions.setUpdateStatus('success');\n      \n      setTimeout(() => actions.setUpdateStatus('idle'), 3000);\n    } catch (error) {\n      console.error('Ошибка обновления данных:', error);\n      actions.setUpdateStatus('error');\n      setTimeout(() => actions.setUpdateStatus('idle'), 5000);\n    } finally {\n      actions.setUpdatingData(false);\n    }\n  }, [actions]);\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 p-6\">\n      <div className=\"max-w-7xl mx-auto\">\n        <DiagnosticHeader\n          onTestAllAPIs={testAllAPIs}\n          onRunFullTesting={runFullTesting}\n          onUpdateProductData={updateProductData}\n          isFullTesting={state.isFullTesting}\n          isUpdatingData={state.isUpdatingData}\n          updateStatus={state.updateStatus}\n        />\n\n        <ApiTestingSection\n          diagnosticResults={state.diagnosticResults}\n          testStates={{\n            isTestingPEK: state.isTestingPEK,\n            isTestingDellin: state.isTestingDellin,\n            isTestingRailContinent: state.isTestingRailContinent,\n            isTestingVozovoz: state.isTestingVozovoz,\n            isTestingNordWheel: state.isTestingNordWheel,\n          }}\n          onTestPEK={testPEK}\n          onTestDellin={testDellin}\n          onTestRailContinent={testRailContinent}\n          onTestVozovoz={testVozovoz}\n          onTestNordWheel={testNordWheel}\n        />\n\n        <LazyFullTestingResults\n          fullTestResults={state.fullTestResults}\n          testProgress={state.testProgress?.progress || 0}\n          isFullTesting={state.isFullTesting}\n        />\n\n        <LazyVehicleManagement\n          vehicleTypes={state.vehicleTypes}\n          newVehicle={state.newVehicle}\n          hasUnsavedChanges={state.hasUnsavedChanges}\n          saveStatus={state.saveStatus}\n          isSaving={state.isSaving}\n          lastUpdateTime={state.lastUpdateTime}\n          onAddVehicleType={addVehicleType}\n          onRemoveVehicleType={actions.removeVehicleType}\n          onUpdateVehicleType={actions.updateVehicleType}\n          onSaveVehicleTypes={saveVehicleTypes}\n          onSetNewVehicle={actions.setNewVehicle}\n        />\n      </div>\n    </div>\n  );\n}"
    },
    "output": "",
    "metadata": {
      "diagnostics": {},
      "filepath": "/home/user/project/app/diagnostic/optimized-page.tsx",
      "exists": false
    },
    "title": "app/diagnostic/optimized-page.tsx",
    "time": {
      "start": 1759243826268,
      "end": 1759243826269
    }
  }
}