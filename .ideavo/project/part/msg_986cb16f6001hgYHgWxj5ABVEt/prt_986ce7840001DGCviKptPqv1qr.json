{
  "id": "prt_986ce7840001DGCviKptPqv1qr",
  "messageID": "msg_986cb16f6001hgYHgWxj5ABVEt",
  "sessionID": "ses_6852784ecffeuHwynj83p2lr14",
  "type": "tool",
  "tool": "edit",
  "callID": "toolu_01WZ7XP9He6TGmNiAYm4jt6h",
  "state": {
    "status": "completed",
    "input": {
      "filePath": "/home/user/project/app/page.tsx",
      "oldString": "  // Получение ID склада ПЭК по адресу через API\n  const findPekWarehouseId = async (address: string): Promise<string | null> => {\n    try {\n      // Используем API ПЭК для поиска склада по адресу\n      const response = await fetch('https://api.pecom.ru/v1/branches/findzonebyaddress', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': 'Basic ' + btoa('C04C5BF2AE367BDCBDC71E7DA520A69B167D1984:')\n        },\n        body: JSON.stringify({\n          address: address\n        })\n      });\n\n      if (response.ok) {\n        const data = await response.json();\n        return data.mainWarehouseId || null;\n      }\n      \n      // Фоллбэк для основных городов\n      const fallbackWarehouses: { [key: string]: string } = {\n        'москва': 'dc6c746d-812d-11e4-bbfc-001999d8b3c5',\n        'санкт-петербург': 'b436c978-086d-11e6-b6ca-00155d668909',\n        'екатеринбург': '550e8400-e29b-41d4-a716-446655440000'\n      };\n      \n      const normalizedCity = address.toLowerCase().trim()\n        .replace(/ё/g, 'е')\n        .replace(/[\\s\\-\\.]+/g, '');\n      \n      for (const [city, warehouseId] of Object.entries(fallbackWarehouses)) {\n        const normalizedCityKey = city.replace(/[\\s\\-\\.]+/g, '');\n        if (normalizedCity.includes(normalizedCityKey) || normalizedCityKey.includes(normalizedCity)) {\n          return warehouseId;\n        }\n      }\n      \n      return null;\n    } catch (error) {\n      console.error('Ошибка поиска склада ПЭК:', error);\n      return null;\n    }\n  };\n\n  // Расчет для ПЭК через публичный API\n  const calculatePEK = async (): Promise<CalculationResult> => {\n    const apiUrl = 'http://calc.pecom.ru/bitrix/components/pecom/calc/ajax.php';\n    \n    try {\n      // Получаем ID городов\n      const fromCityId = await findPekCityId(form.fromCity);\n      const toCityId = await findPekCityId(form.toCity);\n      \n      if (!fromCityId || !toCityId) {\n        return {\n          company: 'ПЭК',\n          price: 0,\n          days: 0,\n          error: `Город не найден в базе ПЭК. Проверьте: ${!fromCityId ? form.fromCity : ''} ${!toCityId ? form.toCity : ''}`.trim(),\n          apiUrl,\n          requestData: { fromCity: form.fromCity, toCity: form.toCity, fromCityId, toCityId },\n          responseData: null\n        };\n      }\n\n      // Формируем параметры запроса согласно публичной документации\n      const params = new URLSearchParams();\n      \n      // Добавляем грузы согласно формату: Ширина (м), Длина (м), Высота (м), Объем (м3), Вес (кг), Негабарит (0/1), ЗТУ (0/1)\n      form.cargos.forEach((cargo, index) => {\n        const width = cargo.width / 100; // переводим см в метры\n        const length = cargo.length / 100;\n        const height = cargo.height / 100;\n        const volume = width * length * height;\n        const weight = cargo.weight;\n        const isOversized = (width > 2.4 || length > 12 || height > 2.7 || weight > 1500) ? 1 : 0;\n        const needZTU = form.needPackaging ? 1 : 0;\n        \n        params.append(`places[${index}][]`, width.toString());\n        params.append(`places[${index}][]`, length.toString());\n        params.append(`places[${index}][]`, height.toString());\n        params.append(`places[${index}][]`, volume.toString());\n        params.append(`places[${index}][]`, weight.toString());\n        params.append(`places[${index}][]`, isOversized.toString());\n        params.append(`places[${index}][]`, needZTU.toString());\n      });\n      \n      // Параметры забора\n      params.append('take[town]', fromCityId.toString());\n      params.append('take[tent]', '0'); // растентровка\n      params.append('take[gidro]', form.needLoading ? '1' : '0'); // гидролифт\n      params.append('take[manip]', '0'); // манипулятор\n      params.append('take[speed]', '0'); // срочный забор\n      params.append('take[moscow]', '0'); // ограничения по Москве\n      \n      // Параметры доставки\n      params.append('deliver[town]', toCityId.toString());\n      params.append('deliver[tent]', '0');\n      params.append('deliver[gidro]', form.needLoading ? '1' : '0');\n      params.append('deliver[manip]', '0');\n      params.append('deliver[speed]', '0');\n      params.append('deliver[moscow]', '0');\n      \n      // Дополнительные услуги\n      params.append('plombir', '0'); // пломбы\n      params.append('strah', form.needInsurance ? form.declaredValue.toString() : '0'); // страховка\n      params.append('ashan', '0'); // доставка в Ашан\n      params.append('night', '0'); // ночное время\n      params.append('pal', '0'); // запаллечивание\n      params.append('pallets', '0'); // паллетная перевозка\n\n      const fullUrl = `${apiUrl}?${params.toString()}`;\n      const requestData = Object.fromEntries(params);\n\n      console.log('ПЭК запрос URL:', fullUrl);\n      console.log('ПЭК параметры:', requestData);\n\n      // Прямой запрос к API (без прокси, так как HTTPS сайт может делать HTTP запросы)\n      const response = await fetch(fullUrl);\n      const data = await response.json();\n      \n      console.log('ПЭК ответ:', data);\n\n      if (response.ok && data.success) {\n        let totalPrice = 0;\n        let services: { name: string; description: string; price: number }[] = [];\n        \n        // Основная стоимость доставки\n        if (data.data?.totalCost) {\n          totalPrice = data.data.totalCost;\n          \n          // Разбивка по услугам если доступна\n          if (data.data.services) {\n            data.data.services.forEach((service: any) => {\n              services.push({\n                name: service.name || 'Услуга ПЭК',\n                description: service.description || '',\n                price: service.cost || 0\n              });\n            });\n          } else {\n            // Основная услуга\n            services.push({\n              name: 'Доставка груза',\n              description: `${form.fromCity} - ${form.toCity}`,\n              price: totalPrice\n            });\n          }\n        }\n        \n        // Забор груза\n        if (data.data?.pickupCost && form.fromAddressDelivery) {\n          services.push({\n            name: 'Забор груза',\n            description: 'От адреса отправителя',\n            price: data.data.pickupCost\n          });\n        }\n        \n        // Доставка до адреса\n        if (data.data?.deliveryCost && form.toAddressDelivery) {\n          services.push({\n            name: 'Доставка груза',\n            description: 'До адреса получателя',\n            price: data.data.deliveryCost\n          });\n        }\n\n        // Срок доставки\n        const deliveryDays = data.data?.deliveryDays || 3;\n\n        return {\n          company: 'ПЭК',\n          price: Math.round(totalPrice),\n          days: deliveryDays,\n          details: {\n            services,\n            totalCost: data.data?.totalCost,\n            pickupCost: data.data?.pickupCost,\n            deliveryCost: data.data?.deliveryCost,\n            deliveryDays: data.data?.deliveryDays,\n            fromCityId,\n            toCityId,\n            rawData: data.data\n          },\n          requestData,\n          responseData: data,\n          apiUrl\n        };\n      } else {\n        // Фоллбэк - возвращаем заглушку если API не работает\n        const totalWeight = form.cargos.reduce((sum, cargo) => sum + cargo.weight, 0);\n        let basePrice = totalWeight * 15; // 15 руб за кг базовая ставка\n        \n        if (form.fromAddressDelivery) basePrice += 500; // забор\n        if (form.toAddressDelivery) basePrice += 500; // доставка\n        if (form.needInsurance) basePrice += form.declaredValue * 0.01; // страховка\n        if (form.needPackaging) basePrice += totalWeight * 20; // упаковка\n        \n        return {\n          company: 'ПЭК',\n          price: Math.round(basePrice),\n          days: 3,\n          details: {\n            note: 'Расчет произведен по базовым тарифам (API недоступен)',\n            fromCityId,\n            toCityId,\n            services: [\n              { name: 'Доставка груза', description: `${form.fromCity} - ${form.toCity}`, price: basePrice }\n            ]\n          },\n          requestData,\n          responseData: data,\n          apiUrl,\n          error: data.message || data.error || 'API ПЭК временно недоступен, показан примерный расчет'\n        };\n      }\n    } catch (error: any) {\n      // Фоллбэк расчет при ошибке соединения\n      const totalWeight = form.cargos.reduce((sum, cargo) => sum + cargo.weight, 0);\n      let basePrice = totalWeight * 15; // 15 руб за кг\n      \n      if (form.fromAddressDelivery) basePrice += 500;\n      if (form.toAddressDelivery) basePrice += 500; \n      if (form.needInsurance) basePrice += form.declaredValue * 0.01;\n      if (form.needPackaging) basePrice += totalWeight * 20;\n      \n      return {\n        company: 'ПЭК',\n        price: Math.round(basePrice),\n        days: 3,\n        details: {\n          note: 'Примерный расчет по базовым тарифам (ошибка соединения с API)',\n          services: [\n            { name: 'Доставка груза', description: `${form.fromCity} - ${form.toCity}`, price: basePrice }\n          ]\n        },\n        requestData: null,\n        responseData: null,\n        apiUrl,\n        error: `Ошибка соединения: ${error.message}. Показан примерный расчет.`\n      };\n    }\n  };",
      "newString": ""
    },
    "output": "",
    "metadata": {
      "diagnostics": {},
      "diff": "Index: /home/user/project/app/page.tsx\n===================================================================\n--- /home/user/project/app/page.tsx\n+++ /home/user/project/app/page.tsx\n@@ -1201,254 +1201,10 @@\n     };\n   }\n };\n \n-// Получение ID склада ПЭК по адресу через API\n-const findPekWarehouseId = async (address: string): Promise<string | null> => {\n-  try {\n-    // Используем API ПЭК для поиска склада по адресу\n-    const response = await fetch('https://api.pecom.ru/v1/branches/findzonebyaddress', {\n-      method: 'POST',\n-      headers: {\n-        'Content-Type': 'application/json',\n-        'Authorization': 'Basic ' + btoa('C04C5BF2AE367BDCBDC71E7DA520A69B167D1984:')\n-      },\n-      body: JSON.stringify({\n-        address: address\n-      })\n-    });\n \n-    if (response.ok) {\n-      const data = await response.json();\n-      return data.mainWarehouseId || null;\n-    }\n-    \n-    // Фоллбэк для основных городов\n-    const fallbackWarehouses: { [key: string]: string } = {\n-      'москва': 'dc6c746d-812d-11e4-bbfc-001999d8b3c5',\n-      'санкт-петербург': 'b436c978-086d-11e6-b6ca-00155d668909',\n-      'екатеринбург': '550e8400-e29b-41d4-a716-446655440000'\n-    };\n-    \n-    const normalizedCity = address.toLowerCase().trim()\n-      .replace(/ё/g, 'е')\n-      .replace(/[\\s\\-\\.]+/g, '');\n-    \n-    for (const [city, warehouseId] of Object.entries(fallbackWarehouses)) {\n-      const normalizedCityKey = city.replace(/[\\s\\-\\.]+/g, '');\n-      if (normalizedCity.includes(normalizedCityKey) || normalizedCityKey.includes(normalizedCity)) {\n-        return warehouseId;\n-      }\n-    }\n-    \n-    return null;\n-  } catch (error) {\n-    console.error('Ошибка поиска склада ПЭК:', error);\n-    return null;\n-  }\n-};\n \n-// Расчет для ПЭК через публичный API\n-const calculatePEK = async (): Promise<CalculationResult> => {\n-  const apiUrl = 'http://calc.pecom.ru/bitrix/components/pecom/calc/ajax.php';\n-  \n-  try {\n-    // Получаем ID городов\n-    const fromCityId = await findPekCityId(form.fromCity);\n-    const toCityId = await findPekCityId(form.toCity);\n-    \n-    if (!fromCityId || !toCityId) {\n-      return {\n-        company: 'ПЭК',\n-        price: 0,\n-        days: 0,\n-        error: `Город не найден в базе ПЭК. Проверьте: ${!fromCityId ? form.fromCity : ''} ${!toCityId ? form.toCity : ''}`.trim(),\n-        apiUrl,\n-        requestData: { fromCity: form.fromCity, toCity: form.toCity, fromCityId, toCityId },\n-        responseData: null\n-      };\n-    }\n-\n-    // Формируем параметры запроса согласно публичной документации\n-    const params = new URLSearchParams();\n-    \n-    // Добавляем грузы согласно формату: Ширина (м), Длина (м), Высота (м), Объем (м3), Вес (кг), Негабарит (0/1), ЗТУ (0/1)\n-    form.cargos.forEach((cargo, index) => {\n-      const width = cargo.width / 100; // переводим см в метры\n-      const length = cargo.length / 100;\n-      const height = cargo.height / 100;\n-      const volume = width * length * height;\n-      const weight = cargo.weight;\n-      const isOversized = (width > 2.4 || length > 12 || height > 2.7 || weight > 1500) ? 1 : 0;\n-      const needZTU = form.needPackaging ? 1 : 0;\n-      \n-      params.append(`places[${index}][]`, width.toString());\n-      params.append(`places[${index}][]`, length.toString());\n-      params.append(`places[${index}][]`, height.toString());\n-      params.append(`places[${index}][]`, volume.toString());\n-      params.append(`places[${index}][]`, weight.toString());\n-      params.append(`places[${index}][]`, isOversized.toString());\n-      params.append(`places[${index}][]`, needZTU.toString());\n-    });\n-    \n-    // Параметры забора\n-    params.append('take[town]', fromCityId.toString());\n-    params.append('take[tent]', '0'); // растентровка\n-    params.append('take[gidro]', form.needLoading ? '1' : '0'); // гидролифт\n-    params.append('take[manip]', '0'); // манипулятор\n-    params.append('take[speed]', '0'); // срочный забор\n-    params.append('take[moscow]', '0'); // ограничения по Москве\n-    \n-    // Параметры доставки\n-    params.append('deliver[town]', toCityId.toString());\n-    params.append('deliver[tent]', '0');\n-    params.append('deliver[gidro]', form.needLoading ? '1' : '0');\n-    params.append('deliver[manip]', '0');\n-    params.append('deliver[speed]', '0');\n-    params.append('deliver[moscow]', '0');\n-    \n-    // Дополнительные услуги\n-    params.append('plombir', '0'); // пломбы\n-    params.append('strah', form.needInsurance ? form.declaredValue.toString() : '0'); // страховка\n-    params.append('ashan', '0'); // доставка в Ашан\n-    params.append('night', '0'); // ночное время\n-    params.append('pal', '0'); // запаллечивание\n-    params.append('pallets', '0'); // паллетная перевозка\n-\n-    const fullUrl = `${apiUrl}?${params.toString()}`;\n-    const requestData = Object.fromEntries(params);\n-\n-    console.log('ПЭК запрос URL:', fullUrl);\n-    console.log('ПЭК параметры:', requestData);\n-\n-    // Прямой запрос к API (без прокси, так как HTTPS сайт может делать HTTP запросы)\n-    const response = await fetch(fullUrl);\n-    const data = await response.json();\n-    \n-    console.log('ПЭК ответ:', data);\n-\n-    if (response.ok && data.success) {\n-      let totalPrice = 0;\n-      let services: { name: string; description: string; price: number }[] = [];\n-      \n-      // Основная стоимость доставки\n-      if (data.data?.totalCost) {\n-        totalPrice = data.data.totalCost;\n-        \n-        // Разбивка по услугам если доступна\n-        if (data.data.services) {\n-          data.data.services.forEach((service: any) => {\n-            services.push({\n-              name: service.name || 'Услуга ПЭК',\n-              description: service.description || '',\n-              price: service.cost || 0\n-            });\n-          });\n-        } else {\n-          // Основная услуга\n-          services.push({\n-            name: 'Доставка груза',\n-            description: `${form.fromCity} - ${form.toCity}`,\n-            price: totalPrice\n-          });\n-        }\n-      }\n-      \n-      // Забор груза\n-      if (data.data?.pickupCost && form.fromAddressDelivery) {\n-        services.push({\n-          name: 'Забор груза',\n-          description: 'От адреса отправителя',\n-          price: data.data.pickupCost\n-        });\n-      }\n-      \n-      // Доставка до адреса\n-      if (data.data?.deliveryCost && form.toAddressDelivery) {\n-        services.push({\n-          name: 'Доставка груза',\n-          description: 'До адреса получателя',\n-          price: data.data.deliveryCost\n-        });\n-      }\n-\n-      // Срок доставки\n-      const deliveryDays = data.data?.deliveryDays || 3;\n-\n-      return {\n-        company: 'ПЭК',\n-        price: Math.round(totalPrice),\n-        days: deliveryDays,\n-        details: {\n-          services,\n-          totalCost: data.data?.totalCost,\n-          pickupCost: data.data?.pickupCost,\n-          deliveryCost: data.data?.deliveryCost,\n-          deliveryDays: data.data?.deliveryDays,\n-          fromCityId,\n-          toCityId,\n-          rawData: data.data\n-        },\n-        requestData,\n-        responseData: data,\n-        apiUrl\n-      };\n-    } else {\n-      // Фоллбэк - возвращаем заглушку если API не работает\n-      const totalWeight = form.cargos.reduce((sum, cargo) => sum + cargo.weight, 0);\n-      let basePrice = totalWeight * 15; // 15 руб за кг базовая ставка\n-      \n-      if (form.fromAddressDelivery) basePrice += 500; // забор\n-      if (form.toAddressDelivery) basePrice += 500; // доставка\n-      if (form.needInsurance) basePrice += form.declaredValue * 0.01; // страховка\n-      if (form.needPackaging) basePrice += totalWeight * 20; // упаковка\n-      \n-      return {\n-        company: 'ПЭК',\n-        price: Math.round(basePrice),\n-        days: 3,\n-        details: {\n-          note: 'Расчет произведен по базовым тарифам (API недоступен)',\n-          fromCityId,\n-          toCityId,\n-          services: [\n-            { name: 'Доставка груза', description: `${form.fromCity} - ${form.toCity}`, price: basePrice }\n-          ]\n-        },\n-        requestData,\n-        responseData: data,\n-        apiUrl,\n-        error: data.message || data.error || 'API ПЭК временно недоступен, показан примерный расчет'\n-      };\n-    }\n-  } catch (error: any) {\n-    // Фоллбэк расчет при ошибке соединения\n-    const totalWeight = form.cargos.reduce((sum, cargo) => sum + cargo.weight, 0);\n-    let basePrice = totalWeight * 15; // 15 руб за кг\n-    \n-    if (form.fromAddressDelivery) basePrice += 500;\n-    if (form.toAddressDelivery) basePrice += 500; \n-    if (form.needInsurance) basePrice += form.declaredValue * 0.01;\n-    if (form.needPackaging) basePrice += totalWeight * 20;\n-    \n-    return {\n-      company: 'ПЭК',\n-      price: Math.round(basePrice),\n-      days: 3,\n-      details: {\n-        note: 'Примерный расчет по базовым тарифам (ошибка соединения с API)',\n-        services: [\n-          { name: 'Доставка груза', description: `${form.fromCity} - ${form.toCity}`, price: basePrice }\n-        ]\n-      },\n-      requestData: null,\n-      responseData: null,\n-      apiUrl,\n-      error: `Ошибка соединения: ${error.message}. Показан примерный расчет.`\n-    };\n-  }\n-};\n-\n const calculateRailContinent = async (): Promise<CalculationResult> => {\n   await new Promise(resolve => setTimeout(resolve, 1200));\n   const basePrice = form.cargos.reduce((sum, cargo) => sum + cargo.weight * 12, 0);\n   let totalPrice = basePrice;\n"
    },
    "title": "app/page.tsx",
    "time": {
      "start": 1758903348186,
      "end": 1758903348224
    }
  }
}