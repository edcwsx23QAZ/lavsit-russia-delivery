{
  "id": "prt_9e2e42304001LjsNIe2GoDyumP",
  "type": "text",
  "text": "Используй пример следующего варианта расчета ТК Новая Линия\n\nПопробуй его реализовать\n\nКонечно, давайте разработаем готовый автономный код и промпт для такого калькулятора.\n\nАнализ консоли и структуры:\n\nКонсольный лог, который вы предоставили, содержит повторяющиеся сообщения, указывающие на инициализацию элементов калькулятора (page_5d8967560ae1d08f53aa7f8b07afe141_v1.js). Важные фрагменты: * init0: input.input.form-control.decimal.c_volume.c_volume1 - это явный указатель на то, что есть элемент для объема (c_volume), и он, вероятно, является полем ввода (input). * .closest(.calculator__param) .c_volume - этот селектор подсказывает, что элементы калькулятора находятся внутри контейнеров с классами, вроде .calculator__param. * Failed to load resource: net::ERR_BLOCKED_BY_CLIENT - это сообщение от Facebook SDK, не имеет отношения к функционалу калькулятора. * You are running production build of Inferno in development mode. - Подтверждает использование фреймворка (Inferno, похожий на React) и наличие клиентского JavaScript.\n\nИсходя из этого, мы можем предположить, что поля ввода имеют узнаваемые классы или имена.\n\nОписание Вводных Данных для Калькулятора\nПриложение, которое будет использовать этот калькулятор, должно собирать следующие данные от пользователя.\n\n1. Общие Параметры Груза:\n\nКоличество мест: quantity (целое число, по умолчанию 1)\nЕдиницы измерения объема: volume_unit (строка, например, \"m3\" - кубические метры, \"cm3\" - кубические сантиметры; скорее всего, на сайте tknl.ru есть дефолтные единицы, которые надо учитывать)\nГабариты одного места:\nlength (число, в соответствующих единицах, например, см)\nwidth (число, в соответствующих единицах, например, см)\nheight (число, в соответствующих единицах, например, см)\n2. Параметры Груза:\n\nВес: weight (число, например, кг)\nОбъявленная стоимость: declared_value (число)\nТип груза: cargo_type (строка, например, \"Посылка\", \"Груз\", \"Документы\"; если tknl.ru поддерживает различие)\n3. Адреса и Терминалы:\n\nМесто забора:\npickup_type (строка: \"address\" - адрес, \"terminal\" - терминал)\npickup_address (строка: полный адрес, если pickup_type == \"address\")\npickup_terminal_code (строка: код терминала, если pickup_type == \"terminal\")\nМесто доставки:\ndelivery_type (строка: \"address\" - адрес, \"terminal\" - терминал)\ndelivery_address (строка: полный адрес, если delivery_type == \"address\")\ndelivery_terminal_code (строка: код терминала, если delivery_type == \"terminal\")\n4. Дополнительные Услуги:\n\nТребуется упаковка: requires_packaging (булево: true / false)\nТребуется погрузка/разгрузка: requires_loading_unloading (булево: true / false)\nРучной подъем: requires_manual_handling (булево: true / false)\nЭтаж для ручного подъема: manual_handling_floor (целое число, если requires_manual_handling == true)\nНаличие грузового лифта: has_freight_elevator (булево: true / false, если requires_manual_handling == true)\nPython Код (Flask + Playwright)\nЭтот код является автономным и может быть запущен как отдельное приложение. Он реализует веб-сервер, который принимает данные, отправляет их на tknl.ru/calculator/ через автоматизацию браузера и возвращает результат.\n\n# main.py\n\nimport os\nfrom flask import Flask, request, jsonify, render_template\nfrom playwright.sync_api import sync_playwright, TimeoutError as PlaywrightTimeoutError\nfrom bs4 import BeautifulSoup # Для парсинга HTML\n\napp = Flask(__name__)\n\n# --- КОНФИГУРАЦИЯ И СЕЛЕКТОРЫ ---\n# Эти селекторы являются предположениями, основанными на вашем логе.\n# ИХ НЕОБХОДИМО ПРОТЕСТИРОВАТЬ И, ВОЗМОЖНО, ИЗМЕНИТЬ\n# путем анализа реальной страницы https://tknl.ru/calculator/\nSELECTOR_MAP = {\n    \"length\": \"input.c_size.length\",         # Поле ввода длины\n    \"width\": \"input.c_size.width\",          # Поле ввода ширины\n    \"height\": \"input.c_size.height\",         # Поле ввода высоты\n    \"weight\": \"input.c_weight_b.weight_b\", # Поле ввода веса\n    \"from_location\": \"input.c_city.from\",     # Поле ввода города отправления (предположение)\n    \"to_location\": \"input.c_city.to\",         # Поле ввода города назначения (предположение)\n    \"declared_value\": \"input.c_value\",      # Поле для объявленной стоимости (предположение)\n    \"packaging_checkbox\": \"input[type='checkbox'][name='packaging']\", # Чекбокс упаковки (предположение)\n    \"loading_unloading_checkbox\": \"input[type='checkbox'][name='loading']\", # Чекбокс погрузки (предположение)\n    \"manual_handling_checkbox\": \"input[type='checkbox'][name='manual_lift']\", # Чекбокс ручного подъема (предположение)\n    \"manual_handling_floor\": \"input.c_floor\", # Поле для этажа (предположение)\n    \"has_freight_elevator_checkbox\": \"input[type='checkbox'][name='freight_elevator']\", # Чекбокс лифта (предположение)\n\n    \"calculate_button\": \"button.calculator__btn-calc\", # Кнопка рассчитать (пример)\n    \"result_area\": \".calculator__total-price span\",    # Элемент с итоговой стоимостью (пример)\n    \"delivery_time_area\": \".calculator__delivery-time span\", # Элемент со сроком доставки (пример)\n    \"pickup_terminal_option\": \"select[name='pickup_type'] option[value='terminal']\", # Опция выбора терминала для забора\n    \"delivery_terminal_option\": \"select[name='delivery_type'] option[value='terminal']\", # Опция выбора терминала для доставки\n    \"pickup_terminal_input\": \"input.c_terminal_code.pickup\", # Поле для ввода кода терминала забора (предположение)\n    \"delivery_terminal_input\": \"input.c_terminal_code.delivery\" # Поле для ввода кода терминала доставки (предположение)\n}\n\nTARGET_URL = \"https://tknl.ru/calculator/\"\n# --------------------\n\ndef get_delivery_cost_from_tknl(data):\n    \"\"\"\n    Автоматизирует заполнение формы на https://tknl.ru/calculator/\n    и извлекает стоимость доставки.\n    \"\"\"\n    try:\n        with sync_playwright() as p:\n            browser = p.chromium.launch(headless=True)\n            page = browser.new_page()\n\n            page.goto(TARGET_URL, wait_until='domcontentloaded', timeout=30000) # Увеличим таймаут\n\n            # --- Заполнение полей ---\n            # Функция для безопасного заполнения полей\n            def safe_fill(selector, value, field_name):\n                if value is not None and value != \"\":\n                    try:\n                        element = page.locator(selector).element_handle()\n                        if element:\n                            element.fill(str(value))\n                            print(f\"Заполнено поле '{field_name}' ({selector}) значением: {value}\")\n                        else:\n                            print(f\"ПРЕДУПРЕЖДЕНИЕ: Элемент '{field_name}' ({selector}) не найден.\")\n                    except Exception as e:\n                        print(f\"Ошибка при заполнении поля '{field_name}' ({selector}): {e}\")\n\n            # Проверяем, существуют ли селекторы в DOM перед заполнением\n            # (это может быть полезно, если элементы подгружаются динамически)\n            page.wait_for_selector(SELECTOR_MAP[\"length\"], state='visible', timeout=15000)\n\n            safe_fill(SELECTOR_MAP[\"length\"], data.get(\"length\"), \"Длина\")\n            safe_fill(SELECTOR_MAP[\"width\"], data.get(\"width\"), \"Ширина\")\n            safe_fill(SELECTOR_MAP[\"height\"], data.get(\"height\"), \"Высота\")\n            safe_fill(SELECTOR_MAP[\"weight\"], data.get(\"weight\"), \"Вес\")\n            safe_fill(SELECTOR_MAP[\"declared_value\"], data.get(\"declared_value\"), \"Объявленная стоимость\")\n\n            # Обработка адресов/терминалов\n            if data.get(\"pickup_type\") == \"terminal\" and data.get(\"pickup_terminal_code\"):\n                # Выбираем опцию \"Терминал\" для забора\n                try:\n                    page.locator(SELECTOR_MAP[\"pickup_terminal_option\"]).click()\n                    safe_fill(SELECTOR_MAP[\"pickup_terminal_input\"], data[\"pickup_terminal_code\"], \"Терминал забора\")\n                except Exception as e:\n                    print(f\"Не удалось выбрать терминал забора: {e}\")\n            elif data.get(\"pickup_type\") == \"address\" and data.get(\"pickup_address\"):\n                safe_fill(SELECTOR_MAP[\"from_location\"], data[\"pickup_address\"], \"Адрес забора\")\n\n            if data.get(\"delivery_type\") == \"terminal\" and data.get(\"delivery_terminal_code\"):\n                # Выбираем опцию \"Терминал\" для доставки\n                try:\n                    page.locator(SELECTOR_MAP[\"delivery_terminal_option\"]).click()\n                    safe_fill(SELECTOR_MAP[\"delivery_terminal_input\"], data[\"delivery_terminal_code\"], \"Терминал доставки\")\n                except Exception as e:\n                    print(f\"Не удалось выбрать терминал доставки: {e}\")\n            elif data.get(\"delivery_type\") == \"address\" and data.get(\"delivery_address\"):\n                safe_fill(SELECTOR_MAP[\"to_location\"], data[\"delivery_address\"], \"Адрес доставки\")\n\n            # Обработка чекбоксов (нужно ставить галочку, если true)\n            if data.get(\"requires_packaging\"):\n                try:\n                    page.locator(SELECTOR_MAP[\"packaging_checkbox\"]).check()\n                except Exception as e:\n                    print(f\"Ошибка при установке галочки упаковки: {e}\")\n            if data.get(\"requires_loading_unloading\"):\n                try:\n                    page.locator(SELECTOR_MAP[\"loading_unloading_checkbox\"]).check()\n                except Exception as e:\n                    print(f\"Ошибка при установке галочки погрузки/разгрузки: {e}\")\n            if data.get(\"requires_manual_handling\"):\n                try:\n                    page.locator(SELECTOR_MAP[\"manual_handling_checkbox\"]).check()\n                    safe_fill(SELECTOR_MAP[\"manual_handling_floor\"], data.get(\"manual_handling_floor\"), \"Этаж ручного подъема\")\n                    if data.get(\"has_freight_elevator\"):\n                        page.locator(SELECTOR_MAP[\"has_freight_elevator_checkbox\"]).check()\n                except Exception as e:\n                    print(f\"Ошибка при установке галочки ручного подъема/лифта: {e}\")\n\n            # --- Запуск расчета ---\n            try:\n                # Кликаем на кнопку расчета\n                calculate_button = page.locator(SELECTOR_MAP[\"calculate_button\"])\n                calculate_button.click()\n                print(\"Нажата кнопка 'Рассчитать'.\")\n            except Exception as e:\n                print(f\"Не удалось нажать кнопку расчета ({SELECTOR_MAP['calculate_button']}): {e}\")\n                return {\"error\": f\"Не удалось найти или нажать кнопку расчета. Возможно, изменилась структура сайта. Ошибка: {e}\"}\n\n            # --- Получение результатов ---\n            # Ждем появления элемента с результатом. Возможно, потребуется более сложная логика ожидания\n            # или парсинг всей страницы, если результат не выделен в отдельный элемент.\n            try:\n                # Ждем, пока появиться стоимость и срок\n                page.wait_for_selector(SELECTOR_MAP[\"result_area\"], state='visible', timeout=25000)\n                page.wait_for_selector(SELECTOR_MAP[\"delivery_time_area\"], state='visible', timeout=25000)\n\n                delivery_cost = page.locator(SELECTOR_MAP[\"result_area\"]).inner_text().strip()\n                delivery_time = page.locator(SELECTOR_MAP[\"delivery_time_area\"]).inner_text().strip()\n\n                # Дополнительный парсинг, если результаты не извлекаются напрямую\n                if not delivery_cost or \"...\" in delivery_cost:\n                    print(\"Получена пустая или некорректная стоимость, пробуем парсить всю страницу.\")\n                    html_content = page.content()\n                    soup = BeautifulSoup(html_content, 'html.parser')\n\n                    # Попробуем найти стоимость более универсально, если предыдущие селекторы не сработали\n                    cost_element_fallback = soup.select_one('.calculator__total-price') # Общий контейнер\n                    if cost_element_fallback:\n                        delivery_cost = cost_element_fallback.get_text(strip=True)\n\n                    # Попробуем найти срок доставки\n                    time_element_fallback = soup.select_one('.calculator__delivery-time')\n                    if time_element_fallback:\n                        delivery_time = time_element_fallback.get_text(strip=True)\n\n                print(f\"Результат: Стоимость='{delivery_cost}', Срок='{delivery_time}'\")\n                return {\"cost\": delivery_cost, \"delivery_time\": delivery_time, \"message\": \"Расчет успешно выполнен.\"}\n\n            except PlaywrightTimeoutError:\n                print(\"Timeout error occurred while waiting for result elements.\")\n                html_content = page.content() # Получаем HTML для анализа\n                return {\"error\": \"Превышено время ожидания результата. Возможно, расчет не удался или изменилась структура страницы.\", \"html_preview\": html_content[:1000] + \"...\"}\n            except Exception as e:\n                print(f\"Error extracting result: {e}\")\n                html_content = page.content()\n                return {\"error\": f\"Ошибка при извлечении результата: {str(e)}\", \"html_preview\": html_content[:1000] + \"...\"}\n\n    except PlaywrightTimeoutError:\n        print(\"Timeout error: Page did not load or elements not ready.\")\n        return {\"error\": \"Не удалось загрузить страницу калькулятора или элементы не появились вовремя.\"}\n    except Exception as e:\n        print(f\"An unexpected error occurred: {e}\")\n        return {\"error\": f\"Произошла непредвиденная ошибка: {str(e)}.\"}\n    finally:\n        browser.close()\n\n\n@app.route('/')\ndef index():\n    \"\"\"Главная страница с формой ввода.\"\"\"\n    return render_template('index.html')\n\n@app.route('/calculate', methods=['POST'])\ndef calculate_route():\n    \"\"\"API endpoint для обработки запросов расчета.\"\"\"\n    data = request.get_json()\n\n    if not data:\n        return jsonify({\"error\": \"Неверный формат запроса, ожидается JSON.\"}), 400\n\n    # Проверяем минимальный набор полей\n    # (можно добавить более строгие проверки типов и значений)\n    required_fields = [\"length\", \"width\", \"height\", \"weight\", \"from_city\", \"to_city\", \"pickup_type\", \"delivery_type\"]\n    if not all(field in data and data[field] is not None for field in required_fields):\n        missing = [field for field in required_fields if field not in data or data[field] is None]\n        return jsonify({\"error\": f\"Отсутствуют или пусты обязательные поля: {', '.join(missing)}.\"}), 400\n\n    # Выполняем расчет\n    result = get_delivery_cost_from_tknl(data)\n\n    return jsonify(result)\n\nif __name__ == '__main__':\n    # Для работы на Replit, используем host='0.0.0.0'\n    # Убедитесь, что в requirements.txt есть:\n    # flask\n    # playwright\n    # beautifulsoup4\n    # playwrigt install playwright --with-deps\n    app.run(host='0.0.0.0', port=int(os.environ.get(\"PORT\", 3000)))\n<!-- templates/index.html -->\n<!DOCTYPE html>\n<html lang=\"ru\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>Удаленный Калькулятор Доставки</title>\n    <style>\n        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; padding: 20px; background-color: #f0f2f5; color: #333; }\n        .container { max-width: 700px; margin: 20px auto; background-color: #fff; padding: 30px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }\n        h1 { color: #2c3e50; text-align: center; margin-bottom: 30px; }\n        label { display: block; margin-bottom: 8px; font-weight: 600; color: #34495e; }\n        input[type=\"text\"], input[type=\"number\"], select {\n            width: calc(100% - 24px); padding: 12px; margin-bottom: 15px;\n            border: 1px solid #dcdcdc; border-radius: 6px; box-sizing: border-box;\n            font-size: 16px;\n        }\n        input[type=\"number\"] { -moz-appearance: textfield; } /* Убираем стрелки в Firefox */\n        input[type=\"number\"]::-webkit-outer-spin-button,\n        input[type=\"number\"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; } /* Убираем стрелки в Chrome/Safari */\n\n        .address-group, .terminal-group { margin-bottom: 15px; border: 1px solid #e0e0e0; padding: 15px; border-radius: 6px; background-color: #f9f9f9; }\n        .address-group label, .terminal-group label { margin-bottom: 5px; }\n        .radio-group label { font-weight: normal; display: inline-block; margin-right: 15px; }\n        .radio-group input[type=\"radio\"] { margin-right: 5px; vertical-align: middle;}\n\n        button {\n            background-color: #28a745; color: white; padding: 12px 25px; border: none;\n            border-radius: 6px; cursor: pointer; font-size: 18px; font-weight: 600;\n            transition: background-color 0.3s ease; width: 100%;\n        }\n        button:hover { background-color: #218838; }\n        button:active { background-color: #1e7e34; }\n\n        .result { margin-top: 30px; padding: 20px; background-color: #e7f3ff; border: 1px solid #b0d4ff; border-radius: 6px; }\n        .result h2 { color: #007bff; margin-top: 0; }\n        .result p { margin-bottom: 10px; }\n        .error { color: #dc3545; font-weight: bold; }\n        .loading { font-style: italic; color: #6c757d; }\n        .hidden { display: none; }\n        .checkbox-group label { font-weight: normal; }\n        .checkbox-group input[type=\"checkbox\"] { margin-right: 8px; }\n        .additional-options { margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px; }\n        .additional-options legend { font-weight: 600; color: #34495e; margin-bottom: 15px; }\n        .additional-options div { margin-bottom: 10px; }\n        .floor-input-group { display: flex; gap: 10px; align-items: center; }\n        .floor-input-group input[type=\"number\"] { flex-grow: 1; }\n        .floor-input-group label { flex-shrink: 0; }\n    </style>\n</head>\n<body>\n    <div class=\"container\">\n        <h1>Калькулятор Стоимости Доставки</h1>\n        <form id=\"deliveryForm\">\n            <!-- Секция Забора -->\n            <div class=\"address-group\">\n                <label>Откуда забирать:</label>\n                <div class=\"radio-group\">\n                    <label><input type=\"radio\" name=\"pickup_type\" value=\"address\" checked> Адрес</label>\n                    <label><input type=\"radio\" name=\"pickup_type\" value=\"terminal\"> Терминал</label>\n                </div>\n                <div id=\"pickupAddressFields\">\n                    <label for=\"pickup_address\">Адрес забора:</label>\n                    <input type=\"text\" id=\"pickup_address\" name=\"pickup_address\" required placeholder=\"Например: г. Москва, ул. Примерная, д. 1\">\n                </div>\n                <div id=\"pickupTerminalFields\" class=\"hidden\">\n                    <label for=\"pickup_terminal_code\">Код терминала забора:</label>\n                    <input type=\"text\" id=\"pickup_terminal_code\" name=\"pickup_terminal_code\" placeholder=\"Например: MOW1\">\n                </div>\n            </div>\n\n            <!-- Секция Доставки -->\n            <div class=\"address-group\">\n                <label>Куда доставлять:</label>\n                <div class=\"radio-group\">\n                    <label><input type=\"radio\" name=\"delivery_type\" value=\"address\" checked> Адрес</label>\n                    <label><input type=\"radio\" name=\"delivery_type\" value=\"terminal\"> Терминал</label>\n                </div>\n                <div id=\"deliveryAddressFields\">\n                    <label for=\"delivery_address\">Адрес доставки:</label>\n                    <input type=\"text\" id=\"delivery_address\" name=\"delivery_address\" required placeholder=\"Например: г. Санкт-Петербург, пр. Невский, д. 10\">\n                </div>\n                <div id=\"deliveryTerminalFields\" class=\"hidden\">\n                    <label for=\"delivery_terminal_code\">Код терминала доставки:</label>\n                    <input type=\"text\" id=\"delivery_terminal_code\" name=\"delivery_terminal_code\" placeholder=\"Например: SPB1\">\n                </div>\n            </div>\n\n            <!-- Параметры груза -->\n            <div class=\"address-group\">\n                <label>Размеры груза (одного места):</label>\n                <div class=\"floor-input-group\">\n                    <label for=\"length\">Длина (см):</label>\n                    <input type=\"number\" id=\"length\" name=\"length\" step=\"0.1\" required value=\"50\">\n                    <label for=\"width\">Ширина (см):</label>\n                    <input type=\"number\" id=\"width\" name=\"width\" step=\"0.1\" required value=\"30\">\n                    <label for=\"height\">Высота (см):</label>\n                    <input type=\"number\" id=\"height\" name=\"height\" step=\"0.1\" required value=\"20\">\n                </div>\n                <label for=\"weight\">Вес (кг):</label>\n                <input type=\"number\" id=\"weight\" name=\"weight\" step=\"0.1\" required value=\"5\">\n                <label for=\"quantity\">Количество одинаковых мест:</label>\n                <input type=\"number\" id=\"quantity\" name=\"quantity\" required value=\"1\">\n            </div>\n\n            <div class=\"additional-options\">\n                <fieldset>\n                    <legend>Дополнительно:</legend>\n                    <div class=\"checkbox-group\">\n                        <input type=\"checkbox\" id=\"requires_packaging\" name=\"requires_packaging\">\n                        <label for=\"requires_packaging\">Требуется упаковка</label>\n                    </div>\n                    <div class=\"checkbox-group\">\n                        <input type=\"checkbox\" id=\"requires_loading_unloading\" name=\"requires_loading_unloading\">\n                        <label for=\"requires_loading_unloading\">Требуется погрузка/разгрузка</label>\n                    </div>\n                    <div class=\"checkbox-group\">\n                        <input type=\"checkbox\" id=\"requires_manual_handling\" name=\"requires_manual_handling\">\n                        <label for=\"requires_manual_handling\">Требуется ручной подъем</label>\n                    </div>\n                    <div id=\"manualHandlingDetails\" class=\"hidden floor-input-group\">\n                        <label for=\"manual_handling_floor\">Этаж:</label>\n                        <input type=\"number\" id=\"manual_handling_floor\" name=\"manual_handling_floor\" value=\"1\">\n                        <div class=\"checkbox-group\">\n                            <input type=\"checkbox\" id=\"has_freight_elevator\" name=\"has_freight_elevator\">\n                            <label for=\"has_freight_elevator\">Грузовой лифт</label>\n                        </div>\n                    </div>\n                </fieldset>\n            </div>\n\n            <div class=\"address-group\">\n                <label for=\"declared_value\">Объявленная стоимость:</label>\n                <input type=\"number\" id=\"declared_value\" name=\"declared_value\" step=\"0.01\" required value=\"1000\">\n            </div>\n\n            <button type=\"submit\">Рассчитать стоимость</button>\n        </form>\n\n        <div id=\"resultArea\" class=\"result hidden\">\n            <h2>Результат расчета:</h2>\n            <p><strong>Стоимость:</strong> <span id=\"costResult\"></span></p>\n            <p><strong>Срок доставки:</strong> <span id=\"timeResult\"></span></p>\n            <p id=\"errorMessage\" class=\"error hidden\"></p>\n            <p id=\"pagePreview\" class=\"loading\" style=\"display: none;\"></p>\n        </div>\n    </div>\n\n    <script>\n        document.addEventListener('DOMContentLoaded', function() {\n            const form = document.getElementById('deliveryForm');\n            const resultDiv = document.getElementById('resultArea');\n            const costResult = document.getElementById('costResult');\n            const timeResult = document.getElementById('timeResult');\n            const errorMessage = document.getElementById('errorMessage');\n            const pagePreview = document.getElementById('pagePreview');\n\n            const pickupAddressFields = document.getElementById('pickupAddressFields');\n            const pickupTerminalFields = document.getElementById('pickupTerminalFields');\n            const deliveryAddressFields = document.getElementById('deliveryAddressFields');\n            const deliveryTerminalFields = document.getElementById('deliveryTerminalFields');\n            const manualHandlingDetails = document.getElementById('manualHandlingDetails');\n\n            // Переключение полей для адреса/терминала\n            form.querySelectorAll('input[name=\"pickup_type\"]').forEach(radio => {\n                radio.addEventListener('change', (e) => {\n                    if (e.target.value === 'address') {\n                        pickupAddressFields.classList.remove('hidden');\n                        pickupTerminalFields.classList.add('hidden');\n                    } else {\n                        pickupAddressFields.classList.add('hidden');\n                        pickupTerminalFields.classList.remove('hidden');\n                    }\n                });\n            });\n\n            form.querySelectorAll('input[name=\"delivery_type\"]').forEach(radio => {\n                radio.addEventListener('change', (e) => {\n                    if (e.target.value === 'address') {\n                        deliveryAddressFields.classList.remove('hidden');\n                        deliveryTerminalFields.classList.add('hidden');\n                    } else {\n                        deliveryAddressFields.classList.add('hidden');\n                        deliveryTerminalFields.classList.remove('hidden');\n                    }\n                });\n            });\n\n            // Показ/скрытие деталей ручного подъема\n            const manualHandlingCheckbox = document.getElementById('requires_manual_handling');\n            manualHandlingCheckbox.addEventListener('change', () => {\n                manualHandlingDetails.classList.toggle('hidden', !manualHandlingCheckbox.checked);\n            });\n            // Инициализация состояния при загрузке\n            manualHandlingDetails.classList.add('hidden', !manualHandlingCheckbox.checked);\n\n\n            form.addEventListener('submit', async function(event) {\n                event.preventDefault();\n\n                const formData = new FormData(form);\n                const payload = {};\n\n                // Собираем данные формы\n                formData.forEach((value, key) => {\n                    // Преобразуем числовые поля\n                    if (key === 'length' || key === 'width' || key === 'height' || key === 'weight' ||\n                        key === 'quantity' || key === 'declared_value' || key === 'manual_handling_floor') {\n                        payload[key] = parseFloat(value);\n                    } else if (value === 'true') { // Для чекбоксов, если сервер их так передаст\n                         payload[key] = true;\n                    } else if (value === 'false') {\n                         payload[key] = false;\n                    }\n                    else {\n                        payload[key] = value;\n                    }\n                });\n\n                // Добавляем булевы значения для чекбоксов, если они не были выбраны\n                if (!payload.requires_packaging) payload.requires_packaging = false;\n                if (!payload.requires_loading_unloading) payload.requires_loading_unloading = false;\n                if (!payload.requires_manual_handling) payload.requires_manual_handling = false;\n                if (!payload.has_freight_elevator) payload.has_freight_elevator = false;\n                // Если ручной подъем не выбран, очищаем этаж\n                if (!payload.requires_manual_handling) {\n                    payload.manual_handling_floor = null;\n                    payload.has_freight_elevator = false;\n                }\n\n\n                resultDiv.classList.remove('hidden');\n                errorMessage.classList.add('hidden');\n                pagePreview.style.display = 'block'; // Показываем индикатор загрузки\n                pagePreview.textContent = 'Отправка запроса на расчет...';\n\n                try {\n                    const response = await fetch('/calculate', {\n                        method: 'POST',\n                        headers: { 'Content-Type': 'application/json' },\n                        body: JSON.stringify(payload)\n                    });\n\n                    const data = await response.json();\n\n                    if (response.ok && !data.error) {\n                        costResult.textContent = data.cost || 'Недоступно';\n                        timeResult.textContent = data.delivery_time || 'Недоступно';\n                        pagePreview.style.display = 'none'; // Скрываем индикатор\n                    } else {\n                        errorMessage.textContent = `Ошибка: ${data.error || 'Неизвестная ошибка.'}`;\n                        errorMessage.classList.remove('hidden');\n                        pagePreview.style.display = 'none'; // Скрываем индикатор\n                        if (data.html_preview) {\n                            pagePreview.innerHTML = `<strong>Предпросмотр HTML страницы (для отладки):</strong><br><pre>${data.html_preview}</pre>`;\n                            pagePreview.style.display = 'block';\n                        }\n                    }\n                } catch (error) {\n                    errorMessage.textContent = `Ошибка сети или выполнения запроса: ${error}`;\n                    errorMessage.classList.remove('hidden');\n                    pagePreview.style.display = 'none'; // Скрываем индикатор\n                }\n            });\n        });\n    </script>\n</body>\n</html>\n# requirements.txt\n\nFlask>=2.0\nplaywright>=1.20\nbeautifulsoup4>=4.10\nИнструкции для установки и запуска на Replit:\n\nСоздайте новый Repl: Выберите шаблон \"Python\" или \"Flask\".\nСоздайте файлы:\nmain.py (содержимое Python кода выше).\nrequirements.txt (содержимое requirements.txt выше).\nСоздайте папку templates и в ней файл index.html (содержимое HTML кода выше).\nУстановите зависимости Playwright: В консоли Repl выполните команду: bash playwright install playwright --with-deps Или добавьте playwright install playwright --with-deps в ваш replit.nix файл, если вы используете Nix.\nЗапустите приложение: Нажмите кнопку \"Run\" в Replit.\nОткройте вашу форму: Перейдите по ссылке, которую предоставит Replit (например, your-repl-name.replit.dev).\nПоле Запроса для Приложения (Input JSON)\nЭто формат данных, который ваше приложение будет отправлять на ваш же бэкенд (/calculate endpoint).\n\n{\n  \"length\": 50,           // Число, см\n  \"width\": 30,            // Число, см\n  \"height\": 20,           // Число, см\n  \"weight\": 5.0,          // Число, кг\n  \"quantity\": 1,          // Целое число, количество одинаковых мест\n  \"declared_value\": 1000.00, // Число, валюта не указана, предполагается рубли\n\n  \"pickup_type\": \"address\", // \"address\" или \"terminal\"\n  \"pickup_address\": \"г. Москва, ул. Примерная, д. 1, кв. 1\", // Строка, если pickup_type == \"address\"\n  \"pickup_terminal_code\": \"MOW1\", // Строка, если pickup_type == \"terminal\"\n\n  \"delivery_type\": \"terminal\", // \"address\" или \"terminal\"\n  \"delivery_address\": \"г. Санкт-Петербург, пр. Невский, д. 10\", // Строка, если delivery_type == \"address\"\n  \"delivery_terminal_code\": \"SPB1\", // Строка, если delivery_type == \"terminal\"\n\n  \"requires_packaging\": true, // Булево\n  \"requires_loading_unloading\": false, // Булево\n  \"requires_manual_handling\": true,    // Булево\n  \"manual_handling_floor\": 5,        // Целое число, если requires_manual_handling = true\n  \"has_freight_elevator\": false      // Булево, если requires_manual_handling = true\n}\nПоле с Примером Ответа от Вашего Приложения (Output JSON)\nЭто формат данных, который ваше приложение будет получать от своего же бэкенда после обработки запроса.\n\nУспешный ответ:\n\n{\n  \"cost\": \"1 250 руб.\",      // Строка, стоимость доставки\n  \"delivery_time\": \"2-3 дня\", // Строка, срок доставки\n  \"message\": \"Расчет успешно выполнен.\" // Строка, статус операции\n}\nОтвет с ошибкой:\n\n{\n  \"error\": \"Превышено время ожидания результата. Возможно, расчет не удался или изменилась структура страницы.\", // Строка, описание ошибки\n  \"html_preview\": \"<html>...</html>\" // Опционально, фрагмент HTML целевой страницы для отладки\n}\nИли\n\n{\n  \"error\": \"Отсутствуют или пусты обязательные поля: from_city, to_city.\", // Строка, описание ошибки\n  // код ответа HTTP будет 400 Bad Request\n}\nКлючевые моменты для \"Senior Prompt Engineer\":\n\nСелекторы: Подчеркнул, что селекторы – самое слабое звено и требуют ручной проверки. Предусмотрел, что они могут быть динамическими или иметь разные названия.\nОбработка ошибок: Реализовал try-except блоки для всех критических операций Playwright и сетевых запросов. Возвращение html_preview поможет в отладке.\nСтруктура: Четкое разделение на фронтенд (HTML), бэкенд (Python/Flask) и логику автоматизации (Playwright).\nВводные данные: Полный набор данных, который вы просили, с разбивкой на группы.\nТипы данных: Предусмотрел преобразование строк в числа/булевы значения там, где это необходимо.\nАвтономность: Код готов к размещению в Repl.\nНадеюсь, это исчерпывающий ответ, который позволит вам реализовать задуманное!",
  "messageID": "msg_9e2e422fd001Bwfg7eN87MV1hZ",
  "sessionID": "ses_6852784ecffeuHwynj83p2lr14"
}