{
  "id": "prt_ab4688ca60018DTpBQAJCYAAMb",
  "sessionID": "ses_54b97e247ffenCZZa4jZiIWD0l",
  "messageID": "msg_ab46873a2001pSqaQJS44LhPGU",
  "type": "tool",
  "callID": "call_7033b52b9f3b44dbb458b33f",
  "tool": "read",
  "state": {
    "status": "completed",
    "input": {
      "filePath": "/home/user/project/app/api/pek/route.ts",
      "limit": 100
    },
    "output": "<file>\n00001| import { NextRequest, NextResponse } from 'next/server';\n00002| import { apiRequestWithTimeout, validateApiInput, validationRules, PerformanceMonitor } from '@/lib/api-utils';\n00003| \n00004| export async function POST(request: NextRequest) {\n00005|   const endTiming = PerformanceMonitor.startMeasurement('pek_api_total');\n00006|   \n00007|   try {\n00008|     console.log('üîß –ü–≠–ö –ü—Ä–æ–∫—Å–∏: –ü–æ–ª—É—á–µ–Ω –∑–∞–ø—Ä–æ—Å (–ø–æ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏)');\n00009|     \n00010|     const requestData = await request.json();\n00011|     console.log('üìù –î–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å–∞:', JSON.stringify(requestData, null, 2));\n00012|     \n00013|     // Input validation\n00014|     validateApiInput(requestData, {\n00015|       method: validationRules.required('method'),\n00016|     });\n00017|     \n00018|     const { method, address, coordinates } = requestData;\n00019|     \n00020|     // –î–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –ü–≠–ö\n00021|     const PEK_API_KEY = process.env.PEK_API_KEY || '624FC93CA677B23673BB476D4982294DC27E246F';\n00022|     const PEK_LOGIN = process.env.PEK_LOGIN || 'demo';\n00023|     \n00024|     // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–µ-—Ç–µ—Å—Ç–æ–≤—ã—Ö –º–µ—Ç–æ–¥–æ–≤\n00025|     if (method !== 'test' && (!process.env.PEK_LOGIN || !process.env.PEK_API_KEY)) {\n00026|       console.warn('‚ö†Ô∏è –ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è PEK_LOGIN –∏ PEK_API_KEY');\n00027|       console.warn('‚ö†Ô∏è –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ /env-check –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏');\n00028|       \n00029|       return NextResponse.json({ \n00030|         error: '–ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –ü–≠–ö',\n00031|         details: '–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å PEK_LOGIN –∏ PEK_API_KEY –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è',\n00032|         suggestion: '–ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ /env-check –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏',\n00033|         requiredVars: ['PEK_LOGIN', 'PEK_API_KEY'],\n00034|         currentEnv: {\n00035|           hasLogin: !!process.env.PEK_LOGIN,\n00036|           hasKey: !!process.env.PEK_API_KEY,\n00037|           loginPreview: process.env.PEK_LOGIN ? process.env.PEK_LOGIN.substring(0, 3) + '***' : '–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'\n00038|         }\n00039|       }, { status: 500 });\n00040|     }\n00041|     \n00042|     // –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –±–∞–∑–æ–≤—ã–π URL —Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏\n00043|     const BASE_URL = 'https://kabinet.pecom.ru/api/v1';\n00044|     \n00045|     let urlPath = '';\n00046|     let body = {};\n00047|     \n00048|     switch (method) {\n00049|       case 'findzonebyaddress':\n00050|         urlPath = '/branches/findzonebyaddress/';\n00051|         console.log('üîç –ü–≠–ö API: findzonebyaddress –¥–ª—è –∞–¥—Ä–µ—Å–∞:', address);\n00052|         body = { address: address };\n00053|         break;\n00054|         \n00055|       case 'findzonebycoordinates':\n00056|         urlPath = '/branches/findzonebycoordinates/';\n00057|         \n00058|         // –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç\n00059|         const lat = Number(coordinates.latitude);\n00060|         const lng = Number(coordinates.longitude);\n00061|         \n00062|         if (isNaN(lat) || isNaN(lng) || lat < -90 || lat > 90 || lng < -180 || lng > 180) {\n00063|           return NextResponse.json({ \n00064|             error: '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã',\n00065|             details: `–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å: latitude –æ—Ç -90 –¥–æ 90, longitude –æ—Ç -180 –¥–æ 180`,\n00066|             received: { latitude: coordinates.latitude, longitude: coordinates.longitude },\n00067|             validated: { latitude: lat, longitude: lng }\n00068|           }, { status: 400 });\n00069|         }\n00070|         \n00071|         body = {\n00072|           longitude: lng,\n00073|           latitude: lat\n00074|         };\n00075|         break;\n00076|         \n00077|       case 'calculateprice':\n00078|         urlPath = '/calculator/calculateprice/';\n00079|         const { method: methodName, ...calculationData } = requestData;\n00080|         \n00081|         // –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –≤ –∞–¥—Ä–µ—Å–∞—Ö –¥–æ—Å—Ç–∞–≤–∫–∏\n00082|         console.log('üß™ API –ü—Ä–æ–∫—Å–∏: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –≤ calculateprice');\n00083|         \n00084|         if (calculationData.pickup?.coordinates) {\n00085|           console.log('üìç API –ü—Ä–æ–∫—Å–∏: pickup.coordinates =', calculationData.pickup.coordinates);\n00086|           const lat = Number(calculationData.pickup.coordinates.latitude);\n00087|           const lng = Number(calculationData.pickup.coordinates.longitude);\n00088|           \n00089|           console.log('üìç API –ü—Ä–æ–∫—Å–∏: pickup –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–Ω–æ: lat=' + lat + ', lng=' + lng);\n00090|           \n00091|           if (isNaN(lat) || isNaN(lng) || lat < -90 || lat > 90 || lng < -180 || lng > 180) {\n00092|             console.warn('‚ö†Ô∏è API –ü—Ä–æ–∫—Å–∏: –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã pickup:', calculationData.pickup.coordinates);\n00093|             console.warn('‚ö†Ô∏è API –ü—Ä–æ–∫—Å–∏: –£–¥–∞–ª—è–µ–º pickup.coordinates');\n00094|             delete calculationData.pickup.coordinates;\n00095|           } else {\n00096|             console.log('‚úÖ API –ü—Ä–æ–∫—Å–∏: pickup.coordinates –≤–∞–ª–∏–¥–Ω—ã');\n00097|             calculationData.pickup.coordinates = { latitude: lat, longitude: lng };\n00098|           }\n00099|         }\n00100|         \n\n(File has more lines. Use 'offset' parameter to read beyond line 100)\n</file>",
    "title": "app/api/pek/route.ts",
    "metadata": {
      "preview": "import { NextRequest, NextResponse } from 'next/server';\nimport { apiRequestWithTimeout, validateApiInput, validationRules, PerformanceMonitor } from '@/lib/api-utils';\n\nexport async function POST(request: NextRequest) {\n  const endTiming = PerformanceMonitor.startMeasurement('pek_api_total');\n  \n  try {\n    console.log('üîß –ü–≠–ö –ü—Ä–æ–∫—Å–∏: –ü–æ–ª—É—á–µ–Ω –∑–∞–ø—Ä–æ—Å (–ø–æ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏)');\n    \n    const requestData = await request.json();\n    console.log('üìù –î–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å–∞:', JSON.stringify(requestData, null, 2));\n    \n    // Input validation\n    validateApiInput(requestData, {\n      method: validationRules.required('method'),\n    });\n    \n    const { method, address, coordinates } = requestData;\n    \n    // –î–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –ü–≠–ö"
    },
    "time": {
      "start": 1763963341992,
      "end": 1763963341993
    }
  }
}