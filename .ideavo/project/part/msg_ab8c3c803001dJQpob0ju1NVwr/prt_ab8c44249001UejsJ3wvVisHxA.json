{
  "id": "prt_ab8c44249001UejsJ3wvVisHxA",
  "sessionID": "ses_54b97e247ffenCZZa4jZiIWD0l",
  "messageID": "msg_ab8c3c803001dJQpob0ju1NVwr",
  "type": "tool",
  "callID": "call_25aafec7b4ab41dd83532b0f",
  "tool": "write",
  "state": {
    "status": "completed",
    "input": {
      "content": "import puppeteer, { Browser, Page } from 'puppeteer';\n\nexport interface ScreenshotOptions {\n  width?: number;\n  height?: number;\n  fullPage?: boolean;\n  quality?: number;\n}\n\nexport async function createPageScreenshot(\n  html: string, \n  options: ScreenshotOptions = {}\n): Promise<string> {\n  const {\n    width = 1920,\n    height = 1080,\n    fullPage = true,\n    quality = 90\n  } = options;\n\n  let browser: Browser | null = null;\n  \n  try {\n    console.log('üì∏ Creating screenshot with Puppeteer...');\n    \n    // –ó–∞–ø—É—Å–∫ –±—Ä–∞—É–∑–µ—Ä–∞ —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –¥–ª—è —Å–µ—Ä–≤–µ—Ä–∞\n    browser = await puppeteer.launch({\n      headless: true,\n      args: [\n        '--no-sandbox',\n        '--disable-setuid-sandbox',\n        '--disable-dev-shm-usage',\n        '--disable-accelerated-2d-canvas',\n        '--no-first-run',\n        '--no-zygote',\n        '--disable-gpu'\n      ]\n    });\n\n    const page: Page = await browser.newPage();\n    \n    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–∞–∑–º–µ—Ä–æ–≤ viewport\n    await page.setViewport({ width, height });\n    \n    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ HTML\n    await page.setContent(html, {\n      waitUntil: 'networkidle0',\n      timeout: 30000\n    });\n\n    // –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö —Å—Ç–∏–ª–µ–π –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π\n    await page.waitForTimeout(2000);\n\n    // –°–æ–∑–¥–∞–Ω–∏–µ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞ –≤ base64\n    const screenshot = await page.screenshot({\n      fullPage,\n      quality,\n      type: 'jpeg',\n      encoding: 'base64'\n    });\n\n    // –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ data URL\n    const dataUrl = `data:image/jpeg;base64,${screenshot}`;\n    \n    console.log('‚úÖ Screenshot created successfully');\n    return dataUrl;\n\n  } catch (error) {\n    console.error('‚ùå Error creating screenshot:', error);\n    throw new Error(`Screenshot creation failed: ${error instanceof Error ? error.message : 'Unknown error'}`);\n  } finally {\n    if (browser) {\n      await browser.close();\n    }\n  }\n}\n\nexport async function createCalculationScreenshot(\n  formData: any, \n  calculations: any[],\n  enabledCompanies: Record<string, boolean>\n): Promise<string> {\n  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è HTML –¥–ª—è —Å–∫—Ä–∏–Ω—à–æ—Ç–∞\n  const html = generateCalculationHTML(formData, calculations, enabledCompanies);\n  \n  return createPageScreenshot(html, {\n    width: 1920,\n    height: 2000, // –£–≤–µ–ª–∏—á–µ–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –¥–ª—è –¥–ª–∏–Ω–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã\n    fullPage: true,\n    quality: 85\n  });\n}\n\nfunction generateCalculationHTML(\n  formData: any, \n  calculations: any[], \n  enabledCompanies: Record<string, boolean>\n): string {\n  const currentDate = new Date().toLocaleString('ru-RU');\n  \n  // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Ñ–æ—Ä–º—ã\n  const formatFormData = () => {\n    const items = [];\n    \n    items.push(`üìç –ú–∞—Ä—à—Ä—É—Ç: ${formData.fromCity} ‚Üí ${formData.toCity}`);\n    \n    if (formData.fromAddress) {\n      items.push(`üè† –ê–¥—Ä–µ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è: ${formData.fromAddress}`);\n    }\n    \n    if (formData.toAddress) {\n      items.push(`üè† –ê–¥—Ä–µ—Å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è: ${formData.toAddress}`);\n    }\n    \n    // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥—Ä—É–∑–∞—Ö\n    items.push(`üì¶ –ì—Ä—É–∑—ã (${formData.cargos.length} —à—Ç.):`);\n    formData.cargos.forEach((cargo: any, index: number) => {\n      items.push(`   ${index + 1}. ${cargo.length}√ó${cargo.width}√ó${cargo.height} —Å–º, ${cargo.weight} –∫–≥`);\n    });\n    \n    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏\n    const services = [];\n    if (formData.needPackaging) services.push('–£–ø–∞–∫–æ–≤–∫–∞');\n    if (formData.needLoading) services.push('–ü–æ–≥—Ä—É–∑–∫–∞');\n    if (formData.needCarry) services.push('–ü–µ—Ä–µ–Ω–æ—Å–∫–∞');\n    if (formData.needInsurance) services.push(`–°—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ (${formData.declaredValue}‚ÇΩ)`);\n    \n    if (services.length > 0) {\n      items.push(`üîß –£—Å–ª—É–≥–∏: ${services.join(', ')}`);\n    }\n    \n    return items.join('\\n');\n  };\n  \n  // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ä–∞—Å—á–µ—Ç–∞\n  const formatCalculations = () => {\n    const validCalculations = calculations.filter(calc => \n      calc.price > 0 && enabledCompanies[calc.company.toLowerCase().replace(/\\s+/g, '')]\n    );\n    \n    if (validCalculations.length === 0) {\n      return '<p style=\"color: #666;\">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ä–∞—Å—á–µ—Ç–æ–≤</p>';\n    }\n    \n    // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —Ü–µ–Ω–µ\n    validCalculations.sort((a, b) => a.price - b.price);\n    \n    return validCalculations.map(calc => `\n      <div style=\"border: 1px solid #ddd; margin: 10px 0; padding: 15px; border-radius: 8px;\">\n        <h3 style=\"margin: 0 0 10px 0; color: #333;\">\n          ${calc.company} - ${calc.price.toLocaleString('ru-RU')} ‚ÇΩ\n        </h3>\n        <p style=\"margin: 5px 0; color: #666;\">\n          üìÖ –°—Ä–æ–∫ –¥–æ—Å—Ç–∞–≤–∫–∏: ${calc.days} –¥–Ω–µ–π\n        </p>\n        ${calc.error ? `<p style=\"margin: 5px 0; color: #d32f2f;\">‚ùå ${calc.error}</p>` : ''}\n      </div>\n    `).join('');\n  };\n  \n  return `\n    <!DOCTYPE html>\n    <html lang=\"ru\">\n    <head>\n      <meta charset=\"UTF-8\">\n      <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n      <title>–†–∞—Å—á–µ—Ç –¥–æ—Å—Ç–∞–≤–∫–∏</title>\n      <style>\n        body {\n          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n          line-height: 1.6;\n          color: #333;\n          max-width: 800px;\n          margin: 0 auto;\n          padding: 20px;\n          background: #f9f9f9;\n        }\n        .header {\n          background: #2196f3;\n          color: white;\n          padding: 20px;\n          border-radius: 8px;\n          margin-bottom: 20px;\n          text-align: center;\n        }\n        .section {\n          background: white;\n          padding: 20px;\n          border-radius: 8px;\n          margin-bottom: 20px;\n          box-shadow: 0 2px 4px rgba(0,0,0,0.1);\n        }\n        .form-data {\n          white-space: pre-line;\n          font-family: monospace;\n          background: #f5f5f5;\n          padding: 15px;\n          border-radius: 4px;\n          border-left: 4px solid #2196f3;\n        }\n        .timestamp {\n          text-align: center;\n          color: #666;\n          font-size: 14px;\n          margin-top: 20px;\n        }\n      </style>\n    </head>\n    <body>\n      <div class=\"header\">\n        <h1>üöõ –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –¥–æ—Å—Ç–∞–≤–∫–∏</h1>\n        <div class=\"timestamp\">${currentDate}</div>\n      </div>\n      \n      <div class=\"section\">\n        <h2>üìã –í–≤–µ–¥–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h2>\n        <div class=\"form-data\">${formatFormData()}</div>\n      </div>\n      \n      <div class=\"section\">\n        <h2>üí∞ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—Å—á–µ—Ç–∞</h2>\n        ${formatCalculations()}\n      </div>\n      \n      <div class=\"timestamp\">\n        –†–∞—Å—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ —Å–∏—Å—Ç–µ–º–µ –¥–æ—Å—Ç–∞–≤–∫–∏\n      </div>\n    </body>\n    </html>\n  `;\n}",
      "filePath": "/home/user/project/lib/screenshot-utils.ts"
    },
    "output": "",
    "title": "lib/screenshot-utils.ts",
    "metadata": {
      "diagnostics": {},
      "filepath": "/home/user/project/lib/screenshot-utils.ts",
      "exists": false
    },
    "time": {
      "start": 1764036461136,
      "end": 1764036461137
    }
  }
}