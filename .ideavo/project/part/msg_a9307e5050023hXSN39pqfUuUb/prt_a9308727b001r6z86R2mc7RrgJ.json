{
  "id": "prt_a9308727b001r6z86R2mc7RrgJ",
  "sessionID": "ses_6852784ecffeuHwynj83p2lr14",
  "messageID": "msg_a9307e5050023hXSN39pqfUuUb",
  "type": "tool",
  "callID": "call_79287369",
  "tool": "write",
  "state": {
    "status": "completed",
    "input": {
      "content": "'use client';\n\nimport React, { useState, useEffect, useCallback } from 'react';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Button } from '@/components/ui/button';\nimport { Badge } from '@/components/ui/badge';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { Switch } from '@/components/ui/switch';\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';\nimport { Alert, AlertDescription } from '@/components/ui/alert';\nimport {\n  Settings,\n  Play,\n  CheckCircle,\n  XCircle,\n  AlertTriangle,\n  RefreshCw,\n  Key,\n  Globe,\n  Truck,\n  Database,\n  ExternalLink\n} from 'lucide-react';\nimport { apiRequestWithTimeout } from '@/lib/api-utils';\n\ninterface ApiConfig {\n  name: string;\n  key: string;\n  category: 'transport' | 'service' | 'internal';\n  status: 'working' | 'error' | 'expired' | 'unknown';\n  credentials: {\n    [key: string]: string;\n  };\n  endpoints: string[];\n  description: string;\n  lastChecked?: Date;\n  errorMessage?: string;\n}\n\nconst API_CONFIGS: ApiConfig[] = [\n  {\n    name: 'ПЭК',\n    key: 'pek',\n    category: 'transport',\n    status: 'unknown',\n    credentials: {\n      login: process.env.PEK_LOGIN || '',\n      apiKey: process.env.PEK_API_KEY || '624FC93CA677B23673BB476D4982294DC27E246F'\n    },\n    endpoints: ['/api/pek'],\n    description: 'Транспортная компания ПЭК - доставка по России'\n  },\n  {\n    name: 'Возовоз',\n    key: 'vozovoz',\n    category: 'transport',\n    status: 'unknown',\n    credentials: {\n      token: 'sBDUaEmzVBO6syQWHvHxmjxJQiON2BZplQaqrU3N'\n    },\n    endpoints: ['/api/vozovoz'],\n    description: 'Транспортная компания Возовоз - доставка сборных грузов'\n  },\n  {\n    name: 'СДЭК',\n    key: 'cdek',\n    category: 'transport',\n    status: 'unknown',\n    credentials: {\n      clientId: '3J5AvQWReEdW1o01PApvw6jHsnkNpqT1',\n      clientSecret: 'T8iMvgShV0p9OfJiysSBpCCWcXtOO0Hy'\n    },\n    endpoints: ['/api/cdek'],\n    description: 'Транспортная компания СДЭК - курьерская доставка'\n  },\n  {\n    name: 'КИТ',\n    key: 'kit',\n    category: 'transport',\n    status: 'unknown',\n    credentials: {\n      token: process.env.KIT_API_TOKEN || ''\n    },\n    endpoints: ['/api/kit'],\n    description: 'Транспортная компания КИТ - доставка посылок'\n  },\n  {\n    name: 'Деловые Линии',\n    key: 'dellin',\n    category: 'transport',\n    status: 'unknown',\n    credentials: {\n      appkey: 'E6C50E91-8E93-440F-9CC6-DEF9F0D68F1B',\n      login: 'service@lavsit.ru',\n      password: 'edcwsx123QAZ'\n    },\n    endpoints: ['/api/dellin-packages'],\n    description: 'Транспортная компания Деловые Линии'\n  },\n  {\n    name: 'Rail Continent',\n    key: 'railcontinent',\n    category: 'transport',\n    status: 'unknown',\n    credentials: {},\n    endpoints: ['/api/rail-continent'],\n    description: 'Железнодорожная доставка Rail Continent'\n  },\n  {\n    name: 'DaData',\n    key: 'dadata',\n    category: 'service',\n    status: 'unknown',\n    credentials: {\n      apiKey: 'eb87bbb3789bb43ed465f796892ea951f9e91008'\n    },\n    endpoints: ['https://suggestions.dadata.ru/suggestions/api/4_1/rs/suggest/address'],\n    description: 'Сервис подсказок адресов DaData'\n  },\n  {\n    name: 'Google Sheets',\n    key: 'sheets',\n    category: 'internal',\n    status: 'unknown',\n    credentials: {},\n    endpoints: ['https://docs.google.com/spreadsheets/d/1e0P91PfGKVIuSWDY0ceWkIE7jD-vzD_xrIesBeQno1Y'],\n    description: 'База данных товаров в Google Sheets'\n  }\n];\n\nconst ApiMasterTab: React.FC = () => {\n  const [apis, setApis] = useState<ApiConfig[]>(API_CONFIGS);\n  const [testingAll, setTestingAll] = useState(false);\n  const [editingApi, setEditingApi] = useState<string | null>(null);\n  const [editCredentials, setEditCredentials] = useState<{ [key: string]: string }>({});\n\n  // Load saved API configurations\n  useEffect(() => {\n    try {\n      const saved = localStorage.getItem('apiConfigurations');\n      if (saved) {\n        const savedConfigs = JSON.parse(saved);\n        setApis(prev => prev.map(api => ({\n          ...api,\n          credentials: savedConfigs[api.key] || api.credentials,\n          status: savedConfigs[api.key + '_status'] || api.status,\n          lastChecked: savedConfigs[api.key + '_lastChecked'] ? new Date(savedConfigs[api.key + '_lastChecked']) : api.lastChecked\n        })));\n      }\n    } catch (error) {\n      console.error('Error loading API configurations:', error);\n    }\n  }, []);\n\n  const saveApiConfigurations = useCallback(() => {\n    try {\n      const configToSave: { [key: string]: any } = {};\n      apis.forEach(api => {\n        configToSave[api.key] = api.credentials;\n        configToSave[api.key + '_status'] = api.status;\n        configToSave[api.key + '_lastChecked'] = api.lastChecked?.toISOString();\n      });\n      localStorage.setItem('apiConfigurations', JSON.stringify(configToSave));\n    } catch (error) {\n      console.error('Error saving API configurations:', error);\n    }\n  }, [apis]);\n\n  const testApi = useCallback(async (api: ApiConfig) => {\n    setApis(prev => prev.map(a =>\n      a.key === api.key ? { ...a, status: 'unknown' as const } : a\n    ));\n\n    try {\n      let testResult = false;\n      let errorMessage = '';\n\n      // Test based on API type\n      switch (api.key) {\n        case 'pek':\n          const pekResponse = await apiRequestWithTimeout('/api/pek', {\n            method: 'POST',\n            headers: { 'Content-Type': 'application/json' },\n            body: JSON.stringify({ method: 'test' })\n          });\n          testResult = pekResponse.ok;\n          if (!pekResponse.ok) {\n            const errorData = await pekResponse.text();\n            errorMessage = errorData.includes('<!DOCTYPE') ? 'Неверные учетные данные' : errorData;\n          }\n          break;\n\n        case 'vozovoz':\n          const vozResponse = await apiRequestWithTimeout('/api/vozovoz', {\n            method: 'POST',\n            headers: { 'Content-Type': 'application/json' },\n            body: JSON.stringify({\n              object: \"price\",\n              action: \"get\",\n              params: {\n                cargo: { dimension: { quantity: 1, volume: 0.1, weight: 10 } },\n                gateway: {\n                  dispatch: { point: { location: \"Москва\", terminal: \"default\" } },\n                  destination: { point: { location: \"СПб\", terminal: \"default\" } }\n                }\n              }\n            })\n          });\n          testResult = vozResponse.ok;\n          if (!vozResponse.ok) {\n            const errorData = await vozResponse.text();\n            errorMessage = errorData.includes('<!DOCTYPE') ? 'Токен устарел' : 'Ошибка API';\n          }\n          break;\n\n        case 'cdek':\n          const cdekResponse = await apiRequestWithTimeout('/api/cdek', {\n            method: 'POST',\n            headers: { 'Content-Type': 'application/json' },\n            body: JSON.stringify({\n              from_city: 'Москва',\n              to_city: 'СПб',\n              packages: [{ height: 10, length: 20, width: 10, weight: 1000 }]\n            })\n          });\n          testResult = cdekResponse.ok;\n          if (!cdekResponse.ok) {\n            const errorData = await cdekResponse.text();\n            errorMessage = errorData.includes('<!DOCTYPE') ? 'Учетные данные устарели' : 'Ошибка API';\n          }\n          break;\n\n        case 'kit':\n          const kitResponse = await apiRequestWithTimeout('/api/kit', {\n            method: 'POST',\n            headers: { 'Content-Type': 'application/json' },\n            body: JSON.stringify({\n              from_city: 'Москва',\n              to_city: 'СПб',\n              declared_price: 10000\n            })\n          });\n          testResult = kitResponse.ok;\n          if (!kitResponse.ok) {\n            const errorData = await kitResponse.text();\n            errorMessage = errorData.includes('<!DOCTYPE') ? 'Токен отсутствует' : 'Ошибка API';\n          }\n          break;\n\n        case 'dellin':\n          const dellinResponse = await apiRequestWithTimeout('/api/dellin-packages', {\n            method: 'POST',\n            headers: { 'Content-Type': 'application/json' },\n            body: JSON.stringify({ method: 'test' })\n          });\n          testResult = dellinResponse.ok;\n          break;\n\n        case 'railcontinent':\n          const railResponse = await apiRequestWithTimeout('/api/rail-continent', {\n            method: 'POST',\n            headers: { 'Content-Type': 'application/json' },\n            body: JSON.stringify({ method: 'test' })\n          });\n          testResult = railResponse.ok;\n          break;\n\n        case 'dadata':\n          const dadataResponse = await fetch('https://suggestions.dadata.ru/suggestions/api/4_1/rs/suggest/address', {\n            method: 'POST',\n            headers: {\n              'Content-Type': 'application/json',\n              'Authorization': `Token ${api.credentials.apiKey}`\n            },\n            body: JSON.stringify({ query: 'Москва', count: 1 })\n          });\n          testResult = dadataResponse.ok;\n          break;\n\n        default:\n          testResult = true; // For internal APIs, assume working\n      }\n\n      setApis(prev => prev.map(a =>\n        a.key === api.key ? {\n          ...a,\n          status: testResult ? 'working' : 'error',\n          lastChecked: new Date(),\n          errorMessage: testResult ? undefined : errorMessage\n        } : a\n      ));\n\n    } catch (error) {\n      setApis(prev => prev.map(a =>\n        a.key === api.key ? {\n          ...a,\n          status: 'error',\n          lastChecked: new Date(),\n          errorMessage: 'Сетевая ошибка'\n        } : a\n      ));\n    }\n  }, []);\n\n  const testAllApis = useCallback(async () => {\n    setTestingAll(true);\n    for (const api of apis) {\n      await testApi(api);\n      await new Promise(resolve => setTimeout(resolve, 500)); // Delay between tests\n    }\n    setTestingAll(false);\n    saveApiConfigurations();\n  }, [apis, testApi, saveApiConfigurations]);\n\n  const startEditing = useCallback((apiKey: string) => {\n    const api = apis.find(a => a.key === apiKey);\n    if (api) {\n      setEditingApi(apiKey);\n      setEditCredentials({ ...api.credentials });\n    }\n  }, [apis]);\n\n  const saveCredentials = useCallback(() => {\n    if (editingApi) {\n      setApis(prev => prev.map(a =>\n        a.key === editingApi ? { ...a, credentials: { ...editCredentials } } : a\n      ));\n      setEditingApi(null);\n      saveApiConfigurations();\n    }\n  }, [editingApi, editCredentials, saveApiConfigurations]);\n\n  const getStatusIcon = (status: string) => {\n    switch (status) {\n      case 'working': return <CheckCircle className=\"h-4 w-4 text-green-500\" />;\n      case 'error': return <XCircle className=\"h-4 w-4 text-red-500\" />;\n      case 'expired': return <AlertTriangle className=\"h-4 w-4 text-yellow-500\" />;\n      default: return <RefreshCw className=\"h-4 w-4 text-gray-500\" />;\n    }\n  };\n\n  const getStatusText = (status: string) => {\n    switch (status) {\n      case 'working': return 'Работает';\n      case 'error': return 'Ошибка';\n      case 'expired': return 'Устарел';\n      default: return 'Неизвестно';\n    }\n  };\n\n  const getCategoryIcon = (category: string) => {\n    switch (category) {\n      case 'transport': return <Truck className=\"h-4 w-4\" />;\n      case 'service': return <Globe className=\"h-4 w-4\" />;\n      case 'internal': return <Database className=\"h-4 w-4\" />;\n      default: return <Settings className=\"h-4 w-4\" />;\n    }\n  };\n\n  const transportApis = apis.filter(api => api.category === 'transport');\n  const serviceApis = apis.filter(api => api.category === 'service');\n  const internalApis = apis.filter(api => api.category === 'internal');\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex justify-between items-center\">\n        <div>\n          <h2 className=\"text-2xl font-bold text-white mb-2\">Все API</h2>\n          <p className=\"text-gray-400\">Централизованное управление всеми API приложения</p>\n        </div>\n        <Button\n          onClick={testAllApis}\n          disabled={testingAll}\n          className=\"bg-blue-600 hover:bg-blue-700\"\n        >\n          {testingAll ? (\n            <>\n              <RefreshCw className=\"h-4 w-4 mr-2 animate-spin\" />\n              Тестирование...\n            </>\n          ) : (\n            <>\n              <Play className=\"h-4 w-4 mr-2\" />\n              Протестировать все\n            </>\n          )}\n        </Button>\n      </div>\n\n      <Tabs defaultValue=\"transport\" className=\"w-full\">\n        <TabsList className=\"grid w-full grid-cols-3 bg-gray-800 border-gray-700\">\n          <TabsTrigger value=\"transport\" className=\"text-white\">\n            <Truck className=\"h-4 w-4 mr-2\" />\n            Транспорт ({transportApis.length})\n          </TabsTrigger>\n          <TabsTrigger value=\"service\" className=\"text-white\">\n            <Globe className=\"h-4 w-4 mr-2\" />\n            Сервисы ({serviceApis.length})\n          </TabsTrigger>\n          <TabsTrigger value=\"internal\" className=\"text-white\">\n            <Database className=\"h-4 w-4 mr-2\" />\n            Внутренние ({internalApis.length})\n          </TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"transport\" className=\"mt-6\">\n          <div className=\"grid gap-4\">\n            {transportApis.map((api) => (\n              <Card key={api.key} className=\"bg-gray-800 border-gray-700\">\n                <CardHeader className=\"pb-3\">\n                  <div className=\"flex items-center justify-between\">\n                    <div className=\"flex items-center gap-3\">\n                      {getCategoryIcon(api.category)}\n                      <div>\n                        <CardTitle className=\"text-white text-lg\">{api.name}</CardTitle>\n                        <p className=\"text-gray-400 text-sm\">{api.description}</p>\n                      </div>\n                    </div>\n                    <div className=\"flex items-center gap-2\">\n                      {getStatusIcon(api.status)}\n                      <Badge variant={api.status === 'working' ? 'default' : 'destructive'}>\n                        {getStatusText(api.status)}\n                      </Badge>\n                    </div>\n                  </div>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"space-y-4\">\n                    {api.errorMessage && (\n                      <Alert className=\"border-red-500 bg-red-900/20\">\n                        <AlertTriangle className=\"h-4 w-4\" />\n                        <AlertDescription className=\"text-red-400\">\n                          {api.errorMessage}\n                        </AlertDescription>\n                      </Alert>\n                    )}\n\n                    <div className=\"grid grid-cols-2 gap-4\">\n                      <div>\n                        <Label className=\"text-gray-300 text-sm\">Последняя проверка</Label>\n                        <p className=\"text-white text-sm\">\n                          {api.lastChecked ? api.lastChecked.toLocaleString('ru-RU') : 'Не проверялся'}\n                        </p>\n                      </div>\n                      <div>\n                        <Label className=\"text-gray-300 text-sm\">Эндпоинты</Label>\n                        <div className=\"flex flex-wrap gap-1\">\n                          {api.endpoints.map((endpoint, idx) => (\n                            <Badge key={idx} variant=\"outline\" className=\"text-xs\">\n                              {endpoint}\n                            </Badge>\n                          ))}\n                        </div>\n                      </div>\n                    </div>\n\n                    <div className=\"flex gap-2\">\n                      <Button\n                        onClick={() => testApi(api)}\n                        variant=\"outline\"\n                        size=\"sm\"\n                        className=\"border-blue-500 text-blue-400 hover:bg-blue-900/20\"\n                      >\n                        <Play className=\"h-3 w-3 mr-1\" />\n                        Тест\n                      </Button>\n                      <Button\n                        onClick={() => startEditing(api.key)}\n                        variant=\"outline\"\n                        size=\"sm\"\n                        className=\"border-green-500 text-green-400 hover:bg-green-900/20\"\n                      >\n                        <Key className=\"h-3 w-3 mr-1\" />\n                        Ключи\n                      </Button>\n                    </div>\n\n                    {editingApi === api.key && (\n                      <Card className=\"bg-gray-700 border-gray-600 mt-4\">\n                        <CardHeader className=\"pb-2\">\n                          <CardTitle className=\"text-white text-sm\">Редактирование учетных данных</CardTitle>\n                        </CardHeader>\n                        <CardContent className=\"space-y-3\">\n                          {Object.keys(api.credentials).map((key) => (\n                            <div key={key}>\n                              <Label className=\"text-gray-300 text-sm capitalize\">{key}</Label>\n                              <Input\n                                type={key.includes('secret') || key.includes('password') ? 'password' : 'text'}\n                                value={editCredentials[key] || ''}\n                                onChange={(e) => setEditCredentials(prev => ({ ...prev, [key]: e.target.value }))}\n                                className=\"bg-gray-600 border-gray-500 text-white\"\n                              />\n                            </div>\n                          ))}\n                          <div className=\"flex gap-2\">\n                            <Button onClick={saveCredentials} size=\"sm\" className=\"bg-green-600 hover:bg-green-700\">\n                              Сохранить\n                            </Button>\n                            <Button onClick={() => setEditingApi(null)} variant=\"outline\" size=\"sm\">\n                              Отмена\n                            </Button>\n                          </div>\n                        </CardContent>\n                      </Card>\n                    )}\n                  </div>\n                </CardContent>\n              </Card>\n            ))}\n          </div>\n        </TabsContent>\n\n        <TabsContent value=\"service\" className=\"mt-6\">\n          <div className=\"grid gap-4\">\n            {serviceApis.map((api) => (\n              <Card key={api.key} className=\"bg-gray-800 border-gray-700\">\n                <CardHeader className=\"pb-3\">\n                  <div className=\"flex items-center justify-between\">\n                    <div className=\"flex items-center gap-3\">\n                      {getCategoryIcon(api.category)}\n                      <div>\n                        <CardTitle className=\"text-white text-lg\">{api.name}</CardTitle>\n                        <p className=\"text-gray-400 text-sm\">{api.description}</p>\n                      </div>\n                    </div>\n                    <div className=\"flex items-center gap-2\">\n                      {getStatusIcon(api.status)}\n                      <Badge variant={api.status === 'working' ? 'default' : 'destructive'}>\n                        {getStatusText(api.status)}\n                      </Badge>\n                    </div>\n                  </div>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"space-y-4\">\n                    {api.errorMessage && (\n                      <Alert className=\"border-red-500 bg-red-900/20\">\n                        <AlertTriangle className=\"h-4 w-4\" />\n                        <AlertDescription className=\"text-red-400\">\n                          {api.errorMessage}\n                        </AlertDescription>\n                      </Alert>\n                    )}\n\n                    <div className=\"flex gap-2\">\n                      <Button\n                        onClick={() => testApi(api)}\n                        variant=\"outline\"\n                        size=\"sm\"\n                        className=\"border-blue-500 text-blue-400 hover:bg-blue-900/20\"\n                      >\n                        <Play className=\"h-3 w-3 mr-1\" />\n                        Тест\n                      </Button>\n                      <Button\n                        onClick={() => startEditing(api.key)}\n                        variant=\"outline\"\n                        size=\"sm\"\n                        className=\"border-green-500 text-green-400 hover:bg-green-900/20\"\n                      >\n                        <Key className=\"h-3 w-3 mr-1\" />\n                        Ключи\n                      </Button>\n                    </div>\n                  </div>\n                </CardContent>\n              </Card>\n            ))}\n          </div>\n        </TabsContent>\n\n        <TabsContent value=\"internal\" className=\"mt-6\">\n          <div className=\"grid gap-4\">\n            {internalApis.map((api) => (\n              <Card key={api.key} className=\"bg-gray-800 border-gray-700\">\n                <CardHeader className=\"pb-3\">\n                  <div className=\"flex items-center justify-between\">\n                    <div className=\"flex items-center gap-3\">\n                      {getCategoryIcon(api.category)}\n                      <div>\n                        <CardTitle className=\"text-white text-lg\">{api.name}</CardTitle>\n                        <p className=\"text-gray-400 text-sm\">{api.description}</p>\n                      </div>\n                    </div>\n                    <div className=\"flex items-center gap-2\">\n                      {getStatusIcon(api.status)}\n                      <Badge variant={api.status === 'working' ? 'default' : 'destructive'}>\n                        {getStatusText(api.status)}\n                      </Badge>\n                      <Button\n                        onClick={() => window.open(api.endpoints[0], '_blank')}\n                        variant=\"outline\"\n                        size=\"sm\"\n                        className=\"border-purple-500 text-purple-400 hover:bg-purple-900/20\"\n                      >\n                        <ExternalLink className=\"h-3 w-3 mr-1\" />\n                        Открыть\n                      </Button>\n                    </div>\n                  </div>\n                </CardHeader>\n              </Card>\n            ))}\n          </div>\n        </TabsContent>\n      </Tabs>\n    </div>\n  );\n};\n\nexport default ApiMasterTab;",
      "filePath": "components/diagnostic/ApiMasterTab.tsx"
    },
    "output": "",
    "title": "components/diagnostic/ApiMasterTab.tsx",
    "metadata": {
      "diagnostics": {},
      "filepath": "/home/user/project/components/diagnostic/ApiMasterTab.tsx",
      "exists": false
    },
    "time": {
      "start": 1763403395713,
      "end": 1763403395714
    }
  }
}