{
  "id": "prt_975c72183001yIYaLp6OU72ZC8",
  "messageID": "msg_975c6de77001PmXkBOFkyDhWUA",
  "sessionID": "ses_68a64bdc5ffeVKHQcgswYhtY22",
  "type": "tool",
  "tool": "multiedit",
  "callID": "toolu_01EWF7k7h9ALtYfWmsXZ2vMh",
  "state": {
    "status": "completed",
    "input": {
      "filePath": "/home/user/project/app/page.tsx",
      "edits": [
        {
          "filePath": "/home/user/project/app/page.tsx",
          "oldString": "  const [expandedDetails, setExpandedDetails] = useState<{ [key: string]: boolean }>({});\n  const [suggestionPosition, setSuggestionPosition] = useState({ top: 0, left: 0 });",
          "newString": "  const [expandedDetails, setExpandedDetails] = useState<{ [key: string]: boolean }>({});\n  const [expandedDebugInfo, setExpandedDebugInfo] = useState<{ [key: string]: boolean }>({});\n  const [suggestionPosition, setSuggestionPosition] = useState({ top: 0, left: 0 });"
        },
        {
          "filePath": "/home/user/project/app/page.tsx",
          "oldString": "  const toggleDetails = (company: string) => {\n    setExpandedDetails(prev => ({\n      ...prev,\n      [company]: !prev[company]\n    }));\n  };",
          "newString": "  const toggleDetails = (company: string) => {\n    setExpandedDetails(prev => ({\n      ...prev,\n      [company]: !prev[company]\n    }));\n  };\n\n  const toggleDebugInfo = (company: string) => {\n    setExpandedDebugInfo(prev => ({\n      ...prev,\n      [company]: !prev[company]\n    }));\n  };\n\n  // Парсер деталей расчета для читаемого формата\n  const parseCalculationDetails = (calc: CalculationResult) => {\n    const details = [];\n    \n    if (calc.company === 'Деловые Линии' && calc.details) {\n      // Основная перевозка\n      if (calc.details.availableDeliveryTypes?.auto) {\n        details.push({\n          service: 'Межтерминальная перевозка',\n          description: `${form.fromCity} - ${form.toCity}`,\n          price: calc.details.availableDeliveryTypes.auto\n        });\n      }\n      \n      // Забор груза\n      if (!form.fromTerminal && calc.details.derival?.price) {\n        details.push({\n          service: 'Забор груза',\n          description: 'От адреса',\n          price: calc.details.derival.price\n        });\n      }\n      \n      // Доставка груза\n      if (!form.toTerminal && calc.details.arrival?.price) {\n        details.push({\n          service: 'Отвоз груза',\n          description: 'До адреса',\n          price: calc.details.arrival.price\n        });\n      }\n      \n      // Страхование\n      if (form.needInsurance && calc.details.insurance) {\n        details.push({\n          service: 'Страхование груза и срока',\n          description: '',\n          price: calc.details.insurance\n        });\n        \n        if (form.declaredValue > 0) {\n          details.push({\n            service: 'Страхование груза',\n            description: `На сумму ${form.declaredValue.toLocaleString()} ₽`,\n            price: Math.round(form.declaredValue * 0.01)\n          });\n        }\n      }\n      \n      // Упаковка\n      if (form.needPackaging) {\n        const totalWeight = form.cargos.reduce((sum, cargo) => sum + cargo.weight, 0);\n        details.push({\n          service: 'Услуги на терминале отправителе',\n          description: 'Упаковка груза',\n          price: Math.round(totalWeight * 50)\n        });\n      }\n      \n      // Дополнительные услуги\n      details.push({\n        service: 'Доп.услуги',\n        description: 'Информирование о статусе груза',\n        price: 15\n      });\n    } else {\n      // Для других ТК - базовая информация\n      details.push({\n        service: 'Доставка груза',\n        description: `${form.fromCity} - ${form.toCity}`,\n        price: calc.price\n      });\n      \n      if (form.needInsurance && form.declaredValue > 0) {\n        details.push({\n          service: 'Страхование',\n          description: `На сумму ${form.declaredValue.toLocaleString()} ₽`,\n          price: Math.round(form.declaredValue * 0.02)\n        });\n      }\n      \n      if (form.needPackaging) {\n        const totalWeight = form.cargos.reduce((sum, cargo) => sum + cargo.weight, 0);\n        details.push({\n          service: 'Упаковка',\n          description: '',\n          price: Math.round(totalWeight * 30)\n        });\n      }\n    }\n    \n    return details;\n  };"
        },
        {
          "filePath": "/home/user/project/app/page.tsx",
          "oldString": "                          <div className=\"flex gap-2 mt-2\">\n                            <Button\n                              variant=\"outline\"\n                              size=\"sm\"\n                              onClick={() => toggleDetails(calc.company)}\n                              className=\"h-6 text-xs\"\n                            >\n                              {expandedDetails[calc.company] ? 'Скрыть детали' : 'Показать подробнее'}\n                            </Button>\n                          </div>",
          "newString": "                          <div className=\"flex gap-2 mt-2\">\n                            <Button\n                              variant=\"outline\"\n                              size=\"sm\"\n                              onClick={() => toggleDetails(calc.company)}\n                              className=\"h-6 text-xs\"\n                            >\n                              {expandedDetails[calc.company] ? 'Скрыть подробнее' : 'Показать подробнее'}\n                            </Button>\n                            <Button\n                              variant=\"outline\"\n                              size=\"sm\"\n                              onClick={() => toggleDebugInfo(calc.company)}\n                              className=\"h-6 text-xs\"\n                            >\n                              {expandedDebugInfo[calc.company] ? 'Скрыть отладку' : 'Отладочная информация'}\n                            </Button>\n                          </div>"
        },
        {
          "filePath": "/home/user/project/app/page.tsx",
          "oldString": "                          <Collapsible open={expandedDetails[calc.company]}>\n                            <CollapsibleContent className=\"mt-2\">\n                              <div className=\"bg-gray-900 p-3 rounded text-xs\">\n                                <h4 className=\"font-bold mb-2 text-white\">Отладочная информация:</h4>\n                                \n                                {calc.apiUrl && (\n                                  <div className=\"mb-3\">\n                                    <h5 className=\"font-bold mb-1 text-white\">Запрос к API:</h5>\n                                    <p className=\"text-gray-300 break-all\">URL: {calc.apiUrl}</p>\n                                  </div>\n                                )}\n                                \n                                {calc.sessionId && (\n                                  <div className=\"mb-3\">\n                                    <h5 className=\"font-bold mb-1 text-white\">Session ID:</h5>\n                                    <p className=\"text-gray-300\">{calc.sessionId}</p>\n                                  </div>\n                                )}\n                                \n                                {calc.requestData && (\n                                  <div className=\"mb-3\">\n                                    <h5 className=\"font-bold mb-1 text-white\">Отправленный запрос:</h5>\n                                    <pre className=\"whitespace-pre-wrap overflow-auto max-h-32 text-gray-300 bg-gray-950 p-2 rounded text-xs\">\n                                      {JSON.stringify(calc.requestData, null, 2)}\n                                    </pre>\n                                  </div>\n                                )}\n                                \n                                {calc.responseData && (\n                                  <div className=\"mb-3\">\n                                    <h5 className=\"font-bold mb-1 text-white\">Полученный ответ:</h5>\n                                    <pre className=\"whitespace-pre-wrap overflow-auto max-h-32 text-gray-300 bg-gray-950 p-2 rounded text-xs\">\n                                      {JSON.stringify(calc.responseData, null, 2)}\n                                    </pre>\n                                  </div>\n                                )}\n                                \n                                {calc.details && (\n                                  <div className=\"mb-3\">\n                                    <h5 className=\"font-bold mb-1 text-white\">Детали расчета:</h5>\n                                    <pre className=\"whitespace-pre-wrap overflow-auto max-h-32 text-gray-300 bg-gray-950 p-2 rounded text-xs\">\n                                      {JSON.stringify(calc.details, null, 2)}\n                                    </pre>\n                                  </div>\n                                )}\n                              </div>\n                            </CollapsibleContent>\n                          </Collapsible>",
          "newString": "                          {/* Детали расчета */}\n                          <Collapsible open={expandedDetails[calc.company]}>\n                            <CollapsibleContent className=\"mt-2\">\n                              <div className=\"bg-gray-900 p-3 rounded text-xs\">\n                                <h4 className=\"font-bold mb-2 text-white\">Детали расчета:</h4>\n                                {(() => {\n                                  const details = parseCalculationDetails(calc);\n                                  const totalPrice = details.reduce((sum, detail) => sum + detail.price, 0);\n                                  \n                                  return (\n                                    <div className=\"space-y-1\">\n                                      {details.map((detail, idx) => (\n                                        <div key={idx} className=\"flex justify-between text-white\">\n                                          <div>\n                                            <div className=\"font-medium\">{detail.service}</div>\n                                            {detail.description && (\n                                              <div className=\"text-gray-400 text-xs\">{detail.description}</div>\n                                            )}\n                                          </div>\n                                          <div className=\"font-medium\">{detail.price.toLocaleString()} ₽</div>\n                                        </div>\n                                      ))}\n                                      <hr className=\"border-gray-600 my-2\" />\n                                      <div className=\"flex justify-between font-bold text-white\">\n                                        <div>К оплате по заказу:</div>\n                                        <div>{totalPrice.toLocaleString()} ₽</div>\n                                      </div>\n                                    </div>\n                                  );\n                                })()}\n                              </div>\n                            </CollapsibleContent>\n                          </Collapsible>\n                          \n                          {/* Отладочная информация */}\n                          <Collapsible open={expandedDebugInfo[calc.company]}>\n                            <CollapsibleContent className=\"mt-2\">\n                              <div className=\"bg-gray-900 p-3 rounded text-xs\">\n                                <h4 className=\"font-bold mb-2 text-white\">Отладочная информация:</h4>\n                                \n                                {calc.apiUrl && (\n                                  <div className=\"mb-3\">\n                                    <h5 className=\"font-bold mb-1 text-white\">Запрос к API:</h5>\n                                    <p className=\"text-gray-300 break-all\">URL: {calc.apiUrl}</p>\n                                  </div>\n                                )}\n                                \n                                {calc.sessionId && (\n                                  <div className=\"mb-3\">\n                                    <h5 className=\"font-bold mb-1 text-white\">Session ID:</h5>\n                                    <p className=\"text-gray-300\">{calc.sessionId}</p>\n                                  </div>\n                                )}\n                                \n                                {calc.requestData && (\n                                  <div className=\"mb-3\">\n                                    <h5 className=\"font-bold mb-1 text-white\">Отправленный запрос:</h5>\n                                    <pre className=\"whitespace-pre-wrap overflow-auto max-h-32 text-gray-300 bg-gray-950 p-2 rounded text-xs\">\n                                      {JSON.stringify(calc.requestData, null, 2)}\n                                    </pre>\n                                  </div>\n                                )}\n                                \n                                {calc.responseData && (\n                                  <div className=\"mb-3\">\n                                    <h5 className=\"font-bold mb-1 text-white\">Полученный ответ:</h5>\n                                    <pre className=\"whitespace-pre-wrap overflow-auto max-h-32 text-gray-300 bg-gray-950 p-2 rounded text-xs\">\n                                      {JSON.stringify(calc.responseData, null, 2)}\n                                    </pre>\n                                  </div>\n                                )}\n                                \n                                {calc.details && (\n                                  <div className=\"mb-3\">\n                                    <h5 className=\"font-bold mb-1 text-white\">Детали расчета (JSON):</h5>\n                                    <pre className=\"whitespace-pre-wrap overflow-auto max-h-32 text-gray-300 bg-gray-950 p-2 rounded text-xs\">\n                                      {JSON.stringify(calc.details, null, 2)}\n                                    </pre>\n                                  </div>\n                                )}\n                              </div>\n                            </CollapsibleContent>\n                          </Collapsible>"
        },
        {
          "filePath": "/home/user/project/app/page.tsx",
          "oldString": "  const handleCalculate = async () => {\n    setCalculating(true);\n    setCalculations([]);\n    \n    try {\n      const results = await Promise.all([\n        calculateDellin(),\n        calculatePEK(),\n        calculateNordWheel(),\n        calculateRailContinent()\n      ]);\n      \n      // Сортировка по цене\n      const sortedResults = results\n        .filter(result => !result.error)\n        .sort((a, b) => a.price - b.price)\n        .concat(results.filter(result => result.error));\n      \n      setCalculations(sortedResults);\n    } catch (error) {\n      console.error('Ошибка при расчете:', error);\n    } finally {\n      setCalculating(false);\n    }\n  };",
          "newString": "  const handleCalculate = async () => {\n    setCalculating(true);\n    setCalculations([]);\n    \n    // Сохраняем данные формы после расчета\n    localStorage.setItem('deliveryForm', JSON.stringify(form));\n    \n    try {\n      const results = await Promise.all([\n        calculateDellin(),\n        calculatePEK(),\n        calculateNordWheel(),\n        calculateRailContinent()\n      ]);\n      \n      // Сортировка по цене\n      const sortedResults = results\n        .filter(result => !result.error)\n        .sort((a, b) => a.price - b.price)\n        .concat(results.filter(result => result.error));\n      \n      setCalculations(sortedResults);\n    } catch (error) {\n      console.error('Ошибка при расчете:', error);\n    } finally {\n      setCalculating(false);\n    }\n  };"
        }
      ]
    },
    "output": "",
    "metadata": {
      "results": [
        {
          "diagnostics": {},
          "diff": "Index: /home/user/project/app/page.tsx\n===================================================================\n--- /home/user/project/app/page.tsx\n+++ /home/user/project/app/page.tsx\n@@ -93,8 +93,9 @@\n const [activeField, setActiveField] = useState('');\n const [calculations, setCalculations] = useState<CalculationResult[]>([]);\n const [calculating, setCalculating] = useState(false);\n const [expandedDetails, setExpandedDetails] = useState<{ [key: string]: boolean }>({});\n+const [expandedDebugInfo, setExpandedDebugInfo] = useState<{ [key: string]: boolean }>({});\n const [suggestionPosition, setSuggestionPosition] = useState({ top: 0, left: 0 });\n \n // Загрузка сохраненных данных\n useEffect(() => {\n"
        },
        {
          "diagnostics": {},
          "diff": "Index: /home/user/project/app/page.tsx\n===================================================================\n--- /home/user/project/app/page.tsx\n+++ /home/user/project/app/page.tsx\n@@ -506,8 +506,109 @@\n     [company]: !prev[company]\n   }));\n };\n \n+const toggleDebugInfo = (company: string) => {\n+  setExpandedDebugInfo(prev => ({\n+    ...prev,\n+    [company]: !prev[company]\n+  }));\n+};\n+\n+// Парсер деталей расчета для читаемого формата\n+const parseCalculationDetails = (calc: CalculationResult) => {\n+  const details = [];\n+  \n+  if (calc.company === 'Деловые Линии' && calc.details) {\n+    // Основная перевозка\n+    if (calc.details.availableDeliveryTypes?.auto) {\n+      details.push({\n+        service: 'Межтерминальная перевозка',\n+        description: `${form.fromCity} - ${form.toCity}`,\n+        price: calc.details.availableDeliveryTypes.auto\n+      });\n+    }\n+    \n+    // Забор груза\n+    if (!form.fromTerminal && calc.details.derival?.price) {\n+      details.push({\n+        service: 'Забор груза',\n+        description: 'От адреса',\n+        price: calc.details.derival.price\n+      });\n+    }\n+    \n+    // Доставка груза\n+    if (!form.toTerminal && calc.details.arrival?.price) {\n+      details.push({\n+        service: 'Отвоз груза',\n+        description: 'До адреса',\n+        price: calc.details.arrival.price\n+      });\n+    }\n+    \n+    // Страхование\n+    if (form.needInsurance && calc.details.insurance) {\n+      details.push({\n+        service: 'Страхование груза и срока',\n+        description: '',\n+        price: calc.details.insurance\n+      });\n+      \n+      if (form.declaredValue > 0) {\n+        details.push({\n+          service: 'Страхование груза',\n+          description: `На сумму ${form.declaredValue.toLocaleString()} ₽`,\n+          price: Math.round(form.declaredValue * 0.01)\n+        });\n+      }\n+    }\n+    \n+    // Упаковка\n+    if (form.needPackaging) {\n+      const totalWeight = form.cargos.reduce((sum, cargo) => sum + cargo.weight, 0);\n+      details.push({\n+        service: 'Услуги на терминале отправителе',\n+        description: 'Упаковка груза',\n+        price: Math.round(totalWeight * 50)\n+      });\n+    }\n+    \n+    // Дополнительные услуги\n+    details.push({\n+      service: 'Доп.услуги',\n+      description: 'Информирование о статусе груза',\n+      price: 15\n+    });\n+  } else {\n+    // Для других ТК - базовая информация\n+    details.push({\n+      service: 'Доставка груза',\n+      description: `${form.fromCity} - ${form.toCity}`,\n+      price: calc.price\n+    });\n+    \n+    if (form.needInsurance && form.declaredValue > 0) {\n+      details.push({\n+        service: 'Страхование',\n+        description: `На сумму ${form.declaredValue.toLocaleString()} ₽`,\n+        price: Math.round(form.declaredValue * 0.02)\n+      });\n+    }\n+    \n+    if (form.needPackaging) {\n+      const totalWeight = form.cargos.reduce((sum, cargo) => sum + cargo.weight, 0);\n+      details.push({\n+        service: 'Упаковка',\n+        description: '',\n+        price: Math.round(totalWeight * 30)\n+      });\n+    }\n+  }\n+  \n+  return details;\n+};\n+\n return (\n   <div className=\"min-h-screen bg-gray-900 text-white p-4 relative\">\n     <div className=\"max-w-7xl mx-auto\">\n       <h1 className=\"text-2xl font-bold text-center mb-6 text-blue-400\">\n"
        },
        {
          "diagnostics": {},
          "diff": "Index: /home/user/project/app/page.tsx\n===================================================================\n--- /home/user/project/app/page.tsx\n+++ /home/user/project/app/page.tsx\n@@ -927,10 +927,18 @@\n     size=\"sm\"\n     onClick={() => toggleDetails(calc.company)}\n     className=\"h-6 text-xs\"\n   >\n-    {expandedDetails[calc.company] ? 'Скрыть детали' : 'Показать подробнее'}\n+    {expandedDetails[calc.company] ? 'Скрыть подробнее' : 'Показать подробнее'}\n   </Button>\n+  <Button\n+    variant=\"outline\"\n+    size=\"sm\"\n+    onClick={() => toggleDebugInfo(calc.company)}\n+    className=\"h-6 text-xs\"\n+  >\n+    {expandedDebugInfo[calc.company] ? 'Скрыть отладку' : 'Отладочная информация'}\n+  </Button>\n </div>\n \n <Collapsible open={expandedDetails[calc.company]}>\n   <CollapsibleContent className=\"mt-2\">\n"
        },
        {
          "diagnostics": {},
          "diff": "Index: /home/user/project/app/page.tsx\n===================================================================\n--- /home/user/project/app/page.tsx\n+++ /home/user/project/app/page.tsx\n@@ -939,11 +939,46 @@\n     {expandedDebugInfo[calc.company] ? 'Скрыть отладку' : 'Отладочная информация'}\n   </Button>\n </div>\n \n+{/* Детали расчета */}\n <Collapsible open={expandedDetails[calc.company]}>\n   <CollapsibleContent className=\"mt-2\">\n     <div className=\"bg-gray-900 p-3 rounded text-xs\">\n+      <h4 className=\"font-bold mb-2 text-white\">Детали расчета:</h4>\n+      {(() => {\n+        const details = parseCalculationDetails(calc);\n+        const totalPrice = details.reduce((sum, detail) => sum + detail.price, 0);\n+        \n+        return (\n+          <div className=\"space-y-1\">\n+            {details.map((detail, idx) => (\n+              <div key={idx} className=\"flex justify-between text-white\">\n+                <div>\n+                  <div className=\"font-medium\">{detail.service}</div>\n+                  {detail.description && (\n+                    <div className=\"text-gray-400 text-xs\">{detail.description}</div>\n+                  )}\n+                </div>\n+                <div className=\"font-medium\">{detail.price.toLocaleString()} ₽</div>\n+              </div>\n+            ))}\n+            <hr className=\"border-gray-600 my-2\" />\n+            <div className=\"flex justify-between font-bold text-white\">\n+              <div>К оплате по заказу:</div>\n+              <div>{totalPrice.toLocaleString()} ₽</div>\n+            </div>\n+          </div>\n+        );\n+      })()}\n+    </div>\n+  </CollapsibleContent>\n+</Collapsible>\n+\n+{/* Отладочная информация */}\n+<Collapsible open={expandedDebugInfo[calc.company]}>\n+  <CollapsibleContent className=\"mt-2\">\n+    <div className=\"bg-gray-900 p-3 rounded text-xs\">\n       <h4 className=\"font-bold mb-2 text-white\">Отладочная информация:</h4>\n       \n       {calc.apiUrl && (\n         <div className=\"mb-3\">\n@@ -978,9 +1013,9 @@\n       )}\n       \n       {calc.details && (\n         <div className=\"mb-3\">\n-          <h5 className=\"font-bold mb-1 text-white\">Детали расчета:</h5>\n+          <h5 className=\"font-bold mb-1 text-white\">Детали расчета (JSON):</h5>\n           <pre className=\"whitespace-pre-wrap overflow-auto max-h-32 text-gray-300 bg-gray-950 p-2 rounded text-xs\">\n             {JSON.stringify(calc.details, null, 2)}\n           </pre>\n         </div>\n"
        },
        {
          "diagnostics": {},
          "diff": "Index: /home/user/project/app/page.tsx\n===================================================================\n--- /home/user/project/app/page.tsx\n+++ /home/user/project/app/page.tsx\n@@ -471,8 +471,11 @@\n const handleCalculate = async () => {\n   setCalculating(true);\n   setCalculations([]);\n   \n+  // Сохраняем данные формы после расчета\n+  localStorage.setItem('deliveryForm', JSON.stringify(form));\n+  \n   try {\n     const results = await Promise.all([\n       calculateDellin(),\n       calculatePEK(),\n"
        }
      ]
    },
    "title": "app/page.tsx",
    "time": {
      "start": 1758617654485,
      "end": 1758617654536
    }
  }
}