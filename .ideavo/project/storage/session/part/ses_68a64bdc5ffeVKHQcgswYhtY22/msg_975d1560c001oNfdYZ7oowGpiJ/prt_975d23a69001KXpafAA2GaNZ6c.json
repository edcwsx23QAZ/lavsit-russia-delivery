{
  "id": "prt_975d23a69001KXpafAA2GaNZ6c",
  "messageID": "msg_975d1560c001oNfdYZ7oowGpiJ",
  "sessionID": "ses_68a64bdc5ffeVKHQcgswYhtY22",
  "type": "tool",
  "tool": "multiedit",
  "callID": "toolu_01Hr1EcdwvqLXKMuzRcpw9Y4",
  "state": {
    "status": "completed",
    "input": {
      "filePath": "/home/user/project/app/page.tsx",
      "edits": [
        {
          "filePath": "/home/user/project/app/page.tsx",
          "oldString": "  // Заглушки для других ТК\n  const calculatePEK = async (): Promise<CalculationResult> => {\n    await new Promise(resolve => setTimeout(resolve, 1000));\n    const basePrice = form.cargos.reduce((sum, cargo) => sum + cargo.weight * 15, 0);\n    let totalPrice = basePrice;\n    \n    if (form.needInsurance) totalPrice += form.declaredValue * 0.02;\n    if (form.needPackaging) totalPrice += basePrice * 0.1;\n    \n    return {\n      company: 'ПЭК',\n      price: totalPrice,\n      days: 3,\n      apiUrl: 'https://pecom.ru/business/developers/api_public/',\n      details: { note: 'Заглушка - API не реализован' }\n    };\n  };",
          "newString": "  // Получение ID городов ПЭК по названию\n  const getPEKCityId = async (cityName: string): Promise<number | null> => {\n    try {\n      // Хардкод основных городов для демонстрации\n      const cityMappings: { [key: string]: number } = {\n        'москва': -457,\n        'санкт-петербург': 64883,\n        'спб': 64883,\n        'екатеринбург': 65102,\n        'новосибирск': 65398,\n        'краснодар': 65294,\n        'ростов-на-дону': 65456,\n        'казань': 65265,\n        'нижний новгород': 65392,\n        'самара': 65469,\n        'уфа': 65533,\n        'красноярск': 65300,\n        'пермь': 65419,\n        'воронеж': 65122,\n        'волгоград': 65118\n      };\n      \n      const normalizedCity = cityName.toLowerCase().trim();\n      return cityMappings[normalizedCity] || null;\n    } catch (error) {\n      console.error('Ошибка получения ID города ПЭК:', error);\n      return null;\n    }\n  };\n\n  // Расчет для ПЭК\n  const calculatePEK = async (): Promise<CalculationResult> => {\n    const apiUrl = 'http://calc.pecom.ru/bitrix/components/pecom/calc/ajax.php';\n    \n    try {\n      // Получаем ID городов\n      const fromCityId = await getPEKCityId(form.fromCity);\n      const toCityId = await getPEKCityId(form.toCity);\n      \n      if (!fromCityId || !toCityId) {\n        return {\n          company: 'ПЭК',\n          price: 0,\n          days: 0,\n          error: 'Город не найден в базе ПЭК',\n          apiUrl\n        };\n      }\n\n      // Формируем параметры запроса\n      const params = new URLSearchParams();\n      \n      // Добавляем грузы\n      form.cargos.forEach((cargo, index) => {\n        const width = cargo.width / 100; // переводим в метры\n        const length = cargo.length / 100;\n        const height = cargo.height / 100;\n        const volume = width * length * height;\n        const weight = cargo.weight;\n        const isOversized = (width > 2.4 || length > 12 || height > 2.7 || weight > 1500) ? 1 : 0;\n        const needZTU = form.needPackaging ? 1 : 0;\n        \n        params.append(`places[${index}][]`, width.toString());\n        params.append(`places[${index}][]`, length.toString());\n        params.append(`places[${index}][]`, height.toString());\n        params.append(`places[${index}][]`, volume.toString());\n        params.append(`places[${index}][]`, weight.toString());\n        params.append(`places[${index}][]`, isOversized.toString());\n        params.append(`places[${index}][]`, needZTU.toString());\n      });\n      \n      // Параметры забора\n      params.append('take[town]', fromCityId.toString());\n      params.append('take[tent]', '0'); // растентровка\n      params.append('take[gidro]', form.needLoading ? '1' : '0'); // гидролифт\n      params.append('take[manip]', '0'); // манипулятор\n      params.append('take[speed]', '0'); // срочный забор\n      params.append('take[moscow]', '0'); // ограничения по Москве\n      \n      // Параметры доставки\n      params.append('deliver[town]', toCityId.toString());\n      params.append('deliver[tent]', '0');\n      params.append('deliver[gidro]', form.needLoading ? '1' : '0');\n      params.append('deliver[manip]', '0');\n      params.append('deliver[speed]', '0');\n      params.append('deliver[moscow]', '0');\n      \n      // Дополнительные услуги\n      params.append('plombir', '0'); // пломбы\n      params.append('strah', form.needInsurance ? form.declaredValue.toString() : '0'); // страховка\n      params.append('ashan', '0'); // доставка в Ашан\n      params.append('night', '0'); // ночное время\n      params.append('pal', '0'); // запаллечивание\n      params.append('pallets', '0'); // паллетная перевозка\n\n      const fullUrl = `${apiUrl}?${params.toString()}`;\n      const requestData = Object.fromEntries(params);\n\n      const response = await fetch(fullUrl, {\n        method: 'GET',\n        headers: {\n          'Accept': 'application/json'\n        }\n      });\n\n      const data = await response.json();\n\n      if (response.ok && !data.error?.length) {\n        let totalPrice = 0;\n        let services = [];\n        \n        // Собираем стоимость услуг\n        if (data.take?.[2]) {\n          totalPrice += parseFloat(data.take[2]);\n          services.push({ name: data.take[0], description: data.take[1], price: parseFloat(data.take[2]) });\n        }\n        \n        if (data.auto?.[2]) {\n          totalPrice += parseFloat(data.auto[2]);\n          services.push({ name: data.auto[0], description: data.auto[1], price: parseFloat(data.auto[2]) });\n        } else if (data.autonegabarit?.[2]) {\n          totalPrice += parseFloat(data.autonegabarit[2]);\n          services.push({ name: data.autonegabarit[0], description: data.autonegabarit[1], price: parseFloat(data.autonegabarit[2]) });\n        }\n        \n        if (data.deliver?.[2]) {\n          totalPrice += parseFloat(data.deliver[2]);\n          services.push({ name: data.deliver[0], description: data.deliver[1], price: parseFloat(data.deliver[2]) });\n        }\n        \n        // Дополнительные услуги\n        ['ADD', 'ADD_1', 'ADD_2', 'ADD_3', 'ADD_4'].forEach(key => {\n          if (data[key]?.[2] && parseFloat(data[key][2]) > 0) {\n            totalPrice += parseFloat(data[key][2]);\n            services.push({ name: data[key][0], description: data[key][1], price: parseFloat(data[key][2]) });\n          }\n        });\n        \n        // Определяем срок доставки\n        let deliveryDays = 3; // по умолчанию\n        if (data.periods) {\n          const daysMatch = data.periods.match(/(\\d+)\\s*дн/);\n          if (daysMatch) {\n            deliveryDays = parseInt(daysMatch[1]);\n          }\n        }\n\n        return {\n          company: 'ПЭК',\n          price: Math.round(totalPrice),\n          days: deliveryDays,\n          details: {\n            services,\n            periods: data.periods,\n            aperiods: data.aperiods,\n            rawData: data\n          },\n          requestData,\n          responseData: data,\n          apiUrl: fullUrl\n        };\n      } else {\n        const errorMessages = data.error?.join(', ') || 'Неизвестная ошибка';\n        return {\n          company: 'ПЭК',\n          price: 0,\n          days: 0,\n          error: errorMessages,\n          requestData,\n          responseData: data,\n          apiUrl: fullUrl\n        };\n      }\n    } catch (error: any) {\n      return {\n        company: 'ПЭК',\n        price: 0,\n        days: 0,\n        error: `Ошибка соединения: ${error.message}`,\n        apiUrl\n      };\n    }\n  };"
        }
      ]
    },
    "output": "",
    "metadata": {
      "results": [
        {
          "diagnostics": {},
          "diff": "Index: /home/user/project/app/page.tsx\n===================================================================\n--- /home/user/project/app/page.tsx\n+++ /home/user/project/app/page.tsx\n@@ -432,24 +432,190 @@\n     };\n   }\n };\n \n-// Заглушки для других ТК\n+// Получение ID городов ПЭК по названию\n+const getPEKCityId = async (cityName: string): Promise<number | null> => {\n+  try {\n+    // Хардкод основных городов для демонстрации\n+    const cityMappings: { [key: string]: number } = {\n+      'москва': -457,\n+      'санкт-петербург': 64883,\n+      'спб': 64883,\n+      'екатеринбург': 65102,\n+      'новосибирск': 65398,\n+      'краснодар': 65294,\n+      'ростов-на-дону': 65456,\n+      'казань': 65265,\n+      'нижний новгород': 65392,\n+      'самара': 65469,\n+      'уфа': 65533,\n+      'красноярск': 65300,\n+      'пермь': 65419,\n+      'воронеж': 65122,\n+      'волгоград': 65118\n+    };\n+    \n+    const normalizedCity = cityName.toLowerCase().trim();\n+    return cityMappings[normalizedCity] || null;\n+  } catch (error) {\n+    console.error('Ошибка получения ID города ПЭК:', error);\n+    return null;\n+  }\n+};\n+\n+// Расчет для ПЭК\n const calculatePEK = async (): Promise<CalculationResult> => {\n-  await new Promise(resolve => setTimeout(resolve, 1000));\n-  const basePrice = form.cargos.reduce((sum, cargo) => sum + cargo.weight * 15, 0);\n-  let totalPrice = basePrice;\n+  const apiUrl = 'http://calc.pecom.ru/bitrix/components/pecom/calc/ajax.php';\n   \n-  if (form.needInsurance) totalPrice += form.declaredValue * 0.02;\n-  if (form.needPackaging) totalPrice += basePrice * 0.1;\n-  \n-  return {\n-    company: 'ПЭК',\n-    price: totalPrice,\n-    days: 3,\n-    apiUrl: 'https://pecom.ru/business/developers/api_public/',\n-    details: { note: 'Заглушка - API не реализован' }\n-  };\n+  try {\n+    // Получаем ID городов\n+    const fromCityId = await getPEKCityId(form.fromCity);\n+    const toCityId = await getPEKCityId(form.toCity);\n+    \n+    if (!fromCityId || !toCityId) {\n+      return {\n+        company: 'ПЭК',\n+        price: 0,\n+        days: 0,\n+        error: 'Город не найден в базе ПЭК',\n+        apiUrl\n+      };\n+    }\n+\n+    // Формируем параметры запроса\n+    const params = new URLSearchParams();\n+    \n+    // Добавляем грузы\n+    form.cargos.forEach((cargo, index) => {\n+      const width = cargo.width / 100; // переводим в метры\n+      const length = cargo.length / 100;\n+      const height = cargo.height / 100;\n+      const volume = width * length * height;\n+      const weight = cargo.weight;\n+      const isOversized = (width > 2.4 || length > 12 || height > 2.7 || weight > 1500) ? 1 : 0;\n+      const needZTU = form.needPackaging ? 1 : 0;\n+      \n+      params.append(`places[${index}][]`, width.toString());\n+      params.append(`places[${index}][]`, length.toString());\n+      params.append(`places[${index}][]`, height.toString());\n+      params.append(`places[${index}][]`, volume.toString());\n+      params.append(`places[${index}][]`, weight.toString());\n+      params.append(`places[${index}][]`, isOversized.toString());\n+      params.append(`places[${index}][]`, needZTU.toString());\n+    });\n+    \n+    // Параметры забора\n+    params.append('take[town]', fromCityId.toString());\n+    params.append('take[tent]', '0'); // растентровка\n+    params.append('take[gidro]', form.needLoading ? '1' : '0'); // гидролифт\n+    params.append('take[manip]', '0'); // манипулятор\n+    params.append('take[speed]', '0'); // срочный забор\n+    params.append('take[moscow]', '0'); // ограничения по Москве\n+    \n+    // Параметры доставки\n+    params.append('deliver[town]', toCityId.toString());\n+    params.append('deliver[tent]', '0');\n+    params.append('deliver[gidro]', form.needLoading ? '1' : '0');\n+    params.append('deliver[manip]', '0');\n+    params.append('deliver[speed]', '0');\n+    params.append('deliver[moscow]', '0');\n+    \n+    // Дополнительные услуги\n+    params.append('plombir', '0'); // пломбы\n+    params.append('strah', form.needInsurance ? form.declaredValue.toString() : '0'); // страховка\n+    params.append('ashan', '0'); // доставка в Ашан\n+    params.append('night', '0'); // ночное время\n+    params.append('pal', '0'); // запаллечивание\n+    params.append('pallets', '0'); // паллетная перевозка\n+\n+    const fullUrl = `${apiUrl}?${params.toString()}`;\n+    const requestData = Object.fromEntries(params);\n+\n+    const response = await fetch(fullUrl, {\n+      method: 'GET',\n+      headers: {\n+        'Accept': 'application/json'\n+      }\n+    });\n+\n+    const data = await response.json();\n+\n+    if (response.ok && !data.error?.length) {\n+      let totalPrice = 0;\n+      let services = [];\n+      \n+      // Собираем стоимость услуг\n+      if (data.take?.[2]) {\n+        totalPrice += parseFloat(data.take[2]);\n+        services.push({ name: data.take[0], description: data.take[1], price: parseFloat(data.take[2]) });\n+      }\n+      \n+      if (data.auto?.[2]) {\n+        totalPrice += parseFloat(data.auto[2]);\n+        services.push({ name: data.auto[0], description: data.auto[1], price: parseFloat(data.auto[2]) });\n+      } else if (data.autonegabarit?.[2]) {\n+        totalPrice += parseFloat(data.autonegabarit[2]);\n+        services.push({ name: data.autonegabarit[0], description: data.autonegabarit[1], price: parseFloat(data.autonegabarit[2]) });\n+      }\n+      \n+      if (data.deliver?.[2]) {\n+        totalPrice += parseFloat(data.deliver[2]);\n+        services.push({ name: data.deliver[0], description: data.deliver[1], price: parseFloat(data.deliver[2]) });\n+      }\n+      \n+      // Дополнительные услуги\n+      ['ADD', 'ADD_1', 'ADD_2', 'ADD_3', 'ADD_4'].forEach(key => {\n+        if (data[key]?.[2] && parseFloat(data[key][2]) > 0) {\n+          totalPrice += parseFloat(data[key][2]);\n+          services.push({ name: data[key][0], description: data[key][1], price: parseFloat(data[key][2]) });\n+        }\n+      });\n+      \n+      // Определяем срок доставки\n+      let deliveryDays = 3; // по умолчанию\n+      if (data.periods) {\n+        const daysMatch = data.periods.match(/(\\d+)\\s*дн/);\n+        if (daysMatch) {\n+          deliveryDays = parseInt(daysMatch[1]);\n+        }\n+      }\n+\n+      return {\n+        company: 'ПЭК',\n+        price: Math.round(totalPrice),\n+        days: deliveryDays,\n+        details: {\n+          services,\n+          periods: data.periods,\n+          aperiods: data.aperiods,\n+          rawData: data\n+        },\n+        requestData,\n+        responseData: data,\n+        apiUrl: fullUrl\n+      };\n+    } else {\n+      const errorMessages = data.error?.join(', ') || 'Неизвестная ошибка';\n+      return {\n+        company: 'ПЭК',\n+        price: 0,\n+        days: 0,\n+        error: errorMessages,\n+        requestData,\n+        responseData: data,\n+        apiUrl: fullUrl\n+      };\n+    }\n+  } catch (error: any) {\n+    return {\n+      company: 'ПЭК',\n+      price: 0,\n+      days: 0,\n+      error: `Ошибка соединения: ${error.message}`,\n+      apiUrl\n+    };\n+  }\n };\n \n const calculateRailContinent = async (): Promise<CalculationResult> => {\n   await new Promise(resolve => setTimeout(resolve, 1200));\n"
        }
      ]
    },
    "title": "app/page.tsx",
    "time": {
      "start": 1758618370413,
      "end": 1758618370453
    }
  }
}